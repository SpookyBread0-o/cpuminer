From marklmi at yahoo.com  Sun Jul  1 06:50:56 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Sat, 30 Jun 2018 23:50:44 -0700
Subject: svn commit: r335836 - head/usr.bin/top [broke ci.freebsd.org 's
 FreeBSD-head-riscv64-build]
Message-ID: <C6D8D7E6-5330-4FF4-A45A-16F1466308F2@yahoo.com>

https://ci.freebsd.org/job/FreeBSD-head-riscv64-build/9229/consoleText

--- utils.o ---
/usr/local/bin/riscv64-unknown-freebsd11.1-gcc --sysroot=/workspace/obj/workspace/src/riscv.riscv64/tmp -B/usr/local/riscv64-unknown-freebsd11.1/bin/  -O2 -pipe -march=rv64imafdc -mabi=lp64d   -g -MD  -MF.depend.utils.o -MTutils.o -std=gnu99 -fstack-protector-strong -Wsystem-headers -Werror -Wall -Wno-format-y2k -W -Wno-unused-parameter -Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith -Wreturn-type -Wcast-qual -Wwrite-strings -Wswitch -Wshadow -Wunused-parameter -Wcast-align -Wchar-subscripts -Winline -Wnested-externs -Wredundant-decls -Wold-style-definition -Wno-pointer-sign -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable -Wno-error=bool-operation -Wno-error=deprecated -Wno-error=expansion-to-defined -Wno-error=format-overflow -Wno-error=format-truncation -Wno-error=implicit-fallthrough -Wno-error=int-in-bool-context -Wno-error=memset-elt-size -Wno-error=nonnull -Wno-error=pointer-compare -Wno-error=stringop-overflow   -Wno-error=discarded-qualifiers -Wno-error=incompatible-pointer-types  -c /workspace/src/usr.bin/top/utils.c -o utils.o
/workspace/src/usr.bin/top/utils.c: In function 'utf8strvisx':
/workspace/src/usr.bin/top/utils.c:357:10: error: comparison is always true due to limited range of data type [-Werror=type-limits]
    if (0 <= *src_p && *src_p <= 31) {
          ^~

I'd guess that riscv64 has an unsigned type for *src_p --and that
fairly modern gcc complains where system clang and old gcc 4.2.1
do not complain for the issue.



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From dim at FreeBSD.org  Sun Jul  1 07:26:43 2018
From: dim at FreeBSD.org (Dimitry Andric)
Date: Sun, 1 Jul 2018 09:26:30 +0200
Subject: svn commit: r335813 [ broke ci.freebsd.org 's
 FreeBSD-head-{aarch64,amd64,i386}-build ]
In-Reply-To: <082D396D-639C-445F-A04E-5C56F219D177@FreeBSD.org>
References: <84175A6B-B159-4320-95FD-C5BC7F3B4C96@yahoo.com>
 <082D396D-639C-445F-A04E-5C56F219D177@FreeBSD.org>
Message-ID: <B605DDA8-9B45-4C84-9E23-66D88261113F@FreeBSD.org>

On 30 Jun 2018, at 15:58, Dimitry Andric <dim at FreeBSD.org> wrote:
> 
> On 30 Jun 2018, at 15:22, Mark Millard <marklmi at yahoo.com> wrote:
>> 
>> https://ci.freebsd.org/job/FreeBSD-head-aarch64-build/8358/consoleText
>> 
>> --- all_subdir_armv8crypto ---
>> /usr/src/sys/crypto/armv8/armv8_crypto_wrap.c:46:10: fatal error: 'arm_neon.h' file not found
>> #include <arm_neon.h>
>>        ^~~~~~~~~~~~
>> 1 error generated.
>> *** [armv8_crypto_wrap.o] Error code 1
>> 
>> 
>> https://ci.freebsd.org/job/FreeBSD-head-amd64-build/9268/consoleText
>> 
>> --- lib/liblzma__L ---
>> In file included from /usr/src/contrib/xz/src/liblzma/lz/lz_encoder.c:23:
>> /usr/src/contrib/xz/src/liblzma/common/memcmplen.h:19:11: fatal error: 'immintrin.h' file not found
>> #       include <immintrin.h>
>>               ^~~~~~~~~~~~~
>> 1 error generated.
>> *** [lz_encoder.o] Error code 1
> 
> Yeah, sorry about that, working on it now.  I'm awaiting a full build to
> see if there are any other issues.

This should now be fixed with r335819.

-Dimitry

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 223 bytes
Desc: Message signed with OpenPGP
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180701/8d34466a/attachment.sig>

From marklmi at yahoo.com  Sun Jul  1 13:35:11 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Sun, 1 Jul 2018 06:34:58 -0700
Subject: head -r335782 (?) broke ci.freebsd.org's FreeBSD-head-amd64-gcc
 build (lib32 part of build)
In-Reply-To: <AA1986CC-E407-4085-BAF9-0C54D6FFB2F4@yahoo.com>
References: <00D1127A-1F0E-4E0E-B86C-1C5AA5B2E085@yahoo.com>
 <CF0230A1-1384-4F0F-A96A-5AB555FD17AC@yahoo.com>
 <7A845F2C-C994-4828-823D-33A97B7B6EB0@yahoo.com>
 <72081b02-cf23-82ec-32df-7f5793c35f57@FreeBSD.org>
 <003509F0-F2F4-4A43-82FE-3F6FC23D19D4@yahoo.com>
 <65b19cc4-eaf0-13ed-43e6-9f04a1f7f196@FreeBSD.org>
 <FF369ACC-D496-49AF-BB41-406936E433B0@yahoo.com>
 <edcd2126-3554-f444-6ba0-3da94d887dfe@FreeBSD.org>
 <49BF6569-96A9-4104-BDE6-8BB94C0D9626@yahoo.com>
 <F60AE252-CB8E-429E-97BF-812CC4012A90@yahoo.com>
 <d9385d5b-85a7-3012-3024-c6d9ae8c6705@FreeBSD.org>
 <AA1986CC-E407-4085-BAF9-0C54D6FFB2F4@yahoo.com>
Message-ID: <E7718790-DC0D-4D12-9758-6D240877A6C4@yahoo.com>

My brain finally engaged for showing exactly what files are included
for the gcc builds: the .meta files include that information explicitly
(along with other files that are opened during the operation).

amd64 is as I reported, just one header file from gcc: float.h .

powerpc64 builds Lex/Lexer.cpp without defining __ALTIVEC__ and so
is not including <altivec.h> . Building without __ALTIVEC__ might
be an error itself but would be a workaround for the altivec.h
file name aliasing vs. search-path problem.

The details from the .meta files for the amd64 float.h
failure and the powerpc64 altivec.h issue follow.

For the -r335782+ amd64 context:

E 73559 /bin/sh
R 73559 /etc/libmap.conf
R 73559 /var/run/ld-elf.so.hints
R 73559 /lib/libedit.so.7
R 73559 /lib/libc.so.7
R 73559 /lib/libncursesw.so.8
F 73559 73560
E 73560 /usr/local/bin/x86_64-unknown-freebsd12.0-gcc
R 73560 /etc/libmap.conf
R 73560 /var/run/ld-elf.so.hints
R 73560 /usr/lib/libc++.so.1
R 73560 /lib/libcxxrt.so.1
R 73560 /lib/libm.so.5
R 73560 /lib/libc.so.7
R 73560 /lib/libgcc_s.so.1
F 73560 73561
E 73561 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1
R 73561 /etc/libmap.conf
R 73561 /var/run/ld-elf.so.hints
R 73561 /usr/local/lib/libmpc.so.3
R 73561 /usr/local/lib/libmpfr.so.6
R 73561 /usr/local/lib/libgmp.so.10
R 73561 /lib/libz.so.6
R 73561 /usr/lib/libc++.so.1
R 73561 /lib/libcxxrt.so.1
R 73561 /lib/libm.so.5
R 73561 /lib/libc.so.7
R 73561 /lib/libgcc_s.so.1
R 73561 /dev/urandom
R 73561 /usr/src/lib/msun/src/catrigl.c
F 73560 73562
E 73562 /usr/local/bin/x86_64-unknown-freebsd12.0-as
R 73562 /etc/libmap.conf
R 73562 /var/run/ld-elf.so.hints
R 73562 /lib/libc.so.7
R 73562 catrigl.o
W 73562 catrigl.o
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/cdefs.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/complex.h
R 73561 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/float.h
R 73561 /usr/src/lib/msun/ld80/invtrig.h
R 73561 /usr/src/lib/libc/include/fpmath.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/endian.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_types.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/_types.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/x86/_types.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/_limits.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/x86/_limits.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/endian.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/x86/endian.h
R 73561 /usr/src/lib/libc/i386/_fpmath.h
R 73561 /usr/src/lib/msun/src/math.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/_limits.h
R 73561 /usr/src/lib/msun/src/math_private.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/types.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/endian.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_pthreadtypes.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_stdint.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/select.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_sigset.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_timeval.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/timespec.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/sys/_timespec.h
R 73561 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/obj-lib32/tmp/usr/include/machine/endian.h
R 73561 /usr/src/lib/msun/src/catrigl.c
X 73562 0 0
X 73561 1 0
D 73560 catrigl.o
X 73560 1 0
X 73559 1 0

Note that only one one file (float.h) comes from gcc.
It would have to not be a file of a related set of files
(very independent) for such to be coherent.



As for my pre-existing powerpc64 build under -r335782+: It
did not include altivec.h at all according to its Lex_Lexer.o.meta
file. Apparently __ALTIVEC__ is not defined, as the code for
the #include in Lex/Lexer.cpp is:

#ifdef __SSE2__
#include <emmintrin.h>
#elif __ALTIVEC__
#include <altivec.h>
#undef bool
#endif


It did open the 3 files with /gcc/ in the path (2 being headers):

/usr/local/libexec/gcc/powerpc64-unknown-freebsd12.0/6.4.0/cc1plus

/usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stddef.h

/usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdint.h

but no others that I noticed.

For the amd64 -> powerpc64 cross build context:

E 74651 /bin/sh
R 74651 /etc/libmap.conf
R 74651 /var/run/ld-elf.so.hints
R 74651 /lib/libedit.so.7
R 74651 /lib/libc.so.7
R 74651 /lib/libncursesw.so.8
F 74651 74652
E 74652 /usr/local/bin/powerpc64-unknown-freebsd12.0-g++
R 74652 /etc/libmap.conf
R 74652 /var/run/ld-elf.so.hints
R 74652 /usr/lib/libc++.so.1
R 74652 /lib/libcxxrt.so.1
R 74652 /lib/libm.so.5
R 74652 /lib/libc.so.7
R 74652 /lib/libgcc_s.so.1
F 74652 74653
E 74653 /usr/local/libexec/gcc/powerpc64-unknown-freebsd12.0/6.4.0/cc1plus
F 74652 74654
R 74653 /etc/libmap.conf
R 74653 /var/run/ld-elf.so.hints
R 74653 /usr/local/lib/libmpc.so.3
R 74653 /usr/local/lib/libmpfr.so.6
R 74653 /usr/local/lib/libgmp.so.10
R 74653 /lib/libz.so.6
R 74653 /usr/lib/libc++.so.1
R 74653 /lib/libcxxrt.so.1
R 74653 /lib/libm.so.5
R 74653 /lib/libc.so.7
R 74653 /lib/libgcc_s.so.1
R 74653 /dev/urandom
R 74653 /usr/src/contrib/llvm/tools/clang/lib/Lex/Lexer.cpp
E 74654 /usr/local/bin/powerpc64-unknown-freebsd12.0-as
R 74654 /etc/libmap.conf
R 74654 /var/run/ld-elf.so.hints
R 74654 /lib/libc.so.7
D 74654 Lex/Lexer.o
R 74654 Lex/Lexer.o
W 74654 Lex/Lexer.o
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/Lexer.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/LangOptions.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/CommentOptions.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/string
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__config
R 74653 /usr/src/sys/sys/endian.h
R 74653 /usr/src/sys/sys/cdefs.h
R 74653 /usr/src/sys/sys/_types.h
R 74653 /usr/src/sys/powerpc/include/_types.h
R 74653 /usr/src/sys/powerpc/include/endian.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/pthread.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/string_view
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__string
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/algorithm
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/initializer_list
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cstddef
R 74653 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stddef.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__nullptr
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/type_traits
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cstring
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/string.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/string.h
R 74653 /usr/src/sys/sys/_null.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/strings.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_strings.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_string.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/utility
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__tuple
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cstdint
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/stdint.h
R 74653 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdint.h
R 74653 /usr/src/sys/sys/stdint.h
R 74653 /usr/src/sys/powerpc/include/_stdint.h
R 74653 /usr/src/sys/sys/_stdint.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__debug
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/memory
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/typeinfo
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/exception
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cstdlib
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/stdlib.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/stdlib.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/new
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/limits
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/iterator
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/iosfwd
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/wchar.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/wchar.h
R 74653 /usr/src/sys/powerpc/include/_limits.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/_ctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/runetype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_wchar.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__functional_base
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/tuple
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/stdexcept
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/atomic
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cstdio
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/stdio.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/stdio.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cwchar
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cwctype
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cctype
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/ctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/ctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_ctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/wctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/wctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_ctype.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/wchar.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/vector
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__bit_reference
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/climits
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/limits.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/limits.h
R 74653 /usr/src/sys/sys/limits.h
R 74653 /usr/src/sys/sys/syslimits.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__split_buffer
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/LLVM.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Casting.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Compiler.h
R 74653 /usr/src/lib/clang/include/llvm/Config/llvm-config.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/type_traits.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/None.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/ObjCRuntime.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/VersionTuple.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/Optional.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/AlignOf.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/Triple.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/Twine.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/SmallVector.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/iterator_range.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/MathExtras.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/SwapByteOrder.h
R 74653 /usr/src/lib/clang/include/llvm/Support/DataTypes.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cmath
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/math.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/math.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cinttypes
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/inttypes.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/inttypes.h
R 74653 /usr/src/sys/powerpc/include/_inttypes.h
R 74653 /usr/src/sys/sys/stdint.h
R 74653 /usr/src/sys/sys/types.h
R 74653 /usr/src/sys/sys/_pthreadtypes.h
R 74653 /usr/src/sys/sys/select.h
R 74653 /usr/src/sys/sys/_sigset.h
R 74653 /usr/src/sys/sys/_timeval.h
R 74653 /usr/src/sys/sys/timespec.h
R 74653 /usr/src/sys/sys/_timespec.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/ErrorHandling.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/StringRef.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/STLExtras.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/iterator.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/functional
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Sanitizers.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Sanitizers.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Sanitizers.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Visibility.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Linkage.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/LangOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/LangOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/LangOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/SourceLocation.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/PointerLikeTypeTraits.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/TokenKinds.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/TokenKinds.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OpenCLImageTypes.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/TokenKinds.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OpenCLImageTypes.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/TokenKinds.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OpenCLImageTypes.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/TokenKinds.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OpenCLImageTypes.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/PreprocessorLexer.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/MultipleIncludeOpt.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/Token.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/ArrayRef.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/Hashing.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Host.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/StringMap.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Allocator.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/array
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/lib/Lex/UnicodeCharSets.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/UnicodeCharRanges.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/SmallPtrSet.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/EpochTracker.h
R 74653 /usr/src/lib/clang/include/llvm/Config/abi-breaking.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/ReverseIteration.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Debug.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Mutex.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Threading.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/ciso646
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/mutex
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__mutex_base
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/chrono
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/ctime
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/time.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/xlocale/_time.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/ratio
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/system_error
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cerrno
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/errno.h
R 74653 /usr/src/sys/sys/errno.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__threading_support
R 74653 /usr/src/sys/sys/sched.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/MutexGuard.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/raw_ostream.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/CharInfo.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/IdentifierTable.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/DenseMapInfo.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/SmallString.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OperatorKinds.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/SourceManager.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/FileManager.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/FileSystemOptions.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/VirtualFileSystem.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/IntrusiveRefCntPtr.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Chrono.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/FormatProviders.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/StringSwitch.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/FormatVariadicDetails.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/NativeFormatting.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/ErrorOr.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/FileSystem.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Error.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/StringExtras.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/MD5.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Endian.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/stack
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/deque
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/src/contrib/llvm/include/llvm/Support/SourceMgr.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/MemoryBuffer.h
R 74653 /usr/src/contrib/llvm/include/llvm-c/Types.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/CBindingWrapping.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/SMLoc.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/DenseMap.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/map
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__tree
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/BitVector.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/DenseSet.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/PointerIntPair.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/LexDiagnostic.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Diagnostic.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticIDs.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/lib/clang/libclang/clang/Basic/DiagnosticCommonKinds.inc
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticOptions.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/DiagnosticOptions.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Specifiers.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/OpenCLImageTypes.def
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/list
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/__undef_macros
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/lib/clang/libclang/clang/Basic/DiagnosticLexKinds.inc
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/LiteralSupport.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/APFloat.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/APInt.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/Preprocessor.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Builtins.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Builtins.def
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Basic/Module.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/PointerUnion.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/SetVector.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/MacroInfo.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/FoldingSet.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/ModuleLoader.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/ModuleMap.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/TinyPtrVector.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/PPCallbacks.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/Pragma.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/PTHLexer.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/TokenLexer.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/Registry.h
R 74653 /usr/src/contrib/llvm/include/llvm/Support/DynamicLibrary.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/src/contrib/llvm/tools/clang/include/clang/Lex/PreprocessorOptions.h
R 74653 /usr/src/contrib/llvm/include/llvm/ADT/StringSet.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/set
R 74653 /usr/src/contrib/llvm/include/llvm/Support/ConvertUTF.h
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/c++/v1/cassert
R 74653 /usr/obj/powerpc64vtsc_xtoolchain-gcc/powerpc.powerpc64/usr/src/powerpc.powerpc64/tmp/usr/include/assert.h
X 74653 0 0
X 74654 0 0
X 74652 0 0
X 74651 0 0
# Stop 1530379489.086422
# Bye bye



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From rmacklem at uoguelph.ca  Mon Jul  2 19:45:13 2018
From: rmacklem at uoguelph.ca (Rick Macklem)
Date: Mon, 2 Jul 2018 19:45:10 +0000
Subject: Heads Up: rebuild nfsd if using the "-p" option
Message-ID: <YTOPR0101MB0953FB2741ACDF094F239501DD430@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>

r335870 changes the interface between the nfsd and the kernel for the case
where the "-p" option is used, so if you are using "nfsd -p" you should rebuild
your nfsd from sources of r335871 or later.

To be honest, I didn't see problems during testing, but I think that is because
there are some bytes of "0" at the bottom of the stack for nfsd.c's main() and
I wouldn't want to guarantee that there isn't a problem without rebuilding nfsd
from sources.

Note that old, pre r335172 binaries will continue to work fine, but there is no
support for "-p" in them.

rick

From marklmi at yahoo.com  Tue Jul  3 05:46:08 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 2 Jul 2018 22:46:00 -0700
Subject: svn commit: r335879 - in head/sys: conf kern sys [ broke
 ci.freebsd.org's FreeBSD-head-amd64-build ]
Message-ID: <5399C6EA-2904-4A1B-BF07-43A5D854A710@yahoo.com>

-r335879 broke ci.freebsd.org's FreeBSD-head-amd64-build :

https://ci.freebsd.org/job/FreeBSD-head-amd64-build/

shows:

--- ia32_genassym.o ---
In file included from /usr/src/sys/compat/ia32/ia32_genassym.c:6:
In file included from /usr/src/sys/sys/systm.h:113:
/usr/src/sys/sys/kpilite.h:33:10: fatal error: 'offset.inc' file not found
#include "offset.inc"
         ^~~~~~~~~~~~
1 error generated.
*** [ia32_genassym.o] Error code 1

Later builds ( -r335880 , -r335881 , -r335882 ) get the same.

FreeBSD-head-i386-LINT also fails for such reasons.

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From imb at protected-networks.net  Tue Jul  3 14:20:01 2018
From: imb at protected-networks.net (Michael Butler)
Date: Tue, 3 Jul 2018 10:19:57 -0400
Subject: atomic changes break drm-next-kmod?
Message-ID: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>

It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..

--- i915_drv.o ---
In file included from i915_drv.c:30:
In file included from
/usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
In file included from
/usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
In file included from
/usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
In file included from
/usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
In file included from /usr/src/sys/sys/systm.h:44:
./machine/atomic.h:450:29: error: invalid operand for instruction
ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
                            ^
<inline asm>:1:7: note: instantiated into assembly here
        andq $9223372036854775807,40672(%r14)
             ^~~~~~~~~~~~~~~~~~~~~
1 error generated.
*** [i915_drv.o] Error code 1

make[3]: stopped in
/usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
--- i915_gem.o ---
In file included from i915_gem.c:28:
In file included from
/usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
In file included from /usr/src/sys/sys/malloc.h:42:
In file included from /usr/src/sys/sys/systm.h:44:
./machine/atomic.h:449:29: error: invalid operand for instruction
ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
                            ^
<inline asm>:1:6: note: instantiated into assembly here
        orq $-9223372036854775808,40672(%r14)
            ^~~~~~~~~~~~~~~~~~~~~~
1 error generated.
*** [i915_gem.o] Error code 1


From ohartmann at walstatt.org  Tue Jul  3 15:02:54 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Tue, 3 Jul 2018 17:02:23 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
Message-ID: <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Tue, 3 Jul 2018 10:19:57 -0400
Michael Butler <imb at protected-networks.net> schrieb:

> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
> 
> --- i915_drv.o ---
> In file included from i915_drv.c:30:
> In file included from
> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
> In file included from
> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
> In file included from
> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
> In file included from
> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
> In file included from /usr/src/sys/sys/systm.h:44:
> ./machine/atomic.h:450:29: error: invalid operand for instruction
> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
>                             ^
> <inline asm>:1:7: note: instantiated into assembly here
>         andq $9223372036854775807,40672(%r14)
>              ^~~~~~~~~~~~~~~~~~~~~
> 1 error generated.
> *** [i915_drv.o] Error code 1
> 
> make[3]: stopped in
> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
> --- i915_gem.o ---
> In file included from i915_gem.c:28:
> In file included from
> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
> In file included from /usr/src/sys/sys/malloc.h:42:
> In file included from /usr/src/sys/sys/systm.h:44:
> ./machine/atomic.h:449:29: error: invalid operand for instruction
> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
>                             ^
> <inline asm>:1:6: note: instantiated into assembly here
>         orq $-9223372036854775808,40672(%r14)
>             ^~~~~~~~~~~~~~~~~~~~~~
> 1 error generated.
> *** [i915_gem.o] Error code 1
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


It breaks also graphics/drm-stable-kmod (see PR 229484,
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you described
above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is < r335873,
those kmod compile well.
- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCWzuQGgAKCRDS528fyFhY
lKHnAf0fIVHnw1xBVHzogeQQo4v+he17R2ln6l25lNR/pUE1AZOsFzPDamAkqbY+
f1+Usr+P5o7jn26Bh4ob3UmIj25DAf4tJZpeZS4iGZ374lrCAemYFb53+MJ1fClW
aBLI6DVOiBiOt/UpLXZf1whl/dtQvo5yd1xywfYOwi9Jh8teHcNW
=mtMH
-----END PGP SIGNATURE-----

From bdrewery at FreeBSD.org  Tue Jul  3 16:28:33 2018
From: bdrewery at FreeBSD.org (Bryan Drewery)
Date: Tue, 3 Jul 2018 09:28:30 -0700
Subject: svn commit: r335879 - in head/sys: conf kern sys [ broke
 ci.freebsd.org's FreeBSD-head-amd64-build ]
In-Reply-To: <5399C6EA-2904-4A1B-BF07-43A5D854A710@yahoo.com>
References: <5399C6EA-2904-4A1B-BF07-43A5D854A710@yahoo.com>
Message-ID: <57f1f29f-220b-ebac-4318-b1db4ce25c6e@FreeBSD.org>

On 7/2/2018 10:46 PM, Mark Millard wrote:
> -r335879 broke ci.freebsd.org's FreeBSD-head-amd64-build :
> 
> https://ci.freebsd.org/job/FreeBSD-head-amd64-build/
> 
> shows:
> 
> --- ia32_genassym.o ---
> In file included from /usr/src/sys/compat/ia32/ia32_genassym.c:6:
> In file included from /usr/src/sys/sys/systm.h:113:
> /usr/src/sys/sys/kpilite.h:33:10: fatal error: 'offset.inc' file not found
> #include "offset.inc"
>          ^~~~~~~~~~~~
> 1 error generated.
> *** [ia32_genassym.o] Error code 1
> 
> Later builds ( -r335880 , -r335881 , -r335882 ) get the same.
> 
> FreeBSD-head-i386-LINT also fails for such reasons.
> 

r335884 should fix this.


-- 
Regards,
Bryan Drewery

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 473 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180703/1782189a/attachment.sig>

From lwhsu at freebsd.org  Tue Jul  3 17:06:35 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Tue, 3 Jul 2018 18:06:16 +0100
Subject: svn commit: r335879 - in head/sys: conf kern sys [ broke
 ci.freebsd.org's FreeBSD-head-amd64-build ]
In-Reply-To: <57f1f29f-220b-ebac-4318-b1db4ce25c6e@FreeBSD.org>
References: <5399C6EA-2904-4A1B-BF07-43A5D854A710@yahoo.com>
 <57f1f29f-220b-ebac-4318-b1db4ce25c6e@FreeBSD.org>
Message-ID: <CAKBkRUxEVxsEGjfD4XQsoeNM-XSNakOrBKkjsSx9G1QMP4FELQ@mail.gmail.com>

On Tue, Jul 3, 2018 at 5:30 PM Bryan Drewery <bdrewery at freebsd.org> wrote:
>
> On 7/2/2018 10:46 PM, Mark Millard wrote:
> > -r335879 broke ci.freebsd.org's FreeBSD-head-amd64-build :
> >
> > https://ci.freebsd.org/job/FreeBSD-head-amd64-build/
> >
> > shows:
> >
> > --- ia32_genassym.o ---
> > In file included from /usr/src/sys/compat/ia32/ia32_genassym.c:6:
> > In file included from /usr/src/sys/sys/systm.h:113:
> > /usr/src/sys/sys/kpilite.h:33:10: fatal error: 'offset.inc' file not found
> > #include "offset.inc"
> >          ^~~~~~~~~~~~
> > 1 error generated.
> > *** [ia32_genassym.o] Error code 1
> >
> > Later builds ( -r335880 , -r335881 , -r335882 ) get the same.
> >
> > FreeBSD-head-i386-LINT also fails for such reasons.
> >
>
> r335884 should fix this.

It seems that amd64 and i386 LINT are still failing.

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From imb at protected-networks.net  Tue Jul  3 17:47:45 2018
From: imb at protected-networks.net (Michael Butler)
Date: Tue, 3 Jul 2018 13:47:42 -0400
Subject: em0 link fail
Message-ID: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>

On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
(using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
can't without the em0 interface stalling :-(

On a guess, I tried reverting SVN r335303 but that didn't help.

em0: <Intel(R) PRO/1000 Network Connection> port 0xf080-0xf09f mem
0xf7e00000-0xf7e1ffff,0xf7e39000-0xf7e39fff irq 20 at device 25.0 on pci0
em0: attach_pre capping queues at 1
em0: using 1024 tx descriptors and 1024 rx descriptors
em0: msix_init qsets capped at 1
em0: PCIY_MSIX capability not found; or rid 0 == 0.
em0: Using an MSI interrupt
em0: allocated for 1 tx_queues
em0: allocated for 1 rx_queues
em0: Ethernet address: f0:1f:af:66:95:7e
em0: netmap queues/slots: TX 1/1024, RX 1/1024
em0: link state changed to UP

 [ initiate "zfs send" ]

em0: TX(0) desc avail = 41, pidx = 172
em0: link state changed to DOWN
em0: TX(0) desc avail = 1024, pidx = 0
em0: TX(0) desc avail = 1024, pidx = 0

 .. ad nauseum ..

"ifconfig em0 down; ifconfig em0 up" doesn't help.

Any hints?

	imb


From marklmi at yahoo.com  Tue Jul  3 17:48:27 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Tue, 3 Jul 2018 10:48:14 -0700
Subject: svn commit: r335879 - in head/sys: conf kern sys [ broke
 ci.freebsd.org's FreeBSD-head-amd64-build ]
In-Reply-To: <CAKBkRUxEVxsEGjfD4XQsoeNM-XSNakOrBKkjsSx9G1QMP4FELQ@mail.gmail.com>
References: <5399C6EA-2904-4A1B-BF07-43A5D854A710@yahoo.com>
 <57f1f29f-220b-ebac-4318-b1db4ce25c6e@FreeBSD.org>
 <CAKBkRUxEVxsEGjfD4XQsoeNM-XSNakOrBKkjsSx9G1QMP4FELQ@mail.gmail.com>
Message-ID: <B199CBCC-AA72-469E-9492-574028B1EB64@yahoo.com>



On 2018-Jul-3, at 10:06 AM, Li-Wen Hsu <lwhsu at freebsd.org> wrote:

> On Tue, Jul 3, 2018 at 5:30 PM Bryan Drewery <bdrewery at freebsd.org> wrote:
>> 
>> On 7/2/2018 10:46 PM, Mark Millard wrote:
>>> -r335879 broke ci.freebsd.org's FreeBSD-head-amd64-build :
>>> 
>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-build/
>>> 
>>> shows:
>>> 
>>> --- ia32_genassym.o ---
>>> In file included from /usr/src/sys/compat/ia32/ia32_genassym.c:6:
>>> In file included from /usr/src/sys/sys/systm.h:113:
>>> /usr/src/sys/sys/kpilite.h:33:10: fatal error: 'offset.inc' file not found
>>> #include "offset.inc"
>>>         ^~~~~~~~~~~~
>>> 1 error generated.
>>> *** [ia32_genassym.o] Error code 1
>>> 
>>> Later builds ( -r335880 , -r335881 , -r335882 ) get the same.
>>> 
>>> FreeBSD-head-i386-LINT also fails for such reasons.
>>> 
>> 
>> r335884 should fix this.
> 
> It seems that amd64 and i386 LINT are still failing.

https://ci.freebsd.org/job/FreeBSD-head-amd64-build/ shows that
#9303 (-r335884) and later for amd64 are building successfully.

But https://ci.freebsd.org/job/FreeBSD-head-i386-LINT/ shows
that -r335884 (#6934) and later ( -r335892 so far ) for i386's
LINT are still failing with:

--- linux_genassym.o ---
In file included from /workspace/src/sys/i386/linux/linux_genassym.c:6:
In file included from /workspace/src/sys/sys/systm.h:113:
/workspace/src/sys/sys/kpilite.h:33:10: fatal error: 'offset.inc' file not found
#include "offset.inc"
         ^~~~~~~~~~~~
1 error generated.
*** [linux_genassym.o] Error code 1



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From lists at opsec.eu  Tue Jul  3 18:06:38 2018
From: lists at opsec.eu (Kurt Jaeger)
Date: Tue, 3 Jul 2018 20:06:39 +0200
Subject: em0 link fail
In-Reply-To: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
Message-ID: <20180703180639.GA77764@home.opsec.eu>

Hi!

> On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
> (using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
> can't without the em0 interface stalling :-(

I had a similar case on a current r334918 and saw this in the kern syslog:

  Jun 30 15:40:34 fc kernel: em0: TX(0) desc avail = 1024, pidx = 0

A reboot was necessary to get this fixed.

-- 
pi at opsec.eu            +49 171 3101372                    2 years to go !

From zeising+freebsd at daemonic.se  Tue Jul  3 18:28:28 2018
From: zeising+freebsd at daemonic.se (Niclas Zeising)
Date: Tue, 3 Jul 2018 20:28:23 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
Message-ID: <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>

On 07/03/18 17:02, O. Hartmann wrote:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> 
> Am Tue, 3 Jul 2018 10:19:57 -0400
> Michael Butler <imb at protected-networks.net> schrieb:
> 
>> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
>>
>> --- i915_drv.o ---
>> In file included from i915_drv.c:30:
>> In file included from
>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
>> In file included from
>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
>> In file included from
>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>> In file included from
>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>> In file included from /usr/src/sys/sys/systm.h:44:
>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
>>                              ^
>> <inline asm>:1:7: note: instantiated into assembly here
>>          andq $9223372036854775807,40672(%r14)
>>               ^~~~~~~~~~~~~~~~~~~~~
>> 1 error generated.
>> *** [i915_drv.o] Error code 1
>>
>> make[3]: stopped in
>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>> --- i915_gem.o ---
>> In file included from i915_gem.c:28:
>> In file included from
>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
>> In file included from /usr/src/sys/sys/malloc.h:42:
>> In file included from /usr/src/sys/sys/systm.h:44:
>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
>>                              ^
>> <inline asm>:1:6: note: instantiated into assembly here
>>          orq $-9223372036854775808,40672(%r14)
>>              ^~~~~~~~~~~~~~~~~~~~~~
>> 1 error generated.
>> *** [i915_gem.o] Error code 1
>>
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 
> 
> It breaks also graphics/drm-stable-kmod (see PR 229484,
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you described
> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is < r335873,
> those kmod compile well.

We are looking into why both the drm ports fail.
Regards
-- 
Niclas


From sbruno at freebsd.org  Tue Jul  3 18:31:51 2018
From: sbruno at freebsd.org (Sean Bruno)
Date: Tue, 3 Jul 2018 12:31:47 -0600
Subject: em0 link fail
In-Reply-To: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
Message-ID: <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>



On 07/03/18 11:47, Michael Butler wrote:
> On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
> (using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
> can't without the em0 interface stalling :-(
> 

Can you tell what version of FreeBSD SVN was in use on "June 1st" ?

sean

> On a guess, I tried reverting SVN r335303 but that didn't help.
> 
> em0: <Intel(R) PRO/1000 Network Connection> port 0xf080-0xf09f mem
> 0xf7e00000-0xf7e1ffff,0xf7e39000-0xf7e39fff irq 20 at device 25.0 on pci0
> em0: attach_pre capping queues at 1
> em0: using 1024 tx descriptors and 1024 rx descriptors
> em0: msix_init qsets capped at 1
> em0: PCIY_MSIX capability not found; or rid 0 == 0.
> em0: Using an MSI interrupt
> em0: allocated for 1 tx_queues
> em0: allocated for 1 rx_queues
> em0: Ethernet address: f0:1f:af:66:95:7e
> em0: netmap queues/slots: TX 1/1024, RX 1/1024
> em0: link state changed to UP
> 
>  [ initiate "zfs send" ]
> 
> em0: TX(0) desc avail = 41, pidx = 172
> em0: link state changed to DOWN
> em0: TX(0) desc avail = 1024, pidx = 0
> em0: TX(0) desc avail = 1024, pidx = 0
> 
>  .. ad nauseum ..
> 
> "ifconfig em0 down; ifconfig em0 up" doesn't help.
> 
> Any hints?
> 
> 	imb
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 618 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180703/38120fec/attachment.sig>

From imb at protected-networks.net  Tue Jul  3 18:47:40 2018
From: imb at protected-networks.net (Michael Butler)
Date: Tue, 3 Jul 2018 14:47:07 -0400
Subject: em0 link fail
In-Reply-To: <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
Message-ID: <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>

On 07/03/18 14:31, Sean Bruno wrote:
> 
> 
> On 07/03/18 11:47, Michael Butler wrote:
>> On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
>> (using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
>> can't without the em0 interface stalling :-(
>>
> 
> Can you tell what version of FreeBSD SVN was in use on "June 1st" ?
> 
> sean

That would've been ..

Jun  1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
1 08:25:58 EDT 2018

I'm going to build one with SVN r334862 reverted to see if that works,

	imb


> 
>> On a guess, I tried reverting SVN r335303 but that didn't help.
>>
>> em0: <Intel(R) PRO/1000 Network Connection> port 0xf080-0xf09f mem
>> 0xf7e00000-0xf7e1ffff,0xf7e39000-0xf7e39fff irq 20 at device 25.0 on pci0
>> em0: attach_pre capping queues at 1
>> em0: using 1024 tx descriptors and 1024 rx descriptors
>> em0: msix_init qsets capped at 1
>> em0: PCIY_MSIX capability not found; or rid 0 == 0.
>> em0: Using an MSI interrupt
>> em0: allocated for 1 tx_queues
>> em0: allocated for 1 rx_queues
>> em0: Ethernet address: f0:1f:af:66:95:7e
>> em0: netmap queues/slots: TX 1/1024, RX 1/1024
>> em0: link state changed to UP
>>
>>  [ initiate "zfs send" ]
>>
>> em0: TX(0) desc avail = 41, pidx = 172
>> em0: link state changed to DOWN
>> em0: TX(0) desc avail = 1024, pidx = 0
>> em0: TX(0) desc avail = 1024, pidx = 0
>>
>>  .. ad nauseum ..
>>
>> "ifconfig em0 down; ifconfig em0 up" doesn't help.
>>
>> Any hints?
>>
>> 	imb
>>
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>
> 


From jhb at FreeBSD.org  Tue Jul  3 19:02:59 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Tue, 3 Jul 2018 12:02:56 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
Message-ID: <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>

On 7/3/18 11:28 AM, Niclas Zeising wrote:
> On 07/03/18 17:02, O. Hartmann wrote:
>> -----BEGIN PGP SIGNED MESSAGE-----
>> Hash: SHA512
>>
>> Am Tue, 3 Jul 2018 10:19:57 -0400
>> Michael Butler <imb at protected-networks.net> schrieb:
>>
>>> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
>>>
>>> --- i915_drv.o ---
>>> In file included from i915_drv.c:30:
>>> In file included from
>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
>>> In file included from
>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
>>> In file included from
>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>> In file included from
>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>> In file included from /usr/src/sys/sys/systm.h:44:
>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
>>>                              ^
>>> <inline asm>:1:7: note: instantiated into assembly here
>>>          andq $9223372036854775807,40672(%r14)
>>>               ^~~~~~~~~~~~~~~~~~~~~
>>> 1 error generated.
>>> *** [i915_drv.o] Error code 1
>>>
>>> make[3]: stopped in
>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>> --- i915_gem.o ---
>>> In file included from i915_gem.c:28:
>>> In file included from
>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>> In file included from /usr/src/sys/sys/systm.h:44:
>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
>>>                              ^
>>> <inline asm>:1:6: note: instantiated into assembly here
>>>          orq $-9223372036854775808,40672(%r14)
>>>              ^~~~~~~~~~~~~~~~~~~~~~
>>> 1 error generated.
>>> *** [i915_gem.o] Error code 1
>>>
>>> _______________________________________________
>>> freebsd-current at freebsd.org mailing list
>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>
>>
>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you described
>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is < r335873,
>> those kmod compile well.
> 
> We are looking into why both the drm ports fail.
> Regards
> 

I haven't yet tested an amd64 kernel with this, but I think this change to sys/amd64/include/atomic.h
might fix it:

Index: atomic.h
===================================================================
--- atomic.h	(revision 335896)
+++ atomic.h	(working copy)
@@ -446,10 +446,10 @@ ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~
 ATOMIC_ASM(add,	     int,   "addl %1,%0",  "ir",  v);
 ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
 
-ATOMIC_ASM(set,	     long,  "orq %1,%0",   "ir",  v);
-ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
-ATOMIC_ASM(add,	     long,  "addq %1,%0",  "ir",  v);
-ATOMIC_ASM(subtract, long,  "subq %1,%0",  "ir",  v);
+ATOMIC_ASM(set,	     long,  "orq %1,%0",   "er",  v);
+ATOMIC_ASM(clear,    long,  "andq %1,%0",  "er", ~v);
+ATOMIC_ASM(add,	     long,  "addq %1,%0",  "er",  v);
+ATOMIC_ASM(subtract, long,  "subq %1,%0",  "er",  v);
 
 #define	ATOMIC_LOADSTORE(TYPE)					\
 	ATOMIC_LOAD(TYPE);					\


-- 
John Baldwin

From imb at protected-networks.net  Tue Jul  3 19:14:41 2018
From: imb at protected-networks.net (Michael Butler)
Date: Tue, 3 Jul 2018 15:14:38 -0400
Subject: em0 link fail
In-Reply-To: <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
 <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
Message-ID: <4f8f2142-d1f8-881e-3181-fe208550f2a6@protected-networks.net>

On 7/3/18 14:47, I wrote:
> On 07/03/18 14:31, Sean Bruno wrote:
>>
>>
>> On 07/03/18 11:47, Michael Butler wrote:
>>> On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
>>> (using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
>>> can't without the em0 interface stalling :-(
>>>
>>
>> Can you tell what version of FreeBSD SVN was in use on "June 1st" ?
>>
>> sean
> 
> That would've been ..
> 
> Jun  1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
> 1 08:25:58 EDT 2018
> 
> I'm going to build one with SVN r334862 reverted to see if that works,

Sadly, no :-(

> 
>>
>>> On a guess, I tried reverting SVN r335303 but that didn't help.
>>>
>>> em0: <Intel(R) PRO/1000 Network Connection> port 0xf080-0xf09f mem
>>> 0xf7e00000-0xf7e1ffff,0xf7e39000-0xf7e39fff irq 20 at device 25.0 on pci0
>>> em0: attach_pre capping queues at 1
>>> em0: using 1024 tx descriptors and 1024 rx descriptors
>>> em0: msix_init qsets capped at 1
>>> em0: PCIY_MSIX capability not found; or rid 0 == 0.
>>> em0: Using an MSI interrupt
>>> em0: allocated for 1 tx_queues
>>> em0: allocated for 1 rx_queues
>>> em0: Ethernet address: f0:1f:af:66:95:7e
>>> em0: netmap queues/slots: TX 1/1024, RX 1/1024
>>> em0: link state changed to UP
>>>
>>>  [ initiate "zfs send" ]
>>>
>>> em0: TX(0) desc avail = 41, pidx = 172
>>> em0: link state changed to DOWN
>>> em0: TX(0) desc avail = 1024, pidx = 0
>>> em0: TX(0) desc avail = 1024, pidx = 0
>>>
>>>  .. ad nauseum ..
>>>
>>> "ifconfig em0 down; ifconfig em0 up" doesn't help.
>>>
>>> Any hints?
>>>
>>> 	imb
>>>
>>> _______________________________________________
>>> freebsd-current at freebsd.org mailing list
>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 


From jkim at FreeBSD.org  Tue Jul  3 19:23:42 2018
From: jkim at FreeBSD.org (Jung-uk Kim)
Date: Tue, 3 Jul 2018 15:23:30 -0400
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
Message-ID: <94747acc-dbf4-69db-aa19-687155f66dbf@FreeBSD.org>

On 07/03/2018 15:02, John Baldwin wrote:
> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>> On 07/03/18 17:02, O. Hartmann wrote:
>>> -----BEGIN PGP SIGNED MESSAGE-----
>>> Hash: SHA512
>>>
>>> Am Tue, 3 Jul 2018 10:19:57 -0400
>>> Michael Butler <imb at protected-networks.net> schrieb:
>>>
>>>> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
>>>>
>>>> --- i915_drv.o ---
>>>> In file included from i915_drv.c:30:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
>>>> In file included from
>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>> In file included from
>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>>> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
>>>>                              ^
>>>> <inline asm>:1:7: note: instantiated into assembly here
>>>>          andq $9223372036854775807,40672(%r14)
>>>>               ^~~~~~~~~~~~~~~~~~~~~
>>>> 1 error generated.
>>>> *** [i915_drv.o] Error code 1
>>>>
>>>> make[3]: stopped in
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>> --- i915_gem.o ---
>>>> In file included from i915_gem.c:28:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
>>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>>> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
>>>>                              ^
>>>> <inline asm>:1:6: note: instantiated into assembly here
>>>>          orq $-9223372036854775808,40672(%r14)
>>>>              ^~~~~~~~~~~~~~~~~~~~~~
>>>> 1 error generated.
>>>> *** [i915_gem.o] Error code 1
>>>>
>>>> _______________________________________________
>>>> freebsd-current at freebsd.org mailing list
>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>>
>>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you described
>>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is < r335873,
>>> those kmod compile well.
>>
>> We are looking into why both the drm ports fail.
>> Regards
>>
> 
> I haven't yet tested an amd64 kernel with this, but I think this change to sys/amd64/include/atomic.h
> might fix it:
> 
> Index: atomic.h
> ===================================================================
> --- atomic.h	(revision 335896)
> +++ atomic.h	(working copy)
> @@ -446,10 +446,10 @@ ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~
>  ATOMIC_ASM(add,	     int,   "addl %1,%0",  "ir",  v);
>  ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
>  
> -ATOMIC_ASM(set,	     long,  "orq %1,%0",   "ir",  v);
> -ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
> -ATOMIC_ASM(add,	     long,  "addq %1,%0",  "ir",  v);
> -ATOMIC_ASM(subtract, long,  "subq %1,%0",  "ir",  v);
> +ATOMIC_ASM(set,	     long,  "orq %1,%0",   "er",  v);
> +ATOMIC_ASM(clear,    long,  "andq %1,%0",  "er", ~v);
> +ATOMIC_ASM(add,	     long,  "addq %1,%0",  "er",  v);
> +ATOMIC_ASM(subtract, long,  "subq %1,%0",  "er",  v);
>  
>  #define	ATOMIC_LOADSTORE(TYPE)					\
>  	ATOMIC_LOAD(TYPE);					\

Isn't "Z" better than "e" in this case?

Jung-uk Kim

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 488 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180703/37a48ff3/attachment.sig>

From jkim at FreeBSD.org  Tue Jul  3 19:32:05 2018
From: jkim at FreeBSD.org (Jung-uk Kim)
Date: Tue, 3 Jul 2018 15:32:03 -0400
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <94747acc-dbf4-69db-aa19-687155f66dbf@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <94747acc-dbf4-69db-aa19-687155f66dbf@FreeBSD.org>
Message-ID: <a42279a7-a1eb-8d00-6026-8cdef6ec7c59@FreeBSD.org>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA256

On 07/03/2018 15:23, Jung-uk Kim wrote:
> On 07/03/2018 15:02, John Baldwin wrote:
>> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>>> On 07/03/18 17:02, O. Hartmann wrote:
>>>> -----BEGIN PGP SIGNED MESSAGE----- Hash: SHA512
>>>> 
>>>> Am Tue, 3 Jul 2018 10:19:57 -0400 Michael Butler 
>>>> <imb at protected-networks.net> schrieb:
>>>> 
>>>>> It seems recent changes (SVN r335873?) may have broken 
>>>>> drm-next-kmod ..
>>>>> 
>>>>> --- i915_drv.o --- In file included from i915_drv.c:30: In 
>>>>> file included from 
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gp
lv2/include/linux/acpi.h:26:
>>>>>
>>>>>
>>>>> 
In file included from
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gp
lv2/include/linux/device.h:4:
>>>>>
>>>>>
>>>>> 
In file included from
>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>>>
>>>>>
>>>>> 
In file included from
>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>>>
>>>>>
>>>>> 
In file included from /usr/src/sys/sys/systm.h:44:
>>>>> ./machine/atomic.h:450:29: error: invalid operand for 
>>>>> instruction ATOMIC_ASM(clear,    long,  "andq %1,%0", "ir",
>>>>> ~v); ^ <inline asm>:1:7: note: instantiated into assembly
>>>>> here andq $9223372036854775807,40672(%r14) 
>>>>> ^~~~~~~~~~~~~~~~~~~~~ 1 error generated. *** [i915_drv.o] 
>>>>> Error code 1
>>>>> 
>>>>> make[3]: stopped in 
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>>>
>>>>>
>>>>> 
- --- i915_gem.o ---
>>>>> In file included from i915_gem.c:28: In file included from
>>>>>  
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm
/drmP.h:38:
>>>>>
>>>>>
>>>>> 
In file included from /usr/src/sys/sys/malloc.h:42:
>>>>> In file included from /usr/src/sys/sys/systm.h:44: 
>>>>> ./machine/atomic.h:449:29: error: invalid operand for 
>>>>> instruction ATOMIC_ASM(set,      long,  "orq %1,%0", "ir",
>>>>> v); ^ <inline asm>:1:6: note: instantiated into assembly
>>>>> here orq $-9223372036854775808,40672(%r14) 
>>>>> ^~~~~~~~~~~~~~~~~~~~~~ 1 error generated. *** [i915_gem.o] 
>>>>> Error code 1
>>>>> 
>>>>> _______________________________________________ 
>>>>> freebsd-current at freebsd.org mailing list 
>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>>  To unsubscribe, send any mail to 
>>>>> "freebsd-current-unsubscribe at freebsd.org"
>>>> 
>>>> 
>>>> It breaks also graphics/drm-stable-kmod (see PR 229484, 
>>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, 
>>>> same error as you described above) and also 
>>>> emulators/virtualbox-ose-kmod. As long as CURRENT revision
>>>> is < r335873, those kmod compile well.
>>> 
>>> We are looking into why both the drm ports fail. Regards
>>> 
>> 
>> I haven't yet tested an amd64 kernel with this, but I think this 
>> change to sys/amd64/include/atomic.h might fix it:
>> 
>> Index: atomic.h 
>> ===================================================================
>>
>>
>> 
- --- atomic.h	(revision 335896)
>> +++ atomic.h	(working copy) @@ -446,10 +446,10 @@ 
>> ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~ 
>> ATOMIC_ASM(add,	     int,   "addl %1,%0",  "ir",  v); 
>> ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
>> 
>> -ATOMIC_ASM(set,	     long,  "orq %1,%0",   "ir",  v); 
>> -ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v); 
>> -ATOMIC_ASM(add,	     long,  "addq %1,%0",  "ir",  v); 
>> -ATOMIC_ASM(subtract, long,  "subq %1,%0",  "ir",  v); 
>> +ATOMIC_ASM(set,	     long,  "orq %1,%0",   "er",  v); 
>> +ATOMIC_ASM(clear,    long,  "andq %1,%0",  "er", ~v); 
>> +ATOMIC_ASM(add,	     long,  "addq %1,%0",  "er",  v); 
>> +ATOMIC_ASM(subtract, long,  "subq %1,%0",  "er",  v);
>> 
>> #define	ATOMIC_LOADSTORE(TYPE)					\ ATOMIC_LOAD(TYPE);					\
> 
> Isn't "Z" better than "e" in this case?

Never mind, brain fart.  These instructions are sign-extended.

Sorry for the noise.

Jung-uk Kim
-----BEGIN PGP SIGNATURE-----

iQEzBAEBCAAdFiEEl1bqgKaRyqfWXu/CfJ+WJvzb8UYFAls7zy8ACgkQfJ+WJvzb
8UYiOgf+PSb+Mv7UGCTUlftCiRmYYOW6ElMZSdr4tPinMocn4b/V9KJDqKOgO1SX
B2KCQHgSYt4Y+STiSrcCdhIkqCeIxdqJGHdTNpnpiUm7C+B50MrKgZo6n1xnlcCM
d4thqf0T/ZMaVaVEkZ42FTnmdXFo0L3jHNCHHYrpnXXXfRLJF6j5Q5Uetr1GEUJX
rpV2NIXMdk308qy4EvagLd0DEtT85QAjuG124nKh5FoSFD+5wBGFVrQWk4v4LVyd
rzBNM55JbTlEIFASlFjpiWJVhGvDzNVwN9XRxacYVgfEv23AMEibqhK12V48Lto/
X1/qHA0T9HC+gu/Eol+53AtU/P8ZyQ==
=cHxX
-----END PGP SIGNATURE-----

From yuri at rawbw.com  Tue Jul  3 19:46:03 2018
From: yuri at rawbw.com (Yuri)
Date: Tue, 3 Jul 2018 12:45:58 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't create
 the 'run0' interface any more
Message-ID: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>

I updated the laptop to r335884 last night, and 'service wpa_supplicant 
start wlan0' doesn't succeed any more.

kernel is supposed to create the network interface 'run0', but it 
doesn't. This is the immediate reason why wpa_supplicant fails.

The non-creation of 'run0' is a regression. I don't know of any workaround.


The steps 'mergemaster -p' and 'mergemaster' were done during the 
upgrade, so /etc is updated.


Yuri



From lev at FreeBSD.org  Tue Jul  3 19:50:28 2018
From: lev at FreeBSD.org (Lev Serebryakov)
Date: Tue, 3 Jul 2018 22:50:13 +0300
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
Message-ID: <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>

On 03.07.2018 22:45, Yuri wrote:

> I updated the laptop to r335884 last night, and 'service wpa_supplicant
> start wlan0' doesn't succeed any more.
> 
> kernel is supposed to create the network interface 'run0', but it
> doesn't. This is the immediate reason why wpa_supplicant fails.
> 
> The non-creation of 'run0' is a regression. I don't know of any workaround.
 No, it isn't.

 https://lists.freebsd.org/pipermail/freebsd-wireless/2016-October/007232.html

 I don't know, why is it not mentioned in UPDATING :-(


-- 
// Lev Serebryakov

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 963 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180703/46915a7d/attachment.sig>

From yuri at rawbw.com  Tue Jul  3 19:53:14 2018
From: yuri at rawbw.com (Yuri)
Date: Tue, 3 Jul 2018 12:53:07 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>
Message-ID: <8dc53310-b2a4-0537-8593-6376799d1cbc@rawbw.com>

On 07/03/18 12:50, Lev Serebryakov wrote:
>   No, it isn't.
>
>   https://lists.freebsd.org/pipermail/freebsd-wireless/2016-October/007232.html
>
>   I don't know, why is it not mentioned in UPDATING:-(


I may be mistaken about the interface creation.

But regardless of the cause, WiFi doesn't work any more. :-(


Yuri



From sbruno at freebsd.org  Tue Jul  3 20:54:52 2018
From: sbruno at freebsd.org (Sean Bruno)
Date: Tue, 3 Jul 2018 14:54:49 -0600
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <8dc53310-b2a4-0537-8593-6376799d1cbc@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>
 <8dc53310-b2a4-0537-8593-6376799d1cbc@rawbw.com>
Message-ID: <1bc18a88-bb06-1d1d-89f5-2bdf726421d5@freebsd.org>



On 07/03/18 13:53, Yuri wrote:
> On 07/03/18 12:50, Lev Serebryakov wrote:
>> ? No, it isn't.
>>
>> ?
>> https://lists.freebsd.org/pipermail/freebsd-wireless/2016-October/007232.html
>>
>>
>> ? I don't know, why is it not mentioned in UPDATING:-(
> 
> 
> I may be mistaken about the interface creation.
> 
> But regardless of the cause, WiFi doesn't work any more. :-(
> 
> 
> Yuri
> 
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 


Yuri:

If you're still having trouble, dump your rc.conf entries for your
wireless.  Mine looks like this at the moment with iwn(4):

wlans_iwn0="wlan0"
ifconfig_wlan0="WPA DHCP"

seam


-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 618 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180703/7cef3b03/attachment.sig>

From pete at nomadlogic.org  Tue Jul  3 21:17:29 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Tue, 3 Jul 2018 14:17:20 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
Message-ID: <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>



On 07/03/2018 12:02, John Baldwin wrote:
> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>> On 07/03/18 17:02, O. Hartmann wrote:
>>> -----BEGIN PGP SIGNED MESSAGE-----
>>> Hash: SHA512
>>>
>>> Am Tue, 3 Jul 2018 10:19:57 -0400
>>> Michael Butler <imb at protected-networks.net> schrieb:
>>>
>>>> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
>>>>
>>>> --- i915_drv.o ---
>>>> In file included from i915_drv.c:30:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4:
>>>> In file included from
>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>> In file included from
>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>>> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
>>>>                               ^
>>>> <inline asm>:1:7: note: instantiated into assembly here
>>>>           andq $9223372036854775807,40672(%r14)
>>>>                ^~~~~~~~~~~~~~~~~~~~~
>>>> 1 error generated.
>>>> *** [i915_drv.o] Error code 1
>>>>
>>>> make[3]: stopped in
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>> --- i915_gem.o ---
>>>> In file included from i915_gem.c:28:
>>>> In file included from
>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38:
>>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>>> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
>>>>                               ^
>>>> <inline asm>:1:6: note: instantiated into assembly here
>>>>           orq $-9223372036854775808,40672(%r14)
>>>>               ^~~~~~~~~~~~~~~~~~~~~~
>>>> 1 error generated.
>>>> *** [i915_gem.o] Error code 1
>>>>
>>>> _______________________________________________
>>>> freebsd-current at freebsd.org mailing list
>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you described
>>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is < r335873,
>>> those kmod compile well.
>> We are looking into why both the drm ports fail.
>> Regards
>>
> I haven't yet tested an amd64 kernel with this, but I think this change to sys/amd64/include/atomic.h
> might fix it:
>
> Index: atomic.h
> ===================================================================
> --- atomic.h	(revision 335896)
> +++ atomic.h	(working copy)
> @@ -446,10 +446,10 @@ ATOMIC_ASM(clear,    int,   "andl %1,%0",  "ir", ~
>   ATOMIC_ASM(add,	     int,   "addl %1,%0",  "ir",  v);
>   ATOMIC_ASM(subtract, int,   "subl %1,%0",  "ir",  v);
>   
> -ATOMIC_ASM(set,	     long,  "orq %1,%0",   "ir",  v);
> -ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
> -ATOMIC_ASM(add,	     long,  "addq %1,%0",  "ir",  v);
> -ATOMIC_ASM(subtract, long,  "subq %1,%0",  "ir",  v);
> +ATOMIC_ASM(set,	     long,  "orq %1,%0",   "er",  v);
> +ATOMIC_ASM(clear,    long,  "andq %1,%0",  "er", ~v);
> +ATOMIC_ASM(add,	     long,  "addq %1,%0",  "er",  v);
> +ATOMIC_ASM(subtract, long,  "subq %1,%0",  "er",  v);
>   
>   #define	ATOMIC_LOADSTORE(TYPE)					\
>   	ATOMIC_LOAD(TYPE);					\
>
>

i've just built a kernel with this patch applied, rebooted into it and 
was able to build the drm-next-kmod port.? i am also running X without 
issues so far with this configuration.

cheers,
-pete


-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From yuri at rawbw.com  Tue Jul  3 21:32:23 2018
From: yuri at rawbw.com (Yuri)
Date: Tue, 3 Jul 2018 14:32:19 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <1bc18a88-bb06-1d1d-89f5-2bdf726421d5@freebsd.org>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>
 <8dc53310-b2a4-0537-8593-6376799d1cbc@rawbw.com>
 <1bc18a88-bb06-1d1d-89f5-2bdf726421d5@freebsd.org>
Message-ID: <0d8d7084-291e-89ab-f973-a3ec4ed87755@rawbw.com>

On 07/03/18 13:54, Sean Bruno wrote:
> Yuri:
>
> If you're still having trouble, dump your rc.conf entries for your
> wireless.  Mine looks like this at the moment with iwn(4):
>
> wlans_iwn0="wlan0"
> ifconfig_wlan0="WPA DHCP"
>
> seam
>

Thank you, Sean!


rc.conf has:

wlans_iwn0="wlan0"

ifconfig_wlan0="WPA DHCP"

wpa_supplicant_enable="YES"

wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"


This worked before, and the only thing that has changed is that the system was updated.

The interface run0 exists.
After I run this command manually: ifconfig wlan0 create wlandev run0
wpa_supplicant works. But before this happened automatically, now it doesn't happen, and wpa_supplicant just fails.

Something in the system update affected the interoperability with wpa_supplicant.


Yuri


From yuri at rawbw.com  Tue Jul  3 21:43:31 2018
From: yuri at rawbw.com (Yuri)
Date: Tue, 3 Jul 2018 14:43:27 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <0d8d7084-291e-89ab-f973-a3ec4ed87755@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <55b549d9-70d3-2c30-c731-1d0d55fa3494@FreeBSD.org>
 <8dc53310-b2a4-0537-8593-6376799d1cbc@rawbw.com>
 <1bc18a88-bb06-1d1d-89f5-2bdf726421d5@freebsd.org>
 <0d8d7084-291e-89ab-f973-a3ec4ed87755@rawbw.com>
Message-ID: <4717816c-e9bd-3ee7-be03-9a284834a390@rawbw.com>

On 07/03/18 14:32, Yuri wrote:
>
>
> rc.conf has:
>
> wlans_iwn0="wlan0"
>
> ifconfig_wlan0="WPA DHCP"
>
> wpa_supplicant_enable="YES"
>
> wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"


This got mixed up.

rc.conf has:

wlans_run0="wlan0"
ifconfig_wlan0="WPA SYNCDHCP"
wpa_supplicant_enable="YES"
wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"


Yuri



From pete at nomadlogic.org  Tue Jul  3 22:12:54 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Tue, 3 Jul 2018 15:12:45 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
Message-ID: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>



On 07/03/2018 14:17, Pete Wright wrote:
>
>
> On 07/03/2018 12:02, John Baldwin wrote:
>> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>>> On 07/03/18 17:02, O. Hartmann wrote:
>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>> Hash: SHA512
>>>>
>>>> Am Tue, 3 Jul 2018 10:19:57 -0400
>>>> Michael Butler <imb at protected-networks.net> schrieb:
>>>>
>>>>> It seems recent changes (SVN r335873?) may have broken 
>>>>> drm-next-kmod ..
>>>>>
>>>>> --- i915_drv.o ---
>>>>> In file included from i915_drv.c:30:
>>>>> In file included from
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26: 
>>>>>
>>>>> In file included from
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4: 
>>>>>
>>>>> In file included from
>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>>> In file included from
>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>>>> ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>>>>> ????????????????????????????? ^
>>>>> <inline asm>:1:7: note: instantiated into assembly here
>>>>> ????????? andq $9223372036854775807,40672(%r14)
>>>>> ?????????????? ^~~~~~~~~~~~~~~~~~~~~
>>>>> 1 error generated.
>>>>> *** [i915_drv.o] Error code 1
>>>>>
>>>>> make[3]: stopped in
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>>> --- i915_gem.o ---
>>>>> In file included from i915_gem.c:28:
>>>>> In file included from
>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38: 
>>>>>
>>>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>>>> ATOMIC_ASM(set,????? long,? "orq %1,%0",?? "ir",? v);
>>>>> ????????????????????????????? ^
>>>>> <inline asm>:1:6: note: instantiated into assembly here
>>>>> ????????? orq $-9223372036854775808,40672(%r14)
>>>>> ????????????? ^~~~~~~~~~~~~~~~~~~~~~
>>>>> 1 error generated.
>>>>> *** [i915_gem.o] Error code 1
>>>>>
>>>>> _______________________________________________
>>>>> freebsd-current at freebsd.org mailing list
>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>> To unsubscribe, send any mail to 
>>>>> "freebsd-current-unsubscribe at freebsd.org"
>>>>
>>>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same 
>>>> error as you described
>>>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT 
>>>> revision is < r335873,
>>>> those kmod compile well.
>>> We are looking into why both the drm ports fail.
>>> Regards
>>>
>> I haven't yet tested an amd64 kernel with this, but I think this 
>> change to sys/amd64/include/atomic.h
>> might fix it:
>>
>> Index: atomic.h
>> ===================================================================
>> --- atomic.h??? (revision 335896)
>> +++ atomic.h??? (working copy)
>> @@ -446,10 +446,10 @@ ATOMIC_ASM(clear,??? int,?? "andl %1,%0", "ir", ~
>> ? ATOMIC_ASM(add,???????? int,?? "addl %1,%0",? "ir",? v);
>> ? ATOMIC_ASM(subtract, int,?? "subl %1,%0",? "ir",? v);
>> ? -ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "ir",? v);
>> -ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>> -ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "ir",? v);
>> -ATOMIC_ASM(subtract, long,? "subq %1,%0",? "ir",? v);
>> +ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "er",? v);
>> +ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "er", ~v);
>> +ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "er",? v);
>> +ATOMIC_ASM(subtract, long,? "subq %1,%0",? "er",? v);
>> ? ? #define??? ATOMIC_LOADSTORE(TYPE)??????????????????? \
>> ????? ATOMIC_LOAD(TYPE);??????????????????? \
>>
>>
>
> i've just built a kernel with this patch applied, rebooted into it and 
> was able to build the drm-next-kmod port.? i am also running X without 
> issues so far with this configuration.
>


oh neat - looks like this may have triggered a kernel panic. fortunately 
i was able to savecore.? here's the output of my info file:

info:
 ? Version String: FreeBSD 12.0-CURRENT #7 d7ac1268f3a(master)-dirty: 
Tue Jul? 3 13:53:50 PDT 2018
pete at duke:/usr/obj/usr/home/pete/git/freebsd/amd64.amd64/sys/GENERIC-EVDEV
 ? Panic String: Duplicate free of 0xfffff8010ac59000 from zone 
0xfffff800340935a0(i915_gem_request) slab 0xfffff8010ac43af0(0)

i didn't build a kernel.debug file unfortunately, but here's the output 
of my core.txt file, not sure how helpful it is:

BFD: /bootpool/boot/kernel/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
BFD: /bootpool/boot/kernel/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
/dev/stdin:1: Error in sourced command file:
Cannot access memory at address 0x65657246
BFD: /bootpool/boot/kernel/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
BFD: /bootpool/boot/kernel/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
/dev/stdin:1: Error in sourced command file:
Cannot access memory at address 0x65657246
BFD: /bootpool/boot/kernel.old/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
BFD: /bootpool/boot/kernel.old/kernel: invalid relocation type 37
BFD: BFD 2.17.50 [FreeBSD] 2007-07-03 assertion fail 
/usr/home/pete/git/freebsd/gnu/usr.bin/binutils/libbfd/../../../../contrib/binutils/bfd/elf64-x86-64.c:276
/dev/stdin:1: Error in sourced command file:
Cannot access memory at address 0x65657246
Unable to find matching kernel for /var/crash/vmcore.1


cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From pete at nomadlogic.org  Tue Jul  3 22:20:29 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Tue, 3 Jul 2018 15:20:22 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
Message-ID: <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>



On 07/03/2018 15:12, Pete Wright wrote:
>
>
> On 07/03/2018 14:17, Pete Wright wrote:
>>
>>
>> On 07/03/2018 12:02, John Baldwin wrote:
>>> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>>>> On 07/03/18 17:02, O. Hartmann wrote:
>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>> Hash: SHA512
>>>>>
>>>>> Am Tue, 3 Jul 2018 10:19:57 -0400
>>>>> Michael Butler <imb at protected-networks.net> schrieb:
>>>>>
>>>>>> It seems recent changes (SVN r335873?) may have broken 
>>>>>> drm-next-kmod ..
>>>>>>
>>>>>> --- i915_drv.o ---
>>>>>> In file included from i915_drv.c:30:
>>>>>> In file included from
>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26: 
>>>>>>
>>>>>> In file included from
>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4: 
>>>>>>
>>>>>> In file included from
>>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>>>> In file included from
>>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>>>>> ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>>>>>> ????????????????????????????? ^
>>>>>> <inline asm>:1:7: note: instantiated into assembly here
>>>>>> ????????? andq $9223372036854775807,40672(%r14)
>>>>>> ?????????????? ^~~~~~~~~~~~~~~~~~~~~
>>>>>> 1 error generated.
>>>>>> *** [i915_drv.o] Error code 1
>>>>>>
>>>>>> make[3]: stopped in
>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>>>> --- i915_gem.o ---
>>>>>> In file included from i915_gem.c:28:
>>>>>> In file included from
>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38: 
>>>>>>
>>>>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>>>>> ATOMIC_ASM(set,????? long,? "orq %1,%0",?? "ir",? v);
>>>>>> ????????????????????????????? ^
>>>>>> <inline asm>:1:6: note: instantiated into assembly here
>>>>>> ????????? orq $-9223372036854775808,40672(%r14)
>>>>>> ????????????? ^~~~~~~~~~~~~~~~~~~~~~
>>>>>> 1 error generated.
>>>>>> *** [i915_gem.o] Error code 1
>>>>>>
>>>>>> _______________________________________________
>>>>>> freebsd-current at freebsd.org mailing list
>>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>>> To unsubscribe, send any mail to 
>>>>>> "freebsd-current-unsubscribe at freebsd.org"
>>>>>
>>>>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>>>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same 
>>>>> error as you described
>>>>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT 
>>>>> revision is < r335873,
>>>>> those kmod compile well.
>>>> We are looking into why both the drm ports fail.
>>>> Regards
>>>>
>>> I haven't yet tested an amd64 kernel with this, but I think this 
>>> change to sys/amd64/include/atomic.h
>>> might fix it:
>>>
>>> Index: atomic.h
>>> ===================================================================
>>> --- atomic.h??? (revision 335896)
>>> +++ atomic.h??? (working copy)
>>> @@ -446,10 +446,10 @@ ATOMIC_ASM(clear,??? int,?? "andl %1,%0", "ir", ~
>>> ? ATOMIC_ASM(add,???????? int,?? "addl %1,%0",? "ir",? v);
>>> ? ATOMIC_ASM(subtract, int,?? "subl %1,%0",? "ir",? v);
>>> ? -ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "ir",? v);
>>> -ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>>> -ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "ir",? v);
>>> -ATOMIC_ASM(subtract, long,? "subq %1,%0",? "ir",? v);
>>> +ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "er",? v);
>>> +ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "er", ~v);
>>> +ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "er",? v);
>>> +ATOMIC_ASM(subtract, long,? "subq %1,%0",? "er",? v);
>>> ? ? #define??? ATOMIC_LOADSTORE(TYPE)??????????????????? \
>>> ????? ATOMIC_LOAD(TYPE);??????????????????? \
>>>
>>>
>>
>> i've just built a kernel with this patch applied, rebooted into it 
>> and was able to build the drm-next-kmod port.? i am also running X 
>> without issues so far with this configuration.
>>
>
>
> oh neat - looks like this may have triggered a kernel panic. 
> fortunately i was able to savecore.? here's the output of my info file:
>
> info:
> ? Version String: FreeBSD 12.0-CURRENT #7 d7ac1268f3a(master)-dirty: 
> Tue Jul? 3 13:53:50 PDT 2018
> pete at duke:/usr/obj/usr/home/pete/git/freebsd/amd64.amd64/sys/GENERIC-EVDEV 
>
> ? Panic String: Duplicate free of 0xfffff8010ac59000 from zone 
> 0xfffff800340935a0(i915_gem_request) slab 0xfffff8010ac43af0(0)
>
> i didn't build a kernel.debug file unfortunately, but here's the 
> output of my core.txt file, not sure how helpful it is:

darn, hit send too soon - i was looking in wrong place for debug kernel 
- here is some hopefully more helpful info:

$ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
Unread portion of the kernel message buffer:
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !mutex_is_locked(&mode_config->mutex) && 
!drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
/usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
WARNING !state->acquire_ctx failed at drm_atomic.c:909
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:909
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !mutex_is_locked(&mode_config->mutex) && 
!drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
/usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
WARNING !state->acquire_ctx failed at drm_atomic.c:909
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:909
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:634
WARNING !mutex_is_locked(&mode_config->mutex) && 
!drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
/usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
WARNING !mutex_is_locked(&mode_config->mutex) && 
!drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
/usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
WARNING !state->acquire_ctx failed at drm_atomic.c:270
panic: running but not TDS_RUNNING
cpuid = 7
time = 1530655265
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 
0xfffffe00756b9ef0
vpanic() at vpanic+0x1a3/frame 0xfffffe00756b9f50
doadump() at doadump/frame 0xfffffe00756b9fd0
sleepq_timedwait() at sleepq_timedwait+0x50/frame 0xfffffe00756ba010
linux_add_to_sleepqueue() at linux_add_to_sleepqueue+0xfd/frame 
0xfffffe00756ba060
linux_wait_event_common() at linux_wait_event_common+0x149/frame 
0xfffffe00756ba0b0
intel_atomic_wait_for_vblanks() at 
intel_atomic_wait_for_vblanks+0x38c/frame 0xfffffe00756ba200
intel_atomic_commit_tail() at intel_atomic_commit_tail+0x808/frame 
0xfffffe00756ba3e0
intel_atomic_commit() at intel_atomic_commit+0x24c/frame 0xfffffe00756ba460
drm_atomic_commit() at drm_atomic_commit+0x95/frame 0xfffffe00756ba490
restore_fbdev_mode_atomic() at restore_fbdev_mode_atomic+0x1da/frame 
0xfffffe00756ba510
restore_fbdev_mode() at restore_fbdev_mode+0x43/frame 0xfffffe00756ba5b0
drm_fb_helper_restore_fbdev_mode_unlocked() at 
drm_fb_helper_restore_fbdev_mode_unlocked+0x45/frame 0xfffffe00756ba5f0
vt_kms_postswitch() at vt_kms_postswitch+0x1e2/frame 0xfffffe00756ba660
vt_window_switch() at vt_window_switch+0x128/frame 0xfffffe00756ba6a0
vtterm_cngrab() at vtterm_cngrab+0x20/frame 0xfffffe00756ba6c0
cngrab() at cngrab+0x42/frame 0xfffffe00756ba6e0
vpanic() at vpanic+0xfb/frame 0xfffffe00756ba740
panic() at panic+0x43/frame 0xfffffe00756ba7a0
uma_dbg_free() at uma_dbg_free+0x174/frame 0xfffffe00756ba7d0
uma_zfree_arg() at uma_zfree_arg+0xf6/frame 0xfffffe00756ba830
linux_rcu_cleaner_func() at linux_rcu_cleaner_func+0xa2/frame 
0xfffffe00756ba860
taskqueue_run_locked() at taskqueue_run_locked+0x14c/frame 
0xfffffe00756ba8c0
taskqueue_run() at taskqueue_run+0x4a/frame 0xfffffe00756ba8e0
intr_event_execute_handlers() at intr_event_execute_handlers+0x99/frame 
0xfffffe00756ba920
ithread_loop() at ithread_loop+0xb7/frame 0xfffffe00756ba970
fork_exit() at fork_exit+0x84/frame 0xfffffe00756ba9b0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe00756ba9b0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic
<snip symbol loading>
#0? cpustop_handler () at 
/usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1379
1379??? ??? CPU_SET_ATOMIC(cpu, &stopped_cpus);
(kgdb) bt
#0? cpustop_handler () at 
/usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1379
#1? 0xffffffff811e9ae4 in ipi_nmi_handler () at 
/usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1337
#2? 0xffffffff81070d29 in trap (frame=0xffffffff81fb42f0) at 
/usr/home/pete/git/freebsd/sys/amd64/amd64/trap.c:192
#3? 0xffffffff8104d0d4 in nmi_calltrap () at 
/usr/home/pete/git/freebsd/sys/amd64/amd64/exception.S:768
#4? 0xffffffff811d9a2c in acpi_cpu_idle_mwait (mwait_hint=0) at 
cpufunc.h:620
Previous frame inner to this frame (corrupt stack?)
Current language:? auto; currently minimal
(kgdb)


-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Tue Jul  3 22:29:12 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Tue, 3 Jul 2018 15:29:07 -0700 (PDT)
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <4717816c-e9bd-3ee7-be03-9a284834a390@rawbw.com>
Message-ID: <201807032229.w63MT7Dp040183@pdx.rh.CN85.dnsmgr.net>

> On 07/03/18 14:32, Yuri wrote:
> >
> >
> > rc.conf has:
> >
> > wlans_iwn0="wlan0"
> >
> > ifconfig_wlan0="WPA DHCP"
> >
> > wpa_supplicant_enable="YES"
> >
> > wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"
                            ^^^^^^^^^^

What wpa_supplicant is this?
The normal system one lives in /sbin.

> 
> This got mixed up.
> 
> rc.conf has:
> 
> wlans_run0="wlan0"
> ifconfig_wlan0="WPA SYNCDHCP"
> wpa_supplicant_enable="YES"
> wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"
> 
> 
> Yuri
> 
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From jhb at FreeBSD.org  Tue Jul  3 22:29:54 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Tue, 3 Jul 2018 15:29:50 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
Message-ID: <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>

On 7/3/18 3:20 PM, Pete Wright wrote:
> 
> 
> On 07/03/2018 15:12, Pete Wright wrote:
>>
>>
>> On 07/03/2018 14:17, Pete Wright wrote:
>>>
>>>
>>> On 07/03/2018 12:02, John Baldwin wrote:
>>>> On 7/3/18 11:28 AM, Niclas Zeising wrote:
>>>>> On 07/03/18 17:02, O. Hartmann wrote:
>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>> Hash: SHA512
>>>>>>
>>>>>> Am Tue, 3 Jul 2018 10:19:57 -0400
>>>>>> Michael Butler <imb at protected-networks.net> schrieb:
>>>>>>
>>>>>>> It seems recent changes (SVN r335873?) may have broken 
>>>>>>> drm-next-kmod ..
>>>>>>>
>>>>>>> --- i915_drv.o ---
>>>>>>> In file included from i915_drv.c:30:
>>>>>>> In file included from
>>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/acpi.h:26: 
>>>>>>>
>>>>>>> In file included from
>>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/include/linux/device.h:4: 
>>>>>>>
>>>>>>> In file included from
>>>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
>>>>>>> In file included from
>>>>>>> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
>>>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>>>> ./machine/atomic.h:450:29: error: invalid operand for instruction
>>>>>>> ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>>>>>>> ????????????????????????????? ^
>>>>>>> <inline asm>:1:7: note: instantiated into assembly here
>>>>>>> ????????? andq $9223372036854775807,40672(%r14)
>>>>>>> ?????????????? ^~~~~~~~~~~~~~~~~~~~~
>>>>>>> 1 error generated.
>>>>>>> *** [i915_drv.o] Error code 1
>>>>>>>
>>>>>>> make[3]: stopped in
>>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
>>>>>>> --- i915_gem.o ---
>>>>>>> In file included from i915_gem.c:28:
>>>>>>> In file included from
>>>>>>> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:38: 
>>>>>>>
>>>>>>> In file included from /usr/src/sys/sys/malloc.h:42:
>>>>>>> In file included from /usr/src/sys/sys/systm.h:44:
>>>>>>> ./machine/atomic.h:449:29: error: invalid operand for instruction
>>>>>>> ATOMIC_ASM(set,????? long,? "orq %1,%0",?? "ir",? v);
>>>>>>> ????????????????????????????? ^
>>>>>>> <inline asm>:1:6: note: instantiated into assembly here
>>>>>>> ????????? orq $-9223372036854775808,40672(%r14)
>>>>>>> ????????????? ^~~~~~~~~~~~~~~~~~~~~~
>>>>>>> 1 error generated.
>>>>>>> *** [i915_gem.o] Error code 1
>>>>>>>
>>>>>>> _______________________________________________
>>>>>>> freebsd-current at freebsd.org mailing list
>>>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>>>> To unsubscribe, send any mail to 
>>>>>>> "freebsd-current-unsubscribe at freebsd.org"
>>>>>>
>>>>>> It breaks also graphics/drm-stable-kmod (see PR 229484,
>>>>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same 
>>>>>> error as you described
>>>>>> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT 
>>>>>> revision is < r335873,
>>>>>> those kmod compile well.
>>>>> We are looking into why both the drm ports fail.
>>>>> Regards
>>>>>
>>>> I haven't yet tested an amd64 kernel with this, but I think this 
>>>> change to sys/amd64/include/atomic.h
>>>> might fix it:
>>>>
>>>> Index: atomic.h
>>>> ===================================================================
>>>> --- atomic.h??? (revision 335896)
>>>> +++ atomic.h??? (working copy)
>>>> @@ -446,10 +446,10 @@ ATOMIC_ASM(clear,??? int,?? "andl %1,%0", "ir", ~
>>>> ? ATOMIC_ASM(add,???????? int,?? "addl %1,%0",? "ir",? v);
>>>> ? ATOMIC_ASM(subtract, int,?? "subl %1,%0",? "ir",? v);
>>>> ? -ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "ir",? v);
>>>> -ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "ir", ~v);
>>>> -ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "ir",? v);
>>>> -ATOMIC_ASM(subtract, long,? "subq %1,%0",? "ir",? v);
>>>> +ATOMIC_ASM(set,???????? long,? "orq %1,%0",?? "er",? v);
>>>> +ATOMIC_ASM(clear,??? long,? "andq %1,%0",? "er", ~v);
>>>> +ATOMIC_ASM(add,???????? long,? "addq %1,%0",? "er",? v);
>>>> +ATOMIC_ASM(subtract, long,? "subq %1,%0",? "er",? v);
>>>> ? ? #define??? ATOMIC_LOADSTORE(TYPE)??????????????????? \
>>>> ????? ATOMIC_LOAD(TYPE);??????????????????? \
>>>>
>>>>
>>>
>>> i've just built a kernel with this patch applied, rebooted into it 
>>> and was able to build the drm-next-kmod port.? i am also running X 
>>> without issues so far with this configuration.
>>>
>>
>>
>> oh neat - looks like this may have triggered a kernel panic. 
>> fortunately i was able to savecore.? here's the output of my info file:
>>
>> info:
>> ? Version String: FreeBSD 12.0-CURRENT #7 d7ac1268f3a(master)-dirty: 
>> Tue Jul? 3 13:53:50 PDT 2018
>> pete at duke:/usr/obj/usr/home/pete/git/freebsd/amd64.amd64/sys/GENERIC-EVDEV 
>>
>> ? Panic String: Duplicate free of 0xfffff8010ac59000 from zone 
>> 0xfffff800340935a0(i915_gem_request) slab 0xfffff8010ac43af0(0)
>>
>> i didn't build a kernel.debug file unfortunately, but here's the 
>> output of my core.txt file, not sure how helpful it is:
> 
> darn, hit send too soon - i was looking in wrong place for debug kernel 
> - here is some hopefully more helpful info:
> 
> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
> Unread portion of the kernel message buffer:
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !mutex_is_locked(&mode_config->mutex) && 
> !drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
> /usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
> WARNING !state->acquire_ctx failed at drm_atomic.c:909
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:909
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !mutex_is_locked(&mode_config->mutex) && 
> !drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
> /usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
> WARNING !state->acquire_ctx failed at drm_atomic.c:909
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:909
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:634
> WARNING !mutex_is_locked(&mode_config->mutex) && 
> !drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
> /usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
> WARNING !mutex_is_locked(&mode_config->mutex) && 
> !drm_modeset_is_locked(&mode_config->connection_mutex) failed at 
> /usr/home/pete/git/freebsd-ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drm_crtc.h:1403
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> WARNING !state->acquire_ctx failed at drm_atomic.c:270
> panic: running but not TDS_RUNNING
> cpuid = 7
> time = 1530655265
> KDB: stack backtrace:
> db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 
> 0xfffffe00756b9ef0
> vpanic() at vpanic+0x1a3/frame 0xfffffe00756b9f50
> doadump() at doadump/frame 0xfffffe00756b9fd0
> sleepq_timedwait() at sleepq_timedwait+0x50/frame 0xfffffe00756ba010
> linux_add_to_sleepqueue() at linux_add_to_sleepqueue+0xfd/frame 
> 0xfffffe00756ba060
> linux_wait_event_common() at linux_wait_event_common+0x149/frame 
> 0xfffffe00756ba0b0
> intel_atomic_wait_for_vblanks() at 
> intel_atomic_wait_for_vblanks+0x38c/frame 0xfffffe00756ba200
> intel_atomic_commit_tail() at intel_atomic_commit_tail+0x808/frame 
> 0xfffffe00756ba3e0
> intel_atomic_commit() at intel_atomic_commit+0x24c/frame 0xfffffe00756ba460
> drm_atomic_commit() at drm_atomic_commit+0x95/frame 0xfffffe00756ba490
> restore_fbdev_mode_atomic() at restore_fbdev_mode_atomic+0x1da/frame 
> 0xfffffe00756ba510
> restore_fbdev_mode() at restore_fbdev_mode+0x43/frame 0xfffffe00756ba5b0
> drm_fb_helper_restore_fbdev_mode_unlocked() at 
> drm_fb_helper_restore_fbdev_mode_unlocked+0x45/frame 0xfffffe00756ba5f0
> vt_kms_postswitch() at vt_kms_postswitch+0x1e2/frame 0xfffffe00756ba660
> vt_window_switch() at vt_window_switch+0x128/frame 0xfffffe00756ba6a0
> vtterm_cngrab() at vtterm_cngrab+0x20/frame 0xfffffe00756ba6c0
> cngrab() at cngrab+0x42/frame 0xfffffe00756ba6e0
> vpanic() at vpanic+0xfb/frame 0xfffffe00756ba740
> panic() at panic+0x43/frame 0xfffffe00756ba7a0
> uma_dbg_free() at uma_dbg_free+0x174/frame 0xfffffe00756ba7d0
> uma_zfree_arg() at uma_zfree_arg+0xf6/frame 0xfffffe00756ba830
> linux_rcu_cleaner_func() at linux_rcu_cleaner_func+0xa2/frame 
> 0xfffffe00756ba860
> taskqueue_run_locked() at taskqueue_run_locked+0x14c/frame 
> 0xfffffe00756ba8c0
> taskqueue_run() at taskqueue_run+0x4a/frame 0xfffffe00756ba8e0
> intr_event_execute_handlers() at intr_event_execute_handlers+0x99/frame 
> 0xfffffe00756ba920
> ithread_loop() at ithread_loop+0xb7/frame 0xfffffe00756ba970
> fork_exit() at fork_exit+0x84/frame 0xfffffe00756ba9b0
> fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe00756ba9b0
> --- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> KDB: enter: panic
> <snip symbol loading>
> #0? cpustop_handler () at 
> /usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1379
> 1379??? ??? CPU_SET_ATOMIC(cpu, &stopped_cpus);
> (kgdb) bt
> #0? cpustop_handler () at 
> /usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1379
> #1? 0xffffffff811e9ae4 in ipi_nmi_handler () at 
> /usr/home/pete/git/freebsd/sys/x86/x86/mp_x86.c:1337
> #2? 0xffffffff81070d29 in trap (frame=0xffffffff81fb42f0) at 
> /usr/home/pete/git/freebsd/sys/amd64/amd64/trap.c:192
> #3? 0xffffffff8104d0d4 in nmi_calltrap () at 
> /usr/home/pete/git/freebsd/sys/amd64/amd64/exception.S:768
> #4? 0xffffffff811d9a2c in acpi_cpu_idle_mwait (mwait_hint=0) at 
> cpufunc.h:620
> Previous frame inner to this frame (corrupt stack?)
> Current language:? auto; currently minimal
> (kgdb)

That seems like kgdb is looking at the wrong CPU.  Can you use
'info threads' and look for threads not stopped in 'sched_switch'
and get their backtraces?  You could also just do 'thread apply
all bt' and put that file at a URL if that is easiest.

-- 
John Baldwin

From pete at nomadlogic.org  Tue Jul  3 22:34:32 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Tue, 3 Jul 2018 15:34:24 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
Message-ID: <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>



On 07/03/2018 15:29, John Baldwin wrote:
> That seems like kgdb is looking at the wrong CPU.  Can you use
> 'info threads' and look for threads not stopped in 'sched_switch'
> and get their backtraces?  You could also just do 'thread apply
> all bt' and put that file at a URL if that is easiest.
>


sure thing John - here's a gist of "thread apply all bt"

https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed

cheers!
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From yuri at rawbw.com  Tue Jul  3 22:45:52 2018
From: yuri at rawbw.com (Yuri)
Date: Tue, 3 Jul 2018 15:45:48 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <201807032229.w63MT7Dp040183@pdx.rh.CN85.dnsmgr.net>
References: <201807032229.w63MT7Dp040183@pdx.rh.CN85.dnsmgr.net>
Message-ID: <985b0a68-a75b-895a-6d27-c040182752a8@rawbw.com>

On 07/03/18 15:29, Rodney W. Grimes wrote:
>>> wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"
>                              ^^^^^^^^^^
>
> What wpa_supplicant is this?
> The normal system one lives in /sbin.

It's installed by the package wpa_supplicant-2.6_2 from 
security/wpa_supplicant.
It is supposed to be the most recent version of the same project where 
system wpa_supplicant comes from.


Yuri


From jhb at FreeBSD.org  Tue Jul  3 22:56:28 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Tue, 3 Jul 2018 15:56:25 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
Message-ID: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>

On 7/3/18 3:34 PM, Pete Wright wrote:
> 
> 
> On 07/03/2018 15:29, John Baldwin wrote:
>> That seems like kgdb is looking at the wrong CPU.  Can you use
>> 'info threads' and look for threads not stopped in 'sched_switch'
>> and get their backtraces?  You could also just do 'thread apply
>> all bt' and put that file at a URL if that is easiest.
>>
> 
> 
> sure thing John - here's a gist of "thread apply all bt"
> 
> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed

That doesn't look right at all.  Are you sure the kernel matches the
vmcore?  Also, which kgdb version are you using?

-- 
John Baldwin

From jhb at FreeBSD.org  Tue Jul  3 23:02:01 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Tue, 3 Jul 2018 16:01:59 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <CAPrugNqvDKS8883wDWHiMJ1+hiRx5BfQaLJ3882X3RQrUgzP=w@mail.gmail.com>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <CAPrugNqvDKS8883wDWHiMJ1+hiRx5BfQaLJ3882X3RQrUgzP=w@mail.gmail.com>
Message-ID: <f28cd724-c0ae-353f-833a-5f7c51b807ac@FreeBSD.org>

On 7/3/18 3:40 PM, Matthew Macy wrote:
> This seems like a clang inline asm bug. Could you try building the port with a recent gcc against an unpatched HEAD?

I've already committed the patch to HEAD, but using 'e' is from the GCC docs, not clang docs:

https://gcc.gnu.org/onlinedocs/gcc/Machine-Constraints.html#Machine-Constraints

The disassembly of one of the functions from the kmod using one of the affected atomic ops would
show if it is working correctly (there should now be a mov with a 64-bit immediate into a register
followed by the atomic op using a register operand).  You could also try using just 'r' to always
force the use of a register.  It would be less optimal than "er" but should function correctly.

> On Tue, Jul 3, 2018 at 15:38 Pete Wright <pete at nomadlogic.org <mailto:pete at nomadlogic.org>> wrote:
> 
> 
> 
>     On 07/03/2018 15:29, John Baldwin wrote:
>     > That seems like kgdb is looking at the wrong CPU.? Can you use
>     > 'info threads' and look for threads not stopped in 'sched_switch'
>     > and get their backtraces?? You could also just do 'thread apply
>     > all bt' and put that file at a URL if that is easiest.
>     >
> 
> 
>     sure thing John - here's a gist of "thread apply all bt"
> 
>     https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> 
>     cheers!
>     -pete
> 
>     -- 
>     Pete Wright
>     pete at nomadlogic.org <mailto:pete at nomadlogic.org>
>     @nomadlogicLA
> 
>     _______________________________________________
>     freebsd-current at freebsd.org <mailto:freebsd-current at freebsd.org> mailing list
>     https://lists.freebsd.org/mailman/listinfo/freebsd-current
>     To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org <mailto:freebsd-current-unsubscribe at freebsd.org>"
> 


-- 
John Baldwin

From mat.macy at gmail.com  Tue Jul  3 22:40:56 2018
From: mat.macy at gmail.com (Matthew Macy)
Date: Tue, 3 Jul 2018 15:40:43 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
Message-ID: <CAPrugNqvDKS8883wDWHiMJ1+hiRx5BfQaLJ3882X3RQrUgzP=w@mail.gmail.com>

This seems like a clang inline asm bug. Could you try building the port
with a recent gcc against an unpatched HEAD?

On Tue, Jul 3, 2018 at 15:38 Pete Wright <pete at nomadlogic.org> wrote:

>
>
> On 07/03/2018 15:29, John Baldwin wrote:
> > That seems like kgdb is looking at the wrong CPU.  Can you use
> > 'info threads' and look for threads not stopped in 'sched_switch'
> > and get their backtraces?  You could also just do 'thread apply
> > all bt' and put that file at a URL if that is easiest.
> >
>
>
> sure thing John - here's a gist of "thread apply all bt"
>
> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>
> cheers!
> -pete
>
> --
> Pete Wright
> pete at nomadlogic.org
> @nomadlogicLA
>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From pete at nomadlogic.org  Wed Jul  4 00:10:25 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Tue, 3 Jul 2018 17:10:17 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
Message-ID: <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>



On 07/03/2018 15:56, John Baldwin wrote:
> On 7/3/18 3:34 PM, Pete Wright wrote:
>>
>> On 07/03/2018 15:29, John Baldwin wrote:
>>> That seems like kgdb is looking at the wrong CPU.  Can you use
>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>> and get their backtraces?  You could also just do 'thread apply
>>> all bt' and put that file at a URL if that is easiest.
>>>
>>
>> sure thing John - here's a gist of "thread apply all bt"
>>
>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> That doesn't look right at all.  Are you sure the kernel matches the
> vmcore?  Also, which kgdb version are you using?
>

yea i agree that doesn't look right at all.? here is my setup:

$ which kgdb
/usr/bin/kgdb
$ kgdb
GNU gdb 6.1.1 [FreeBSD]
$ ls -lh /var/crash/vmcore.1
-rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
$ ls -l /usr/lib/debug/boot/kernel/kernel.debug
-r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54 
/usr/lib/debug/boot/kernel/kernel.debug

and i invoke kgdb like so:
$ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1

here's a gist of my full gdb session:
http://termbin.com/krsn

dunno - maybe i have a bad core dump?? regardless, more than happy to 
help so let me know if i should try anything else or patches etc..

-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Wed Jul  4 01:13:50 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Tue, 3 Jul 2018 18:13:44 -0700 (PDT)
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <985b0a68-a75b-895a-6d27-c040182752a8@rawbw.com>
Message-ID: <201807040113.w641Dirc040693@pdx.rh.CN85.dnsmgr.net>

[ Charset UTF-8 unsupported, converting... ]
> On 07/03/18 15:29, Rodney W. Grimes wrote:
> >>> wpa_supplicant_program="/usr/local/sbin/wpa_supplicant"
> >                              ^^^^^^^^^^
> >
> > What wpa_supplicant is this?
> > The normal system one lives in /sbin.
> 
> It's installed by the package wpa_supplicant-2.6_2 from 
> security/wpa_supplicant.
> It is supposed to be the most recent version of the same project where 
> system wpa_supplicant comes from.

Do you get the same failure condition if you use the
wpa_supplicant from the base system?

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From Cy.Schubert at cschubert.com  Wed Jul  4 06:26:19 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Tue, 03 Jul 2018 22:55:22 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: Message from Niclas Zeising <zeising+freebsd@daemonic.se> of "Tue,
 03 Jul 2018 20:28:23 +0200."
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
Message-ID: <201807040556.w645tMAU021405@slippy.cwsent.com>

In message <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b at daemonic.se>, Niclas 
Zeising w
rites:
> On 07/03/18 17:02, O. Hartmann wrote:
> > -----BEGIN PGP SIGNED MESSAGE-----
> > Hash: SHA512
> > 
> > Am Tue, 3 Jul 2018 10:19:57 -0400
> > Michael Butler <imb at protected-networks.net> schrieb:
> > 
> >> It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
> >>
> >> --- i915_drv.o ---
> >> In file included from i915_drv.c:30:
> >> In file included from
> >> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/incl
> ude/linux/acpi.h:26:
> >> In file included from
> >> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/incl
> ude/linux/device.h:4:
> >> In file included from
> >> /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
> >> In file included from
> >> /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
> >> In file included from /usr/src/sys/sys/systm.h:44:
> >> ./machine/atomic.h:450:29: error: invalid operand for instruction
> >> ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
> >>                              ^
> >> <inline asm>:1:7: note: instantiated into assembly here
> >>          andq $9223372036854775807,40672(%r14)
> >>               ^~~~~~~~~~~~~~~~~~~~~
> >> 1 error generated.
> >> *** [i915_drv.o] Error code 1
> >>
> >> make[3]: stopped in
> >> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
> >> --- i915_gem.o ---
> >> In file included from i915_gem.c:28:
> >> In file included from
> >> /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:
> 38:
> >> In file included from /usr/src/sys/sys/malloc.h:42:
> >> In file included from /usr/src/sys/sys/systm.h:44:
> >> ./machine/atomic.h:449:29: error: invalid operand for instruction
> >> ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
> >>                              ^
> >> <inline asm>:1:6: note: instantiated into assembly here
> >>          orq $-9223372036854775808,40672(%r14)
> >>              ^~~~~~~~~~~~~~~~~~~~~~
> >> 1 error generated.
> >> *** [i915_gem.o] Error code 1
> >>
> >> _______________________________________________
> >> freebsd-current at freebsd.org mailing list
> >> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> > 
> > 
> > It breaks also graphics/drm-stable-kmod (see PR 229484,
> > https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you
>  described
> > above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision 
> is < r335873,
> > those kmod compile well.

The vbox issue looks like namespace pollution.


-- 
Cheers,
Cy Schubert <Cy.Schubert at cschubert.com>
FreeBSD UNIX:  <cy at FreeBSD.org>   Web:  http://www.FreeBSD.org

	The need of the many outweighs the greed of the few.



From yuri at rawbw.com  Wed Jul  4 08:22:46 2018
From: yuri at rawbw.com (Yuri)
Date: Wed, 4 Jul 2018 01:22:35 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <201807040113.w641Dirc040693@pdx.rh.CN85.dnsmgr.net>
References: <201807040113.w641Dirc040693@pdx.rh.CN85.dnsmgr.net>
Message-ID: <4ec7b3bc-ab63-ae8d-bc21-4b01d9053c8e@rawbw.com>

On 07/03/18 18:13, Rodney W. Grimes wrote:
> Do you get the same failure condition if you use the
> wpa_supplicant from the base system?


Same failure with the base wpa_supplicant.

Creating wlan0 by hand helps, but this should happen automatically. 
restarting devd service also helps.


I think wlan0 creation happens before wpa_supplicant due to the 
instruction 'wlans_run0="wlan0"'.

Something changed in /etc/network.subr or /etc/rc.d/netif or in devd or 
its configuration.

It definitely did create the run0 interface before, and now it doesn't.


Yuri




From linus.sundqvist at loopia.se  Wed Jul  4 09:28:46 2018
From: linus.sundqvist at loopia.se (Linus Sundqvist)
Date: Wed, 4 Jul 2018 11:28:39 +0200
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
Message-ID: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>

Hi,

I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
https://imgur.com/a/Idljfhm

The bootonly ISOs seems to show the same error message.

Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.

The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.

I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:

https://reviews.freebsd.org/D13784
https://svnweb.freebsd.org/base?view=revision&revision=332416

So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:

R440
R630
R430
FC430
R330
R620
R420
R610

-- 
Med v?nlig h?lsning/Best Regards
Linus Sundqvist
System Engineer, Loopia AB

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180704/bb2217ce/attachment.sig>

From tsoome at me.com  Wed Jul  4 13:08:46 2018
From: tsoome at me.com (Toomas Soome)
Date: Wed, 04 Jul 2018 16:08:22 +0300
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
Message-ID: <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>

Can you post lsdev -v output?

Also, could you try ls command? Like, ls cd0:   

Rgds,
Toomas

Sent from my iPhone

> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> 
> Hi,
> 
> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
> https://imgur.com/a/Idljfhm
> 
> The bootonly ISOs seems to show the same error message.
> 
> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
> 
> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
> 
> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
> 
> https://reviews.freebsd.org/D13784
> https://svnweb.freebsd.org/base?view=revision&revision=332416
> 
> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
> 
> R440
> R630
> R430
> FC430
> R330
> R620
> R420
> R610
> 
> -- 
> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
> 

From linus.sundqvist at loopia.se  Wed Jul  4 13:25:48 2018
From: linus.sundqvist at loopia.se (Linus Sundqvist)
Date: Wed, 4 Jul 2018 15:25:36 +0200
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
Message-ID: <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>

Hi,

Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
https://imgur.com/RmYpg7u

and here is ls cd1:
https://imgur.com/FPsixOw

Med v?nlig h?lsning/Best Regards
Linus Sundqvist
System Engineer, Loopia AB

On 04/07/18 15:08, Toomas Soome wrote:
> Can you post lsdev -v output?
> 
> Also, could you try ls command? Like, ls cd0:   
> 
> Rgds,
> Toomas
> 
> Sent from my iPhone
> 
>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>
>> Hi,
>>
>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>> https://imgur.com/a/Idljfhm
>>
>> The bootonly ISOs seems to show the same error message.
>>
>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>
>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>
>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>
>> https://reviews.freebsd.org/D13784
>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>
>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>
>> R440
>> R630
>> R430
>> FC430
>> R330
>> R620
>> R420
>> R610
>>
>> -- 
>> Med v?nlig h?lsning/Best Regards
>> Linus Sundqvist
>> System Engineer, Loopia AB
>>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180704/4728d4f9/attachment.sig>

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Wed Jul  4 14:27:18 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Wed, 4 Jul 2018 07:27:13 -0700 (PDT)
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <4ec7b3bc-ab63-ae8d-bc21-4b01d9053c8e@rawbw.com>
Message-ID: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>

[ Charset UTF-8 unsupported, converting... ]
> On 07/03/18 18:13, Rodney W. Grimes wrote:
> > Do you get the same failure condition if you use the
> > wpa_supplicant from the base system?
> 
> 
> Same failure with the base wpa_supplicant.
> 
> Creating wlan0 by hand helps, but this should happen automatically. 
> restarting devd service also helps.
> 
> 
> I think wlan0 creation happens before wpa_supplicant due to the 
> instruction 'wlans_run0="wlan0"'.
> 
> Something changed in /etc/network.subr or /etc/rc.d/netif or in devd or 
> its configuration.

Devd/devmatch is one of the largest changes recently,
it could be something in that code path.

Do you get the if_run.ko module loaded?  What does kldstat show
immediately after boot and before you try to "fix" anything with
ifconfig.


> It definitely did create the run0 interface before, and now it doesn't.

I wonder if the kernel module is no longer loading...


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Wed Jul  4 14:36:01 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Wed, 4 Jul 2018 07:35:58 -0700 (PDT)
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
Message-ID: <201807041435.w64EZwIn043295@pdx.rh.CN85.dnsmgr.net>

> Hi,
> 
> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
> https://imgur.com/a/Idljfhm
> 
> The bootonly ISOs seems to show the same error message.

Are you booting from a USB thumb drive,
an actual CD drive,
or the emulated CD drive from a Dell DRAC?

It appears that you have the boot media in cd1: not cd0:,
I am not sure the code handles this well.

> 
> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
> 
> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.

Does it show you booted from cd1:?

> 
> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
> 
> https://reviews.freebsd.org/D13784
> https://svnweb.freebsd.org/base?view=revision&revision=332416
> 
> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
> 
> R440
> R630
> R430
> FC430
> R330
> R620
> R420
> R610

Try the following at the OK prompt:
OK  load cd1:/boot/kernel/kernel
OK  boot


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From tsoome at me.com  Wed Jul  4 15:50:46 2018
From: tsoome at me.com (Toomas Soome)
Date: Wed, 04 Jul 2018 17:50:36 +0300
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
Message-ID: <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>

set currdev=cd1:
include /boot/loader.rc

This should give menu/boot.

Rgds,
Toomas

Sent from my iPhone

> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> 
> Hi,
> 
> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
> https://imgur.com/RmYpg7u
> 
> and here is ls cd1:
> https://imgur.com/FPsixOw
> 
> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
> 
>> On 04/07/18 15:08, Toomas Soome wrote:
>> Can you post lsdev -v output?
>> 
>> Also, could you try ls command? Like, ls cd0:   
>> 
>> Rgds,
>> Toomas
>> 
>> Sent from my iPhone
>> 
>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>> 
>>> Hi,
>>> 
>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>> https://imgur.com/a/Idljfhm
>>> 
>>> The bootonly ISOs seems to show the same error message.
>>> 
>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>> 
>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>> 
>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>> 
>>> https://reviews.freebsd.org/D13784
>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>> 
>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>> 
>>> R440
>>> R630
>>> R430
>>> FC430
>>> R330
>>> R620
>>> R420
>>> R610
>>> 
>>> -- 
>>> Med v?nlig h?lsning/Best Regards
>>> Linus Sundqvist
>>> System Engineer, Loopia AB
>>> 
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>> 
> 

From ler at FreeBSD.org  Wed Jul  4 16:51:55 2018
From: ler at FreeBSD.org (Larry Rosenman)
Date: Wed, 4 Jul 2018 11:51:53 -0500
Subject: Crash in udp6_input on -HEAD
Message-ID: <20180704165153.ppkluljubj4d5sgs@ler-imac.local>

borg.lerctr.org dumped core - see /var/crash/vmcore.0

Wed Jul  4 11:37:29 CDT 2018

FreeBSD borg.lerctr.org 12.0-CURRENT FreeBSD 12.0-CURRENT #46 r335957: Wed Jul  4 11:08:13 CDT 2018     root at borg.lerctr.org:/usr/obj/usr/src/amd64.amd64/sys/VT-LER  amd64

panic: page fault

GNU gdb (GDB) 8.1 [GDB v8.1 for FreeBSD]
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-portbld-freebsd12.0".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /boot/kernel/kernel...Reading symbols from /usr/lib/debug//boot/kernel/kernel.debug...done.
done.

Unread portion of the kernel message buffer:
<118>Starting cupsd.


Fatal trap 12: page fault while in kernel mode
cpuid = 17; apic id = 05
fault virtual address	= 0x60
fault code		= supervisor read data, page not present
instruction pointer	= 0x20:0xffffffff80e0f61f
stack pointer	        = 0x28:0xfffffe00004288a0
frame pointer	        = 0x28:0xfffffe00004289b0
code segment		= base 0x0, limit 0xfffff, type 0x1b
			= DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags	= interrupt enabled, resume, IOPL = 0
current process		= 12 (swi1: netisr 0)
trap number		= 12
panic: page fault
cpuid = 17
time = 1530721146
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe0000428550
vpanic() at vpanic+0x1a3/frame 0xfffffe00004285b0
panic() at panic+0x43/frame 0xfffffe0000428610
trap_fatal() at trap_fatal+0x35f/frame 0xfffffe0000428660
trap_pfault() at trap_pfault+0x49/frame 0xfffffe00004286c0
trap() at trap+0x2ba/frame 0xfffffe00004287d0
calltrap() at calltrap+0x8/frame 0xfffffe00004287d0
--- trap 0xc, rip = 0xffffffff80e0f61f, rsp = 0xfffffe00004288a0, rbp = 0xfffffe00004289b0 ---
udp6_input() at udp6_input+0xbdf/frame 0xfffffe00004289b0
ip6_input() at ip6_input+0xdd8/frame 0xfffffe0000428aa0
swi_net() at swi_net+0x1b9/frame 0xfffffe0000428b20
intr_event_execute_handlers() at intr_event_execute_handlers+0x99/frame 0xfffffe0000428b60
ithread_loop() at ithread_loop+0xb7/frame 0xfffffe0000428bb0
fork_exit() at fork_exit+0x84/frame 0xfffffe0000428bf0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe0000428bf0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
Uptime: 1m3s
Dumping 6608 out of 130994 MB:..1%..11%..21%..31%..41%..51%..61%..71%..81%..91%

__curthread () at ./machine/pcpu.h:231
231		__asm("movq %%gs:%1,%0" : "=r" (td)
(kgdb) #0  __curthread () at ./machine/pcpu.h:231
#1  doadump (textdump=1) at /usr/src/sys/kern/kern_shutdown.c:366
#2  0xffffffff80b909b2 in kern_reboot (howto=260)
    at /usr/src/sys/kern/kern_shutdown.c:446
#3  0xffffffff80b90f93 in vpanic (fmt=<optimized out>, ap=0xfffffe00004285f0)
    at /usr/src/sys/kern/kern_shutdown.c:863
#4  0xffffffff80b90fe3 in panic (fmt=<unavailable>)
    at /usr/src/sys/kern/kern_shutdown.c:790
#5  0xffffffff8107291f in trap_fatal (frame=0xfffffe00004287e0, eva=96)
    at /usr/src/sys/amd64/amd64/trap.c:892
#6  0xffffffff81072979 in trap_pfault (frame=0xfffffe00004287e0, usermode=0)
    at /usr/src/sys/amd64/amd64/trap.c:728
#7  0xffffffff81071f9a in trap (frame=0xfffffe00004287e0)
    at /usr/src/sys/amd64/amd64/trap.c:427
#8  <signal handler called>
#9  udp6_input (mp=<optimized out>, offp=<optimized out>, 
    proto=<optimized out>) at /usr/src/sys/netinet6/udp6_usrreq.c:424
#10 0xffffffff80df0c18 in ip6_input (m=0xfffff80237299400)
    at /usr/src/sys/netinet6/ip6_input.c:962
#11 0xffffffff80cb6919 in netisr_process_workstream_proto (
    nwsp=<optimized out>, proto=<optimized out>)
    at /usr/src/sys/net/netisr.c:901
#12 swi_net (arg=<optimized out>) at /usr/src/sys/net/netisr.c:948
#13 0xffffffff80b52289 in intr_event_execute_handlers (p=<optimized out>, 
    ie=0xfffff8012088e500) at /usr/src/sys/kern/kern_intr.c:1013
#14 0xffffffff80b529c7 in ithread_execute_handlers (ie=<optimized out>, 
    p=<optimized out>) at /usr/src/sys/kern/kern_intr.c:1026
#15 ithread_loop (arg=0xfffff8012088e100)
    at /usr/src/sys/kern/kern_intr.c:1106
#16 0xffffffff80b4f704 in fork_exit (
    callout=0xffffffff80b52910 <ithread_loop>, arg=0xfffff8012088e100, 
    frame=0xfffffe0000428c00) at /usr/src/sys/kern/kern_fork.c:1057
#17 <signal handler called>
(kgdb) 


vmcore *IS* available, as is a 2nd one.

This is after an upgrade from 
FreeBSD borg.lerctr.org 12.0-CURRENT FreeBSD 12.0-CURRENT #45 r335610: Sun Jun 24 17:12:56 CDT 2018     root at borg.lerctr.org:/usr/obj/usr/src/amd64.amd64/sys/VT-LER  amd64 1200069 1200071
to r335957.



Ideas?
-- 
Larry Rosenman                         https://people.FreeBSD.org/~ler/
Phone: +1 214-642-9640                 E-Mail: ler at FreeBSD.org
US Mail: 5708 Sabbia Drive, Round Rock, TX 78665-2106
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 679 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180704/7924a1d4/attachment.sig>

From hps at selasky.org  Wed Jul  4 16:57:48 2018
From: hps at selasky.org (Hans Petter Selasky)
Date: Wed, 4 Jul 2018 18:57:19 +0200
Subject: Crash in udp6_input on -HEAD
In-Reply-To: <20180704165153.ppkluljubj4d5sgs@ler-imac.local>
References: <20180704165153.ppkluljubj4d5sgs@ler-imac.local>
Message-ID: <8c133974-8e13-20ac-5063-ec2221b0f909@selasky.org>

On 07/04/18 18:51, Larry Rosenman wrote:
> borg.lerctr.org dumped core - see /var/crash/vmcore.0

> 
> Ideas?
> 
https://svnweb.freebsd.org/changeset/base/335958

From ler at lerctr.org  Wed Jul  4 17:09:38 2018
From: ler at lerctr.org (Larry Rosenman)
Date: Wed, 4 Jul 2018 12:09:35 -0500
Subject: Crash in udp6_input on -HEAD
In-Reply-To: <8c133974-8e13-20ac-5063-ec2221b0f909@selasky.org>
References: <20180704165153.ppkluljubj4d5sgs@ler-imac.local>
 <8c133974-8e13-20ac-5063-ec2221b0f909@selasky.org>
Message-ID: <20180704170935.zyrhfa3kue22q2mj@ler-imac.local>

On Wed, Jul 04, 2018 at 06:57:19PM +0200, Hans Petter Selasky wrote:
> On 07/04/18 18:51, Larry Rosenman wrote:
> > borg.lerctr.org dumped core - see /var/crash/vmcore.0
> 
> > 
> > Ideas?
> > 
> https://svnweb.freebsd.org/changeset/base/335958

Thanks!  That fixes it for me.
-- 
Larry Rosenman                     http://www.lerctr.org/~ler
Phone: +1 214-642-9640                 E-Mail: ler at lerctr.org
US Mail: 5708 Sabbia Drive, Round Rock, TX 78665-2106

From yuri at rawbw.com  Wed Jul  4 18:49:17 2018
From: yuri at rawbw.com (Yuri)
Date: Wed, 4 Jul 2018 11:49:12 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>
References: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>
Message-ID: <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>

On 07/04/18 07:27, Rodney W. Grimes wrote:
> Devd/devmatch is one of the largest changes recently,
> it could be something in that code path.
>
> Do you get the if_run.ko module loaded?  What does kldstat show
> immediately after boot and before you try to "fix" anything with
> ifconfig.
>
>
>> It definitely did create the run0 interface before, and now it doesn't.
> I wonder if the kernel module is no longer loading...


if_run.ko isn't loaded after boot. But I think it is supposed to be 
loaded by devd too.


Yuri



From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Wed Jul  4 19:00:29 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Wed, 4 Jul 2018 12:00:26 -0700 (PDT)
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>
Message-ID: <201807041900.w64J0QeZ044339@pdx.rh.CN85.dnsmgr.net>

> On 07/04/18 07:27, Rodney W. Grimes wrote:
> > Devd/devmatch is one of the largest changes recently,
> > it could be something in that code path.
> >
> > Do you get the if_run.ko module loaded?  What does kldstat show
> > immediately after boot and before you try to "fix" anything with
> > ifconfig.
> >
> >
> >> It definitely did create the run0 interface before, and now it doesn't.
> > I wonder if the kernel module is no longer loading...
> 
> 
> if_run.ko isn't loaded after boot. But I think it is supposed to be 
> loaded by devd too.

Just for fun to see if this can clear up your issue add
	if_run_load="YES"
to /boot/loader.conf


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From yuri at rawbw.com  Wed Jul  4 19:06:40 2018
From: yuri at rawbw.com (Yuri)
Date: Wed, 4 Jul 2018 12:06:35 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <201807041900.w64J0QeZ044339@pdx.rh.CN85.dnsmgr.net>
References: <201807041900.w64J0QeZ044339@pdx.rh.CN85.dnsmgr.net>
Message-ID: <14f86d91-1550-ba3e-a71d-36364155593e@rawbw.com>

On 07/04/18 12:00, Rodney W. Grimes wrote:
> Just for fun to see if this can clear up your issue add
> 	if_run_load="YES"
> to /boot/loader.conf


This doesn't help. In the presence of preloaded if_run.ko wpa_supplicant 
still can't initialize wlan0.


Yuri



From rkoberman at gmail.com  Wed Jul  4 19:11:43 2018
From: rkoberman at gmail.com (Kevin Oberman)
Date: Wed, 4 Jul 2018 12:11:40 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>
References: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>
 <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>
Message-ID: <CAN6yY1smGKsWpgusDaL19yLprzMp1K16eWrnFcggGoR54+m+Jg@mail.gmail.com>

On Wed, Jul 4, 2018 at 11:49 AM, Yuri <yuri at rawbw.com> wrote:

> On 07/04/18 07:27, Rodney W. Grimes wrote:
>
>> Devd/devmatch is one of the largest changes recently,
>> it could be something in that code path.
>>
>> Do you get the if_run.ko module loaded?  What does kldstat show
>> immediately after boot and before you try to "fix" anything with
>> ifconfig.
>>
>>
>> It definitely did create the run0 interface before, and now it doesn't.
>>>
>> I wonder if the kernel module is no longer loading...
>>
>
>
> if_run.ko isn't loaded after boot. But I think it is supposed to be loaded
> by devd too.
>
>
> Yuri
>

A quick perusal of /etc/devd.conf does not indicate that devd will load the
driver. It is possible that I missed something, but "run" i only referenced
as a part of long regex to stop or start pccard-ether.
--
Kevin Oberman, Part time kid herder and retired Network Engineer
E-mail: rkoberman at gmail.com
PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683

From imp at bsdimp.com  Wed Jul  4 19:17:43 2018
From: imp at bsdimp.com (Warner Losh)
Date: Wed, 4 Jul 2018 13:17:28 -0600
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <CAN6yY1smGKsWpgusDaL19yLprzMp1K16eWrnFcggGoR54+m+Jg@mail.gmail.com>
References: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>
 <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>
 <CAN6yY1smGKsWpgusDaL19yLprzMp1K16eWrnFcggGoR54+m+Jg@mail.gmail.com>
Message-ID: <CANCZdfrdNVa781jQq_99X1tB1edQ_X5mBDR2tXN2V_qysODxMw@mail.gmail.com>

On Wed, Jul 4, 2018, 2:13 PM Kevin Oberman <rkoberman at gmail.com> wrote:

> On Wed, Jul 4, 2018 at 11:49 AM, Yuri <yuri at rawbw.com> wrote:
>
> > On 07/04/18 07:27, Rodney W. Grimes wrote:
> >
> >> Devd/devmatch is one of the largest changes recently,
> >> it could be something in that code path.
> >>
> >> Do you get the if_run.ko module loaded?  What does kldstat show
> >> immediately after boot and before you try to "fix" anything with
> >> ifconfig.
> >>
> >>
> >> It definitely did create the run0 interface before, and now it doesn't.
> >>>
> >> I wonder if the kernel module is no longer loading...
> >>
> >
> >
> > if_run.ko isn't loaded after boot. But I think it is supposed to be
> loaded
> > by devd too.
> >
> >
> > Yuri
> >
>
> A quick perusal of /etc/devd.conf does not indicate that devd will load the
> driver. It is possible that I missed something, but "run" i only referenced
> as a part of long regex to stop or start pccard-ether.
>

Look at etc/devd/devmatch.conf....

Warner

--
> Kevin Oberman, Part time kid herder and retired Network Engineer
> E-mail: rkoberman at gmail.com
> PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From rkoberman at gmail.com  Wed Jul  4 19:22:31 2018
From: rkoberman at gmail.com (Kevin Oberman)
Date: Wed, 4 Jul 2018 12:22:28 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <14f86d91-1550-ba3e-a71d-36364155593e@rawbw.com>
References: <201807041900.w64J0QeZ044339@pdx.rh.CN85.dnsmgr.net>
 <14f86d91-1550-ba3e-a71d-36364155593e@rawbw.com>
Message-ID: <CAN6yY1s4jgUFv+Vb_DtNhznZa3RZP5GkJcn2W4v5B4TbPWVzcA@mail.gmail.com>

On Wed, Jul 4, 2018 at 12:06 PM, Yuri <yuri at rawbw.com> wrote:

> On 07/04/18 12:00, Rodney W. Grimes wrote:
>
>> Just for fun to see if this can clear up your issue add
>>         if_run_load="YES"
>> to /boot/loader.conf
>>
>
>
> This doesn't help. In the presence of preloaded if_run.ko wpa_supplicant
> still can't initialize wlan0.
>
>
> Yuri


This is a shot in the dark, but I have a possibly similar issue with my
Intel  6205 (iwn) card. It appears that thee is a race involving the timing
of the iwn (wlan0) coming up and the start of the wpa_supplicant.

I see the interface start, and aesociate but immediately go down. dhclient
starts, but fails. If I kill the interface (service netif stop wlan0) and
manually start it (ifconfig wlan0 up), it comes up fine. I can then start
the wpa_supplicant and dhclient to get it working. From this point, it
remains stable.

If I just let it bounce up and down, it usually will eventually come up,
but it can take some time and, on occasion it simply fails to some up
unless I intervene.
wlans_iwn0="wlan0"
ifconfig_wlan0="WPA SYNCDHCP"
--
Kevin Oberman, Part time kid herder and retired Network Engineer
E-mail: rkoberman at gmail.com
PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683

From rkoberman at gmail.com  Wed Jul  4 19:28:23 2018
From: rkoberman at gmail.com (Kevin Oberman)
Date: Wed, 4 Jul 2018 12:28:20 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <CANCZdfrdNVa781jQq_99X1tB1edQ_X5mBDR2tXN2V_qysODxMw@mail.gmail.com>
References: <201807041427.w64ERDHh043253@pdx.rh.CN85.dnsmgr.net>
 <028e8ccd-b76f-bb77-44db-7278d1f273aa@rawbw.com>
 <CAN6yY1smGKsWpgusDaL19yLprzMp1K16eWrnFcggGoR54+m+Jg@mail.gmail.com>
 <CANCZdfrdNVa781jQq_99X1tB1edQ_X5mBDR2tXN2V_qysODxMw@mail.gmail.com>
Message-ID: <CAN6yY1vcJOQq3Hwfz3Vwm=vU=S8jgSNbjec-qHouT_RUF_Qgag@mail.gmail.com>

On Wed, Jul 4, 2018 at 12:17 PM, Warner Losh <imp at bsdimp.com> wrote:

>
>
> On Wed, Jul 4, 2018, 2:13 PM Kevin Oberman <rkoberman at gmail.com> wrote:
>
>> On Wed, Jul 4, 2018 at 11:49 AM, Yuri <yuri at rawbw.com> wrote:
>>
>> > On 07/04/18 07:27, Rodney W. Grimes wrote:
>> >
>> >> Devd/devmatch is one of the largest changes recently,
>> >> it could be something in that code path.
>> >>
>> >> Do you get the if_run.ko module loaded?  What does kldstat show
>> >> immediately after boot and before you try to "fix" anything with
>> >> ifconfig.
>> >>
>> >>
>> >> It definitely did create the run0 interface before, and now it doesn't.
>> >>>
>> >> I wonder if the kernel module is no longer loading...
>> >>
>> >
>> >
>> > if_run.ko isn't loaded after boot. But I think it is supposed to be
>> loaded
>> > by devd too.
>> >
>> >
>> > Yuri
>> >
>>
>> A quick perusal of /etc/devd.conf does not indicate that devd will load
>> the
>> driver. It is possible that I missed something, but "run" i only
>> referenced
>> as a part of long regex to stop or start pccard-ether.
>>
>
> Look at etc/devd/devmatch.conf....
>
> Warner
>

Oops! That's why I said "quick perusal". (On my 11.2-STABLE system, it's in
/etc/devd/usb.conf) I don't have a system HEAD running here ATM.

Thanks!
--
Kevin Oberman, Part time kid herder and retired Network Engineer
E-mail: rkoberman at gmail.com
PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683

From jamie at catflap.org  Wed Jul  4 20:07:09 2018
From: jamie at catflap.org (Jamie Landeg-Jones)
Date: Wed, 04 Jul 2018 21:07:06 +0100
Subject: kvm_swap: ksw_devname too short
Message-ID: <201807042007.w64K76C7057650@donotpassgo.dyslexicfish.net>

kvm_swap.ksw_devname is defined in <kvm.h> as 32 characters. It's easy to
exceed this (e.g. /dev/diskid/DISK-4C441001130129435304p2)

I suppose setting an automatic glabel would be the solution, but how much
hassle would bumping this field cause? I notice that swap with such long
names still actually works...

Cheers

From Cy.Schubert at cschubert.com  Thu Jul  5 03:19:39 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Wed, 04 Jul 2018 20:19:30 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: Message from "O. Hartmann" <ohartmann@walstatt.org> of "Tue,
 03 Jul 2018 17:02:23 +0200."
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
Message-ID: <201807050319.w653JUjY075521@slippy.cwsent.com>

In message <20180703170223.266dbf5b at thor.intern.walstatt.dynvpn.de>, 
"O. Hartma
nn" writes:
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
>
> Am Tue, 3 Jul 2018 10:19:57 -0400
> Michael Butler <imb at protected-networks.net> schrieb:
>
> > It seems recent changes (SVN r335873?) may have broken drm-next-kmod ..
> > 
> > --- i915_drv.o ---
> > In file included from i915_drv.c:30:
> > In file included from
> > /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/inclu
> de/linux/acpi.h:26:
> > In file included from
> > /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/linuxkpi/gplv2/inclu
> de/linux/device.h:4:
> > In file included from
> > /usr/src/sys/compat/linuxkpi/common/include/linux/device.h:35:
> > In file included from
> > /usr/src/sys/compat/linuxkpi/common/include/linux/types.h:37:
> > In file included from /usr/src/sys/sys/systm.h:44:
> > ./machine/atomic.h:450:29: error: invalid operand for instruction
> > ATOMIC_ASM(clear,    long,  "andq %1,%0",  "ir", ~v);
> >                             ^
> > <inline asm>:1:7: note: instantiated into assembly here
> >         andq $9223372036854775807,40672(%r14)
> >              ^~~~~~~~~~~~~~~~~~~~~
> > 1 error generated.
> > *** [i915_drv.o] Error code 1
> > 
> > make[3]: stopped in
> > /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/i915
> > --- i915_gem.o ---
> > In file included from i915_gem.c:28:
> > In file included from
> > /usr/ports/graphics/drm-next-kmod/work/kms-drm-a753215/include/drm/drmP.h:3
> 8:
> > In file included from /usr/src/sys/sys/malloc.h:42:
> > In file included from /usr/src/sys/sys/systm.h:44:
> > ./machine/atomic.h:449:29: error: invalid operand for instruction
> > ATOMIC_ASM(set,      long,  "orq %1,%0",   "ir",  v);
> >                             ^
> > <inline asm>:1:6: note: instantiated into assembly here
> >         orq $-9223372036854775808,40672(%r14)
> >             ^~~~~~~~~~~~~~~~~~~~~~
> > 1 error generated.
> > *** [i915_gem.o] Error code 1
> > 
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>
>
> It breaks also graphics/drm-stable-kmod (see PR 229484,
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229484, same error as you d
> escribed
> above) and also emulators/virtualbox-ose-kmod. As long as CURRENT revision is
>  < r335873,
> those kmod compile well.

The virtualbox-ose-kmod issue is different. It's namespace pollution 
caused by the inclusion of sys/param.h in sys/systm.h when _KERNEL is 
defined. sys/param.h includes sys/priority.h if LOCORE is not defined. 
virtualbox typedefs PVM as a struct whereas sys/priority.h defines it 
as a constant. Virtualbox undefines PVM in some headers, usually after 
including sys/param.h. I haven't looked at it further than this with 
the limited time I have tonight but I suspect one of the #undef PVM 
statements needs to move.

> - -- 
> O. Hartmann
>
> Ich widerspreche der Nutzung oder ??bermittlung meiner Daten f??r
> Werbezwecke oder f??r die Markt- oder Meinungsforschung (?? 28 Abs. 4 BDSG).
> -----BEGIN PGP SIGNATURE-----
>
> iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCWzuQGgAKCRDS528fyFhY
> lKHnAf0fIVHnw1xBVHzogeQQo4v+he17R2ln6l25lNR/pUE1AZOsFzPDamAkqbY+
> f1+Usr+P5o7jn26Bh4ob3UmIj25DAf4tJZpeZS4iGZ374lrCAemYFb53+MJ1fClW
> aBLI6DVOiBiOt/UpLXZf1whl/dtQvo5yd1xywfYOwi9Jh8teHcNW
> =mtMH
> -----END PGP SIGNATURE-----
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>


-- 
Cheers,
Cy Schubert <Cy.Schubert at cschubert.com>
FreeBSD UNIX:  <cy at FreeBSD.org>   Web:  http://www.FreeBSD.org

	The need of the many outweighs the greed of the few.



From linus.sundqvist at loopia.se  Thu Jul  5 06:32:46 2018
From: linus.sundqvist at loopia.se (Linus Sundqvist)
Date: Thu, 5 Jul 2018 08:32:34 +0200
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
Message-ID: <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>

Running these commands makes the boot menu show up, and then takes me to the BSD installer!

Med v?nlig h?lsning/Best Regards
Linus Sundqvist
System Engineer, Loopia AB

On 04/07/18 16:50, Toomas Soome wrote:
> set currdev=cd1:
> include /boot/loader.rc
> 
> This should give menu/boot.
> 
> Rgds,
> Toomas
> 
> Sent from my iPhone
> 
>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>
>> Hi,
>>
>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
>> https://imgur.com/RmYpg7u
>>
>> and here is ls cd1:
>> https://imgur.com/FPsixOw
>>
>> Med v?nlig h?lsning/Best Regards
>> Linus Sundqvist
>> System Engineer, Loopia AB
>>
>>> On 04/07/18 15:08, Toomas Soome wrote:
>>> Can you post lsdev -v output?
>>>
>>> Also, could you try ls command? Like, ls cd0:   
>>>
>>> Rgds,
>>> Toomas
>>>
>>> Sent from my iPhone
>>>
>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>
>>>> Hi,
>>>>
>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>>> https://imgur.com/a/Idljfhm
>>>>
>>>> The bootonly ISOs seems to show the same error message.
>>>>
>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>>>
>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>>>
>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>>>
>>>> https://reviews.freebsd.org/D13784
>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>>>
>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>>>
>>>> R440
>>>> R630
>>>> R430
>>>> FC430
>>>> R330
>>>> R620
>>>> R420
>>>> R610
>>>>
>>>> -- 
>>>> Med v?nlig h?lsning/Best Regards
>>>> Linus Sundqvist
>>>> System Engineer, Loopia AB
>>>>
>>> _______________________________________________
>>> freebsd-current at freebsd.org mailing list
>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180705/ba2f57b5/attachment.sig>

From tsoome at me.com  Thu Jul  5 07:17:47 2018
From: tsoome at me.com (Toomas Soome)
Date: Thu, 05 Jul 2018 10:17:34 +0300
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
 <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
Message-ID: <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>

Could you check, show currdev from OK prompt before setting it.

Somehow the boot device path is shown but we fail to recognize it (as seen by error message). However, the lsdev -v does show the path, so the efipart.c seems to do its work correctly. I feel, there should be some corner case in efi/loader/main.c where we detect the boot device.

Rgds,
Toomas

Sent from my iPhone

> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> 
> Running these commands makes the boot menu show up, and then takes me to the BSD installer!
> 
> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
> 
>> On 04/07/18 16:50, Toomas Soome wrote:
>> set currdev=cd1:
>> include /boot/loader.rc
>> 
>> This should give menu/boot.
>> 
>> Rgds,
>> Toomas
>> 
>> Sent from my iPhone
>> 
>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>> 
>>> Hi,
>>> 
>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
>>> https://imgur.com/RmYpg7u
>>> 
>>> and here is ls cd1:
>>> https://imgur.com/FPsixOw
>>> 
>>> Med v?nlig h?lsning/Best Regards
>>> Linus Sundqvist
>>> System Engineer, Loopia AB
>>> 
>>>> On 04/07/18 15:08, Toomas Soome wrote:
>>>> Can you post lsdev -v output?
>>>> 
>>>> Also, could you try ls command? Like, ls cd0:   
>>>> 
>>>> Rgds,
>>>> Toomas
>>>> 
>>>> Sent from my iPhone
>>>> 
>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>> 
>>>>> Hi,
>>>>> 
>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>>>> https://imgur.com/a/Idljfhm
>>>>> 
>>>>> The bootonly ISOs seems to show the same error message.
>>>>> 
>>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>>>> 
>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>>>> 
>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>>>> 
>>>>> https://reviews.freebsd.org/D13784
>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>>>> 
>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>>>> 
>>>>> R440
>>>>> R630
>>>>> R430
>>>>> FC430
>>>>> R330
>>>>> R620
>>>>> R420
>>>>> R610
>>>>> 
>>>>> -- 
>>>>> Med v?nlig h?lsning/Best Regards
>>>>> Linus Sundqvist
>>>>> System Engineer, Loopia AB
>>>>> 
>>>> _______________________________________________
>>>> freebsd-current at freebsd.org mailing list
>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>> 
>>> 
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>> 
> 

From linus.sundqvist at loopia.se  Thu Jul  5 07:28:26 2018
From: linus.sundqvist at loopia.se (Linus Sundqvist)
Date: Thu, 5 Jul 2018 09:28:23 +0200
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
 <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
 <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>
Message-ID: <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>

Here's the output, variable 'currdev' not found:
https://imgur.com/LlBygfr

And to answer Rodneys question from before, this is the emulated CD drive from a Dell iDRAC (remote console thingy).

Med v?nlig h?lsning/Best Regards
Linus Sundqvist
System Engineer, Loopia AB

On 05/07/18 09:17, Toomas Soome wrote:
> Could you check, show currdev from OK prompt before setting it.
> 
> Somehow the boot device path is shown but we fail to recognize it (as seen by error message). However, the lsdev -v does show the path, so the efipart.c seems to do its work correctly. I feel, there should be some corner case in efi/loader/main.c where we detect the boot device.
> 
> Rgds,
> Toomas
> 
> Sent from my iPhone
> 
>> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>
>> Running these commands makes the boot menu show up, and then takes me to the BSD installer!
>>
>> Med v?nlig h?lsning/Best Regards
>> Linus Sundqvist
>> System Engineer, Loopia AB
>>
>>> On 04/07/18 16:50, Toomas Soome wrote:
>>> set currdev=cd1:
>>> include /boot/loader.rc
>>>
>>> This should give menu/boot.
>>>
>>> Rgds,
>>> Toomas
>>>
>>> Sent from my iPhone
>>>
>>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>
>>>> Hi,
>>>>
>>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
>>>> https://imgur.com/RmYpg7u
>>>>
>>>> and here is ls cd1:
>>>> https://imgur.com/FPsixOw
>>>>
>>>> Med v?nlig h?lsning/Best Regards
>>>> Linus Sundqvist
>>>> System Engineer, Loopia AB
>>>>
>>>>> On 04/07/18 15:08, Toomas Soome wrote:
>>>>> Can you post lsdev -v output?
>>>>>
>>>>> Also, could you try ls command? Like, ls cd0:   
>>>>>
>>>>> Rgds,
>>>>> Toomas
>>>>>
>>>>> Sent from my iPhone
>>>>>
>>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>>>
>>>>>> Hi,
>>>>>>
>>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>>>>> https://imgur.com/a/Idljfhm
>>>>>>
>>>>>> The bootonly ISOs seems to show the same error message.
>>>>>>
>>>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>>>>>
>>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>>>>>
>>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>>>>>
>>>>>> https://reviews.freebsd.org/D13784
>>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>>>>>
>>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>>>>>
>>>>>> R440
>>>>>> R630
>>>>>> R430
>>>>>> FC430
>>>>>> R330
>>>>>> R620
>>>>>> R420
>>>>>> R610
>>>>>>
>>>>>> -- 
>>>>>> Med v?nlig h?lsning/Best Regards
>>>>>> Linus Sundqvist
>>>>>> System Engineer, Loopia AB
>>>>>>
>>>>> _______________________________________________
>>>>> freebsd-current at freebsd.org mailing list
>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>>>
>>>>
>>> _______________________________________________
>>> freebsd-current at freebsd.org mailing list
>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180705/ad712965/attachment.sig>

From tsoome at me.com  Thu Jul  5 08:23:12 2018
From: tsoome at me.com (Toomas Soome)
Date: Thu, 05 Jul 2018 11:23:06 +0300
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
 <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
 <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>
 <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>
Message-ID: <69DD5AC1-5FF8-4A6E-993B-F65070D484BF@me.com>



> On 5 Jul 2018, at 10:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> 
> Here's the output, variable 'currdev' not found:
> https://imgur.com/LlBygfr <https://imgur.com/LlBygfr>


Yes indeed, as you got the error, so the variable was not set at all. My suggestion would be to walk over the code in main.c, and to try to get more debug printouts from that dell system? Im myself mostly offline till next week.

rgds,
toomas

> 
> And to answer Rodneys question from before, this is the emulated CD drive from a Dell iDRAC (remote console thingy).
> 
> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
> 
> On 05/07/18 09:17, Toomas Soome wrote:
>> Could you check, show currdev from OK prompt before setting it.
>> 
>> Somehow the boot device path is shown but we fail to recognize it (as seen by error message). However, the lsdev -v does show the path, so the efipart.c seems to do its work correctly. I feel, there should be some corner case in efi/loader/main.c where we detect the boot device.
>> 
>> Rgds,
>> Toomas
>> 
>> Sent from my iPhone
>> 
>>> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>> 
>>> Running these commands makes the boot menu show up, and then takes me to the BSD installer!
>>> 
>>> Med v?nlig h?lsning/Best Regards
>>> Linus Sundqvist
>>> System Engineer, Loopia AB
>>> 
>>>> On 04/07/18 16:50, Toomas Soome wrote:
>>>> set currdev=cd1:
>>>> include /boot/loader.rc
>>>> 
>>>> This should give menu/boot.
>>>> 
>>>> Rgds,
>>>> Toomas
>>>> 
>>>> Sent from my iPhone
>>>> 
>>>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>> 
>>>>> Hi,
>>>>> 
>>>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
>>>>> https://imgur.com/RmYpg7u
>>>>> 
>>>>> and here is ls cd1:
>>>>> https://imgur.com/FPsixOw
>>>>> 
>>>>> Med v?nlig h?lsning/Best Regards
>>>>> Linus Sundqvist
>>>>> System Engineer, Loopia AB
>>>>> 
>>>>>> On 04/07/18 15:08, Toomas Soome wrote:
>>>>>> Can you post lsdev -v output?
>>>>>> 
>>>>>> Also, could you try ls command? Like, ls cd0:   
>>>>>> 
>>>>>> Rgds,
>>>>>> Toomas
>>>>>> 
>>>>>> Sent from my iPhone
>>>>>> 
>>>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>>>> 
>>>>>>> Hi,
>>>>>>> 
>>>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>>>>>> https://imgur.com/a/Idljfhm
>>>>>>> 
>>>>>>> The bootonly ISOs seems to show the same error message.
>>>>>>> 
>>>>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>>>>>> 
>>>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>>>>>> 
>>>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>>>>>> 
>>>>>>> https://reviews.freebsd.org/D13784
>>>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>>>>>> 
>>>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>>>>>> 
>>>>>>> R440
>>>>>>> R630
>>>>>>> R430
>>>>>>> FC430
>>>>>>> R330
>>>>>>> R620
>>>>>>> R420
>>>>>>> R610
>>>>>>> 
>>>>>>> -- 
>>>>>>> Med v?nlig h?lsning/Best Regards
>>>>>>> Linus Sundqvist
>>>>>>> System Engineer, Loopia AB
>>>>>>> 
>>>>>> _______________________________________________
>>>>>> freebsd-current at freebsd.org mailing list
>>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>>>> 
>>>>> 
>>>> _______________________________________________
>>>> freebsd-current at freebsd.org mailing list
>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>> 
>>> 
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>> 
> 


From tech-lists at zyxst.net  Thu Jul  5 13:28:02 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Thu, 5 Jul 2018 14:27:53 +0100
Subject: em0 link fail
In-Reply-To: <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
 <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
Message-ID: <64e462dd-16fc-b57f-7bf2-02068d0e24c8@zyxst.net>

On 03/07/2018 19:47, Michael Butler wrote:
> That would've been ..
> 
> Jun  1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
> 1 08:25:58 EDT 2018
> 
> I'm going to build one with SVN r334862 reverted to see if that works,

Hi,

Is it working now? Am asking because a system I'd like to take from 
11-stable to 12 uses the em driver.

thanks,

-- 
J.

From imb at protected-networks.net  Thu Jul  5 13:54:57 2018
From: imb at protected-networks.net (Michael Butler)
Date: Thu, 5 Jul 2018 09:54:45 -0400
Subject: em0 link fail
In-Reply-To: <64e462dd-16fc-b57f-7bf2-02068d0e24c8@zyxst.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
 <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
 <64e462dd-16fc-b57f-7bf2-02068d0e24c8@zyxst.net>
Message-ID: <7a4607ce-e212-5cba-bc04-1d0abf1a7824@protected-networks.net>

On 07/05/18 09:27, tech-lists wrote:
> On 03/07/2018 19:47, Michael Butler wrote:
>> That would've been ..
>>
>> Jun? 1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
>> 1 08:25:58 EDT 2018
>>
>> I'm going to build one with SVN r334862 reverted to see if that works,
> 
> Hi,
> 
> Is it working now? Am asking because a system I'd like to take from
> 11-stable to 12 uses the em driver.

No :-( I haven't had the chance yet to revisit it,

	imb


From linus.sundqvist at loopia.se  Thu Jul  5 14:12:31 2018
From: linus.sundqvist at loopia.se (Linus Sundqvist)
Date: Thu, 5 Jul 2018 16:12:27 +0200
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <69DD5AC1-5FF8-4A6E-993B-F65070D484BF@me.com>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
 <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
 <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>
 <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>
 <69DD5AC1-5FF8-4A6E-993B-F65070D484BF@me.com>
Message-ID: <d8ee4dd5-5125-e6a3-3198-7e40ec75856a@loopia.se>

I have no idea how to do that or where to begin, but if anyone would like to assist with those steps I'll gladly run commands or a test ISO on one of our Dell servers.

Med v?nlig h?lsning/Best Regards
Linus Sundqvist
System Engineer, Loopia AB

On 05/07/18 10:23, Toomas Soome wrote:
> 
> 
>> On 5 Jul 2018, at 10:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>
>> Here's the output, variable 'currdev' not found:
>> https://imgur.com/LlBygfr <https://imgur.com/LlBygfr>
> 
> 
> Yes indeed, as you got the error, so the variable was not set at all. My suggestion would be to walk over the code in main.c, and to try to get more debug printouts from that dell system? Im myself mostly offline till next week.
> 
> rgds,
> toomas
> 
>>
>> And to answer Rodneys question from before, this is the emulated CD drive from a Dell iDRAC (remote console thingy).
>>
>> Med v?nlig h?lsning/Best Regards
>> Linus Sundqvist
>> System Engineer, Loopia AB
>>
>> On 05/07/18 09:17, Toomas Soome wrote:
>>> Could you check, show currdev from OK prompt before setting it.
>>>
>>> Somehow the boot device path is shown but we fail to recognize it (as seen by error message). However, the lsdev -v does show the path, so the efipart.c seems to do its work correctly. I feel, there should be some corner case in efi/loader/main.c where we detect the boot device.
>>>
>>> Rgds,
>>> Toomas
>>>
>>> Sent from my iPhone
>>>
>>>> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>
>>>> Running these commands makes the boot menu show up, and then takes me to the BSD installer!
>>>>
>>>> Med v?nlig h?lsning/Best Regards
>>>> Linus Sundqvist
>>>> System Engineer, Loopia AB
>>>>
>>>>> On 04/07/18 16:50, Toomas Soome wrote:
>>>>> set currdev=cd1:
>>>>> include /boot/loader.rc
>>>>>
>>>>> This should give menu/boot.
>>>>>
>>>>> Rgds,
>>>>> Toomas
>>>>>
>>>>> Sent from my iPhone
>>>>>
>>>>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>>>
>>>>>> Hi,
>>>>>>
>>>>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
>>>>>> https://imgur.com/RmYpg7u
>>>>>>
>>>>>> and here is ls cd1:
>>>>>> https://imgur.com/FPsixOw
>>>>>>
>>>>>> Med v?nlig h?lsning/Best Regards
>>>>>> Linus Sundqvist
>>>>>> System Engineer, Loopia AB
>>>>>>
>>>>>>> On 04/07/18 15:08, Toomas Soome wrote:
>>>>>>> Can you post lsdev -v output?
>>>>>>>
>>>>>>> Also, could you try ls command? Like, ls cd0:   
>>>>>>>
>>>>>>> Rgds,
>>>>>>> Toomas
>>>>>>>
>>>>>>> Sent from my iPhone
>>>>>>>
>>>>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
>>>>>>>>
>>>>>>>> Hi,
>>>>>>>>
>>>>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
>>>>>>>> https://imgur.com/a/Idljfhm
>>>>>>>>
>>>>>>>> The bootonly ISOs seems to show the same error message.
>>>>>>>>
>>>>>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
>>>>>>>>
>>>>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
>>>>>>>>
>>>>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
>>>>>>>>
>>>>>>>> https://reviews.freebsd.org/D13784
>>>>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
>>>>>>>>
>>>>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
>>>>>>>>
>>>>>>>> R440
>>>>>>>> R630
>>>>>>>> R430
>>>>>>>> FC430
>>>>>>>> R330
>>>>>>>> R620
>>>>>>>> R420
>>>>>>>> R610
>>>>>>>>
>>>>>>>> -- 
>>>>>>>> Med v?nlig h?lsning/Best Regards
>>>>>>>> Linus Sundqvist
>>>>>>>> System Engineer, Loopia AB
>>>>>>>>
>>>>>>> _______________________________________________
>>>>>>> freebsd-current at freebsd.org mailing list
>>>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>>>>>
>>>>>>
>>>>> _______________________________________________
>>>>> freebsd-current at freebsd.org mailing list
>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>>>
>>>>
>>> _______________________________________________
>>> freebsd-current at freebsd.org mailing list
>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>>>
>>
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180705/a25a9b1d/attachment.sig>

From bzeeb-lists at lists.zabbadoz.net  Thu Jul  5 14:30:58 2018
From: bzeeb-lists at lists.zabbadoz.net (Bjoern A. Zeeb)
Date: Thu, 05 Jul 2018 14:30:51 +0000
Subject: EFI booting from external USB pen drive
Message-ID: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>

Hi,

while I can boot memstick images just fine (which are created using 
makefs/mkimg), doing the same thing using gpart/newfs_msdos -F 12/.. I 
am not able to get anything that boots.

On a Thinkpad (secure boot is off) from the ?boot device chooser from 
?BIOS?? I get a quick blank screen and am back at the chooser.  
I?ve tried the gpart ?thinkpad hack? as well as trying an MBR (why 
that should work I don?t know but the memstick one does) and GPT 
options of various kinds.


Anyone successfully done this lately?


/bz

From manu at bidouilliste.com  Thu Jul  5 14:49:35 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Thu, 05 Jul 2018 16:49:25 +0200
Subject: EFI booting from external USB pen drive
In-Reply-To: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
References: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
Message-ID: <38d764d4ff3cf05e7619c79766716acd@megadrive.org>

On 2018-07-05 16:30, Bjoern A. Zeeb wrote:
> Hi,
> 
> while I can boot memstick images just fine (which are created using
> makefs/mkimg), doing the same thing using gpart/newfs_msdos -F 12/.. I
> am not able to get anything that boots.

  What is the size for the fat12 partition ? Everything over ~30MB will 
fail.
  Go to fat16/fat32 with a size of 150MB just to be sure.

> On a Thinkpad (secure boot is off) from the ?boot device chooser from
> ?BIOS?? I get a quick blank screen and am back at the chooser.  I?ve
> tried the gpart ?thinkpad hack? as well as trying an MBR (why that
> should work I don?t know but the memstick one does) and GPT options of
> various kinds.
> 
> 
> Anyone successfully done this lately?
> 
> 
> /bz
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to 
> "freebsd-current-unsubscribe at freebsd.org"

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From mentalbarcode at fastest.cc  Thu Jul  5 14:51:44 2018
From: mentalbarcode at fastest.cc (David Mimms)
Date: Thu, 05 Jul 2018 10:50:56 -0400
Subject: EFI booting from external USB pen drive
In-Reply-To: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
References: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
Message-ID: <2965305.K7DBhPY28l@fenix>

Bjoern,

I had this problem earlier this week while using FreeBSD-12.0-CURRENT-amd64-20180628-r335760-memstick.img on my ThinkPad P50.

I had used `dd` to place the img file on a partition (e.g. /dev/sdb1) of the USB pen drive and it wouldn't boot properly.

After I used `dd` to place the img on the entire device (e.g. /dev/sdb), I noticed that it had its own partition scheme with three partitions, and that booted just fine.

DM


On Thursday, July 5, 2018 10:30:51 AM -04 Bjoern A. Zeeb wrote:
> Hi,
> 
> while I can boot memstick images just fine (which are created using 
> makefs/mkimg), doing the same thing using gpart/newfs_msdos -F 12/.. I 
> am not able to get anything that boots.
> 
> On a Thinkpad (secure boot is off) from the ?boot device chooser from 
> ?BIOS?? I get a quick blank screen and am back at the chooser.  
> I?ve tried the gpart ?thinkpad hack? as well as trying an MBR (why 
> that should work I don?t know but the memstick one does) and GPT 
> options of various kinds.
> 
> 
> Anyone successfully done this lately?
> 
> 
> /bz
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 





From jhb at FreeBSD.org  Thu Jul  5 17:10:41 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Thu, 5 Jul 2018 10:10:45 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
Message-ID: <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>

On 7/3/18 5:10 PM, Pete Wright wrote:
> 
> 
> On 07/03/2018 15:56, John Baldwin wrote:
>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>
>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>> That seems like kgdb is looking at the wrong CPU.  Can you use
>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>> and get their backtraces?  You could also just do 'thread apply
>>>> all bt' and put that file at a URL if that is easiest.
>>>>
>>>
>>> sure thing John - here's a gist of "thread apply all bt"
>>>
>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>> That doesn't look right at all.  Are you sure the kernel matches the
>> vmcore?  Also, which kgdb version are you using?
>>
> 
> yea i agree that doesn't look right at all.? here is my setup:
> 
> $ which kgdb
> /usr/bin/kgdb
> $ kgdb
> GNU gdb 6.1.1 [FreeBSD]
> $ ls -lh /var/crash/vmcore.1
> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54 
> /usr/lib/debug/boot/kernel/kernel.debug
> 
> and i invoke kgdb like so:
> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
> 
> here's a gist of my full gdb session:
> http://termbin.com/krsn
> 
> dunno - maybe i have a bad core dump?? regardless, more than happy to 
> help so let me know if i should try anything else or patches etc..

Can you try installing gdb from ports and using /usr/local/bin/kgdb?

-- 
John Baldwin

From imp at bsdimp.com  Thu Jul  5 17:19:40 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 11:19:27 -0600
Subject: EFI booting from external USB pen drive
In-Reply-To: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
References: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
Message-ID: <CANCZdfqpEcvv-dYK-uspaJiXapK-Uko8UFn0gksiti0CRhMGwQ@mail.gmail.com>

FAT12 isn't good for UEFI. Use FAT16 or FAT32.

Warner

On Thu, Jul 5, 2018, 9:32 AM Bjoern A. Zeeb <bzeeb-lists at lists.zabbadoz.net>
wrote:

> Hi,
>
> while I can boot memstick images just fine (which are created using
> makefs/mkimg), doing the same thing using gpart/newfs_msdos -F 12/.. I
> am not able to get anything that boots.
>
> On a Thinkpad (secure boot is off) from the ?boot device chooser from
> ?BIOS?? I get a quick blank screen and am back at the chooser.
> I?ve tried the gpart ?thinkpad hack? as well as trying an MBR (why
> that should work I don?t know but the memstick one does) and GPT
> options of various kinds.
>
>
> Anyone successfully done this lately?
>
>
> /bz
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Thu Jul  5 17:20:32 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Thu, 5 Jul 2018 10:20:29 -0700 (PDT)
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>
Message-ID: <201807051720.w65HKTe4048658@pdx.rh.CN85.dnsmgr.net>

> Here's the output, variable 'currdev' not found:
> https://imgur.com/LlBygfr

Hum, currdev didnt get set, but I see the loaddevice looks to be
cd1:  Toomas is right, we have an edge case here that is failing
to set currdev properly.

> 
> And to answer Rodneys question from before, this is the emulated CD drive from a Dell iDRAC (remote console thingy).

Thanks, that helps.  I'll try to duplicate this failure mode since I have Dells,
IIRC this virtual emulated CD drive shows up as a USB device.

> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
> 
> On 05/07/18 09:17, Toomas Soome wrote:
> > Could you check, show currdev from OK prompt before setting it.
> > 
> > Somehow the boot device path is shown but we fail to recognize it (as seen by error message). However, the lsdev -v does show the path, so the efipart.c seems to do its work correctly. I feel, there should be some corner case in efi/loader/main.c where we detect the boot device.
> > 
> > Rgds,
> > Toomas
> > 
> > Sent from my iPhone
> > 
> >> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> >>
> >> Running these commands makes the boot menu show up, and then takes me to the BSD installer!

Good, so there is a work around....


> >> Med v?nlig h?lsning/Best Regards
> >> Linus Sundqvist
> >> System Engineer, Loopia AB
> >>
> >>> On 04/07/18 16:50, Toomas Soome wrote:
> >>> set currdev=cd1:
> >>> include /boot/loader.rc
> >>>
> >>> This should give menu/boot.
> >>>
> >>> Rgds,
> >>> Toomas
> >>>
> >>> Sent from my iPhone
> >>>
> >>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> >>>>
> >>>> Hi,
> >>>>
> >>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
> >>>> https://imgur.com/RmYpg7u
> >>>>
> >>>> and here is ls cd1:
> >>>> https://imgur.com/FPsixOw
> >>>>
> >>>> Med v?nlig h?lsning/Best Regards
> >>>> Linus Sundqvist
> >>>> System Engineer, Loopia AB
> >>>>
> >>>>> On 04/07/18 15:08, Toomas Soome wrote:
> >>>>> Can you post lsdev -v output?
> >>>>>
> >>>>> Also, could you try ls command? Like, ls cd0:   
> >>>>>
> >>>>> Rgds,
> >>>>> Toomas
> >>>>>
> >>>>> Sent from my iPhone
> >>>>>
> >>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <linus.sundqvist at loopia.se> wrote:
> >>>>>>
> >>>>>> Hi,
> >>>>>>
> >>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430 by getting this error:
> >>>>>> https://imgur.com/a/Idljfhm
> >>>>>>
> >>>>>> The bootonly ISOs seems to show the same error message.
> >>>>>>
> >>>>>> Changing the server to boot via BIOS loads the setup correctly, however, I want to use UEFI on all our servers, which I have done before.
> >>>>>>
> >>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and BIOS.
> >>>>>>
> >>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send an e-mail this way and linking to these commits as a reference:
> >>>>>>
> >>>>>> https://reviews.freebsd.org/D13784
> >>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
> >>>>>>
> >>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the following Dell PowerEdge models without success:
> >>>>>>
> >>>>>> R440
> >>>>>> R630
> >>>>>> R430
> >>>>>> FC430
> >>>>>> R330
> >>>>>> R620
> >>>>>> R420
> >>>>>> R610
> >>>>>>
> >>>>>> -- 
> >>>>>> Med v?nlig h?lsning/Best Regards
> >>>>>> Linus Sundqvist
> >>>>>> System Engineer, Loopia AB
> >>>>>>
> >>>>> _______________________________________________
> >>>>> freebsd-current at freebsd.org mailing list
> >>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >>>>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> >>>>>
> >>>>
> >>> _______________________________________________
> >>> freebsd-current at freebsd.org mailing list
> >>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> >>>
> >>
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> > 
> 
-- End of PGP section, PGP failed!

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From pete at nomadlogic.org  Thu Jul  5 17:48:23 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Thu, 5 Jul 2018 10:48:16 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
Message-ID: <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>



On 07/05/2018 10:10, John Baldwin wrote:
> On 7/3/18 5:10 PM, Pete Wright wrote:
>>
>> On 07/03/2018 15:56, John Baldwin wrote:
>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>> That seems like kgdb is looking at the wrong CPU.  Can you use
>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>>> and get their backtraces?  You could also just do 'thread apply
>>>>> all bt' and put that file at a URL if that is easiest.
>>>>>
>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>
>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>> That doesn't look right at all.  Are you sure the kernel matches the
>>> vmcore?  Also, which kgdb version are you using?
>>>
>> yea i agree that doesn't look right at all.? here is my setup:
>>
>> $ which kgdb
>> /usr/bin/kgdb
>> $ kgdb
>> GNU gdb 6.1.1 [FreeBSD]
>> $ ls -lh /var/crash/vmcore.1
>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>> /usr/lib/debug/boot/kernel/kernel.debug
>>
>> and i invoke kgdb like so:
>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
>>
>> here's a gist of my full gdb session:
>> http://termbin.com/krsn
>>
>> dunno - maybe i have a bad core dump?? regardless, more than happy to
>> help so let me know if i should try anything else or patches etc..
> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
>

that seems to have done the trick, at least the output looks more 
encouraging.

 ?--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
KDB: enter: panic

__curthread () at ./machine/pcpu.h:231
231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)


here's my full kgdb session:
http://termbin.com/qa4f

i don't see any threads not in "sched_switch" though :(

-pete


-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From bzeeb-lists at lists.zabbadoz.net  Thu Jul  5 17:55:30 2018
From: bzeeb-lists at lists.zabbadoz.net (Bjoern A. Zeeb)
Date: Thu, 05 Jul 2018 17:55:22 +0000
Subject: EFI booting from external USB pen drive
In-Reply-To: <CANCZdfqpEcvv-dYK-uspaJiXapK-Uko8UFn0gksiti0CRhMGwQ@mail.gmail.com>
References: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
 <CANCZdfqpEcvv-dYK-uspaJiXapK-Uko8UFn0gksiti0CRhMGwQ@mail.gmail.com>
Message-ID: <EDAAA093-EBBF-422F-A551-043190047421@lists.zabbadoz.net>

On 5 Jul 2018, at 17:19, Warner Losh wrote:

> FAT12 isn't good for UEFI. Use FAT16 or FAT32.

We use it for the default image we built and the wiki suggests it as 
well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI

I wonder where this ?default? came from?

/bz



From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Thu Jul  5 18:18:08 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Thu, 5 Jul 2018 11:18:03 -0700 (PDT)
Subject: EFI booting from external USB pen drive
In-Reply-To: <EDAAA093-EBBF-422F-A551-043190047421@lists.zabbadoz.net>
Message-ID: <201807051818.w65II3mw048904@pdx.rh.CN85.dnsmgr.net>

[ Charset UTF-8 unsupported, converting... ]
> On 5 Jul 2018, at 17:19, Warner Losh wrote:
> 
> > FAT12 isn't good for UEFI. Use FAT16 or FAT32.
> 
> We use it for the default image we built and the wiki suggests it as 
> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI

IIRC FreeBSD recently cnahged to FAT16 or 32 on these
as the size got pushed up to be larger than what FAT12
can access.

> I wonder where this ?default? came from?
> 
> /bz

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From imb at protected-networks.net  Thu Jul  5 18:38:15 2018
From: imb at protected-networks.net (Michael Butler)
Date: Thu, 5 Jul 2018 14:38:10 -0400
Subject: SVN r336011 breaks build
Message-ID: <29f7ca37-b1f8-e6d8-470d-8ed574b8acc4@protected-networks.net>

As below:

Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/config.c
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/lang.c
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/kernconf.c
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/config.o
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/main.o
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/lang.o
Building /usr/obj/usr/src/amd64.amd64/usr.sbin/config/mkmakefile.o
/usr/src/usr.sbin/config/mkmakefile.c:289:28: error: too many arguments
to function call, expected single argument 'cookie', have 2 arguments
                cnvlist_free_string(nvl, cookie);
                ~~~~~~~~~~~~~~~~~~~      ^~~~~~
/usr/include/sys/cnv.h:106:1: note: 'cnvlist_free_string' declared here
void    cnvlist_free_string(void *cookie);
^
1 error generated.
*** Error code 1

Stop.
make: stopped in /usr/src/usr.sbin/config

	imb

From imp at bsdimp.com  Thu Jul  5 18:39:33 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 12:39:20 -0600
Subject: EFI booting from external USB pen drive
In-Reply-To: <EDAAA093-EBBF-422F-A551-043190047421@lists.zabbadoz.net>
References: <F2FA85B0-75AB-4F6A-BF79-93D74F00102C@lists.zabbadoz.net>
 <CANCZdfqpEcvv-dYK-uspaJiXapK-Uko8UFn0gksiti0CRhMGwQ@mail.gmail.com>
 <EDAAA093-EBBF-422F-A551-043190047421@lists.zabbadoz.net>
Message-ID: <CANCZdfqhVPETjzjMokbi6B9RS8nwGu0vagVBXuob==tEhHNA8A@mail.gmail.com>

On Thu, Jul 5, 2018, 12:55 PM Bjoern A. Zeeb <bzeeb-lists at lists.zabbadoz.net>
wrote:

> On 5 Jul 2018, at 17:19, Warner Losh wrote:
>
> > FAT12 isn't good for UEFI. Use FAT16 or FAT32.
>
> We use it for the default image we built and the wiki suggests it as
> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
>
> I wonder where this ?default? came from?
>

The original UEFI port... they didn't check the standard's recommendations.
It worked then, but experience has shown FAT12 doesn't work everywhere.

Warner

>

From imp at bsdimp.com  Thu Jul  5 18:42:47 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 12:42:23 -0600
Subject: Unable to UEFI boot 11.2 ISO (latest 12.0 as well)
In-Reply-To: <d8ee4dd5-5125-e6a3-3198-7e40ec75856a@loopia.se>
References: <86482bdb-60bd-b573-1a98-e14928f4537e@loopia.se>
 <CBB5DAB8-D05C-4B17-8DD5-0D2EDFD8D41B@me.com>
 <b507e7cf-4c16-aa44-4452-1351bcd2e524@loopia.se>
 <1E09B50A-8E4F-4E1E-BBE2-61B1570376D3@me.com>
 <d51cbc72-977f-9083-90d9-fd1718e8a2bd@loopia.se>
 <3FB4F603-03A7-4D54-87EA-633C08D8C5E7@me.com>
 <aa47a1d4-64bb-5c57-8be7-203533eb6d16@loopia.se>
 <69DD5AC1-5FF8-4A6E-993B-F65070D484BF@me.com>
 <d8ee4dd5-5125-e6a3-3198-7e40ec75856a@loopia.se>
Message-ID: <CANCZdfqyKfCkTCFURKP=bmGA6ERfhoRsQQ2YZONxwQPmDzNM-Q@mail.gmail.com>

I think I know what is going on... I may have some changes that fixes this.

Warner

On Thu, Jul 5, 2018, 9:12 AM Linus Sundqvist <linus.sundqvist at loopia.se>
wrote:

> I have no idea how to do that or where to begin, but if anyone would like
> to assist with those steps I'll gladly run commands or a test ISO on one of
> our Dell servers.
>
> Med v?nlig h?lsning/Best Regards
> Linus Sundqvist
> System Engineer, Loopia AB
>
> On 05/07/18 10:23, Toomas Soome wrote:
> >
> >
> >> On 5 Jul 2018, at 10:28, Linus Sundqvist <linus.sundqvist at loopia.se>
> wrote:
> >>
> >> Here's the output, variable 'currdev' not found:
> >> https://imgur.com/LlBygfr <https://imgur.com/LlBygfr>
> >
> >
> > Yes indeed, as you got the error, so the variable was not set at all. My
> suggestion would be to walk over the code in main.c, and to try to get more
> debug printouts from that dell system? Im myself mostly offline till next
> week.
> >
> > rgds,
> > toomas
> >
> >>
> >> And to answer Rodneys question from before, this is the emulated CD
> drive from a Dell iDRAC (remote console thingy).
> >>
> >> Med v?nlig h?lsning/Best Regards
> >> Linus Sundqvist
> >> System Engineer, Loopia AB
> >>
> >> On 05/07/18 09:17, Toomas Soome wrote:
> >>> Could you check, show currdev from OK prompt before setting it.
> >>>
> >>> Somehow the boot device path is shown but we fail to recognize it (as
> seen by error message). However, the lsdev -v does show the path, so the
> efipart.c seems to do its work correctly. I feel, there should be some
> corner case in efi/loader/main.c where we detect the boot device.
> >>>
> >>> Rgds,
> >>> Toomas
> >>>
> >>> Sent from my iPhone
> >>>
> >>>> On 5 Jul 2018, at 09:32, Linus Sundqvist <linus.sundqvist at loopia.se>
> wrote:
> >>>>
> >>>> Running these commands makes the boot menu show up, and then takes me
> to the BSD installer!
> >>>>
> >>>> Med v?nlig h?lsning/Best Regards
> >>>> Linus Sundqvist
> >>>> System Engineer, Loopia AB
> >>>>
> >>>>> On 04/07/18 16:50, Toomas Soome wrote:
> >>>>> set currdev=cd1:
> >>>>> include /boot/loader.rc
> >>>>>
> >>>>> This should give menu/boot.
> >>>>>
> >>>>> Rgds,
> >>>>> Toomas
> >>>>>
> >>>>> Sent from my iPhone
> >>>>>
> >>>>>> On 4 Jul 2018, at 16:25, Linus Sundqvist <linus.sundqvist at loopia.se>
> wrote:
> >>>>>>
> >>>>>> Hi,
> >>>>>>
> >>>>>> Sure, while using the 12.0 ISO here is lsdev -v and ls cd0:
> >>>>>> https://imgur.com/RmYpg7u
> >>>>>>
> >>>>>> and here is ls cd1:
> >>>>>> https://imgur.com/FPsixOw
> >>>>>>
> >>>>>> Med v?nlig h?lsning/Best Regards
> >>>>>> Linus Sundqvist
> >>>>>> System Engineer, Loopia AB
> >>>>>>
> >>>>>>> On 04/07/18 15:08, Toomas Soome wrote:
> >>>>>>> Can you post lsdev -v output?
> >>>>>>>
> >>>>>>> Also, could you try ls command? Like, ls cd0:
> >>>>>>>
> >>>>>>> Rgds,
> >>>>>>> Toomas
> >>>>>>>
> >>>>>>> Sent from my iPhone
> >>>>>>>
> >>>>>>>> On 4 Jul 2018, at 12:28, Linus Sundqvist <
> linus.sundqvist at loopia.se> wrote:
> >>>>>>>>
> >>>>>>>> Hi,
> >>>>>>>>
> >>>>>>>> I'm unable to boot up the amd64 11.2 disk1 ISO as well as the
> latest amd64 12.0 disk1 ISO (20180628) using UEFI on a Dell PowerEdge R430
> by getting this error:
> >>>>>>>> https://imgur.com/a/Idljfhm
> >>>>>>>>
> >>>>>>>> The bootonly ISOs seems to show the same error message.
> >>>>>>>>
> >>>>>>>> Changing the server to boot via BIOS loads the setup correctly,
> however, I want to use UEFI on all our servers, which I have done before.
> >>>>>>>>
> >>>>>>>> The 11.1 ISO boots without any trouble at all using both UEFI and
> BIOS.
> >>>>>>>>
> >>>>>>>> I was helped by koobs in #freebsd @ Freenode who asked me to send
> an e-mail this way and linking to these commits as a reference:
> >>>>>>>>
> >>>>>>>> https://reviews.freebsd.org/D13784
> >>>>>>>> https://svnweb.freebsd.org/base?view=revision&revision=332416
> >>>>>>>>
> >>>>>>>> So far I've tried to UEFI boot the 11.2 ISO and 12.0 ISO with the
> following Dell PowerEdge models without success:
> >>>>>>>>
> >>>>>>>> R440
> >>>>>>>> R630
> >>>>>>>> R430
> >>>>>>>> FC430
> >>>>>>>> R330
> >>>>>>>> R620
> >>>>>>>> R420
> >>>>>>>> R610
> >>>>>>>>
> >>>>>>>> --
> >>>>>>>> Med v?nlig h?lsning/Best Regards
> >>>>>>>> Linus Sundqvist
> >>>>>>>> System Engineer, Loopia AB
> >>>>>>>>
> >>>>>>> _______________________________________________
> >>>>>>> freebsd-current at freebsd.org mailing list
> >>>>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >>>>>>> To unsubscribe, send any mail to "
> freebsd-current-unsubscribe at freebsd.org"
> >>>>>>>
> >>>>>>
> >>>>> _______________________________________________
> >>>>> freebsd-current at freebsd.org mailing list
> >>>>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >>>>> To unsubscribe, send any mail to "
> freebsd-current-unsubscribe at freebsd.org"
> >>>>>
> >>>>
> >>> _______________________________________________
> >>> freebsd-current at freebsd.org mailing list
> >>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >>> To unsubscribe, send any mail to "
> freebsd-current-unsubscribe at freebsd.org"
> >>>
> >>
> >
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "
> freebsd-current-unsubscribe at freebsd.org"
> >
>
>

From hps at selasky.org  Thu Jul  5 18:59:27 2018
From: hps at selasky.org (Hans Petter Selasky)
Date: Thu, 5 Jul 2018 20:59:04 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
Message-ID: <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>

On 07/05/18 19:48, Pete Wright wrote:
> 
> 
> On 07/05/2018 10:10, John Baldwin wrote:
>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>
>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>>> That seems like kgdb is looking at the wrong CPU.? Can you use
>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>>>> and get their backtraces?? You could also just do 'thread apply
>>>>>> all bt' and put that file at a URL if that is easiest.
>>>>>>
>>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>>
>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>> That doesn't look right at all.? Are you sure the kernel matches the
>>>> vmcore?? Also, which kgdb version are you using?
>>>>
>>> yea i agree that doesn't look right at all.? here is my setup:
>>>
>>> $ which kgdb
>>> /usr/bin/kgdb
>>> $ kgdb
>>> GNU gdb 6.1.1 [FreeBSD]
>>> $ ls -lh /var/crash/vmcore.1
>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>
>>> and i invoke kgdb like so:
>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
>>>
>>> here's a gist of my full gdb session:
>>> http://termbin.com/krsn
>>>
>>> dunno - maybe i have a bad core dump?? regardless, more than happy to
>>> help so let me know if i should try anything else or patches etc..
>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
>>
> 
> that seems to have done the trick, at least the output looks more 
> encouraging.
> 
>  ?--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> KDB: enter: panic
> 
> __curthread () at ./machine/pcpu.h:231
> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
> 
> 
> here's my full kgdb session:
> http://termbin.com/qa4f
> 
> i don't see any threads not in "sched_switch" though :(

Hi,

The problem may be that the patch to enable atomic inlining of all 
macros forgot to set the SMP keyword which means SMP is not defined at 
all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!

/*
  * For userland, always use lock prefixes so that the binaries will run
  * on both SMP and !SMP systems.
  */
#if defined(SMP) || !defined(_KERNEL)
#define MPLOCKED        "lock ; "
#else
#define MPLOCKED
#endif

Can you try to recompile the LinuxKPI /sys/modules/linuxkpi with 
DEBUG_FLAGS="-DSMP" ?

and similarly the drm-next package?

--HPS

From marklmi at yahoo.com  Thu Jul  5 19:08:59 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 5 Jul 2018 12:08:49 -0700
Subject: svn commit: r336012 - in head: . usr.sbin/config [ broken for
 ci.freebsd.org's FreeBSD-head-{sparc64,powerpcspe,powerpc,i386,armv7}-build
Message-ID: <2D701F12-BF14-4C95-AAEC-8184577C0B22@yahoo.com>

Examples:

https://ci.freebsd.org/job/FreeBSD-head-armv7-build/568/console shows:

18:54:11 
--- _bootstrap-tools-usr.sbin/config ---

18:54:11 
mkmakefile.o: In function `dump_nvlist':

18:54:11 
/usr/src/usr.sbin/config/mkmakefile.c:287: undefined reference to `cnvlist_get_string'

18:54:11 
/usr/src/usr.sbin/config/mkmakefile.c:289: undefined reference to `cnvlist_free_string'

18:54:11 
cc: error: linker command failed with exit code 1 (use -v to see invocation)

18:54:11 
*** [config.full] Error code 1

(i386 agrees.)


As for gcc 4.2.1 (32-bit and 64-bit targets), an example:

https://ci.freebsd.org/job/FreeBSD-head-powerpcspe-build/ shows:

--------------------------------------------------------------
>>> stage 1: configuring the kernel
--------------------------------------------------------------
cd /usr/src/sys/powerpc/conf;  PATH=/usr/obj/usr/src/powerpc.powerpcspe/tmp/legacy/usr/sbin:/usr/obj/usr/src/powerpc.powerpcspe/tmp/legacy/usr/bin:/usr/obj/usr/src/powerpc.powerpcspe/tmp/legacy/bin:/usr/obj/usr/src/powerpc.powerpcspe/tmp/usr/sbin:/usr/obj/usr/src/powerpc.powerpcspe/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin  config  -d /usr/obj/usr/src/powerpc.powerpcspe/sys/MPC85XXSPE  -I '/usr/src/sys/powerpc/conf' '/usr/src/sys/powerpc/conf/MPC85XXSPE'
config: /usr/src/sys/powerpc/conf/MPC85XXSPE: No error: 0
*** [buildkernel] Error code 2



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From hps at selasky.org  Thu Jul  5 19:12:52 2018
From: hps at selasky.org (Hans Petter Selasky)
Date: Thu, 5 Jul 2018 21:12:24 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
Message-ID: <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>

On 07/05/18 20:59, Hans Petter Selasky wrote:
> On 07/05/18 19:48, Pete Wright wrote:
>>
>>
>> On 07/05/2018 10:10, John Baldwin wrote:
>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>>
>>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>>>> That seems like kgdb is looking at the wrong CPU.? Can you use
>>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>>>>> and get their backtraces?? You could also just do 'thread apply
>>>>>>> all bt' and put that file at a URL if that is easiest.
>>>>>>>
>>>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>>>
>>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>> That doesn't look right at all.? Are you sure the kernel matches the
>>>>> vmcore?? Also, which kgdb version are you using?
>>>>>
>>>> yea i agree that doesn't look right at all.? here is my setup:
>>>>
>>>> $ which kgdb
>>>> /usr/bin/kgdb
>>>> $ kgdb
>>>> GNU gdb 6.1.1 [FreeBSD]
>>>> $ ls -lh /var/crash/vmcore.1
>>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>>
>>>> and i invoke kgdb like so:
>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
>>>>
>>>> here's a gist of my full gdb session:
>>>> http://termbin.com/krsn
>>>>
>>>> dunno - maybe i have a bad core dump?? regardless, more than happy to
>>>> help so let me know if i should try anything else or patches etc..
>>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
>>>
>>
>> that seems to have done the trick, at least the output looks more 
>> encouraging.
>>
>> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>> KDB: enter: panic
>>
>> __curthread () at ./machine/pcpu.h:231
>> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
>>
>>
>> here's my full kgdb session:
>> http://termbin.com/qa4f
>>
>> i don't see any threads not in "sched_switch" though :(
> 
> Hi,
> 
> The problem may be that the patch to enable atomic inlining of all 
> macros forgot to set the SMP keyword which means SMP is not defined at 
> all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!
> 
> /*
>  ?* For userland, always use lock prefixes so that the binaries will run
>  ?* on both SMP and !SMP systems.
>  ?*/
> #if defined(SMP) || !defined(_KERNEL)
> #define MPLOCKED??????? "lock ; "
> #else
> #define MPLOCKED
> #endif
> 
> Can you try to recompile the LinuxKPI /sys/modules/linuxkpi with 
> DEBUG_FLAGS="-DSMP" ?
> 
> and similarly the drm-next package?
> 

Also please find attached a patch for amd64.

--HPS

-------------- next part --------------
A non-text attachment was scrubbed...
Name: atomic.h.diff
Type: text/x-patch
Size: 656 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180705/43503a8b/attachment.bin>

From kostikbel at gmail.com  Thu Jul  5 19:37:04 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Thu, 5 Jul 2018 22:36:46 +0300
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
References: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
Message-ID: <20180705193646.GM5562@kib.kiev.ua>

On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky wrote:
> On 07/05/18 20:59, Hans Petter Selasky wrote:
> > On 07/05/18 19:48, Pete Wright wrote:
> >>
> >>
> >> On 07/05/2018 10:10, John Baldwin wrote:
> >>> On 7/3/18 5:10 PM, Pete Wright wrote:
> >>>>
> >>>> On 07/03/2018 15:56, John Baldwin wrote:
> >>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
> >>>>>> On 07/03/2018 15:29, John Baldwin wrote:
> >>>>>>> That seems like kgdb is looking at the wrong CPU.? Can you use
> >>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
> >>>>>>> and get their backtraces?? You could also just do 'thread apply
> >>>>>>> all bt' and put that file at a URL if that is easiest.
> >>>>>>>
> >>>>>> sure thing John - here's a gist of "thread apply all bt"
> >>>>>>
> >>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> >>>>> That doesn't look right at all.? Are you sure the kernel matches the
> >>>>> vmcore?? Also, which kgdb version are you using?
> >>>>>
> >>>> yea i agree that doesn't look right at all.? here is my setup:
> >>>>
> >>>> $ which kgdb
> >>>> /usr/bin/kgdb
> >>>> $ kgdb
> >>>> GNU gdb 6.1.1 [FreeBSD]
> >>>> $ ls -lh /var/crash/vmcore.1
> >>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
> >>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
> >>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
> >>>> /usr/lib/debug/boot/kernel/kernel.debug
> >>>>
> >>>> and i invoke kgdb like so:
> >>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
> >>>>
> >>>> here's a gist of my full gdb session:
> >>>> http://termbin.com/krsn
> >>>>
> >>>> dunno - maybe i have a bad core dump?? regardless, more than happy to
> >>>> help so let me know if i should try anything else or patches etc..
> >>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
> >>>
> >>
> >> that seems to have done the trick, at least the output looks more 
> >> encouraging.
> >>
> >> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> >> KDB: enter: panic
> >>
> >> __curthread () at ./machine/pcpu.h:231
> >> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
> >>
> >>
> >> here's my full kgdb session:
> >> http://termbin.com/qa4f
> >>
> >> i don't see any threads not in "sched_switch" though :(
> > 
> > Hi,
> > 
> > The problem may be that the patch to enable atomic inlining of all 
> > macros forgot to set the SMP keyword which means SMP is not defined at 
> > all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!
Problem is that out-of-tree modules build does not have opt*.h files
from the kernel.  UP config is a valid one, flipping some option's
default value does not solve the problem.

The build invocation for such modules needs to provide KERNBUILDDIR
variable pointing to the kernel build directory, where all opt*.h files
are located.

> > 
> > /*
> >  ?* For userland, always use lock prefixes so that the binaries will run
> >  ?* on both SMP and !SMP systems.
> >  ?*/
> > #if defined(SMP) || !defined(_KERNEL)
> > #define MPLOCKED??????? "lock ; "
> > #else
> > #define MPLOCKED
> > #endif
> > 
> > Can you try to recompile the LinuxKPI /sys/modules/linuxkpi with 
> > DEBUG_FLAGS="-DSMP" ?
> > 
> > and similarly the drm-next package?
> > 
> 
> Also please find attached a patch for amd64.
> 
> --HPS
> 

> Index: sys/amd64/include/atomic.h
> ===================================================================
> --- sys/amd64/include/atomic.h	(revision 335974)
> +++ sys/amd64/include/atomic.h	(working copy)
> @@ -132,7 +132,7 @@
>   * For userland, always use lock prefixes so that the binaries will run
>   * on both SMP and !SMP systems.
>   */
> -#if defined(SMP) || !defined(_KERNEL)
> +#if defined(SMP) || !defined(_KERNEL) || defined(KLD_MODULE)
>  #define	MPLOCKED	"lock ; "
>  #else
>  #define	MPLOCKED
> @@ -354,7 +354,7 @@
>   */
>  #define	OFFSETOF_MONITORBUF	0x100
>  
> -#if defined(SMP)
> +#if defined(SMP) || defined(KLD_MODULE)
>  static __inline void
>  __storeload_barrier(void)
>  {

> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


From jhb at FreeBSD.org  Thu Jul  5 19:44:06 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Thu, 5 Jul 2018 12:44:02 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <20180705193646.GM5562@kib.kiev.ua>
References: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
Message-ID: <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>

On 7/5/18 12:36 PM, Konstantin Belousov wrote:
> On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky wrote:
>> On 07/05/18 20:59, Hans Petter Selasky wrote:
>>> On 07/05/18 19:48, Pete Wright wrote:
>>>>
>>>>
>>>> On 07/05/2018 10:10, John Baldwin wrote:
>>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>>>>
>>>>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>>>>>> That seems like kgdb is looking at the wrong CPU.? Can you use
>>>>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>>>>>>> and get their backtraces?? You could also just do 'thread apply
>>>>>>>>> all bt' and put that file at a URL if that is easiest.
>>>>>>>>>
>>>>>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>>>>>
>>>>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>>>> That doesn't look right at all.? Are you sure the kernel matches the
>>>>>>> vmcore?? Also, which kgdb version are you using?
>>>>>>>
>>>>>> yea i agree that doesn't look right at all.? here is my setup:
>>>>>>
>>>>>> $ which kgdb
>>>>>> /usr/bin/kgdb
>>>>>> $ kgdb
>>>>>> GNU gdb 6.1.1 [FreeBSD]
>>>>>> $ ls -lh /var/crash/vmcore.1
>>>>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
>>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>>>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>>>>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>>>>
>>>>>> and i invoke kgdb like so:
>>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug /var/crash/vmcore.1
>>>>>>
>>>>>> here's a gist of my full gdb session:
>>>>>> http://termbin.com/krsn
>>>>>>
>>>>>> dunno - maybe i have a bad core dump?? regardless, more than happy to
>>>>>> help so let me know if i should try anything else or patches etc..
>>>>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
>>>>>
>>>>
>>>> that seems to have done the trick, at least the output looks more 
>>>> encouraging.
>>>>
>>>> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>>>> KDB: enter: panic
>>>>
>>>> __curthread () at ./machine/pcpu.h:231
>>>> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
>>>>
>>>>
>>>> here's my full kgdb session:
>>>> http://termbin.com/qa4f
>>>>
>>>> i don't see any threads not in "sched_switch" though :(
>>>
>>> Hi,
>>>
>>> The problem may be that the patch to enable atomic inlining of all 
>>> macros forgot to set the SMP keyword which means SMP is not defined at 
>>> all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!
> Problem is that out-of-tree modules build does not have opt*.h files
> from the kernel.  UP config is a valid one, flipping some option's
> default value does not solve the problem.

Yes, but using the lock prefix in a generic module is ok (it will still
work, just not quite as fast) whereas the lack of lock is fatal on 
SMP.  I would amend Hans' patch slightly to honor the opt_* setting
for KLD_TIED (but that is only true if KLD_TIED means "built as part of
a kernel build, so has valid opt_foo.h headers" and not
'a standalone module where someone put MODULES_TIED=1 on the command line
to make').

-- 
John Baldwin

From marklmi at yahoo.com  Thu Jul  5 19:46:46 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 5 Jul 2018 12:46:42 -0700
Subject: svn commit: r336002 - in head: usr.bin/netstat usr.sbin/tcpdrop [
 as-of -r336013: still broken: ci.freebsd.org
 FreeBSD-head-{mips,powerpc,powerpcspe}-build 
Message-ID: <18A86BF1-7428-4387-8889-7EEC07CD8EDA@yahoo.com>

> Author: brooks
> Date: Thu Jul  5 17:02:10 2018
> New Revision: 336002
> URL: 
> https://svnweb.freebsd.org/changeset/base/336002
> 
> 
> Log:
>   Work around lame warnings in ancient gcc on 32-bit platforms.
>   
>   Fixes r335979.


[The below are the gcc 4.2.1 based 32-bit architectures.]

https://ci.freebsd.org/job/FreeBSD-head-mips-build/3192/consoleText shows
(as an example):

--- kern_descrip.o ---
cc1: warnings being treated as errors
/usr/src/sys/kern/kern_descrip.c: In function 'sysctl_kern_file':
/usr/src/sys/kern/kern_descrip.c:3365: warning: cast from pointer to integer of different size [-Wpointer-to-int-cast]
/usr/src/sys/kern/kern_descrip.c:3366: warning: cast from pointer to integer of different size [-Wpointer-to-int-cast]
/usr/src/sys/kern/kern_descrip.c:3367: warning: cast from pointer to integer of different size [-Wpointer-to-int-cast]

powerpc and powerpcspe agree.

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From bzeeb-lists at lists.zabbadoz.net  Thu Jul  5 21:31:35 2018
From: bzeeb-lists at lists.zabbadoz.net (Bjoern A. Zeeb)
Date: Thu, 05 Jul 2018 21:31:18 +0000
Subject: EFI booting from external USB pen drive
In-Reply-To: <201807051818.w65II3mw048904@pdx.rh.CN85.dnsmgr.net>
References: <201807051818.w65II3mw048904@pdx.rh.CN85.dnsmgr.net>
Message-ID: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>

On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:

> [ Charset UTF-8 unsupported, converting... ]
>> On 5 Jul 2018, at 17:19, Warner Losh wrote:
>>
>>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
>>
>> We use it for the default image we built and the wiki suggests it as
>> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
>
> IIRC FreeBSD recently cnahged to FAT16 or 32 on these
> as the size got pushed up to be larger than what FAT12
> can access.

https://svnweb.freebsd.org/base/head/stand/efi/boot1/generate-fat.sh?annotate=332561#l45

nope.

From imp at bsdimp.com  Thu Jul  5 21:55:21 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 15:55:19 -0600
Subject: EFI booting from external USB pen drive
In-Reply-To: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
References: <201807051818.w65II3mw048904@pdx.rh.CN85.dnsmgr.net>
 <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
Message-ID: <CANCZdfqYauHBkwNEmrh1ZSwCM2r1q1w_vuDXzZNDRzRsxf_oLA@mail.gmail.com>

On Thu, Jul 5, 2018 at 3:31 PM, Bjoern A. Zeeb <
bzeeb-lists at lists.zabbadoz.net> wrote:

> On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:
>
> [ Charset UTF-8 unsupported, converting... ]
>>
>>> On 5 Jul 2018, at 17:19, Warner Losh wrote:
>>>
>>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
>>>>
>>>
>>> We use it for the default image we built and the wiki suggests it as
>>> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
>>>
>>
>> IIRC FreeBSD recently cnahged to FAT16 or 32 on these
>> as the size got pushed up to be larger than what FAT12
>> can access.
>>
>
> https://svnweb.freebsd.org/base/head/stand/efi/boot1/generat
> e-fat.sh?annotate=332561#l45
>
> nope.
>

Yea, this should die a firey death in a fire, burned with flames, and the
ashes stirred into a paste that's tossed overboard into the ocean :)

But before that glorious day, I have a few last niggles to fix in
loader.efi.

Warner

From imp at bsdimp.com  Thu Jul  5 22:02:10 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 16:02:08 -0600
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
References: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
Message-ID: <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>

On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org> wrote:

> On 7/5/18 12:36 PM, Konstantin Belousov wrote:
> > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky wrote:
> >> On 07/05/18 20:59, Hans Petter Selasky wrote:
> >>> On 07/05/18 19:48, Pete Wright wrote:
> >>>>
> >>>>
> >>>> On 07/05/2018 10:10, John Baldwin wrote:
> >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
> >>>>>>
> >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
> >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
> >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
> >>>>>>>>> That seems like kgdb is looking at the wrong CPU.  Can you use
> >>>>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
> >>>>>>>>> and get their backtraces?  You could also just do 'thread apply
> >>>>>>>>> all bt' and put that file at a URL if that is easiest.
> >>>>>>>>>
> >>>>>>>> sure thing John - here's a gist of "thread apply all bt"
> >>>>>>>>
> >>>>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> >>>>>>> That doesn't look right at all.  Are you sure the kernel matches
> the
> >>>>>>> vmcore?  Also, which kgdb version are you using?
> >>>>>>>
> >>>>>> yea i agree that doesn't look right at all.  here is my setup:
> >>>>>>
> >>>>>> $ which kgdb
> >>>>>> /usr/bin/kgdb
> >>>>>> $ kgdb
> >>>>>> GNU gdb 6.1.1 [FreeBSD]
> >>>>>> $ ls -lh /var/crash/vmcore.1
> >>>>>> -rw-------  1 root  wheel   1.6G Jul  3 15:03 /var/crash/vmcore.1
> >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
> >>>>>> -r-xr-xr-x  1 root  wheel  87840496 Jul  3 13:54
> >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
> >>>>>>
> >>>>>> and i invoke kgdb like so:
> >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
> /var/crash/vmcore.1
> >>>>>>
> >>>>>> here's a gist of my full gdb session:
> >>>>>> http://termbin.com/krsn
> >>>>>>
> >>>>>> dunno - maybe i have a bad core dump?  regardless, more than happy
> to
> >>>>>> help so let me know if i should try anything else or patches etc..
> >>>>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
> >>>>>
> >>>>
> >>>> that seems to have done the trick, at least the output looks more
> >>>> encouraging.
> >>>>
> >>>>   --- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> >>>> KDB: enter: panic
> >>>>
> >>>> __curthread () at ./machine/pcpu.h:231
> >>>> 231        __asm("movq %%gs:%1,%0" : "=r" (td)
> >>>>
> >>>>
> >>>> here's my full kgdb session:
> >>>> http://termbin.com/qa4f
> >>>>
> >>>> i don't see any threads not in "sched_switch" though :(
> >>>
> >>> Hi,
> >>>
> >>> The problem may be that the patch to enable atomic inlining of all
> >>> macros forgot to set the SMP keyword which means SMP is not defined at
> >>> all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!
> > Problem is that out-of-tree modules build does not have opt*.h files
> > from the kernel.  UP config is a valid one, flipping some option's
> > default value does not solve the problem.
>
> Yes, but using the lock prefix in a generic module is ok (it will still
> work, just not quite as fast) whereas the lack of lock is fatal on
> SMP.  I would amend Hans' patch slightly to honor the opt_* setting
> for KLD_TIED (but that is only true if KLD_TIED means "built as part of
> a kernel build, so has valid opt_foo.h headers" and not
> 'a standalone module where someone put MODULES_TIED=1 on the command line
> to make').
>

I agree with this default. It's sensible to default to (a) the most popular
thing and (b) thing that always works, especially when (a) and (b) are
identical.

Don't make me start the "Do we really need an SMP option, why not make it
always on" thread :) The number of relevant uniprocessor x86 boxes that
benefit from omitting SMP is so small as to be irrelevant, IMHO. A MP
kernel runs just fine on them...

Warner

From marklmi at yahoo.com  Thu Jul  5 22:49:27 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 5 Jul 2018 15:49:13 -0700
Subject: ci.freebsd.org's FreeBSD-head-i386-testvm fails for: pkg: No packages
 available to install matching 'scapy' have been found in the
 repositories
Message-ID: <76841358-DBB1-4400-9E99-9B7375245DD2@yahoo.com>

https://ci.freebsd.org/job/FreeBSD-head-i386-testvm/6978/console shows:

22:34:39 All repositories are up to date.
22:34:39 + sudo chroot ufs pkg install -y kyua perl5 scapy ksh93 python
22:34:39 Updating FreeBSD repository catalogue...
22:34:39 FreeBSD repository is up to date.
22:34:39 All repositories are up to date.
22:34:39 Updating database digests format: . done
22:34:39 pkg: No packages available to install matching 'scapy' have been found in the repositories
22:34:39 Build step 'Execute shell' marked build as failure
22:34:39 FTP: Current build result is [FAILURE], not going to run.

There is a:

https://svnweb.freebsd.org/ports/head/net/scapy/



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Fri Jul  6 01:11:18 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Thu, 5 Jul 2018 18:11:14 -0700 (PDT)
Subject: EFI booting from external USB pen drive
In-Reply-To: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
Message-ID: <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>

> On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:
> 
> > [ Charset UTF-8 unsupported, converting... ]
> >> On 5 Jul 2018, at 17:19, Warner Losh wrote:
> >>
> >>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
> >>
> >> We use it for the default image we built and the wiki suggests it as
> >> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
> >
> > IIRC FreeBSD recently cnahged to FAT16 or 32 on these
> > as the size got pushed up to be larger than what FAT12
> > can access.
> 
> https://svnweb.freebsd.org/base/head/stand/efi/boot1/generate-fat.sh?annotate=332561#l45
> 
> nope.

That is not the code we build release images with,
that is Warners tests for the boot loader.


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From pete at nomadlogic.org  Fri Jul  6 01:32:35 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Thu, 5 Jul 2018 18:32:27 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
References: <c640afcd-1fa4-a43e-5f36-f0bd11aad63d@protected-networks.net>
 <20180703170223.266dbf5b@thor.intern.walstatt.dynvpn.de>
 <cbd2d2f2-8ce4-871a-9aaf-75738d6c465b@daemonic.se>
 <ee0f7fce-7ce3-3784-f9e8-0f6862d59303@FreeBSD.org>
 <c7a3b447-00e9-8501-0484-841a371cfd62@nomadlogic.org>
 <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
Message-ID: <4aee6f32-a3b9-7e8e-8741-2309639ecce0@nomadlogic.org>



On 07/05/2018 12:12, Hans Petter Selasky wrote:
> On 07/05/18 20:59, Hans Petter Selasky wrote:
>> On 07/05/18 19:48, Pete Wright wrote:
>>>
>>>
>>> On 07/05/2018 10:10, John Baldwin wrote:
>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>>>
>>>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>>>>> That seems like kgdb is looking at the wrong CPU.? Can you use
>>>>>>>> 'info threads' and look for threads not stopped in 'sched_switch'
>>>>>>>> and get their backtraces?? You could also just do 'thread apply
>>>>>>>> all bt' and put that file at a URL if that is easiest.
>>>>>>>>
>>>>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>>>>
>>>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>>> That doesn't look right at all.? Are you sure the kernel matches the
>>>>>> vmcore?? Also, which kgdb version are you using?
>>>>>>
>>>>> yea i agree that doesn't look right at all.? here is my setup:
>>>>>
>>>>> $ which kgdb
>>>>> /usr/bin/kgdb
>>>>> $ kgdb
>>>>> GNU gdb 6.1.1 [FreeBSD]
>>>>> $ ls -lh /var/crash/vmcore.1
>>>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03 /var/crash/vmcore.1
>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>>>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>>>
>>>>> and i invoke kgdb like so:
>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug 
>>>>> /var/crash/vmcore.1
>>>>>
>>>>> here's a gist of my full gdb session:
>>>>> http://termbin.com/krsn
>>>>>
>>>>> dunno - maybe i have a bad core dump?? regardless, more than happy to
>>>>> help so let me know if i should try anything else or patches etc..
>>>> Can you try installing gdb from ports and using /usr/local/bin/kgdb?
>>>>
>>>
>>> that seems to have done the trick, at least the output looks more 
>>> encouraging.
>>>
>>> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>>> KDB: enter: panic
>>>
>>> __curthread () at ./machine/pcpu.h:231
>>> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
>>>
>>>
>>> here's my full kgdb session:
>>> http://termbin.com/qa4f
>>>
>>> i don't see any threads not in "sched_switch" though :(
>>
>> Hi,
>>
>> The problem may be that the patch to enable atomic inlining of all 
>> macros forgot to set the SMP keyword which means SMP is not defined 
>> at all for KLD's so all non-kernel atomic usage is with MPLOCKED empty!
>>
>> /*
>> ??* For userland, always use lock prefixes so that the binaries will run
>> ??* on both SMP and !SMP systems.
>> ??*/
>> #if defined(SMP) || !defined(_KERNEL)
>> #define MPLOCKED??????? "lock ; "
>> #else
>> #define MPLOCKED
>> #endif
>>
>> Can you try to recompile the LinuxKPI /sys/modules/linuxkpi with 
>> DEBUG_FLAGS="-DSMP" ?
>>
>> and similarly the drm-next package?
>>
>
> Also please find attached a patch for amd64.


i have been running this patch for about 4hours.? previous uptime before 
this patch was under 1hr.? i've attached and detached HDMI displays and 
gone through several suspend/resume cycles as well without any issues.

to be clear - since i'm not sure this is was your intent - i applied the 
patch, rebuilt/installed a new kernel.? i did *not* use the "-DSMP" 
flags for linuxkpi or the drm-next module.

cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From imp at bsdimp.com  Fri Jul  6 02:17:15 2018
From: imp at bsdimp.com (Warner Losh)
Date: Thu, 5 Jul 2018 20:17:13 -0600
Subject: EFI booting from external USB pen drive
In-Reply-To: <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>
References: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
 <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>
Message-ID: <CANCZdfpuLdYE47Zun9971GEYbHr9ypHXx405-o+r0BuRPGZQSQ@mail.gmail.com>

On Thu, Jul 5, 2018 at 7:11 PM, Rodney W. Grimes <
freebsd-rwg at pdx.rh.cn85.dnsmgr.net> wrote:

> > On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:
> >
> > > [ Charset UTF-8 unsupported, converting... ]
> > >> On 5 Jul 2018, at 17:19, Warner Losh wrote:
> > >>
> > >>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
> > >>
> > >> We use it for the default image we built and the wiki suggests it as
> > >> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
> > >
> > > IIRC FreeBSD recently cnahged to FAT16 or 32 on these
> > > as the size got pushed up to be larger than what FAT12
> > > can access.
> >
> > https://svnweb.freebsd.org/base/head/stand/efi/boot1/
> generate-fat.sh?annotate=332561#l45
> >
> > nope.
>
> That is not the code we build release images with,
> that is Warners tests for the boot loader.
>

No, that's the actual code that generates boot1.efiffat.

Warner

From manu at bidouilliste.com  Fri Jul  6 06:34:26 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Fri, 06 Jul 2018 08:34:22 +0200
Subject: EFI booting from external USB pen drive
In-Reply-To: <CANCZdfpuLdYE47Zun9971GEYbHr9ypHXx405-o+r0BuRPGZQSQ@mail.gmail.com>
References: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
 <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>
 <CANCZdfpuLdYE47Zun9971GEYbHr9ypHXx405-o+r0BuRPGZQSQ@mail.gmail.com>
Message-ID: <c16ee49cb9a0a91b4f187753a380c360@megadrive.org>

On 2018-07-06 04:17, Warner Losh wrote:
> On Thu, Jul 5, 2018 at 7:11 PM, Rodney W. Grimes <
> freebsd-rwg at pdx.rh.cn85.dnsmgr.net> wrote:
> 
>> > On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:
>> >
>> > > [ Charset UTF-8 unsupported, converting... ]
>> > >> On 5 Jul 2018, at 17:19, Warner Losh wrote:
>> > >>
>> > >>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
>> > >>
>> > >> We use it for the default image we built and the wiki suggests it as
>> > >> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
>> > >
>> > > IIRC FreeBSD recently cnahged to FAT16 or 32 on these
>> > > as the size got pushed up to be larger than what FAT12
>> > > can access.
>> >
>> > https://svnweb.freebsd.org/base/head/stand/efi/boot1/
>> generate-fat.sh?annotate=332561#l45
>> >
>> > nope.
>> 
>> That is not the code we build release images with,
>> that is Warners tests for the boot loader.
>> 
> 
> No, that's the actual code that generates boot1.efiffat.
> 
> Warner

  Yup, and EFI have no problem at all with this.
  FAT12 can work with all EFI implementation, the problem is the size of 
the FAT12 part that sometimes causes problems.
  Rod, you are refering to the arm images which do not uses makefs or 
generate-fat.sh but using md device and newfs_msdos.

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From bzeeb-lists at lists.zabbadoz.net  Fri Jul  6 07:34:31 2018
From: bzeeb-lists at lists.zabbadoz.net (Bjoern A. Zeeb)
Date: Fri, 06 Jul 2018 07:34:21 +0000
Subject: EFI booting from external USB pen drive
In-Reply-To: <c16ee49cb9a0a91b4f187753a380c360@megadrive.org>
References: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
 <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>
 <CANCZdfpuLdYE47Zun9971GEYbHr9ypHXx405-o+r0BuRPGZQSQ@mail.gmail.com>
 <c16ee49cb9a0a91b4f187753a380c360@megadrive.org>
Message-ID: <36244855-DC9D-405A-863B-99A922D26AB2@lists.zabbadoz.net>

On 6 Jul 2018, at 6:34, Emmanuel Vadot wrote:

>  FAT12 can work with all EFI implementation, the problem is the size 
> of the FAT12 part that sometimes causes problems.

Ok, now that we are all on the same page, changing it to newfs_msdos -F 
32  did not make a change to my problem of the boot menu changing to the 
blank screen and immediately returning to itself.

/bz

From zeising+freebsd at daemonic.se  Fri Jul  6 07:52:29 2018
From: zeising+freebsd at daemonic.se (Niclas Zeising)
Date: Fri, 6 Jul 2018 09:52:24 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
References: <bb2cac77-4bcd-c87c-9bc9-ce5f8ce1c726@nomadlogic.org>
 <845aca10-8c01-fa3b-087f-f957df4e7531@nomadlogic.org>
 <063ae5c3-0584-1284-dd9d-ab8b5790baf1@FreeBSD.org>
 <0bf8e57b-fdb4-4c1a-3d0d-a734f8187ca8@nomadlogic.org>
 <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
 <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
Message-ID: <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>

On 07/06/18 00:02, Warner Losh wrote:
> 
> 
> On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org 
> <mailto:jhb at freebsd.org>> wrote:
> 
>     On 7/5/18 12:36 PM, Konstantin Belousov wrote:
>      > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky wrote:
>      >> On 07/05/18 20:59, Hans Petter Selasky wrote:
>      >>> On 07/05/18 19:48, Pete Wright wrote:
>      >>>>
>      >>>>
>      >>>> On 07/05/2018 10:10, John Baldwin wrote:
>      >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>      >>>>>>
>      >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
>      >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>      >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>      >>>>>>>>> That seems like kgdb is looking at the wrong CPU.? Can
>     you use
>      >>>>>>>>> 'info threads' and look for threads not stopped in
>     'sched_switch'
>      >>>>>>>>> and get their backtraces?? You could also just do 'thread
>     apply
>      >>>>>>>>> all bt' and put that file at a URL if that is easiest.
>      >>>>>>>>>
>      >>>>>>>> sure thing John - here's a gist of "thread apply all bt"
>      >>>>>>>>
>      >>>>>>>>
>     https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>     <https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed>
>      >>>>>>> That doesn't look right at all.? Are you sure the kernel
>     matches the
>      >>>>>>> vmcore?? Also, which kgdb version are you using?
>      >>>>>>>
>      >>>>>> yea i agree that doesn't look right at all.? here is my setup:
>      >>>>>>
>      >>>>>> $ which kgdb
>      >>>>>> /usr/bin/kgdb
>      >>>>>> $ kgdb
>      >>>>>> GNU gdb 6.1.1 [FreeBSD]
>      >>>>>> $ ls -lh /var/crash/vmcore.1
>      >>>>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03
>     /var/crash/vmcore.1
>      >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>      >>>>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
>      >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
>      >>>>>>
>      >>>>>> and i invoke kgdb like so:
>      >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
>     /var/crash/vmcore.1
>      >>>>>>
>      >>>>>> here's a gist of my full gdb session:
>      >>>>>> http://termbin.com/krsn
>      >>>>>>
>      >>>>>> dunno - maybe i have a bad core dump?? regardless, more than
>     happy to
>      >>>>>> help so let me know if i should try anything else or patches
>     etc..
>      >>>>> Can you try installing gdb from ports and using
>     /usr/local/bin/kgdb?
>      >>>>>
>      >>>>
>      >>>> that seems to have done the trick, at least the output looks more
>      >>>> encouraging.
>      >>>>
>      >>>> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>      >>>> KDB: enter: panic
>      >>>>
>      >>>> __curthread () at ./machine/pcpu.h:231
>      >>>> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
>      >>>>
>      >>>>
>      >>>> here's my full kgdb session:
>      >>>> http://termbin.com/qa4f
>      >>>>
>      >>>> i don't see any threads not in "sched_switch" though :(
>      >>>
>      >>> Hi,
>      >>>
>      >>> The problem may be that the patch to enable atomic inlining of all
>      >>> macros forgot to set the SMP keyword which means SMP is not
>     defined at
>      >>> all for KLD's so all non-kernel atomic usage is with MPLOCKED
>     empty!
>      > Problem is that out-of-tree modules build does not have opt*.h files
>      > from the kernel.? UP config is a valid one, flipping some option's
>      > default value does not solve the problem.
> 
>     Yes, but using the lock prefix in a generic module is ok (it will still
>     work, just not quite as fast) whereas the lack of lock is fatal on
>     SMP.? I would amend Hans' patch slightly to honor the opt_* setting
>     for KLD_TIED (but that is only true if KLD_TIED means "built as part of
>     a kernel build, so has valid opt_foo.h headers" and not
>     'a standalone module where someone put MODULES_TIED=1 on the command
>     line
>     to make').
> 
> 
> I agree with this default. It's sensible to default to (a) the most 
> popular thing and (b) thing that always works, especially when (a) and 
> (b) are identical.
> 
> Don't make me start the "Do we really need an SMP option, why not make 
> it always on" thread :) The number of relevant uniprocessor x86 boxes 
> that benefit from omitting SMP is so small as to be irrelevant, IMHO. A 
> MP kernel runs just fine on them...
> 
> Warner

Where are we on this?
It is important to get it fixed, it's already been 4 days, which means 4 
days of all modern FreeBSD desktop systems being broken, and possibly 
other systems with kernel modules from ports as well.


Another question, how hard would it be to expose how the kernel was 
built to modules built from ports, so that they can figure out stuff 
like SMP and others, that might affect the module build?

Regards
-- 
Niclas

From manu at bidouilliste.com  Fri Jul  6 08:05:49 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Fri, 06 Jul 2018 10:05:46 +0200
Subject: EFI booting from external USB pen drive
In-Reply-To: <36244855-DC9D-405A-863B-99A922D26AB2@lists.zabbadoz.net>
References: <6889B6B2-A102-4832-9319-124CEE081784@lists.zabbadoz.net>
 <201807060111.w661BEbj050010@pdx.rh.CN85.dnsmgr.net>
 <CANCZdfpuLdYE47Zun9971GEYbHr9ypHXx405-o+r0BuRPGZQSQ@mail.gmail.com>
 <c16ee49cb9a0a91b4f187753a380c360@megadrive.org>
 <36244855-DC9D-405A-863B-99A922D26AB2@lists.zabbadoz.net>
Message-ID: <ecfb77196d8a467979e0aa328e6427de@megadrive.org>

On 2018-07-06 09:34, Bjoern A. Zeeb wrote:
> On 6 Jul 2018, at 6:34, Emmanuel Vadot wrote:
> 
>>  FAT12 can work with all EFI implementation, the problem is the size 
>> of the FAT12 part that sometimes causes problems.
> 
> Ok, now that we are all on the same page, changing it to newfs_msdos
> -F 32  did not make a change to my problem of the boot menu changing
> to the blank screen and immediately returning to itself.
> 
> /bz

  What boot menu and what blank screen ?

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From ohartmann at walstatt.org  Fri Jul  6 08:13:01 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 6 Jul 2018 10:12:52 +0200
Subject: CURRENT: building PkgBase for 11.2-RELENG on CURRENT fails
Message-ID: <20180706101247.4ae7cbcb@freyja.zeit4.iv.bundesimmobilien.de>

I fail to buildworld/buildkernel and package FreeBSD 11.2-RELENG on a CURRENT
host (FreeBSD 12.0-CURRENT #165 r336013: Thu Jul  5 21:00:36 CEST 2018 amd64)
with the error shown below.

My aim is to have CURRENT building 11.1 and 11.2 packages for "base" and for
the poudriere jails. This seems to start failing recently and I can not fathom
why. Any ideas?

As the env variables show, the sources are stored
at /pool/sources/11.2-RELENG/src and for the build environment, I point to that
source and obj base.


Kind regards,
Oliver

[...]
+ cd /pool/sources/11.2-RELENG/src
+ env 'MAKEOBJDIRPREFIX=/pool/sources/11.2-RELENG/obj' 'WITH_META_MODE=YES'
  '__MAKE_CONF=/usr/local/etc/config/amd64/11.2-RELENG-make.conf'
  'SRCCONF=/usr/local/etc/config/amd64/11.2-RELENG-src.conf'
  'SRC_ENV_CONF=/usr/local/etc/config/amd64/11.2-RELENG-src-env.conf' make -j9
  'TARGET=amd64'
  'KERNCONFDIR=/usr/local/etc/config/amd64/11.2-RELENG/kernel_conf/' 'KERNCONF=
  GENERIC-NODEBUG ' 'NO_INSTALLEXTRAKERNELS=NO' 'NO_INSTALLKERNEL=NO'
  buildworld buildkernel --- buildworld --- make[1]:
  "/pool/sources/11.2-RELENG/src/Makefile.inc1" line 1517: Unassociated shell
  command "@cd ${KSTAGEDIR}/${DISTDIR} ;  awk -f
  ${SRCDIR}/release/scripts/mtree-to-plist.awk  -v kernel=yes -v
  _kernconf=${INSTALLKERNEL}  ${KSTAGEDIR}/kernel.meta ;  cap_arg=`cd
  ${SRCDIR}/etc ; ${MAKE} -VCAP_MKDB_ENDIAN` ;  pwd_arg=`cd ${SRCDIR}/etc ;
  ${MAKE} -VPWD_MKDB_ENDIAN` ;  sed -e "s/%VERSION%/${PKG_VERSION}/"  -e
  "s/%PKGNAME%/kernel-${INSTALLKERNEL:tl}${:U""}/"  -e "s/%KERNELDIR%/kernel/"
  -e "s/%COMMENT%/FreeBSD ${INSTALLKERNEL} kernel ${:U""}/"  -e
  "s/%DESC%/FreeBSD ${INSTALLKERNEL} kernel ${:U""}/"  -e
  "s/%CAP_MKDB_ENDIAN%/$${cap_arg}/g"  -e "s/%PWD_MKDB_ENDIAN%/$${pwd_arg}/g"
  ${SRCDIR}/release/packages/kernel.ucl  >
  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U""}.ucl ;  awk -F\"
  '  /name/ { printf("===> Creating %s-", $$2); next }  /version/ {print $$2;
  next } '  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U""}.ucl ;
  ${PKG_CMD} -o ABI_FILE=${WSTAGEDIR}/bin/sh -o ALLOW_BASE_SHLIBS=yes  create
  -M ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U""}.ucl  -p
  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U""}.plist  -r
  ${KSTAGEDIR}/${DISTDIR}  -o ${REPODIR}/$$(${PKG_CMD} -o
  ABI_FILE=${WSTAGEDIR}/bin/sh config ABI)/${PKG_VERSION}" 

make[1]: "/pool/sources/11.2-RELENG/src/Makefile.inc1" line 1517: Unassociated
shell command "@cd ${KSTAGEDIR}/${DISTDIR} ;  awk -f
  ${SRCDIR}/release/scripts/mtree-to-plist.awk  -v kernel=yes -v
  _kernconf=${INSTALLKERNEL}  ${KSTAGEDIR}/kernel.meta ;  cap_arg=`cd
  ${SRCDIR}/etc ; ${MAKE} -VCAP_MKDB_ENDIAN` ;  pwd_arg=`cd ${SRCDIR}/etc ;
  ${MAKE} -VPWD_MKDB_ENDIAN` ;  sed -e "s/%VERSION%/${PKG_VERSION}/"  -e
  "s/%PKGNAME%/kernel-${INSTALLKERNEL:tl}${:U-debug}/"  -e
  "s/%KERNELDIR%/kernel/"  -e "s/%COMMENT%/FreeBSD ${INSTALLKERNEL} kernel
  ${:U-debug}/"  -e "s/%DESC%/FreeBSD ${INSTALLKERNEL} kernel ${:U-debug}/"  -e
  "s/%CAP_MKDB_ENDIAN%/$${cap_arg}/g"  -e "s/%PWD_MKDB_ENDIAN%/$${pwd_arg}/g"
  ${SRCDIR}/release/packages/kernel.ucl  >
  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U-debug}.ucl ;  awk -F\"
  '  /name/ { printf("===> Creating %s-", $$2); next }  /version/ {print $$2;
  next } '  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U-debug}.ucl ;
  ${PKG_CMD} -o ABI_FILE=${WSTAGEDIR}/bin/sh -o ALLOW_BASE_SHLIBS=yes  create
  -M ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U-debug}.ucl  -p
  ${KSTAGEDIR}/${DISTDIR}/kernel.${INSTALLKERNEL}${:U-debug}.plist  -r
  ${KSTAGEDIR}/${DISTDIR}  -o ${REPODIR}/$$(${PKG_CMD} -o
  ABI_FILE=${WSTAGEDIR}/bin/sh config ABI)/${PKG_VERSION}" 

make[1]: Fatal errors encountered -- cannot continue 
make[1]: stopped in /pool/sources/11.2-RELENG/src

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Fri Jul  6 08:37:19 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Fri, 6 Jul 2018 01:37:10 -0700 (PDT)
Subject: EFI booting from external USB pen drive
In-Reply-To: <c16ee49cb9a0a91b4f187753a380c360@megadrive.org>
Message-ID: <201807060837.w668bApk051314@pdx.rh.CN85.dnsmgr.net>

> On 2018-07-06 04:17, Warner Losh wrote:
> > On Thu, Jul 5, 2018 at 7:11 PM, Rodney W. Grimes <
> > freebsd-rwg at pdx.rh.cn85.dnsmgr.net> wrote:
> > 
> >> > On 5 Jul 2018, at 18:18, Rodney W. Grimes wrote:
> >> >
> >> > > [ Charset UTF-8 unsupported, converting... ]
> >> > >> On 5 Jul 2018, at 17:19, Warner Losh wrote:
> >> > >>
> >> > >>> FAT12 isn't good for UEFI. Use FAT16 or FAT32.
> >> > >>
> >> > >> We use it for the default image we built and the wiki suggests it as
> >> > >> well at https://wiki.freebsd.org/UEFI#CD.2FDVD_Boot_under_UEFI
> >> > >
> >> > > IIRC FreeBSD recently cnahged to FAT16 or 32 on these
> >> > > as the size got pushed up to be larger than what FAT12
> >> > > can access.
> >> >
> >> > https://svnweb.freebsd.org/base/head/stand/efi/boot1/
> >> generate-fat.sh?annotate=332561#l45
> >> >
> >> > nope.
> >> 
> >> That is not the code we build release images with,
> >> that is Warners tests for the boot loader.
> >> 
> > 
> > No, that's the actual code that generates boot1.efiffat.
> > 
> > Warner
> 
>   Yup, and EFI have no problem at all with this.
>   FAT12 can work with all EFI implementation, the problem is the size of 
> the FAT12 part that sometimes causes problems.
>   Rod, you are refering to the arm images which do not uses makefs or 
> generate-fat.sh but using md device and newfs_msdos.

Yes, your right Emmanuel, thanks.  I thought that was the last
place fat12 was in use, but I see there is this ugly bit of evil
still around.

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From kostikbel at gmail.com  Fri Jul  6 08:47:42 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Fri, 6 Jul 2018 11:47:30 +0300
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>
References: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
 <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
 <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>
Message-ID: <20180706084729.GN5562@kib.kiev.ua>

On Fri, Jul 06, 2018 at 09:52:24AM +0200, Niclas Zeising wrote:
> On 07/06/18 00:02, Warner Losh wrote:
> > 
> > 
> > On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org 
> > <mailto:jhb at freebsd.org>> wrote:
> > 
> >     On 7/5/18 12:36 PM, Konstantin Belousov wrote:
> >      > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky wrote:
> >      >> On 07/05/18 20:59, Hans Petter Selasky wrote:
> >      >>> On 07/05/18 19:48, Pete Wright wrote:
> >      >>>>
> >      >>>>
> >      >>>> On 07/05/2018 10:10, John Baldwin wrote:
> >      >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
> >      >>>>>>
> >      >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
> >      >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
> >      >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
> >      >>>>>>>>> That seems like kgdb is looking at the wrong CPU.? Can
> >     you use
> >      >>>>>>>>> 'info threads' and look for threads not stopped in
> >     'sched_switch'
> >      >>>>>>>>> and get their backtraces?? You could also just do 'thread
> >     apply
> >      >>>>>>>>> all bt' and put that file at a URL if that is easiest.
> >      >>>>>>>>>
> >      >>>>>>>> sure thing John - here's a gist of "thread apply all bt"
> >      >>>>>>>>
> >      >>>>>>>>
> >     https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> >     <https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed>
> >      >>>>>>> That doesn't look right at all.? Are you sure the kernel
> >     matches the
> >      >>>>>>> vmcore?? Also, which kgdb version are you using?
> >      >>>>>>>
> >      >>>>>> yea i agree that doesn't look right at all.? here is my setup:
> >      >>>>>>
> >      >>>>>> $ which kgdb
> >      >>>>>> /usr/bin/kgdb
> >      >>>>>> $ kgdb
> >      >>>>>> GNU gdb 6.1.1 [FreeBSD]
> >      >>>>>> $ ls -lh /var/crash/vmcore.1
> >      >>>>>> -rw-------? 1 root? wheel?? 1.6G Jul? 3 15:03
> >     /var/crash/vmcore.1
> >      >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
> >      >>>>>> -r-xr-xr-x? 1 root? wheel? 87840496 Jul? 3 13:54
> >      >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
> >      >>>>>>
> >      >>>>>> and i invoke kgdb like so:
> >      >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
> >     /var/crash/vmcore.1
> >      >>>>>>
> >      >>>>>> here's a gist of my full gdb session:
> >      >>>>>> http://termbin.com/krsn
> >      >>>>>>
> >      >>>>>> dunno - maybe i have a bad core dump?? regardless, more than
> >     happy to
> >      >>>>>> help so let me know if i should try anything else or patches
> >     etc..
> >      >>>>> Can you try installing gdb from ports and using
> >     /usr/local/bin/kgdb?
> >      >>>>>
> >      >>>>
> >      >>>> that seems to have done the trick, at least the output looks more
> >      >>>> encouraging.
> >      >>>>
> >      >>>> ??--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> >      >>>> KDB: enter: panic
> >      >>>>
> >      >>>> __curthread () at ./machine/pcpu.h:231
> >      >>>> 231??? ??? __asm("movq %%gs:%1,%0" : "=r" (td)
> >      >>>>
> >      >>>>
> >      >>>> here's my full kgdb session:
> >      >>>> http://termbin.com/qa4f
> >      >>>>
> >      >>>> i don't see any threads not in "sched_switch" though :(
> >      >>>
> >      >>> Hi,
> >      >>>
> >      >>> The problem may be that the patch to enable atomic inlining of all
> >      >>> macros forgot to set the SMP keyword which means SMP is not
> >     defined at
> >      >>> all for KLD's so all non-kernel atomic usage is with MPLOCKED
> >     empty!
> >      > Problem is that out-of-tree modules build does not have opt*.h files
> >      > from the kernel.? UP config is a valid one, flipping some option's
> >      > default value does not solve the problem.
> > 
> >     Yes, but using the lock prefix in a generic module is ok (it will still
> >     work, just not quite as fast) whereas the lack of lock is fatal on
> >     SMP.? I would amend Hans' patch slightly to honor the opt_* setting
> >     for KLD_TIED (but that is only true if KLD_TIED means "built as part of
> >     a kernel build, so has valid opt_foo.h headers" and not
> >     'a standalone module where someone put MODULES_TIED=1 on the command
> >     line
> >     to make').
> > 
> > 
> > I agree with this default. It's sensible to default to (a) the most 
> > popular thing and (b) thing that always works, especially when (a) and 
> > (b) are identical.
> > 
> > Don't make me start the "Do we really need an SMP option, why not make 
> > it always on" thread :) The number of relevant uniprocessor x86 boxes 
> > that benefit from omitting SMP is so small as to be irrelevant, IMHO. A 
> > MP kernel runs just fine on them...
> > 
> > Warner
> 
> Where are we on this?
> It is important to get it fixed, it's already been 4 days, which means 4 
> days of all modern FreeBSD desktop systems being broken, and possibly 
> other systems with kernel modules from ports as well.
> 
> 
> Another question, how hard would it be to expose how the kernel was 
> built to modules built from ports, so that they can figure out stuff 
> like SMP and others, that might affect the module build?
Point the KERNBUILDDIR variable to the directory of the kernel build.
This is the directory where *.o and opt*.h are located.  Then everything
would just work.

From johalun0 at gmail.com  Fri Jul  6 09:14:41 2018
From: johalun0 at gmail.com (Johannes Lundberg)
Date: Fri, 6 Jul 2018 10:14:01 +0100
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <20180706084729.GN5562@kib.kiev.ua>
References: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
 <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
 <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>
 <20180706084729.GN5562@kib.kiev.ua>
Message-ID: <CAECmPwtBJEp_4fFLr1KZhKu2ZJfSGANBD21C0OXUZ=-qfomNBQ@mail.gmail.com>

On Fri, Jul 6, 2018 at 9:49 AM Konstantin Belousov <kostikbel at gmail.com>
wrote:

> On Fri, Jul 06, 2018 at 09:52:24AM +0200, Niclas Zeising wrote:
> > On 07/06/18 00:02, Warner Losh wrote:
> > >
> > >
> > > On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org
> > > <mailto:jhb at freebsd.org>> wrote:
> > >
> > >     On 7/5/18 12:36 PM, Konstantin Belousov wrote:
> > >      > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky
> wrote:
> > >      >> On 07/05/18 20:59, Hans Petter Selasky wrote:
> > >      >>> On 07/05/18 19:48, Pete Wright wrote:
> > >      >>>>
> > >      >>>>
> > >      >>>> On 07/05/2018 10:10, John Baldwin wrote:
> > >      >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
> > >      >>>>>>
> > >      >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
> > >      >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
> > >      >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
> > >      >>>>>>>>> That seems like kgdb is looking at the wrong CPU.  Can
> > >     you use
> > >      >>>>>>>>> 'info threads' and look for threads not stopped in
> > >     'sched_switch'
> > >      >>>>>>>>> and get their backtraces?  You could also just do
> 'thread
> > >     apply
> > >      >>>>>>>>> all bt' and put that file at a URL if that is easiest.
> > >      >>>>>>>>>
> > >      >>>>>>>> sure thing John - here's a gist of "thread apply all bt"
> > >      >>>>>>>>
> > >      >>>>>>>>
> > >     https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> > >     <https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
> >
> > >      >>>>>>> That doesn't look right at all.  Are you sure the kernel
> > >     matches the
> > >      >>>>>>> vmcore?  Also, which kgdb version are you using?
> > >      >>>>>>>
> > >      >>>>>> yea i agree that doesn't look right at all.  here is my
> setup:
> > >      >>>>>>
> > >      >>>>>> $ which kgdb
> > >      >>>>>> /usr/bin/kgdb
> > >      >>>>>> $ kgdb
> > >      >>>>>> GNU gdb 6.1.1 [FreeBSD]
> > >      >>>>>> $ ls -lh /var/crash/vmcore.1
> > >      >>>>>> -rw-------  1 root  wheel   1.6G Jul  3 15:03
> > >     /var/crash/vmcore.1
> > >      >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
> > >      >>>>>> -r-xr-xr-x  1 root  wheel  87840496 Jul  3 13:54
> > >      >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
> > >      >>>>>>
> > >      >>>>>> and i invoke kgdb like so:
> > >      >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
> > >     /var/crash/vmcore.1
> > >      >>>>>>
> > >      >>>>>> here's a gist of my full gdb session:
> > >      >>>>>> http://termbin.com/krsn
> > >      >>>>>>
> > >      >>>>>> dunno - maybe i have a bad core dump?  regardless, more
> than
> > >     happy to
> > >      >>>>>> help so let me know if i should try anything else or
> patches
> > >     etc..
> > >      >>>>> Can you try installing gdb from ports and using
> > >     /usr/local/bin/kgdb?
> > >      >>>>>
> > >      >>>>
> > >      >>>> that seems to have done the trick, at least the output looks
> more
> > >      >>>> encouraging.
> > >      >>>>
> > >      >>>>   --- trap 0, rip = 0, rsp = 0, rbp = 0 ---
> > >      >>>> KDB: enter: panic
> > >      >>>>
> > >      >>>> __curthread () at ./machine/pcpu.h:231
> > >      >>>> 231        __asm("movq %%gs:%1,%0" : "=r" (td)
> > >      >>>>
> > >      >>>>
> > >      >>>> here's my full kgdb session:
> > >      >>>> http://termbin.com/qa4f
> > >      >>>>
> > >      >>>> i don't see any threads not in "sched_switch" though :(
> > >      >>>
> > >      >>> Hi,
> > >      >>>
> > >      >>> The problem may be that the patch to enable atomic inlining
> of all
> > >      >>> macros forgot to set the SMP keyword which means SMP is not
> > >     defined at
> > >      >>> all for KLD's so all non-kernel atomic usage is with MPLOCKED
> > >     empty!
> > >      > Problem is that out-of-tree modules build does not have opt*.h
> files
> > >      > from the kernel.  UP config is a valid one, flipping some
> option's
> > >      > default value does not solve the problem.
> > >
> > >     Yes, but using the lock prefix in a generic module is ok (it will
> still
> > >     work, just not quite as fast) whereas the lack of lock is fatal on
> > >     SMP.  I would amend Hans' patch slightly to honor the opt_* setting
> > >     for KLD_TIED (but that is only true if KLD_TIED means "built as
> part of
> > >     a kernel build, so has valid opt_foo.h headers" and not
> > >     'a standalone module where someone put MODULES_TIED=1 on the
> command
> > >     line
> > >     to make').
> > >
> > >
> > > I agree with this default. It's sensible to default to (a) the most
> > > popular thing and (b) thing that always works, especially when (a) and
> > > (b) are identical.
> > >
> > > Don't make me start the "Do we really need an SMP option, why not make
> > > it always on" thread :) The number of relevant uniprocessor x86 boxes
> > > that benefit from omitting SMP is so small as to be irrelevant, IMHO.
> A
> > > MP kernel runs just fine on them...
> > >
> > > Warner
> >
> > Where are we on this?
> > It is important to get it fixed, it's already been 4 days, which means 4
> > days of all modern FreeBSD desktop systems being broken, and possibly
> > other systems with kernel modules from ports as well.
> >
> >
> > Another question, how hard would it be to expose how the kernel was
> > built to modules built from ports, so that they can figure out stuff
> > like SMP and others, that might affect the module build?
> Point the KERNBUILDDIR variable to the directory of the kernel build.
> This is the directory where *.o and opt*.h are located.  Then everything
> would just work.
>

Is the solution that we require everyone to build a kernel before they can
build the standalone modules or am I missing something here?

_______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From hps at selasky.org  Fri Jul  6 10:16:18 2018
From: hps at selasky.org (Hans Petter Selasky)
Date: Fri, 6 Jul 2018 12:15:55 +0200
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <CAECmPwtBJEp_4fFLr1KZhKu2ZJfSGANBD21C0OXUZ=-qfomNBQ@mail.gmail.com>
References: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
 <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
 <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>
 <20180706084729.GN5562@kib.kiev.ua>
 <CAECmPwtBJEp_4fFLr1KZhKu2ZJfSGANBD21C0OXUZ=-qfomNBQ@mail.gmail.com>
Message-ID: <1cd8c3c6-5d85-fbf3-cc06-1df8282216a1@selasky.org>

On 07/06/18 11:14, Johannes Lundberg wrote:
> On Fri, Jul 6, 2018 at 9:49 AM Konstantin Belousov <kostikbel at gmail.com>
> wrote:
> 
>> On Fri, Jul 06, 2018 at 09:52:24AM +0200, Niclas Zeising wrote:
>>> On 07/06/18 00:02, Warner Losh wrote:
>>>>
>>>>
>>>> On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org
>>>> <mailto:jhb at freebsd.org>> wrote:
>>>>
>>>>      On 7/5/18 12:36 PM, Konstantin Belousov wrote:
>>>>       > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky
>> wrote:
>>>>       >> On 07/05/18 20:59, Hans Petter Selasky wrote:
>>>>       >>> On 07/05/18 19:48, Pete Wright wrote:
>>>>       >>>>
>>>>       >>>>
>>>>       >>>> On 07/05/2018 10:10, John Baldwin wrote:
>>>>       >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>>       >>>>>>
>>>>       >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>>       >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>       >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>       >>>>>>>>> That seems like kgdb is looking at the wrong CPU.  Can
>>>>      you use
>>>>       >>>>>>>>> 'info threads' and look for threads not stopped in
>>>>      'sched_switch'
>>>>       >>>>>>>>> and get their backtraces?  You could also just do
>> 'thread
>>>>      apply
>>>>       >>>>>>>>> all bt' and put that file at a URL if that is easiest.
>>>>       >>>>>>>>>
>>>>       >>>>>>>> sure thing John - here's a gist of "thread apply all bt"
>>>>       >>>>>>>>
>>>>       >>>>>>>>
>>>>      https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>      <https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>
>>>>       >>>>>>> That doesn't look right at all.  Are you sure the kernel
>>>>      matches the
>>>>       >>>>>>> vmcore?  Also, which kgdb version are you using?
>>>>       >>>>>>>
>>>>       >>>>>> yea i agree that doesn't look right at all.  here is my
>> setup:
>>>>       >>>>>>
>>>>       >>>>>> $ which kgdb
>>>>       >>>>>> /usr/bin/kgdb
>>>>       >>>>>> $ kgdb
>>>>       >>>>>> GNU gdb 6.1.1 [FreeBSD]
>>>>       >>>>>> $ ls -lh /var/crash/vmcore.1
>>>>       >>>>>> -rw-------  1 root  wheel   1.6G Jul  3 15:03
>>>>      /var/crash/vmcore.1
>>>>       >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>>>       >>>>>> -r-xr-xr-x  1 root  wheel  87840496 Jul  3 13:54
>>>>       >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>>       >>>>>>
>>>>       >>>>>> and i invoke kgdb like so:
>>>>       >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
>>>>      /var/crash/vmcore.1
>>>>       >>>>>>
>>>>       >>>>>> here's a gist of my full gdb session:
>>>>       >>>>>> http://termbin.com/krsn
>>>>       >>>>>>
>>>>       >>>>>> dunno - maybe i have a bad core dump?  regardless, more
>> than
>>>>      happy to
>>>>       >>>>>> help so let me know if i should try anything else or
>> patches
>>>>      etc..
>>>>       >>>>> Can you try installing gdb from ports and using
>>>>      /usr/local/bin/kgdb?
>>>>       >>>>>
>>>>       >>>>
>>>>       >>>> that seems to have done the trick, at least the output looks
>> more
>>>>       >>>> encouraging.
>>>>       >>>>
>>>>       >>>>   --- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>>>>       >>>> KDB: enter: panic
>>>>       >>>>
>>>>       >>>> __curthread () at ./machine/pcpu.h:231
>>>>       >>>> 231        __asm("movq %%gs:%1,%0" : "=r" (td)
>>>>       >>>>
>>>>       >>>>
>>>>       >>>> here's my full kgdb session:
>>>>       >>>> http://termbin.com/qa4f
>>>>       >>>>
>>>>       >>>> i don't see any threads not in "sched_switch" though :(
>>>>       >>>
>>>>       >>> Hi,
>>>>       >>>
>>>>       >>> The problem may be that the patch to enable atomic inlining
>> of all
>>>>       >>> macros forgot to set the SMP keyword which means SMP is not
>>>>      defined at
>>>>       >>> all for KLD's so all non-kernel atomic usage is with MPLOCKED
>>>>      empty!
>>>>       > Problem is that out-of-tree modules build does not have opt*.h
>> files
>>>>       > from the kernel.  UP config is a valid one, flipping some
>> option's
>>>>       > default value does not solve the problem.
>>>>
>>>>      Yes, but using the lock prefix in a generic module is ok (it will
>> still
>>>>      work, just not quite as fast) whereas the lack of lock is fatal on
>>>>      SMP.  I would amend Hans' patch slightly to honor the opt_* setting
>>>>      for KLD_TIED (but that is only true if KLD_TIED means "built as
>> part of
>>>>      a kernel build, so has valid opt_foo.h headers" and not
>>>>      'a standalone module where someone put MODULES_TIED=1 on the
>> command
>>>>      line
>>>>      to make').
>>>>
>>>>
>>>> I agree with this default. It's sensible to default to (a) the most
>>>> popular thing and (b) thing that always works, especially when (a) and
>>>> (b) are identical.
>>>>
>>>> Don't make me start the "Do we really need an SMP option, why not make
>>>> it always on" thread :) The number of relevant uniprocessor x86 boxes
>>>> that benefit from omitting SMP is so small as to be irrelevant, IMHO.
>> A
>>>> MP kernel runs just fine on them...
>>>>
>>>> Warner
>>>
>>> Where are we on this?
>>> It is important to get it fixed, it's already been 4 days, which means 4
>>> days of all modern FreeBSD desktop systems being broken, and possibly
>>> other systems with kernel modules from ports as well.
>>>
>>>
>>> Another question, how hard would it be to expose how the kernel was
>>> built to modules built from ports, so that they can figure out stuff
>>> like SMP and others, that might affect the module build?
>> Point the KERNBUILDDIR variable to the directory of the kernel build.
>> This is the directory where *.o and opt*.h are located.  Then everything
>> would just work.
>>
> 
> Is the solution that we require everyone to build a kernel before they can
> build the standalone modules or am I missing something here?
> 

Hi,

Here is a temporary fix:
https://svnweb.freebsd.org/changeset/base/336025

Like Konstantin says this issue needs to be revisited.

--HPS

From tech-lists at zyxst.net  Fri Jul  6 13:26:23 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Fri, 6 Jul 2018 14:26:19 +0100
Subject: em0 link fail
In-Reply-To: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
Message-ID: <10e5354f-44e1-ba6f-4f50-552b2cec5680@zyxst.net>

On 03/07/2018 18:47, Michael Butler wrote:
> On June 1st, I was able to do my monthly laptop ZFS snap-shot/back-up
> (using "zfs snapshot -r zroot at backup; zfs send -R >nfs-filesys"). Now I
> can't without the em0 interface stalling :-(
> 
> On a guess, I tried reverting SVN r335303 but that didn't help.
> 
> em0: <Intel(R) PRO/1000 Network Connection> port 0xf080-0xf09f mem
> 0xf7e00000-0xf7e1ffff,0xf7e39000-0xf7e39fff irq 20 at device 25.0 on pci0
> em0: attach_pre capping queues at 1
> em0: using 1024 tx descriptors and 1024 rx descriptors
> em0: msix_init qsets capped at 1
> em0: PCIY_MSIX capability not found; or rid 0 == 0.
> em0: Using an MSI interrupt
> em0: allocated for 1 tx_queues
> em0: allocated for 1 rx_queues
> em0: Ethernet address: f0:1f:af:66:95:7e
> em0: netmap queues/slots: TX 1/1024, RX 1/1024
> em0: link state changed to UP
> 
>   [ initiate "zfs send" ]
> 
> em0: TX(0) desc avail = 41, pidx = 172
> em0: link state changed to DOWN
> em0: TX(0) desc avail = 1024, pidx = 0
> em0: TX(0) desc avail = 1024, pidx = 0
> 
>   .. ad nauseum ..
> 
> "ifconfig em0 down; ifconfig em0 up" doesn't help.
> 
> Any hints?

Hi,

I'm not seeing any problems using em0/saturating upstream
using 12.0-CURRENT #0 r335979
-- 
J.

From tech-lists at zyxst.net  Fri Jul  6 17:25:40 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Fri, 6 Jul 2018 18:25:37 +0100
Subject: bhyve and freebsd memstick installer
Message-ID: <7fdf88da-7692-8cfa-a42b-19314866977d@zyxst.net>

Hello,

context: freebsd-12-current server, amd64

I usually install a freebsd guest like this:

sh /usr/share/examples/bhyve/vmrun.sh -c 2 -m 4096M -t tap0 -d guest.img 
-i -I FreeBSD-installation-dvd1.iso guestname

I only have memstick.img - how do I either:

1. convert the memstick to dvd1.iso
2. make bhyve use the memstick installation iso (I don't think it can do 
this as the option to do so isn't in vmrun.sh)

thanks,
-- 
J.

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Fri Jul  6 17:32:45 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Fri, 6 Jul 2018 10:32:42 -0700 (PDT)
Subject: bhyve and freebsd memstick installer
In-Reply-To: <7fdf88da-7692-8cfa-a42b-19314866977d@zyxst.net>
Message-ID: <201807061732.w66HWgJF053394@pdx.rh.CN85.dnsmgr.net>

> Hello,
> 
> context: freebsd-12-current server, amd64
> 
> I usually install a freebsd guest like this:
> 
> sh /usr/share/examples/bhyve/vmrun.sh -c 2 -m 4096M -t tap0 -d guest.img 
> -i -I FreeBSD-installation-dvd1.iso guestname
> 
> I only have memstick.img - how do I either:
> 
> 1. convert the memstick to dvd1.iso
> 2. make bhyve use the memstick installation iso (I don't think it can do 
> this as the option to do so isn't in vmrun.sh)

Untested, but since memstick is actually a "disk" image and not
a "cdrom" image you should be able to do something like
vmrun.sh -c 2 -m 4096M -t tap0 -d memstick.img -d guest.img guestname

Your memstick should show up as ada0,
and your guest.img should be ada1.


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From tech-lists at zyxst.net  Fri Jul  6 20:37:37 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Fri, 6 Jul 2018 21:37:34 +0100
Subject: bhyve and freebsd memstick installer
In-Reply-To: <201807061732.w66HWgJF053394@pdx.rh.CN85.dnsmgr.net>
References: <201807061732.w66HWgJF053394@pdx.rh.CN85.dnsmgr.net>
Message-ID: <7cffa475-4d43-987c-f380-2384f4834ce1@zyxst.net>

On 06/07/2018 18:32, Rodney W. Grimes wrote:
> Untested, but since memstick is actually a "disk" image and not
> a "cdrom" image you should be able to do something like
> vmrun.sh -c 2 -m 4096M -t tap0 -d memstick.img -d guest.img guestname
> 
> Your memstick should show up as ada0,
> and your guest.img should be ada1.

Thanks for that, I'll try it next time I can.

I got round it temporarily by mounting the memstick as /dev/md1p3 and 
pointing mkisofs at that.

the -i -I thing of bhyve threw me. I thought I'd need it to point to 
bootable media.

-- 
J.

From pete at nomadlogic.org  Fri Jul  6 23:22:41 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Fri, 6 Jul 2018 16:22:34 -0700
Subject: AWS M5 ena issues
Message-ID: <ced35751-2e2b-defd-592b-46fb8993028b@nomadlogic.org>

hi there - this is in relation to this ticket:
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=225791

"ena driver causing kernel panics on AWS EC2"

reading through the thread, and Colin's blog post on the new M5 instance 
types, it looks like the issues people are running into are related to 
NVMe devices fronting EBS block stores. My question is is this a 
discreet issue from other anomalies people have seen with ena network 
devices.? For example, on some currently lightly loaded m5.large 
instances I have been seeing this in the logs pretty regularly:

ena0: device is going DOWN
ena0: device is going UP
ena0: queue 0 - cpu 0
ena0: queue 1 - cpu 1

These systems were previously running 11.1-RELEASE, which I upgraded to 
11.2-RELEASE via "freebsd-update".? These messages only started showing 
up after I had completed the upgrade.2


from reading the bug report above though it's not clear as to the state 
of the ena drivers themselves.? Are they considered unstable on 
11.2-RELEASE?

Cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From pete at nomadlogic.org  Fri Jul  6 23:25:22 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Fri, 6 Jul 2018 16:25:15 -0700
Subject: AWS M5 ena issues [IGNORE]
In-Reply-To: <ced35751-2e2b-defd-592b-46fb8993028b@nomadlogic.org>
References: <ced35751-2e2b-defd-592b-46fb8993028b@nomadlogic.org>
Message-ID: <3cf5f980-fb7b-efc7-e3ea-33a2646dc140@nomadlogic.org>

sorry - this was sent to incorrect list - please ignore.? sorry for the 
noise!

-pete

On 07/06/2018 16:22, Pete Wright wrote:
> hi there - this is in relation to this ticket:
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=225791
>
> "ena driver causing kernel panics on AWS EC2"
>
> reading through the thread, and Colin's blog post on the new M5 
> instance types, it looks like the issues people are running into are 
> related to NVMe devices fronting EBS block stores. My question is is 
> this a discreet issue from other anomalies people have seen with ena 
> network devices.? For example, on some currently lightly loaded 
> m5.large instances I have been seeing this in the logs pretty regularly:
>
> ena0: device is going DOWN
> ena0: device is going UP
> ena0: queue 0 - cpu 0
> ena0: queue 1 - cpu 1
>
> These systems were previously running 11.1-RELEASE, which I upgraded 
> to 11.2-RELEASE via "freebsd-update".? These messages only started 
> showing up after I had completed the upgrade.2
>
>
> from reading the bug report above though it's not clear as to the 
> state of the ena drivers themselves.? Are they considered unstable on 
> 11.2-RELEASE?
>
> Cheers,
> -pete
>

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From tech-lists at zyxst.net  Sat Jul  7 22:22:44 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Sat, 7 Jul 2018 23:22:38 +0100
Subject: aarch64-none-elf-gcc and related programs will not install
Message-ID: <2c2b0c64-0518-69b9-deba-da14aa7f110b@zyxst.net>

Hi,

context: 12.0-CURRENT #0 r336037 amd64 / ports r474140

I get the following when installing aarch64-none-elf-gcc and related 
programs from ports. It will build fine, just errors on install.

my /etc/make.conf looks like this:

 > less /etc/make.conf
WRKDIRPREFIX=/buildports
MAKE_JOBS_NUMBER=36
WITH_CCACHE_BUILD=YES
CCACHE_DIR=/ccache
WITH_MANCOMPRESS=YES
WITHOUT_DEBUG=YES
OPTIONS_SET+=OPTIMIZED_CFLAGS
OPTIONS_SET+=ICONV
CPUTYPE?=sandybridge

It doesn't matter if /etc/make.conf is moved out of the way.

these also fail in a similar way:
devel/arm-none-eabi-gcc
sysutils/u-boot-rpi2
sysutils/u-boot-rpi3

output when trying to install:

root at REDACTED:/usr/ports/devel/aarch64-none-elf-gcc # make distclean && 
make clean && make
===>  Cleaning for aarch64-none-elf-gcc-6.4.0
===>  Deleting distfiles for aarch64-none-elf-gcc-6.4.0
===>  Cleaning for aarch64-none-elf-gcc-6.4.0
===>  License GPLv3 GPLv3RLE accepted by the user
===>   aarch64-none-elf-gcc-6.4.0 depends on file: /usr/local/sbin/pkg - 
found
=> gcc-6.4.0.tar.xz doesn't seem to exist in /usr/ports/distfiles/.
=> Attempting to fetch 
https://mirrors.kernel.org/sourceware/gcc/releases/gcc-6.4.0/gcc-6.4.0.tar.xz

[...]

/bin/sh 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/gcc-6.4.0/libgcc/../mkinstalldirs 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include
install  -m 0644 unwind.h 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include
gmake[4]: Leaving directory 
'/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/.build/aarch64-none-elf/ilp32/libgcc'
gmake[3]: Leaving directory 
'/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/.build/aarch64-none-elf/libgcc'
gmake[2]: Leaving directory 
'/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/.build/aarch64-none-elf/libgcc'
gmake[1]: Leaving directory 
'/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/.build'
====> Compressing man pages (compress-man)
root at REDACTED:/usr/ports/devel/aarch64-none-elf-gcc #

root at REDACTED:/usr/ports/devel/aarch64-none-elf-gcc # make deinstall 
reinstall
===>  Deinstalling for aarch64-none-elf-gcc
===>   aarch64-none-elf-gcc not installed, skipping
===>  Installing for aarch64-none-elf-gcc-6.4.0
===>   Registering installation for aarch64-none-elf-gcc-6.4.0
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_fil.h:No 
such file or directory
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_lookup.h:No 
such file or directory
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_nat.h:No 
such file or directory
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_proxy.h:No 
such file or directory
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_scan.h:No 
such file or directory
pkg-static: Unable to access file 
/buildports/usr/ports/devel/aarch64-none-elf-gcc/work/stage/usr/local/lib/gcc/aarch64-none-elf/6.4.0/include-fixed/netinet/ip_state.h:No 
such file or directory
*** Error code 74

Stop.
make[1]: stopped in /usr/ports/devel/aarch64-none-elf-gcc
*** Error code 1

Stop.
make: stopped in /usr/ports/devel/aarch64-none-elf-gcc
root at REDACTED:/usr/ports/devel/aarch64-none-elf-gcc #

How can I fix?

thanks,
-- 
J.

From pete at nomadlogic.org  Sun Jul  8 02:55:08 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Sat, 7 Jul 2018 19:54:59 -0700
Subject: atomic changes break drm-next-kmod?
In-Reply-To: <1cd8c3c6-5d85-fbf3-cc06-1df8282216a1@selasky.org>
References: <4c5411dd-9f6b-7245-6ade-e11040f74687@FreeBSD.org>
 <24f5d737-a205-6fcc-0a33-a84601d2ff7a@nomadlogic.org>
 <c459a76c-21a2-2510-54b1-d7edee6eaa1e@FreeBSD.org>
 <eb84c2ed-1cd8-794f-9d5e-9454edeba4e4@nomadlogic.org>
 <29ce4eab-6667-d2ca-b5d8-3deeef28f142@selasky.org>
 <df73594c-785a-663d-6c76-bf95466a7aa3@selasky.org>
 <20180705193646.GM5562@kib.kiev.ua>
 <5dc2a315-4b71-9ff0-0a37-576649e9144b@FreeBSD.org>
 <CANCZdfqGyANQ5uUz_Ebc3i5HDLvkWocDs=J2p5xuj=1OttGWYQ@mail.gmail.com>
 <4797c607-c261-77f7-eccf-45056bf56694@daemonic.se>
 <20180706084729.GN5562@kib.kiev.ua>
 <CAECmPwtBJEp_4fFLr1KZhKu2ZJfSGANBD21C0OXUZ=-qfomNBQ@mail.gmail.com>
 <1cd8c3c6-5d85-fbf3-cc06-1df8282216a1@selasky.org>
Message-ID: <e852dc68-f3d5-cca8-fb40-20d6af5f4798@nomadlogic.org>



On 07/06/2018 03:15, Hans Petter Selasky wrote:
> On 07/06/18 11:14, Johannes Lundberg wrote:
>> On Fri, Jul 6, 2018 at 9:49 AM Konstantin Belousov <kostikbel at gmail.com>
>> wrote:
>>
>>> On Fri, Jul 06, 2018 at 09:52:24AM +0200, Niclas Zeising wrote:
>>>> On 07/06/18 00:02, Warner Losh wrote:
>>>>>
>>>>>
>>>>> On Thu, Jul 5, 2018 at 1:44 PM, John Baldwin <jhb at freebsd.org
>>>>> <mailto:jhb at freebsd.org>> wrote:
>>>>>
>>>>> ???? On 7/5/18 12:36 PM, Konstantin Belousov wrote:
>>>>> ????? > On Thu, Jul 05, 2018 at 09:12:24PM +0200, Hans Petter Selasky
>>> wrote:
>>>>> ????? >> On 07/05/18 20:59, Hans Petter Selasky wrote:
>>>>> ????? >>> On 07/05/18 19:48, Pete Wright wrote:
>>>>> ????? >>>>
>>>>> ????? >>>>
>>>>> ????? >>>> On 07/05/2018 10:10, John Baldwin wrote:
>>>>> ????? >>>>> On 7/3/18 5:10 PM, Pete Wright wrote:
>>>>> ????? >>>>>>
>>>>> ????? >>>>>> On 07/03/2018 15:56, John Baldwin wrote:
>>>>> ????? >>>>>>> On 7/3/18 3:34 PM, Pete Wright wrote:
>>>>> ????? >>>>>>>> On 07/03/2018 15:29, John Baldwin wrote:
>>>>> ????? >>>>>>>>> That seems like kgdb is looking at the wrong CPU.? 
>>>>> Can
>>>>> ???? you use
>>>>> ????? >>>>>>>>> 'info threads' and look for threads not stopped in
>>>>> ???? 'sched_switch'
>>>>> ????? >>>>>>>>> and get their backtraces?? You could also just do
>>> 'thread
>>>>> ???? apply
>>>>> ????? >>>>>>>>> all bt' and put that file at a URL if that is 
>>>>> easiest.
>>>>> ????? >>>>>>>>>
>>>>> ????? >>>>>>>> sure thing John - here's a gist of "thread apply 
>>>>> all bt"
>>>>> ????? >>>>>>>>
>>>>> ????? >>>>>>>>
>>>>> https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>> <https://gist.github.com/gem-pete/d8d7ab220dc8781f0827f965f09d43ed
>>>>
>>>>> ????? >>>>>>> That doesn't look right at all.? Are you sure the 
>>>>> kernel
>>>>> ???? matches the
>>>>> ????? >>>>>>> vmcore?? Also, which kgdb version are you using?
>>>>> ????? >>>>>>>
>>>>> ????? >>>>>> yea i agree that doesn't look right at all.? here is my
>>> setup:
>>>>> ????? >>>>>>
>>>>> ????? >>>>>> $ which kgdb
>>>>> ????? >>>>>> /usr/bin/kgdb
>>>>> ????? >>>>>> $ kgdb
>>>>> ????? >>>>>> GNU gdb 6.1.1 [FreeBSD]
>>>>> ????? >>>>>> $ ls -lh /var/crash/vmcore.1
>>>>> ????? >>>>>> -rw-------? 1 root? wheel 1.6G Jul? 3 15:03
>>>>> ???? /var/crash/vmcore.1
>>>>> ????? >>>>>> $ ls -l /usr/lib/debug/boot/kernel/kernel.debug
>>>>> ????? >>>>>> -r-xr-xr-x? 1 root? wheel 87840496 Jul? 3 13:54
>>>>> ????? >>>>>> /usr/lib/debug/boot/kernel/kernel.debug
>>>>> ????? >>>>>>
>>>>> ????? >>>>>> and i invoke kgdb like so:
>>>>> ????? >>>>>> $ sudo kgdb /usr/lib/debug/boot/kernel/kernel.debug
>>>>> ???? /var/crash/vmcore.1
>>>>> ????? >>>>>>
>>>>> ????? >>>>>> here's a gist of my full gdb session:
>>>>> ????? >>>>>> http://termbin.com/krsn
>>>>> ????? >>>>>>
>>>>> ????? >>>>>> dunno - maybe i have a bad core dump?? regardless, more
>>> than
>>>>> ???? happy to
>>>>> ????? >>>>>> help so let me know if i should try anything else or
>>> patches
>>>>> ???? etc..
>>>>> ????? >>>>> Can you try installing gdb from ports and using
>>>>> ???? /usr/local/bin/kgdb?
>>>>> ????? >>>>>
>>>>> ????? >>>>
>>>>> ????? >>>> that seems to have done the trick, at least the output 
>>>>> looks
>>> more
>>>>> ????? >>>> encouraging.
>>>>> ????? >>>>
>>>>> ????? >>>>?? --- trap 0, rip = 0, rsp = 0, rbp = 0 ---
>>>>> ????? >>>> KDB: enter: panic
>>>>> ????? >>>>
>>>>> ????? >>>> __curthread () at ./machine/pcpu.h:231
>>>>> ????? >>>> 231??????? __asm("movq %%gs:%1,%0" : "=r" (td)
>>>>> ????? >>>>
>>>>> ????? >>>>
>>>>> ????? >>>> here's my full kgdb session:
>>>>> ????? >>>> http://termbin.com/qa4f
>>>>> ????? >>>>
>>>>> ????? >>>> i don't see any threads not in "sched_switch" though :(
>>>>> ????? >>>
>>>>> ????? >>> Hi,
>>>>> ????? >>>
>>>>> ????? >>> The problem may be that the patch to enable atomic inlining
>>> of all
>>>>> ????? >>> macros forgot to set the SMP keyword which means SMP is not
>>>>> ???? defined at
>>>>> ????? >>> all for KLD's so all non-kernel atomic usage is with 
>>>>> MPLOCKED
>>>>> ???? empty!
>>>>> ????? > Problem is that out-of-tree modules build does not have 
>>>>> opt*.h
>>> files
>>>>> ????? > from the kernel.? UP config is a valid one, flipping some
>>> option's
>>>>> ????? > default value does not solve the problem.
>>>>>
>>>>> ???? Yes, but using the lock prefix in a generic module is ok (it 
>>>>> will
>>> still
>>>>> ???? work, just not quite as fast) whereas the lack of lock is 
>>>>> fatal on
>>>>> ???? SMP.? I would amend Hans' patch slightly to honor the opt_* 
>>>>> setting
>>>>> ???? for KLD_TIED (but that is only true if KLD_TIED means "built as
>>> part of
>>>>> ???? a kernel build, so has valid opt_foo.h headers" and not
>>>>> ???? 'a standalone module where someone put MODULES_TIED=1 on the
>>> command
>>>>> ???? line
>>>>> ???? to make').
>>>>>
>>>>>
>>>>> I agree with this default. It's sensible to default to (a) the most
>>>>> popular thing and (b) thing that always works, especially when (a) 
>>>>> and
>>>>> (b) are identical.
>>>>>
>>>>> Don't make me start the "Do we really need an SMP option, why not 
>>>>> make
>>>>> it always on" thread :) The number of relevant uniprocessor x86 boxes
>>>>> that benefit from omitting SMP is so small as to be irrelevant, IMHO.
>>> A
>>>>> MP kernel runs just fine on them...
>>>>>
>>>>> Warner
>>>>
>>>> Where are we on this?
>>>> It is important to get it fixed, it's already been 4 days, which 
>>>> means 4
>>>> days of all modern FreeBSD desktop systems being broken, and possibly
>>>> other systems with kernel modules from ports as well.
>>>>
>>>>
>>>> Another question, how hard would it be to expose how the kernel was
>>>> built to modules built from ports, so that they can figure out stuff
>>>> like SMP and others, that might affect the module build?
>>> Point the KERNBUILDDIR variable to the directory of the kernel build.
>>> This is the directory where *.o and opt*.h are located.? Then 
>>> everything
>>> would just work.
>>>
>>
>> Is the solution that we require everyone to build a kernel before 
>> they can
>> build the standalone modules or am I missing something here?
>>
>
> Hi,
>
> Here is a temporary fix:
> https://svnweb.freebsd.org/changeset/base/336025
>
> Like Konstantin says this issue needs to be revisited.
>

this patch has been stable for me for a couple days now after rebuilding 
drm-next under the new kernel containing this update.? we may want to 
kick-off an update of the drm-next pkg if that hasn't happened already.? 
the old package caused periodic kernel-panics on my end.

cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From oliver.pinter at hardenedbsd.org  Sun Jul  8 19:08:10 2018
From: oliver.pinter at hardenedbsd.org (Oliver Pinter)
Date: Sun, 8 Jul 2018 21:08:08 +0200
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <CANCZdfp-bYi2fFJi5ashPLwjnwKWeoepiPt23LfPORU1EpKNGg@mail.gmail.com>
 <CABHD1wQU_6wHw96+LguVuqmwqY04+n7NPcy6rSgn4QdKZpF3Kg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
Message-ID: <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>

Hi!

Have you or Warner any update on this code?

On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net> wrote:

> I'm in the middle of moving to a new apartment right now.  It's going to
> be a bit before I can get to this.
>
> On 04/11/2018 20:31, Warner Losh wrote:
> > OK. I've pushed in the main part of it. The additional work I have
> > shouldn't affect any of this stuff.  I was going to look at what part(s)
> > of your open reviewed needed to be redone tomorrow and send you
> > feedback, but if you wanted to get a start before then, I'm happy to
> > answer questions. All the rest of my work is going to be selecting the
> > root partition when we're told to us a specific partition, so will be
> > very constrained.
> >
> > Warner
> >
> > On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.net
> > <mailto:eric at metricspace.net>> wrote:
> >
> >     I think the thing to do at this point is to wait for the current
> work on
> >     loader.efi to land, then adapt my patches to apply against that work.
> >
> >     On 04/11/2018 15:06, Warner Losh wrote:
> >     > Still reviewing the code. I'm worried it's too i386 specific and it
> >     > conflicts with some work I'm doing. I'll have a list of actionable
> >     > critiques this week.
> >     >
> >     > Warner
> >     >
> >     > On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
> >     > <oliver.pinter at hardenedbsd.org
> >     <mailto:oliver.pinter at hardenedbsd.org>
> >     <mailto:oliver.pinter at hardenedbsd.org
> >     <mailto:oliver.pinter at hardenedbsd.org>>>
> >     > wrote:
> >     >
> >     >     Hi!
> >     >
> >     >     Is there any update regarding the rebase or the inclusion to
> base
> >     >     system?
> >     >     On 3/28/18, Eric McCorkle <eric at metricspace.net <mailto:
> eric at metricspace.net>
> >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.net>>>
> wrote:
> >     >     > I'll do another rebase from head just to be sure
> >     >     >
> >     >     > On March 28, 2018 3:23:23 PM EDT, Warner Losh <
> imp at bsdimp.com <mailto:imp at bsdimp.com>
> >     >     <mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
> >     >     >>It's on my list for nexr, finally. I have an alternate patch
> for
> >     >     >>loader.efi
> >     >     >>from ESP, but i don't think it will affect the GELI stuff. I
> have some
> >     >     >>time
> >     >     >>slotted for integration issues though.
> >     >     >>
> >     >     >>I am quite mindful of the freeze dates.... I  have some uefi
> boot
> >     >     >>loader
> >     >     >>protocol changes that I need to get in.
> >     >     >>
> >     >     >>Warner
> >     >     >>
> >     >     >>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
> tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
> >     >     <mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>>>
> wrote:
> >     >     >>
> >     >     >>> Awesome, thanks for the update and the work that you have
> done!
> >     >     >>>
> >     >     >>> Now we just need some more reviewers eyes on the code :)
> >     >     >>>
> >     >     >>> Br,
> >     >     >>>
> >     >     >>> Tommi
> >     >     >>>
> >     >     >>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
> eric at metricspace.net <mailto:eric at metricspace.net>
> >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.net>>>
> >     >     >>wrote:
> >     >     >>>
> >     >     >>>> FYI, I just IFC'ed everything, and the current patches
> >     are still
> >     >     >>fine.
> >     >     >>>>
> >     >     >>>> Also, the full GELI + standalone loader has been deployed
> >     on one of
> >     >     >>my
> >     >     >>>> laptops for some time now.
> >     >     >>>>
> >     >     >>>> On 02/21/2018 18:15, Eric McCorkle wrote:
> >     >     >>>> > The GELI work could be merged at this point, though it
> >     won't be
> >     >     >>usable
> >     >     >>>> > without an additional patch to enable loader-only
> >     operation.  The
> >     >     >>>> > patches are currently up for review:
> >     >     >>>> >
> >     >     >>>> > This is the order in which they'd need to be merged:
> >     >     >>>> >
> >     >     >>>> >
> >     >     >>>> > https://reviews.freebsd.org/D12732
> >     <https://reviews.freebsd.org/D12732>
> >     >     <https://reviews.freebsd.org/D12732
> >     <https://reviews.freebsd.org/D12732>>
> >     >     >>>> >
> >     >     >>>> > This one changes the efipart device.  Toomas Soome
> >     identified
> >     >     some
> >     >     >>>> > problems, which I have addressed.  He has not
> >     re-reviewed it,
> >     >     >>however.
> >     >     >>>> >
> >     >     >>>> >
> >     >     >>>> > https://reviews.freebsd.org/D12692
> >     <https://reviews.freebsd.org/D12692>
> >     >     <https://reviews.freebsd.org/D12692
> >     <https://reviews.freebsd.org/D12692>>
> >     >     >>>> >
> >     >     >>>> > This adds some crypto code needed for GELI.  It simply
> >     adds new
> >     >     >>code,
> >     >     >>>> > and doesn't conflict with anything.
> >     >     >>>> >
> >     >     >>>> >
> >     >     >>>> > https://reviews.freebsd.org/D12698
> >     <https://reviews.freebsd.org/D12698>
> >     >     <https://reviews.freebsd.org/D12698
> >     <https://reviews.freebsd.org/D12698>>
> >     >     >>>> >
> >     >     >>>> > This adds the EFI KMS interface code, and has the EFI
> >     loader pass
> >     >     >>keys
> >     >     >>>> > into the keybuf interface.
> >     >     >>>> >
> >     >     >>>> >
> >     >     >>>> > I can't post the main GELI driver until those get
> >     merged, as it
> >     >     >>depends
> >     >     >>>> > on them.  It can be found on the geli branch on my
> >     github freebsd
> >     >     >>>> > repository, however.
> >     >     >>>> >
> >     >     >>>> >
> >     >     >>>> > Additionally, you need this patch, which allows
> >     loader.efi to
> >     >     >>function
> >     >     >>>> > when installed directly to the ESP:
> >     >     >>>> >
> >     >     >>>> > https://reviews.freebsd.org/D13497
> >     <https://reviews.freebsd.org/D13497>
> >     >     <https://reviews.freebsd.org/D13497
> >     <https://reviews.freebsd.org/D13497>>
> >     >     >>>> >
> >     >     >>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
> >     >     >>>> >> Hi Eric,
> >     >     >>>> >>
> >     >     >>>> >> could you provide a brief update how the work is going?
> >     >     >>>> >>
> >     >     >>>> >>
> >     >     >>>> >> Br,
> >     >     >>>> >>
> >     >     >>>> >> Tommi
> >     >     >>>> >>
> >     >     >>>> >>
> >     >     >>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
> >     <eric at metricspace.net <mailto:eric at metricspace.net>
> >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.net>>
> >     >     >>>> >> <mailto:eric at metricspace.net
> >     <mailto:eric at metricspace.net> <mailto:eric at metricspace.net
> >     <mailto:eric at metricspace.net>>>>
> >     >     wrote:
> >     >     >>>> >>
> >     >     >>>> >>     Right, so basically, the remaining GELI patches
> >     are against
> >     >     >>>> loader, and
> >     >     >>>> >>     most of them can go in independently of the work
> >     on removing
> >     >     >>boot1.
> >     >     >>>> >>     There's a unanimous consensus on getting rid of
> >     boot1 which
> >     >     >>>> includes its
> >     >     >>>> >>     original author, so that's going to happen.
> >     >     >>>> >>
> >     >     >>>> >>
> >     >     >>>> >>     For GELI, we have the following (not necessarily
> >     in order):
> >     >     >>>> >>
> >     >     >>>> >>     a) Adding the KMS interfaces, pseudo-device, and
> >     kernel
> >     >     >>keybuf
> >     >     >>>> >>     interactions
> >     >     >>>> >>     b) Modifications to the efipart driver
> >     >     >>>> >>     c) boot crypto
> >     >     >>>> >>     d) GELI partition types (not strictly necessary)
> >     >     >>>> >>
> >     >     >>>> >>     Then there's the GELI driver itself.  (a) and (c)
> are
> >     >     good to
> >     >     >>>> land, (b)
> >     >     >>>> >>     needs some more work after Toomas Soome pointed
> out a
> >     >     >>legitimate
> >     >     >>>> >>     problem, and (d) actually needs a good bit more
> >     code (but
> >     >     >>again,
> >     >     >>>> it's
> >     >     >>>> >>     more cosmetic).  Additionally, the GELI driver
> >     will need
> >     >     >>further
> >     >     >>>> mods to
> >     >     >>>> >>     efipart to be written (nothing too big).  But we
> >     could go
> >     >     >>ahead
> >     >     >>>> with (a)
> >     >     >>>> >>     and (c), as they've already been proven to work.
> >     >     >>>> >>
> >     >     >>>> >>     I'd wanted to have this stuff shaped up sooner,
> >     but I'm
> >     >     >>>> preoccupied with
> >     >     >>>> >>     the 7th RISC-V workshop at the end of the month.
> >     >     >>>> >>
> >     >     >>>> >>     Once this stuff is all in, loader should handle
> >     any GELI
> >     >     >>volumes it
> >     >     >>>> >>     finds, and it should Just Work once boot1 is gone.
> >     >     >>>> >>
> >     >     >>>> >>
> >     >     >>>> > _______________________________________________
> >     >     >>>> > freebsd-current at freebsd.org
> >     <mailto:freebsd-current at freebsd.org>
> >     >     <mailto:freebsd-current at freebsd.org
> >     <mailto:freebsd-current at freebsd.org>> mailing list
> >     >     >>>> > https://lists.freebsd.org/mailman/listinfo/freebsd-
> current
> >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> >     >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> >     >     >>>> > To unsubscribe, send any mail to
> "freebsd-current-unsubscribe@
> >     >     >>>> freebsd.org <http://freebsd.org> <http://freebsd.org>"
> >     >     >>>> >
> >     >     >>>>
> >     >     >>>
> >     >     >
> >     >     > --
> >     >     > Sent from my Android device with K-9 Mail. Please excuse my
> brevity.
> >     >     > _______________________________________________
> >     >     > freebsd-current at freebsd.org
> >     <mailto:freebsd-current at freebsd.org>
> >     <mailto:freebsd-current at freebsd.org
> >     <mailto:freebsd-current at freebsd.org>>
> >     >     mailing list
> >     >     > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> >     >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> >     >     > To unsubscribe, send any mail to
> >     >     "freebsd-current-unsubscribe at freebsd.org
> >     <mailto:freebsd-current-unsubscribe at freebsd.org>
> >     >     <mailto:freebsd-current-unsubscribe at freebsd.org
> >     <mailto:freebsd-current-unsubscribe at freebsd.org>>"
> >     >     >
> >     >
> >     >
> >
> >
>
>

From ian at freebsd.org  Sun Jul  8 19:31:54 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sun, 08 Jul 2018 13:31:47 -0600
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <CANCZdfp-bYi2fFJi5ashPLwjnwKWeoepiPt23LfPORU1EpKNGg@mail.gmail.com>
 <CABHD1wQU_6wHw96+LguVuqmwqY04+n7NPcy6rSgn4QdKZpF3Kg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
 <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
Message-ID: <1531078307.1336.22.camel@freebsd.org>

On Sun, 2018-07-08 at 21:08 +0200, Oliver Pinter wrote:
> Hi!
> 
> Have you or Warner any update on this code?
> 
> On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net>
> wrote:
> 

Are you aware of?https://reviews.freebsd.org/D15743??

That's my changes to add geli support to loader(8) in an architecture-
agnostic way, so that "it just works" for all platforms and flavors of
loader. It has been succesfully tested on armv6/7 (ubldr) and on x86
using qemu. ?The x86 tests cover ufs and zfs, legacy bios and uefi. The
only variations that aren't tested yet are the uefi flavors, because
the current rootgen.sh script for assembling test images is still using
boot1.efi and I don't know enough about efi myself to update the script
to make it assemble images the new way Warner envisions.

-- Ian

> > 
> > I'm in the middle of moving to a new apartment right now.??It's
> > going to
> > be a bit before I can get to this.
> > 
> > On 04/11/2018 20:31, Warner Losh wrote:
> > > 
> > > OK. I've pushed in the main part of it. The additional work I
> > > have
> > > shouldn't affect any of this stuff.??I was going to look at what
> > > part(s)
> > > of your open reviewed needed to be redone tomorrow and send you
> > > feedback, but if you wanted to get a start before then, I'm happy
> > > to
> > > answer questions. All the rest of my work is going to be
> > > selecting the
> > > root partition when we're told to us a specific partition, so
> > > will be
> > > very constrained.
> > > 
> > > Warner
> > > 
> > > On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.
> > > net
> > > <mailto:eric at metricspace.net>> wrote:
> > > 
> > > ????I think the thing to do at this point is to wait for the
> > > current
> > work on
> > > 
> > > ????loader.efi to land, then adapt my patches to apply against
> > > that work.
> > > 
> > > ????On 04/11/2018 15:06, Warner Losh wrote:
> > > ????> Still reviewing the code. I'm worried it's too i386
> > > specific and it
> > > ????> conflicts with some work I'm doing. I'll have a list of
> > > actionable
> > > ????> critiques this week.
> > > ????>
> > > ????> Warner
> > > ????>
> > > ????> On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
> > > ????> <oliver.pinter at hardenedbsd.org
> > > ????<mailto:oliver.pinter at hardenedbsd.org>
> > > ????<mailto:oliver.pinter at hardenedbsd.org
> > > ????<mailto:oliver.pinter at hardenedbsd.org>>>
> > > ????> wrote:
> > > ????>
> > > ????>?????Hi!
> > > ????>
> > > ????>?????Is there any update regarding the rebase or the
> > > inclusion to
> > base
> > > 
> > > ????>?????system?
> > > ????>?????On 3/28/18, Eric McCorkle <eric at metricspace.net
> > > <mailto:
> > eric at metricspace.net>
> > > 
> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > et>>>
> > wrote:
> > > 
> > > ????>?????> I'll do another rebase from head just to be sure
> > > ????>?????>
> > > ????>?????> On March 28, 2018 3:23:23 PM EDT, Warner Losh <
> > imp at bsdimp.com <mailto:imp at bsdimp.com>
> > > 
> > > ????>?????<mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
> > > ????>?????>>It's on my list for nexr, finally. I have an
> > > alternate patch
> > for
> > > 
> > > ????>?????>>loader.efi
> > > ????>?????>>from ESP, but i don't think it will affect the GELI
> > > stuff. I
> > have some
> > > 
> > > ????>?????>>time
> > > ????>?????>>slotted for integration issues though.
> > > ????>?????>>
> > > ????>?????>>I am quite mindful of the freeze dates.... I??have
> > > some uefi
> > boot
> > > 
> > > ????>?????>>loader
> > > ????>?????>>protocol changes that I need to get in.
> > > ????>?????>>
> > > ????>?????>>Warner
> > > ????>?????>>
> > > ????>?????>>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
> > tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
> > > 
> > > ????>?????<mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.
> > > fi>>>
> > wrote:
> > > 
> > > ????>?????>>
> > > ????>?????>>> Awesome, thanks for the update and the work that
> > > you have
> > done!
> > > 
> > > ????>?????>>>
> > > ????>?????>>> Now we just need some more reviewers eyes on the
> > > code :)
> > > ????>?????>>>
> > > ????>?????>>> Br,
> > > ????>?????>>>
> > > ????>?????>>> Tommi
> > > ????>?????>>>
> > > ????>?????>>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
> > eric at metricspace.net <mailto:eric at metricspace.net>
> > > 
> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > et>>>
> > > ????>?????>>wrote:
> > > ????>?????>>>
> > > ????>?????>>>> FYI, I just IFC'ed everything, and the current
> > > patches
> > > ????are still
> > > ????>?????>>fine.
> > > ????>?????>>>>
> > > ????>?????>>>> Also, the full GELI + standalone loader has been
> > > deployed
> > > ????on one of
> > > ????>?????>>my
> > > ????>?????>>>> laptops for some time now.
> > > ????>?????>>>>
> > > ????>?????>>>> On 02/21/2018 18:15, Eric McCorkle wrote:
> > > ????>?????>>>> > The GELI work could be merged at this point,
> > > though it
> > > ????won't be
> > > ????>?????>>usable
> > > ????>?????>>>> > without an additional patch to enable loader-
> > > only
> > > ????operation.??The
> > > ????>?????>>>> > patches are currently up for review:
> > > ????>?????>>>> >
> > > ????>?????>>>> > This is the order in which they'd need to be
> > > merged:
> > > ????>?????>>>> >
> > > ????>?????>>>> >
> > > ????>?????>>>> > https://reviews.freebsd.org/D12732
> > > ????<https://reviews.freebsd.org/D12732>
> > > ????>?????<https://reviews.freebsd.org/D12732
> > > ????<https://reviews.freebsd.org/D12732>>
> > > ????>?????>>>> >
> > > ????>?????>>>> > This one changes the efipart device.??Toomas
> > > Soome
> > > ????identified
> > > ????>?????some
> > > ????>?????>>>> > problems, which I have addressed.??He has not
> > > ????re-reviewed it,
> > > ????>?????>>however.
> > > ????>?????>>>> >
> > > ????>?????>>>> >
> > > ????>?????>>>> > https://reviews.freebsd.org/D12692
> > > ????<https://reviews.freebsd.org/D12692>
> > > ????>?????<https://reviews.freebsd.org/D12692
> > > ????<https://reviews.freebsd.org/D12692>>
> > > ????>?????>>>> >
> > > ????>?????>>>> > This adds some crypto code needed for GELI.??It
> > > simply
> > > ????adds new
> > > ????>?????>>code,
> > > ????>?????>>>> > and doesn't conflict with anything.
> > > ????>?????>>>> >
> > > ????>?????>>>> >
> > > ????>?????>>>> > https://reviews.freebsd.org/D12698
> > > ????<https://reviews.freebsd.org/D12698>
> > > ????>?????<https://reviews.freebsd.org/D12698
> > > ????<https://reviews.freebsd.org/D12698>>
> > > ????>?????>>>> >
> > > ????>?????>>>> > This adds the EFI KMS interface code, and has
> > > the EFI
> > > ????loader pass
> > > ????>?????>>keys
> > > ????>?????>>>> > into the keybuf interface.
> > > ????>?????>>>> >
> > > ????>?????>>>> >
> > > ????>?????>>>> > I can't post the main GELI driver until those
> > > get
> > > ????merged, as it
> > > ????>?????>>depends
> > > ????>?????>>>> > on them.??It can be found on the geli branch on
> > > my
> > > ????github freebsd
> > > ????>?????>>>> > repository, however.
> > > ????>?????>>>> >
> > > ????>?????>>>> >
> > > ????>?????>>>> > Additionally, you need this patch, which allows
> > > ????loader.efi to
> > > ????>?????>>function
> > > ????>?????>>>> > when installed directly to the ESP:
> > > ????>?????>>>> >
> > > ????>?????>>>> > https://reviews.freebsd.org/D13497
> > > ????<https://reviews.freebsd.org/D13497>
> > > ????>?????<https://reviews.freebsd.org/D13497
> > > ????<https://reviews.freebsd.org/D13497>>
> > > ????>?????>>>> >
> > > ????>?????>>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
> > > ????>?????>>>> >> Hi Eric,
> > > ????>?????>>>> >>
> > > ????>?????>>>> >> could you provide a brief update how the work
> > > is going?
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>
> > > ????>?????>>>> >> Br,
> > > ????>?????>>>> >>
> > > ????>?????>>>> >> Tommi
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>
> > > ????>?????>>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
> > > ????<eric at metricspace.net <mailto:eric at metricspace.net>
> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > et>>
> > > ????>?????>>>> >> <mailto:eric at metricspace.net
> > > ????<mailto:eric at metricspace.net> <mailto:eric at metricspace.net
> > > ????<mailto:eric at metricspace.net>>>>
> > > ????>?????wrote:
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????Right, so basically, the remaining GELI
> > > patches
> > > ????are against
> > > ????>?????>>>> loader, and
> > > ????>?????>>>> >>?????most of them can go in independently of the
> > > work
> > > ????on removing
> > > ????>?????>>boot1.
> > > ????>?????>>>> >>?????There's a unanimous consensus on getting
> > > rid of
> > > ????boot1 which
> > > ????>?????>>>> includes its
> > > ????>?????>>>> >>?????original author, so that's going to happen.
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????For GELI, we have the following (not
> > > necessarily
> > > ????in order):
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????a) Adding the KMS interfaces, pseudo-
> > > device, and
> > > ????kernel
> > > ????>?????>>keybuf
> > > ????>?????>>>> >>?????interactions
> > > ????>?????>>>> >>?????b) Modifications to the efipart driver
> > > ????>?????>>>> >>?????c) boot crypto
> > > ????>?????>>>> >>?????d) GELI partition types (not strictly
> > > necessary)
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????Then there's the GELI driver itself.??(a)
> > > and (c)
> > are
> > > 
> > > ????>?????good to
> > > ????>?????>>>> land, (b)
> > > ????>?????>>>> >>?????needs some more work after Toomas Soome
> > > pointed
> > out a
> > > 
> > > ????>?????>>legitimate
> > > ????>?????>>>> >>?????problem, and (d) actually needs a good bit
> > > more
> > > ????code (but
> > > ????>?????>>again,
> > > ????>?????>>>> it's
> > > ????>?????>>>> >>?????more cosmetic).??Additionally, the GELI
> > > driver
> > > ????will need
> > > ????>?????>>further
> > > ????>?????>>>> mods to
> > > ????>?????>>>> >>?????efipart to be written (nothing too
> > > big).??But we
> > > ????could go
> > > ????>?????>>ahead
> > > ????>?????>>>> with (a)
> > > ????>?????>>>> >>?????and (c), as they've already been proven to
> > > work.
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????I'd wanted to have this stuff shaped up
> > > sooner,
> > > ????but I'm
> > > ????>?????>>>> preoccupied with
> > > ????>?????>>>> >>?????the 7th RISC-V workshop at the end of the
> > > month.
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>?????Once this stuff is all in, loader should
> > > handle
> > > ????any GELI
> > > ????>?????>>volumes it
> > > ????>?????>>>> >>?????finds, and it should Just Work once boot1
> > > is gone.
> > > ????>?????>>>> >>
> > > ????>?????>>>> >>
> > > ????>?????>>>> > _______________________________________________
> > > ????>?????>>>> > freebsd-current at freebsd.org
> > > ????<mailto:freebsd-current at freebsd.org>
> > > ????>?????<mailto:freebsd-current at freebsd.org
> > > ????<mailto:freebsd-current at freebsd.org>> mailing list
> > > ????>?????>>>> > https://lists.freebsd.org/mailman/listinfo/freeb
> > > sd-
> > current
> > > 
> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> > > ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> > > rent
> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> > > ????>?????>>>> > To unsubscribe, send any mail to
> > "freebsd-current-unsubscribe@
> > > 
> > > ????>?????>>>> freebsd.org <http://freebsd.org>
> > > <http://freebsd.org>"
> > > ????>?????>>>> >
> > > ????>?????>>>>
> > > ????>?????>>>
> > > ????>?????>
> > > ????>?????> --
> > > ????>?????> Sent from my Android device with K-9 Mail. Please
> > > excuse my
> > brevity.
> > > 
> > > ????>?????> _______________________________________________
> > > ????>?????> freebsd-current at freebsd.org
> > > ????<mailto:freebsd-current at freebsd.org>
> > > ????<mailto:freebsd-current at freebsd.org
> > > ????<mailto:freebsd-current at freebsd.org>>
> > > ????>?????mailing list
> > > ????>?????> https://lists.freebsd.org/mailman/listinfo/freebsd-cu
> > > rrent
> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> > > ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> > > rent
> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> > > ????>?????> To unsubscribe, send any mail to
> > > ????>?????"freebsd-current-unsubscribe at freebsd.org
> > > ????<mailto:freebsd-current-unsubscribe at freebsd.org>
> > > ????>?????<mailto:freebsd-current-unsubscribe at freebsd.org
> > > ????<mailto:freebsd-current-unsubscribe at freebsd.org>>"
> > > ????>?????>
> > > ????>
> > > ????>
> > > 
> > > 
> > 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd
> .org"

From oliver.pinter at hardenedbsd.org  Sun Jul  8 19:38:45 2018
From: oliver.pinter at hardenedbsd.org (Oliver Pinter)
Date: Sun, 8 Jul 2018 21:38:43 +0200
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <1531078307.1336.22.camel@freebsd.org>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <CANCZdfp-bYi2fFJi5ashPLwjnwKWeoepiPt23LfPORU1EpKNGg@mail.gmail.com>
 <CABHD1wQU_6wHw96+LguVuqmwqY04+n7NPcy6rSgn4QdKZpF3Kg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
 <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
 <1531078307.1336.22.camel@freebsd.org>
Message-ID: <CAPQ4ffuDEbn=ZTh=Mj1RwE7+bheJCpjwY6qBimbxiBXAjUB3NA@mail.gmail.com>

On Sunday, July 8, 2018, Ian Lepore <ian at freebsd.org> wrote:

> On Sun, 2018-07-08 at 21:08 +0200, Oliver Pinter wrote:
> > Hi!
> >
> > Have you or Warner any update on this code?
> >
> > On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net>
> > wrote:
> >
>
> Are you aware of https://reviews.freebsd.org/D15743 ?
>
> That's my changes to add geli support to loader(8) in an architecture-
> agnostic way, so that "it just works" for all platforms and flavors of
> loader. It has been succesfully tested on armv6/7 (ubldr) and on x86
> using qemu.  The x86 tests cover ufs and zfs, legacy bios and uefi. The
> only variations that aren't tested yet are the uefi flavors, because
> the current rootgen.sh script for assembling test images is still using
> boot1.efi and I don't know enough about efi myself to update the script
> to make it assemble images the new way Warner envisions.
>
>
Not yet, but thanks for the link!


> -- Ian
>
> > >
> > > I'm in the middle of moving to a new apartment right now.  It's
> > > going to
> > > be a bit before I can get to this.
> > >
> > > On 04/11/2018 20:31, Warner Losh wrote:
> > > >
> > > > OK. I've pushed in the main part of it. The additional work I
> > > > have
> > > > shouldn't affect any of this stuff.  I was going to look at what
> > > > part(s)
> > > > of your open reviewed needed to be redone tomorrow and send you
> > > > feedback, but if you wanted to get a start before then, I'm happy
> > > > to
> > > > answer questions. All the rest of my work is going to be
> > > > selecting the
> > > > root partition when we're told to us a specific partition, so
> > > > will be
> > > > very constrained.
> > > >
> > > > Warner
> > > >
> > > > On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.
> > > > net
> > > > <mailto:eric at metricspace.net>> wrote:
> > > >
> > > >     I think the thing to do at this point is to wait for the
> > > > current
> > > work on
> > > >
> > > >     loader.efi to land, then adapt my patches to apply against
> > > > that work.
> > > >
> > > >     On 04/11/2018 15:06, Warner Losh wrote:
> > > >     > Still reviewing the code. I'm worried it's too i386
> > > > specific and it
> > > >     > conflicts with some work I'm doing. I'll have a list of
> > > > actionable
> > > >     > critiques this week.
> > > >     >
> > > >     > Warner
> > > >     >
> > > >     > On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
> > > >     > <oliver.pinter at hardenedbsd.org
> > > >     <mailto:oliver.pinter at hardenedbsd.org>
> > > >     <mailto:oliver.pinter at hardenedbsd.org
> > > >     <mailto:oliver.pinter at hardenedbsd.org>>>
> > > >     > wrote:
> > > >     >
> > > >     >     Hi!
> > > >     >
> > > >     >     Is there any update regarding the rebase or the
> > > > inclusion to
> > > base
> > > >
> > > >     >     system?
> > > >     >     On 3/28/18, Eric McCorkle <eric at metricspace.net
> > > > <mailto:
> > > eric at metricspace.net>
> > > >
> > > >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > > et>>>
> > > wrote:
> > > >
> > > >     >     > I'll do another rebase from head just to be sure
> > > >     >     >
> > > >     >     > On March 28, 2018 3:23:23 PM EDT, Warner Losh <
> > > imp at bsdimp.com <mailto:imp at bsdimp.com>
> > > >
> > > >     >     <mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
> > > >     >     >>It's on my list for nexr, finally. I have an
> > > > alternate patch
> > > for
> > > >
> > > >     >     >>loader.efi
> > > >     >     >>from ESP, but i don't think it will affect the GELI
> > > > stuff. I
> > > have some
> > > >
> > > >     >     >>time
> > > >     >     >>slotted for integration issues though.
> > > >     >     >>
> > > >     >     >>I am quite mindful of the freeze dates.... I  have
> > > > some uefi
> > > boot
> > > >
> > > >     >     >>loader
> > > >     >     >>protocol changes that I need to get in.
> > > >     >     >>
> > > >     >     >>Warner
> > > >     >     >>
> > > >     >     >>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
> > > tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
> > > >
> > > >     >     <mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.
> > > > fi>>>
> > > wrote:
> > > >
> > > >     >     >>
> > > >     >     >>> Awesome, thanks for the update and the work that
> > > > you have
> > > done!
> > > >
> > > >     >     >>>
> > > >     >     >>> Now we just need some more reviewers eyes on the
> > > > code :)
> > > >     >     >>>
> > > >     >     >>> Br,
> > > >     >     >>>
> > > >     >     >>> Tommi
> > > >     >     >>>
> > > >     >     >>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
> > > eric at metricspace.net <mailto:eric at metricspace.net>
> > > >
> > > >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > > et>>>
> > > >     >     >>wrote:
> > > >     >     >>>
> > > >     >     >>>> FYI, I just IFC'ed everything, and the current
> > > > patches
> > > >     are still
> > > >     >     >>fine.
> > > >     >     >>>>
> > > >     >     >>>> Also, the full GELI + standalone loader has been
> > > > deployed
> > > >     on one of
> > > >     >     >>my
> > > >     >     >>>> laptops for some time now.
> > > >     >     >>>>
> > > >     >     >>>> On 02/21/2018 18:15, Eric McCorkle wrote:
> > > >     >     >>>> > The GELI work could be merged at this point,
> > > > though it
> > > >     won't be
> > > >     >     >>usable
> > > >     >     >>>> > without an additional patch to enable loader-
> > > > only
> > > >     operation.  The
> > > >     >     >>>> > patches are currently up for review:
> > > >     >     >>>> >
> > > >     >     >>>> > This is the order in which they'd need to be
> > > > merged:
> > > >     >     >>>> >
> > > >     >     >>>> >
> > > >     >     >>>> > https://reviews.freebsd.org/D12732
> > > >     <https://reviews.freebsd.org/D12732>
> > > >     >     <https://reviews.freebsd.org/D12732
> > > >     <https://reviews.freebsd.org/D12732>>
> > > >     >     >>>> >
> > > >     >     >>>> > This one changes the efipart device.  Toomas
> > > > Soome
> > > >     identified
> > > >     >     some
> > > >     >     >>>> > problems, which I have addressed.  He has not
> > > >     re-reviewed it,
> > > >     >     >>however.
> > > >     >     >>>> >
> > > >     >     >>>> >
> > > >     >     >>>> > https://reviews.freebsd.org/D12692
> > > >     <https://reviews.freebsd.org/D12692>
> > > >     >     <https://reviews.freebsd.org/D12692
> > > >     <https://reviews.freebsd.org/D12692>>
> > > >     >     >>>> >
> > > >     >     >>>> > This adds some crypto code needed for GELI.  It
> > > > simply
> > > >     adds new
> > > >     >     >>code,
> > > >     >     >>>> > and doesn't conflict with anything.
> > > >     >     >>>> >
> > > >     >     >>>> >
> > > >     >     >>>> > https://reviews.freebsd.org/D12698
> > > >     <https://reviews.freebsd.org/D12698>
> > > >     >     <https://reviews.freebsd.org/D12698
> > > >     <https://reviews.freebsd.org/D12698>>
> > > >     >     >>>> >
> > > >     >     >>>> > This adds the EFI KMS interface code, and has
> > > > the EFI
> > > >     loader pass
> > > >     >     >>keys
> > > >     >     >>>> > into the keybuf interface.
> > > >     >     >>>> >
> > > >     >     >>>> >
> > > >     >     >>>> > I can't post the main GELI driver until those
> > > > get
> > > >     merged, as it
> > > >     >     >>depends
> > > >     >     >>>> > on them.  It can be found on the geli branch on
> > > > my
> > > >     github freebsd
> > > >     >     >>>> > repository, however.
> > > >     >     >>>> >
> > > >     >     >>>> >
> > > >     >     >>>> > Additionally, you need this patch, which allows
> > > >     loader.efi to
> > > >     >     >>function
> > > >     >     >>>> > when installed directly to the ESP:
> > > >     >     >>>> >
> > > >     >     >>>> > https://reviews.freebsd.org/D13497
> > > >     <https://reviews.freebsd.org/D13497>
> > > >     >     <https://reviews.freebsd.org/D13497
> > > >     <https://reviews.freebsd.org/D13497>>
> > > >     >     >>>> >
> > > >     >     >>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
> > > >     >     >>>> >> Hi Eric,
> > > >     >     >>>> >>
> > > >     >     >>>> >> could you provide a brief update how the work
> > > > is going?
> > > >     >     >>>> >>
> > > >     >     >>>> >>
> > > >     >     >>>> >> Br,
> > > >     >     >>>> >>
> > > >     >     >>>> >> Tommi
> > > >     >     >>>> >>
> > > >     >     >>>> >>
> > > >     >     >>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
> > > >     <eric at metricspace.net <mailto:eric at metricspace.net>
> > > >     >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> > > > et>>
> > > >     >     >>>> >> <mailto:eric at metricspace.net
> > > >     <mailto:eric at metricspace.net> <mailto:eric at metricspace.net
> > > >     <mailto:eric at metricspace.net>>>>
> > > >     >     wrote:
> > > >     >     >>>> >>
> > > >     >     >>>> >>     Right, so basically, the remaining GELI
> > > > patches
> > > >     are against
> > > >     >     >>>> loader, and
> > > >     >     >>>> >>     most of them can go in independently of the
> > > > work
> > > >     on removing
> > > >     >     >>boot1.
> > > >     >     >>>> >>     There's a unanimous consensus on getting
> > > > rid of
> > > >     boot1 which
> > > >     >     >>>> includes its
> > > >     >     >>>> >>     original author, so that's going to happen.
> > > >     >     >>>> >>
> > > >     >     >>>> >>
> > > >     >     >>>> >>     For GELI, we have the following (not
> > > > necessarily
> > > >     in order):
> > > >     >     >>>> >>
> > > >     >     >>>> >>     a) Adding the KMS interfaces, pseudo-
> > > > device, and
> > > >     kernel
> > > >     >     >>keybuf
> > > >     >     >>>> >>     interactions
> > > >     >     >>>> >>     b) Modifications to the efipart driver
> > > >     >     >>>> >>     c) boot crypto
> > > >     >     >>>> >>     d) GELI partition types (not strictly
> > > > necessary)
> > > >     >     >>>> >>
> > > >     >     >>>> >>     Then there's the GELI driver itself.  (a)
> > > > and (c)
> > > are
> > > >
> > > >     >     good to
> > > >     >     >>>> land, (b)
> > > >     >     >>>> >>     needs some more work after Toomas Soome
> > > > pointed
> > > out a
> > > >
> > > >     >     >>legitimate
> > > >     >     >>>> >>     problem, and (d) actually needs a good bit
> > > > more
> > > >     code (but
> > > >     >     >>again,
> > > >     >     >>>> it's
> > > >     >     >>>> >>     more cosmetic).  Additionally, the GELI
> > > > driver
> > > >     will need
> > > >     >     >>further
> > > >     >     >>>> mods to
> > > >     >     >>>> >>     efipart to be written (nothing too
> > > > big).  But we
> > > >     could go
> > > >     >     >>ahead
> > > >     >     >>>> with (a)
> > > >     >     >>>> >>     and (c), as they've already been proven to
> > > > work.
> > > >     >     >>>> >>
> > > >     >     >>>> >>     I'd wanted to have this stuff shaped up
> > > > sooner,
> > > >     but I'm
> > > >     >     >>>> preoccupied with
> > > >     >     >>>> >>     the 7th RISC-V workshop at the end of the
> > > > month.
> > > >     >     >>>> >>
> > > >     >     >>>> >>     Once this stuff is all in, loader should
> > > > handle
> > > >     any GELI
> > > >     >     >>volumes it
> > > >     >     >>>> >>     finds, and it should Just Work once boot1
> > > > is gone.
> > > >     >     >>>> >>
> > > >     >     >>>> >>
> > > >     >     >>>> > _______________________________________________
> > > >     >     >>>> > freebsd-current at freebsd.org
> > > >     <mailto:freebsd-current at freebsd.org>
> > > >     >     <mailto:freebsd-current at freebsd.org
> > > >     <mailto:freebsd-current at freebsd.org>> mailing list
> > > >     >     >>>> > https://lists.freebsd.org/mailman/listinfo/freeb
> > > > sd-
> > > current
> > > >
> > > >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> > > >     >     <https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> > > > rent
> > > >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> > > >     >     >>>> > To unsubscribe, send any mail to
> > > "freebsd-current-unsubscribe@
> > > >
> > > >     >     >>>> freebsd.org <http://freebsd.org>
> > > > <http://freebsd.org>"
> > > >     >     >>>> >
> > > >     >     >>>>
> > > >     >     >>>
> > > >     >     >
> > > >     >     > --
> > > >     >     > Sent from my Android device with K-9 Mail. Please
> > > > excuse my
> > > brevity.
> > > >
> > > >     >     > _______________________________________________
> > > >     >     > freebsd-current at freebsd.org
> > > >     <mailto:freebsd-current at freebsd.org>
> > > >     <mailto:freebsd-current at freebsd.org
> > > >     <mailto:freebsd-current at freebsd.org>>
> > > >     >     mailing list
> > > >     >     > https://lists.freebsd.org/mailman/listinfo/freebsd-cu
> > > > rrent
> > > >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> > > >     >     <https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> > > > rent
> > > >     <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> > > >     >     > To unsubscribe, send any mail to
> > > >     >     "freebsd-current-unsubscribe at freebsd.org
> > > >     <mailto:freebsd-current-unsubscribe at freebsd.org>
> > > >     >     <mailto:freebsd-current-unsubscribe at freebsd.org
> > > >     <mailto:freebsd-current-unsubscribe at freebsd.org>>"
> > > >     >     >
> > > >     >
> > > >     >
> > > >
> > > >
> > >
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd
> > .org"
>

From eric at metricspace.net  Sun Jul  8 20:36:53 2018
From: eric at metricspace.net (Eric McCorkle)
Date: Sun, 08 Jul 2018 16:36:47 -0400
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <1531078307.1336.22.camel@freebsd.org>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
 <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
 <1531078307.1336.22.camel@freebsd.org>
Message-ID: <8AFC01EE-A37A-4D89-9A67-8707AA3184DD@metricspace.net>

I intend to endorse this patch over my own once I'm able to test it out on my test images.

My approach is highly EFI-specific, and it made sense to do it that way when boot1.efi was still a thing. The architecture agnostic method makes more sense now that it's gone. 

On July 8, 2018 3:31:47 PM EDT, Ian Lepore <ian at freebsd.org> wrote:
>On Sun, 2018-07-08 at 21:08 +0200, Oliver Pinter wrote:
>> Hi!
>> 
>> Have you or Warner any update on this code?
>> 
>> On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net>
>> wrote:
>> 
>
>Are you aware of?https://reviews.freebsd.org/D15743??
>
>That's my changes to add geli support to loader(8) in an architecture-
>agnostic way, so that "it just works" for all platforms and flavors of
>loader. It has been succesfully tested on armv6/7 (ubldr) and on x86
>using qemu. ?The x86 tests cover ufs and zfs, legacy bios and uefi. The
>only variations that aren't tested yet are the uefi flavors, because
>the current rootgen.sh script for assembling test images is still using
>boot1.efi and I don't know enough about efi myself to update the script
>to make it assemble images the new way Warner envisions.
>
>-- Ian
>
>> > 
>> > I'm in the middle of moving to a new apartment right now.??It's
>> > going to
>> > be a bit before I can get to this.
>> > 
>> > On 04/11/2018 20:31, Warner Losh wrote:
>> > > 
>> > > OK. I've pushed in the main part of it. The additional work I
>> > > have
>> > > shouldn't affect any of this stuff.??I was going to look at what
>> > > part(s)
>> > > of your open reviewed needed to be redone tomorrow and send you
>> > > feedback, but if you wanted to get a start before then, I'm happy
>> > > to
>> > > answer questions. All the rest of my work is going to be
>> > > selecting the
>> > > root partition when we're told to us a specific partition, so
>> > > will be
>> > > very constrained.
>> > > 
>> > > Warner
>> > > 
>> > > On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.
>> > > net
>> > > <mailto:eric at metricspace.net>> wrote:
>> > > 
>> > > ????I think the thing to do at this point is to wait for the
>> > > current
>> > work on
>> > > 
>> > > ????loader.efi to land, then adapt my patches to apply against
>> > > that work.
>> > > 
>> > > ????On 04/11/2018 15:06, Warner Losh wrote:
>> > > ????> Still reviewing the code. I'm worried it's too i386
>> > > specific and it
>> > > ????> conflicts with some work I'm doing. I'll have a list of
>> > > actionable
>> > > ????> critiques this week.
>> > > ????>
>> > > ????> Warner
>> > > ????>
>> > > ????> On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
>> > > ????> <oliver.pinter at hardenedbsd.org
>> > > ????<mailto:oliver.pinter at hardenedbsd.org>
>> > > ????<mailto:oliver.pinter at hardenedbsd.org
>> > > ????<mailto:oliver.pinter at hardenedbsd.org>>>
>> > > ????> wrote:
>> > > ????>
>> > > ????>?????Hi!
>> > > ????>
>> > > ????>?????Is there any update regarding the rebase or the
>> > > inclusion to
>> > base
>> > > 
>> > > ????>?????system?
>> > > ????>?????On 3/28/18, Eric McCorkle <eric at metricspace.net
>> > > <mailto:
>> > eric at metricspace.net>
>> > > 
>> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>> > > et>>>
>> > wrote:
>> > > 
>> > > ????>?????> I'll do another rebase from head just to be sure
>> > > ????>?????>
>> > > ????>?????> On March 28, 2018 3:23:23 PM EDT, Warner Losh <
>> > imp at bsdimp.com <mailto:imp at bsdimp.com>
>> > > 
>> > > ????>?????<mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
>> > > ????>?????>>It's on my list for nexr, finally. I have an
>> > > alternate patch
>> > for
>> > > 
>> > > ????>?????>>loader.efi
>> > > ????>?????>>from ESP, but i don't think it will affect the GELI
>> > > stuff. I
>> > have some
>> > > 
>> > > ????>?????>>time
>> > > ????>?????>>slotted for integration issues though.
>> > > ????>?????>>
>> > > ????>?????>>I am quite mindful of the freeze dates.... I??have
>> > > some uefi
>> > boot
>> > > 
>> > > ????>?????>>loader
>> > > ????>?????>>protocol changes that I need to get in.
>> > > ????>?????>>
>> > > ????>?????>>Warner
>> > > ????>?????>>
>> > > ????>?????>>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
>> > tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
>> > > 
>> > > ????>?????<mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.
>> > > fi>>>
>> > wrote:
>> > > 
>> > > ????>?????>>
>> > > ????>?????>>> Awesome, thanks for the update and the work that
>> > > you have
>> > done!
>> > > 
>> > > ????>?????>>>
>> > > ????>?????>>> Now we just need some more reviewers eyes on the
>> > > code :)
>> > > ????>?????>>>
>> > > ????>?????>>> Br,
>> > > ????>?????>>>
>> > > ????>?????>>> Tommi
>> > > ????>?????>>>
>> > > ????>?????>>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
>> > eric at metricspace.net <mailto:eric at metricspace.net>
>> > > 
>> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>> > > et>>>
>> > > ????>?????>>wrote:
>> > > ????>?????>>>
>> > > ????>?????>>>> FYI, I just IFC'ed everything, and the current
>> > > patches
>> > > ????are still
>> > > ????>?????>>fine.
>> > > ????>?????>>>>
>> > > ????>?????>>>> Also, the full GELI + standalone loader has been
>> > > deployed
>> > > ????on one of
>> > > ????>?????>>my
>> > > ????>?????>>>> laptops for some time now.
>> > > ????>?????>>>>
>> > > ????>?????>>>> On 02/21/2018 18:15, Eric McCorkle wrote:
>> > > ????>?????>>>> > The GELI work could be merged at this point,
>> > > though it
>> > > ????won't be
>> > > ????>?????>>usable
>> > > ????>?????>>>> > without an additional patch to enable loader-
>> > > only
>> > > ????operation.??The
>> > > ????>?????>>>> > patches are currently up for review:
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > This is the order in which they'd need to be
>> > > merged:
>> > > ????>?????>>>> >
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > https://reviews.freebsd.org/D12732
>> > > ????<https://reviews.freebsd.org/D12732>
>> > > ????>?????<https://reviews.freebsd.org/D12732
>> > > ????<https://reviews.freebsd.org/D12732>>
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > This one changes the efipart device.??Toomas
>> > > Soome
>> > > ????identified
>> > > ????>?????some
>> > > ????>?????>>>> > problems, which I have addressed.??He has not
>> > > ????re-reviewed it,
>> > > ????>?????>>however.
>> > > ????>?????>>>> >
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > https://reviews.freebsd.org/D12692
>> > > ????<https://reviews.freebsd.org/D12692>
>> > > ????>?????<https://reviews.freebsd.org/D12692
>> > > ????<https://reviews.freebsd.org/D12692>>
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > This adds some crypto code needed for GELI.??It
>> > > simply
>> > > ????adds new
>> > > ????>?????>>code,
>> > > ????>?????>>>> > and doesn't conflict with anything.
>> > > ????>?????>>>> >
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > https://reviews.freebsd.org/D12698
>> > > ????<https://reviews.freebsd.org/D12698>
>> > > ????>?????<https://reviews.freebsd.org/D12698
>> > > ????<https://reviews.freebsd.org/D12698>>
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > This adds the EFI KMS interface code, and has
>> > > the EFI
>> > > ????loader pass
>> > > ????>?????>>keys
>> > > ????>?????>>>> > into the keybuf interface.
>> > > ????>?????>>>> >
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > I can't post the main GELI driver until those
>> > > get
>> > > ????merged, as it
>> > > ????>?????>>depends
>> > > ????>?????>>>> > on them.??It can be found on the geli branch on
>> > > my
>> > > ????github freebsd
>> > > ????>?????>>>> > repository, however.
>> > > ????>?????>>>> >
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > Additionally, you need this patch, which allows
>> > > ????loader.efi to
>> > > ????>?????>>function
>> > > ????>?????>>>> > when installed directly to the ESP:
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > https://reviews.freebsd.org/D13497
>> > > ????<https://reviews.freebsd.org/D13497>
>> > > ????>?????<https://reviews.freebsd.org/D13497
>> > > ????<https://reviews.freebsd.org/D13497>>
>> > > ????>?????>>>> >
>> > > ????>?????>>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
>> > > ????>?????>>>> >> Hi Eric,
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >> could you provide a brief update how the work
>> > > is going?
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >> Br,
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >> Tommi
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
>> > > ????<eric at metricspace.net <mailto:eric at metricspace.net>
>> > > ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>> > > et>>
>> > > ????>?????>>>> >> <mailto:eric at metricspace.net
>> > > ????<mailto:eric at metricspace.net> <mailto:eric at metricspace.net
>> > > ????<mailto:eric at metricspace.net>>>>
>> > > ????>?????wrote:
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????Right, so basically, the remaining GELI
>> > > patches
>> > > ????are against
>> > > ????>?????>>>> loader, and
>> > > ????>?????>>>> >>?????most of them can go in independently of the
>> > > work
>> > > ????on removing
>> > > ????>?????>>boot1.
>> > > ????>?????>>>> >>?????There's a unanimous consensus on getting
>> > > rid of
>> > > ????boot1 which
>> > > ????>?????>>>> includes its
>> > > ????>?????>>>> >>?????original author, so that's going to happen.
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????For GELI, we have the following (not
>> > > necessarily
>> > > ????in order):
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????a) Adding the KMS interfaces, pseudo-
>> > > device, and
>> > > ????kernel
>> > > ????>?????>>keybuf
>> > > ????>?????>>>> >>?????interactions
>> > > ????>?????>>>> >>?????b) Modifications to the efipart driver
>> > > ????>?????>>>> >>?????c) boot crypto
>> > > ????>?????>>>> >>?????d) GELI partition types (not strictly
>> > > necessary)
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????Then there's the GELI driver itself.??(a)
>> > > and (c)
>> > are
>> > > 
>> > > ????>?????good to
>> > > ????>?????>>>> land, (b)
>> > > ????>?????>>>> >>?????needs some more work after Toomas Soome
>> > > pointed
>> > out a
>> > > 
>> > > ????>?????>>legitimate
>> > > ????>?????>>>> >>?????problem, and (d) actually needs a good bit
>> > > more
>> > > ????code (but
>> > > ????>?????>>again,
>> > > ????>?????>>>> it's
>> > > ????>?????>>>> >>?????more cosmetic).??Additionally, the GELI
>> > > driver
>> > > ????will need
>> > > ????>?????>>further
>> > > ????>?????>>>> mods to
>> > > ????>?????>>>> >>?????efipart to be written (nothing too
>> > > big).??But we
>> > > ????could go
>> > > ????>?????>>ahead
>> > > ????>?????>>>> with (a)
>> > > ????>?????>>>> >>?????and (c), as they've already been proven to
>> > > work.
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????I'd wanted to have this stuff shaped up
>> > > sooner,
>> > > ????but I'm
>> > > ????>?????>>>> preoccupied with
>> > > ????>?????>>>> >>?????the 7th RISC-V workshop at the end of the
>> > > month.
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>?????Once this stuff is all in, loader should
>> > > handle
>> > > ????any GELI
>> > > ????>?????>>volumes it
>> > > ????>?????>>>> >>?????finds, and it should Just Work once boot1
>> > > is gone.
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> >>
>> > > ????>?????>>>> > _______________________________________________
>> > > ????>?????>>>> > freebsd-current at freebsd.org
>> > > ????<mailto:freebsd-current at freebsd.org>
>> > > ????>?????<mailto:freebsd-current at freebsd.org
>> > > ????<mailto:freebsd-current at freebsd.org>> mailing list
>> > > ????>?????>>>> > https://lists.freebsd.org/mailman/listinfo/freeb
>> > > sd-
>> > current
>> > > 
>> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
>> > > ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
>> > > rent
>> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
>> > > ????>?????>>>> > To unsubscribe, send any mail to
>> > "freebsd-current-unsubscribe@
>> > > 
>> > > ????>?????>>>> freebsd.org <http://freebsd.org>
>> > > <http://freebsd.org>"
>> > > ????>?????>>>> >
>> > > ????>?????>>>>
>> > > ????>?????>>>
>> > > ????>?????>
>> > > ????>?????> --
>> > > ????>?????> Sent from my Android device with K-9 Mail. Please
>> > > excuse my
>> > brevity.
>> > > 
>> > > ????>?????> _______________________________________________
>> > > ????>?????> freebsd-current at freebsd.org
>> > > ????<mailto:freebsd-current at freebsd.org>
>> > > ????<mailto:freebsd-current at freebsd.org
>> > > ????<mailto:freebsd-current at freebsd.org>>
>> > > ????>?????mailing list
>> > > ????>?????> https://lists.freebsd.org/mailman/listinfo/freebsd-cu
>> > > rrent
>> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
>> > > ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
>> > > rent
>> > > ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
>> > > ????>?????> To unsubscribe, send any mail to
>> > > ????>?????"freebsd-current-unsubscribe at freebsd.org
>> > > ????<mailto:freebsd-current-unsubscribe at freebsd.org>
>> > > ????>?????<mailto:freebsd-current-unsubscribe at freebsd.org
>> > > ????<mailto:freebsd-current-unsubscribe at freebsd.org>>"
>> > > ????>?????>
>> > > ????>
>> > > ????>
>> > > 
>> > > 
>> > 
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd
>> .org"

-- 
Sent from my Android device with K-9 Mail. Please excuse my brevity.

From marklmi at yahoo.com  Sun Jul  8 23:10:30 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Sun, 8 Jul 2018 15:50:09 -0700
Subject: -r336099 and later: broke ci.freebsd.prg's FreeBSD-head-amd64-build
Message-ID: <6EA9A549-7508-467C-BED2-AF0C136C752D@yahoo.com>

https://ci.freebsd.org/job/FreeBSD-head-amd64-build/9386/consoleText shows:

===> zlib (install)
install -T release -o root -g wheel -m 555   zlib.ko /usr/obj/usr/src/amd64.amd64/release/dist/kernel/boot/kernel/
install -T debug -o root -g wheel -m 555   zlib.ko.debug /usr/obj/usr/src/amd64.amd64/release/dist/kernel/usr/lib/debug/boot/kernel/
kldxref /usr/obj/usr/src/amd64.amd64/release/dist/kernel/boot/kernel
kldxref: Parse error of description string U16:vendor; U16:device
*** Error code 1

Stop.
make[4]: stopped in /usr/src/sys/modules


Note the "U16:vendor; U16:device" reference and such text in
the below (and other check-ins after it). . .


Author: imp
Date: Sun Jul  8 20:39:38 2018
New Revision: 336099
URL: 
https://svnweb.freebsd.org/changeset/base/336099


Log:
  Add PNP info to PCI attachment of ena driver
. . .

Modified:
  head/sys/dev/ena/ena.c
  head/sys/dev/ena/ena.h

Modified: head/sys/dev/ena/ena.c
==============================================================================
--- head/sys/dev/ena/ena.c	Sun Jul  8 20:39:23 2018	(r336098)
+++ head/sys/dev/ena/ena.c	Sun Jul  8 20:39:38 2018	(r336099)
@@ -3947,6 +3947,8 @@ static driver_t ena_driver = {
 
 devclass_t ena_devclass;
 DRIVER_MODULE(ena, pci, ena_driver, ena_devclass, 0, 0);
+MODULE_PNP_INFO("U16:vendor; U16:device", pci, ena, ena_vendor_info_array,
+    sizeof(ena_vendor_info_array[0]), nitems(ena_vendor_info_array) - 1);
 MODULE_DEPEND(ena, pci, 1, 1, 1);
 MODULE_DEPEND(ena, ether, 1, 1, 1);

. . .


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From imp at bsdimp.com  Sun Jul  8 23:13:13 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sun, 8 Jul 2018 17:13:11 -0600
Subject: -r336099 and later: broke ci.freebsd.prg's
 FreeBSD-head-amd64-build
In-Reply-To: <6EA9A549-7508-467C-BED2-AF0C136C752D@yahoo.com>
References: <6EA9A549-7508-467C-BED2-AF0C136C752D@yahoo.com>
Message-ID: <CANCZdfoWTFwXgYcpXwkbo-SHnzw1zOex96xO9nQLL7a2=y4WvA@mail.gmail.com>

Yea, there's a stray space in that string.

r336114 should fix that.

Warner

On Sun, Jul 8, 2018 at 4:50 PM, Mark Millard <marklmi at yahoo.com> wrote:

> https://ci.freebsd.org/job/FreeBSD-head-amd64-build/9386/consoleText
> shows:
>
> ===> zlib (install)
> install -T release -o root -g wheel -m 555   zlib.ko
> /usr/obj/usr/src/amd64.amd64/release/dist/kernel/boot/kernel/
> install -T debug -o root -g wheel -m 555   zlib.ko.debug
> /usr/obj/usr/src/amd64.amd64/release/dist/kernel/usr/lib/
> debug/boot/kernel/
> kldxref /usr/obj/usr/src/amd64.amd64/release/dist/kernel/boot/kernel
> kldxref: Parse error of description string U16:vendor; U16:device
> *** Error code 1
>
> Stop.
> make[4]: stopped in /usr/src/sys/modules
>
>
> Note the "U16:vendor; U16:device" reference and such text in
> the below (and other check-ins after it). . .
>
>
> Author: imp
> Date: Sun Jul  8 20:39:38 2018
> New Revision: 336099
> URL:
> https://svnweb.freebsd.org/changeset/base/336099
>
>
> Log:
>   Add PNP info to PCI attachment of ena driver
> . . .
>
> Modified:
>   head/sys/dev/ena/ena.c
>   head/sys/dev/ena/ena.h
>
> Modified: head/sys/dev/ena/ena.c
> ============================================================
> ==================
> --- head/sys/dev/ena/ena.c      Sun Jul  8 20:39:23 2018        (r336098)
> +++ head/sys/dev/ena/ena.c      Sun Jul  8 20:39:38 2018        (r336099)
> @@ -3947,6 +3947,8 @@ static driver_t ena_driver = {
>
>  devclass_t ena_devclass;
>  DRIVER_MODULE(ena, pci, ena_driver, ena_devclass, 0, 0);
> +MODULE_PNP_INFO("U16:vendor; U16:device", pci, ena, ena_vendor_info_array,
> +    sizeof(ena_vendor_info_array[0]), nitems(ena_vendor_info_array) - 1);
>  MODULE_DEPEND(ena, pci, 1, 1, 1);
>  MODULE_DEPEND(ena, ether, 1, 1, 1);
>
> . . .
>
>
> ===
> Mark Millard
> marklmi at yahoo.com
> ( dsl-only.net went
> away in early 2018-Mar)
>
>

From lwhsu at freebsd.org  Mon Jul  9 00:11:52 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Mon, 9 Jul 2018 01:03:46 +0100
Subject: ci.freebsd.org's FreeBSD-head-i386-testvm fails for: pkg: No
 packages available to install matching 'scapy' have been found in the
 repositories
In-Reply-To: <76841358-DBB1-4400-9E99-9B7375245DD2@yahoo.com>
References: <76841358-DBB1-4400-9E99-9B7375245DD2@yahoo.com>
Message-ID: <CAKBkRUznBBOxrR=6gmo_w7nJCz_zJxBdPgBzv234nHgoP9P=LA@mail.gmail.com>

On Thu, Jul 5, 2018 at 11:51 PM Mark Millard <marklmi at yahoo.com> wrote:
>
> https://ci.freebsd.org/job/FreeBSD-head-i386-testvm/6978/console shows:
>
> 22:34:39 All repositories are up to date.
> 22:34:39 + sudo chroot ufs pkg install -y kyua perl5 scapy ksh93 python
> 22:34:39 Updating FreeBSD repository catalogue...
> 22:34:39 FreeBSD repository is up to date.
> 22:34:39 All repositories are up to date.
> 22:34:39 Updating database digests format: . done
> 22:34:39 pkg: No packages available to install matching 'scapy' have been found in the repositories
> 22:34:39 Build step 'Execute shell' marked build as failure
> 22:34:39 FTP: Current build result is [FAILURE], not going to run.
>
> There is a:
>
> https://svnweb.freebsd.org/ports/head/net/scapy/
>

It's not in head's pkg repository because it was skipped in last
completed pkg build:

http://beefy12.nyi.freebsd.org/build.html?mastername=head-amd64-default&build=p473790_s335878
(ipv6 only)

The reason is libdnet did not build, which needs this:

https://svnweb.freebsd.org/changeset/base/335928

The on-going pkg build will have scapy restored:

http://beefy12.nyi.freebsd.org/build.html?mastername=head-amd64-default&build=p474051_s336054

Li-Wen

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From tobik at FreeBSD.org  Mon Jul  9 09:58:20 2018
From: tobik at FreeBSD.org (Tobias Kortkamp)
Date: Mon, 09 Jul 2018 11:58:18 +0200
Subject: New conflict between the FreeBSD-libnv-development and
 FreeBSD-runtime-development packages
Message-ID: <1531130298.3054575.1434404056.514ED8A8@webmail.messagingengine.com>

Hi,

there's a new conflict between the FreeBSD-{libnv,runtime}-development
base packages.  This was for r336096 but the problem must have been
introduced after r335966 as the packages from that revision were
fine.

Checking integrity...  done (1 conflicting)
  - FreeBSD-libnv-development-12.0.s20180708222113 [base] conflicts
  with FreeBSD-runtime-development-12.0.s20180708222113 [installed]
  on /usr/include/sys/cnv.h


From jhs at berklix.com  Mon Jul  9 10:55:41 2018
From: jhs at berklix.com (Julian H. Stacey)
Date: Mon, 09 Jul 2018 11:50:01 +0200
Subject: sys/Makefile .if defined(MODULES_WITH_WORLD)
Message-ID: <201807090950.w699o1jF022468@fire.js.berklix.net>

Hi current@
src/sys/dev/amdsbwd/amdsbwd.c broke src/sys/modules

Is it immediately intuitive & well known to developers working in sys/dev
to enable MODULES_WITH_WORLD before a test make all before a commit ?

Or what should we do to increase the liklehood of commiters catching
modules/ errors before a commit ?

With src/
	.ctm_status src-cur 13573
	.svn_revision 335362
sys/Makefile has
	.if defined(MODULES_WITH_WORLD)
	SUBDIR+=modules
& nothing from cd /usr/src; find . -name \*src.conf\*
& no default /etc/src.conf with no
	MODULES_WITH_WORLD=YES
so make all does not build /sys/modules/ 
so this not seen from /sys/modules/
===> amdsbwd (all)
cc  -O2 -pipe -DBERKLIX=YES  -fno-strict-aliasing -Werror -D_KERNEL -DKLD_MODULE -nostdinc   -I. -I/data/release/s1/usr/src/sys -I/data/release/s1/usr/src/sys/contrib/ck/include -fno-common  -fno-omit-frame-pointer -mno-omit-leaf-frame-pointer   -MD  -MF.depend.amdsbwd.o -MTamdsbwd.o -mcmodel=kernel -mno-red-zone -mno-mmx -mno-sse -msoft-float  -fno-asynchronous-unwind-tables -ffreestanding -fwrapv -fstack-protector -Wall -Wredundant-decls -Wnested-externs -Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith -Wcast-qual -Wundef -Wno-pointer-sign -D__printf__=__freebsd_kprintf__ -Wmissing-include-dirs -fdiagnostics-show-option -Wno-unknown-pragmas -Wno-error-tautological-compare -Wno-error-empty-body -Wno-error-parentheses-equality -Wno-error-unused-function -Wno-error-pointer-sign -Wno-error-shift-negative-value -Wno-address-of-packed-member  -mno-aes -mno-avx  -std=iso9899:1999 -c /data/release/s1/usr/src/sys/dev/amdsbwd/amdsbwd.c -o amdsbwd.o
/data/release/s1/usr/src/sys/dev/amdsbwd/amdsbwd.c:52:10: fatal error: 
      'opt_amdsbwd.h' file not found
#include "opt_amdsbwd.h"


PS With 
	.ctm_status	src-cur 13601
	.svn_revision	336117
nothing from
	find . -name opt_amdsbwd.h
but this has
	src/sys/dev/amdsbwd/amdsbwd.c
	#include "opt_amdsbwd.h"
I haven't yet upgraded my src/ yet to see if it still fails.

Cheers,
Julian
-- 
Julian Stacey, Computer Consultant, Systems Engineer, BSD Linux Unix, Munich
 Brexit Referendum stole 3.7 million votes inc. from 700,000 British in EU.
 UK Goverment lies it's democratic in Article 50 paragraph 3 of letter to EU.
 http://berklix.eu/queen/  https://www.peoples-vote.uk   193,000 @ 8 Jul 2018

From jhs at berklix.com  Mon Jul  9 11:54:49 2018
From: jhs at berklix.com (Julian H. Stacey)
Date: Mon, 09 Jul 2018 13:54:07 +0200
Subject: How to add su to /rescue ?
Message-ID: <201807091154.w69Bs7Ha024391@fire.js.berklix.net>

Hi current@
I want to add su to /rescue, but got stuck on pam.
Old unix su didn't suffer from pam.
There's no #define in su to turn off pam.
Man src.conf says WITHOUT_PAM is deprecated & does nothing.

Can someone please offer a solution ?
Or better to include a simple BSD su pre pam ?
I would happily develop a patch for that.

Notes to explain the need, & patches from my
http://berklix.com/~jhs/src/bsd/fixes/freebsd/src/gen/rescue/
---------

Patch[es] below to solve this emailed scenario:
> Please on prison-host cp /lib/libc.so.7 /tank/ezjail/my-domain/lib/libc.so.7
> I am logged in on jail-host, but only as normal-user, not root, so I cannot run
> 	/rescue/cp /usr/obj/usr/src/lib/libc/libc.so.7 /lib/libc.so.7
> 
> a my make installworld on jail-host.my-domain previously failed with
> 	===> lib/libc (install)
> 	install -C -o root -g wheel -m 444   libc.a /usr/lib
> 	install -C -o root -g wheel -m 444   libc_p.a /usr/lib
> 	install -s -o root -g wheel -m 444   -fschg -S  libc.so.7 /lib
> 	install: /lib/libc.so.7: chflags: Operation not permitted
> 	*** Error code 71
> (might or not be an artifact of being in a jail)
> 
> unfortunately I had run the command as
> 	xs make installworld
> (xs is my own little root wrapper)
> so when it exited, I was just normal-user not root, & I had forgotten to
> open another xterm & leave it logged in as root,
> & I found no /rescue/su

*** 12.0-CURRENT/usr/src/rescue/rescue/Makefile.orig	Tue Jun 19 14:43:47 2018
--- new-generic/usr/src/rescue/rescue/Makefile	Mon Jul  9 12:21:47 2018
***************
*** 188,193 ****
--- 188,195 ----
  CRUNCH_PROGS_usr.bin+= less
  CRUNCH_ALIAS_less= more
  
+ CRUNCH_PROGS_usr.bin+= su
+ 
  CRUNCH_PROGS_usr.bin+= xz
  CRUNCH_ALIAS_xz= unxz lzma unlzma xzcat lzcat
  
-----
Patch above fails with:
  cc -O2 -pipe -DBERKLIX=YES   -std=gnu99    -Qunused-arguments    -static -o reue rescue.o cat.lo chflags.lo chio.lo chmod.lo cp.lo date.lo dd.lo df.lo echo. ed.lo expr.lo getfacl.lo hostname.lo kenv.lo kill.lo ln.lo ls.lo mkdir.lo mv. pkill.lo ps.lo pwd.lo realpath.lo rm.lo rmdir.lo setfacl.lo sh.lo sleep.lo st.lo sync.lo test.lo csh.lo camcontrol.lo clri.lo devfs.lo dmesg.lo dump.lo dums.lo dumpon.lo fsck.lo fsck_ffs.lo fsck_msdosfs.lo fsdb.lo fsirand.lo gbde.lo om.lo ifconfig.lo init.lo kldconfig.lo kldload.lo kldstat.lo kldunload.lo ldcoig.lo md5.lo mdconfig.lo mdmfs.lo mknod.lo mount.lo mount_cd9660.lo mount_msdos.lo mount_nfs.lo mount_nullfs.lo mount_udf.lo mount_unionfs.lo newfs.lo newfssdos.lo nos-tun.lo ping.lo reboot.lo restore.lo rcorder.lo route.lo savecore.lshutdown.lo spppcontrol.lo swapon.lo sysctl.lo tunefs.lo umount.lo ccdconfig.lping6.lo rtsol.lo ipf.lo routed.lo rtquery.lo zfs.lo zpool.lo bsdlabel.lo fdislo dhclient.lo head.lo mt.lo sed.lo tail.lo tee.lo !
 gzip.lo bzip2.lo less.lo suo xz.lo zstd.lo tar.lo nc.lo vi.lo id.lo iscsictl.lo zdb.lo chroot.lo chown.loscsid.lo /data/release/s1/usr/obj/data/release/s1/usr/src/amd64.amd64/rescue/rcue/../librescue/exec.o /data/release/s1/usr/obj/data/release/s1/usr/src/amd64md64/rescue/rescue/../librescue/getusershell.o /data/release/s1/usr/obj/data/rease/s1/usr/src/amd64.amd64/rescue/rescue/../librescue/login_class.o /data/relse/s1/usr/obj/data/release/s1/usr/src/amd64.amd64/rescue/rescue/../librescue/pen.o /data/release/s1/usr/obj/data/release/s1/usr/src/amd64.amd64/rescue/rescu../librescue/rcmdsh.o /data/release/s1/usr/obj/data/release/s1/usr/src/amd64.a64/rescue/rescue/../librescue/sysctl.o /data/release/s1/usr/obj/data/release/susr/src/amd64.amd64/rescue/rescue/../librescue/system.o -lcrypt -ledit -ljail kvm -lelf -ll -ltermcapw -lutil -lxo -l80211 -lalias -lcam -lncursesw -ldevsta-lipsec -llzma -lavl -lzpool -lzfs_core -lzfs -lnvpair -lpthread -luutil -lume-lgeom -lbsdxml -lkiconv !
 -lmt -lsbuf -lufs -lz -lbz2 -lprivatezstd -larchive -rypto -lmd -lm
  /usr/bin/ld: error: undefined symbol: pam_start
  >>> referenced by su.lo:(_$$hide$$ su.lo main)
  
  /usr/bin/ld: error: undefined symbol: pam_set_item
  >>> referenced by su.lo:(_$$hide$$ su.lo main)

Patch below does not solve problem above
*** 12.0-CURRENT/usr/src/rescue/librescue/Makefile.orig	Mon Jul  9 13:02:43 2018
--- new-generic/usr/src/rescue/librescue/Makefile	Mon Jul  9 13:03:59 2018
***************
*** 16,21 ****
--- 16,22 ----
  .PATH: ${SRCTOP}/lib/libc/gen \
         ${SRCTOP}/lib/libc/net \
         ${SRCTOP}/lib/libc/stdlib \
+        ${SRCTOP}/lib/libpam/libpam \
         ${SRCTOP}/lib/libutil 
  
  LIB=		rescue
---
changing libpam/libpam to libpam also fails.
-------

Cheers,
Julian
-- 
Julian Stacey, Computer Consultant, Systems Engineer, BSD Linux Unix, Munich
 Brexit Referendum stole 3.7 million votes inc. from 700,000 British in EU.
 UK Goverment lies it's democratic in Article 50 paragraph 3 of letter to EU.
 http://berklix.eu/queen/  https://www.peoples-vote.uk   200,000 @ 9 Jul 2018

From kevans at freebsd.org  Mon Jul  9 13:06:27 2018
From: kevans at freebsd.org (Kyle Evans)
Date: Mon, 9 Jul 2018 08:06:04 -0500
Subject: New conflict between the FreeBSD-libnv-development and
 FreeBSD-runtime-development packages
In-Reply-To: <1531130298.3054575.1434404056.514ED8A8@webmail.messagingengine.com>
References: <1531130298.3054575.1434404056.514ED8A8@webmail.messagingengine.com>
Message-ID: <CACNAnaGAZmhrGmz=j4Ss-ZD9QR5eWJrbJh0R1S3apJ0tLMA3oA@mail.gmail.com>

On Mon, Jul 9, 2018 at 4:58 AM, Tobias Kortkamp <tobik at freebsd.org> wrote:
> Hi,
>
> there's a new conflict between the FreeBSD-{libnv,runtime}-development
> base packages.  This was for r336096 but the problem must have been
> introduced after r335966 as the packages from that revision were
> fine.
>
> Checking integrity...  done (1 conflicting)
>   - FreeBSD-libnv-development-12.0.s20180708222113 [base] conflicts
>   with FreeBSD-runtime-development-12.0.s20180708222113 [installed]
>   on /usr/include/sys/cnv.h
>

Hi,

Indeed- there's a patch in flight that will alleviate this that will
hopefully land later today.

Thanks,

Kyle Evans

From ian at freebsd.org  Mon Jul  9 14:19:19 2018
From: ian at freebsd.org (Ian Lepore)
Date: Mon, 09 Jul 2018 08:19:05 -0600
Subject: sys/Makefile .if defined(MODULES_WITH_WORLD)
In-Reply-To: <201807090950.w699o1jF022468@fire.js.berklix.net>
References: <201807090950.w699o1jF022468@fire.js.berklix.net>
Message-ID: <1531145945.1336.23.camel@freebsd.org>

On Mon, 2018-07-09 at 11:50 +0200, Julian H. Stacey wrote:
> Hi current@
> src/sys/dev/amdsbwd/amdsbwd.c broke src/sys/modules
> 
> Is it immediately intuitive & well known to developers working in
> sys/dev
> to enable MODULES_WITH_WORLD before a test make all before a commit ?
> 
> Or what should we do to increase the liklehood of commiters catching
> modules/ errors before a commit ?
> 
> With src/
> 	.ctm_status src-cur 13573
> 	.svn_revision 335362
> sys/Makefile has
> 	.if defined(MODULES_WITH_WORLD)
> 	SUBDIR+=modules
> & nothing from cd /usr/src; find . -name \*src.conf\*
> & no default /etc/src.conf with no
> 	MODULES_WITH_WORLD=YES
> so make all does not build /sys/modules/?
> so this not seen from /sys/modules/
> ===> amdsbwd (all)
> cc??-O2 -pipe -DBERKLIX=YES??-fno-strict-aliasing -Werror -D_KERNEL
> -DKLD_MODULE -nostdinc???-I. -I/data/release/s1/usr/src/sys
> -I/data/release/s1/usr/src/sys/contrib/ck/include -fno-common??-fno-
> omit-frame-pointer -mno-omit-leaf-frame-pointer???-MD??-
> MF.depend.amdsbwd.o -MTamdsbwd.o -mcmodel=kernel -mno-red-zone -mno-
> mmx -mno-sse -msoft-float??-fno-asynchronous-unwind-tables
> -ffreestanding -fwrapv -fstack-protector -Wall -Wredundant-decls
> -Wnested-externs -Wstrict-prototypes -Wmissing-prototypes -Wpointer-
> arith -Wcast-qual -Wundef -Wno-pointer-sign
> -D__printf__=__freebsd_kprintf__ -Wmissing-include-dirs
> -fdiagnostics-show-option -Wno-unknown-pragmas -Wno-error-
> tautological-compare -Wno-error-empty-body -Wno-error-parentheses-
> equality -Wno-error-unused-function -Wno-error-pointer-sign -Wno-
> error-shift-negative-value -Wno-address-of-packed-member??-mno-aes
> -mno-avx??-std=iso9899:1999 -c
> /data/release/s1/usr/src/sys/dev/amdsbwd/amdsbwd.c -o amdsbwd.o
> /data/release/s1/usr/src/sys/dev/amdsbwd/amdsbwd.c:52:10: fatal
> error:?
> ??????'opt_amdsbwd.h' file not found
> #include "opt_amdsbwd.h"
> 
> 
> PS With?
> 	.ctm_status	src-cur 13601
> 	.svn_revision	336117
> nothing from
> 	find . -name opt_amdsbwd.h
> but this has
> 	src/sys/dev/amdsbwd/amdsbwd.c
> 	#include "opt_amdsbwd.h"
> I haven't yet upgraded my src/ yet to see if it still fails.
> 
> Cheers,
> Julian

Should be fixed in r336134.

-- Ian

From allanjude at freebsd.org  Mon Jul  9 16:28:55 2018
From: allanjude at freebsd.org (Allan Jude)
Date: Mon, 9 Jul 2018 12:28:33 -0400
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <1531078307.1336.22.camel@freebsd.org>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
 <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
 <1531078307.1336.22.camel@freebsd.org>
Message-ID: <06cb8190-7a04-5c92-8fb9-637d1a80758f@freebsd.org>

I will look at updating the rootgen.sh script this evening, to support 
creating more flexible ESP partitions, so we can drop the loader.efi 
into an msdosfs directly.

On 07/08/2018 15:31, Ian Lepore wrote:
> On Sun, 2018-07-08 at 21:08 +0200, Oliver Pinter wrote:
>> Hi!
>>
>> Have you or Warner any update on this code?
>>
>> On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net>
>> wrote:
>>
> 
> Are you aware of?https://reviews.freebsd.org/D15743??
> 
> That's my changes to add geli support to loader(8) in an architecture-
> agnostic way, so that "it just works" for all platforms and flavors of
> loader. It has been succesfully tested on armv6/7 (ubldr) and on x86
> using qemu. ?The x86 tests cover ufs and zfs, legacy bios and uefi. The
> only variations that aren't tested yet are the uefi flavors, because
> the current rootgen.sh script for assembling test images is still using
> boot1.efi and I don't know enough about efi myself to update the script
> to make it assemble images the new way Warner envisions.
> 
> -- Ian
> 
>>>
>>> I'm in the middle of moving to a new apartment right now.??It's
>>> going to
>>> be a bit before I can get to this.
>>>
>>> On 04/11/2018 20:31, Warner Losh wrote:
>>>>
>>>> OK. I've pushed in the main part of it. The additional work I
>>>> have
>>>> shouldn't affect any of this stuff.??I was going to look at what
>>>> part(s)
>>>> of your open reviewed needed to be redone tomorrow and send you
>>>> feedback, but if you wanted to get a start before then, I'm happy
>>>> to
>>>> answer questions. All the rest of my work is going to be
>>>> selecting the
>>>> root partition when we're told to us a specific partition, so
>>>> will be
>>>> very constrained.
>>>>
>>>> Warner
>>>>
>>>> On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.
>>>> net
>>>> <mailto:eric at metricspace.net>> wrote:
>>>>
>>>>  ????I think the thing to do at this point is to wait for the
>>>> current
>>> work on
>>>>
>>>>  ????loader.efi to land, then adapt my patches to apply against
>>>> that work.
>>>>
>>>>  ????On 04/11/2018 15:06, Warner Losh wrote:
>>>>  ????> Still reviewing the code. I'm worried it's too i386
>>>> specific and it
>>>>  ????> conflicts with some work I'm doing. I'll have a list of
>>>> actionable
>>>>  ????> critiques this week.
>>>>  ????>
>>>>  ????> Warner
>>>>  ????>
>>>>  ????> On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
>>>>  ????> <oliver.pinter at hardenedbsd.org
>>>>  ????<mailto:oliver.pinter at hardenedbsd.org>
>>>>  ????<mailto:oliver.pinter at hardenedbsd.org
>>>>  ????<mailto:oliver.pinter at hardenedbsd.org>>>
>>>>  ????> wrote:
>>>>  ????>
>>>>  ????>?????Hi!
>>>>  ????>
>>>>  ????>?????Is there any update regarding the rebase or the
>>>> inclusion to
>>> base
>>>>
>>>>  ????>?????system?
>>>>  ????>?????On 3/28/18, Eric McCorkle <eric at metricspace.net
>>>> <mailto:
>>> eric at metricspace.net>
>>>>
>>>>  ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>>>> et>>>
>>> wrote:
>>>>
>>>>  ????>?????> I'll do another rebase from head just to be sure
>>>>  ????>?????>
>>>>  ????>?????> On March 28, 2018 3:23:23 PM EDT, Warner Losh <
>>> imp at bsdimp.com <mailto:imp at bsdimp.com>
>>>>
>>>>  ????>?????<mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
>>>>  ????>?????>>It's on my list for nexr, finally. I have an
>>>> alternate patch
>>> for
>>>>
>>>>  ????>?????>>loader.efi
>>>>  ????>?????>>from ESP, but i don't think it will affect the GELI
>>>> stuff. I
>>> have some
>>>>
>>>>  ????>?????>>time
>>>>  ????>?????>>slotted for integration issues though.
>>>>  ????>?????>>
>>>>  ????>?????>>I am quite mindful of the freeze dates.... I??have
>>>> some uefi
>>> boot
>>>>
>>>>  ????>?????>>loader
>>>>  ????>?????>>protocol changes that I need to get in.
>>>>  ????>?????>>
>>>>  ????>?????>>Warner
>>>>  ????>?????>>
>>>>  ????>?????>>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
>>> tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
>>>>
>>>>  ????>?????<mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.
>>>> fi>>>
>>> wrote:
>>>>
>>>>  ????>?????>>
>>>>  ????>?????>>> Awesome, thanks for the update and the work that
>>>> you have
>>> done!
>>>>
>>>>  ????>?????>>>
>>>>  ????>?????>>> Now we just need some more reviewers eyes on the
>>>> code :)
>>>>  ????>?????>>>
>>>>  ????>?????>>> Br,
>>>>  ????>?????>>>
>>>>  ????>?????>>> Tommi
>>>>  ????>?????>>>
>>>>  ????>?????>>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
>>> eric at metricspace.net <mailto:eric at metricspace.net>
>>>>
>>>>  ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>>>> et>>>
>>>>  ????>?????>>wrote:
>>>>  ????>?????>>>
>>>>  ????>?????>>>> FYI, I just IFC'ed everything, and the current
>>>> patches
>>>>  ????are still
>>>>  ????>?????>>fine.
>>>>  ????>?????>>>>
>>>>  ????>?????>>>> Also, the full GELI + standalone loader has been
>>>> deployed
>>>>  ????on one of
>>>>  ????>?????>>my
>>>>  ????>?????>>>> laptops for some time now.
>>>>  ????>?????>>>>
>>>>  ????>?????>>>> On 02/21/2018 18:15, Eric McCorkle wrote:
>>>>  ????>?????>>>> > The GELI work could be merged at this point,
>>>> though it
>>>>  ????won't be
>>>>  ????>?????>>usable
>>>>  ????>?????>>>> > without an additional patch to enable loader-
>>>> only
>>>>  ????operation.??The
>>>>  ????>?????>>>> > patches are currently up for review:
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > This is the order in which they'd need to be
>>>> merged:
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > https://reviews.freebsd.org/D12732
>>>>  ????<https://reviews.freebsd.org/D12732>
>>>>  ????>?????<https://reviews.freebsd.org/D12732
>>>>  ????<https://reviews.freebsd.org/D12732>>
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > This one changes the efipart device.??Toomas
>>>> Soome
>>>>  ????identified
>>>>  ????>?????some
>>>>  ????>?????>>>> > problems, which I have addressed.??He has not
>>>>  ????re-reviewed it,
>>>>  ????>?????>>however.
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > https://reviews.freebsd.org/D12692
>>>>  ????<https://reviews.freebsd.org/D12692>
>>>>  ????>?????<https://reviews.freebsd.org/D12692
>>>>  ????<https://reviews.freebsd.org/D12692>>
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > This adds some crypto code needed for GELI.??It
>>>> simply
>>>>  ????adds new
>>>>  ????>?????>>code,
>>>>  ????>?????>>>> > and doesn't conflict with anything.
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > https://reviews.freebsd.org/D12698
>>>>  ????<https://reviews.freebsd.org/D12698>
>>>>  ????>?????<https://reviews.freebsd.org/D12698
>>>>  ????<https://reviews.freebsd.org/D12698>>
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > This adds the EFI KMS interface code, and has
>>>> the EFI
>>>>  ????loader pass
>>>>  ????>?????>>keys
>>>>  ????>?????>>>> > into the keybuf interface.
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > I can't post the main GELI driver until those
>>>> get
>>>>  ????merged, as it
>>>>  ????>?????>>depends
>>>>  ????>?????>>>> > on them.??It can be found on the geli branch on
>>>> my
>>>>  ????github freebsd
>>>>  ????>?????>>>> > repository, however.
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > Additionally, you need this patch, which allows
>>>>  ????loader.efi to
>>>>  ????>?????>>function
>>>>  ????>?????>>>> > when installed directly to the ESP:
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > https://reviews.freebsd.org/D13497
>>>>  ????<https://reviews.freebsd.org/D13497>
>>>>  ????>?????<https://reviews.freebsd.org/D13497
>>>>  ????<https://reviews.freebsd.org/D13497>>
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
>>>>  ????>?????>>>> >> Hi Eric,
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >> could you provide a brief update how the work
>>>> is going?
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >> Br,
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >> Tommi
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
>>>>  ????<eric at metricspace.net <mailto:eric at metricspace.net>
>>>>  ????>?????<mailto:eric at metricspace.net <mailto:eric at metricspace.n
>>>> et>>
>>>>  ????>?????>>>> >> <mailto:eric at metricspace.net
>>>>  ????<mailto:eric at metricspace.net> <mailto:eric at metricspace.net
>>>>  ????<mailto:eric at metricspace.net>>>>
>>>>  ????>?????wrote:
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????Right, so basically, the remaining GELI
>>>> patches
>>>>  ????are against
>>>>  ????>?????>>>> loader, and
>>>>  ????>?????>>>> >>?????most of them can go in independently of the
>>>> work
>>>>  ????on removing
>>>>  ????>?????>>boot1.
>>>>  ????>?????>>>> >>?????There's a unanimous consensus on getting
>>>> rid of
>>>>  ????boot1 which
>>>>  ????>?????>>>> includes its
>>>>  ????>?????>>>> >>?????original author, so that's going to happen.
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????For GELI, we have the following (not
>>>> necessarily
>>>>  ????in order):
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????a) Adding the KMS interfaces, pseudo-
>>>> device, and
>>>>  ????kernel
>>>>  ????>?????>>keybuf
>>>>  ????>?????>>>> >>?????interactions
>>>>  ????>?????>>>> >>?????b) Modifications to the efipart driver
>>>>  ????>?????>>>> >>?????c) boot crypto
>>>>  ????>?????>>>> >>?????d) GELI partition types (not strictly
>>>> necessary)
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????Then there's the GELI driver itself.??(a)
>>>> and (c)
>>> are
>>>>
>>>>  ????>?????good to
>>>>  ????>?????>>>> land, (b)
>>>>  ????>?????>>>> >>?????needs some more work after Toomas Soome
>>>> pointed
>>> out a
>>>>
>>>>  ????>?????>>legitimate
>>>>  ????>?????>>>> >>?????problem, and (d) actually needs a good bit
>>>> more
>>>>  ????code (but
>>>>  ????>?????>>again,
>>>>  ????>?????>>>> it's
>>>>  ????>?????>>>> >>?????more cosmetic).??Additionally, the GELI
>>>> driver
>>>>  ????will need
>>>>  ????>?????>>further
>>>>  ????>?????>>>> mods to
>>>>  ????>?????>>>> >>?????efipart to be written (nothing too
>>>> big).??But we
>>>>  ????could go
>>>>  ????>?????>>ahead
>>>>  ????>?????>>>> with (a)
>>>>  ????>?????>>>> >>?????and (c), as they've already been proven to
>>>> work.
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????I'd wanted to have this stuff shaped up
>>>> sooner,
>>>>  ????but I'm
>>>>  ????>?????>>>> preoccupied with
>>>>  ????>?????>>>> >>?????the 7th RISC-V workshop at the end of the
>>>> month.
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>?????Once this stuff is all in, loader should
>>>> handle
>>>>  ????any GELI
>>>>  ????>?????>>volumes it
>>>>  ????>?????>>>> >>?????finds, and it should Just Work once boot1
>>>> is gone.
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> >>
>>>>  ????>?????>>>> > _______________________________________________
>>>>  ????>?????>>>> > freebsd-current at freebsd.org
>>>>  ????<mailto:freebsd-current at freebsd.org>
>>>>  ????>?????<mailto:freebsd-current at freebsd.org
>>>>  ????<mailto:freebsd-current at freebsd.org>> mailing list
>>>>  ????>?????>>>> > https://lists.freebsd.org/mailman/listinfo/freeb
>>>> sd-
>>> current
>>>>
>>>>  ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
>>>>  ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
>>>> rent
>>>>  ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
>>>>  ????>?????>>>> > To unsubscribe, send any mail to
>>> "freebsd-current-unsubscribe@
>>>>
>>>>  ????>?????>>>> freebsd.org <http://freebsd.org>
>>>> <http://freebsd.org>"
>>>>  ????>?????>>>> >
>>>>  ????>?????>>>>
>>>>  ????>?????>>>
>>>>  ????>?????>
>>>>  ????>?????> --
>>>>  ????>?????> Sent from my Android device with K-9 Mail. Please
>>>> excuse my
>>> brevity.
>>>>
>>>>  ????>?????> _______________________________________________
>>>>  ????>?????> freebsd-current at freebsd.org
>>>>  ????<mailto:freebsd-current at freebsd.org>
>>>>  ????<mailto:freebsd-current at freebsd.org
>>>>  ????<mailto:freebsd-current at freebsd.org>>
>>>>  ????>?????mailing list
>>>>  ????>?????> https://lists.freebsd.org/mailman/listinfo/freebsd-cu
>>>> rrent
>>>>  ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>
>>>>  ????>?????<https://lists.freebsd.org/mailman/listinfo/freebsd-cur
>>>> rent
>>>>  ????<https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
>>>>  ????>?????> To unsubscribe, send any mail to
>>>>  ????>?????"freebsd-current-unsubscribe at freebsd.org
>>>>  ????<mailto:freebsd-current-unsubscribe at freebsd.org>
>>>>  ????>?????<mailto:freebsd-current-unsubscribe at freebsd.org
>>>>  ????<mailto:freebsd-current-unsubscribe at freebsd.org>>"
>>>>  ????>?????>
>>>>  ????>
>>>>  ????>
>>>>
>>>>
>>>
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd
>> .org"

-- 
Allan Jude

From guy.helmer at gmail.com  Mon Jul  9 19:13:44 2018
From: guy.helmer at gmail.com (Guy Helmer)
Date: Mon, 9 Jul 2018 14:13:40 -0500
Subject: How to add su to /rescue ?
In-Reply-To: <201807091154.w69Bs7Ha024391@fire.js.berklix.net>
References: <201807091154.w69Bs7Ha024391@fire.js.berklix.net>
Message-ID: <2ACD0DE9-3C43-48DE-BD5A-E074E1A4740E@gmail.com>


> On Jul 9, 2018, at 6:54 AM, Julian H. Stacey <jhs at berklix.com> wrote:
> 
> Hi current@
> I want to add su to /rescue, but got stuck on pam.
> Old unix su didn't suffer from pam.
> There's no #define in su to turn off pam.
> Man src.conf says WITHOUT_PAM is deprecated & does nothing.
> 
> Can someone please offer a solution ?
> Or better to include a simple BSD su pre pam ?
> I would happily develop a patch for that.


Hi,

Aside from not being able to use pam from a static executable, please don?t try to make the crunched hard-linked executable in /rescue setuid-root (su is useless without it). That would mean anyone running /rescue/sh gets a root shell :-)

Conceptually, a separate crunchgen binary could be made for setuid-root purposes, but having a setuid-root binary in /rescue (outside of the normal hierarchy) makes me nervous.

Regards,
Guy 

> 
> Notes to explain the need, & patches from my
> http://berklix.com/~jhs/src/bsd/fixes/freebsd/src/gen/rescue/
> ---------
> 
> Patch[es] below to solve this emailed scenario:
>> Please on prison-host cp /lib/libc.so.7 /tank/ezjail/my-domain/lib/libc.so.7
>> I am logged in on jail-host, but only as normal-user, not root, so I cannot run
>> 	/rescue/cp /usr/obj/usr/src/lib/libc/libc.so.7 /lib/libc.so.7
>> 
>> a my make installworld on jail-host.my-domain previously failed with
>> 	===> lib/libc (install)
>> 	install -C -o root -g wheel -m 444   libc.a /usr/lib
>> 	install -C -o root -g wheel -m 444   libc_p.a /usr/lib
>> 	install -s -o root -g wheel -m 444   -fschg -S  libc.so.7 /lib
>> 	install: /lib/libc.so.7: chflags: Operation not permitted
>> 	*** Error code 71
>> (might or not be an artifact of being in a jail)
>> 
>> unfortunately I had run the command as
>> 	xs make installworld
>> (xs is my own little root wrapper)
>> so when it exited, I was just normal-user not root, & I had forgotten to
>> open another xterm & leave it logged in as root,
>> & I found no /rescue/su
> 


From imp at bsdimp.com  Mon Jul  9 22:05:29 2018
From: imp at bsdimp.com (Warner Losh)
Date: Mon, 9 Jul 2018 16:05:16 -0600
Subject: GELI with UEFI supporting Boot Environments goes to HEAD when?
In-Reply-To: <06cb8190-7a04-5c92-8fb9-637d1a80758f@freebsd.org>
References: <CABHD1wRyrmXp5R_ViERa-MnJnVKN-U551SWt+ehm6r+3viydxg@mail.gmail.com>
 <0e75a2ba-9a59-8301-a678-68a822025bd6@metricspace.net>
 <CABHD1wS-RoxP5fsCYgH61BsPsad_OPC4FZSUCUi6EfsWyXRzQA@mail.gmail.com>
 <9df63df2-9d61-4106-f360-347411869b41@metricspace.net>
 <f17bbb44-6735-e252-ba75-bd0b4f685d9d@metricspace.net>
 <CABHD1wRu_C4dPvzt+xMsYYYjFNJ1+78ne4cLsuCxr=YrN+hfFA@mail.gmail.com>
 <CANCZdfrkW1yteAixk44DetDe=uetVtvxM9-M7K5FioxeLseHJw@mail.gmail.com>
 <D667242D-ACB8-42E4-85B8-308702C15360@metricspace.net>
 <CAPQ4fftB27Y63yvk9zqEE3q4-MShHOYdwM7aD=c+XKzrs+ZoMw@mail.gmail.com>
 <CANCZdfqZ1qr0Z7eiby6Kvwop_-+3_VZ0hFnCfo7Hm1NN9UbaUA@mail.gmail.com>
 <c0c57711-055a-5d0d-796e-f7acce4be3b4@metricspace.net>
 <CANCZdfpH4z8yhzD_pyJDPy0276FxqQ+pEWcp3HiPe-qhNnrYCw@mail.gmail.com>
 <5ba11024-e99b-86e1-48b7-125fb80b4001@metricspace.net>
 <CAPQ4fftg_8DRmHhsrt3k4660GyiXGQ+Qe+-+OpfitVU5i-jTkA@mail.gmail.com>
 <1531078307.1336.22.camel@freebsd.org>
 <06cb8190-7a04-5c92-8fb9-637d1a80758f@freebsd.org>
Message-ID: <CANCZdfpx8KpeUuvZ-jwmeEe0ds0Hiwrzsfmrj+Sf6ewUU+C=Vw@mail.gmail.com>

I have this in my tree already...

Warner

On Mon, Jul 9, 2018, 10:28 AM Allan Jude <allanjude at freebsd.org> wrote:

> I will look at updating the rootgen.sh script this evening, to support
> creating more flexible ESP partitions, so we can drop the loader.efi
> into an msdosfs directly.
>
> On 07/08/2018 15:31, Ian Lepore wrote:
> > On Sun, 2018-07-08 at 21:08 +0200, Oliver Pinter wrote:
> >> Hi!
> >>
> >> Have you or Warner any update on this code?
> >>
> >> On Thursday, April 12, 2018, Eric McCorkle <eric at metricspace.net>
> >> wrote:
> >>
> >
> > Are you aware of https://reviews.freebsd.org/D15743 ?
> >
> > That's my changes to add geli support to loader(8) in an architecture-
> > agnostic way, so that "it just works" for all platforms and flavors of
> > loader. It has been succesfully tested on armv6/7 (ubldr) and on x86
> > using qemu.  The x86 tests cover ufs and zfs, legacy bios and uefi. The
> > only variations that aren't tested yet are the uefi flavors, because
> > the current rootgen.sh script for assembling test images is still using
> > boot1.efi and I don't know enough about efi myself to update the script
> > to make it assemble images the new way Warner envisions.
> >
> > -- Ian
> >
> >>>
> >>> I'm in the middle of moving to a new apartment right now.  It's
> >>> going to
> >>> be a bit before I can get to this.
> >>>
> >>> On 04/11/2018 20:31, Warner Losh wrote:
> >>>>
> >>>> OK. I've pushed in the main part of it. The additional work I
> >>>> have
> >>>> shouldn't affect any of this stuff.  I was going to look at what
> >>>> part(s)
> >>>> of your open reviewed needed to be redone tomorrow and send you
> >>>> feedback, but if you wanted to get a start before then, I'm happy
> >>>> to
> >>>> answer questions. All the rest of my work is going to be
> >>>> selecting the
> >>>> root partition when we're told to us a specific partition, so
> >>>> will be
> >>>> very constrained.
> >>>>
> >>>> Warner
> >>>>
> >>>> On Wed, Apr 11, 2018 at 6:02 PM, Eric McCorkle <eric at metricspace.
> >>>> net
> >>>> <mailto:eric at metricspace.net>> wrote:
> >>>>
> >>>>      I think the thing to do at this point is to wait for the
> >>>> current
> >>> work on
> >>>>
> >>>>      loader.efi to land, then adapt my patches to apply against
> >>>> that work.
> >>>>
> >>>>      On 04/11/2018 15:06, Warner Losh wrote:
> >>>>      > Still reviewing the code. I'm worried it's too i386
> >>>> specific and it
> >>>>      > conflicts with some work I'm doing. I'll have a list of
> >>>> actionable
> >>>>      > critiques this week.
> >>>>      >
> >>>>      > Warner
> >>>>      >
> >>>>      > On Wed, Apr 11, 2018 at 1:03 PM, Oliver Pinter
> >>>>      > <oliver.pinter at hardenedbsd.org
> >>>>      <mailto:oliver.pinter at hardenedbsd.org>
> >>>>      <mailto:oliver.pinter at hardenedbsd.org
> >>>>      <mailto:oliver.pinter at hardenedbsd.org>>>
> >>>>      > wrote:
> >>>>      >
> >>>>      >     Hi!
> >>>>      >
> >>>>      >     Is there any update regarding the rebase or the
> >>>> inclusion to
> >>> base
> >>>>
> >>>>      >     system?
> >>>>      >     On 3/28/18, Eric McCorkle <eric at metricspace.net
> >>>> <mailto:
> >>> eric at metricspace.net>
> >>>>
> >>>>      >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> >>>> et>>>
> >>> wrote:
> >>>>
> >>>>      >     > I'll do another rebase from head just to be sure
> >>>>      >     >
> >>>>      >     > On March 28, 2018 3:23:23 PM EDT, Warner Losh <
> >>> imp at bsdimp.com <mailto:imp at bsdimp.com>
> >>>>
> >>>>      >     <mailto:imp at bsdimp.com <mailto:imp at bsdimp.com>>> wrote:
> >>>>      >     >>It's on my list for nexr, finally. I have an
> >>>> alternate patch
> >>> for
> >>>>
> >>>>      >     >>loader.efi
> >>>>      >     >>from ESP, but i don't think it will affect the GELI
> >>>> stuff. I
> >>> have some
> >>>>
> >>>>      >     >>time
> >>>>      >     >>slotted for integration issues though.
> >>>>      >     >>
> >>>>      >     >>I am quite mindful of the freeze dates.... I  have
> >>>> some uefi
> >>> boot
> >>>>
> >>>>      >     >>loader
> >>>>      >     >>protocol changes that I need to get in.
> >>>>      >     >>
> >>>>      >     >>Warner
> >>>>      >     >>
> >>>>      >     >>On Feb 21, 2018 11:18 PM, "Tommi Pernila" <
> >>> tommi.pernila at iki.fi <mailto:tommi.pernila at iki.fi>
> >>>>
> >>>>      >     <mailto:tommi.pernila at iki.fi <mailto:tommi.pernila at iki.
> >>>> fi>>>
> >>> wrote:
> >>>>
> >>>>      >     >>
> >>>>      >     >>> Awesome, thanks for the update and the work that
> >>>> you have
> >>> done!
> >>>>
> >>>>      >     >>>
> >>>>      >     >>> Now we just need some more reviewers eyes on the
> >>>> code :)
> >>>>      >     >>>
> >>>>      >     >>> Br,
> >>>>      >     >>>
> >>>>      >     >>> Tommi
> >>>>      >     >>>
> >>>>      >     >>> On Thu, 22 Feb 2018 at 2.03, Eric McCorkle <
> >>> eric at metricspace.net <mailto:eric at metricspace.net>
> >>>>
> >>>>      >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> >>>> et>>>
> >>>>      >     >>wrote:
> >>>>      >     >>>
> >>>>      >     >>>> FYI, I just IFC'ed everything, and the current
> >>>> patches
> >>>>      are still
> >>>>      >     >>fine.
> >>>>      >     >>>>
> >>>>      >     >>>> Also, the full GELI + standalone loader has been
> >>>> deployed
> >>>>      on one of
> >>>>      >     >>my
> >>>>      >     >>>> laptops for some time now.
> >>>>      >     >>>>
> >>>>      >     >>>> On 02/21/2018 18:15, Eric McCorkle wrote:
> >>>>      >     >>>> > The GELI work could be merged at this point,
> >>>> though it
> >>>>      won't be
> >>>>      >     >>usable
> >>>>      >     >>>> > without an additional patch to enable loader-
> >>>> only
> >>>>      operation.  The
> >>>>      >     >>>> > patches are currently up for review:
> >>>>      >     >>>> >
> >>>>      >     >>>> > This is the order in which they'd need to be
> >>>> merged:
> >>>>      >     >>>> >
> >>>>      >     >>>> >
> >>>>      >     >>>> > https://reviews.freebsd.org/D12732
> >>>>      <https://reviews.freebsd.org/D12732>
> >>>>      >     <https://reviews.freebsd.org/D12732
> >>>>      <https://reviews.freebsd.org/D12732>>
> >>>>      >     >>>> >
> >>>>      >     >>>> > This one changes the efipart device.  Toomas
> >>>> Soome
> >>>>      identified
> >>>>      >     some
> >>>>      >     >>>> > problems, which I have addressed.  He has not
> >>>>      re-reviewed it,
> >>>>      >     >>however.
> >>>>      >     >>>> >
> >>>>      >     >>>> >
> >>>>      >     >>>> > https://reviews.freebsd.org/D12692
> >>>>      <https://reviews.freebsd.org/D12692>
> >>>>      >     <https://reviews.freebsd.org/D12692
> >>>>      <https://reviews.freebsd.org/D12692>>
> >>>>      >     >>>> >
> >>>>      >     >>>> > This adds some crypto code needed for GELI.  It
> >>>> simply
> >>>>      adds new
> >>>>      >     >>code,
> >>>>      >     >>>> > and doesn't conflict with anything.
> >>>>      >     >>>> >
> >>>>      >     >>>> >
> >>>>      >     >>>> > https://reviews.freebsd.org/D12698
> >>>>      <https://reviews.freebsd.org/D12698>
> >>>>      >     <https://reviews.freebsd.org/D12698
> >>>>      <https://reviews.freebsd.org/D12698>>
> >>>>      >     >>>> >
> >>>>      >     >>>> > This adds the EFI KMS interface code, and has
> >>>> the EFI
> >>>>      loader pass
> >>>>      >     >>keys
> >>>>      >     >>>> > into the keybuf interface.
> >>>>      >     >>>> >
> >>>>      >     >>>> >
> >>>>      >     >>>> > I can't post the main GELI driver until those
> >>>> get
> >>>>      merged, as it
> >>>>      >     >>depends
> >>>>      >     >>>> > on them.  It can be found on the geli branch on
> >>>> my
> >>>>      github freebsd
> >>>>      >     >>>> > repository, however.
> >>>>      >     >>>> >
> >>>>      >     >>>> >
> >>>>      >     >>>> > Additionally, you need this patch, which allows
> >>>>      loader.efi to
> >>>>      >     >>function
> >>>>      >     >>>> > when installed directly to the ESP:
> >>>>      >     >>>> >
> >>>>      >     >>>> > https://reviews.freebsd.org/D13497
> >>>>      <https://reviews.freebsd.org/D13497>
> >>>>      >     <https://reviews.freebsd.org/D13497
> >>>>      <https://reviews.freebsd.org/D13497>>
> >>>>      >     >>>> >
> >>>>      >     >>>> > On 02/20/2018 22:56, Tommi Pernila wrote:
> >>>>      >     >>>> >> Hi Eric,
> >>>>      >     >>>> >>
> >>>>      >     >>>> >> could you provide a brief update how the work
> >>>> is going?
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>
> >>>>      >     >>>> >> Br,
> >>>>      >     >>>> >>
> >>>>      >     >>>> >> Tommi
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>
> >>>>      >     >>>> >> On Nov 16, 2017 04:29, "Eric McCorkle"
> >>>>      <eric at metricspace.net <mailto:eric at metricspace.net>
> >>>>      >     <mailto:eric at metricspace.net <mailto:eric at metricspace.n
> >>>> et>>
> >>>>      >     >>>> >> <mailto:eric at metricspace.net
> >>>>      <mailto:eric at metricspace.net> <mailto:eric at metricspace.net
> >>>>      <mailto:eric at metricspace.net>>>>
> >>>>      >     wrote:
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     Right, so basically, the remaining GELI
> >>>> patches
> >>>>      are against
> >>>>      >     >>>> loader, and
> >>>>      >     >>>> >>     most of them can go in independently of the
> >>>> work
> >>>>      on removing
> >>>>      >     >>boot1.
> >>>>      >     >>>> >>     There's a unanimous consensus on getting
> >>>> rid of
> >>>>      boot1 which
> >>>>      >     >>>> includes its
> >>>>      >     >>>> >>     original author, so that's going to happen.
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     For GELI, we have the following (not
> >>>> necessarily
> >>>>      in order):
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     a) Adding the KMS interfaces, pseudo-
> >>>> device, and
> >>>>      kernel
> >>>>      >     >>keybuf
> >>>>      >     >>>> >>     interactions
> >>>>      >     >>>> >>     b) Modifications to the efipart driver
> >>>>      >     >>>> >>     c) boot crypto
> >>>>      >     >>>> >>     d) GELI partition types (not strictly
> >>>> necessary)
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     Then there's the GELI driver itself.  (a)
> >>>> and (c)
> >>> are
> >>>>
> >>>>      >     good to
> >>>>      >     >>>> land, (b)
> >>>>      >     >>>> >>     needs some more work after Toomas Soome
> >>>> pointed
> >>> out a
> >>>>
> >>>>      >     >>legitimate
> >>>>      >     >>>> >>     problem, and (d) actually needs a good bit
> >>>> more
> >>>>      code (but
> >>>>      >     >>again,
> >>>>      >     >>>> it's
> >>>>      >     >>>> >>     more cosmetic).  Additionally, the GELI
> >>>> driver
> >>>>      will need
> >>>>      >     >>further
> >>>>      >     >>>> mods to
> >>>>      >     >>>> >>     efipart to be written (nothing too
> >>>> big).  But we
> >>>>      could go
> >>>>      >     >>ahead
> >>>>      >     >>>> with (a)
> >>>>      >     >>>> >>     and (c), as they've already been proven to
> >>>> work.
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     I'd wanted to have this stuff shaped up
> >>>> sooner,
> >>>>      but I'm
> >>>>      >     >>>> preoccupied with
> >>>>      >     >>>> >>     the 7th RISC-V workshop at the end of the
> >>>> month.
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>     Once this stuff is all in, loader should
> >>>> handle
> >>>>      any GELI
> >>>>      >     >>volumes it
> >>>>      >     >>>> >>     finds, and it should Just Work once boot1
> >>>> is gone.
> >>>>      >     >>>> >>
> >>>>      >     >>>> >>
> >>>>      >     >>>> > _______________________________________________
> >>>>      >     >>>> > freebsd-current at freebsd.org
> >>>>      <mailto:freebsd-current at freebsd.org>
> >>>>      >     <mailto:freebsd-current at freebsd.org
> >>>>      <mailto:freebsd-current at freebsd.org>> mailing list
> >>>>      >     >>>> > https://lists.freebsd.org/mailman/listinfo/freeb
> >>>> sd-
> >>> current
> >>>>
> >>>>      <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> >>>>      >     <https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> >>>> rent
> >>>>      <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> >>>>      >     >>>> > To unsubscribe, send any mail to
> >>> "freebsd-current-unsubscribe@
> >>>>
> >>>>      >     >>>> freebsd.org <http://freebsd.org>
> >>>> <http://freebsd.org>"
> >>>>      >     >>>> >
> >>>>      >     >>>>
> >>>>      >     >>>
> >>>>      >     >
> >>>>      >     > --
> >>>>      >     > Sent from my Android device with K-9 Mail. Please
> >>>> excuse my
> >>> brevity.
> >>>>
> >>>>      >     > _______________________________________________
> >>>>      >     > freebsd-current at freebsd.org
> >>>>      <mailto:freebsd-current at freebsd.org>
> >>>>      <mailto:freebsd-current at freebsd.org
> >>>>      <mailto:freebsd-current at freebsd.org>>
> >>>>      >     mailing list
> >>>>      >     > https://lists.freebsd.org/mailman/listinfo/freebsd-cu
> >>>> rrent
> >>>>      <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> >>>>      >     <https://lists.freebsd.org/mailman/listinfo/freebsd-cur
> >>>> rent
> >>>>      <https://lists.freebsd.org/mailman/listinfo/freebsd-current>>
> >>>>      >     > To unsubscribe, send any mail to
> >>>>      >     "freebsd-current-unsubscribe at freebsd.org
> >>>>      <mailto:freebsd-current-unsubscribe at freebsd.org>
> >>>>      >     <mailto:freebsd-current-unsubscribe at freebsd.org
> >>>>      <mailto:freebsd-current-unsubscribe at freebsd.org>>"
> >>>>      >     >
> >>>>      >
> >>>>      >
> >>>>
> >>>>
> >>>
> >> _______________________________________________
> >> freebsd-current at freebsd.org mailing list
> >> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> >> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd
> >> .org"
>
> --
> Allan Jude
>

From marklmi at yahoo.com  Tue Jul 10 15:28:15 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Tue, 10 Jul 2018 08:28:03 -0700
Subject: All the builds on arthur.nyi.freebsd.org seem to be getting
 PostBuildScript having: . . . libpython3.6m.so.1.0: Undefined symbol
 "getrandom@FBSD_1.5"
Message-ID: <01DBB928-E9E1-4E10-933C-B000C3ABF5FE@yahoo.com>


[PostBuildScript] - Executing post build scripts.
[FreeBSD-head-armv6-build] $ /bin/sh -xe /tmp/jenkins5219713071838772045.sh
+ ./freebsd-ci/artifact/post-link.py
/usr/local/lib/libpython3.6m.so.1.0: Undefined symbol "getrandom at FBSD_1.5"
Build step 'Execute Scripts' changed build result to UNSTABLE



I looked around at a bunch of yellow-status vs. green-status builds and
yellow was always from arthur.nyi.freebsd.org in what I looked at. But
I did not eliminate all others in the process. Everything that I found
from arthur.nyi.freebsd.org was yellow-status.

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From lwhsu at freebsd.org  Tue Jul 10 21:50:16 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Wed, 11 Jul 2018 05:49:58 +0800
Subject: All the builds on arthur.nyi.freebsd.org seem to be getting
 PostBuildScript having: . . . libpython3.6m.so.1.0: Undefined symbol
 "getrandom@FBSD_1.5"
In-Reply-To: <01DBB928-E9E1-4E10-933C-B000C3ABF5FE@yahoo.com>
References: <01DBB928-E9E1-4E10-933C-B000C3ABF5FE@yahoo.com>
Message-ID: <CAKBkRUxKKD9WnnvZ=wg6Le3vXB78+PcNTT=JfB7y2Ky=V_v8gw@mail.gmail.com>

On Tue, Jul 10, 2018 at 11:30 PM Mark Millard <marklmi at yahoo.com> wrote:
>
>
> [PostBuildScript] - Executing post build scripts.
> [FreeBSD-head-armv6-build] $ /bin/sh -xe /tmp/jenkins5219713071838772045.sh
> + ./freebsd-ci/artifact/post-link.py
> /usr/local/lib/libpython3.6m.so.1.0: Undefined symbol "getrandom at FBSD_1.5"
> Build step 'Execute Scripts' changed build result to UNSTABLE
>
>
>
> I looked around at a bunch of yellow-status vs. green-status builds and
> yellow was always from arthur.nyi.freebsd.org in what I looked at. But
> I did not eliminate all others in the process. Everything that I found
> from arthur.nyi.freebsd.org was yellow-status.
>

This is because of the ABI incompatible between different versions of
-CURRENT, on pkg build cluster and the arthur.nyi.  It has been fixed.

Thanks,
Li-Wen

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From gurenchan at gmail.com  Wed Jul 11 06:22:55 2018
From: gurenchan at gmail.com (blubee blubeeme)
Date: Wed, 11 Jul 2018 14:22:42 +0800
Subject: Make buildworld fails
Message-ID: <CALM2mEmY+sR2FHXbRULN2cyEndW7fer4kmfZ=MkRkwUK087ptA@mail.gmail.com>

Why am I getting these errors?

error: user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]

----------------------
In file included from /usr/src/usr.sbin/pmc/cmd_pmc_filter.cc:71:
In file included from
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:477:
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:796:29:
error: user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string_view<char> operator "" sv(const char *__str, size_t __len)
_NOEXCEPT
                            ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:802:32:
error: user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string_view<wchar_t> operator "" sv(const wchar_t *__str, size_t
__len) _NOEXCEPT
                               ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:808:33:
error: user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string_view<char16_t> operator "" sv(const char16_t *__str,
size_t __len) _NOEXCEPT
                                ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:814:33:
error: user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string_view<char32_t> operator "" sv(const char32_t *__str,
size_t __len) _NOEXCEPT
                                ^
In file included from /usr/src/usr.sbin/pmc/cmd_pmc_filter.cc:71:
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4046:24: error:
user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string<char> operator "" s( const char *__str, size_t __len )
                       ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4052:27: error:
user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string<wchar_t> operator "" s( const wchar_t *__str, size_t __len
)
                          ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4058:28: error:
user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string<char16_t> operator "" s( const char16_t *__str, size_t
__len )
                           ^
/usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4064:28: error:
user-defined literal suffixes not starting with '_' are reserved
[-Werror,-Wuser-defined-literals]
    basic_string<char32_t> operator "" s( const char32_t *__str, size_t
__len )
                           ^
8 errors generated.
*** Error code 1

From freebsd at grem.de  Wed Jul 11 08:09:48 2018
From: freebsd at grem.de (Michael Gmelin)
Date: Wed, 11 Jul 2018 10:09:38 +0200
Subject: Make buildworld fails
In-Reply-To: <CALM2mEmY+sR2FHXbRULN2cyEndW7fer4kmfZ=MkRkwUK087ptA@mail.gmail.com>
References: <CALM2mEmY+sR2FHXbRULN2cyEndW7fer4kmfZ=MkRkwUK087ptA@mail.gmail.com>
Message-ID: <FF9BC365-15C5-4177-9BD1-4BB4CD01722E@grem.de>



> On 11. Jul 2018, at 08:22, blubee blubeeme <gurenchan at gmail.com> wrote:
> 
> Why am I getting these errors?
> 
> error: user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
> 
> ----------------------
> In file included from /usr/src/usr.sbin/pmc/cmd_pmc_filter.cc:71:
> In file included from
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:477:
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:796:29:
> error: user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string_view<char> operator "" sv(const char *__str, size_t __len)
> _NOEXCEPT
>                            ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:802:32:
> error: user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string_view<wchar_t> operator "" sv(const wchar_t *__str, size_t
> __len) _NOEXCEPT
>                               ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:808:33:
> error: user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string_view<char16_t> operator "" sv(const char16_t *__str,
> size_t __len) _NOEXCEPT
>                                ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string_view:814:33:
> error: user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string_view<char32_t> operator "" sv(const char32_t *__str,
> size_t __len) _NOEXCEPT
>                                ^
> In file included from /usr/src/usr.sbin/pmc/cmd_pmc_filter.cc:71:
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4046:24: error:
> user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string<char> operator "" s( const char *__str, size_t __len )
>                       ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4052:27: error:
> user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string<wchar_t> operator "" s( const wchar_t *__str, size_t __len
> )
>                          ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4058:28: error:
> user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string<char16_t> operator "" s( const char16_t *__str, size_t
> __len )
>                           ^
> /usr/obj/usr/src/amd64.amd64/tmp/usr/include/c++/v1/string:4064:28: error:
> user-defined literal suffixes not starting with '_' are reserved
> [-Werror,-Wuser-defined-literals]
>    basic_string<char32_t> operator "" s( const char32_t *__str, size_t
> __len )
>                           ^
> 8 errors generated.
> *** Error code 1
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


Which version/checkout (svn info and svn status), how do you build (and where), what does your /etc/make.conf look like?

From tech-lists at zyxst.net  Wed Jul 11 11:42:58 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Wed, 11 Jul 2018 12:42:54 +0100
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
Message-ID: <a68f6312-c9a3-2e5e-2216-bfa3b1df9a70@zyxst.net>

Hello lists [x-posted to -current where it's also relevant]

12-current-arm64 fails to build generic-nodebug kernel

context:
12.0-CURRENT #0 r336134: Mon Jul  9 GENERIC arm64 (this is the older rpi3B+)

root at rpi3:/usr/src# svnlite info
Path: .
Working Copy Root Path: /ext/src
URL: https://svn.freebsd.org/base/head
Relative URL: ^/head
Repository Root: https://svn.freebsd.org/base
Repository UUID: ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f
Revision: 336195
Node Kind: directory
Schedule: normal
Last Changed Author: eugen
Last Changed Rev: 336195
Last Changed Date: 2018-07-11 10:41:50 +0100 (Wed, 11 Jul 2018)

Some dirs on /usr are symlinked to a 1TB external disk. Swap is on the 
external disk. Made sure there was no src.conf or make.conf present:

root at rpi3:/root# cd /etc
root at rpi3:/etc# mv src.conf old.src.conf
root at rpi3:/etc# mv make.conf old.make.conf
root at rpi3:/etc# cd /usr/src

root at rpi3:/usr/src# rm -rf /ext/obj
root at rpi3:/usr/src# mkdir /ext/obj
root at rpi3:/usr/src# ls -lah /usr
total 72
drwxr-xr-x  12 root  wheel   512B Jul 10 11:15 .
drwxr-xr-x  20 root  wheel   512B Jul 10 18:45 ..
drwxr-xr-x   2 root  wheel   7.5K Jul  9 20:45 bin
drwxr-xr-x   2 root  wheel   512B Jul 10 11:15 home
drwxr-xr-x  56 root  wheel   6.5K Jul  9 20:44 include
drwxr-xr-x  10 root  wheel    16K Jul  9 20:45 lib
drwxr-xr-x   5 root  wheel   512B Jul  9 20:28 lib32
drwxr-xr-x   5 root  wheel   512B Jul  9 20:28 libdata
drwxr-xr-x   9 root  wheel   1.5K Jul  9 20:45 libexec
lrwxr-xr-x   1 root  wheel    10B Jul 10 11:43 local -> /ext/local
lrwxr-xr-x   1 root  wheel     8B Jul 10 11:41 obj -> /ext/obj
lrwxr-xr-x   1 root  wheel    10B Jul 10 11:41 ports -> /ext/ports
drwxr-xr-x   2 root  wheel   5.0K Jul  9 20:45 sbin
drwxr-xr-x  29 root  wheel   512B Jul  9 20:28 share
lrwxr-xr-x   1 root  wheel     8B Jul 10 11:41 src -> /ext/src
drwxr-xr-x  15 root  wheel   512B Jul  9 20:46 tests

root at rpi3:/usr/src# make -j10 cleanworld && make -j10 cleandir && make 
-j10 clean <--- just to make absolutely sure

[...]

RPI3 is just a copy of GENERIC-NODEBUG. it looks like this:

include GENERIC

ident   RPI3

nooptions       INVARIANTS
nooptions       INVARIANT_SUPPORT
nooptions       WITNESS
nooptions       WITNESS_SKIPSPIN
nooptions       DEADLKRES
nooptions       USB_DEBUG

root at rpi3:/usr/src# make -j1 buildkernel KERNCONF=RPI3

[...]

===> armv8crypto (all)
[Creating objdir 
/ext/obj/ext/src/arm64.aarch64/sys/RPI3/modules/ext/src/sys/modules/armv8crypto...]
machine -> /ext/src/sys/arm64/include
ln -sf /ext/obj/ext/src/arm64.aarch64/sys/RPI3/opt_bus.h opt_bus.h
awk -f /ext/src/sys/tools/makeobjops.awk /ext/src/sys/kern/device_if.m -h
awk -f /ext/src/sys/tools/makeobjops.awk /ext/src/sys/kern/bus_if.m -h
awk -f /ext/src/sys/tools/makeobjops.awk 
/ext/src/sys/opencrypto/cryptodev_if.m -h
cc -target aarch64-unknown-freebsd12.0 
--sysroot=/ext/obj/ext/src/arm64.aarch64/tmp 
-B/ext/obj/ext/src/arm64.aarch64/tmp/usr/bin -c -O2 -pipe 
-fno-strict-aliasing -Werror -D_KERNEL -DKLD_MODULE -DKLD_TIED -nostdinc 
-DHAVE_KERNEL_OPTION_HEADERS -include 
/ext/obj/ext/src/arm64.aarch64/sys/RPI3/opt_global.h -I. -I/ext/src/sys 
-I/ext/src/sys/contrib/ck/include -g -fPIC 
-I/ext/obj/ext/src/arm64.aarch64/sys/RPI3 -MD -MF.depend.genoffset.o 
-MTgenoffset.o -mgeneral-regs-only -ffixed-x18 -ffreestanding -fwrapv 
-fstack-protector -gdwarf-2 -Wall -Wredundant-decls -Wnested-externs 
-Wstrict-prototypes -Wmissing-prototypes -Wpointer-arith -Wcast-qual 
-Wundef -Wno-pointer-sign -D__printf__=__freebsd_kprintf__ 
-Wmissing-include-dirs -fdiagnostics-show-option -Wno-unknown-pragmas 
-Wno-error-tautological-compare -Wno-error-empty-body 
-Wno-error-parentheses-equality -Wno-error-unused-function 
-Wno-error-pointer-sign -Wno-error-shift-negative-value 
-Wno-address-of-packed-member -std=iso9899:1999 
/ext/src/sys/kern/genoffset.c
sh /ext/src/sys/kern/genoffset.sh genoffset.o > offset.inc
cc -target aarch64-unknown-freebsd12.0 
--sysroot=/ext/obj/ext/src/arm64.aarch64/tmp 
-B/ext/obj/ext/src/arm64.aarch64/tmp/usr/bin  -O2 -pipe 
-fno-strict-aliasing -Werror -D_KERNEL -DKLD_MODULE -DKLD_TIED -nostdinc 
   -DHAVE_KERNEL_OPTION_HEADERS -include 
/ext/obj/ext/src/arm64.aarch64/sys/RPI3/opt_global.h -I. -I/ext/src/sys 
-I/ext/src/sys/contrib/ck/include -fno-common -g -fPIC 
-I/ext/obj/ext/src/arm64.aarch64/sys/RPI3   -MD 
-MF.depend.armv8_crypto.o -MTarmv8_crypto.o -mgeneral-regs-only 
-ffixed-x18 -ffreestanding -fwrapv -fstack-protector -gdwarf-2 -Wall 
-Wredundant-decls -Wnested-externs -Wstrict-prototypes 
-Wmissing-prototypes -Wpointer-arith -Wcast-qual -Wundef 
-Wno-pointer-sign -D__printf__=__freebsd_kprintf__ 
-Wmissing-include-dirs -fdiagnostics-show-option -Wno-unknown-pragmas 
-Wno-error-tautological-compare -Wno-error-empty-body 
-Wno-error-parentheses-equality -Wno-error-unused-function 
-Wno-error-pointer-sign -Wno-error-shift-negative-value 
-Wno-address-of-packed-member    -std=iso9899:1999 -c 
/ext/src/sys/crypto/armv8/armv8_crypto.c -o armv8_crypto.o
ctfconvert -L VERSION -g armv8_crypto.o
cc -target aarch64-unknown-freebsd12.0 
--sysroot=/ext/obj/ext/src/arm64.aarch64/tmp 
-B/ext/obj/ext/src/arm64.aarch64/tmp/usr/bin -c -O3 -pipe 
-fno-strict-aliasing -Werror -D_KERNEL -DKLD_MODULE -DKLD_TIED 
-DHAVE_KERNEL_OPTION_HEADERS -include 
/ext/obj/ext/src/arm64.aarch64/sys/RPI3/opt_global.h -I. -I/ext/src/sys 
-I/ext/src/sys/contrib/ck/include -fno-common -g -fPIC 
-I/ext/obj/ext/src/arm64.aarch64/sys/RPI3 -ffixed-x18 -ffreestanding 
-fwrapv -fstack-protector -gdwarf-2 -Wall -Wredundant-decls 
-Wnested-externs -Wstrict-prototypes -Wmissing-prototypes 
-Wpointer-arith -Wcast-qual -Wundef -Wno-pointer-sign 
-D__printf__=__freebsd_kprintf__ -Wmissing-include-dirs 
-fdiagnostics-show-option -Wno-unknown-pragmas 
-Wno-error-tautological-compare -Wno-error-empty-body 
-Wno-error-parentheses-equality -Wno-error-unused-function 
-Wno-error-pointer-sign -Wno-error-shift-negative-value 
-Wno-address-of-packed-member -std=iso9899:1999  -Werror 
-march=armv8-a+crypto /ext/src/sys/crypto/armv8/armv8_crypto_wrap.c
In file included from /ext/src/sys/crypto/armv8/armv8_crypto_wrap.c:46:
/usr/lib/clang/6.0.1/include/arm_neon.h:31:10: fatal error: 'stdint.h' 
file not found
#include <stdint.h>
          ^~~~~~~~~~
1 error generated.
*** [armv8_crypto_wrap.o] Error code 1

make[4]: stopped in /ext/src/sys/modules/armv8crypto
1 error

make[4]: stopped in /ext/src/sys/modules/armv8crypto
*** [all_subdir_armv8crypto] Error code 2

make[3]: stopped in /ext/src/sys/modules
1 error

make[3]: stopped in /ext/src/sys/modules
*** [modules-all] Error code 2

make[2]: stopped in /ext/obj/ext/src/arm64.aarch64/sys/RPI3
1 error

make[2]: stopped in /ext/obj/ext/src/arm64.aarch64/sys/RPI3
*** [buildkernel] Error code 2

make[1]: stopped in /ext/src
1 error

make[1]: stopped in /ext/src
*** [buildkernel] Error code 2

make: stopped in /ext/src
1 error

make: stopped in /ext/src


-- 
J.

From marklmi at yahoo.com  Wed Jul 11 16:21:24 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Wed, 11 Jul 2018 09:21:17 -0700
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
Message-ID: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>

tech-lists tech-lists at zyxst.net wrote on
Wed Jul 11 11:42:58 UTC 2018 :

> Hello lists [x-posted to -current where it's also relevant]
> 
> 12-current-arm64 fails to build generic-nodebug kernel
> 
> context:
> 12.0-CURRENT #0 r336134: Mon Jul  9 GENERIC arm64 (this is the older rpi3B+)
> 
> 
> root at rpi3
> :/usr/src# svnlite info
> Path: .
> Working Copy Root Path: /ext/src
> URL: 
> https://svn.freebsd.org/base/head
> 
> Relative URL: ^/head
> Repository Root: 
> https://svn.freebsd.org/base
> 
> Repository UUID: ccf9f872-aa2e-dd11-9fc8-001c23d0bc1f
> Revision: 336195
> Node Kind: directory
> Schedule: normal
> Last Changed Author: eugen
> Last Changed Rev: 336195
> Last Changed Date: 2018-07-11 10:41:50 +0100 (Wed, 11 Jul 2018)
> 
> Some dirs on /usr are symlinked to a 1TB external disk. Swap is on the 
> external disk. Made sure there was no src.conf or make.conf present:
> 
> 
> root at rpi3
> :/root# cd /etc
> 
> root at rpi3
> :/etc# mv src.conf old.src.conf
> 
> root at rpi3
> :/etc# mv make.conf old.make.conf
> 
> root at rpi3
> :/etc# cd /usr/src
> 
> 
> root at rpi3
> :/usr/src# rm -rf /ext/obj
> 
> root at rpi3
> :/usr/src# mkdir /ext/obj
> 
> root at rpi3
> :/usr/src# ls -lah /usr
> total 72
> drwxr-xr-x  12 root  wheel   512B Jul 10 11:15 .
> drwxr-xr-x  20 root  wheel   512B Jul 10 18:45 ..
> drwxr-xr-x   2 root  wheel   7.5K Jul  9 20:45 bin
> drwxr-xr-x   2 root  wheel   512B Jul 10 11:15 home
> drwxr-xr-x  56 root  wheel   6.5K Jul  9 20:44 include
> drwxr-xr-x  10 root  wheel    16K Jul  9 20:45 lib
> drwxr-xr-x   5 root  wheel   512B Jul  9 20:28 lib32
> drwxr-xr-x   5 root  wheel   512B Jul  9 20:28 libdata
> drwxr-xr-x   9 root  wheel   1.5K Jul  9 20:45 libexec
> lrwxr-xr-x   1 root  wheel    10B Jul 10 11:43 local -> /ext/local
> lrwxr-xr-x   1 root  wheel     8B Jul 10 11:41 obj -> /ext/obj
> lrwxr-xr-x   1 root  wheel    10B Jul 10 11:41 ports -> /ext/ports
> drwxr-xr-x   2 root  wheel   5.0K Jul  9 20:45 sbin
> drwxr-xr-x  29 root  wheel   512B Jul  9 20:28 share
> lrwxr-xr-x   1 root  wheel     8B Jul 10 11:41 src -> /ext/src
> drwxr-xr-x  15 root  wheel   512B Jul  9 20:46 tests
> 
> 
> root at rpi3
> :/usr/src# make -j10 cleanworld && make -j10 cleandir && make 
> -j10 clean <--- just to make absolutely sure
> 
> [...]
> 
> RPI3 is just a copy of GENERIC-NODEBUG. it looks like this:
> 
> include GENERIC
> 
> ident   RPI3
> 
> nooptions       INVARIANTS
> nooptions       INVARIANT_SUPPORT
> nooptions       WITNESS
> nooptions       WITNESS_SKIPSPIN
> nooptions       DEADLKRES
> nooptions       USB_DEBUG
> 
> 
> root at rpi3
> :/usr/src# make -j1 buildkernel KERNCONF=RPI3
> 
> [...]


[Like a answered in freebsd-arm . . .]

Bugzilla 220125 (from over a year ago) is a non-fixed report about this for
the likes of:

make kernel-toolchain buildkernel

Over the time since then the workaround was to use:

make buildworld buildkernel

buildworld put the needed stdint.h in place, kernel-toolchain
did not.

If kernel-toolchain was in use, then the recent bugzilla 229702
and this exchange is a duplicate. If buildworld was in use then
229702 and this exchange is new.

[Added note . . .]

It seems from the quoted material that neither kernel-toolchain nor
build world was done before buildkernel . My understanding is that
the intent is that one or the other be done first. (But for aarch64
currently only buildworld works.)



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From tech-lists at zyxst.net  Thu Jul 12 09:44:11 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Thu, 12 Jul 2018 10:44:00 +0100
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
Message-ID: <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>

On 11/07/2018 17:21, Mark Millard wrote:
> It seems from the quoted material that neither kernel-toolchain nor
> build world was done before buildkernel . My understanding is that
> the intent is that one or the other be done first. (But for aarch64
> currently only buildworld works.)

Thanks for this. I'm running a buildworld now.

For how long has it been the case that buildworld is needed for 
buildkernel? Coming from amd64 and before that, i386, in situations 
where I've only wanted to install a custom kernel, I was firstly used to 
making and installing it from /sys/{i386,amd64}/conf. Then that broke a 
number of years ago. Then got used to making kernel in /usr/src with 
make buildkernel && make installkernel. And now this is broken, on 
aarch64-arm64. Nobody knows if it's accidental or policy.

-- 
J.

From Alexander at leidinger.net  Thu Jul 12 12:43:15 2018
From: Alexander at leidinger.net (Alexander Leidinger)
Date: Thu, 12 Jul 2018 14:42:29 +0200
Subject: Deadlocks / hangs in ZFS
In-Reply-To: <20180604223108.Horde.RcVquaVKWdNzNidD_5aJz7E@webmail.leidinger.net>
References: <20180522101749.Horde.Wxz9gSxx1xArxkYMQqTL0iZ@webmail.leidinger.net>
 <fa263af4-9bf7-88f8-8d23-21456daf7960@FreeBSD.org>
 <20180522122924.GC1954@zxy.spb.ru>
 <20180522161632.Horde.ROSnBoZixBoE9ZBGp5VBQgZ@webmail.leidinger.net>
 <20180522144055.GD1954@zxy.spb.ru> <20180527194159.v54ox3vlthpuvx4q@jo>
 <20180527220612.GK1926@zxy.spb.ru>
 <20180528090201.Horde._E4JZcuEaZHfj_BNzWjci2O@webmail.leidinger.net>
 <20180603211450.Horde.pI-Fom6S1tUcaHvTF4MUjin@webmail.leidinger.net>
 <20180603192814.GP1926@zxy.spb.ru>
 <20180604223108.Horde.RcVquaVKWdNzNidD_5aJz7E@webmail.leidinger.net>
Message-ID: <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>


Quoting Alexander Leidinger <Alexander at leidinger.net> (from Mon, 04  
Jun 2018 22:31:08 +0200):

> Quoting Slawa Olhovchenkov <slw at zxy.spb.ru> (from Sun, 3 Jun 2018  
> 22:28:14 +0300):
>
>> On Sun, Jun 03, 2018 at 09:14:50PM +0200, Alexander Leidinger wrote:
>>
>>> Quoting Alexander Leidinger <Alexander at leidinger.net> (from Mon, 28
>>> May 2018 09:02:01 +0200):
>>>
>>>> Quoting Slawa Olhovchenkov <slw at zxy.spb.ru> (from Mon, 28 May 2018
>>>> 01:06:12 +0300):
>>>>
>>>>> On Sun, May 27, 2018 at 09:41:59PM +0200, Kirill Ponomarev wrote:
>>>>>
>>>>>> On 05/22, Slawa Olhovchenkov wrote:
>>>>>>> > It has been a while since I tried Karl's patch the last time, and I
>>>>>>> > stopped because it didn't apply to -current anymore at some point.
>>>>>>> > Will what is provided right now in the patch work on -current?
>>>>>>>
>>>>>>> I am mean yes, after s/vm_cnt.v_free_count/vm_free_count()/g
>>>>>>> I am don't know how to have two distinct patch (for stable and
>>>>>>> current) in one review.
>>>>>>
>>>>>> I'm experiencing these issues sporadically as well, would you mind
>>>>>> to publish this patch for fresh current?
>>>>>
>>>>> Week ago I am adopt and publish patch to fresh current and stable, is
>>>>> adopt need again?
>>>>
>>>> I applied the patch in the review yesterday to rev 333966, it
>>>> applied OK (with some fuzz). I will try to reproduce my issue with
>>>> the patch.
>>>
>>> The behavior changed (or the system was long enough in this state
>>> without me noticing it). I have a panic now:
>>> panic: deadlkres: possible deadlock detected for 0xfffff803766db580,
>>> blocked for 1803003 ticks
>>
>> Hmm, may be first determinate locked function
>>
>> addr2line -ie /boot/kernel/kernel 0xfffff803766db580
>>
>> or
>>
>> kgdb
>> x/10i 0xfffff803766db580
>
> Both don'T produce any sensible output:
> (kgdb) x/10i 0xfffff803766db580
> 0xfffff803766db580:     subb   $0x80,-0x78(%rsi)
> 0xfffff803766db584:     (bad)
> 0xfffff803766db585:     (bad)
> 0xfffff803766db586:     (bad)
> 0xfffff803766db587:     incl   -0x7f7792(%rax)
> 0xfffff803766db58d:     (bad)
> 0xfffff803766db58e:     (bad)
> 0xfffff803766db58f:     incl   -0x7f7792(%rax)
> 0xfffff803766db595:     (bad)
> 0xfffff803766db596:     (bad)
>
>
> Seems I need to provoke a real kernel dump instead of a textdump for this.

Finally... time to recompile the kernel with crashdump-compress  
support and changing from textdump to normal dump and to install a  
recent gdb from ports...

The dump is with r336194 and the zfs patch as of 20180527.

---snip---
# kgdb -c /var/crash/vmcore.2 /boot/kernel/kernel
GNU gdb (GDB) 8.1 [GDB v8.1 for FreeBSD]
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.  Type "show copying"
and "show warranty" for details.
This GDB was configured as "x86_64-portbld-freebsd12.0".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
<http://www.gnu.org/software/gdb/documentation/>.
For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from /boot/kernel/kernel...Reading symbols from  
/usr/lib/debug//boot/kernel/kernel.debug...done.
done.

Unread portion of the kernel message buffer:


Fatal trap 12: page fault while in kernel mode
cpuid = 1; apic id = 01
fault virtual address   = 0x20
fault code              = supervisor read data, page not present
instruction pointer     = 0x20:0xffffffff81391fbe
stack pointer           = 0x0:0xfffffe0000457b10
frame pointer           = 0x0:0xfffffe0000457bb0
code segment            = base 0x0, limit 0xfffff, type 0x1b
                         = DPL 0, pres 1, long 1, def32 0, gran 1
processor eflags        = interrupt enabled, resume, IOPL = 0
current process         = 15 (arc_reclaim_thread)
trap number             = 12
panic: page fault
cpuid = 1
time = 1531394214
KDB: stack backtrace:
db_trace_self_wrapper() at db_trace_self_wrapper+0x2b/frame 0xfffffe00004577d0
vpanic() at vpanic+0x1a3/frame 0xfffffe0000457830
panic() at panic+0x43/frame 0xfffffe0000457890
trap_fatal() at trap_fatal+0x35f/frame 0xfffffe00004578e0
trap_pfault() at trap_pfault+0x62/frame 0xfffffe0000457930
trap() at trap+0x2ba/frame 0xfffffe0000457a40
calltrap() at calltrap+0x8/frame 0xfffffe0000457a40
--- trap 0xc, rip = 0xffffffff81391fbe, rsp = 0xfffffe0000457b10, rbp  
= 0xfffffe0000457bb0 ---
arc_reclaim_thread() at arc_reclaim_thread+0x42e/frame 0xfffffe0000457bb0
fork_exit() at fork_exit+0x84/frame 0xfffffe0000457bf0
fork_trampoline() at fork_trampoline+0xe/frame 0xfffffe0000457bf0
--- trap 0, rip = 0, rsp = 0, rbp = 0 ---
Uptime: 38m3s
Dumping 2378 out of 8037 MB:..1%..11%..21%..31%..41%..51%..61%..71%..81%..91%

__curthread () at ./machine/pcpu.h:230
230             __asm("movq %%gs:%1,%0" : "=r" (td)
(kgdb) bt
#0  __curthread () at ./machine/pcpu.h:230
#1  doadump (textdump=1) at /usr/src/sys/kern/kern_shutdown.c:366
#2  0xffffffff80485e11 in kern_reboot (howto=260) at  
/usr/src/sys/kern/kern_shutdown.c:446
#3  0xffffffff804863f3 in vpanic (fmt=<optimized out>, ap=0xfffffe0000457870)
     at /usr/src/sys/kern/kern_shutdown.c:863
#4  0xffffffff80486443 in panic (fmt=<unavailable>) at  
/usr/src/sys/kern/kern_shutdown.c:790
#5  0xffffffff8075279f in trap_fatal (frame=0xfffffe0000457a50,  
eva=32) at /usr/src/sys/amd64/amd64/trap.c:892
#6  0xffffffff80752812 in trap_pfault (frame=0xfffffe0000457a50,  
usermode=<optimized out>)
     at /usr/src/sys/amd64/amd64/trap.c:728
#7  0xffffffff80751e1a in trap (frame=0xfffffe0000457a50) at  
/usr/src/sys/amd64/amd64/trap.c:427
#8  <signal handler called>
#9  0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
     at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532
#10 arc_reclaim_thread (unused=<optimized out>)
     at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4657
#11 0xffffffff8044ca74 in fork_exit (callout=0xffffffff81391b90  
<arc_reclaim_thread>, arg=0x0,
     frame=0xfffffe0000457c00) at /usr/src/sys/kern/kern_fork.c:1057
#12 <signal handler called>
(kgdb) up 9
#9  0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
     at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532
4532                    lowest +=  
uma_zone_get_free_size(zio_data_buf_cache[n]->kc_zone);
(kgdb) list
4527            int                     iter = 4;
4528            int                     step = 1 << (SPA_MAXBLOCKSHIFT  
- SPA_MINBLOCKSHIFT - 3);
4529            int                     n = (SPA_MAXBLOCKSIZE >>  
SPA_MINBLOCKSHIFT) - 1;
4530
4531            while (n >= 0) {
4532                    lowest +=  
uma_zone_get_free_size(zio_data_buf_cache[n]->kc_zone);
4533                    if (lowest >= 0)
4534                            return lowest;
4535                    n -= step;
4536                    if(--iter == 0) {
(kgdb) print n
$1 = 32767
(kgdb) print zio_data_buf_cache[n]
$2 = (kmem_cache_t *) 0x0
(kgdb)

---snip---

Bye,
Alexander.

-- 
http://www.Leidinger.net Alexander at Leidinger.net: PGP 0x8F31830F9F2772BF
http://www.FreeBSD.org    netchild at FreeBSD.org  : PGP 0x8F31830F9F2772BF
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 819 bytes
Desc: Digitale PGP-Signatur
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180712/22a3e36f/attachment.sig>

From marklmi at yahoo.com  Thu Jul 12 13:34:02 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 12 Jul 2018 06:23:49 -0700
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
Message-ID: <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>

On 2018-Jul-12, at 2:44 AM, tech-lists <tech-lists at zyxst.net> wrote:

> On 11/07/2018 17:21, Mark Millard wrote:
>> It seems from the quoted material that neither kernel-toolchain nor
>> build world was done before buildkernel . My understanding is that
>> the intent is that one or the other be done first. (But for aarch64
>> currently only buildworld works.)
> 
> Thanks for this. I'm running a buildworld now.
> 
> For how long has it been the case that buildworld is needed for buildkernel? Coming from amd64 and before that, i386, in situations where I've only wanted to install a custom kernel, I was firstly used to making and installing it from /sys/{i386,amd64}/conf. Then that broke a number of years ago. Then got used to making kernel in /usr/src with make buildkernel && make installkernel. And now this is broken, on aarch64-arm64. Nobody knows if it's accidental or policy.

It has been true since clang added use of stdint.h to the kernel build.
Prior to this stdint.h was  not needed to build the kernel for any
architecture (as far as I know).

As I remember, in C99 or later stdint.h is one of the headers
required for a conforming freestanding implementation of C99+.

stdint.h was added to C in C99. It was intended to be the subset
of the older inttypes.h that was suitable for freestanding
environments. inttypes.h is defined to include stdint.h for
C99 and later as I remember (or to behave as-if it had?).

https://www.freebsd.org/cgi/man.cgi?build(7) is very explicit about what
is supposed to be the case relative to kernel-toolchain use:

     kernel-toolchain  Rebuild the tools needed	for kernel compilation.	 Use
		       this if you did not do a	buildworld first.

In other words: buildkernel is not intended to be self-contained/sufficient
according to the build documentation but buildworld should not be required.

Note the difference in the buildkernel and buildworld descriptions, given
the above:

     buildkernel       Rebuild the kernel and the kernel modules.  The object
		       directory can be	changed	from the default /usr/obj by
		       setting the MAKEOBJDIRPREFIX make(1) variable.

vs.

     buildworld	      Build everything but the kernel, configure files in etc,
		      and release.  The	object directory can be	changed	from
		      the default /usr/obj by setting the MAKEOBJDIRPREFIX
		      make(1) variable.	 The actual build location prefix used
		      is ${MAKEOBJDIRPREFIX}${.CURDIR} for native builds, and
		      ${MAKEOBJDIRPREFIX}/${TARGET}${.CURDIR} for cross	builds
		      and native builds	with variable CROSS_BUILD_TESTING set.


Currently, overall, FreeBSD does not meet its own criteria for aarch64 relative
to kernel-toolchain .

As far as I can tell the issue can be summarized relative to kernel-toolchain
by saying that kernel-toolchain does not currently establish a (full)
freestanding C99 environment relative to the headers but clang requires
(at least) one of the missing items ( stdint.h ) for aarch64.

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From dim at FreeBSD.org  Thu Jul 12 18:32:48 2018
From: dim at FreeBSD.org (Dimitry Andric)
Date: Thu, 12 Jul 2018 20:32:30 +0200
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
Message-ID: <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>

On 12 Jul 2018, at 15:23, Mark Millard via freebsd-toolchain <freebsd-toolchain at freebsd.org> wrote:
> 
> On 2018-Jul-12, at 2:44 AM, tech-lists <tech-lists at zyxst.net> wrote:
> 
>> On 11/07/2018 17:21, Mark Millard wrote:
>>> It seems from the quoted material that neither kernel-toolchain nor
>>> build world was done before buildkernel . My understanding is that
>>> the intent is that one or the other be done first. (But for aarch64
>>> currently only buildworld works.)
>> 
>> Thanks for this. I'm running a buildworld now.
>> 
>> For how long has it been the case that buildworld is needed for buildkernel? Coming from amd64 and before that, i386, in situations where I've only wanted to install a custom kernel, I was firstly used to making and installing it from /sys/{i386,amd64}/conf. Then that broke a number of years ago. Then got used to making kernel in /usr/src with make buildkernel && make installkernel. And now this is broken, on aarch64-arm64. Nobody knows if it's accidental or policy.
> 
> It has been true since clang added use of stdint.h to the kernel build.
> Prior to this stdint.h was  not needed to build the kernel for any
> architecture (as far as I know).

No, it's because sys/crypto/armv8/armv8_crypto_wrap.c includes
<arm_neon.h>, an intrinsics header, which in turn requires <stdint.h>.

This was introduced in https://svnweb.freebsd.org/changeset/base/308921,
and at the time resulted in similar build failures, specifically when
one attempted to build a new kernel, without building world or a new
toolchain first.

-Dimitry

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 223 bytes
Desc: Message signed with OpenPGP
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180712/08d1755b/attachment.sig>

From jhs at berklix.com  Thu Jul 12 18:58:13 2018
From: jhs at berklix.com (Julian H. Stacey)
Date: Thu, 12 Jul 2018 20:57:07 +0200
Subject: How to add su to /rescue ?
In-Reply-To: Your message "Mon, 09 Jul 2018 14:13:40 -0500."
 <2ACD0DE9-3C43-48DE-BD5A-E074E1A4740E@gmail.com>
Message-ID: <201807121857.w6CIv7TX089208@fire.js.berklix.net>

Guy Helmer wrote:
> > On Jul 9, 2018, at 6:54 AM, Julian H. Stacey <jhs at berklix.com> wrote:
> > Hi current@
> > I want to add su to /rescue, but got stuck on pam.
> > Old unix su didn't suffer from pam.
> > There's no #define in su to turn off pam.
> > Man src.conf says WITHOUT_PAM is deprecated & does nothing.
> > 
> > Can someone please offer a solution ?
> > Or better to include a simple BSD su pre pam ?
> > I would happily develop a patch for that.
> Hi,
> Aside from not being able to use pam from a static executable, please don???t try to make the crunched hard-linked executable in /rescue setuid-root (su is useless without it). That would mean anyone running /rescue/sh gets a root shell :-)

Thanks Guy !  Yes all SUID 0 would be very wrong.


> Conceptually, a separate crunchgen binary could be made for setuid-root purposes, but having a setuid-root binary in /rescue (outside of the normal hierarchy) makes me nervous.

In case other suid things are also needed later, I created a local
src/rescue/suid/ with an old su.c pre PAM, Thanks to Diane Bruce,
& a diff & Makefile to drive it.
	http://berklix.com/~jhs/src/bsd/fixes/freebsd/src/gen/rescue/
It works, but improvements welcome.
	
Cheers,
Julian
-- 
Julian Stacey, Computer Consultant, Systems Engineer, BSD Linux Unix, Munich
 Brexit Referendum stole 3.7 million votes inc. 700,000 from British in EU.
 UK Goverment lies it's democratic in Article 50 paragraph 3 of letter to EU.
			http://exitbrexit.uk

From yuri at rawbw.com  Thu Jul 12 19:26:01 2018
From: yuri at rawbw.com (Yuri)
Date: Thu, 12 Jul 2018 12:25:52 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
Message-ID: <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>

On 07/03/18 12:45, Yuri wrote:
> I updated the laptop to r335884 last night, and 'service 
> wpa_supplicant start wlan0' doesn't succeed any more.
>
> kernel is supposed to create the network interface 'run0', but it 
> doesn't. This is the immediate reason why wpa_supplicant fails.
>
> The non-creation of 'run0' is a regression. I don't know of any 
> workaround.
>
>
> The steps 'mergemaster -p' and 'mergemaster' were done during the 
> upgrade, so /etc is updated.


Bug report for this problem: 
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229738

This is a very serious regression breaking WiFi.


Yuri



From marklmi at yahoo.com  Thu Jul 12 20:07:43 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 12 Jul 2018 13:07:32 -0700
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
 <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
Message-ID: <3723A682-71BD-4654-9DCB-6FCBF12BEC49@yahoo.com>



On 2018-Jul-12, at 11:32 AM, Dimitry Andric <dim at FreeBSD.org> wrote:

> On 12 Jul 2018, at 15:23, Mark Millard via freebsd-toolchain <freebsd-toolchain at freebsd.org> wrote:
>> 
>> On 2018-Jul-12, at 2:44 AM, tech-lists <tech-lists at zyxst.net> wrote:
>> 
>>> On 11/07/2018 17:21, Mark Millard wrote:
>>>> It seems from the quoted material that neither kernel-toolchain nor
>>>> build world was done before buildkernel . My understanding is that
>>>> the intent is that one or the other be done first. (But for aarch64
>>>> currently only buildworld works.)
>>> 
>>> Thanks for this. I'm running a buildworld now.
>>> 
>>> For how long has it been the case that buildworld is needed for buildkernel? Coming from amd64 and before that, i386, in situations where I've only wanted to install a custom kernel, I was firstly used to making and installing it from /sys/{i386,amd64}/conf. Then that broke a number of years ago. Then got used to making kernel in /usr/src with make buildkernel && make installkernel. And now this is broken, on aarch64-arm64. Nobody knows if it's accidental or policy.
>> 
>> It has been true since clang added use of stdint.h to the kernel build.
>> Prior to this stdint.h was  not needed to build the kernel for any
>> architecture (as far as I know).
> 
> No, it's because sys/crypto/armv8/armv8_crypto_wrap.c includes
> <arm_neon.h>, an intrinsics header, which in turn requires <stdint.h>.
> 
> This was introduced in https://svnweb.freebsd.org/changeset/base/308921,
> and at the time resulted in similar build failures, specifically when
> one attempted to build a new kernel, without building world or a new
> toolchain first.

Sorry. I was distracted this morning and should have cross checked
my claims instead of quickly babbling off the top of my head.



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From pete at nomadlogic.org  Thu Jul 12 20:38:41 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Thu, 12 Jul 2018 13:38:33 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
Message-ID: <83624f27-797d-6557-3f7e-8beac57c7d38@nomadlogic.org>



On 07/12/2018 12:25, Yuri wrote:
> On 07/03/18 12:45, Yuri wrote:
>> I updated the laptop to r335884 last night, and 'service 
>> wpa_supplicant start wlan0' doesn't succeed any more.
>>
>> kernel is supposed to create the network interface 'run0', but it 
>> doesn't. This is the immediate reason why wpa_supplicant fails.
>>
>> The non-creation of 'run0' is a regression. I don't know of any 
>> workaround.
>>
>>
>> The steps 'mergemaster -p' and 'mergemaster' were done during the 
>> upgrade, so /etc is updated.
>
>
> Bug report for this problem: 
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229738
>
> This is a very serious regression breaking WiFi.
>

sorry if i missed something (don't see details in the bug report) - is 
the issue that the run(4) kernel module is not being loaded?? is there 
an error when the system attempts to load the kernel module in the dmesg 
buffer?? if it is not being loaded automagically what happens when you 
manually load the module via "kldload" or by updating rc.conf?

-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From yuri at rawbw.com  Fri Jul 13 04:15:47 2018
From: yuri at rawbw.com (Yuri)
Date: Thu, 12 Jul 2018 21:15:43 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <83624f27-797d-6557-3f7e-8beac57c7d38@nomadlogic.org>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
 <83624f27-797d-6557-3f7e-8beac57c7d38@nomadlogic.org>
Message-ID: <d6f50e82-b573-d444-47aa-13fa3e84622d@rawbw.com>

On 07/12/18 13:38, Pete Wright wrote:
>
> sorry if i missed something (don't see details in the bug report) - is 
> the issue that the run(4) kernel module is not being loaded? is there 
> an error when the system attempts to load the kernel module in the 
> dmesg buffer?? if it is not being loaded automagically what happens 
> when you manually load the module via "kldload" or by updating rc.conf?


No errors while the kernel module is loaded. The problem is that when 
the card is inserted wlan0 isn't automatically created. It also isn't 
created during boot with the card in. I think that there were some 
changes in devd that caused this regression.


Yuri

From tech-lists at zyxst.net  Fri Jul 13 10:15:32 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Fri, 13 Jul 2018 11:15:22 +0100
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
 <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
Message-ID: <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net>

On 12/07/2018 19:32, Dimitry Andric wrote:
> No, it's because sys/crypto/armv8/armv8_crypto_wrap.c includes
> <arm_neon.h>, an intrinsics header, which in turn requires <stdint.h>.
> 
> This was introduced inhttps://svnweb.freebsd.org/changeset/base/308921,
> and at the time resulted in similar build failures, specifically when
> one attempted to build a new kernel, without building world or a new
> toolchain first.

Hi,

Ok, it's finished building and installing. The command I used was this:

# make -j10 buildworld && make -j10 buildkernel KERNCONF=RPI3

and it all built, (so I'll close the PR I opened). Then I did make 
installkernel KERNCONF=RPI3 and because I thought might as well install 
everything now it's built, mergemaster -p and make installworld && 
mergemaster -Ui.

So I take it then, that every time I want to build a kernel, I either 
have to do the above or use make kernel-toolchain. Is this correct?

thanks,
-- 
J.

From ohartmann at walstatt.org  Fri Jul 13 10:40:07 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 13 Jul 2018 12:39:56 +0200
Subject: Firmware Error (ACPI): Failure looking up
 [\_SB.PCI0.LPCB.HEC.ECAV], AE_NOT_FOUND
Message-ID: <20180713123951.50440c9a@freyja.zeit4.iv.bundesimmobilien.de>

Hello.

The target host is a

Fujitsu Esprimo Q956
Firmware V5.0.0.11 R1.26.0 for A3413-A1x
Date 05/25/2018
BIOS Revision 1.26

FreeBSD 11.2-RELEASE and 12-CURRENT (ISO Image from 9th July 2018, r336134) are
spamming the console with an annoying error:

Jul 13 10:00:32  kernel: Firmware Error (ACPI): Failure looking up
[\_SB.PCI0.LPCB.HEC.ECAV], AE_NOT_FOUND (20171214/psargs-503) Jul 13 10:00:32
kernel: ACPI Error: Method parse/execution failed \_TZ.TZ00._TMP, AE_NOT_FOUND
(20171214/psparse-677) Jul 13 10:00:32  kernel: Firmware Error (ACPI): Failure
looking up [\_SB.PCI0.LPCB.HEC.ECAV], AE_NOT_FOUND (20171214/psargs-503)

The error is repeated endless.

Can this be fixed?

Thanks in advance and kind regards,

Oliver

From yuripv at yuripv.net  Fri Jul 13 10:41:37 2018
From: yuripv at yuripv.net (Yuri Pankov)
Date: Fri, 13 Jul 2018 13:41:32 +0300
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
Message-ID: <ffafff20-a930-44bf-8ff7-3c85905fd8c4@yuripv.net>

Yuri wrote:
> On 07/03/18 12:45, Yuri wrote:
>> I updated the laptop to r335884 last night, and 'service
>> wpa_supplicant start wlan0' doesn't succeed any more.
>>
>> kernel is supposed to create the network interface 'run0', but it
>> doesn't. This is the immediate reason why wpa_supplicant fails.
>>
>> The non-creation of 'run0' is a regression. I don't know of any
>> workaround.
>>
>>
>> The steps 'mergemaster -p' and 'mergemaster' were done during the
>> upgrade, so /etc is updated.
> 
> 
> Bug report for this problem:
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229738
> 
> This is a very serious regression breaking WiFi.

It's likely the switch from using usb.conf to devmatch.conf (see r329148).

I can confirm the problem, inserting the ralink usb wifi dongle doesn't 
do anything (I'm not using it anymore so I didn't notice the problem), 
though the action in devmatch.conf is executed, so it might be the 
problem somewhere below in devmatch(8).

From ohartmann at walstatt.org  Fri Jul 13 11:00:11 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 13 Jul 2018 13:00:01 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
Message-ID: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>

The problem is some kind of weird. I face UEFI boot problems on GPT drives
where the first partition begins at block 40 of the hdd/ssd.

I have two host in private use based on an
outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
Both boards are equipted with the lates official available AMI firmware
revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
for the Spectre/Meltdown mitigation is available, but I didn't test that. But
please read.

The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).

Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
test facility.

If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
guess I can assume this when the well known clumsy 80x25 char console suddenly
gets bright and shiny with a much higher resoltion as long the GPU supports
EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
partition starts at block 1 of the device and the device has a MBR layout. I
haven't found a way to force the GPT scheme, when initialised via gpart, to let
the partitions start at block 1. This might be a naiv thinking, so please be
patient with me.

I do not know whether this is a well-known issue. On the ASRock boards, I
tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
not. I gave up on that that time. Now, having the very same issues with a new
Fujitsu system, leaves me with the impression that FreeBSD's UEFI
implementation might have problems I'm not aware of.

Can someone shed some light onto this? 

Thanks in advance,

Oliver 

From yuripv at yuripv.net  Fri Jul 13 11:04:13 2018
From: yuripv at yuripv.net (Yuri Pankov)
Date: Fri, 13 Jul 2018 14:04:08 +0300
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <ffafff20-a930-44bf-8ff7-3c85905fd8c4@yuripv.net>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
 <ffafff20-a930-44bf-8ff7-3c85905fd8c4@yuripv.net>
Message-ID: <963c38fb-1c08-62bc-198d-309953c39eb1@yuripv.net>

Yuri Pankov wrote:
> Yuri wrote:
>> On 07/03/18 12:45, Yuri wrote:
>>> I updated the laptop to r335884 last night, and 'service
>>> wpa_supplicant start wlan0' doesn't succeed any more.
>>>
>>> kernel is supposed to create the network interface 'run0', but it
>>> doesn't. This is the immediate reason why wpa_supplicant fails.
>>>
>>> The non-creation of 'run0' is a regression. I don't know of any
>>> workaround.
>>>
>>>
>>> The steps 'mergemaster -p' and 'mergemaster' were done during the
>>> upgrade, so /etc is updated.
>>
>>
>> Bug report for this problem:
>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229738
>>
>> This is a very serious regression breaking WiFi.
> 
> It's likely the switch from using usb.conf to devmatch.conf (see r329148).
> 
> I can confirm the problem, inserting the ralink usb wifi dongle doesn't
> do anything (I'm not using it anymore so I didn't notice the problem),
> though the action in devmatch.conf is executed, so it might be the
> problem somewhere below in devmatch(8).

And looks like it's fixed in r335763 (for me, at least).

From lev at FreeBSD.org  Fri Jul 13 11:10:38 2018
From: lev at FreeBSD.org (Lev Serebryakov)
Date: Fri, 13 Jul 2018 14:10:22 +0300
Subject: [REGRESSION] Fresh CURRENT consume much more CPU on network traffic
 (vlans + routing + ipfw with NAT)
Message-ID: <6d8b301b-8ee9-0e8b-80b5-6aced15ca843@FreeBSD.org>


 I have "SOHO" router on Atom D2500 with FreeBSD CURRENT. It runs
CURRENT for very long time (from 11-CURRENT times), and recently it
start to consume much more CPU on same traffic ? to the point when it
becomes unresponsive in shell (via ssh, not local console).

 I have rather complex ipfw ruleset, but this ruleset is the same for
many years.

 Revisions before r333989 worked normally, I never seen any problem with
shell, no matter how much traffic is processed

 Revision r334649 with same configuration, same firewall ruleset, etc.,
becomes completely unresponsive under network load (pure transit traffic).

 when system is unresponsive I see this in `top -SH`

100083 root -76 - 0K   272K -       1 291.8H  95.31% kernel{if_io_tqg_1}
100082 root -76 - 0K   272K -       0 297.7H  95.20% kernel{if_io_tqg_0}

 And it is new to me.

-- 
// Lev Serebryakov

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 963 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180713/7d489494/attachment.sig>

From lev at FreeBSD.org  Fri Jul 13 11:28:36 2018
From: lev at FreeBSD.org (Lev Serebryakov)
Date: Fri, 13 Jul 2018 14:28:34 +0300
Subject: [REGRESSION] Fresh CURRENT consume much more CPU on network
 traffic (vlans + routing + ipfw with NAT)
In-Reply-To: <6d8b301b-8ee9-0e8b-80b5-6aced15ca843@FreeBSD.org>
References: <6d8b301b-8ee9-0e8b-80b5-6aced15ca843@FreeBSD.org>
Message-ID: <4cfd6e7f-6da3-5248-4d39-4d08e491b233@FreeBSD.org>

On 13.07.2018 14:10, Lev Serebryakov wrote:

>  when system is unresponsive I see this in `top -SH`
> 
> 100083 root -76 - 0K   272K -       1 291.8H  95.31% kernel{if_io_tqg_1}
> 100082 root -76 - 0K   272K -       0 297.7H  95.20% kernel{if_io_tqg_0}
> 
>  And it is new to me.
 Oh, this MoBo has (and uses) two em0 adapters:

em0 at pci0:2:0:0: class=0x020000 card=0x202c8086 chip=0x10d38086 rev=0x00
hdr=0x00
    vendor     = 'Intel Corporation'
    device     = '82574L Gigabit Network Connection'
    class      = network
    subclass   = ethernet
em1 at pci0:1:0:0: class=0x020000 card=0x202c8086 chip=0x10d38086 rev=0x00
hdr=0x00
    vendor     = 'Intel Corporation'
    device     = '82574L Gigabit Network Connection'
    class      = network
    subclass   = ethernet

-- 
// Lev Serebryakov

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 963 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180713/975d9835/attachment.sig>

From kalle.carlbark+freebsd at kcbark.net  Fri Jul 13 12:14:09 2018
From: kalle.carlbark+freebsd at kcbark.net (Kalle Carlbark)
Date: Fri, 13 Jul 2018 14:13:52 +0200
Subject: HD Audio Emulation For Bhyve
Message-ID: <8EA0050D-E83E-4DB0-9ADD-A1EE485BCFC9@kcbark.net>

Hi!

First post to the mailing list. 

I was trying out the https://reviews.freebsd.org/D12419 on a recent FreeBSD current (>= 336229) but didn?t get it to work using debian 9 as a guest. Mpg123 just hangs when trying to play a mp3. Also tried Ubuntu 18 but that just hangs at boot time at ?Detecting sound card?. I?ve compiled bhyve WITHOUT_CAPSICUM but that doesn?t seem to solve anything. Also built with DEBUG_HDA and that doesn?t output any errors. Sound works just fine on the host system. Any hints?


Thanks! 

From Alexander at leidinger.net  Fri Jul 13 12:18:30 2018
From: Alexander at leidinger.net (Alexander Leidinger)
Date: Fri, 13 Jul 2018 14:17:56 +0200
Subject: Deadlocks / hangs in ZFS
In-Reply-To: <6254a3ca-6740-c1b2-7125-7ac8a708e757@FreeBSD.org>
References: <20180522101749.Horde.Wxz9gSxx1xArxkYMQqTL0iZ@webmail.leidinger.net>
 <fa263af4-9bf7-88f8-8d23-21456daf7960@FreeBSD.org>
 <20180522122924.GC1954@zxy.spb.ru>
 <20180522161632.Horde.ROSnBoZixBoE9ZBGp5VBQgZ@webmail.leidinger.net>
 <20180522144055.GD1954@zxy.spb.ru> <20180527194159.v54ox3vlthpuvx4q@jo>
 <20180527220612.GK1926@zxy.spb.ru>
 <20180528090201.Horde._E4JZcuEaZHfj_BNzWjci2O@webmail.leidinger.net>
 <20180603211450.Horde.pI-Fom6S1tUcaHvTF4MUjin@webmail.leidinger.net>
 <20180603192814.GP1926@zxy.spb.ru>
 <20180604223108.Horde.RcVquaVKWdNzNidD_5aJz7E@webmail.leidinger.net>
 <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>
 <6254a3ca-6740-c1b2-7125-7ac8a708e757@FreeBSD.org>
Message-ID: <20180713141756.Horde.fBMrBpf878-dzloMbGlo6N1@webmail.leidinger.net>


Quoting Andriy Gapon <avg at freebsd.org> (from Fri, 13 Jul 2018 14:50:48 +0300):

> On 12/07/2018 15:42, Alexander Leidinger wrote:
>> #9? 0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
>> ??? at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532
>
> Do you have any local modifications to ZFS code?

Yes, this is with https://reviews.freebsd.org/D7538

Bye,
Alexander.

-- 
http://www.Leidinger.net Alexander at Leidinger.net: PGP 0x8F31830F9F2772BF
http://www.FreeBSD.org    netchild at FreeBSD.org  : PGP 0x8F31830F9F2772BF
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 819 bytes
Desc: Digitale PGP-Signatur
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180713/8c5cc260/attachment.sig>

From tsoome at me.com  Fri Jul 13 12:27:18 2018
From: tsoome at me.com (Toomas Soome)
Date: Fri, 13 Jul 2018 14:26:51 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <68505F98-E840-4148-9E48-BDB350F7431A@me.com>



> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> The problem is some kind of weird. I face UEFI boot problems on GPT drives
> where the first partition begins at block 40 of the hdd/ssd.
> 
> I have two host in private use based on an
> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
> Both boards are equipted with the lates official available AMI firmware
> revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
> and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> for the Spectre/Meltdown mitigation is available, but I didn't test that. But
> please read.
> 
> The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
> AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
> 
> Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
> UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
> immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
> test facility.
> 
> If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
> the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
> guess I can assume this when the well known clumsy 80x25 char console suddenly
> gets bright and shiny with a much higher resoltion as long the GPU supports
> EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
> partition starts at block 1 of the device and the device has a MBR layout. I
> haven't found a way to force the GPT scheme, when initialised via gpart, to let
> the partitions start at block 1. This might be a naiv thinking, so please be
> patient with me.
> 
> I do not know whether this is a well-known issue. On the ASRock boards, I
> tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
> not. I gave up on that that time. Now, having the very same issues with a new
> Fujitsu system, leaves me with the impression that FreeBSD's UEFI
> implementation might have problems I'm not aware of.
> 
> Can someone shed some light onto this? 
> 

The first thing to check is if the secure boot is disabled. We do not support secure boot at all at this time. 

If you have efi or bios version running - you can check from either console variable value (it can have efi or vidconsole or comconsole) or better yet, see if efi-version is set (show efi-version) - if efi-version is not set, it is BIOS loader running. Another indirect way is to see lsdev -v, with device paths present, it is uefi:)

GPT partitions can never start from disk absolute sector 1; this is because at sector 0 there is MBR (for compatibility), sector 1 is GPT table and then sectors 2-33 have GPT partition table entries, so the first possible data sector is 34 (absolute 34). Thats assuming 512B sectors.  For details see UEFI 2.7 Chapter 5.3.1 page 131.

rgds,
toomas




From avg at FreeBSD.org  Fri Jul 13 12:45:52 2018
From: avg at FreeBSD.org (Andriy Gapon)
Date: Fri, 13 Jul 2018 14:50:48 +0300
Subject: Deadlocks / hangs in ZFS
In-Reply-To: <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>
References: <20180522101749.Horde.Wxz9gSxx1xArxkYMQqTL0iZ@webmail.leidinger.net>
 <fa263af4-9bf7-88f8-8d23-21456daf7960@FreeBSD.org>
 <20180522122924.GC1954@zxy.spb.ru>
 <20180522161632.Horde.ROSnBoZixBoE9ZBGp5VBQgZ@webmail.leidinger.net>
 <20180522144055.GD1954@zxy.spb.ru> <20180527194159.v54ox3vlthpuvx4q@jo>
 <20180527220612.GK1926@zxy.spb.ru>
 <20180528090201.Horde._E4JZcuEaZHfj_BNzWjci2O@webmail.leidinger.net>
 <20180603211450.Horde.pI-Fom6S1tUcaHvTF4MUjin@webmail.leidinger.net>
 <20180603192814.GP1926@zxy.spb.ru>
 <20180604223108.Horde.RcVquaVKWdNzNidD_5aJz7E@webmail.leidinger.net>
 <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>
Message-ID: <6254a3ca-6740-c1b2-7125-7ac8a708e757@FreeBSD.org>

On 12/07/2018 15:42, Alexander Leidinger wrote:
> #9? 0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
> ??? at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532

Do you have any local modifications to ZFS code?
I cannot find that function.

-- 
Andriy Gapon

From slw at zxy.spb.ru  Fri Jul 13 13:19:54 2018
From: slw at zxy.spb.ru (Slawa Olhovchenkov)
Date: Fri, 13 Jul 2018 16:19:42 +0300
Subject: Deadlocks / hangs in ZFS
In-Reply-To: <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>
References: <20180522122924.GC1954@zxy.spb.ru>
 <20180522161632.Horde.ROSnBoZixBoE9ZBGp5VBQgZ@webmail.leidinger.net>
 <20180522144055.GD1954@zxy.spb.ru>
 <20180527194159.v54ox3vlthpuvx4q@jo>
 <20180527220612.GK1926@zxy.spb.ru>
 <20180528090201.Horde._E4JZcuEaZHfj_BNzWjci2O@webmail.leidinger.net>
 <20180603211450.Horde.pI-Fom6S1tUcaHvTF4MUjin@webmail.leidinger.net>
 <20180603192814.GP1926@zxy.spb.ru>
 <20180604223108.Horde.RcVquaVKWdNzNidD_5aJz7E@webmail.leidinger.net>
 <20180712144229.Horde.D_-hM4wiiKjbsuR-VROmvkZ@webmail.leidinger.net>
Message-ID: <20180713131942.GA30893@zxy.spb.ru>

On Thu, Jul 12, 2018 at 02:42:29PM +0200, Alexander Leidinger wrote:

> __curthread () at ./machine/pcpu.h:230
> 230             __asm("movq %%gs:%1,%0" : "=r" (td)
> (kgdb) bt
> #0  __curthread () at ./machine/pcpu.h:230
> #1  doadump (textdump=1) at /usr/src/sys/kern/kern_shutdown.c:366
> #2  0xffffffff80485e11 in kern_reboot (howto=260) at  
> /usr/src/sys/kern/kern_shutdown.c:446
> #3  0xffffffff804863f3 in vpanic (fmt=<optimized out>, ap=0xfffffe0000457870)
>      at /usr/src/sys/kern/kern_shutdown.c:863
> #4  0xffffffff80486443 in panic (fmt=<unavailable>) at  
> /usr/src/sys/kern/kern_shutdown.c:790
> #5  0xffffffff8075279f in trap_fatal (frame=0xfffffe0000457a50,  
> eva=32) at /usr/src/sys/amd64/amd64/trap.c:892
> #6  0xffffffff80752812 in trap_pfault (frame=0xfffffe0000457a50,  
> usermode=<optimized out>)
>      at /usr/src/sys/amd64/amd64/trap.c:728
> #7  0xffffffff80751e1a in trap (frame=0xfffffe0000457a50) at  
> /usr/src/sys/amd64/amd64/trap.c:427
> #8  <signal handler called>
> #9  0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
>      at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532
> #10 arc_reclaim_thread (unused=<optimized out>)
>      at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4657
> #11 0xffffffff8044ca74 in fork_exit (callout=0xffffffff81391b90  
> <arc_reclaim_thread>, arg=0x0,
>      frame=0xfffffe0000457c00) at /usr/src/sys/kern/kern_fork.c:1057
> #12 <signal handler called>
> (kgdb) up 9
> #9  0xffffffff81391fbe in arc_check_uma_cache (lowest=-1011712)
>      at /usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs/arc.c:4532
> 4532                    lowest +=  
> uma_zone_get_free_size(zio_data_buf_cache[n]->kc_zone);
> (kgdb) list
> 4527            int                     iter = 4;
> 4528            int                     step = 1 << (SPA_MAXBLOCKSHIFT  
> - SPA_MINBLOCKSHIFT - 3);
> 4529            int                     n = (SPA_MAXBLOCKSIZE >>  
> SPA_MINBLOCKSHIFT) - 1;
> 4530
> 4531            while (n >= 0) {
> 4532                    lowest +=  
> uma_zone_get_free_size(zio_data_buf_cache[n]->kc_zone);
> 4533                    if (lowest >= 0)
> 4534                            return lowest;
> 4535                    n -= step;
> 4536                    if(--iter == 0) {
> (kgdb) print n
> $1 = 32767
> (kgdb) print zio_data_buf_cache[n]
> $2 = (kmem_cache_t *) 0x0
> (kgdb)

Very strange, zio_data_buf_cache[] can't be NULL, as asserted in
zio_init.

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Fri Jul 13 14:15:43 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Fri, 13 Jul 2018 07:15:36 -0700 (PDT)
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
Message-ID: <201807131415.w6DEFbYG083619@pdx.rh.CN85.dnsmgr.net>

> 
> 
> > On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > The problem is some kind of weird. I face UEFI boot problems on GPT drives
> > where the first partition begins at block 40 of the hdd/ssd.
> > 
> > I have two host in private use based on an
> > outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
> > Both boards are equipted with the lates official available AMI firmware
> > revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
> > and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> > for the Spectre/Meltdown mitigation is available, but I didn't test that. But
> > please read.
> > 
> > The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
> > AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
> > 
> > Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
> > UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
> > immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
> > test facility.
> > 
> > If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
> > the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
> > guess I can assume this when the well known clumsy 80x25 char console suddenly
> > gets bright and shiny with a much higher resoltion as long the GPU supports
> > EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
> > partition starts at block 1 of the device and the device has a MBR layout. I
> > haven't found a way to force the GPT scheme, when initialised via gpart, to let
> > the partitions start at block 1. This might be a naiv thinking, so please be
> > patient with me.

This sounds like a tool showing you the protective MBR which
is part of GPT.

> > I do not know whether this is a well-known issue. On the ASRock boards, I
> > tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
> > not. I gave up on that that time. Now, having the very same issues with a new
> > Fujitsu system, leaves me with the impression that FreeBSD's UEFI
> > implementation might have problems I'm not aware of.
> > 
> > Can someone shed some light onto this? 
> > 
> 
> The first thing to check is if the secure boot is disabled. We do not support secure boot at all at this time. 
> 
> If you have efi or bios version running - you can check from either console variable value (it can have efi or vidconsole or comconsole) or better yet, see if efi-version is set (show efi-version) - if efi-version is not set, it is BIOS loader running. Another indirect way is to see lsdev -v, with device paths present, it is uefi:)
> 
> GPT partitions can never start from disk absolute sector 1; this is because at sector 0 there is MBR (for compatibility), sector 1 is GPT table and then sectors 2-33 have GPT partition table entries, so the first possible data sector is 34 (absolute 34). Thats assuming 512B sectors.  For details see UEFI 2.7 Chapter 5.3.1 page 131.
> 

One must be carefull when looking at a GPT scheme device,
as it still has a "protective MBR" at sector 0 which
covers sectors 1 to N of the device.  Legacy (mbr only)
tools well see this and show it as type 0xEE covering
the whole device.

Some modern tools still show this as an MBR, but
then also show the GPT's inside it.

Some tools never show you the protective MBR.


-- 
Rod Grimes                                                 rgrimes at freebsd.org

From jounijl at yahoo.co.uk  Fri Jul 13 15:06:41 2018
From: jounijl at yahoo.co.uk (jounijl at yahoo.co.uk)
Date: Fri, 13 Jul 2018 20:56:11 +0300
Subject: options COMPAT_AOUT to file UPDATING to know
Message-ID: <1c5d9e7e-fb12-d35a-818e-5a2a433733f5@yahoo.co.uk>


=== Reason:

In compiling the kernel again after a long time after 'pkg upgrade' the 
following errors. The Intel graphics card is in use and something had 
changed, the 'startx' did not start the XFCE session. This was the 
reason to compile the kernel again with the new sources of today. After 
two retries taking some time to complite, it would be helpful to ...

=== Symptom:

--- kernel.full ---
linking kernel.full
ld.lld: error: undefined symbol: aout_sysvec
 >>> referenced by imgact_gzip.c:240 (/usr/src/sys/kern/imgact_gzip.c:240)
 >>> imgact_gzip.o:(Flush)

=== Resolution:

Adding

options???????? COMPAT_AOUT

to the kernel configuration file.

This added the necessary 'imgact_aout.o' to the linking and the 
'aout_sysvec' was found.

__________________

It would be nice if a message was written in the /usr/src/UPDATING about 
this to prevent the unnecessary retries. Probably COMPAT_LINUXKPI needs 
this setting with 'device gzip' since COMPAT_AOUT was defined in a 
kernel module object, not in a kernel object file. Somewhere in time the 
COMPAT_AOUT did not exist after the 11-stable and this time it was 
necessary (today 13:th of July 2018) with the Intel driver. It has been 
necessary somewhere between 16:th of May to today (from these kernel 
timestamps). Who knows I don't know.

It would be a good idea to add a note to the UPDATING as information for 
all of the Intel graphics users about the aout to be necessary to use 
less time in testing the error.

br, jla

From marklmi at yahoo.com  Fri Jul 13 15:27:22 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Fri, 13 Jul 2018 08:27:10 -0700
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
 <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
 <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net>
Message-ID: <43C85CB9-2F8A-4DB2-85F3-CAE6371666E4@yahoo.com>



On 2018-Jul-13, at 3:15 AM, tech-lists <tech-lists at zyxst.net> wrote:

> On 12/07/2018 19:32, Dimitry Andric wrote:
>> No, it's because sys/crypto/armv8/armv8_crypto_wrap.c includes
>> <arm_neon.h>, an intrinsics header, which in turn requires <stdint.h>.
>> This was introduced inhttps://svnweb.freebsd.org/changeset/base/308921,
>> and at the time resulted in similar build failures, specifically when
>> one attempted to build a new kernel, without building world or a new
>> toolchain first.
> 
> Hi,
> 
> Ok, it's finished building and installing. The command I used was this:
> 
> # make -j10 buildworld && make -j10 buildkernel KERNCONF=RPI3

make -j10 buildworld buildkernel KERNCONF=RPI3

would have worked.

> and it all built, (so I'll close the PR I opened). Then I did make installkernel KERNCONF=RPI3 and because I thought might as well install everything now it's built, mergemaster -p and make installworld && mergemaster -Ui.
> 
> So I take it then, that every time I want to build a kernel, I either have to do the above or use make kernel-toolchain. Is this correct?

If you first clear out the old build, then such would be true.
(Where, for targeting aarch64, kernel-toolchain needs to be
avoided.)

But you can buildkernel using the results of the existing
buildworld (or kernel-toolchain if it applies) when it is
okay to not clear out the old build first. (kernel
developers doing kernel development likely do this a lot.)

Another way to make tradeoffs is to use META_MODE so that
partial rebuilds are done, avoiding some of the strictly
unnecessary rebuild activity. This would involve
buildworld or kernel-toolchain (as appropriate for the
target architecture).


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From o.hartmann at walstatt.org  Fri Jul 13 14:45:08 2018
From: o.hartmann at walstatt.org (O. Hartmann)
Date: Fri, 13 Jul 2018 16:44:20 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
Message-ID: <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Fri, 13 Jul 2018 14:26:51 +0300
Toomas Soome <tsoome at me.com> schrieb:

> > On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > The problem is some kind of weird. I face UEFI boot problems on GPT drives
> > where the first partition begins at block 40 of the hdd/ssd.
> > 
> > I have two host in private use based on an
> > outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
> > Both boards are equipted with the lates official available AMI firmware
> > revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
> > and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> > for the Spectre/Meltdown mitigation is available, but I didn't test that. But
> > please read.
> > 
> > The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
> > AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
> > 
> > Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
> > UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
> > immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
> > test facility.
> > 
> > If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
> > the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
> > guess I can assume this when the well known clumsy 80x25 char console suddenly
> > gets bright and shiny with a much higher resoltion as long the GPU supports
> > EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
> > partition starts at block 1 of the device and the device has a MBR layout. I
> > haven't found a way to force the GPT scheme, when initialised via gpart, to let
> > the partitions start at block 1. This might be a naiv thinking, so please be
> > patient with me.
> > 
> > I do not know whether this is a well-known issue. On the ASRock boards, I
> > tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
> > not. I gave up on that that time. Now, having the very same issues with a new
> > Fujitsu system, leaves me with the impression that FreeBSD's UEFI
> > implementation might have problems I'm not aware of.
> > 
> > Can someone shed some light onto this? 
> >   
> 
> The first thing to check is if the secure boot is disabled. We do not support secure
> boot at all at this time.

Secure boot is in every scenario disabled!
 
> 
> If you have efi or bios version running - you can check from either console variable
> value (it can have efi or vidconsole or comconsole) or better yet, see if efi-version
> is set (show efi-version) - if efi-version is not set, it is BIOS loader running.
> Another indirect way is to see lsdev -v, with device paths present, it is uefi:)

What are you talking about?
What is the point of entry - running system, loader?

sysct machdep.bootmethod: BIOS

This makes me quite sure that the system has booted via BIOS - as I'm sure since I've
checked that many times. UEFI doesn't work on those systems with FreeBSD. I'm not sure
antmore, but I tried also Windows 7 on those mainboards booting via UEFI - and I might
recall that they failed also. I also recall that there were issues with earlier UEFI
versions regarding booting only Windows 8/8.1 - and nothing else, but the fact that Linux
worked confuses me a bit.

If this ASRock crap (never ever again this brand!) doesn't work at all - who cares, I
intend to purchase new server grade hardware. But the more puzzling issue is with the
Fujitsu, which I consider serious and from the behaviour the Fujitsu failure looks
exactly like the ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
Firmware settings when I disable CSM support, that the Firmware will only EFI/UEFI
capable loader? Or is there a ghosty override somwhere to be expected?). Also on ASRock
disabling CSM should ensure not booting a dual-bootstrap-capable system. This said, on
the recent Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
problem, while the ASRock is still under suspicion to be broken by design.  

> 
> GPT partitions can never start from disk absolute sector 1; this is because at sector 0
> there is MBR (for compatibility), sector 1 is GPT table and then sectors 2-33 have GPT
> partition table entries, so the first possible data sector is 34 (absolute 34). Thats
> assuming 512B sectors.  For details see UEFI 2.7 Chapter 5.3.1 page 131.

Thanks for the explanation. That implies the installer did right, gpart did also right
and therefore there must be an issue with the stuff located within the EFI partition?

> 
> rgds,
> toomas

Thank you very much and kind regards,

Oliver

> 
> 
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"



- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW0i63wAKCRDS528fyFhY
lJS9Af96agcXNlHY0MR37IeblIyWFuX5dKEv+e/Py7CNXI+JcTG87NIa4NsXH8Oh
uDCzZnrh/xG2Qht6QzJflVJpBXQsAgCanIPOlzAgh2/PCAuMi1SWzu/JYQShOyB6
LjwaKlRkrQT3w6xit9O8HWqWbk8vd6qqUfWM3SXyDMd8pMvp7uHd
=6+Pb
-----END PGP SIGNATURE-----

From tsoome at me.com  Fri Jul 13 16:44:35 2018
From: tsoome at me.com (Toomas Soome)
Date: Fri, 13 Jul 2018 18:44:23 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
Message-ID: <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>



> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org> wrote:
> 
> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> 
> Am Fri, 13 Jul 2018 14:26:51 +0300
> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> schrieb:
> 
>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> The problem is some kind of weird. I face UEFI boot problems on GPT drives
>>> where the first partition begins at block 40 of the hdd/ssd.
>>> 
>>> I have two host in private use based on an
>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
>>> Both boards are equipted with the lates official available AMI firmware
>>> revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
>>> and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
>>> for the Spectre/Meltdown mitigation is available, but I didn't test that. But
>>> please read.
>>> 
>>> The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
>>> AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
>>> 
>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
>>> UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
>>> immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
>>> test facility.
>>> 
>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
>>> the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
>>> guess I can assume this when the well known clumsy 80x25 char console suddenly
>>> gets bright and shiny with a much higher resoltion as long the GPU supports
>>> EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
>>> partition starts at block 1 of the device and the device has a MBR layout. I
>>> haven't found a way to force the GPT scheme, when initialised via gpart, to let
>>> the partitions start at block 1. This might be a naiv thinking, so please be
>>> patient with me.
>>> 
>>> I do not know whether this is a well-known issue. On the ASRock boards, I
>>> tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
>>> not. I gave up on that that time. Now, having the very same issues with a new
>>> Fujitsu system, leaves me with the impression that FreeBSD's UEFI
>>> implementation might have problems I'm not aware of.
>>> 
>>> Can someone shed some light onto this? 
>>> 
>> 
>> The first thing to check is if the secure boot is disabled. We do not support secure
>> boot at all at this time.
> 
> Secure boot is in every scenario disabled!
> 
>> 
>> If you have efi or bios version running - you can check from either console variable
>> value (it can have efi or vidconsole or comconsole) or better yet, see if efi-version
>> is set (show efi-version) - if efi-version is not set, it is BIOS loader running.
>> Another indirect way is to see lsdev -v, with device paths present, it is uefi:)
> 
> What are you talking about?
> What is the point of entry - running system, loader?
> 
> sysct machdep.bootmethod: BIOS
> 
> This makes me quite sure that the system has booted via BIOS - as I'm sure since I've
> checked that many times. UEFI doesn't work on those systems with FreeBSD. I'm not sure
> antmore, but I tried also Windows 7 on those mainboards booting via UEFI - and I might
> recall that they failed also. I also recall that there were issues with earlier UEFI
> versions regarding booting only Windows 8/8.1 - and nothing else, but the fact that Linux
> worked confuses me a bit.
> 
> If this ASRock crap (never ever again this brand!) doesn't work at all - who cares, I
> intend to purchase new server grade hardware. But the more puzzling issue is with the
> Fujitsu, which I consider serious and from the behaviour the Fujitsu failure looks
> exactly like the ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
> Firmware settings when I disable CSM support, that the Firmware will only EFI/UEFI
> capable loader? Or is there a ghosty override somwhere to be expected?). Also on ASRock
> disabling CSM should ensure not booting a dual-bootstrap-capable system. This said, on
> the recent Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
> problem, while the ASRock is still under suspicion to be broken by design.  
> 
>> 
>> GPT partitions can never start from disk absolute sector 1; this is because at sector 0
>> there is MBR (for compatibility), sector 1 is GPT table and then sectors 2-33 have GPT
>> partition table entries, so the first possible data sector is 34 (absolute 34). Thats
>> assuming 512B sectors.  For details see UEFI 2.7 Chapter 5.3.1 page 131.
> 
> Thanks for the explanation. That implies the installer did right, gpart did also right
> and therefore there must be an issue with the stuff located within the EFI partition?
> 

Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS loader at all or not - that is, if the BIOS bootstrap is actually caring to read the MBR code and start it, since once the MBR code is started, it is all about our code.

btw, you can try to validate the installed boot blocks by using recent enough loader (usb or iso) and then you can use from OK prompt:

OK chain diskX:

(replace X by correct disk number from lsdev) to read and start the MBR code. If that is working, then its really about BIOS refusing to read the MBR and execute it.

rgds,
toomas


From oleg at theweb.org.ua  Fri Jul 13 17:23:11 2018
From: oleg at theweb.org.ua (Oleg V. Nauman)
Date: Thu, 12 Jul 2018 19:08:36 +0300
Subject: HEAD i386 r336217 : wireless connection fails ( ath(4) )
Message-ID: <2011560.GsEZm8Rlsn@asus.theweb.org.ua>

 I'm experiencing wireless connection failure after HEAD/i386 update performed 
today.
Below is relevant portion of dmesg buffer:


Jul 12 18:43:39 desktop kernel: wlan0: Ethernet address: 18:a6:f7:8a:b1:52
Jul 12 18:43:39 desktop kernel: wlan0: link state changed to UP
Jul 12 18:43:39 desktop kernel: wlan0: link state changed to DOWN
Jul 12 18:43:41 desktop wpa_supplicant[257]: wlan0: Trying to associate with 
f8:1a:67:56:16:16 (SSID='****' freq=2412 MHz)
Jul 12 18:43:41 desktop wpa_supplicant[257]: wlan0: Associated with f8:1a:
67:56:16:16
Jul 12 18:43:41 desktop kernel: wlan0: link state changed to UP
Jul 12 18:43:41 desktop dhclient[641]: New IP Address (wlan0): 192.168.0.50
Jul 12 18:43:41 desktop dhclient[642]: New Subnet Mask (wlan0): 255.255.255.0
Jul 12 18:43:41 desktop dhclient[643]: New Broadcast Address (wlan0): 
192.168.0.255
Jul 12 18:43:41 desktop dhclient[644]: New Routers (wlan0): 192.168.0.1
Jul 12 18:43:42 desktop wpa_supplicant[257]: wlan0: CTRL-EVENT-DISCONNECTED 
bssid=f8:1a:67:56:16:16 reason=1 locally_generated=1
Jul 12 18:43:42 desktop kernel: wlan0: link state changed to DOWN
Jul 12 18:43:42 desktop wpa_supplicant[257]: ioctl[SIOCS80211, op=20, val=0, 
arg_len=7]: Can't assign requested address
Jul 12 18:43:45 desktop wpa_supplicant[257]: wlan0: Trying to associate with 
f8:1a:67:56:16:16 (SSID='****' freq=2412 MHz)
Jul 12 18:43:45 desktop wpa_supplicant[257]: wlan0: Associated with f8:1a:
67:56:16:16
Jul 12 18:43:45 desktop kernel: wlan0: link state changed to UP
Jul 12 18:43:45 desktop dhclient[269]: send_packet: No buffer space available
Jul 12 18:43:46 desktop wpa_supplicant[257]: wlan0: CTRL-EVENT-DISCONNECTED 
bssid=f8:1a:67:56:16:16 reason=1 locally_generated=1
Jul 12 18:43:46 desktop kernel: wlan0: link state changed to DOWN
Jul 12 18:43:46 desktop wpa_supplicant[257]: ioctl[SIOCS80211, op=20, val=0, 
arg_len=7]: Can't assign requested address
Jul 12 18:43:49 desktop wpa_supplicant[257]: wlan0: Trying to associate with 
f8:1a:67:56:16:16 (SSID='****' freq=2412 MHz)
Jul 12 18:43:49 desktop kernel: wlan0: link state changed to UP
Jul 12 18:43:49 desktop wpa_supplicant[257]: wlan0: Associated with f8:1a:
67:56:16:16
Jul 12 18:43:49 desktop dhclient[269]: send_packet: No buffer space available
Jul 12 18:43:50 desktop wpa_supplicant[257]: wlan0: CTRL-EVENT-DISCONNECTED 
bssid=f8:1a:67:56:16:16 reason=1 locally_generated=1
Jul 12 18:43:50 desktop kernel: wlan0: link state changed to DOWN
Jul 12 18:43:50 desktop wpa_supplicant[257]: wlan0: CTRL-EVENT-SSID-TEMP-
DISABLED id=22 ssid="****" auth_failures=1 duration=10 reason=CONN_FAILED
Jul 12 18:43:50 desktop wpa_supplicant[257]: ioctl[SIOCS80211, op=20, val=0, 
arg_len=7]: Can't assign requested address
Jul 12 18:43:53 desktop wpa_supplicant[257]: wlan0: Trying to associate with 
SSID 'test adhoc'
Jul 12 18:43:53 desktop wpa_supplicant[257]: bsd_set_if_media: SIOCSIFMEDIA 
Device not configured
Jul 12 18:43:53 desktop wpa_supplicant[257]: wpa_driver_bsd_associate: failed 
to set operation mode
Jul 12 18:43:53 desktop wpa_supplicant[257]: wlan0: Association request to the 
driver failed
Jul 12 18:43:53 desktop wpa_supplicant[257]: wlan0: CTRL-EVENT-CONNECTED - 
Connection to 00:00:00:00:00:00 completed [id=-1 id_str=]
Jul 12 18:43:56 desktop dhclient[269]: send_packet: Network is down
Jul 12 18:44:04 desktop dhclient[269]: send_packet: Network is down
Jul 12 18:45:01 desktop dhclient[269]: send_packet: Network is down
Jul 12 18:45:05 desktop dhclient[1739]: New IP Address (wlan0): 192.168.0.50
Jul 12 18:45:05 desktop dhclient[1740]: New Subnet Mask (wlan0): 255.255.255.0
Jul 12 18:45:05 desktop dhclient[1741]: New Broadcast Address (wlan0): 
192.168.0.255
Jul 12 18:45:05 desktop dhclient[1742]: New Routers (wlan0): 192.168.0.1
Jul 12 18:45:06 desktop dhclient[1744]: New Routers (wlan0): 192.168.0.1

From pete at nomadlogic.org  Fri Jul 13 18:01:21 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Fri, 13 Jul 2018 11:01:14 -0700
Subject: [regression] The USB WiFi card stopped working: if_run doesn't
 create the 'run0' interface any more
In-Reply-To: <d6f50e82-b573-d444-47aa-13fa3e84622d@rawbw.com>
References: <750df9db-ac02-a691-d091-7c34fe5ddb22@rawbw.com>
 <b072c7c7-dbaa-f2e7-9c09-a9cc78465180@rawbw.com>
 <83624f27-797d-6557-3f7e-8beac57c7d38@nomadlogic.org>
 <d6f50e82-b573-d444-47aa-13fa3e84622d@rawbw.com>
Message-ID: <fc844d6d-7538-16ee-2180-ecb92e142769@nomadlogic.org>



On 07/12/2018 21:15, Yuri wrote:
> On 07/12/18 13:38, Pete Wright wrote:
>>
>> sorry if i missed something (don't see details in the bug report) - 
>> is the issue that the run(4) kernel module is not being loaded? is 
>> there an error when the system attempts to load the kernel module in 
>> the dmesg buffer?? if it is not being loaded automagically what 
>> happens when you manually load the module via "kldload" or by 
>> updating rc.conf?
>
>
> No errors while the kernel module is loaded. The problem is that when 
> the card is inserted wlan0 isn't automatically created. It also isn't 
> created during boot with the card in. I think that there were some 
> changes in devd that caused this regression.
>

interesting, i ran into an issue with a kernel/world i updated to on 
thursday where my USB mouse was non-functional and i suspect something 
funky happened with devd as well.? one suggestion i heard was to enable 
devmatch which i haven't had a chance to test yet. throwing it out there 
as it may help you.

cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From marklmi at yahoo.com  Fri Jul 13 18:31:28 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Fri, 13 Jul 2018 11:21:10 -0700
Subject: svn commit: r336252 - in head: [ broke the ci.freebsd.org's
 FreeBSD-head-{mips,mips64,powerpc,powerpc64,sparc64,???}-build ]
Message-ID: <D6A73D44-BB58-4004-ABFC-DCFA3FB4EDC3@yahoo.com>

[Note: mips64 built for -r336251 but failed for -r336252 and -r336253 .]

An example (mips64):

--- all_subdir_stand ---
cc1: warnings being treated as errors
/usr/src/stand/libsa/geli/geliboot_crypto.c: In function 'geliboot_crypt':
/usr/src/stand/libsa/geli/geliboot_crypto.c:45: warning: 'blks' may be used uninitialized in this function
*** [geliboot_crypto.o] Error code 1

(A bunch of architectures are still building their first build
after -r336251 .)


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From se at freebsd.org  Sat Jul 14 09:00:38 2018
From: se at freebsd.org (Stefan Esser)
Date: Sat, 14 Jul 2018 11:00:26 +0200
Subject: options COMPAT_AOUT to file UPDATING to know
In-Reply-To: <1c5d9e7e-fb12-d35a-818e-5a2a433733f5@yahoo.co.uk>
References: <1c5d9e7e-fb12-d35a-818e-5a2a433733f5@yahoo.co.uk>
Message-ID: <7f930a51-e884-3bfb-60e8-9273bc65b618@freebsd.org>

Am 13.07.18 um 19:56 schrieb jounijl at yahoo.co.uk:
> 
> === Reason:
> 
> In compiling the kernel again after a long time after 'pkg upgrade' the
> following errors. The Intel graphics card is in use and something had changed,
> the 'startx' did not start the XFCE session. This was the reason to compile
> the kernel again with the new sources of today. After two retries taking some
> time to complite, it would be helpful to ...
> 
> === Symptom:
> 
> --- kernel.full ---
> linking kernel.full
> ld.lld: error: undefined symbol: aout_sysvec
>>>> referenced by imgact_gzip.c:240 (/usr/src/sys/kern/imgact_gzip.c:240)
>>>> imgact_gzip.o:(Flush)
> 
> === Resolution:
> 
> Adding
> 
> options???????? COMPAT_AOUT
> 
> to the kernel configuration file.
> 
> This added the necessary 'imgact_aout.o' to the linking and the 'aout_sysvec'
> was found.

Seems you have "device gzip" in your kernel configuration?

This is a long (15 years?) obsolete option, which let you compress your a.out
binaries with gzip and execute them as if they were uncompressed. The binaries
where not paged in as normal, but loaded as one blob, in that case.

This was a useful features when Laptops had slow 200 MB hard disks, since the
space saving was substantial.

ELF binaries could never be compressed and executed that way, and the option
is not present in any kernel configuration in the FreeBSD sources. It is only
mentioned in NOTES and there is a clear remark, that this option requires
COMPAT_AOUT (and also mentions that it is only useful for a.out binaries).

Regards, STefan

From ronald-lists at klop.ws  Sat Jul 14 10:15:11 2018
From: ronald-lists at klop.ws (Ronald Klop)
Date: Sat, 14 Jul 2018 12:15:07 +0200
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
 <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
 <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net>
Message-ID: <op.zl4z3hr7kndu52@klop.ws>

On Fri, 13 Jul 2018 12:15:22 +0200, tech-lists <tech-lists at zyxst.net>  
wrote:

> On 12/07/2018 19:32, Dimitry Andric wrote:
>> No, it's because sys/crypto/armv8/armv8_crypto_wrap.c includes
>> <arm_neon.h>, an intrinsics header, which in turn requires <stdint.h>.
>>  This was introduced inhttps://svnweb.freebsd.org/changeset/base/308921,
>> and at the time resulted in similar build failures, specifically when
>> one attempted to build a new kernel, without building world or a new
>> toolchain first.
>
> Hi,
>
> Ok, it's finished building and installing. The command I used was this:
>
> # make -j10 buildworld && make -j10 buildkernel KERNCONF=RPI3

What is RPI3? Mine runs GENERIC and there is no RPI3 config in  
/usr/src/sys/arm64/conf. I can find RPI2 in sys/arm/conf.

Regards,
Ronald.

From tech-lists at zyxst.net  Sat Jul 14 11:24:32 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Sat, 14 Jul 2018 12:24:21 +0100
Subject: aarch64-arm64 fails to build kernel 12-current raspberry pi 3
In-Reply-To: <op.zl4z3hr7kndu52@klop.ws>
References: <A7BBACBB-44A1-4F95-B4F6-498B72238FC5@yahoo.com>
 <a8cc68ec-e87d-9133-7ad9-59c5b42ed749@zyxst.net>
 <2F72F7DB-F5DD-471A-B644-9CDE3FABFAC1@yahoo.com>
 <6DDED0A0-588D-4323-8E22-1267AA06615E@FreeBSD.org>
 <b7ec00a7-f30e-b0a6-bc7b-191e7d6ae367@zyxst.net> <op.zl4z3hr7kndu52@klop.ws>
Message-ID: <2350edc7-44a9-c04d-3b30-66bb6998e9e2@zyxst.net>

On 14/07/2018 11:15, Ronald Klop wrote:
> What is RPI3? Mine runs GENERIC and there is no RPI3 config in 
> /usr/src/sys/arm64/conf. I can find RPI2 in sys/arm/conf.

RPI3 is the same as GENERIC-NODEBUG, apart from the ident string which 
is also RPI3. (was mentioned at the start of the thread which branched off)

-- 
J.

From jbtakk at iherebuywisely.com  Sat Jul 14 11:36:16 2018
From: jbtakk at iherebuywisely.com (Jeffrey Bouquet)
Date: Sat, 14 Jul 2018 04:36:05 -0700 (PDT)
Subject: updates to HEAD online, RSS non-browser ??
Message-ID: <E1feIqM-0000DS-2g@rmmprod05.runbox>

secnetix.de used to let me read HEAD updates to src daily.  About several monhts ago, my browsers cannot reach it and the 2ndry site is tedious to read in an equivalent manner. AFAIK the site
is still up.  Recent EU laws or some other cause?  Reachable by some legal VPN trickery? 
RSS feed better serving to inform? legal web scraping connects to site when browsers cannot? 
.............
Thanks in advance.
.............

From alexvpetrov at gmail.com  Sat Jul 14 13:35:10 2018
From: alexvpetrov at gmail.com (Alex V. Petrov)
Date: Sat, 14 Jul 2018 20:35:03 +0700
Subject: error top?
Message-ID: <cecc41da-97dd-7785-9d47-df887cc20b0f@gmail.com>

1T Wired!!!
My system have 16G memory only.


last pid: 35599;  load averages:  8.53,  4.70,  3.52

                    up 1+01:20:57  20:30:17
310 processes: 11 running, 294 sleeping, 4 zombie, 1 waiting


CPU: 22.7% user, 72.9% nice,  4.4% system,  0.0% interrupt,  0.0% idle
Mem: 3G Active, 5G Inact, 2G Laundry, 1T Wired, 1G Buf, 524M Free
ARC: 2G Total, 337M MFU, 2G MRU, 3M Anon, 35M Header, 94M Other
     2G Compressed, 4G Uncompressed, 2.35:1 Ratio
Swap: 4G Total, 138M Used, 4G Free, 3% Inuse


FreeBSD 12.0-CURRENT FreeBSD 12.0-CURRENT #18 r336020 amd64


-- 
-----
Alex.

From markj at freebsd.org  Sat Jul 14 14:50:50 2018
From: markj at freebsd.org (Mark Johnston)
Date: Sat, 14 Jul 2018 10:42:59 -0400
Subject: error top?
In-Reply-To: <cecc41da-97dd-7785-9d47-df887cc20b0f@gmail.com>
References: <cecc41da-97dd-7785-9d47-df887cc20b0f@gmail.com>
Message-ID: <CAMw1wOwoYNzSkMFcaqr5tgWo4RQVZ7BVmo07pi8xyENQRwLiDw@mail.gmail.com>

On Sat, Jul 14, 2018, 09:36 Alex V. Petrov, <alexvpetrov at gmail.com> wrote:

> 1T Wired!!!
> My system have 16G memory only.
>
>
> last pid: 35599;  load averages:  8.53,  4.70,  3.52
>
>                     up 1+01:20:57  20:30:17
> 310 processes: 11 running, 294 sleeping, 4 zombie, 1 waiting
>
>
> CPU: 22.7% user, 72.9% nice,  4.4% system,  0.0% interrupt,  0.0% idle
> Mem: 3G Active, 5G Inact, 2G Laundry, 1T Wired, 1G Buf, 524M Free
> ARC: 2G Total, 337M MFU, 2G MRU, 3M Anon, 35M Header, 94M Other
>      2G Compressed, 4G Uncompressed, 2.35:1 Ratio
> Swap: 4G Total, 138M Used, 4G Free, 3% Inuse
>
>
> FreeBSD 12.0-CURRENT FreeBSD 12.0-CURRENT #18 r336020 amd64
>

Try updating to r336149 or later.

>

From lists at opsec.eu  Sat Jul 14 15:25:33 2018
From: lists at opsec.eu (Kurt Jaeger)
Date: Sat, 14 Jul 2018 17:25:33 +0200
Subject: updates to HEAD online, RSS non-browser ??
In-Reply-To: <E1feIqM-0000DS-2g@rmmprod05.runbox>
References: <E1feIqM-0000DS-2g@rmmprod05.runbox>
Message-ID: <20180714152533.GL77764@home.opsec.eu>

Hi!

> secnetix.de used to let me read HEAD updates to src daily.
> About
> several monhts ago, my browsers cannot reach it and the 2ndry site
> is tedious to read in an equivalent manner. AFAIK the site is still up.

I've checked (from .de) and the site is down.

Why don't you use the mailman archive ?

https://lists.freebsd.org/pipermail/svn-src-all/

-- 
pi at opsec.eu            +49 171 3101372                    2 years to go !

From jbtakk at iherebuywisely.com  Sat Jul 14 18:19:07 2018
From: jbtakk at iherebuywisely.com (Jeffrey Bouquet)
Date: Sat, 14 Jul 2018 11:19:03 -0700 (PDT)
Subject: updates to HEAD online, RSS non-browser ??
In-Reply-To: <20180714152533.GL77764@home.opsec.eu>
Message-ID: <E1feP8J-0004fg-Kt@rmmprod05.runbox>



On Sat, 14 Jul 2018 17:25:33 +0200, Kurt Jaeger <lists at opsec.eu> wrote:

> Hi!
> 
> > secnetix.de used to let me read HEAD updates to src daily.
> > About
> > several monhts ago, my browsers cannot reach it and the 2ndry site
> > is tedious to read in an equivalent manner. AFAIK the site is still up.
> 
> I've checked (from .de) and the site is down.

   Thanks.  I guess that's what I wanted to know

> 
> Why don't you use the mailman archive ?
> 
> https://lists.freebsd.org/pipermail/svn-src-all/

   I guess the best way to use that is script the downloadable archive and somehow
just read the part that's new from yesterday's downloadable archive.  So something to
test... 
> 
> -- 


     Thanks. 

From lars at gustik.eu  Sun Jul 15 01:19:22 2018
From: lars at gustik.eu (Lars Schotte)
Date: Sun, 15 Jul 2018 03:19:11 +0200
Subject: local_unbound segfaults at boot
In-Reply-To: <CAKS+cu1J7zfM+jtYwZrHJsPiPe4T==6-YJiNesb6kmmY1TD64g@mail.gmail.com>
References: <CAKS+cu1J7zfM+jtYwZrHJsPiPe4T==6-YJiNesb6kmmY1TD64g@mail.gmail.com>
Message-ID: <20180715031911.2ec8af3d@romy.j20.helspy.pw>

I see segfaulting too:

FreeBSD wasp.2km.casa 12.0-CURRENT FreeBSD 12.0-CURRENT #6 r336229: Fri Jul 13 01:51:31 CEST 2018     root at wasp.2km.casa:/usr/obj/usr/src/amd64.amd64/sys/GUSTIK  amd64
# service local_unbound restart
local_unbound not running? (check /var/run/local_unbound.pid).
Starting local_unbound.
Segmentation fault (core dumped)
/etc/rc.d/local_unbound: WARNING: failed to start local_unbound

# du -sh unbound.core 
 23M    unbound.core


On Sun, 3 Jun 2018 14:09:45 -0500
Patrick McMunn <doctorwhoguy at gmail.com> wrote:

> I believe the problem of local_unbound segfaulting began after I
> compiled the source after the large commit to unbound on Saturday,
> May 12, 2018 (about 3 weeks ago).
> 
> I assumed the problem was probably common if I was experiencing it,
> but I've seen no other mentions of it. I'm not sure what info I need
> to provide, but will do so upon request.
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to
> "freebsd-current-unsubscribe at freebsd.org"



-- 
 Lars Schotte
 Mudro?ova 13
92101 Pie??any

From lars at gustik.eu  Sun Jul 15 03:09:15 2018
From: lars at gustik.eu (Lars Schotte)
Date: Sun, 15 Jul 2018 05:09:12 +0200
Subject: PF synproxy 12 seems to work now
Message-ID: <20180715050912.1047123c@romy.j20.helspy.pw>

PF synproxy seems to work now on 12.
It would be nice to move those changes to 11-stable, because there it
is still broken. Just saying.

-- 
 Lars Schotte
 Mudro?ova 13
92101 Pie??any

From herbert at gojira.at  Sun Jul 15 08:16:15 2018
From: herbert at gojira.at (Herbert J. Skuhra)
Date: Sun, 15 Jul 2018 10:16:05 +0200
Subject: PF synproxy 12 seems to work now
In-Reply-To: <20180715050912.1047123c@romy.j20.helspy.pw>
References: <20180715050912.1047123c@romy.j20.helspy.pw>
Message-ID: <87601g29tm.wl-herbert@gojira.at>

On Sun, 15 Jul 2018 05:09:12 +0200, Lars Schotte wrote:
> 
> PF synproxy seems to work now on 12.
> It would be nice to move those changes to 11-stable, because there it
> is still broken. Just saying.

Are you talking about the following changes?

https://lists.freebsd.org/pipermail/svn-src-all/2018-July/167217.html
https://lists.freebsd.org/pipermail/svn-src-all/2018-July/167219.html

They are marked "MFC after: 1 week", so they should appear in
stable/11 soon.

--
Herbert

From herbert at gojira.at  Sun Jul 15 08:40:13 2018
From: herbert at gojira.at (Herbert J. Skuhra)
Date: Sun, 15 Jul 2018 10:40:10 +0200
Subject: local_unbound segfaults at boot
In-Reply-To: <20180715031911.2ec8af3d@romy.j20.helspy.pw>
References: <CAKS+cu1J7zfM+jtYwZrHJsPiPe4T==6-YJiNesb6kmmY1TD64g@mail.gmail.com>
 <20180715031911.2ec8af3d@romy.j20.helspy.pw>
Message-ID: <874lh028ph.wl-herbert@gojira.at>

On Sun, 15 Jul 2018 03:19:11 +0200, Lars Schotte wrote:
> 
> I see segfaulting too:
> 
> FreeBSD wasp.2km.casa 12.0-CURRENT FreeBSD 12.0-CURRENT #6 r336229: Fri Jul 13 01:51:31 CEST 2018     root at wasp.2km.casa:/usr/obj/usr/src/amd64.amd64/sys/GUSTIK  amd64
> # service local_unbound restart
> local_unbound not running? (check /var/run/local_unbound.pid).
> Starting local_unbound.
> Segmentation fault (core dumped)
> /etc/rc.d/local_unbound: WARNING: failed to start local_unbound
> 
> # du -sh unbound.core 
>  23M    unbound.core

unbound binaries were renamed to local-unbound.

https://svnweb.freebsd.org/base?view=revision&revision=333573

# ls -l /usr/sbin/*unbound*
-r-xr-xr-x  1 root  wheel  150416 Jul 10 16:17 /usr/sbin/local-unbound
-r-xr-xr-x  1 root  wheel   47944 Jul 10 16:17 /usr/sbin/local-unbound-anchor
-r-xr-xr-x  1 root  wheel   35608 Jul 10 16:17 /usr/sbin/local-unbound-checkconf
-r-xr-xr-x  1 root  wheel   39736 Jul 10 16:17 /usr/sbin/local-unbound-control
-r-xr-xr-x  1 root  wheel   11030 Jul 10 16:17 /usr/sbin/local-unbound-setup

Did you forget to run mergemaster, 'make delete-old' and 'make
delete-old-libs' after the upgrade?

--
Herbert

From marklmi at yahoo.com  Sun Jul 15 14:49:34 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Sun, 15 Jul 2018 07:49:29 -0700
Subject: emulators/virtualbox-ose-additions-nox11 fails to build in
 poudriere-devel for amd64 context: fails CTASSERT(sizeof(struct pcpu) ==
 UMA_PCPU_ALLOC_SIZE)
Message-ID: <DEB10A42-839B-424B-91D6-3EA98728EABE@yahoo.com>

The failure:

kBuild: Compiling VBoxGuestR0Lib - /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/Additions/common/VBoxGuest/lib/VBoxGuestR0LibPhysHeap.cpp
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/GuestHost/HGSMI/HGSMIMemAlloc.cpp:55:
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/HGSMIMemAlloc.h:31:
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/HGSMIDefs.h:35:
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/VBoxVideoIPRT.h:32:
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/string.h:45:
In file included from /usr/src/sys/sys/libkern.h:41:
In file included from /usr/src/sys/sys/systm.h:112:
/usr/src/sys/sys/pcpu.h:207:1: error: static_assert failed "compile-time assertion failed"
CTASSERT(sizeof(struct pcpu) == UMA_PCPU_ALLOC_SIZE);
^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
/usr/src/sys/sys/systm.h:107:21: note: expanded from macro 'CTASSERT'
#define CTASSERT(x)     _Static_assert(x, "compile-time assertion failed")
                        ^              ~

(There are other example places that fail the same assert condition.)

There is also a warning for PAGE_SIZE being redefined:

In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/Additions/common/VBoxGuest/lib/VBoxGuestR0LibInit.cpp:33:
In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/string.h:45:
In file included from /usr/src/sys/sys/libkern.h:41:
In file included from /usr/src/sys/sys/systm.h:111:
In file included from /usr/src/sys/sys/param.h:141:
/usr/include/machine/param.h:101:9: warning: 'PAGE_SIZE' macro redefined [-Wmacro-redefined]
#define PAGE_SIZE       (1<<PAGE_SHIFT) /* bytes/page */
        ^
/wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/param.h:52:10: note: previous definition is here
# define PAGE_SIZE          4096
         ^


Context:


# uname -apKU
FreeBSD FBSDUSSD 12.0-CURRENT FreeBSD 12.0-CURRENT  r336301M  amd64 amd64 1200072 1200072



# svnlite info /usr/ports | grep "Re[plv]"
Relative URL: ^/head
Repository Root: svn://svn.freebsd.org/ports
Repository UUID: 35697150-7ecd-e111-bb59-0022644237b5
Revision: 474654
Last Changed Rev: 474654



The "M" in r336301M is mostly for use with powerpc* family experiments based
on modern C/C++ compilers:

# svnlite status /usr/src/ | sort
?       /usr/src/sys/amd64/conf/GENERIC-DBG
?       /usr/src/sys/amd64/conf/GENERIC-NODBG
?       /usr/src/sys/arm/conf/GENERIC-DBG
?       /usr/src/sys/arm/conf/GENERIC-NODBG
?       /usr/src/sys/arm64/conf/GENERIC-DBG
?       /usr/src/sys/arm64/conf/GENERIC-NODBG
?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-DBG
?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-NODBG
?       /usr/src/sys/powerpc/conf/GENERICvtsc-DBG
?       /usr/src/sys/powerpc/conf/GENERICvtsc-NODBG
M       /usr/src/Makefile.libcompat
M       /usr/src/contrib/llvm/lib/Target/PowerPC/PPCFrameLowering.cpp
M       /usr/src/contrib/llvm/tools/lld/ELF/Arch/PPC64.cpp
M       /usr/src/crypto/openssl/crypto/armcap.c
M       /usr/src/lib/libkvm/kvm_powerpc.c
M       /usr/src/lib/libkvm/kvm_private.c
M       /usr/src/release/Makefile.vm
M       /usr/src/release/scripts/mk-vmimage.sh
M       /usr/src/release/tools/vmimage.subr
M       /usr/src/secure/lib/libcrypto/Makefile
M       /usr/src/stand/defs.mk
M       /usr/src/stand/powerpc/boot1.chrp/Makefile
M       /usr/src/stand/powerpc/kboot/Makefile
M       /usr/src/sys/arm64/arm64/identcpu.c
M       /usr/src/sys/conf/kmod.mk
M       /usr/src/sys/conf/ldscript.powerpc
M       /usr/src/sys/powerpc/aim/mmu_oea64.c
M       /usr/src/sys/powerpc/ofw/ofw_machdep.c

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From sgk at troutmask.apl.washington.edu  Sun Jul 15 15:07:04 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 08:06:38 -0700
Subject: [PATCH] Recent libm additions
Message-ID: <20180715150638.GA30154@troutmask.apl.washington.edu>

Apparently, the recents additions to libm were not
subject to any code review.  The following patch 
does two things.  First, it works around

https://bugs.llvm.org/show_bug.cgi?id=8532

Second, it removes the pollution of libm with the
polevll.c functions.  Those functions are used 
only in ld80/e_powl.c, and those functions should
be inlined.

Index: Makefile
===================================================================
--- Makefile	(revision 336304)
+++ Makefile	(working copy)
@@ -56,7 +56,6 @@
 	imprecise.c \
 	k_cos.c k_cosf.c k_exp.c k_expf.c k_rem_pio2.c k_sin.c k_sinf.c \
 	k_tan.c k_tanf.c \
-	polevll.c \
 	s_asinh.c s_asinhf.c s_atan.c s_atanf.c s_carg.c s_cargf.c s_cargl.c \
 	s_cbrt.c s_cbrtf.c s_ceil.c s_ceilf.c s_clog.c s_clogf.c \
 	s_copysign.c s_copysignf.c s_cos.c s_cosf.c \
Index: ld80/e_powl.c
===================================================================
--- ld80/e_powl.c	(revision 336304)
+++ ld80/e_powl.c	(working copy)
@@ -77,6 +77,7 @@
 #include <math.h>
 
 #include "math_private.h"
+#include "polevll.c"
 
 /* Table size */
 #define NXT 32
Index: src/math_private.h
===================================================================
--- src/math_private.h	(revision 336304)
+++ src/math_private.h	(working copy)
@@ -828,7 +828,4 @@
 long double __kernel_cosl(long double, long double);
 long double __kernel_tanl(long double, long double, int);
 
-long double __p1evll(long double, void *, int);
-long double __polevll(long double, void *, int);
-
 #endif /* !_MATH_PRIVATE_H_ */
Index: src/polevll.c
===================================================================
--- src/polevll.c	(revision 336304)
+++ src/polevll.c	(working copy)
@@ -69,7 +69,7 @@
  * Polynomial evaluator:
  *  P[0] x^n  +  P[1] x^(n-1)  +  ...  +  P[n]
  */
-long double
+static inline long double
 __polevll(long double x, void *PP, int n)
 {
 	long double y;
@@ -88,7 +88,7 @@
  * Polynomial evaluator:
  *  x^n  +  P[0] x^(n-1)  +  P[1] x^(n-2)  +  ...  +  P[n]
  */
-long double
+static inline long double
 __p1evll(long double x, void *PP, int n)
 {
 	long double y;
Index: src/s_cpow.c
===================================================================
--- src/s_cpow.c	(revision 336304)
+++ src/s_cpow.c	(working copy)
@@ -60,7 +60,7 @@
 	y = cimag (z);
 	absa = cabs (a);
 	if (absa == 0.0) {
-		return (0.0 + 0.0 * I);
+		return (CMPLX(0.0, 0.0));
 	}
 	arga = carg (a);
 	r = pow (absa, x);
@@ -69,6 +69,6 @@
 		r = r * exp (-y * arga);
 		theta = theta + y * log (absa);
 	}
-	w = r * cos (theta) + (r * sin (theta)) * I;
+	w = CMPLX(r * cos (theta),  r * sin (theta));
 	return (w);
 }
Index: src/s_cpowf.c
===================================================================
--- src/s_cpowf.c	(revision 336304)
+++ src/s_cpowf.c	(working copy)
@@ -59,7 +59,7 @@
 	y = cimagf(z);
 	absa = cabsf (a);
 	if (absa == 0.0f) {
-		return (0.0f + 0.0f * I);
+		return (CMPLXF(0.0f, 0.0f));
 	}
 	arga = cargf (a);
 	r = powf (absa, x);
@@ -68,6 +68,6 @@
 		r = r * expf (-y * arga);
 		theta = theta + y * logf (absa);
 	}
-	w = r * cosf (theta) + (r * sinf (theta)) * I;
+	w = CMPLXF(r * cosf (theta), r * sinf (theta));
 	return (w);
 }
Index: src/s_cpowl.c
===================================================================
--- src/s_cpowl.c	(revision 336304)
+++ src/s_cpowl.c	(working copy)
@@ -59,7 +59,7 @@
 	y = cimagl(z);
 	absa = cabsl(a);
 	if (absa == 0.0L) {
-		return (0.0L + 0.0L * I);
+		return (CMPLXL(0.0L, 0.0L));
 	}
 	arga = cargl(a);
 	r = powl(absa, x);
@@ -68,6 +68,6 @@
 		r = r * expl(-y * arga);
 		theta = theta + y * logl(absa);
 	}
-	w = r * cosl(theta) + (r * sinl(theta)) * I;
+	w = CMPLXL(r * cosl(theta), r * sinl(theta));
 	return (w);
 }

-- 
Steve

From imp at bsdimp.com  Sun Jul 15 16:15:10 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sun, 15 Jul 2018 10:14:57 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715150638.GA30154@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
Message-ID: <CANCZdfrRWOKo=VLL-_3R0k+kfbRvJvL1kUVYXxD755tP-EOgQQ@mail.gmail.com>

These changes look perfect to me.

Warner

On Sun, Jul 15, 2018, 9:08 AM Steve Kargl <sgk at troutmask.apl.washington.edu>
wrote:

> Apparently, the recents additions to libm were not
> subject to any code review.  The following patch
> does two things.  First, it works around
>
> https://bugs.llvm.org/show_bug.cgi?id=8532
>
> Second, it removes the pollution of libm with the
> polevll.c functions.  Those functions are used
> only in ld80/e_powl.c, and those functions should
> be inlined.
>
> Index: Makefile
> ===================================================================
> --- Makefile    (revision 336304)
> +++ Makefile    (working copy)
> @@ -56,7 +56,6 @@
>         imprecise.c \
>         k_cos.c k_cosf.c k_exp.c k_expf.c k_rem_pio2.c k_sin.c k_sinf.c \
>         k_tan.c k_tanf.c \
> -       polevll.c \
>         s_asinh.c s_asinhf.c s_atan.c s_atanf.c s_carg.c s_cargf.c
> s_cargl.c \
>         s_cbrt.c s_cbrtf.c s_ceil.c s_ceilf.c s_clog.c s_clogf.c \
>         s_copysign.c s_copysignf.c s_cos.c s_cosf.c \
> Index: ld80/e_powl.c
> ===================================================================
> --- ld80/e_powl.c       (revision 336304)
> +++ ld80/e_powl.c       (working copy)
> @@ -77,6 +77,7 @@
>  #include <math.h>
>
>  #include "math_private.h"
> +#include "polevll.c"
>
>  /* Table size */
>  #define NXT 32
> Index: src/math_private.h
> ===================================================================
> --- src/math_private.h  (revision 336304)
> +++ src/math_private.h  (working copy)
> @@ -828,7 +828,4 @@
>  long double __kernel_cosl(long double, long double);
>  long double __kernel_tanl(long double, long double, int);
>
> -long double __p1evll(long double, void *, int);
> -long double __polevll(long double, void *, int);
> -
>  #endif /* !_MATH_PRIVATE_H_ */
> Index: src/polevll.c
> ===================================================================
> --- src/polevll.c       (revision 336304)
> +++ src/polevll.c       (working copy)
> @@ -69,7 +69,7 @@
>   * Polynomial evaluator:
>   *  P[0] x^n  +  P[1] x^(n-1)  +  ...  +  P[n]
>   */
> -long double
> +static inline long double
>  __polevll(long double x, void *PP, int n)
>  {
>         long double y;
> @@ -88,7 +88,7 @@
>   * Polynomial evaluator:
>   *  x^n  +  P[0] x^(n-1)  +  P[1] x^(n-2)  +  ...  +  P[n]
>   */
> -long double
> +static inline long double
>  __p1evll(long double x, void *PP, int n)
>  {
>         long double y;
> Index: src/s_cpow.c
> ===================================================================
> --- src/s_cpow.c        (revision 336304)
> +++ src/s_cpow.c        (working copy)
> @@ -60,7 +60,7 @@
>         y = cimag (z);
>         absa = cabs (a);
>         if (absa == 0.0) {
> -               return (0.0 + 0.0 * I);
> +               return (CMPLX(0.0, 0.0));
>         }
>         arga = carg (a);
>         r = pow (absa, x);
> @@ -69,6 +69,6 @@
>                 r = r * exp (-y * arga);
>                 theta = theta + y * log (absa);
>         }
> -       w = r * cos (theta) + (r * sin (theta)) * I;
> +       w = CMPLX(r * cos (theta),  r * sin (theta));
>         return (w);
>  }
> Index: src/s_cpowf.c
> ===================================================================
> --- src/s_cpowf.c       (revision 336304)
> +++ src/s_cpowf.c       (working copy)
> @@ -59,7 +59,7 @@
>         y = cimagf(z);
>         absa = cabsf (a);
>         if (absa == 0.0f) {
> -               return (0.0f + 0.0f * I);
> +               return (CMPLXF(0.0f, 0.0f));
>         }
>         arga = cargf (a);
>         r = powf (absa, x);
> @@ -68,6 +68,6 @@
>                 r = r * expf (-y * arga);
>                 theta = theta + y * logf (absa);
>         }
> -       w = r * cosf (theta) + (r * sinf (theta)) * I;
> +       w = CMPLXF(r * cosf (theta), r * sinf (theta));
>         return (w);
>  }
> Index: src/s_cpowl.c
> ===================================================================
> --- src/s_cpowl.c       (revision 336304)
> +++ src/s_cpowl.c       (working copy)
> @@ -59,7 +59,7 @@
>         y = cimagl(z);
>         absa = cabsl(a);
>         if (absa == 0.0L) {
> -               return (0.0L + 0.0L * I);
> +               return (CMPLXL(0.0L, 0.0L));
>         }
>         arga = cargl(a);
>         r = powl(absa, x);
> @@ -68,6 +68,6 @@
>                 r = r * expl(-y * arga);
>                 theta = theta + y * logl(absa);
>         }
> -       w = r * cosl(theta) + (r * sinl(theta)) * I;
> +       w = CMPLXL(r * cosl(theta), r * sinl(theta));
>         return (w);
>  }
>
> --
> Steve
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From marklmi at yahoo.com  Sun Jul 15 16:26:50 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Sun, 15 Jul 2018 09:26:39 -0700
Subject: emulators/virtualbox-ose-additions-nox11 fails to build in
 poudriere-devel for amd64 context: fails CTASSERT(sizeof(struct pcpu) ==
 UMA_PCPU_ALLOC_SIZE)
In-Reply-To: <DEB10A42-839B-424B-91D6-3EA98728EABE@yahoo.com>
References: <DEB10A42-839B-424B-91D6-3EA98728EABE@yahoo.com>
Message-ID: <73DCC023-F5DF-47C2-A1F9-2893924DCC7D@yahoo.com>

[The build got to emulators/virtualbox-ose-additions and it also
failed this way. The PAGE_SIZE warning did not occur. More notes
added after the quoted history.]

On 2018-Jul-15, at 7:49 AM, Mark Millard <marklmi at yahoo.com> wrote:

> The failure:
> 
> kBuild: Compiling VBoxGuestR0Lib - /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/Additions/common/VBoxGuest/lib/VBoxGuestR0LibPhysHeap.cpp
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/GuestHost/HGSMI/HGSMIMemAlloc.cpp:55:
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/HGSMIMemAlloc.h:31:
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/HGSMIDefs.h:35:
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/VBox/Graphics/VBoxVideoIPRT.h:32:
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/string.h:45:
> In file included from /usr/src/sys/sys/libkern.h:41:
> In file included from /usr/src/sys/sys/systm.h:112:
> /usr/src/sys/sys/pcpu.h:207:1: error: static_assert failed "compile-time assertion failed"
> CTASSERT(sizeof(struct pcpu) == UMA_PCPU_ALLOC_SIZE);
> ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
> /usr/src/sys/sys/systm.h:107:21: note: expanded from macro 'CTASSERT'
> #define CTASSERT(x)     _Static_assert(x, "compile-time assertion failed")
>                        ^              ~
> 
> (There are other example places that fail the same assert condition.)
> 
> There is also a warning for PAGE_SIZE being redefined:
> 
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/src/VBox/Additions/common/VBoxGuest/lib/VBoxGuestR0LibInit.cpp:33:
> In file included from /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/string.h:45:
> In file included from /usr/src/sys/sys/libkern.h:41:
> In file included from /usr/src/sys/sys/systm.h:111:
> In file included from /usr/src/sys/sys/param.h:141:
> /usr/include/machine/param.h:101:9: warning: 'PAGE_SIZE' macro redefined [-Wmacro-redefined]
> #define PAGE_SIZE       (1<<PAGE_SHIFT) /* bytes/page */
>        ^
> /wrkdirs/usr/ports/emulators/virtualbox-ose-additions-nox11/work/VirtualBox-5.2.14/include/iprt/param.h:52:10: note: previous definition is here
> # define PAGE_SIZE          4096
>         ^
> 
> 
> Context:
> 
> 
> # uname -apKU
> FreeBSD FBSDUSSD 12.0-CURRENT FreeBSD 12.0-CURRENT  r336301M  amd64 amd64 1200072 1200072
> 
> 
> 
> # svnlite info /usr/ports | grep "Re[plv]"
> Relative URL: ^/head
> Repository Root: svn://svn.freebsd.org/ports
> Repository UUID: 35697150-7ecd-e111-bb59-0022644237b5
> Revision: 474654
> Last Changed Rev: 474654
> 
> 
> 
> The "M" in r336301M is mostly for use with powerpc* family experiments based
> on modern C/C++ compilers:
> 
> # svnlite status /usr/src/ | sort
> ?       /usr/src/sys/amd64/conf/GENERIC-DBG
> ?       /usr/src/sys/amd64/conf/GENERIC-NODBG
> ?       /usr/src/sys/arm/conf/GENERIC-DBG
> ?       /usr/src/sys/arm/conf/GENERIC-NODBG
> ?       /usr/src/sys/arm64/conf/GENERIC-DBG
> ?       /usr/src/sys/arm64/conf/GENERIC-NODBG
> ?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-DBG
> ?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-NODBG
> ?       /usr/src/sys/powerpc/conf/GENERICvtsc-DBG
> ?       /usr/src/sys/powerpc/conf/GENERICvtsc-NODBG
> M       /usr/src/Makefile.libcompat
> M       /usr/src/contrib/llvm/lib/Target/PowerPC/PPCFrameLowering.cpp
> M       /usr/src/contrib/llvm/tools/lld/ELF/Arch/PPC64.cpp
> M       /usr/src/crypto/openssl/crypto/armcap.c
> M       /usr/src/lib/libkvm/kvm_powerpc.c
> M       /usr/src/lib/libkvm/kvm_private.c
> M       /usr/src/release/Makefile.vm
> M       /usr/src/release/scripts/mk-vmimage.sh
> M       /usr/src/release/tools/vmimage.subr
> M       /usr/src/secure/lib/libcrypto/Makefile
> M       /usr/src/stand/defs.mk
> M       /usr/src/stand/powerpc/boot1.chrp/Makefile
> M       /usr/src/stand/powerpc/kboot/Makefile
> M       /usr/src/sys/arm64/arm64/identcpu.c
> M       /usr/src/sys/conf/kmod.mk
> M       /usr/src/sys/conf/ldscript.powerpc
> M       /usr/src/sys/powerpc/aim/mmu_oea64.c
> M       /usr/src/sys/powerpc/ofw/ofw_machdep.c

emulators/virtualbox-ose-additions also got the error. But it did
not get the PAGE_SIZE warning.


There was also in both variants the likes of (3 times for each):

/wrkdirs/usr/ports/emulators/virtualbox-ose-additions/work/VirtualBox-5.2.14/src/VBox/Runtime/common/asm/ASMSerializeInstruction-iret.asm:46: warning: `ss' segment register ignored in 64-bit mode


And there were lots of notices for:

warning: flexible array members are a C99 feature [-Wc99-extensions]
warning: 'register' storage class specifier is deprecated and incompatible with C++17 [-Wdeprecated-register]

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From ian at freebsd.org  Sun Jul 15 17:00:54 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sun, 15 Jul 2018 11:00:41 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715150638.GA30154@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
Message-ID: <1531674041.26036.1.camel@freebsd.org>

On Sun, 2018-07-15 at 08:06 -0700, Steve Kargl wrote:
> Apparently, the recents additions to libm were not
> subject to any code review.??The following patch?
> does two things.??First, it works around
> 
> https://bugs.llvm.org/show_bug.cgi?id=8532
> 
> Second, it removes the pollution of libm with the
> polevll.c functions.??Those functions are used?
> only in ld80/e_powl.c, and those functions should
> be inlined.
> 
> Index: Makefile
> ===================================================================
> --- Makefile	(revision 336304)
> +++ Makefile	(working copy)
> @@ -56,7 +56,6 @@
> ?	imprecise.c \
> ?	k_cos.c k_cosf.c k_exp.c k_expf.c k_rem_pio2.c k_sin.c k_sinf.c \
> ?	k_tan.c k_tanf.c \
> -	polevll.c \
> ?	s_asinh.c s_asinhf.c s_atan.c s_atanf.c s_carg.c s_cargf.c s_cargl.c \
> ?	s_cbrt.c s_cbrtf.c s_ceil.c s_ceilf.c s_clog.c s_clogf.c \
> ?	s_copysign.c s_copysignf.c s_cos.c s_cosf.c \
> Index: ld80/e_powl.c
> ===================================================================
> --- ld80/e_powl.c	(revision 336304)
> +++ ld80/e_powl.c	(working copy)
> @@ -77,6 +77,7 @@
> ?#include 
> ?
> ?#include "math_private.h"
> +#include "polevll.c"
> ?
> ?/* Table size */
> ?#define NXT 32
> Index: src/math_private.h
> ===================================================================
> --- src/math_private.h	(revision 336304)
> +++ src/math_private.h	(working copy)
> @@ -828,7 +828,4 @@
> ?long double __kernel_cosl(long double, long double);
> ?long double __kernel_tanl(long double, long double, int);
> ?
> -long double __p1evll(long double, void *, int);
> -long double __polevll(long double, void *, int);
> -
> ?#endif /* !_MATH_PRIVATE_H_ */
> Index: src/polevll.c
> ===================================================================
> --- src/polevll.c	(revision 336304)
> +++ src/polevll.c	(working copy)
> @@ -69,7 +69,7 @@
> ? * Polynomial evaluator:
> ? *??P[0] x^n??+??P[1] x^(n-1)??+??...??+??P[n]
> ? */
> -long double
> +static inline long double
> ?__polevll(long double x, void *PP, int n)
> ?{
> ?	long double y;
> @@ -88,7 +88,7 @@
> ? * Polynomial evaluator:
> ? *??x^n??+??P[0] x^(n-1)??+??P[1] x^(n-2)??+??...??+??P[n]
> ? */
> -long double
> +static inline long double
> ?__p1evll(long double x, void *PP, int n)
> ?{
> ?	long double y;
> Index: src/s_cpow.c
> ===================================================================
> --- src/s_cpow.c	(revision 336304)
> +++ src/s_cpow.c	(working copy)
> @@ -60,7 +60,7 @@
> ?	y = cimag (z);
> ?	absa = cabs (a);
> ?	if (absa == 0.0) {
> -		return (0.0 + 0.0 * I);
> +		return (CMPLX(0.0, 0.0));
> ?	}
> ?	arga = carg (a);
> ?	r = pow (absa, x);
> @@ -69,6 +69,6 @@
> ?		r = r * exp (-y * arga);
> ?		theta = theta + y * log (absa);
> ?	}
> -	w = r * cos (theta) + (r * sin (theta)) * I;
> +	w = CMPLX(r * cos (theta),??r * sin (theta));
> ?	return (w);
> ?}
> Index: src/s_cpowf.c
> ===================================================================
> --- src/s_cpowf.c	(revision 336304)
> +++ src/s_cpowf.c	(working copy)
> @@ -59,7 +59,7 @@
> ?	y = cimagf(z);
> ?	absa = cabsf (a);
> ?	if (absa == 0.0f) {
> -		return (0.0f + 0.0f * I);
> +		return (CMPLXF(0.0f, 0.0f));
> ?	}
> ?	arga = cargf (a);
> ?	r = powf (absa, x);
> @@ -68,6 +68,6 @@
> ?		r = r * expf (-y * arga);
> ?		theta = theta + y * logf (absa);
> ?	}
> -	w = r * cosf (theta) + (r * sinf (theta)) * I;
> +	w = CMPLXF(r * cosf (theta), r * sinf (theta));
> ?	return (w);
> ?}
> Index: src/s_cpowl.c
> ===================================================================
> --- src/s_cpowl.c	(revision 336304)
> +++ src/s_cpowl.c	(working copy)
> @@ -59,7 +59,7 @@
> ?	y = cimagl(z);
> ?	absa = cabsl(a);
> ?	if (absa == 0.0L) {
> -		return (0.0L + 0.0L * I);
> +		return (CMPLXL(0.0L, 0.0L));
> ?	}
> ?	arga = cargl(a);
> ?	r = powl(absa, x);
> @@ -68,6 +68,6 @@
> ?		r = r * expl(-y * arga);
> ?		theta = theta + y * logl(absa);
> ?	}
> -	w = r * cosl(theta) + (r * sinl(theta)) * I;
> +	w = CMPLXL(r * cosl(theta), r * sinl(theta));
> ?	return (w);
> ?}
> 

If a file contains inline function definitions and is intended only to
be included into another file and not compiled separately, shouldn't
its name be spelled polevll.h ?

-- Ian

From sgk at troutmask.apl.washington.edu  Sun Jul 15 17:17:39 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 10:17:37 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <1531674041.26036.1.camel@freebsd.org>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
Message-ID: <20180715171737.GA31164@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 11:00:41AM -0600, Ian Lepore wrote:
> On Sun, 2018-07-15 at 08:06 -0700, Steve Kargl wrote:
> > Index: ld80/e_powl.c
> > ===================================================================
> > --- ld80/e_powl.c	(revision 336304)
> > +++ ld80/e_powl.c	(working copy)
> > @@ -77,6 +77,7 @@
> > ?#include 
> > ?
> > ?#include "math_private.h"
> > +#include "polevll.c"
> 
> If a file contains inline function definitions and is intended only to
> be included into another file and not compiled separately, shouldn't
> its name be spelled polevll.h ?
> 

Well, actually, the functions in polevll.c should have been copied
into ld80/e_powl.c, and polevall.c should never have been committed.
Unfortunately, the code was not reviewed for correctness.  I've
made the minimum changes to address the two issues I've noted.
Feel free to either copy the functions and delete the polevall.c
or rename it.

-- 
Steve

From kmacy at freebsd.org  Sun Jul 15 17:21:29 2018
From: kmacy at freebsd.org (K. Macy)
Date: Sun, 15 Jul 2018 10:21:25 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715171737.GA31164@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
Message-ID: <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>

>
> Well, actually, the functions in polevll.c should have been copied
> into ld80/e_powl.c, and polevall.c should never have been committed.
> Unfortunately, the code was not reviewed for correctness.

That is not correct. Please stop repeating it. Bruce Evans and John
Baldwin were both looped in. Neither made this observation.

From imp at bsdimp.com  Sun Jul 15 17:56:07 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sun, 15 Jul 2018 11:55:54 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
Message-ID: <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>

On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:

> >
> > Well, actually, the functions in polevll.c should have been copied
> > into ld80/e_powl.c, and polevall.c should never have been committed.
> > Unfortunately, the code was not reviewed for correctness.
>
> That is not correct. Please stop repeating it. Bruce Evans and John
> Baldwin were both looped in. Neither made this observation.
>

Steve is the fp guy these days. And it wasn't reviewed by him. He's mad you
cut him out of the loop. Arguing about pedantic points of process does no
one any good.

Warner

_______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>

From mmacy at freebsd.org  Sun Jul 15 18:03:54 2018
From: mmacy at freebsd.org (Matthew Macy)
Date: Sun, 15 Jul 2018 11:03:52 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
 <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
Message-ID: <CAPrugNqXd9ar1Qv3L_ae++nmvxOeX1v+RqpTf3FVu=0BXm7dvA@mail.gmail.com>

On Sun, Jul 15, 2018 at 10:55 AM, Warner Losh <imp at bsdimp.com> wrote:
> On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
>
>> >
>> > Well, actually, the functions in polevll.c should have been copied
>> > into ld80/e_powl.c, and polevall.c should never have been committed.
>> > Unfortunately, the code was not reviewed for correctness.
>>
>> That is not correct. Please stop repeating it. Bruce Evans and John
>> Baldwin were both looped in. Neither made this observation.
>>
>
> Steve is the fp guy these days. And it wasn't reviewed by him. He's mad you
> cut him out of the loop. Arguing about pedantic points of process does no
> one any good.

Thanks for the tip. I'm sorry. I was under the impression that he gave
up his bit: https://reviews.freebsd.org/rD46886

So we have a maintainer who has opted to not have a bit. So be it.

Nonetheless, reviews.freebsd.org is the established channel by which
the project does code reviews. I stand by my recommendation and will
add him to reviews in the future.

From ian at freebsd.org  Sun Jul 15 18:06:51 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sun, 15 Jul 2018 12:06:47 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
 <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
Message-ID: <1531678007.26036.10.camel@freebsd.org>

On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
> On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
> 
> > 
> > > 
> > > 
> > > Well, actually, the functions in polevll.c should have been
> > > copied
> > > into ld80/e_powl.c, and polevall.c should never have been
> > > committed.
> > > Unfortunately, the code was not reviewed for correctness.
> > That is not correct. Please stop repeating it. Bruce Evans and John
> > Baldwin were both looped in. Neither made this observation.
> > 
> Steve is the fp guy these days. And it wasn't reviewed by him. He's
> mad you
> cut him out of the loop. Arguing about pedantic points of process
> does no
> one any good.
> 
> Warner

On the other hand, what information is there for someone to know that
Steve should be involved in a review? There is nothing in MAINTAINERS.
The review was on phab for almost a month, and phab is supposedly the
preferred way to do reviews these days.

Steve is no longer a committer, but that doesn't preclude him having a
phab account and participating in reviews. If he doesn't like using
phab (and I can certainly understand that POV), an entry in MAINTAINERS
would still be helpful, unless we have a rule that only committers can
be listed in there.

-- Ian


From sgk at troutmask.apl.washington.edu  Sun Jul 15 18:26:04 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 11:26:00 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
Message-ID: <20180715182600.GB31164@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 10:21:25AM -0700, K. Macy wrote:
> >
> > Well, actually, the functions in polevll.c should have been copied
> > into ld80/e_powl.c, and polevall.c should never have been committed.
> > Unfortunately, the code was not reviewed for correctness.
> 
> That is not correct. Please stop repeating it. Bruce Evans and John
> Baldwin were both looped in. Neither made this observation.

I read the differential review.  The code was not reviewed by John.
He reviewed how it was hooked into the build.  Bruce does not appear
in the differential review.   There is no record on freebsd-numerics
about the patch.

powl on i686-class hardware is likely broken as it does not use
the LD80C macro to construct literal constants.

-- 
Steve

From sgk at troutmask.apl.washington.edu  Sun Jul 15 18:33:39 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 11:33:37 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <1531678007.26036.10.camel@freebsd.org>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
 <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
 <1531678007.26036.10.camel@freebsd.org>
Message-ID: <20180715183337.GC31164@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 12:06:47PM -0600, Ian Lepore wrote:
> 
> On the other hand, what information is there for someone to know that
> Steve should be involved in a review? There is nothing in MAINTAINERS.
> The review was on phab for almost a month, and phab is supposedly the
> preferred way to do reviews these days.
> 
> Steve is no longer a committer, but that doesn't preclude him having a
> phab account and participating in reviews. If he doesn't like using
> phab (and I can certainly understand that POV), an entry in MAINTAINERS
> would still be helpful, unless we have a rule that only committers can
> be listed in there.
> 

Patch should be sent the the freebsd-numeric mailing list.
phab appear after I was forced to hand in my commit bit, so
I don't have a phab account.

-- 
Steve

From sgk at troutmask.apl.washington.edu  Sun Jul 15 18:38:55 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 11:38:53 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAPrugNrBNFXEtQxwu7023U8NRVm+dutTSjjtetKbFv-w1fEeKQ@mail.gmail.com>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAPrugNrBNFXEtQxwu7023U8NRVm+dutTSjjtetKbFv-w1fEeKQ@mail.gmail.com>
Message-ID: <20180715183853.GD31164@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 10:44:28AM -0700, Matthew Macy wrote:
> 
> In the bug report you cite, Chris Lattner states: "This is actually an
> unspecified feature of C99 (whether it supports the _Imaginary type).
> It is desirable to support this, but not a regression.
> 

Chris Lattner is wrong when the use of I in an express
gives the wrong answer.  He can claim Annex F and G are
non-normative, but a wrong answer is still wrong.

Go read msun/src/math_private.h.  FreeBSD clearly does 
not use I in libm code, because it has consequences for
floating point numerical code.

-- 
Steve

From mat.macy at gmail.com  Sun Jul 15 17:44:30 2018
From: mat.macy at gmail.com (Matthew Macy)
Date: Sun, 15 Jul 2018 10:44:28 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715171737.GA31164@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
Message-ID: <CAPrugNrBNFXEtQxwu7023U8NRVm+dutTSjjtetKbFv-w1fEeKQ@mail.gmail.com>

On Sun, Jul 15, 2018 at 10:17 AM, Steve Kargl
<sgk at troutmask.apl.washington.edu> wrote:
> On Sun, Jul 15, 2018 at 11:00:41AM -0600, Ian Lepore wrote:
>> On Sun, 2018-07-15 at 08:06 -0700, Steve Kargl wrote:
>> > Index: ld80/e_powl.c
>> > ===================================================================
>> > --- ld80/e_powl.c   (revision 336304)
>> > +++ ld80/e_powl.c   (working copy)
>> > @@ -77,6 +77,7 @@
>> >  #include
>> >
>> >  #include "math_private.h"
>> > +#include "polevll.c"
>>
>> If a file contains inline function definitions and is intended only to
>> be included into another file and not compiled separately, shouldn't
>> its name be spelled polevll.h ?
>>
>
> Well, actually, the functions in polevll.c should have been copied
> into ld80/e_powl.c, and polevall.c should never have been committed.
> Unfortunately, the code was not reviewed for correctness.  I've
> made the minimum changes to address the two issues I've noted.
> Feel free to either copy the functions and delete the polevall.c
> or rename it.
>


In the bug report you cite, Chris Lattner states: "This is actually an
unspecified feature of C99 (whether it supports the _Imaginary type).
It is desirable to support this, but not a regression.

I'm more than happy to commit these changes, but neither including a
.c file nor compensating for the absence of a gcc feature in clang is
a correctness fix. In the future you might wish to subscribe to phab
reviews so that you can be notified when changes like this are under
consideration. Thank you for your input.

-M

From mmacy at freebsd.org  Sun Jul 15 18:41:03 2018
From: mmacy at freebsd.org (Matthew Macy)
Date: Sun, 15 Jul 2018 11:41:01 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715183337.GC31164@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <1531674041.26036.1.camel@freebsd.org>
 <20180715171737.GA31164@troutmask.apl.washington.edu>
 <CAHM0Q_OMYUe4CDemC8Gx9AGzA+wK0cctwUhHieeQi2xdDs0urA@mail.gmail.com>
 <CANCZdfrYrz0971Grk5E-hrQd+APZVfNewvDPj19D-T_JZ_1kJw@mail.gmail.com>
 <1531678007.26036.10.camel@freebsd.org>
 <20180715183337.GC31164@troutmask.apl.washington.edu>
Message-ID: <CAPrugNpuw0fJgzGLHebNg4r8mSNRx-tyMxv_z9b7_MNgZMvibg@mail.gmail.com>

On Sun, Jul 15, 2018 at 11:33 AM, Steve Kargl
<sgk at troutmask.apl.washington.edu> wrote:
> On Sun, Jul 15, 2018 at 12:06:47PM -0600, Ian Lepore wrote:
>>
>> On the other hand, what information is there for someone to know that
>> Steve should be involved in a review? There is nothing in MAINTAINERS.
>> The review was on phab for almost a month, and phab is supposedly the
>> preferred way to do reviews these days.
>>
>> Steve is no longer a committer, but that doesn't preclude him having a
>> phab account and participating in reviews. If he doesn't like using
>> phab (and I can certainly understand that POV), an entry in MAINTAINERS
>> would still be helpful, unless we have a rule that only committers can
>> be listed in there.
>>
>
> Patch should be sent the the freebsd-numeric mailing list.
> phab appear after I was forced to hand in my commit bit, so
> I don't have a phab account.

Anyone can have a phab account.

-M

From Cy.Schubert at cschubert.com  Sun Jul 15 18:43:07 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Sun, 15 Jul 2018 11:43:04 -0700
Subject: [PATCH] Recent libm additions
Message-ID: <20180715184255.4965AE50@spqr.komquats.com>

I don't think it makes sense for a non-committer to have a lock on anything in base. However a request for review makes a lot of sense. If a non-committer or former committer is the SME on a particular subject it's best that they be consulted even if they don't request it. IMO more input is better. Where better to document this than in MAINTAINERS.

Having said all this. If a person is a former committer and it's not documented, how are we to know?

If people agree, should we start documenting SMEs in MAINTAINERS?

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---

-----Original Message-----
From: Ian Lepore
Sent: 15/07/2018 11:08
To: Warner Losh; K. Macy
Cc: Steve Kargl; FreeBSD Current
Subject: Re: [PATCH] Recent libm additions

On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
> On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
> 
> > 
> > > 
> > > 
> > > Well, actually, the functions in polevll.c should have been
> > > copied
> > > into ld80/e_powl.c, and polevall.c should never have been
> > > committed.
> > > Unfortunately, the code was not reviewed for correctness.
> > That is not correct. Please stop repeating it. Bruce Evans and John
> > Baldwin were both looped in. Neither made this observation.
> > 
> Steve is the fp guy these days. And it wasn't reviewed by him. He's
> mad you
> cut him out of the loop. Arguing about pedantic points of process
> does no
> one any good.
> 
> Warner

On the other hand, what information is there for someone to know that
Steve should be involved in a review? There is nothing in MAINTAINERS.
The review was on phab for almost a month, and phab is supposedly the
preferred way to do reviews these days.

Steve is no longer a committer, but that doesn't preclude him having a
phab account and participating in reviews. If he doesn't like using
phab (and I can certainly understand that POV), an entry in MAINTAINERS
would still be helpful, unless we have a rule that only committers can
be listed in there.

-- Ian

_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


From imp at bsdimp.com  Sun Jul 15 19:09:43 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sun, 15 Jul 2018 13:09:41 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715184255.4965AE50@spqr.komquats.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
Message-ID: <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>

I'm not saying that he has a lock. I'm saying he's are domain expert and
many mistakes can be avoided by talking to him.

I'm saying we have history here, and that history, while poorly documented,
wasn't followed. To the extent it is poorly documented, we should fix that.

Warner

On Sun, Jul 15, 2018 at 12:43 PM, Cy Schubert <Cy.Schubert at cschubert.com>
wrote:

> I don't think it makes sense for a non-committer to have a lock on
> anything in base. However a request for review makes a lot of sense. If a
> non-committer or former committer is the SME on a particular subject it's
> best that they be consulted even if they don't request it. IMO more input
> is better. Where better to document this than in MAINTAINERS.
>
> Having said all this. If a person is a former committer and it's not
> documented, how are we to know?
>
> If people agree, should we start documenting SMEs in MAINTAINERS?
>
> ---
> Sent using a tiny phone keyboard.
> Apologies for any typos and autocorrect.
> Also, this old phone only supports top post. Apologies.
>
> Cy Schubert
> <Cy.Schubert at cschubert.com> or <cy at freebsd.org>
> The need of the many outweighs the greed of the few.
> ---
> ------------------------------
> From: Ian Lepore
> Sent: 15/07/2018 11:08
> To: Warner Losh; K. Macy
> Cc: Steve Kargl; FreeBSD Current
> Subject: Re: [PATCH] Recent libm additions
>
> On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
> > On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
> >
> > >
> > > >
> > > >
> > > > Well, actually, the functions in polevll.c should have been
> > > > copied
> > > > into ld80/e_powl.c, and polevall.c should never have been
> > > > committed.
> > > > Unfortunately, the code was not reviewed for correctness.
> > > That is not correct. Please stop repeating it. Bruce Evans and John
> > > Baldwin were both looped in. Neither made this observation.
> > >
> > Steve is the fp guy these days. And it wasn't reviewed by him. He's
> > mad you
> > cut him out of the loop. Arguing about pedantic points of process
> > does no
> > one any good.
> >
> > Warner
>
> On the other hand, what information is there for someone to know that
> Steve should be involved in a review? There is nothing in MAINTAINERS.
> The review was on phab for almost a month, and phab is supposedly the
> preferred way to do reviews these days.
>
> Steve is no longer a committer, but that doesn't preclude him having a
> phab account and participating in reviews. If he doesn't like using
> phab (and I can certainly understand that POV), an entry in MAINTAINERS
> would still be helpful, unless we have a rule that only committers can
> be listed in there.
>
> -- Ian
>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>
>

From Cy.Schubert at cschubert.com  Sun Jul 15 19:23:16 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Sun, 15 Jul 2018 12:23:06 -0700
Subject: [PATCH] Recent libm additions
Message-ID: <20180715192307.45EE0ED6@spqr.komquats.com>

I wasn't saying Steve has a lock however in case non-committers might feel they do, addressing all points in my reply. Not saying anyone feels this way today but we should consider this in whatever we decide here (considering all possibilities). IMO adding subject matter experts to MAINTAINERS seems like the easiest way to document who might be the go-to person.

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---

-----Original Message-----
From: Warner Losh
Sent: 15/07/2018 12:09
To: Cy Schubert
Cc: Ian Lepore; K. Macy; Steve Kargl; FreeBSD Current
Subject: Re: [PATCH] Recent libm additions

I'm not saying that he has a lock. I'm saying he's are domain expert and many mistakes can be avoided by talking to him.



I'm saying we have history here, and that history, while poorly documented, wasn't followed. To the extent it is poorly documented, we should fix that.




Warner





On Sun, Jul 15, 2018 at 12:43 PM, Cy Schubert <Cy.Schubert at cschubert.com> wrote:




I don't think it makes sense for a non-committer to have a lock on anything in base. However a request for review makes a lot of sense. If a non-committer or former committer is the SME on a particular subject it's best that they be consulted even if they don't request it. IMO more input is better. Where better to document this than in MAINTAINERS.

Having said all this. If a person is a former committer and it's not documented, how are we to know?

If people agree, should we start documenting SMEs in MAINTAINERS?

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---



From: Ian Lepore
Sent: 15/07/2018 11:08
To: Warner Losh; K. Macy
Cc: Steve Kargl; FreeBSD Current
Subject: Re: [PATCH] Recent libm additions

On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
> On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
> 
> > 
> > > 
> > > 
> > > Well, actually, the functions in polevll.c should have been
> > > copied
> > > into ld80/e_powl.c, and polevall.c should never have been
> > > committed.
> > > Unfortunately, the code was not reviewed for correctness.
> > That is not correct. Please stop repeating it. Bruce Evans and John
> > Baldwin were both looped in. Neither made this observation.
> > 
> Steve is the fp guy these days. And it wasn't reviewed by him. He's
> mad you
> cut him out of the loop. Arguing about pedantic points of process
> does no
> one any good.
> 
> Warner

On the other hand, what information is there for someone to know that
Steve should be involved in a review? There is nothing in MAINTAINERS.
The review was on phab for almost a month, and phab is supposedly the
preferred way to do reviews these days.

Steve is no longer a committer, but that doesn't preclude him having a
phab account and participating in reviews. If he doesn't like using
phab (and I can certainly understand that POV), an entry in MAINTAINERS
would still be helpful, unless we have a rule that only committers can
be listed in there.

-- Ian

_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


 

From imp at bsdimp.com  Sun Jul 15 19:26:33 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sun, 15 Jul 2018 13:26:31 -0600
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715192307.45EE0ED6@spqr.komquats.com>
References: <20180715192307.45EE0ED6@spqr.komquats.com>
Message-ID: <CANCZdfro3W-Pp0tATMBqDJbC7BLXFQmkqMDSEe9tkO4+Z34UsA@mail.gmail.com>

So something like this:

diff --git a/MAINTAINERS b/MAINTAINERS
index 51d3688f8b8..3e6584f24a1 100644
--- a/MAINTAINERS
+++ b/MAINTAINERS
@@ -58,6 +58,7 @@ kqueue                jmg     Pre-commit review
requested.  Documentation Required.
 libdpv         dteske  Pre-commit review requested. Keep in sync with
dpv(1).
 libfetch       des     Pre-commit review requested, email only.
 libfigpar      dteske  Pre-commit review requested.
+libm           freebsd-numerics        Send email with patches to
freebsd-numerics@
 libpam         des     Pre-commit review requested, email only.
 linprocfs      des     Pre-commit review requested, email only.
 lpr            gad     Pre-commit review requested, particularly for

is what you're suggesting?

Warner

On Sun, Jul 15, 2018 at 1:23 PM, Cy Schubert <Cy.Schubert at cschubert.com>
wrote:

> I wasn't saying Steve has a lock however in case non-committers might feel
> they do, addressing all points in my reply. Not saying anyone feels this
> way today but we should consider this in whatever we decide here
> (considering all possibilities). IMO adding subject matter experts to
> MAINTAINERS seems like the easiest way to document who might be the go-to
> person.
>
> ---
> Sent using a tiny phone keyboard.
> Apologies for any typos and autocorrect.
> Also, this old phone only supports top post. Apologies.
>
> Cy Schubert
> <Cy.Schubert at cschubert.com> or <cy at freebsd.org>
> The need of the many outweighs the greed of the few.
> ---
> ------------------------------
> From: Warner Losh
> Sent: 15/07/2018 12:09
> To: Cy Schubert
> Cc: Ian Lepore; K. Macy; Steve Kargl; FreeBSD Current
>
> Subject: Re: [PATCH] Recent libm additions
>
> I'm not saying that he has a lock. I'm saying he's are domain expert and
> many mistakes can be avoided by talking to him.
>
> I'm saying we have history here, and that history, while poorly
> documented, wasn't followed. To the extent it is poorly documented, we
> should fix that.
>
> Warner
>
> On Sun, Jul 15, 2018 at 12:43 PM, Cy Schubert <Cy.Schubert at cschubert.com>
> wrote:
>
>> I don't think it makes sense for a non-committer to have a lock on
>> anything in base. However a request for review makes a lot of sense. If a
>> non-committer or former committer is the SME on a particular subject it's
>> best that they be consulted even if they don't request it. IMO more input
>> is better. Where better to document this than in MAINTAINERS.
>>
>> Having said all this. If a person is a former committer and it's not
>> documented, how are we to know?
>>
>> If people agree, should we start documenting SMEs in MAINTAINERS?
>>
>> ---
>> Sent using a tiny phone keyboard.
>> Apologies for any typos and autocorrect.
>> Also, this old phone only supports top post. Apologies.
>>
>> Cy Schubert
>> <Cy.Schubert at cschubert.com> or <cy at freebsd.org>
>> The need of the many outweighs the greed of the few.
>> ---
>> ------------------------------
>> From: Ian Lepore
>> Sent: 15/07/2018 11:08
>> To: Warner Losh; K. Macy
>> Cc: Steve Kargl; FreeBSD Current
>> Subject: Re: [PATCH] Recent libm additions
>>
>> On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
>> > On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
>> >
>> > >
>> > > >
>> > > >
>> > > > Well, actually, the functions in polevll.c should have been
>> > > > copied
>> > > > into ld80/e_powl.c, and polevall.c should never have been
>> > > > committed.
>> > > > Unfortunately, the code was not reviewed for correctness.
>> > > That is not correct. Please stop repeating it. Bruce Evans and John
>> > > Baldwin were both looped in. Neither made this observation.
>> > >
>> > Steve is the fp guy these days. And it wasn't reviewed by him. He's
>> > mad you
>> > cut him out of the loop. Arguing about pedantic points of process
>> > does no
>> > one any good.
>> >
>> > Warner
>>
>> On the other hand, what information is there for someone to know that
>> Steve should be involved in a review? There is nothing in MAINTAINERS.
>> The review was on phab for almost a month, and phab is supposedly the
>> preferred way to do reviews these days.
>>
>> Steve is no longer a committer, but that doesn't preclude him having a
>> phab account and participating in reviews. If he doesn't like using
>> phab (and I can certainly understand that POV), an entry in MAINTAINERS
>> would still be helpful, unless we have a rule that only committers can
>> be listed in there.
>>
>> -- Ian
>>
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org
>> "
>>
>>
>

From stephen at missouri.edu  Sun Jul 15 19:43:58 2018
From: stephen at missouri.edu (Montgomery-Smith, Stephen)
Date: Sun, 15 Jul 2018 19:43:18 +0000
Subject: [PATCH] Recent libm additions
In-Reply-To: <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
Message-ID: <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>

On 07/15/2018 02:09 PM, Warner Losh wrote:
> I'm not saying that he has a lock. I'm saying he's are domain expert and
> many mistakes can be avoided by talking to him.
> 
> I'm saying we have history here, and that history, while poorly documented,
> wasn't followed. To the extent it is poorly documented, we should fix that.
> 
> Warner
> 
I agree that we should document the process.  Maybe also include
freebsd-numerics@ on these discussions, as that is why it was created.

But I'm really glad these changes were committed.  I have found the
people tend to drag their feet a lot on numerics issues.

Has anyone done an analysis of the OpenBSD powl functions from an
accuracy point of view?  That is, to test how many ULP of error these
functions have?  If not, I could give it a go, although not for several
months because life is very busy.

From Cy.Schubert at cschubert.com  Sun Jul 15 19:44:53 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Sun, 15 Jul 2018 12:44:46 -0700
Subject: [PATCH] Recent libm additions
Message-ID: <20180715194447.56B88F21@spqr.komquats.com>

That'll work too.

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---

-----Original Message-----
From: Warner Losh
Sent: 15/07/2018 12:26
To: Cy Schubert
Cc: Ian Lepore; K. Macy; Steve Kargl; FreeBSD Current
Subject: Re: [PATCH] Recent libm additions

So something like this:




diff --git a/MAINTAINERS b/MAINTAINERS

index 51d3688f8b8..3e6584f24a1 100644

--- a/MAINTAINERS

+++ b/MAINTAINERS

@@ -58,6 +58,7 @@ kqueue                jmg     Pre-commit review requested.  Documentation Required.

 libdpv         dteske  Pre-commit review requested. Keep in sync with dpv(1).

 libfetch       des     Pre-commit review requested, email only.

 libfigpar      dteske  Pre-commit review requested.

+libm           freebsd-numerics        Send email with patches to freebsd-numerics@

 libpam         des     Pre-commit review requested, email only.

 linprocfs      des     Pre-commit review requested, email only.

 lpr            gad     Pre-commit review requested, particularly for




is what you're suggesting?




Warner



On Sun, Jul 15, 2018 at 1:23 PM, Cy Schubert <Cy.Schubert at cschubert.com> wrote:




I wasn't saying Steve has a lock however in case non-committers might feel they do, addressing all points in my reply. Not saying anyone feels this way today but we should consider this in whatever we decide here (considering all possibilities). IMO adding subject matter experts to MAINTAINERS seems like the easiest way to document who might be the go-to person.

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---



From: Warner Losh
Sent: 15/07/2018 12:09
To: Cy Schubert
Cc: Ian Lepore; K. Macy; Steve Kargl; FreeBSD Current


Subject: Re: [PATCH] Recent libm additions


I'm not saying that he has a lock. I'm saying he's are domain expert and many mistakes can be avoided by talking to him.



I'm saying we have history here, and that history, while poorly documented, wasn't followed. To the extent it is poorly documented, we should fix that.




Warner





On Sun, Jul 15, 2018 at 12:43 PM, Cy Schubert <Cy.Schubert at cschubert.com> wrote:




I don't think it makes sense for a non-committer to have a lock on anything in base. However a request for review makes a lot of sense. If a non-committer or former committer is the SME on a particular subject it's best that they be consulted even if they don't request it. IMO more input is better. Where better to document this than in MAINTAINERS.

Having said all this. If a person is a former committer and it's not documented, how are we to know?

If people agree, should we start documenting SMEs in MAINTAINERS?

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---



From: Ian Lepore
Sent: 15/07/2018 11:08
To: Warner Losh; K. Macy
Cc: Steve Kargl; FreeBSD Current
Subject: Re: [PATCH] Recent libm additions

On Sun, 2018-07-15 at 11:55 -0600, Warner Losh wrote:
> On Sun, Jul 15, 2018, 11:23 AM K. Macy <kmacy at freebsd.org> wrote:
> 
> > 
> > > 
> > > 
> > > Well, actually, the functions in polevll.c should have been
> > > copied
> > > into ld80/e_powl.c, and polevall.c should never have been
> > > committed.
> > > Unfortunately, the code was not reviewed for correctness.
> > That is not correct. Please stop repeating it. Bruce Evans and John
> > Baldwin were both looped in. Neither made this observation.
> > 
> Steve is the fp guy these days. And it wasn't reviewed by him. He's
> mad you
> cut him out of the loop. Arguing about pedantic points of process
> does no
> one any good.
> 
> Warner

On the other hand, what information is there for someone to know that
Steve should be involved in a review? There is nothing in MAINTAINERS.
The review was on phab for almost a month, and phab is supposedly the
preferred way to do reviews these days.

Steve is no longer a committer, but that doesn't preclude him having a
phab account and participating in reviews. If he doesn't like using
phab (and I can certainly understand that POV), an entry in MAINTAINERS
would still be helpful, unless we have a rule that only committers can
be listed in there.

-- Ian

_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


 

From rmacklem at uoguelph.ca  Sun Jul 15 20:29:46 2018
From: rmacklem at uoguelph.ca (Rick Macklem)
Date: Sun, 15 Jul 2018 20:29:44 +0000
Subject: NFSv4.1 server deficiencies fixed for ESXi client
In-Reply-To: <201806171442.w5HEg3pB060542@pdx.rh.CN85.dnsmgr.net>
References: <YTOPR0101MB0953EACBFD7354D0CAA44C8EDD720@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>,
 <201806171442.w5HEg3pB060542@pdx.rh.CN85.dnsmgr.net>
Message-ID: <YTOPR0101MB0953689C53C8B6B9715400E5DD5E0@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>

Rodney W. Grimes wrote:
>Have you any contact with VMWare so that they might fix the issues
>in thier code, rather than having to put hacks in FreeBSD for these
>issues?

Well, Jim White (who is not in their file system area) submitted a PR on their
system and the response was along the lines of:
Sorry to report the storage team punted the bug to a future release (which could be  indefinite).  The stated reason is that FreeBSD isn't a supported NFS 4.1 server.

As such, it didn't sound too promising. However, recent tests have shown that
ESXi6.7 is much better.

The packet traces I've seen sofar for the ESXi 6.7 client show none of the serious (and difficult to deal with without violating the RFC) problems.
It still does a ReclaimComplete with rca_one_fs == TRUE, but it also does the
required ReclaimComplete with rca_one_fs == FALSE. Although I believe the
ReclaimComplete with rca_one_fs == TRUE is only meant to be used after a
file system has been transferred to a different server (something the FreeBSD
server does not do at this time), the RFC is somewhat vague on when this is used,
so I think just replying NFS_OK to this without doing anything should be acceptable.
(I am going to look and see what the Linux server does for this case.)

As such, I'm hoping that there will be no need for "dirty hacks" for the ESXi6.7
client and this might soon be resolved.

Thanks go to those doing the testing (Andreas Nagy and Daniel Engel) and Jim White
for submitting the PR that somehow got fixed in a matter of days, rick


From sgk at troutmask.apl.washington.edu  Sun Jul 15 20:59:26 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 13:59:22 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715192307.45EE0ED6@spqr.komquats.com>
References: <20180715192307.45EE0ED6@spqr.komquats.com>
Message-ID: <20180715205922.GA32747@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 12:23:06PM -0700, Cy Schubert wrote:
> I wasn't saying Steve has a lock however in case non-committers
> might feel they do, addressing all points in my reply. Not saying
> anyone feels this way today but we should consider this in whatever
> we decide here (considering all possibilities). IMO adding subject
> matter experts to MAINTAINERS seems like the easiest way to document
> who might be the go-to person.

I don't have a lock, and I don't want one.  I do, however, 
make a part of my living using FreeBSD for floating point
intensive research.  I think that changes, including the
addition of new functions, to libm should be reviewed and
preferably tested.  Grabbing code from OpenBSD (or anywhere),
getting it to compile and integrated into the build
infrastructure does not constitute a code review. There is
a mailing list dedicated to numerics (aka floating point) on
FreeBSD: freebsd-numerics at freebsd.org.

-- 
Steve

From sgk at troutmask.apl.washington.edu  Sun Jul 15 21:13:18 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 14:11:59 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
 <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>
 <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
Message-ID: <20180715211159.GB32747@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 02:00:37PM -0700, Matthew Macy wrote:
> On Sun, Jul 15, 2018 at 12:43 PM, Montgomery-Smith, Stephen
> <stephen at missouri.edu> wrote:
> > On 07/15/2018 02:09 PM, Warner Losh wrote:
> >> I'm not saying that he has a lock. I'm saying he's are domain expert and
> >> many mistakes can be avoided by talking to him.
> >>
> >> I'm saying we have history here, and that history, while poorly documented,
> >> wasn't followed. To the extent it is poorly documented, we should fix that.
> >>
> >> Warner
> >>
> > I agree that we should document the process.  Maybe also include
> > freebsd-numerics@ on these discussions, as that is why it was created.
> >
> > But I'm really glad these changes were committed.  I have found the
> > people tend to drag their feet a lot on numerics issues.
> >
> > Has anyone done an analysis of the OpenBSD powl functions from an
> > accuracy point of view?  That is, to test how many ULP of error these
> > functions have?  If not, I could give it a go, although not for several
> > months because life is very busy.
> 
> They're also used by Julia. You might ask there first.

The FPU on i686-class hardware is set to use 53-bit precision.
powl.c likely has at least a 2**11 ULP for a (large?) number
of arguments.  Go read the msun/src/math_private.h.  You'll
find LD80C for constucting long double literal constants,
ENTERI() and RETURNI() marcos that toggle the precision of the
FPU.  These are used in ld80 code, e.g., e_lgammal_r.c.

So, it doesn't matter what the Julia developers say unless their
testing was done on FreeBSD.

-- 
Steve

From sgk at troutmask.apl.washington.edu  Sun Jul 15 21:14:46 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Sun, 15 Jul 2018 14:14:42 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
 <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>
 <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
Message-ID: <20180715211442.GA33140@troutmask.apl.washington.edu>

On Sun, Jul 15, 2018 at 02:00:37PM -0700, Matthew Macy wrote:
> On Sun, Jul 15, 2018 at 12:43 PM, Montgomery-Smith, Stephen
> <stephen at missouri.edu> wrote:
> > On 07/15/2018 02:09 PM, Warner Losh wrote:
> >> I'm not saying that he has a lock. I'm saying he's are domain expert and
> >> many mistakes can be avoided by talking to him.
> >>
> >> I'm saying we have history here, and that history, while poorly documented,
> >> wasn't followed. To the extent it is poorly documented, we should fix that.
> >>
> >> Warner
> >>
> > I agree that we should document the process.  Maybe also include
> > freebsd-numerics@ on these discussions, as that is why it was created.
> >
> > But I'm really glad these changes were committed.  I have found the
> > people tend to drag their feet a lot on numerics issues.
> >
> > Has anyone done an analysis of the OpenBSD powl functions from an
> > accuracy point of view?  That is, to test how many ULP of error these
> > functions have?  If not, I could give it a go, although not for several
> > months because life is very busy.
> 
> They're also used by Julia. You might ask there first.

You also need to fix the pow.3 documentation.  It currently states

BUGS
     To conform with newer C/C++ standards, a stub implementation
     for powl was committed to the math library, where powl is mapped
     to pow.  Thus, the numerical accuracy is at most that of the
     53-bit double precision implementation.

-- 
Steve

From mat.macy at gmail.com  Sun Jul 15 21:00:40 2018
From: mat.macy at gmail.com (Matthew Macy)
Date: Sun, 15 Jul 2018 14:00:37 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
 <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>
Message-ID: <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>

On Sun, Jul 15, 2018 at 12:43 PM, Montgomery-Smith, Stephen
<stephen at missouri.edu> wrote:
> On 07/15/2018 02:09 PM, Warner Losh wrote:
>> I'm not saying that he has a lock. I'm saying he's are domain expert and
>> many mistakes can be avoided by talking to him.
>>
>> I'm saying we have history here, and that history, while poorly documented,
>> wasn't followed. To the extent it is poorly documented, we should fix that.
>>
>> Warner
>>
> I agree that we should document the process.  Maybe also include
> freebsd-numerics@ on these discussions, as that is why it was created.
>
> But I'm really glad these changes were committed.  I have found the
> people tend to drag their feet a lot on numerics issues.
>
> Has anyone done an analysis of the OpenBSD powl functions from an
> accuracy point of view?  That is, to test how many ULP of error these
> functions have?  If not, I could give it a go, although not for several
> months because life is very busy.

They're also used by Julia. You might ask there first.
-M

From linimon at lonesome.com  Sun Jul 15 22:49:18 2018
From: linimon at lonesome.com (Mark Linimon)
Date: Sun, 15 Jul 2018 22:49:10 +0000
Subject: [PATCH] Recent libm additions
In-Reply-To: <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
Message-ID: <20180715224909.GA3916@lonesome.com>

On Sun, Jul 15, 2018 at 01:09:41PM -0600, Warner Losh wrote:
> I'm not saying that he has a lock. I'm saying he's are domain expert
> and many mistakes can be avoided by talking to him.

fwiw, substantially all the work done since at least 2013 is from kargl.
(I am eliding the licensing, Makefile, and typo commits.)

  https://svnweb.freebsd.org/base/head/lib/msun/src/?sortby=date#dirlist

mcl

From imb at protected-networks.net  Sun Jul 15 23:15:29 2018
From: imb at protected-networks.net (Michael Butler)
Date: Sun, 15 Jul 2018 19:15:21 -0400
Subject: em0 link fail
In-Reply-To: <7a4607ce-e212-5cba-bc04-1d0abf1a7824@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
 <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
 <64e462dd-16fc-b57f-7bf2-02068d0e24c8@zyxst.net>
 <7a4607ce-e212-5cba-bc04-1d0abf1a7824@protected-networks.net>
Message-ID: <bbfba7da-3f62-17d0-3846-b08f398aac30@protected-networks.net>

On 07/05/18 09:54, I wrote:
> On 07/05/18 09:27, tech-lists wrote:
>> On 03/07/2018 19:47, Michael Butler wrote:
>>> That would've been ..
>>>
>>> Jun? 1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
>>> 1 08:25:58 EDT 2018
>>>
>>> I'm going to build one with SVN r334862 reverted to see if that works,
>>
>> Hi,
>>
>> Is it working now? Am asking because a system I'd like to take from
>> 11-stable to 12 uses the em driver.
> 
> No :-( I haven't had the chance yet to revisit it,

As it turns out, SVN r336313 (committed today) solves the issue I was
having with the hardware stalling,

	imb


From rmacklem at uoguelph.ca  Sun Jul 15 23:55:40 2018
From: rmacklem at uoguelph.ca (Rick Macklem)
Date: Sun, 15 Jul 2018 23:55:37 +0000
Subject: NFSv4.1 server deficiencies fixed for ESXi client
In-Reply-To: <YTOPR0101MB0953689C53C8B6B9715400E5DD5E0@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>
References: <YTOPR0101MB0953EACBFD7354D0CAA44C8EDD720@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>,
 <201806171442.w5HEg3pB060542@pdx.rh.CN85.dnsmgr.net>,
 <YTOPR0101MB0953689C53C8B6B9715400E5DD5E0@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>
Message-ID: <YTOPR0101MB095318BC999B799A8136D9ECDD5E0@YTOPR0101MB0953.CANPRD01.PROD.OUTLOOK.COM>

I wrote:
> (I am going to look and see what the Linux server does for this case.)
I just looked and the Linux 4.17-rc2 kernel NFS server just returns NFS_OK
for the rca_one_fs == TRUE case. I have given a patch that does the same
thing for the FreeBSD server to Andreas and Daniel and think it is ok to
commit, if it works. (I don't think it violates the RFC, since the RFC is vague
w.r.t. when the rca_one_fs == TRUE case is used and never mentions that
an error should be returned when the server doesn't use it.

rick


From dimpase+freebsd at gmail.com  Mon Jul 16 12:18:00 2018
From: dimpase+freebsd at gmail.com (Dima Pasechnik)
Date: Mon, 16 Jul 2018 13:17:47 +0100
Subject: [PATCH] Recent libm additions
In-Reply-To: <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
References: <20180715184255.4965AE50@spqr.komquats.com>
 <CANCZdfp5jOS2mLQR7GvgxTEqpG5D32tDTf2mY=BJxVXSNitLqQ@mail.gmail.com>
 <4c91b1a4-ecaa-337e-c6d3-89e9d4fcaf83@missouri.edu>
 <CAPrugNozzxOH9_G-UAgA6XNgGkP8_giRsEVY3XMPQ0asAKwduw@mail.gmail.com>
Message-ID: <CAAWYfq29Kv5j2qkGP7z=rVX4KrzEWWX7qQBzMe6ogkMqhr3ZTA@mail.gmail.com>

Julia's libm is https://github.com/JuliaMath/openlibm (or http://openlibm.org/)

The do try merging latest from freebsd (msun), although it seems not
the very latest.
(see e.g. https://github.com/JuliaMath/openlibm/pull/118)

I did try installing the master git branch of openlibm on FreeBSD 11.1
with clang,
it builds and passes all tests they have.

Does it make sense to contribute there more tests (if any --- they seem to have
quite a list), to clear
suspicions about precision?

On Sun, Jul 15, 2018 at 10:03 PM Matthew Macy <mat.macy at gmail.com> wrote:
>
> On Sun, Jul 15, 2018 at 12:43 PM, Montgomery-Smith, Stephen
> <stephen at missouri.edu> wrote:
> > On 07/15/2018 02:09 PM, Warner Losh wrote:
> >> I'm not saying that he has a lock. I'm saying he's are domain expert and
> >> many mistakes can be avoided by talking to him.
> >>
> >> I'm saying we have history here, and that history, while poorly documented,
> >> wasn't followed. To the extent it is poorly documented, we should fix that.
> >>
> >> Warner
> >>
> > I agree that we should document the process.  Maybe also include
> > freebsd-numerics@ on these discussions, as that is why it was created.
> >
> > But I'm really glad these changes were committed.  I have found the
> > people tend to drag their feet a lot on numerics issues.
> >
> > Has anyone done an analysis of the OpenBSD powl functions from an
> > accuracy point of view?  That is, to test how many ULP of error these
> > functions have?  If not, I could give it a go, although not for several
> > months because life is very busy.
>
> They're also used by Julia. You might ask there first.
> -M
> _______________________________________________
> freebsd-numerics at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-numerics
> To unsubscribe, send any mail to "freebsd-numerics-unsubscribe at freebsd.org"

From pstef at freebsd.org  Mon Jul 16 20:12:30 2018
From: pstef at freebsd.org (Piotr P. Stefaniak)
Date: Mon, 16 Jul 2018 22:12:28 +0200
Subject: updates to HEAD online, RSS non-browser ??
In-Reply-To: <E1feIqM-0000DS-2g@rmmprod05.runbox>
References: <E1feIqM-0000DS-2g@rmmprod05.runbox>
Message-ID: <20180716201228.GE53055@freefall.freebsd.org>

On 2018-07-14 04:36:05, Jeffrey Bouquet wrote:
>secnetix.de used to let me read HEAD updates to src daily.  About
>several monhts ago, my browsers cannot reach it and the 2ndry site is
>tedious to read in an equivalent manner. AFAIK the site is still up.
>Recent EU laws or some other cause?  Reachable by some legal VPN
>trickery?  RSS feed better serving to inform? legal web scraping
>connects to site when browsers cannot?

Would this suffice?
https://github.com/freebsd/freebsd/commits/master.atom

From marklmi at yahoo.com  Mon Jul 16 20:21:21 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 16 Jul 2018 13:21:10 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64 cross
 build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
Message-ID: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>

I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :

. . .
--- buildkernel ---
Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
--- accf_data.kld ---
ld: unrecognised emulation mode: aarch64elf
Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
*** [accf_data.kld] Error code 1

make[4]: stopped in /usr/src/sys/modules/accf_data
.ERROR_TARGET='accf_data.kld'
.ERROR_META_FILE='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld.meta'
.MAKE.LEVEL='4'
MAKEFILE=''
.MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
_ERROR_CMD='ld -m aarch64elf -d -warn-common -r -d -o accf_data.kld accf_data.o; ctfmerge -L VERSION -g -o accf_data.kld accf_data.o; :> export_syms; awk -f /usr/src/sys/conf/kmod_syms.awk accf_data.kld  export_syms | xargs -J% objcopy % accf_data.kld;'
.CURDIR='/usr/src/sys/modules/accf_data'
.MAKE='make'
.OBJDIR='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data'
.TARGETS='all'
DESTDIR=''
LD_LIBRARY_PATH=''
MACHINE='arm64'
MACHINE_ARCH='aarch64'
MAKEOBJDIRPREFIX='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules'
MAKESYSPATH='/usr/src/share/mk'
MAKE_VERSION='20180512'
PATH='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/usr/sbin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/usr/bin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/bin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/usr/sbin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
SRCTOP='/usr/src'
OBJTOP='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src'
.MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/sys/modules/accf_data/Makefile /usr/src/share/mk/bsd.kmod.mk /usr/src/sys/conf/kmod.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/sys/modules/accf_data/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/sys/conf/kern.opts.mk /usr/src/sys/conf/config.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/sys/conf/kern.mk'
.PATH='. /usr/src/sys/modules/accf_data /usr/src/sys/netinet /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG'
1 error



Detailed context:

# uname -apKU
FreeBSD FBSDUSSD 12.0-CURRENT FreeBSD 12.0-CURRENT  r336349M  amd64 amd64 1200073 1200073

The "M" is mostly for powerpc* family experiments:

# svnlite status /usr/src/ | sort
?       /usr/src/sys/amd64/conf/GENERIC-DBG
?       /usr/src/sys/amd64/conf/GENERIC-NODBG
?       /usr/src/sys/arm/conf/GENERIC-DBG
?       /usr/src/sys/arm/conf/GENERIC-NODBG
?       /usr/src/sys/arm64/conf/GENERIC-DBG
?       /usr/src/sys/arm64/conf/GENERIC-NODBG
?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-DBG
?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-NODBG
?       /usr/src/sys/powerpc/conf/GENERICvtsc-DBG
?       /usr/src/sys/powerpc/conf/GENERICvtsc-NODBG
M       /usr/src/Makefile.libcompat
M       /usr/src/contrib/llvm/lib/Target/PowerPC/PPCFrameLowering.cpp
M       /usr/src/contrib/llvm/tools/lld/ELF/Arch/PPC64.cpp
M       /usr/src/crypto/openssl/crypto/armcap.c
M       /usr/src/lib/libkvm/kvm_powerpc.c
M       /usr/src/lib/libkvm/kvm_private.c
M       /usr/src/release/Makefile.vm
M       /usr/src/release/scripts/mk-vmimage.sh
M       /usr/src/release/tools/vmimage.subr
M       /usr/src/secure/lib/libcrypto/Makefile
M       /usr/src/stand/defs.mk
M       /usr/src/stand/powerpc/boot1.chrp/Makefile
M       /usr/src/stand/powerpc/kboot/Makefile
M       /usr/src/sys/arm64/arm64/identcpu.c
M       /usr/src/sys/conf/kmod.mk
M       /usr/src/sys/conf/ldscript.powerpc
M       /usr/src/sys/powerpc/aim/mmu_oea64.c
M       /usr/src/sys/powerpc/ofw/ofw_machdep.c

# more /usr/src/sys/arm64/conf/GENERIC-NODBG
#
# GENERIC -- Custom configuration for the arm64/aarch64
#

include "GENERIC"

ident   GENERIC-NODBG

makeoptions     DEBUG=-g                # Build kernel with gdb(1) debug symbols

options         ALT_BREAK_TO_DEBUGGER

options         KDB                     # Enable kernel debugger support

# For minimum debugger support (stable branch) use:
#options        KDB_TRACE               # Print a stack trace for a panic
options         DDB                     # Enable the kernel debugger

# Extra stuff:
#options        VERBOSE_SYSINIT         # Enable verbose sysinit messages
#options        BOOTVERBOSE=1
#options        BOOTHOWTO=RB_VERBOSE
#options        KTR
#options        KTR_MASK=KTR_TRAP
##options       KTR_CPUMASK=0xF
#options        KTR_VERBOSE

# Disable any extra checking for. . .
nooptions       DEADLKRES               # Enable the deadlock resolver
nooptions       INVARIANTS              # Enable calls of extra sanity checking
nooptions       INVARIANT_SUPPORT       # Extra sanity checks of internal structures, required by INVARIANTS
nooptions       WITNESS                 # Enable checks to detect deadlocks and cycles
nooptions       WITNESS_SKIPSPIN        # Don't run witness on spinlocks for speed
nooptions       DIAGNOSTIC
nooptions       MALLOC_DEBUG_MAXZONES   # Separate malloc(9) zones
nooptions       BUF_TRACKING
nooptions       FULL_BUF_TRACKING


# more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel
kldload -n filemon && \
script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
WITH_META_MODE=yes \
MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
make $*


# more ~/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host
TO_TYPE=aarch64
TOOLS_TO_TYPE=${TO_TYPE}
VERSION_CONTEXT=12.0
#
KERNCONF=GENERIC-NODBG
TARGET=arm64
.if ${.MAKE.LEVEL} == 0
TARGET_ARCH=${TO_TYPE}
.export TARGET_ARCH
.endif
#
WITH_CROSS_COMPILER=
WITHOUT_SYSTEM_COMPILER=
WITHOUT_SYSTEM_LINKER=
#
WITH_LIBCPLUSPLUS=
WITH_LLD_BOOTSTRAP=
WITHOUT_BINUTILS_BOOTSTRAP=
WITH_ELFTOOLCHAIN_BOOTSTRAP=
WITH_CLANG_BOOTSTRAP=
WITH_CLANG=
WITH_CLANG_IS_CC=
WITH_CLANG_FULL=
WITH_CLANG_EXTRAS=
WITH_LLD=
WITH_LLD_IS_LD=
WITH_LLDB=
#
WITH_BOOT=
WITHOUT_LIB32=
#
WITHOUT_GCC_BOOTSTRAP=
WITHOUT_GCC=
WITHOUT_GCC_IS_CC=
WITHOUT_GNUCXX=
#
NO_WERROR=
#WERROR=
MALLOC_PRODUCTION=
#
WITH_REPRODUCIBLE_BUILD=
WITH_DEBUG_FILES=
#
#CROSS_BINUTILS_PREFIX=/usr/local/${TOOLS_TO_TYPE}-unknown-freebsd${VERSION_CONTEXT}/bin/
XCFLAGS+= -mcpu=cortex-a53
XCXXFLAGS+= -mcpu=cortex-a53
# There is no XCPPFLAGS but XCPP gets XCFLAGS content.
ACFLAGS.arm64cpuid.S+=  -mcpu=cortex-a53+crypto
ACFLAGS.aesv8-armx.S+=  -mcpu=cortex-a53+crypto
ACFLAGS.ghashv8-armx.S+=        -mcpu=cortex-a53+crypto


# more ~/src.configs/make.conf
CFLAGS.gcc+= -v



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From bdrewery at FreeBSD.org  Mon Jul 16 22:32:02 2018
From: bdrewery at FreeBSD.org (Bryan Drewery)
Date: Mon, 16 Jul 2018 15:31:50 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64
 cross build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
In-Reply-To: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
References: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
Message-ID: <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>

On 7/16/18 1:21 PM, Mark Millard wrote:
> I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
> targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
> using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :

I probably extended the LLVM_TARGET_ALL=no in cross-compiler too far. I
thought I had left that out for kernel-toolchain but apparently not.

Try this patch and kernel-toolchain after applying please:
http://people.freebsd.org/~bdrewery/patches/cross-compiler-fix.diff

> 
> . . .
> --- buildkernel ---
> Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
> --- accf_data.kld ---
> ld: unrecognised emulation mode: aarch64elf
> Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
> *** [accf_data.kld] Error code 1
> 
> make[4]: stopped in /usr/src/sys/modules/accf_data
> .ERROR_TARGET='accf_data.kld'
> .ERROR_META_FILE='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld.meta'
> .MAKE.LEVEL='4'
> MAKEFILE=''
> .MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
> _ERROR_CMD='ld -m aarch64elf -d -warn-common -r -d -o accf_data.kld accf_data.o; ctfmerge -L VERSION -g -o accf_data.kld accf_data.o; :> export_syms; awk -f /usr/src/sys/conf/kmod_syms.awk accf_data.kld  export_syms | xargs -J% objcopy % accf_data.kld;'
> .CURDIR='/usr/src/sys/modules/accf_data'
> .MAKE='make'
> .OBJDIR='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data'
> .TARGETS='all'
> DESTDIR=''
> LD_LIBRARY_PATH=''
> MACHINE='arm64'
> MACHINE_ARCH='aarch64'
> MAKEOBJDIRPREFIX='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules'
> MAKESYSPATH='/usr/src/share/mk'
> MAKE_VERSION='20180512'
> PATH='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/usr/sbin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/usr/bin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/legacy/bin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/usr/sbin:/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
> SRCTOP='/usr/src'
> OBJTOP='/usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src'
> .MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/sys/modules/accf_data/Makefile /usr/src/share/mk/bsd.kmod.mk /usr/src/sys/conf/kmod.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/sys/modules/accf_data/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/sys/conf/kern.opts.mk /usr/src/sys/conf/config.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/sys/conf/kern.mk'
> .PATH='. /usr/src/sys/modules/accf_data /usr/src/sys/netinet /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG'
> 1 error
> 
> 
> 
> Detailed context:
> 
> # uname -apKU
> FreeBSD FBSDUSSD 12.0-CURRENT FreeBSD 12.0-CURRENT  r336349M  amd64 amd64 1200073 1200073
> 
> The "M" is mostly for powerpc* family experiments:
> 
> # svnlite status /usr/src/ | sort
> ?       /usr/src/sys/amd64/conf/GENERIC-DBG
> ?       /usr/src/sys/amd64/conf/GENERIC-NODBG
> ?       /usr/src/sys/arm/conf/GENERIC-DBG
> ?       /usr/src/sys/arm/conf/GENERIC-NODBG
> ?       /usr/src/sys/arm64/conf/GENERIC-DBG
> ?       /usr/src/sys/arm64/conf/GENERIC-NODBG
> ?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-DBG
> ?       /usr/src/sys/powerpc/conf/GENERIC64vtsc-NODBG
> ?       /usr/src/sys/powerpc/conf/GENERICvtsc-DBG
> ?       /usr/src/sys/powerpc/conf/GENERICvtsc-NODBG
> M       /usr/src/Makefile.libcompat
> M       /usr/src/contrib/llvm/lib/Target/PowerPC/PPCFrameLowering.cpp
> M       /usr/src/contrib/llvm/tools/lld/ELF/Arch/PPC64.cpp
> M       /usr/src/crypto/openssl/crypto/armcap.c
> M       /usr/src/lib/libkvm/kvm_powerpc.c
> M       /usr/src/lib/libkvm/kvm_private.c
> M       /usr/src/release/Makefile.vm
> M       /usr/src/release/scripts/mk-vmimage.sh
> M       /usr/src/release/tools/vmimage.subr
> M       /usr/src/secure/lib/libcrypto/Makefile
> M       /usr/src/stand/defs.mk
> M       /usr/src/stand/powerpc/boot1.chrp/Makefile
> M       /usr/src/stand/powerpc/kboot/Makefile
> M       /usr/src/sys/arm64/arm64/identcpu.c
> M       /usr/src/sys/conf/kmod.mk
> M       /usr/src/sys/conf/ldscript.powerpc
> M       /usr/src/sys/powerpc/aim/mmu_oea64.c
> M       /usr/src/sys/powerpc/ofw/ofw_machdep.c
> 
> # more /usr/src/sys/arm64/conf/GENERIC-NODBG
> #
> # GENERIC -- Custom configuration for the arm64/aarch64
> #
> 
> include "GENERIC"
> 
> ident   GENERIC-NODBG
> 
> makeoptions     DEBUG=-g                # Build kernel with gdb(1) debug symbols
> 
> options         ALT_BREAK_TO_DEBUGGER
> 
> options         KDB                     # Enable kernel debugger support
> 
> # For minimum debugger support (stable branch) use:
> #options        KDB_TRACE               # Print a stack trace for a panic
> options         DDB                     # Enable the kernel debugger
> 
> # Extra stuff:
> #options        VERBOSE_SYSINIT         # Enable verbose sysinit messages
> #options        BOOTVERBOSE=1
> #options        BOOTHOWTO=RB_VERBOSE
> #options        KTR
> #options        KTR_MASK=KTR_TRAP
> ##options       KTR_CPUMASK=0xF
> #options        KTR_VERBOSE
> 
> # Disable any extra checking for. . .
> nooptions       DEADLKRES               # Enable the deadlock resolver
> nooptions       INVARIANTS              # Enable calls of extra sanity checking
> nooptions       INVARIANT_SUPPORT       # Extra sanity checks of internal structures, required by INVARIANTS
> nooptions       WITNESS                 # Enable checks to detect deadlocks and cycles
> nooptions       WITNESS_SKIPSPIN        # Don't run witness on spinlocks for speed
> nooptions       DIAGNOSTIC
> nooptions       MALLOC_DEBUG_MAXZONES   # Separate malloc(9) zones
> nooptions       BUF_TRACKING
> nooptions       FULL_BUF_TRACKING
> 
> 
> # more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel
> kldload -n filemon && \
> script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
> env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
> WITH_META_MODE=yes \
> MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
> make $*
> 
> 
> # more ~/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host
> TO_TYPE=aarch64
> TOOLS_TO_TYPE=${TO_TYPE}
> VERSION_CONTEXT=12.0
> #
> KERNCONF=GENERIC-NODBG
> TARGET=arm64
> .if ${.MAKE.LEVEL} == 0
> TARGET_ARCH=${TO_TYPE}
> .export TARGET_ARCH
> .endif
> #
> WITH_CROSS_COMPILER=
> WITHOUT_SYSTEM_COMPILER=
> WITHOUT_SYSTEM_LINKER=
> #
> WITH_LIBCPLUSPLUS=
> WITH_LLD_BOOTSTRAP=
> WITHOUT_BINUTILS_BOOTSTRAP=
> WITH_ELFTOOLCHAIN_BOOTSTRAP=
> WITH_CLANG_BOOTSTRAP=
> WITH_CLANG=
> WITH_CLANG_IS_CC=
> WITH_CLANG_FULL=
> WITH_CLANG_EXTRAS=
> WITH_LLD=
> WITH_LLD_IS_LD=
> WITH_LLDB=
> #
> WITH_BOOT=
> WITHOUT_LIB32=
> #
> WITHOUT_GCC_BOOTSTRAP=
> WITHOUT_GCC=
> WITHOUT_GCC_IS_CC=
> WITHOUT_GNUCXX=
> #
> NO_WERROR=
> #WERROR=
> MALLOC_PRODUCTION=
> #
> WITH_REPRODUCIBLE_BUILD=
> WITH_DEBUG_FILES=
> #
> #CROSS_BINUTILS_PREFIX=/usr/local/${TOOLS_TO_TYPE}-unknown-freebsd${VERSION_CONTEXT}/bin/
> XCFLAGS+= -mcpu=cortex-a53
> XCXXFLAGS+= -mcpu=cortex-a53
> # There is no XCPPFLAGS but XCPP gets XCFLAGS content.
> ACFLAGS.arm64cpuid.S+=  -mcpu=cortex-a53+crypto
> ACFLAGS.aesv8-armx.S+=  -mcpu=cortex-a53+crypto
> ACFLAGS.ghashv8-armx.S+=        -mcpu=cortex-a53+crypto
> 
> 
> # more ~/src.configs/make.conf
> CFLAGS.gcc+= -v
> 
> 
> 
> ===
> Mark Millard
> marklmi at yahoo.com
> ( dsl-only.net went
> away in early 2018-Mar)
> 


-- 
Regards,
Bryan Drewery

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 488 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180716/d20afee0/attachment.sig>

From marklmi at yahoo.com  Mon Jul 16 22:59:59 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 16 Jul 2018 15:49:40 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64
 cross build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
In-Reply-To: <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>
References: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
 <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>
Message-ID: <09601A6A-C275-4B90-9A76-7C64E2CA7B32@yahoo.com>



On 2018-Jul-16, at 3:31 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:

> On 7/16/18 1:21 PM, Mark Millard wrote:
>> I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
>> targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
>> using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :
> 
> I probably extended the LLVM_TARGET_ALL=no in cross-compiler too far. I
> thought I had left that out for kernel-toolchain but apparently not.
> 
> Try this patch and kernel-toolchain after applying please:
> http://people.freebsd.org/~bdrewery/patches/cross-compiler-fix.diff
> . . .

Result is unchanged. Details follow.

With:

# svnlite diff /usr/src/Makefile.inc1
Index: /usr/src/Makefile.inc1
===================================================================
--- /usr/src/Makefile.inc1	(revision 336349)
+++ /usr/src/Makefile.inc1	(working copy)
@@ -666,7 +666,7 @@
 BMAKE=		\
 		${BMAKEENV} ${MAKE} ${WORLD_FLAGS} -f Makefile.inc1 \
 		${BSARGS}
-.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL)
+.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL) && !make(*toolchain*)
 BMAKE+=		MK_LLVM_TARGET_ALL=no
 .endif
 
used via:

# rm -fr /usr/obj/cortexA53_clang/arm64.aarch64/*
# ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel

I still get:

--- buildkernel ---
Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
--- accf_data.kld ---
ld: unrecognised emulation mode: aarch64elf
Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
*** [accf_data.kld] Error code 1



Reminder of what my .sh script does:

# more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh
kldload -n filemon && \
script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
WITH_META_MODE=yes \
MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
make $*

(I'll not repeat the other supporting material.)

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From bdrewery at FreeBSD.org  Mon Jul 16 23:48:03 2018
From: bdrewery at FreeBSD.org (Bryan Drewery)
Date: Mon, 16 Jul 2018 16:47:53 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64
 cross build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
In-Reply-To: <09601A6A-C275-4B90-9A76-7C64E2CA7B32@yahoo.com>
References: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
 <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>
 <09601A6A-C275-4B90-9A76-7C64E2CA7B32@yahoo.com>
Message-ID: <0b5b2181-7335-325c-3e7a-f882a48fcd69@FreeBSD.org>

On 7/16/2018 3:49 PM, Mark Millard wrote:
> 
> 
> On 2018-Jul-16, at 3:31 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:
> 
>> On 7/16/18 1:21 PM, Mark Millard wrote:
>>> I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
>>> targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
>>> using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :
>>
>> I probably extended the LLVM_TARGET_ALL=no in cross-compiler too far. I
>> thought I had left that out for kernel-toolchain but apparently not.
>>
>> Try this patch and kernel-toolchain after applying please:
>> http://people.freebsd.org/~bdrewery/patches/cross-compiler-fix.diff
>> . . .
> 
> Result is unchanged. Details follow.

Ok, I'll look more tomorrow.

> 
> With:
> 
> # svnlite diff /usr/src/Makefile.inc1
> Index: /usr/src/Makefile.inc1
> ===================================================================
> --- /usr/src/Makefile.inc1	(revision 336349)
> +++ /usr/src/Makefile.inc1	(working copy)
> @@ -666,7 +666,7 @@
>  BMAKE=		\
>  		${BMAKEENV} ${MAKE} ${WORLD_FLAGS} -f Makefile.inc1 \
>  		${BSARGS}
> -.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL)
> +.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL) && !make(*toolchain*)
>  BMAKE+=		MK_LLVM_TARGET_ALL=no
>  .endif
>  
> used via:
> 
> # rm -fr /usr/obj/cortexA53_clang/arm64.aarch64/*
> # ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel
> 
> I still get:
> 
> --- buildkernel ---
> Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
> --- accf_data.kld ---
> ld: unrecognised emulation mode: aarch64elf
> Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
> *** [accf_data.kld] Error code 1
> 
> 
> 
> Reminder of what my .sh script does:
> 
> # more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh
> kldload -n filemon && \
> script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
> env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
> WITH_META_MODE=yes \
> MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
> make $*
> 
> (I'll not repeat the other supporting material.)
> 
> ===
> Mark Millard
> marklmi at yahoo.com
> ( dsl-only.net went
> away in early 2018-Mar)
> 


-- 
Regards,
Bryan Drewery

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 618 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180716/13fa9c47/attachment.sig>

From jbtakk at iherebuywisely.com  Tue Jul 17 00:26:27 2018
From: jbtakk at iherebuywisely.com (Jeffrey Bouquet)
Date: Mon, 16 Jul 2018 17:26:18 -0700 (PDT)
Subject: updates to HEAD online, RSS non-browser ??
In-Reply-To: <20180716201228.GE53055@freefall.freebsd.org>
Message-ID: <E1ffDoo-0003Fp-CH@rmmprod05.runbox>



On Mon, 16 Jul 2018 22:12:28 +0200, "Piotr P. Stefaniak" <pstef at freebsd.org> wrote:

> On 2018-07-14 04:36:05, Jeffrey Bouquet wrote:
> >secnetix.de used to let me read HEAD updates to src daily.  About
> >several monhts ago, my browsers cannot reach it and the 2ndry site is
> >tedious to read in an equivalent manner. AFAIK the site is still up.
> >Recent EU laws or some other cause?  Reachable by some legal VPN
> >trickery?  RSS feed better serving to inform? legal web scraping
> >connects to site when browsers cannot?
> 
> Would this suffice?
> https://github.com/freebsd/freebsd/commits/master.atom
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


Looks good. Is it new?  Have to get upto speed on RSS-to-pc methods ...

From marklmi at yahoo.com  Tue Jul 17 01:13:40 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 16 Jul 2018 18:13:27 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64
 cross build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
In-Reply-To: <0b5b2181-7335-325c-3e7a-f882a48fcd69@FreeBSD.org>
References: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
 <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>
 <09601A6A-C275-4B90-9A76-7C64E2CA7B32@yahoo.com>
 <0b5b2181-7335-325c-3e7a-f882a48fcd69@FreeBSD.org>
Message-ID: <2A128804-82FA-4315-9FD9-F109FAF7216B@yahoo.com>



On 2018-Jul-16, at 4:47 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:

> On 7/16/2018 3:49 PM, Mark Millard wrote:
>> 
>> 
>> On 2018-Jul-16, at 3:31 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:
>> 
>>> On 7/16/18 1:21 PM, Mark Millard wrote:
>>>> I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
>>>> targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
>>>> using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :
>>> 
>>> I probably extended the LLVM_TARGET_ALL=no in cross-compiler too far. I
>>> thought I had left that out for kernel-toolchain but apparently not.
>>> 
>>> Try this patch and kernel-toolchain after applying please:
>>> http://people.freebsd.org/~bdrewery/patches/cross-compiler-fix.diff
>>> . . .
>> 
>> Result is unchanged. Details follow.
> 
> Ok, I'll look more tomorrow.
> 
>> 
>> With:
>> 
>> # svnlite diff /usr/src/Makefile.inc1
>> Index: /usr/src/Makefile.inc1
>> ===================================================================
>> --- /usr/src/Makefile.inc1	(revision 336349)
>> +++ /usr/src/Makefile.inc1	(working copy)
>> @@ -666,7 +666,7 @@
>> BMAKE=		\
>> 		${BMAKEENV} ${MAKE} ${WORLD_FLAGS} -f Makefile.inc1 \
>> 		${BSARGS}
>> -.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL)
>> +.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL) && !make(*toolchain*)
>> BMAKE+=		MK_LLVM_TARGET_ALL=no
>> .endif
>> 
>> used via:
>> 
>> # rm -fr /usr/obj/cortexA53_clang/arm64.aarch64/*
>> # ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel
>> 
>> I still get:
>> 
>> --- buildkernel ---
>> Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
>> --- accf_data.kld ---
>> ld: unrecognised emulation mode: aarch64elf
>> Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
>> *** [accf_data.kld] Error code 1
>> 
>> 
>> 
>> Reminder of what my .sh script does:
>> 
>> # more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh
>> kldload -n filemon && \
>> script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
>> env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
>> WITH_META_MODE=yes \
>> MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
>> make $*
>> 
>> (I'll not repeat the other supporting material.)

In case it helps:

# ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh test-system-linker
Script started, output file is /root/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-2018-07-16:17:48:38
USING_SYSTEM_LINKER                = no
MK_SYSTEM_LINKER                   = no
MK_LLD_BOOTSTRAP                   = yes
MK_BINUTILS_BOOTSTRAP              = no
WANT_LINKER_TYPE                   = lld
WANT_LINKER_VERSION                = 60001
WANT_LINKER_VERSION_FILE           = lib/clang/include/lld/Common/Version.inc
WANT_LINKER_FREEBSD_VERSION        = 335540-1200003
WANT_LINKER_FREEBSD_VERSION_FILE   = lib/clang/include/lld/Common/Version.inc
LD                                 = ld
LINKER_TYPE                        = bfd
LINKER_FEATURES                    =  filter
LINKER_VERSION                     = 21750
LINKER_FREEBSD_VERSION             = 0
XLD                                = ld
X_LINKER_TYPE                      = bfd
X_LINKER_FEATURES                  =  filter
X_LINKER_VERSION                   = 21750
X_LINKER_FREEBSD_VERSION           = 0

Script done, output file is /root/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-2018-07-16:17:48:38

The part after the WANT_<?>'s looks odd to me.

(I think the above type of output would be good in ci.freebsd.org
build logs for the likes of FreeBSD-head-*-build . Similarly for
test-system-compiler output.)

I get similar oddness for a self-hosted amd64 build via my
usual .sh and src/make configuration files:

# ~/sys_build_scripts.amd64-host/make_amd64_nodebug_clang-amd64-host.sh test-system-linker
Script started, output file is /root/sys_typescripts/typescript_make_amd64_nodebug_clang-amd64-host-2018-07-16:18:00:52
USING_SYSTEM_LINKER                = no
MK_SYSTEM_LINKER                   = yes
MK_LLD_BOOTSTRAP                   = yes
MK_BINUTILS_BOOTSTRAP              = yes
WANT_LINKER_TYPE                   = lld
WANT_LINKER_VERSION                = 60001
WANT_LINKER_VERSION_FILE           = lib/clang/include/lld/Common/Version.inc
WANT_LINKER_FREEBSD_VERSION        = 335540-1200003
WANT_LINKER_FREEBSD_VERSION_FILE   = lib/clang/include/lld/Common/Version.inc
LD                                 = ld
LINKER_TYPE                        = bfd
LINKER_FEATURES                    =  filter
LINKER_VERSION                     = 21750
LINKER_FREEBSD_VERSION             = 0
XLD                                = ld
X_LINKER_TYPE                      = bfd
X_LINKER_FEATURES                  =  filter
X_LINKER_VERSION                   = 21750
X_LINKER_FREEBSD_VERSION           = 0

Script done, output file is /root/sys_typescripts/typescript_make_amd64_nodebug_clang-amd64-host-2018-07-16:18:00:52


(In both contexts test-system-compiler output seemed reasonable to
me.)

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From marklmi at yahoo.com  Tue Jul 17 01:46:16 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 16 Jul 2018 18:46:02 -0700
Subject: New kernel-toolchain buildkernel problem for amd64 -> aarch64
 cross build ( after -r336348 ) : ld used for addf_data only can target:
 elf_x86_64_fbsd elf_i386_fbsd
In-Reply-To: <2A128804-82FA-4315-9FD9-F109FAF7216B@yahoo.com>
References: <B3539689-7913-4790-A1DD-6911DAFAF9D0@yahoo.com>
 <81184558-6b23-085b-19e3-b11569808174@FreeBSD.org>
 <09601A6A-C275-4B90-9A76-7C64E2CA7B32@yahoo.com>
 <0b5b2181-7335-325c-3e7a-f882a48fcd69@FreeBSD.org>
 <2A128804-82FA-4315-9FD9-F109FAF7216B@yahoo.com>
Message-ID: <22626F9B-4337-4C06-BB24-5BAB5AD52300@yahoo.com>

[ toolchain-metadata.mk is missing when kernel-toolchain is used.
I've no clue if this is intentional or not. ]

On 2018-Jul-16, at 6:13 PM, Mark Millard <marklmi at yahoo.com> wrote:

> On 2018-Jul-16, at 4:47 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:
> 
>> On 7/16/2018 3:49 PM, Mark Millard wrote:
>>> 
>>> 
>>> On 2018-Jul-16, at 3:31 PM, Bryan Drewery <bdrewery at FreeBSD.org> wrote:
>>> 
>>>> On 7/16/18 1:21 PM, Mark Millard wrote:
>>>>> I attempted a from-scratch (. . ./arm64.aarch64/ empty) kernel-toolchain buildkernel
>>>>> targeting aarch64 from amd64 based on head -r336349 . It failed by ending up
>>>>> using an ld that can only target elf_x86_64_fbsd elf_i386_fbsd :
>>>> 
>>>> I probably extended the LLVM_TARGET_ALL=no in cross-compiler too far. I
>>>> thought I had left that out for kernel-toolchain but apparently not.
>>>> 
>>>> Try this patch and kernel-toolchain after applying please:
>>>> http://people.freebsd.org/~bdrewery/patches/cross-compiler-fix.diff
>>>> . . .
>>> 
>>> Result is unchanged. Details follow.
>> 
>> Ok, I'll look more tomorrow.
>> 
>>> 
>>> With:
>>> 
>>> # svnlite diff /usr/src/Makefile.inc1
>>> Index: /usr/src/Makefile.inc1
>>> ===================================================================
>>> --- /usr/src/Makefile.inc1	(revision 336349)
>>> +++ /usr/src/Makefile.inc1	(working copy)
>>> @@ -666,7 +666,7 @@
>>> BMAKE=		\
>>> 		${BMAKEENV} ${MAKE} ${WORLD_FLAGS} -f Makefile.inc1 \
>>> 		${BSARGS}
>>> -.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL)
>>> +.if empty(.MAKEOVERRIDES:MMK_LLVM_TARGET_ALL) && !make(*toolchain*)
>>> BMAKE+=		MK_LLVM_TARGET_ALL=no
>>> .endif
>>> 
>>> used via:
>>> 
>>> # rm -fr /usr/obj/cortexA53_clang/arm64.aarch64/*
>>> # ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh -j4 kernel-toolchain buildkernel
>>> 
>>> I still get:
>>> 
>>> --- buildkernel ---
>>> Building /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys/GENERIC-NODBG/modules/usr/src/sys/modules/accf_data/accf_data.kld
>>> --- accf_data.kld ---
>>> ld: unrecognised emulation mode: aarch64elf
>>> Supported emulations: elf_x86_64_fbsd elf_i386_fbsd
>>> *** [accf_data.kld] Error code 1
>>> 
>>> 
>>> 
>>> Reminder of what my .sh script does:
>>> 
>>> # more ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh
>>> kldload -n filemon && \
>>> script ~/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-$(date +%Y-%m-%d:%H:%M:%S) \
>>> env __MAKE_CONF="/root/src.configs/make.conf" SRCCONF="/dev/null" SRC_ENV_CONF="/root/src.configs/src.conf.cortexA53-clang-bootstrap.amd64-host" \
>>> WITH_META_MODE=yes \
>>> MAKEOBJDIRPREFIX="/usr/obj/cortexA53_clang/arm64.aarch64" \
>>> make $*
>>> 
>>> (I'll not repeat the other supporting material.)
> 
> In case it helps:
> 
> # ~/sys_build_scripts.amd64-host/make_cortexA53_nodebug_clang_bootstrap-amd64-host.sh test-system-linker
> Script started, output file is /root/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-2018-07-16:17:48:38
> USING_SYSTEM_LINKER                = no
> MK_SYSTEM_LINKER                   = no
> MK_LLD_BOOTSTRAP                   = yes
> MK_BINUTILS_BOOTSTRAP              = no
> WANT_LINKER_TYPE                   = lld
> WANT_LINKER_VERSION                = 60001
> WANT_LINKER_VERSION_FILE           = lib/clang/include/lld/Common/Version.inc
> WANT_LINKER_FREEBSD_VERSION        = 335540-1200003
> WANT_LINKER_FREEBSD_VERSION_FILE   = lib/clang/include/lld/Common/Version.inc
> LD                                 = ld
> LINKER_TYPE                        = bfd
> LINKER_FEATURES                    =  filter
> LINKER_VERSION                     = 21750
> LINKER_FREEBSD_VERSION             = 0
> XLD                                = ld
> X_LINKER_TYPE                      = bfd
> X_LINKER_FEATURES                  =  filter
> X_LINKER_VERSION                   = 21750
> X_LINKER_FREEBSD_VERSION           = 0
> 
> Script done, output file is /root/sys_typescripts/typescript_make_cortexA53_nodebug_clang_bootstrap-amd64-host-2018-07-16:17:48:38
> 
> The part after the WANT_<?>'s looks odd to me.
> 
> (I think the above type of output would be good in ci.freebsd.org
> build logs for the likes of FreeBSD-head-*-build . Similarly for
> test-system-compiler output.)
> 
> I get similar oddness for a self-hosted amd64 build via my
> usual .sh and src/make configuration files:
> 
> # ~/sys_build_scripts.amd64-host/make_amd64_nodebug_clang-amd64-host.sh test-system-linker
> Script started, output file is /root/sys_typescripts/typescript_make_amd64_nodebug_clang-amd64-host-2018-07-16:18:00:52
> USING_SYSTEM_LINKER                = no
> MK_SYSTEM_LINKER                   = yes
> MK_LLD_BOOTSTRAP                   = yes
> MK_BINUTILS_BOOTSTRAP              = yes
> WANT_LINKER_TYPE                   = lld
> WANT_LINKER_VERSION                = 60001
> WANT_LINKER_VERSION_FILE           = lib/clang/include/lld/Common/Version.inc
> WANT_LINKER_FREEBSD_VERSION        = 335540-1200003
> WANT_LINKER_FREEBSD_VERSION_FILE   = lib/clang/include/lld/Common/Version.inc
> LD                                 = ld
> LINKER_TYPE                        = bfd
> LINKER_FEATURES                    =  filter
> LINKER_VERSION                     = 21750
> LINKER_FREEBSD_VERSION             = 0
> XLD                                = ld
> X_LINKER_TYPE                      = bfd
> X_LINKER_FEATURES                  =  filter
> X_LINKER_VERSION                   = 21750
> X_LINKER_FREEBSD_VERSION           = 0
> 
> Script done, output file is /root/sys_typescripts/typescript_make_amd64_nodebug_clang-amd64-host-2018-07-16:18:00:52
> 
> 
> (In both contexts test-system-compiler output seemed reasonable to
> me.)

In looking around I find that the kernel-toolchain tree does not
have a toolchain-metadata.mk :

# ls -lTdt /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/*
drwxr-xr-x  7 root  wheel  512 Jul 16 15:41:41 2018 /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/tmp
drwxr-xr-x  3 root  wheel  512 Jul 16 15:41:41 2018 /usr/obj/cortexA53_clang/arm64.aarch64/usr/src/arm64.aarch64/sys

(Of course the build failed and so did not execute everything.)


The buildworld based ones do have such files. For example, the amd64
self-hosted build that used buildworld has:

# more /usr/obj/amd64_clang/amd64.amd64/usr/src/amd64.amd64/toolchain-metadata.mk
.info Using cached toolchain metadata from build at FBSDUSSD on Mon Jul 16 11:49:07 PDT 2018
_LOADED_TOOLCHAIN_METADATA=t
COMPILER_VERSION=60001
X_COMPILER_VERSION=60001
COMPILER_TYPE=clang
X_COMPILER_TYPE=clang
COMPILER_FEATURES= c++11 retpoline
X_COMPILER_FEATURES= c++11 retpoline
COMPILER_FREEBSD_VERSION=1200015
X_COMPILER_FREEBSD_VERSION=1200015
LINKER_VERSION=60001
X_LINKER_VERSION=60001
LINKER_FEATURES= build-id ifunc filter retpoline
X_LINKER_FEATURES= build-id ifunc filter retpoline
LINKER_TYPE=lld
X_LINKER_TYPE=lld
LINKER_FREEBSD_VERSION=335540-1200003
X_LINKER_FREEBSD_VERSION=335540-1200003
.export COMPILER_VERSION  COMPILER_TYPE  COMPILER_FEATURES  COMPILER_FREEBSD_VERSION  LINKER_VERSION  LINKER_FEATURES  LINKER_TYPE  LINKER_FREEBSD_VERSION
.export X_COMPILER_VERSION X_COMPILER_TYPE X_COMPILER_FEATURES X_COMPILER_FREEBSD_VERSION X_LINKER_VERSION X_LINKER_FEATURES X_LINKER_TYPE X_LINKER_FREEBSD_VERSION

(This is despite what test-system-linker showed for that tree.)


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From sgk at troutmask.apl.washington.edu  Tue Jul 17 03:20:19 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Mon, 16 Jul 2018 20:20:11 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180715150638.GA30154@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
Message-ID: <20180717032011.GA62070@troutmask.apl.washington.edu>

Version 2.  After applying the patch, one can

% svn delete libm/msun/src/polevll.c
% svn commit libm/msun/src/polevll.c

* lib/msun/Makefile:
  . Remove polevll.c

* lib/msun/ld80/e_powl.c:
  . Copy contents of polevll.c to here.  This is the only consumer of 
    these functions.  Make functions 'static inline'.
  . Make reducl a 'static inline' function.
 
* lib/msun/man/exp.3:
  . Remove BUGS section that no longer applies.

* lib/msun/src/math_private.h:
  . Remove prototypes of __p1evll() and __polevll()

* lib/msun/src/s_cpow.c:
* lib/msun/src/s_cpowf.c:
* lib/msun/src/s_cpowl.c
  . Use the CMPLX macro from either C99 or math_private.h (depends of
    compiler support) instead of the problematic use of complex I.

Index: lib/msun/Makefile
===================================================================
--- lib/msun/Makefile	(revision 336360)
+++ lib/msun/Makefile	(working copy)
@@ -17,6 +17,8 @@
 
 .include "${ARCH_SUBDIR}/Makefile.inc"
 
+CFLAGS+=-msse
+
 .PATH:	${.CURDIR}/${ARCH_SUBDIR}
 .if ${MACHINE_CPUARCH} == "i386" || ${MACHINE_CPUARCH} == "amd64"
 .PATH:	${.CURDIR}/x86
@@ -56,7 +58,6 @@
 	imprecise.c \
 	k_cos.c k_cosf.c k_exp.c k_expf.c k_rem_pio2.c k_sin.c k_sinf.c \
 	k_tan.c k_tanf.c \
-	polevll.c \
 	s_asinh.c s_asinhf.c s_atan.c s_atanf.c s_carg.c s_cargf.c s_cargl.c \
 	s_cbrt.c s_cbrtf.c s_ceil.c s_ceilf.c s_clog.c s_clogf.c \
 	s_copysign.c s_copysignf.c s_cos.c s_cosf.c \
Index: lib/msun/ld80/e_powl.c
===================================================================
--- lib/msun/ld80/e_powl.c	(revision 336360)
+++ lib/msun/ld80/e_powl.c	(working copy)
@@ -14,6 +14,52 @@
  * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
  */
 
+#include <sys/cdefs.h>
+__FBSDID("$FreeBSD$");
+
+#include <math.h>
+
+#include "math_private.h"
+
+/*
+ * Polynomial evaluator:
+ *  P[0] x^n  +  P[1] x^(n-1)  +  ...  +  P[n]
+ */
+static inline long double
+__polevll(long double x, long double *PP, int n)
+{
+	long double y;
+	long double *P;
+
+	P = PP;
+	y = *P++;
+	do {
+		y = y * x + *P++;
+	} while (--n);
+
+	return (y);
+}
+
+/*
+ * Polynomial evaluator:
+ *  x^n  +  P[0] x^(n-1)  +  P[1] x^(n-2)  +  ...  +  P[n]
+ */
+static inline long double
+__p1evll(long double x, long double *PP, int n)
+{
+	long double y;
+	long double *P;
+
+	P = PP;
+	n -= 1;
+	y = x + *P++;
+	do {
+		y = y * x + *P++;
+	} while (--n);
+
+	return (y);
+}
+
 /*							powl.c
  *
  *	Power function, long double precision
@@ -467,7 +513,7 @@
 
 
 /* Find a multiple of 1/NXT that is within 1/NXT of x. */
-static long double
+static inline long double
 reducl(long double x)
 {
 long double t;
Index: lib/msun/man/exp.3
===================================================================
--- lib/msun/man/exp.3	(revision 336360)
+++ lib/msun/man/exp.3	(working copy)
@@ -180,16 +180,9 @@
 then \*(Na**0 = 1 too because x**0 = 1 for all finite
 and infinite x, i.e., independently of x.
 .El
-.Sh BUGS
-To conform with newer C/C++ standards, a stub implementation for
-.Nm powl
-was committed to the math library, where
-.Nm powl
-is mapped to
-.Nm pow .
-Thus, the numerical accuracy is at most that of the 53-bit double
-precision implementation.
 .Sh SEE ALSO
+.Xr clog 3
+.Xr cpow 3
 .Xr fenv 3 ,
 .Xr ldexp 3 ,
 .Xr log 3 ,
Index: lib/msun/src/math_private.h
===================================================================
--- lib/msun/src/math_private.h	(revision 336360)
+++ lib/msun/src/math_private.h	(working copy)
@@ -828,7 +828,4 @@
 long double __kernel_cosl(long double, long double);
 long double __kernel_tanl(long double, long double, int);
 
-long double __p1evll(long double, void *, int);
-long double __polevll(long double, void *, int);
-
 #endif /* !_MATH_PRIVATE_H_ */
Index: lib/msun/src/s_cpow.c
===================================================================
--- lib/msun/src/s_cpow.c	(revision 336360)
+++ lib/msun/src/s_cpow.c	(working copy)
@@ -60,7 +60,7 @@
 	y = cimag (z);
 	absa = cabs (a);
 	if (absa == 0.0) {
-		return (0.0 + 0.0 * I);
+		return (CMPLX(0.0, 0.0));
 	}
 	arga = carg (a);
 	r = pow (absa, x);
@@ -69,6 +69,6 @@
 		r = r * exp (-y * arga);
 		theta = theta + y * log (absa);
 	}
-	w = r * cos (theta) + (r * sin (theta)) * I;
+	w = CMPLX(r * cos (theta),  r * sin (theta));
 	return (w);
 }
Index: lib/msun/src/s_cpowf.c
===================================================================
--- lib/msun/src/s_cpowf.c	(revision 336360)
+++ lib/msun/src/s_cpowf.c	(working copy)
@@ -59,7 +59,7 @@
 	y = cimagf(z);
 	absa = cabsf (a);
 	if (absa == 0.0f) {
-		return (0.0f + 0.0f * I);
+		return (CMPLXF(0.0f, 0.0f));
 	}
 	arga = cargf (a);
 	r = powf (absa, x);
@@ -68,6 +68,6 @@
 		r = r * expf (-y * arga);
 		theta = theta + y * logf (absa);
 	}
-	w = r * cosf (theta) + (r * sinf (theta)) * I;
+	w = CMPLXF(r * cosf (theta), r * sinf (theta));
 	return (w);
 }
Index: lib/msun/src/s_cpowl.c
===================================================================
--- lib/msun/src/s_cpowl.c	(revision 336360)
+++ lib/msun/src/s_cpowl.c	(working copy)
@@ -59,7 +59,7 @@
 	y = cimagl(z);
 	absa = cabsl(a);
 	if (absa == 0.0L) {
-		return (0.0L + 0.0L * I);
+		return (CMPLXL(0.0L, 0.0L));
 	}
 	arga = cargl(a);
 	r = powl(absa, x);
@@ -68,6 +68,6 @@
 		r = r * expl(-y * arga);
 		theta = theta + y * logl(absa);
 	}
-	w = r * cosl(theta) + (r * sinl(theta)) * I;
+	w = CMPLXL(r * cosl(theta), r * sinl(theta));
 	return (w);
 }
-- 
Steve

From marklmi at yahoo.com  Tue Jul 17 06:27:29 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 16 Jul 2018 23:27:19 -0700
Subject: head -r335782 (?) broke ci.freebsd.org's FreeBSD-head-amd64-gcc
 build (lib32 part of build)
In-Reply-To: <E7718790-DC0D-4D12-9758-6D240877A6C4@yahoo.com>
References: <00D1127A-1F0E-4E0E-B86C-1C5AA5B2E085@yahoo.com>
 <CF0230A1-1384-4F0F-A96A-5AB555FD17AC@yahoo.com>
 <7A845F2C-C994-4828-823D-33A97B7B6EB0@yahoo.com>
 <72081b02-cf23-82ec-32df-7f5793c35f57@FreeBSD.org>
 <003509F0-F2F4-4A43-82FE-3F6FC23D19D4@yahoo.com>
 <65b19cc4-eaf0-13ed-43e6-9f04a1f7f196@FreeBSD.org>
 <FF369ACC-D496-49AF-BB41-406936E433B0@yahoo.com>
 <edcd2126-3554-f444-6ba0-3da94d887dfe@FreeBSD.org>
 <49BF6569-96A9-4104-BDE6-8BB94C0D9626@yahoo.com>
 <F60AE252-CB8E-429E-97BF-812CC4012A90@yahoo.com>
 <d9385d5b-85a7-3012-3024-c6d9ae8c6705@FreeBSD.org>
 <AA1986CC-E407-4085-BAF9-0C54D6FFB2F4@yahoo.com>
 <E7718790-DC0D-4D12-9758-6D240877A6C4@yahoo.com>
Message-ID: <9251BE92-A8CE-45E3-B4BF-706E7219321A@yahoo.com>

On 2018-Jul-1, at 6:34 AM, Mark Millard <marklmi at yahoo.com> wrote:

> My brain finally engaged for showing exactly what files are included
> for the gcc builds: the .meta files include that information explicitly
> (along with other files that are opened during the operation).
> 
> amd64 is as I reported, just one header file from gcc: float.h .
> 
> powerpc64 builds Lex/Lexer.cpp without defining __ALTIVEC__ and so
> is not including <altivec.h> . Building without __ALTIVEC__ might
> be an error itself but would be a workaround for the altivec.h
> file name aliasing vs. search-path problem.
> 
> . . .

Going in a different direction, what of the unchanged Makefile.inc1
code block:

.if ${WANT_COMPILER_TYPE} == gcc || \
    (defined(X_COMPILER_TYPE) && ${X_COMPILER_TYPE} == gcc)
# GCC requires -isystem and -L when using a cross-compiler.  --sysroot
# won't set header path and -L is used to ensure the base library path
# is added before the port PREFIX library path.
CD2CFLAGS+=     -isystem ${XDDESTDIR}/usr/include -L${XDDESTDIR}/usr/lib
# GCC requires -B to find /usr/lib/crti.o when using a cross-compiler
# combined with --sysroot.
CD2CFLAGS+=     -B${XDDESTDIR}/usr/lib
# Force using libc++ for external GCC.
.if defined(X_COMPILER_TYPE) && \
    ${X_COMPILER_TYPE} == gcc && ${X_COMPILER_VERSION} >= 40800
CD2CXXFLAGS+=   -isystem ${XDDESTDIR}/usr/include/c++/v1 -std=c++11 \
                -nostdinc++
.endif
.endif

Why is that pair of -isystem uses that gives the old search order
okay? Or was the block just missed? (Similarly for other options
listed above.)



Note: Locally I've reverted the -r335782 changes in order for my use
of devel/*-gcc as cross compilers to work where they used to (hopefully:
still building), restoring the historical search order for the
directories for now.



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From aliovx at gmail.com  Tue Jul 17 11:41:39 2018
From: aliovx at gmail.com (Ali Abdallah)
Date: Tue, 17 Jul 2018 13:41:27 +0200
Subject: top -n -o res shows empty output
Message-ID: <CAO3OKx9VJgEdN9ooh9U-Tb2RndGTzo7ms5k3nq+2FwfibZze7A@mail.gmail.com>

Hello,

>From around the revision r334918, the command 'top -n -o res' shows empty
output.

With best regards,
Ali

From aliovx at gmail.com  Wed Jul 18 09:34:52 2018
From: aliovx at gmail.com (Ali Abdallah)
Date: Wed, 18 Jul 2018 11:34:39 +0200
Subject: top -n -o res shows empty output
In-Reply-To: <CAO3OKx9VJgEdN9ooh9U-Tb2RndGTzo7ms5k3nq+2FwfibZze7A@mail.gmail.com>
References: <CAO3OKx9VJgEdN9ooh9U-Tb2RndGTzo7ms5k3nq+2FwfibZze7A@mail.gmail.com>
Message-ID: <CAO3OKx934eKT9P8O5ja1BoCB-pWbgPMGm-K-r4tw1nfQSxU7WA@mail.gmail.com>

I have submitted a bug report with a patch

https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229842

Best,
Ali

On Tue, Jul 17, 2018 at 1:41 PM Ali Abdallah <aliovx at gmail.com> wrote:

> Hello,
>
> From around the revision r334918, the command 'top -n -o res' shows empty
> output.
>
> With best regards,
> Ali
>

From daichi at ongs.co.jp  Wed Jul 18 14:22:52 2018
From: daichi at ongs.co.jp (Daichi GOTO)
Date: Wed, 18 Jul 2018 23:22:29 +0900
Subject: top -n -o res shows empty output
In-Reply-To: <CAO3OKx934eKT9P8O5ja1BoCB-pWbgPMGm-K-r4tw1nfQSxU7WA@mail.gmail.com>
References: <CAO3OKx9VJgEdN9ooh9U-Tb2RndGTzo7ms5k3nq+2FwfibZze7A@mail.gmail.com>
 <CAO3OKx934eKT9P8O5ja1BoCB-pWbgPMGm-K-r4tw1nfQSxU7WA@mail.gmail.com>
Message-ID: <CFF01D00-9E7E-44A6-9125-6203515C6867@ongs.co.jp>

Thank you. I?ll take it.

> 2018/07/18 18:34?Ali Abdallah <aliovx at gmail.com>????:
> 
> I have submitted a bug report with a patch
> 
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229842
> 
> Best,
> Ali
> 
> On Tue, Jul 17, 2018 at 1:41 PM Ali Abdallah <aliovx at gmail.com> wrote:
> 
>> Hello,
>> 
>> From around the revision r334918, the command 'top -n -o res' shows empty
>> output.
>> 
>> With best regards,
>> Ali
>> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

--
Daichi GOTO
CEO | ONGS Inc.
81-42-316-7945 | daichi at ongs.co.jp | http://www.ongs.co.jp
LinkedIn: http://linkedin.com/in/daichigoto


From mina.puck at newcontext.com  Wed Jul 18 17:50:42 2018
From: mina.puck at newcontext.com (Mike Bergfors)
Date: Wed, 18 Jul 2018 10:50:30 -0700
Subject: freebsd-current Digest, Vol 768, Issue 3
In-Reply-To: <mailman.33.1531915200.25345.freebsd-current@freebsd.org>
References: <mailman.33.1531915200.25345.freebsd-current@freebsd.org>
Message-ID: <CADuCVtxh60teM_uSQKTwWpdFJW0yHtwpWEZNngTt1hY0zXs97A@mail.gmail.com>

unsubscribe

On Wed, Jul 18, 2018 at 5:01 AM <freebsd-current-request at freebsd.org> wrote:

> Send freebsd-current mailing list submissions to
>         freebsd-current at freebsd.org
>
> To subscribe or unsubscribe via the World Wide Web, visit
>         https://lists.freebsd.org/mailman/listinfo/freebsd-current
> or, via email, send a message with subject or body 'help' to
>         freebsd-current-request at freebsd.org
>
> You can reach the person managing the list at
>         freebsd-current-owner at freebsd.org
>
> When replying, please edit your Subject line so it is more specific
> than "Re: Contents of freebsd-current digest..."
>
>
> Today's Topics:
>
>    1. Re: top -n -o res shows empty output (Ali Abdallah)
>
>
> ----------------------------------------------------------------------
>
> Message: 1
> Date: Wed, 18 Jul 2018 11:34:39 +0200
> From: Ali Abdallah <aliovx at gmail.com>
> To: freebsd-current at freebsd.org
> Subject: Re: top -n -o res shows empty output
> Message-ID:
>         <
> CAO3OKx934eKT9P8O5ja1BoCB-pWbgPMGm-K-r4tw1nfQSxU7WA at mail.gmail.com>
> Content-Type: text/plain; charset="UTF-8"
>
> I have submitted a bug report with a patch
>
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229842
>
> Best,
> Ali
>
> On Tue, Jul 17, 2018 at 1:41 PM Ali Abdallah <aliovx at gmail.com> wrote:
>
> > Hello,
> >
> > From around the revision r334918, the command 'top -n -o res' shows empty
> > output.
> >
> > With best regards,
> > Ali
> >
>
>
> ------------------------------
>
> Subject: Digest Footer
>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>
>
> ------------------------------
>
> End of freebsd-current Digest, Vol 768, Issue 3
> ***********************************************
>
-- 

[image: New Context] <https://www.newcontext.com/>
Mike Bergfors
Director of Operations

From sgk at troutmask.apl.washington.edu  Thu Jul 19 00:44:59 2018
From: sgk at troutmask.apl.washington.edu (Steve Kargl)
Date: Wed, 18 Jul 2018 17:44:50 -0700
Subject: [PATCH] Recent libm additions
In-Reply-To: <20180717032011.GA62070@troutmask.apl.washington.edu>
References: <20180715150638.GA30154@troutmask.apl.washington.edu>
 <20180717032011.GA62070@troutmask.apl.washington.edu>
Message-ID: <20180719004450.GA17384@troutmask.apl.washington.edu>

This is now PR 229876.

https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=229876


-- 
steve

On Mon, Jul 16, 2018 at 08:20:11PM -0700, Steve Kargl wrote:
> Version 2.  After applying the patch, one can
> 
> % svn delete libm/msun/src/polevll.c
> % svn commit libm/msun/src/polevll.c
> 
> * lib/msun/Makefile:
>   . Remove polevll.c
> 
> * lib/msun/ld80/e_powl.c:
>   . Copy contents of polevll.c to here.  This is the only consumer of 
>     these functions.  Make functions 'static inline'.
>   . Make reducl a 'static inline' function.
>  
> * lib/msun/man/exp.3:
>   . Remove BUGS section that no longer applies.
> 
> * lib/msun/src/math_private.h:
>   . Remove prototypes of __p1evll() and __polevll()
> 
> * lib/msun/src/s_cpow.c:
> * lib/msun/src/s_cpowf.c:
> * lib/msun/src/s_cpowl.c
>   . Use the CMPLX macro from either C99 or math_private.h (depends of
>     compiler support) instead of the problematic use of complex I.
> 
> Index: lib/msun/Makefile
> ===================================================================
> --- lib/msun/Makefile	(revision 336360)
> +++ lib/msun/Makefile	(working copy)
> @@ -17,6 +17,8 @@
>  
>  .include "${ARCH_SUBDIR}/Makefile.inc"
>  
> +CFLAGS+=-msse
> +
>  .PATH:	${.CURDIR}/${ARCH_SUBDIR}
>  .if ${MACHINE_CPUARCH} == "i386" || ${MACHINE_CPUARCH} == "amd64"
>  .PATH:	${.CURDIR}/x86
> @@ -56,7 +58,6 @@
>  	imprecise.c \
>  	k_cos.c k_cosf.c k_exp.c k_expf.c k_rem_pio2.c k_sin.c k_sinf.c \
>  	k_tan.c k_tanf.c \
> -	polevll.c \
>  	s_asinh.c s_asinhf.c s_atan.c s_atanf.c s_carg.c s_cargf.c s_cargl.c \
>  	s_cbrt.c s_cbrtf.c s_ceil.c s_ceilf.c s_clog.c s_clogf.c \
>  	s_copysign.c s_copysignf.c s_cos.c s_cosf.c \
> Index: lib/msun/ld80/e_powl.c
> ===================================================================
> --- lib/msun/ld80/e_powl.c	(revision 336360)
> +++ lib/msun/ld80/e_powl.c	(working copy)
> @@ -14,6 +14,52 @@
>   * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
>   */
>  
> +#include <sys/cdefs.h>
> +__FBSDID("$FreeBSD$");
> +
> +#include <math.h>
> +
> +#include "math_private.h"
> +
> +/*
> + * Polynomial evaluator:
> + *  P[0] x^n  +  P[1] x^(n-1)  +  ...  +  P[n]
> + */
> +static inline long double
> +__polevll(long double x, long double *PP, int n)
> +{
> +	long double y;
> +	long double *P;
> +
> +	P = PP;
> +	y = *P++;
> +	do {
> +		y = y * x + *P++;
> +	} while (--n);
> +
> +	return (y);
> +}
> +
> +/*
> + * Polynomial evaluator:
> + *  x^n  +  P[0] x^(n-1)  +  P[1] x^(n-2)  +  ...  +  P[n]
> + */
> +static inline long double
> +__p1evll(long double x, long double *PP, int n)
> +{
> +	long double y;
> +	long double *P;
> +
> +	P = PP;
> +	n -= 1;
> +	y = x + *P++;
> +	do {
> +		y = y * x + *P++;
> +	} while (--n);
> +
> +	return (y);
> +}
> +
>  /*							powl.c
>   *
>   *	Power function, long double precision
> @@ -467,7 +513,7 @@
>  
>  
>  /* Find a multiple of 1/NXT that is within 1/NXT of x. */
> -static long double
> +static inline long double
>  reducl(long double x)
>  {
>  long double t;
> Index: lib/msun/man/exp.3
> ===================================================================
> --- lib/msun/man/exp.3	(revision 336360)
> +++ lib/msun/man/exp.3	(working copy)
> @@ -180,16 +180,9 @@
>  then \*(Na**0 = 1 too because x**0 = 1 for all finite
>  and infinite x, i.e., independently of x.
>  .El
> -.Sh BUGS
> -To conform with newer C/C++ standards, a stub implementation for
> -.Nm powl
> -was committed to the math library, where
> -.Nm powl
> -is mapped to
> -.Nm pow .
> -Thus, the numerical accuracy is at most that of the 53-bit double
> -precision implementation.
>  .Sh SEE ALSO
> +.Xr clog 3
> +.Xr cpow 3
>  .Xr fenv 3 ,
>  .Xr ldexp 3 ,
>  .Xr log 3 ,
> Index: lib/msun/src/math_private.h
> ===================================================================
> --- lib/msun/src/math_private.h	(revision 336360)
> +++ lib/msun/src/math_private.h	(working copy)
> @@ -828,7 +828,4 @@
>  long double __kernel_cosl(long double, long double);
>  long double __kernel_tanl(long double, long double, int);
>  
> -long double __p1evll(long double, void *, int);
> -long double __polevll(long double, void *, int);
> -
>  #endif /* !_MATH_PRIVATE_H_ */
> Index: lib/msun/src/s_cpow.c
> ===================================================================
> --- lib/msun/src/s_cpow.c	(revision 336360)
> +++ lib/msun/src/s_cpow.c	(working copy)
> @@ -60,7 +60,7 @@
>  	y = cimag (z);
>  	absa = cabs (a);
>  	if (absa == 0.0) {
> -		return (0.0 + 0.0 * I);
> +		return (CMPLX(0.0, 0.0));
>  	}
>  	arga = carg (a);
>  	r = pow (absa, x);
> @@ -69,6 +69,6 @@
>  		r = r * exp (-y * arga);
>  		theta = theta + y * log (absa);
>  	}
> -	w = r * cos (theta) + (r * sin (theta)) * I;
> +	w = CMPLX(r * cos (theta),  r * sin (theta));
>  	return (w);
>  }
> Index: lib/msun/src/s_cpowf.c
> ===================================================================
> --- lib/msun/src/s_cpowf.c	(revision 336360)
> +++ lib/msun/src/s_cpowf.c	(working copy)
> @@ -59,7 +59,7 @@
>  	y = cimagf(z);
>  	absa = cabsf (a);
>  	if (absa == 0.0f) {
> -		return (0.0f + 0.0f * I);
> +		return (CMPLXF(0.0f, 0.0f));
>  	}
>  	arga = cargf (a);
>  	r = powf (absa, x);
> @@ -68,6 +68,6 @@
>  		r = r * expf (-y * arga);
>  		theta = theta + y * logf (absa);
>  	}
> -	w = r * cosf (theta) + (r * sinf (theta)) * I;
> +	w = CMPLXF(r * cosf (theta), r * sinf (theta));
>  	return (w);
>  }
> Index: lib/msun/src/s_cpowl.c
> ===================================================================
> --- lib/msun/src/s_cpowl.c	(revision 336360)
> +++ lib/msun/src/s_cpowl.c	(working copy)
> @@ -59,7 +59,7 @@
>  	y = cimagl(z);
>  	absa = cabsl(a);
>  	if (absa == 0.0L) {
> -		return (0.0L + 0.0L * I);
> +		return (CMPLXL(0.0L, 0.0L));
>  	}
>  	arga = cargl(a);
>  	r = powl(absa, x);
> @@ -68,6 +68,6 @@
>  		r = r * expl(-y * arga);
>  		theta = theta + y * logl(absa);
>  	}
> -	w = r * cosl(theta) + (r * sinl(theta)) * I;
> +	w = CMPLXL(r * cosl(theta), r * sinl(theta));
>  	return (w);
>  }
> -- 
> Steve
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

-- 
Steve
20170425 https://www.youtube.com/watch?v=VWUpyCsUKR4
20161221 https://www.youtube.com/watch?v=IbCHE-hONow

From filippomore at yahoo.com  Thu Jul 19 05:49:43 2018
From: filippomore at yahoo.com (Filippo Moretti)
Date: Thu, 19 Jul 2018 05:49:39 +0000 (UTC)
Subject: Problem with Current amd64
References: <1280450387.6502118.1531979379575.ref@mail.yahoo.com>
Message-ID: <1280450387.6502118.1531979379575@mail.yahoo.com>

I installed from the latest snapshot,made buildworld with custom kernel,installed bash and mc from ports.It was the first time I used zfs on 1 Tb sata III disk.When I rebooted the system I got a nasty surprise:my home directory,ports and src are no longer there.This never happened to me.Should I reinstall or any other suggestion really appreciated
Sincerely
Filippo

From ronald-lists at klop.ws  Thu Jul 19 07:41:58 2018
From: ronald-lists at klop.ws (Ronald Klop)
Date: Thu, 19 Jul 2018 09:41:52 +0200
Subject: Problem with Current amd64
In-Reply-To: <1280450387.6502118.1531979379575@mail.yahoo.com>
References: <1280450387.6502118.1531979379575.ref@mail.yahoo.com>
 <1280450387.6502118.1531979379575@mail.yahoo.com>
Message-ID: <op.zmd2b2mlkndu52@klop.ws>

On Thu, 19 Jul 2018 07:49:39 +0200, Filippo Moretti  
<filippomore at yahoo.com> wrote:

> I installed from the latest snapshot,made buildworld with custom  
> kernel,installed bash and mc from ports.It was the first time I used zfs  
> on 1 Tb sata III disk.When I rebooted the system I got a nasty  
> surprise:my home directory,ports and src are no longer there.This never  
> happened to me.Should I reinstall or any other suggestion really  
> appreciated
> Sincerely
> Filippo

Reinstall sounds unlikely.

Sounds like a mistake in the order of mounting. Something which worked  
when doing manual steps, but not after boot.
Please mail your /etc/fstab and the output of zpool list, zpool status and  
zfs list.
And /etc/rc.conf can be interesting too.

Regards,

Ronald.

From ronald-lists at klop.ws  Thu Jul 19 08:18:13 2018
From: ronald-lists at klop.ws (Ronald Klop)
Date: Thu, 19 Jul 2018 10:18:13 +0200
Subject: Problem with Current amd64
In-Reply-To: <969514184.6520653.1531986976828@mail.yahoo.com>
References: <1280450387.6502118.1531979379575.ref@mail.yahoo.com>
 <1280450387.6502118.1531979379575@mail.yahoo.com> <op.zmd2b2mlkndu52@klop.ws>
 <969514184.6520653.1531986976828@mail.yahoo.com>
Message-ID: <op.zmd30nkwkndu52@klop.ws>

On Thu, 19 Jul 2018 09:56:16 +0200, Filippo Moretti  
<filippomore at yahoo.com> wrote:

> I reinstalled src and ports via svnlite and it seems to work.I will post  
> the files required once I have the pkgs installed
> thank you
> Filippo


Please keep the mailinglist in your reply addresses. Other people know  
much more than I do. ;-)

Ronald.




>
>
>
> On Thursday, July 19, 2018, 9:44:28 AM GMT+2, Ronald Klop  
> <ronald-lists at klop.ws> wrote:
>
> On Thu, 19 Jul 2018 07:49:39 +0200, Filippo Moretti  
> <filippomore at yahoo.com> wrote:
>
>> I installed from the latest snapshot,made buildworld with custom  
>> kernel,installed bash and mc from ports.It was the first time I used  
>> zfs on 1 Tb sata III disk.When I rebooted the system I got a nasty  
>> surprise:my home directory,ports and src are no longer there.This never  
>> happened to me.Should I reinstall or any other suggestion really  
>> appreciated
>> Sincerely
>> Filippo
>
>
> Reinstall sounds unlikely.
>
> Sounds like a mistake in the order of mounting. Something which worked  
> when doing manual steps, but not after boot.
> Please mail your /etc/fstab and the output of zpool list, zpool status  
> and zfs list.
> And /etc/rc.conf can be interesting too.
>
> Regards,
>
> Ronald.
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org
> "

From julian at freebsd.org  Fri Jul 20 11:36:31 2018
From: julian at freebsd.org (Julian Elischer)
Date: Fri, 20 Jul 2018 19:32:48 +0800
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
Message-ID: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>

compiling our samba with gcc 4.2.1 in 12 gave us some off behaviour 
when lld became the linker I think..

1/ linking needed some directories added to some of the build scripts 
because previously apparently it looked in $SYSROOT/usr/lib by default 
and now it doesn't.

2/ compiling our samba produces a libtdb.so that has various symbols 
in it, (according to nm(1) ), but when we try link against it we get 
complaints about those symbols not being defined.

3/ an attempt to switch to using clang to compile everything leads to:


"--aes-accel=intelaesni selected and compiler rejects -Wp,-E,-lang-asm.

One wonders whether there is a clang equivalent of "-Wp,-E,-lang-asm"

The AES acceleration is a configure option for the samba package.

Apparently turning it on requires -Wp,-E,-lang-asm.

which apparently gcc 4.2.1 has, but clang doesn't have.

    FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based
    on LLVM 6.0.1)
    Target: x86_64-unknown-freebsd12.0
    Thread model: posix
    InstalledDir: /usr/bin

anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?

possible work arrounds include:

1/ Get gcc/lld to produce a library from which lld can find the symbols

2/ find a way to compile this with clang but everything else with gcc?

3/ find a way to allow clang to use
-Wp,-E,-lang-asm

whatever that means


Thoughts from any tools people?

Julian


From julian at freebsd.org  Sat Jul 21 14:32:52 2018
From: julian at freebsd.org (Julian Elischer)
Date: Sat, 21 Jul 2018 22:32:34 +0800
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
Message-ID: <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>

I would really like ot get some pointers as to who are our tools 
committers at the moment, in particular who might know about these issues.
The main issue for me at the moment is the ability to compile the 
aesni code in Samba from clang..

Julian


On 20/7/18 7:32 pm, Julian Elischer wrote:
> compiling our samba with gcc 4.2.1 in 12 gave us some off behaviour 
> when lld became the linker I think..
>
> 1/ linking needed some directories added to some of the build 
> scripts because previously apparently it looked in $SYSROOT/usr/lib 
> by default and now it doesn't.
>
> 2/ compiling our samba produces a libtdb.so that has various symbols 
> in it, (according to nm(1) ), but when we try link against it we get 
> complaints about those symbols not being defined.
>
> 3/ an attempt to switch to using clang to compile everything leads to:
>
>
> "--aes-accel=intelaesni selected and compiler rejects -Wp,-E,-lang-asm.
>
> One wonders whether there is a clang equivalent of "-Wp,-E,-lang-asm"
>
> The AES acceleration is a configure option for the samba package.
>
> Apparently turning it on requires -Wp,-E,-lang-asm.
>
> which apparently gcc 4.2.1 has, but clang doesn't have.
>
> ?? FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based
> ?? on LLVM 6.0.1)
> ?? Target: x86_64-unknown-freebsd12.0
> ?? Thread model: posix
> ?? InstalledDir: /usr/bin
>
> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
>
> possible work arrounds include:
>
> 1/ Get gcc/lld to produce a library from which lld can find the symbols
>
> 2/ find a way to compile this with clang but everything else with gcc?
>
> 3/ find a way to allow clang to use
> -Wp,-E,-lang-asm
>
> whatever that means
>
>
> Thoughts from any tools people?
>
> Julian
>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to 
> "freebsd-current-unsubscribe at freebsd.org"
>


From yuripv at yuripv.net  Sat Jul 21 15:16:50 2018
From: yuripv at yuripv.net (Yuri Pankov)
Date: Sat, 21 Jul 2018 18:16:40 +0300
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
Message-ID: <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>

Julian Elischer wrote:
> I would really like ot get some pointers as to who are our tools
> committers at the moment, in particular who might know about these issues.
> The main issue for me at the moment is the ability to compile the
> aesni code in Samba from clang..
> 
> Julian
> 
> 
> On 20/7/18 7:32 pm, Julian Elischer wrote:
>> compiling our samba with gcc 4.2.1 in 12 gave us some off behaviour
>> when lld became the linker I think..
>>
>> 1/ linking needed some directories added to some of the build
>> scripts because previously apparently it looked in $SYSROOT/usr/lib
>> by default and now it doesn't.
>>
>> 2/ compiling our samba produces a libtdb.so that has various symbols
>> in it, (according to nm(1) ), but when we try link against it we get
>> complaints about those symbols not being defined.
>>
>> 3/ an attempt to switch to using clang to compile everything leads to:
>>
>>
>> "--aes-accel=intelaesni selected and compiler rejects -Wp,-E,-lang-asm.
>>
>> One wonders whether there is a clang equivalent of "-Wp,-E,-lang-asm"
>>
>> The AES acceleration is a configure option for the samba package.
>>
>> Apparently turning it on requires -Wp,-E,-lang-asm.
>>
>> which apparently gcc 4.2.1 has, but clang doesn't have.
>>
>>  ?? FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based
>>  ?? on LLVM 6.0.1)
>>  ?? Target: x86_64-unknown-freebsd12.0
>>  ?? Thread model: posix
>>  ?? InstalledDir: /usr/bin
>>
>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?

In later GCC versions the cpp's -lang-asm seems to be deprecated in 
favor of -x assembler-with-cpp as it conflicts with -l option.

Could you try changing the -Wp,-E,-lang-asm to -Wp,-E,-xassembler-with-cpp?

>> possible work arrounds include:
>>
>> 1/ Get gcc/lld to produce a library from which lld can find the symbols
>>
>> 2/ find a way to compile this with clang but everything else with gcc?
>>
>> 3/ find a way to allow clang to use
>> -Wp,-E,-lang-asm
>>
>> whatever that means
>>
>>
>> Thoughts from any tools people?

From pete at nomadlogic.org  Sat Jul 21 16:41:32 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Sat, 21 Jul 2018 09:41:24 -0700
Subject: ntpd as ntpd user question
Message-ID: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>

hello - i am testing out the new ntpd that was committed yesterday and 
am attempting to run as non-root.? i've created a ntpd user/group, and 
verified permissions look good on pertinent directories.? i am running 
into an issue with the rc script tho - it's complaining about multiple 
pid files being specified?

$ sudo /etc/rc.d/ntpd start
Starting ntpd.
ntpd error:? only one pidfile option allowed
ntpd - NTP daemon program - Ver. 4.2.8p11
Usage:? ntpd [ -<flag> [<val>] | --<name>[{=| }<val>] ]... \
 ??? ??? [ <server1> ... <serverN> ]
Try 'ntpd --help' for more information.
/etc/rc.d/ntpd: WARNING: failed to start ntpd


has anyone else seen this issue? not sure if this is an issue with my 
local config or not, i've read through the rc script and its not obvious 
to me yet why it may be getting multiple pid arguments passed.? the only 
relevant bit i have set in rc.conf is:

$ grep ntpd /etc/rc.conf
ntpd_enable="YES"


thanks!
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From ian at freebsd.org  Sat Jul 21 16:47:47 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sat, 21 Jul 2018 10:47:35 -0600
Subject: ntpd as ntpd user question
In-Reply-To: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
Message-ID: <1532191655.1344.80.camel@freebsd.org>

On Sat, 2018-07-21 at 09:41 -0700, Pete Wright wrote:
> hello - i am testing out the new ntpd that was committed yesterday and?
> am attempting to run as non-root.? i've created a ntpd user/group, and?
> verified permissions look good on pertinent directories.? i am running?
> into an issue with the rc script tho - it's complaining about multiple?
> pid files being specified?
> 
> $ sudo /etc/rc.d/ntpd start
> Starting ntpd.
> ntpd error:? only one pidfile option allowed
> ntpd - NTP daemon program - Ver. 4.2.8p11
> Usage:? ntpd [ - [] | --[{=| }] ]... \
> ???? ??? [  ...  ]
> Try 'ntpd --help' for more information.
> /etc/rc.d/ntpd: WARNING: failed to start ntpd
> 
> 
> has anyone else seen this issue? not sure if this is an issue with my?
> local config or not, i've read through the rc script and its not obvious?
> to me yet why it may be getting multiple pid arguments passed.? the only?
> relevant bit i have set in rc.conf is:
> 
> $ grep ntpd /etc/rc.conf
> ntpd_enable="YES"
> 
> 
> thanks!
> -pete
> 

You say you created an ntpd user/group, that seems to imply you didn't
run mergemaster (which would have done that). If that's the case, you
probably also didn't get /etc/defaults/rc.conf updated, so it still has
the old ntpd_flags that includes the pidfile (which is now provided by
the startup script and shouldn't be set in ntpd_flags).

If all of that is the wrong guess, let me know and we'll figure it out.

-- Ian


From pete at nomadlogic.org  Sat Jul 21 17:11:52 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Sat, 21 Jul 2018 10:11:43 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532191655.1344.80.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
Message-ID: <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>



On 07/21/2018 09:47, Ian Lepore wrote:
> On Sat, 2018-07-21 at 09:41 -0700, Pete Wright wrote:
>> hello - i am testing out the new ntpd that was committed yesterday and
>> am attempting to run as non-root.? i've created a ntpd user/group, and
>> verified permissions look good on pertinent directories.? i am running
>> into an issue with the rc script tho - it's complaining about multiple
>> pid files being specified?
>>
>> $ sudo /etc/rc.d/ntpd start
>> Starting ntpd.
>> ntpd error:? only one pidfile option allowed
>> ntpd - NTP daemon program - Ver. 4.2.8p11
>> Usage:? ntpd [ - [] | --[{=| }] ]... \
>>  ???? ??? [  ...  ]
>> Try 'ntpd --help' for more information.
>> /etc/rc.d/ntpd: WARNING: failed to start ntpd
>>
>>
>> has anyone else seen this issue? not sure if this is an issue with my
>> local config or not, i've read through the rc script and its not obvious
>> to me yet why it may be getting multiple pid arguments passed.? the only
>> relevant bit i have set in rc.conf is:
>>
>> $ grep ntpd /etc/rc.conf
>> ntpd_enable="YES"
>>
>>
>> thanks!
>> -pete
>>
> You say you created an ntpd user/group, that seems to imply you didn't
> run mergemaster (which would have done that). If that's the case, you
> probably also didn't get /etc/defaults/rc.conf updated, so it still has
> the old ntpd_flags that includes the pidfile (which is now provided by
> the startup script and shouldn't be set in ntpd_flags).
>
> If all of that is the wrong guess, let me know and we'll figure it out.

that's Ian - that's most likely it (defaults/rc.conf).? i did run 
mergemaster but i suspect i didn't run it correctly b/c it didn't copy 
over any files, nor create the ntpd uid/gid.? my buildworld script does 
a "mergemaster -m $CHECKOUT -a".? i'll re-read the man page today and 
update my scripts accordingly.

thanks again for the bread-crumb!
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From ian at freebsd.org  Sat Jul 21 17:14:56 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sat, 21 Jul 2018 11:14:45 -0600
Subject: ntpd as ntpd user question
In-Reply-To: <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
Message-ID: <1532193285.1344.83.camel@freebsd.org>

On Sat, 2018-07-21 at 10:11 -0700, Pete Wright wrote:
> 
> On 07/21/2018 09:47, Ian Lepore wrote:
> > 
> > On Sat, 2018-07-21 at 09:41 -0700, Pete Wright wrote:
> > > 
> > > hello - i am testing out the new ntpd that was committed
> > > yesterday and
> > > am attempting to run as non-root.? i've created a ntpd
> > > user/group, and
> > > verified permissions look good on pertinent directories.? i am
> > > running
> > > into an issue with the rc script tho - it's complaining about
> > > multiple
> > > pid files being specified?
> > > 
> > > $ sudo /etc/rc.d/ntpd start
> > > Starting ntpd.
> > > ntpd error:? only one pidfile option allowed
> > > ntpd - NTP daemon program - Ver. 4.2.8p11
> > > Usage:? ntpd [ - [] | --[{=| }] ]... \
> > > ????? ??? [??...??]
> > > Try 'ntpd --help' for more information.
> > > /etc/rc.d/ntpd: WARNING: failed to start ntpd
> > > 
> > > 
> > > has anyone else seen this issue? not sure if this is an issue
> > > with my
> > > local config or not, i've read through the rc script and its not
> > > obvious
> > > to me yet why it may be getting multiple pid arguments passed.?
> > > the only
> > > relevant bit i have set in rc.conf is:
> > > 
> > > $ grep ntpd /etc/rc.conf
> > > ntpd_enable="YES"
> > > 
> > > 
> > > thanks!
> > > -pete
> > > 
> > You say you created an ntpd user/group, that seems to imply you
> > didn't
> > run mergemaster (which would have done that). If that's the case,
> > you
> > probably also didn't get /etc/defaults/rc.conf updated, so it still
> > has
> > the old ntpd_flags that includes the pidfile (which is now provided
> > by
> > the startup script and shouldn't be set in ntpd_flags).
> > 
> > If all of that is the wrong guess, let me know and we'll figure it
> > out.
> that's Ian - that's most likely it (defaults/rc.conf).? i did run?
> mergemaster but i suspect i didn't run it correctly b/c it didn't
> copy?
> over any files, nor create the ntpd uid/gid.? my buildworld script
> does?
> a "mergemaster -m $CHECKOUT -a".? i'll re-read the man page today
> and?
> update my scripts accordingly.
> 
> thanks again for the bread-crumb!
> -pete
> 

There's a "pre-world" stage of mergemaster (-Fp option I think) which
isn't needed often, but one of the times it is needed is apparently
when new user ids are added. ?(So I've been told, I've never much used
mergemaster myself). I think there are some words about it at the very
bottom of UPDATING.

-- Ian

From fbsd at www.zefox.net  Sat Jul 21 17:47:15 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Sat, 21 Jul 2018 10:47:22 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532193285.1344.83.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
Message-ID: <20180721174722.GA40167@www.zefox.net>

On Sat, Jul 21, 2018 at 11:14:45AM -0600, Ian Lepore wrote:
> 
> There's a "pre-world" stage of mergemaster (-Fp option I think) which
> isn't needed often, but one of the times it is needed is apparently
> when new user ids are added. ?(So I've been told, I've never much used
> mergemaster myself). I think there are some words about it at the very
> bottom of UPDATING.
> 

FWIW, installkernel stopped with the note about needing an ntpd user/group.
Never having been successful with mergemaster (couldn't make heads nor tails
of the "what to do" prompts) I just ran adduser, creating a locked ntpd user
and group. Nothing else special done. The machine is up to r336567 on arm64.

Installkernel ran, I didn't touch anthing in /etc manually and reboot looked normal.
For now it seems ignorance is bliss....

If there's something special I should do (beyond locking) to secure the ntpd 
account please warn me.

Thanks for reading,

bob prohaska


From rwmaillists at googlemail.com  Sat Jul 21 17:56:59 2018
From: rwmaillists at googlemail.com (RW)
Date: Sat, 21 Jul 2018 18:56:54 +0100
Subject: ntpd as ntpd user question
In-Reply-To: <1532193285.1344.83.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
Message-ID: <20180721185654.239b4c8b@gumby.homeunix.com>

On Sat, 21 Jul 2018 11:14:45 -0600
Ian Lepore wrote:


> There's a "pre-world" stage of mergemaster (-Fp option I think) which
> isn't needed often, but one of the times it is needed is apparently
> when new user ids are added. ?

I wish mergemaster had an option to just add new users and groups,
rather than merging the files. 

From ian at freebsd.org  Sat Jul 21 18:14:14 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sat, 21 Jul 2018 12:14:10 -0600
Subject: ntpd as ntpd user question
In-Reply-To: <20180721174722.GA40167@www.zefox.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
Message-ID: <1532196850.1344.87.camel@freebsd.org>

On Sat, 2018-07-21 at 10:47 -0700, bob prohaska wrote:
> On Sat, Jul 21, 2018 at 11:14:45AM -0600, Ian Lepore wrote:
> > 
> > 
> > There's a "pre-world" stage of mergemaster (-Fp option I think) which
> > isn't needed often, but one of the times it is needed is apparently
> > when new user ids are added. ?(So I've been told, I've never much used
> > mergemaster myself). I think there are some words about it at the very
> > bottom of UPDATING.
> > 
> FWIW, installkernel stopped with the note about needing an ntpd user/group.
> Never having been successful with mergemaster (couldn't make heads nor tails
> of the "what to do" prompts) I just ran adduser, creating a locked ntpd user
> and group. Nothing else special done. The machine is up to r336567 on arm64.
> 
> Installkernel ran, I didn't touch anthing in /etc manually and reboot looked normal.
> For now it seems ignorance is bliss....
> 
> If there's something special I should do (beyond locking) to secure the ntpd?
> account please warn me.
> 
> Thanks for reading,
> 
> bob prohaska

I can't see any way that installkernel would lead to the complaint
about the ntpd user not existing; that check is tied to the
installworld target.

A quick way to check whether ntpd is running as ntpd user:

?procstat cred `pgrep ntpd`

 PID  COMM ?EUID??RUID SVUID??EGID??RGID SVGID UMASK FLAGS GROUPS
 1176 ntpd ? 123???123???123???123???123???123???022 -?????123

-- Ian

From pete at nomadlogic.org  Sat Jul 21 18:23:46 2018
From: pete at nomadlogic.org (Pete Wright)
Date: Sat, 21 Jul 2018 11:23:37 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532193285.1344.83.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
Message-ID: <dfa3f30e-bf1f-501b-39c7-1efe0463396b@nomadlogic.org>



On 07/21/2018 10:14, Ian Lepore wrote:
> On Sat, 2018-07-21 at 10:11 -0700, Pete Wright wrote:
>> On 07/21/2018 09:47, Ian Lepore wrote:
>>> On Sat, 2018-07-21 at 09:41 -0700, Pete Wright wrote:
>>>> hello - i am testing out the new ntpd that was committed
>>>> yesterday and
>>>> am attempting to run as non-root.? i've created a ntpd
>>>> user/group, and
>>>> verified permissions look good on pertinent directories.? i am
>>>> running
>>>> into an issue with the rc script tho - it's complaining about
>>>> multiple
>>>> pid files being specified?
>>>>
>>>> $ sudo /etc/rc.d/ntpd start
>>>> Starting ntpd.
>>>> ntpd error:? only one pidfile option allowed
>>>> ntpd - NTP daemon program - Ver. 4.2.8p11
>>>> Usage:? ntpd [ - [] | --[{=| }] ]... \
>>>>  ????? ??? [??...??]
>>>> Try 'ntpd --help' for more information.
>>>> /etc/rc.d/ntpd: WARNING: failed to start ntpd
>>>>
>>>>
>>>> has anyone else seen this issue? not sure if this is an issue
>>>> with my
>>>> local config or not, i've read through the rc script and its not
>>>> obvious
>>>> to me yet why it may be getting multiple pid arguments passed.
>>>> the only
>>>> relevant bit i have set in rc.conf is:
>>>>
>>>> $ grep ntpd /etc/rc.conf
>>>> ntpd_enable="YES"
>>>>
>>>>
>>>> thanks!
>>>> -pete
>>>>
>>> You say you created an ntpd user/group, that seems to imply you
>>> didn't
>>> run mergemaster (which would have done that). If that's the case,
>>> you
>>> probably also didn't get /etc/defaults/rc.conf updated, so it still
>>> has
>>> the old ntpd_flags that includes the pidfile (which is now provided
>>> by
>>> the startup script and shouldn't be set in ntpd_flags).
>>>
>>> If all of that is the wrong guess, let me know and we'll figure it
>>> out.
>> that's Ian - that's most likely it (defaults/rc.conf).? i did run
>> mergemaster but i suspect i didn't run it correctly b/c it didn't
>> copy
>> over any files, nor create the ntpd uid/gid.? my buildworld script
>> does
>> a "mergemaster -m $CHECKOUT -a".? i'll re-read the man page today
>> and
>> update my scripts accordingly.
>>
>> thanks again for the bread-crumb!
>> -pete
>>
> There's a "pre-world" stage of mergemaster (-Fp option I think) which
> isn't needed often, but one of the times it is needed is apparently
> when new user ids are added. ?(So I've been told, I've never much used
> mergemaster myself). I think there are some words about it at the very
> bottom of UPDATING.

so i was running the "pre-world" mergemaster, but i think what bit me 
was relying on the "-a" switch.? after reading UPDATING as you suggested 
i re-ran mergemaster like so:

"sudo mergemaster -m $CHECKOUT -rvF"

which seems closer in-line with the documentation.? i had a ton of stuff 
missing, which would explain some funky behaviour i've seen in regards 
to devd, so glad i sorted this out.

as someone RW mentions later in this thread, it would be sweet if 
mergemaster could auto add users/groups.? i missed this in the diff 
during my pre-installworld mergemaster run.? easily fixed - but def 
something i'll have to keep my eye out for.

cheers,
-pete

-- 
Pete Wright
pete at nomadlogic.org
@nomadlogicLA


From Cy.Schubert at cschubert.com  Sat Jul 21 19:01:58 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Sat, 21 Jul 2018 12:01:49 -0700
Subject: ntpd as ntpd user question
Message-ID: <20180721190147.F088C797@spqr.komquats.com>

This is why you need to run pre-world mergemaster.

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---

-----Original Message-----
From: bob prohaska
Sent: 21/07/2018 10:49
To: Ian Lepore
Cc: Pete Wright; FreeBSD Current; bob prohaska
Subject: Re: ntpd as ntpd user question

On Sat, Jul 21, 2018 at 11:14:45AM -0600, Ian Lepore wrote:
> 
> There's a "pre-world" stage of mergemaster (-Fp option I think) which
> isn't needed often, but one of the times it is needed is apparently
> when new user ids are added. ?(So I've been told, I've never much used
> mergemaster myself). I think there are some words about it at the very
> bottom of UPDATING.
> 

FWIW, installkernel stopped with the note about needing an ntpd user/group.
Never having been successful with mergemaster (couldn't make heads nor tails
of the "what to do" prompts) I just ran adduser, creating a locked ntpd user
and group. Nothing else special done. The machine is up to r336567 on arm64.

Installkernel ran, I didn't touch anthing in /etc manually and reboot looked normal.
For now it seems ignorance is bliss....

If there's something special I should do (beyond locking) to secure the ntpd 
account please warn me.

Thanks for reading,

bob prohaska

_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


From Cy.Schubert at cschubert.com  Sat Jul 21 19:02:20 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Sat, 21 Jul 2018 12:02:19 -0700
Subject: ntpd as ntpd user question
Message-ID: <20180721190218.0EF0F79C@spqr.komquats.com>

What's the difference?

---
Sent using a tiny phone keyboard.
Apologies for any typos and autocorrect.
Also, this old phone only supports top post. Apologies.

Cy Schubert
<Cy.Schubert at cschubert.com> or <cy at freebsd.org>
The need of the many outweighs the greed of the few.
---

-----Original Message-----
From: RW
Sent: 21/07/2018 10:59
To: freebsd-current at freebsd.org
Subject: Re: ntpd as ntpd user question

On Sat, 21 Jul 2018 11:14:45 -0600
Ian Lepore wrote:


> There's a "pre-world" stage of mergemaster (-Fp option I think) which
> isn't needed often, but one of the times it is needed is apparently
> when new user ids are added. ?

I wish mergemaster had an option to just add new users and groups,
rather than merging the files. 
_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

From yuripv at yuripv.net  Sat Jul 21 19:11:26 2018
From: yuripv at yuripv.net (Yuri Pankov)
Date: Sat, 21 Jul 2018 22:11:19 +0300
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
 <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
Message-ID: <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>

Yuri Pankov wrote:
> Julian Elischer wrote:
>> I would really like ot get some pointers as to who are our tools
>> committers at the moment, in particular who might know about these issues.
>> The main issue for me at the moment is the ability to compile the
>> aesni code in Samba from clang..
>>
>> Julian
>>
>>
>> On 20/7/18 7:32 pm, Julian Elischer wrote:
>>> compiling our samba with gcc 4.2.1 in 12 gave us some off behaviour
>>> when lld became the linker I think..
>>>
>>> 1/ linking needed some directories added to some of the build
>>> scripts because previously apparently it looked in $SYSROOT/usr/lib
>>> by default and now it doesn't.
>>>
>>> 2/ compiling our samba produces a libtdb.so that has various symbols
>>> in it, (according to nm(1) ), but when we try link against it we get
>>> complaints about those symbols not being defined.
>>>
>>> 3/ an attempt to switch to using clang to compile everything leads to:
>>>
>>>
>>> "--aes-accel=intelaesni selected and compiler rejects -Wp,-E,-lang-asm.
>>>
>>> One wonders whether there is a clang equivalent of "-Wp,-E,-lang-asm"
>>>
>>> The AES acceleration is a configure option for the samba package.
>>>
>>> Apparently turning it on requires -Wp,-E,-lang-asm.
>>>
>>> which apparently gcc 4.2.1 has, but clang doesn't have.
>>>
>>>   ?? FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based
>>>   ?? on LLVM 6.0.1)
>>>   ?? Target: x86_64-unknown-freebsd12.0
>>>   ?? Thread model: posix
>>>   ?? InstalledDir: /usr/bin
>>>
>>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
> 
> In later GCC versions the cpp's -lang-asm seems to be deprecated in
> favor of -x assembler-with-cpp as it conflicts with -l option.
> 
> Could you try changing the -Wp,-E,-lang-asm to -Wp,-E,-xassembler-with-cpp?

Just tried it myself, and if you indeed mean the 
third_party/aesni-intel/aesni-intel_asm.c, the following seems to work 
for me:

clang -xassembler-with-cpp -c third_party/aesni-intel/aesni-intel_asm.c

>>> possible work arrounds include:
>>>
>>> 1/ Get gcc/lld to produce a library from which lld can find the symbols
>>>
>>> 2/ find a way to compile this with clang but everything else with gcc?
>>>
>>> 3/ find a way to allow clang to use
>>> -Wp,-E,-lang-asm
>>>
>>> whatever that means
>>>
>>>
>>> Thoughts from any tools people?


From dim at FreeBSD.org  Sat Jul 21 20:32:55 2018
From: dim at FreeBSD.org (Dimitry Andric)
Date: Sat, 21 Jul 2018 22:32:49 +0200
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
 <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
 <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
Message-ID: <F5832A14-009D-4FD2-BCE7-D07F96165041@FreeBSD.org>

On 21 Jul 2018, at 21:11, Yuri Pankov <yuripv at yuripv.net> wrote:
> 
> Yuri Pankov wrote:
>> Julian Elischer wrote:
...
>>>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
>> In later GCC versions the cpp's -lang-asm seems to be deprecated in
>> favor of -x assembler-with-cpp as it conflicts with -l option.
>> Could you try changing the -Wp,-E,-lang-asm to -Wp,-E,-xassembler-with-cpp?
> 
> Just tried it myself, and if you indeed mean the third_party/aesni-intel/aesni-intel_asm.c, the following seems to work for me:
> 
> clang -xassembler-with-cpp -c third_party/aesni-intel/aesni-intel_asm.c

Yes, that is exactly what I suggested to Julian on IRC.  The point is
that the ".c" extension is misleading, it should more likely be a ".S"
extension.  But maybe this source file is used for multiple purposes.

Note that -x assembler-with-cpp should also work fine for gcc.

-Dimitry

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 223 bytes
Desc: Message signed with OpenPGP
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180721/2c9ab8d3/attachment.sig>

From fbsd at www.zefox.net  Sat Jul 21 22:09:12 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Sat, 21 Jul 2018 15:09:26 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532196850.1344.87.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
Message-ID: <20180721220925.GA40238@www.zefox.net>

On Sat, Jul 21, 2018 at 12:14:10PM -0600, Ian Lepore wrote:
> 
> I can't see any way that installkernel would lead to the complaint
> about the ntpd user not existing; that check is tied to the
> installworld target.
> 
My mistake. I was sleepy and in a hurry. The error message was in installworld
and my attempt to adduser ntpd concluded with an error:
Locked     : yes
OK? (yes/no): yes
pw: Bad id 'ntpd': invalid
adduser: ERROR: There was an error adding user (ntpd).
On reboot the old ntpd set the clock and I thought all was well.

The failure is a little surprising, is ntpd a reserved name?

The machine is re-running buildworld/installworld from a clean start,
so presumably it'll halt over the same error again. When that happens, 
what's the simplest way to recover? Mergemaster is a big hammer, something
less comprehensive might suffice, even manual editing of files.  

There's minimal customization on the machine, basically /etc/fstab, 
/etc/rc.conf and /etc/passwd. Nothing else of real value, so if I kill 
it in the attempt it won't be a disaster.


Thanks for waking me to my blunder...

bob prohaska
 

From kib at freebsd.org  Sat Jul 21 23:18:42 2018
From: kib at freebsd.org (Konstantin Belousov)
Date: Sun, 22 Jul 2018 02:18:32 +0300
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
Message-ID: <20180721231832.GC65334@kib.kiev.ua>

On Sat, Jul 21, 2018 at 02:16:17AM +0000, jenkins-admin at FreeBSD.org wrote:
> --- lib/ofed/libmlx5__L ---
> In file included from /workspace/src/contrib/ofed/libmlx5/mlx5.h:44:0,
>                  from /workspace/src/contrib/ofed/libmlx5/buf.c:42:
> /workspace/obj/workspace/src/riscv.riscv64/tmp/usr/include/infiniband/udma_barrier.h:108:2: error: #error No architecture specific memory barrier defines found!
>  #error No architecture specific memory barrier defines found!
>   ^~~~~

The patch below should be enough to fix the build,  modulo the syntax
errors which I cannot check.  The reason is that it seems riscv is not
cross-buildable from stable/11 host:
--- includes_subdir_include/rpcsvc ---
RPCGEN_CPP=cpp\ -target\ riscv64-unknown-freebsd12.0\ --sysroot=/usr/home/konstantinb/build/bsd/DEV/obj/usr/home/konstantinb/build/bsd/DEV/src/riscv.riscv64/tmp\ -B/usr/local rpcgen -C -h -DWANT_NFS3 /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc/klm_prot.x -o klm_prot.h
--- key_prot.h ---
error: unknown target triple 'riscv64-unknown-freebsd12.0', please use -triple or -arch
*** [key_prot.h] Error code 1

make[4]: stopped in /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc

So if somebody who care about riscv and can build the world could
confirm the fix, I will commit it.

diff --git a/contrib/ofed/include/udma_barrier.h b/contrib/ofed/include/udma_barrier.h
index 71d264f8dce..6709d4433a7 100644
--- a/contrib/ofed/include/udma_barrier.h
+++ b/contrib/ofed/include/udma_barrier.h
@@ -104,6 +104,10 @@
 #include <sys/types.h>
 #include <machine/atomic.h>
 #define udma_to_device_barrier() dmb()
+#elif defined(__riscv__)
+#include <sys/types.h>
+#include <machine/atomic.h>
+#define	udma_to_device_barrier() fence()
 #else
 #error No architecture specific memory barrier defines found!
 #endif

From herbert at gojira.at  Sat Jul 21 23:49:44 2018
From: herbert at gojira.at (Herbert J. Skuhra)
Date: Sun, 22 Jul 2018 01:49:41 +0200
Subject: ntpd as ntpd user question
In-Reply-To: <20180721220925.GA40238@www.zefox.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
Message-ID: <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>

On Sat, Jul 21, 2018 at 03:09:26PM -0700, bob prohaska wrote:
> On Sat, Jul 21, 2018 at 12:14:10PM -0600, Ian Lepore wrote:
> > 
> > I can't see any way that installkernel would lead to the complaint
> > about the ntpd user not existing; that check is tied to the
> > installworld target.
> > 
> My mistake. I was sleepy and in a hurry. The error message was in installworld
> and my attempt to adduser ntpd concluded with an error:
> Locked     : yes
> OK? (yes/no): yes
> pw: Bad id 'ntpd': invalid
> adduser: ERROR: There was an error adding user (ntpd).
> On reboot the old ntpd set the clock and I thought all was well.
> 
> The failure is a little surprising, is ntpd a reserved name?

Why? You obviously entered the string "ntpd" instead of an integer when
asked for the uid!?

> The machine is re-running buildworld/installworld from a clean start,
> so presumably it'll halt over the same error again. When that happens, 
> what's the simplest way to recover? Mergemaster is a big hammer, something
> less comprehensive might suffice, even manual editing of files.

In this case 'mergemaster -p' is enough.

-- 
Herbert

From lwhsu at FreeBSD.org  Sun Jul 22 01:01:18 2018
From: lwhsu at FreeBSD.org (Li-Wen Hsu)
Date: Sun, 22 Jul 2018 01:01:16 +0000
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180721231832.GC65334@kib.kiev.ua>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
Message-ID: <20180722010116.GA13419@freefall.freebsd.org>

On Sun, Jul 22, 2018 at 02:18:32 +0300, Konstantin Belousov wrote:
> On Sat, Jul 21, 2018 at 02:16:17AM +0000, jenkins-admin at FreeBSD.org wrote:
> > --- lib/ofed/libmlx5__L ---
> > In file included from /workspace/src/contrib/ofed/libmlx5/mlx5.h:44:0,
> >                  from /workspace/src/contrib/ofed/libmlx5/buf.c:42:
> > /workspace/obj/workspace/src/riscv.riscv64/tmp/usr/include/infiniband/udma_barrier.h:108:2: error: #error No architecture specific memory barrier defines found!
> >  #error No architecture specific memory barrier defines found!
> >   ^~~~~
> 
> The patch below should be enough to fix the build,  modulo the syntax
> errors which I cannot check.  The reason is that it seems riscv is not
> cross-buildable from stable/11 host:
> --- includes_subdir_include/rpcsvc ---
> RPCGEN_CPP=cpp\ -target\ riscv64-unknown-freebsd12.0\ --sysroot=/usr/home/konstantinb/build/bsd/DEV/obj/usr/home/konstantinb/build/bsd/DEV/src/riscv.riscv64/tmp\ -B/usr/local rpcgen -C -h -DWANT_NFS3 /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc/klm_prot.x -o klm_prot.h
> --- key_prot.h ---
> error: unknown target triple 'riscv64-unknown-freebsd12.0', please use -triple or -arch
> *** [key_prot.h] Error code 1
> 
> make[4]: stopped in /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc
> 
> So if somebody who care about riscv and can build the world could
> confirm the fix, I will commit it.
> 
> diff --git a/contrib/ofed/include/udma_barrier.h b/contrib/ofed/include/udma_barrier.h
> index 71d264f8dce..6709d4433a7 100644
> --- a/contrib/ofed/include/udma_barrier.h
> +++ b/contrib/ofed/include/udma_barrier.h
> @@ -104,6 +104,10 @@
>  #include <sys/types.h>
>  #include <machine/atomic.h>
>  #define udma_to_device_barrier() dmb()
> +#elif defined(__riscv__)
> +#include <sys/types.h>
> +#include <machine/atomic.h>
> +#define	udma_to_device_barrier() fence()
>  #else
>  #error No architecture specific memory barrier defines found!
>  #endif

Thanks for looking into this.  Attached patch is slightly modified.
RISC-V is using __riscv and there are few more atomic macros need to be
defined.

However this seems not enough, there are some c++ errors which may take
longer to fix:

In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:43:0,
                 from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
  atomic_store(&lock->cnt, 0);
  ^
In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:0:
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
  if (atomic_fetch_add(&lock->cnt, 1) > 0)
  ^~
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
/usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
  ^~
*** [acm.o] Error code 1

make[6]: stopped in /usr/home/lwhsu/freebsd-src/lib/ofed/librdmacm


BTW, stable/11 should be fine to cross-build riscv64, this job uses
11.2-RELEASE and riscv64-xtoolchain-gcc package, with
CROSS_TOOLCHAIN=riscv64-gcc defined.


Best,
Li-Wen

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org
-------------- next part --------------
A non-text attachment was scrubbed...
Name: udma_barrier.h.diff
Type: text/x-diff
Size: 1074 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180722/00141260/attachment.diff>

From rwmaillists at googlemail.com  Sun Jul 22 14:27:06 2018
From: rwmaillists at googlemail.com (RW)
Date: Sun, 22 Jul 2018 15:27:02 +0100
Subject: ntpd as ntpd user question
In-Reply-To: <20180721190218.0EF0F79C@spqr.komquats.com>
References: <20180721190218.0EF0F79C@spqr.komquats.com>
Message-ID: <20180722152702.53b4d9bc@gumby.homeunix.com>

On Sat, 21 Jul 2018 12:02:19 -0700
Cy Schubert wrote:

>> I wish mergemaster had an option to just add new users and groups,
>> rather than merging the files. 

> What's the difference?
 
It would be automatic, so less hassle and no chance of getting the
merge wrong.

From kostikbel at gmail.com  Sun Jul 22 15:45:19 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Sun, 22 Jul 2018 18:45:05 +0300
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180722010116.GA13419@freefall.freebsd.org>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
Message-ID: <20180722154505.GE65334@kib.kiev.ua>

On Sun, Jul 22, 2018 at 01:01:16AM +0000, Li-Wen Hsu wrote:
> On Sun, Jul 22, 2018 at 02:18:32 +0300, Konstantin Belousov wrote:
> > On Sat, Jul 21, 2018 at 02:16:17AM +0000, jenkins-admin at FreeBSD.org wrote:
> > > --- lib/ofed/libmlx5__L ---
> > > In file included from /workspace/src/contrib/ofed/libmlx5/mlx5.h:44:0,
> > >                  from /workspace/src/contrib/ofed/libmlx5/buf.c:42:
> > > /workspace/obj/workspace/src/riscv.riscv64/tmp/usr/include/infiniband/udma_barrier.h:108:2: error: #error No architecture specific memory barrier defines found!
> > >  #error No architecture specific memory barrier defines found!
> > >   ^~~~~
> > 
> > The patch below should be enough to fix the build,  modulo the syntax
> > errors which I cannot check.  The reason is that it seems riscv is not
> > cross-buildable from stable/11 host:
> > --- includes_subdir_include/rpcsvc ---
> > RPCGEN_CPP=cpp\ -target\ riscv64-unknown-freebsd12.0\ --sysroot=/usr/home/konstantinb/build/bsd/DEV/obj/usr/home/konstantinb/build/bsd/DEV/src/riscv.riscv64/tmp\ -B/usr/local rpcgen -C -h -DWANT_NFS3 /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc/klm_prot.x -o klm_prot.h
> > --- key_prot.h ---
> > error: unknown target triple 'riscv64-unknown-freebsd12.0', please use -triple or -arch
> > *** [key_prot.h] Error code 1
> > 
> > make[4]: stopped in /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc
> > 
> > So if somebody who care about riscv and can build the world could
> > confirm the fix, I will commit it.
> > 
> > diff --git a/contrib/ofed/include/udma_barrier.h b/contrib/ofed/include/udma_barrier.h
> > index 71d264f8dce..6709d4433a7 100644
> > --- a/contrib/ofed/include/udma_barrier.h
> > +++ b/contrib/ofed/include/udma_barrier.h
> > @@ -104,6 +104,10 @@
> >  #include <sys/types.h>
> >  #include <machine/atomic.h>
> >  #define udma_to_device_barrier() dmb()
> > +#elif defined(__riscv__)
> > +#include <sys/types.h>
> > +#include <machine/atomic.h>
> > +#define	udma_to_device_barrier() fence()
> >  #else
> >  #error No architecture specific memory barrier defines found!
> >  #endif
> 
> Thanks for looking into this.  Attached patch is slightly modified.
> RISC-V is using __riscv and there are few more atomic macros need to be
> defined.
Well, the arch(7) manpage documents __riscv__.   Compilers typically
provide both __XXX__ and __XXX, while FreeBSD traditionally uses
the __XXX__ form.

With that change, I think that your patch should go in regardless of
the second issue below.

> 
> However this seems not enough, there are some c++ errors which may take
> longer to fix:
> 
> In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:43:0,
>                  from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>   atomic_store(&lock->cnt, 0);
>   ^
> In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:0:
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>   if (atomic_fetch_add(&lock->cnt, 1) > 0)
>   ^~
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
> /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>   if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>   ^~
> *** [acm.o] Error code 1
> 
> make[6]: stopped in /usr/home/lwhsu/freebsd-src/lib/ofed/librdmacm
I will look at this later, but it seems that linuxkpi is not ported.
I will disable OFED on RISC-V.

> 
> 
> BTW, stable/11 should be fine to cross-build riscv64, this job uses
> 11.2-RELEASE and riscv64-xtoolchain-gcc package, with
> CROSS_TOOLCHAIN=riscv64-gcc defined.
> 
> 
> Best,
> Li-Wen
> 
> -- 
> Li-Wen Hsu <lwhsu at FreeBSD.org>
> https://lwhsu.org

> Index: contrib/ofed/include/udma_barrier.h
> ===================================================================
> --- contrib/ofed/include/udma_barrier.h	(revision 336593)
> +++ contrib/ofed/include/udma_barrier.h	(working copy)
> @@ -104,6 +104,10 @@
>  #include <sys/types.h>
>  #include <machine/atomic.h>
>  #define udma_to_device_barrier() dmb()
> +#elif defined(__riscv)
> +#include <sys/types.h>
> +#include <machine/atomic.h>
> +#define udma_to_device_barrier() fence()
>  #else
>  #error No architecture specific memory barrier defines found!
>  #endif
> @@ -140,6 +144,8 @@
>  #define udma_from_device_barrier() mips_sync()
>  #elif defined(__arm__)
>  #define udma_from_device_barrier() dmb()
> +#elif defined(__riscv)
> +#define udma_from_device_barrier() fence()
>  #else
>  #error No architecture specific memory barrier defines found!
>  #endif
> @@ -208,6 +214,8 @@
>  #define mmio_flush_writes() mips_sync()
>  #elif defined(__arm__)
>  #define mmio_flush_writes() dmb()
> +#elif defined(__riscv)
> +#define mmio_flush_writes() fence()
>  #else
>  #error No architecture specific memory barrier defines found!
>  #endif


From ian at freebsd.org  Sun Jul 22 16:34:23 2018
From: ian at freebsd.org (Ian Lepore)
Date: Sun, 22 Jul 2018 10:34:12 -0600
Subject: ntpd as ntpd user question
In-Reply-To: <20180721220925.GA40238@www.zefox.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
Message-ID: <1532277252.1344.105.camel@freebsd.org>

On Sat, 2018-07-21 at 15:09 -0700, bob prohaska wrote:
> On Sat, Jul 21, 2018 at 12:14:10PM -0600, Ian Lepore wrote:
> > 
> > 
> > I can't see any way that installkernel would lead to the complaint
> > about the ntpd user not existing; that check is tied to the
> > installworld target.
> > 
> My mistake. I was sleepy and in a hurry. The error message was in
> installworld
> and my attempt to adduser ntpd concluded with an error:
> Locked?????: yes
> OK? (yes/no): yes
> pw: Bad id 'ntpd': invalid
> adduser: ERROR: There was an error adding user (ntpd).
> On reboot the old ntpd set the clock and I thought all was well.
> 
> The failure is a little surprising, is ntpd a reserved name?
> 
> The machine is re-running buildworld/installworld from a clean start,
> so presumably it'll halt over the same error again. When that
> happens,?
> what's the simplest way to recover? Mergemaster is a big hammer,
> something
> less comprehensive might suffice, even manual editing of files.??
> 
> There's minimal customization on the machine, basically /etc/fstab,?
> /etc/rc.conf and /etc/passwd. Nothing else of real value, so if I
> kill?
> it in the attempt it won't be a disaster.
> 
> 
> Thanks for waking me to my blunder...
> 
> bob prohaska
> ?

The important changes that mergemaster would handle are:

? - add ntpd user, id 123
? - add ntpd group, id 123
? - set ntpd_flags="" in /etc/defaults/rc.conf
? - install the new /etc/rc.d/ntpd

You can add the user by doing vipw and pasting the ntpd line from
/usr/src/etc/master.passwd, IMO easier than doing adduser and answering
all the questions.

-- Ian

From lwhsu at freebsd.org  Sun Jul 22 17:16:08 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Sun, 22 Jul 2018 18:16:02 +0100
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180722154505.GE65334@kib.kiev.ua>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
 <20180722154505.GE65334@kib.kiev.ua>
Message-ID: <20180722171601.GA25771@x1c.lwhsu.org>

On Sun, Jul 22, 2018 at 18:45:05 +0300, Konstantin Belousov wrote:
> On Sun, Jul 22, 2018 at 01:01:16AM +0000, Li-Wen Hsu wrote:
> > On Sun, Jul 22, 2018 at 02:18:32 +0300, Konstantin Belousov wrote:
> > > On Sat, Jul 21, 2018 at 02:16:17AM +0000, jenkins-admin at FreeBSD.org wrote:
> > > > --- lib/ofed/libmlx5__L ---
> > > > In file included from /workspace/src/contrib/ofed/libmlx5/mlx5.h:44:0,
> > > >                  from /workspace/src/contrib/ofed/libmlx5/buf.c:42:
> > > > /workspace/obj/workspace/src/riscv.riscv64/tmp/usr/include/infiniband/udma_barrier.h:108:2: error: #error No architecture specific memory barrier defines found!
> > > >  #error No architecture specific memory barrier defines found!
> > > >   ^~~~~
> > > 
> > > The patch below should be enough to fix the build,  modulo the syntax
> > > errors which I cannot check.  The reason is that it seems riscv is not
> > > cross-buildable from stable/11 host:
> > > --- includes_subdir_include/rpcsvc ---
> > > RPCGEN_CPP=cpp\ -target\ riscv64-unknown-freebsd12.0\ --sysroot=/usr/home/konstantinb/build/bsd/DEV/obj/usr/home/konstantinb/build/bsd/DEV/src/riscv.riscv64/tmp\ -B/usr/local rpcgen -C -h -DWANT_NFS3 /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc/klm_prot.x -o klm_prot.h
> > > --- key_prot.h ---
> > > error: unknown target triple 'riscv64-unknown-freebsd12.0', please use -triple or -arch
> > > *** [key_prot.h] Error code 1
> > > 
> > > make[4]: stopped in /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc
> > > 
> > > So if somebody who care about riscv and can build the world could
> > > confirm the fix, I will commit it.
> > > 
> > > diff --git a/contrib/ofed/include/udma_barrier.h b/contrib/ofed/include/udma_barrier.h
> > > index 71d264f8dce..6709d4433a7 100644
> > > --- a/contrib/ofed/include/udma_barrier.h
> > > +++ b/contrib/ofed/include/udma_barrier.h
> > > @@ -104,6 +104,10 @@
> > >  #include <sys/types.h>
> > >  #include <machine/atomic.h>
> > >  #define udma_to_device_barrier() dmb()
> > > +#elif defined(__riscv__)
> > > +#include <sys/types.h>
> > > +#include <machine/atomic.h>
> > > +#define	udma_to_device_barrier() fence()
> > >  #else
> > >  #error No architecture specific memory barrier defines found!
> > >  #endif
> > 
> > Thanks for looking into this.  Attached patch is slightly modified.
> > RISC-V is using __riscv and there are few more atomic macros need to be
> > defined.
> Well, the arch(7) manpage documents __riscv__.   Compilers typically
> provide both __XXX__ and __XXX, while FreeBSD traditionally uses
> the __XXX__ form.

Please check r322168, __riscv__ is replaced by __riscv and
__riscv64 is replaced by (__riscv && __riscv_xlen == 64).  Details are
in the commit message.

Alghough I grep'd sys/ and there are some __riscv__ still existing:

sys/vm/vm_unix.c:72:#if !defined(__aarch64__) && !defined(__riscv__)
sys/vm/vm_unix.c:81:#else /* defined(__aarch64__) || defined(__riscv__) */
sys/vm/vm_unix.c:83:#endif /* defined(__aarch64__) || defined(__riscv__) */

I guess those also need changing, as well as arch(7)


> With that change, I think that your patch should go in regardless of
> the second issue below.

Thanks, please commit or approve it.

> > 
> > However this seems not enough, there are some c++ errors which may take
> > longer to fix:
> > 
> > In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:43:0,
> >                  from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
> >   atomic_store(&lock->cnt, 0);
> >   ^
> > In file included from /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/acm.c:42:0:
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
> >   if (atomic_fetch_add(&lock->cnt, 1) > 0)
> >   ^~
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
> > /usr/home/lwhsu/freebsd-src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
> >   if (atomic_fetch_sub(&lock->cnt, 1) > 1)
> >   ^~
> > *** [acm.o] Error code 1
> > 
> > make[6]: stopped in /usr/home/lwhsu/freebsd-src/lib/ofed/librdmacm
> I will look at this later, but it seems that linuxkpi is not ported.
> I will disable OFED on RISC-V.

Thanks, I think this is the right way to go for now.

> > 
> > 
> > BTW, stable/11 should be fine to cross-build riscv64, this job uses
> > 11.2-RELEASE and riscv64-xtoolchain-gcc package, with
> > CROSS_TOOLCHAIN=riscv64-gcc defined.
> > 
> > 
> > Best,
> > Li-Wen
> > 
> > -- 
> > Li-Wen Hsu <lwhsu at FreeBSD.org>
> > https://lwhsu.org
> 
> > Index: contrib/ofed/include/udma_barrier.h
> > ===================================================================
> > --- contrib/ofed/include/udma_barrier.h	(revision 336593)
> > +++ contrib/ofed/include/udma_barrier.h	(working copy)
> > @@ -104,6 +104,10 @@
> >  #include <sys/types.h>
> >  #include <machine/atomic.h>
> >  #define udma_to_device_barrier() dmb()
> > +#elif defined(__riscv)
> > +#include <sys/types.h>
> > +#include <machine/atomic.h>
> > +#define udma_to_device_barrier() fence()
> >  #else
> >  #error No architecture specific memory barrier defines found!
> >  #endif
> > @@ -140,6 +144,8 @@
> >  #define udma_from_device_barrier() mips_sync()
> >  #elif defined(__arm__)
> >  #define udma_from_device_barrier() dmb()
> > +#elif defined(__riscv)
> > +#define udma_from_device_barrier() fence()
> >  #else
> >  #error No architecture specific memory barrier defines found!
> >  #endif
> > @@ -208,6 +214,8 @@
> >  #define mmio_flush_writes() mips_sync()
> >  #elif defined(__arm__)
> >  #define mmio_flush_writes() dmb()
> > +#elif defined(__riscv)
> > +#define mmio_flush_writes() fence()
> >  #else
> >  #error No architecture specific memory barrier defines found!
> >  #endif
> 
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 963 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180722/19301739/attachment.sig>

From sh+freebsd-current at codevoid.de  Sun Jul 22 19:59:10 2018
From: sh+freebsd-current at codevoid.de (Stefan Hagen)
Date: Sun, 22 Jul 2018 21:59:00 +0200
Subject: fatal error: 'immintrin.h' file not found
Message-ID: <20180722195900.GA75436@ptrace.hagen.corp>

Hello,

I think I broke something and I can't figure out what it is. Since a few 
weeks, I'm not able to build current anymore.

make buildkernel, buildworld, toolchain - all abort with the following 
error:

--- lz_encoder.o ---
In file included from /usr/src/contrib/xz/src/liblzma/lz/lz_encoder.c:23:
/usr/src/contrib/xz/src/liblzma/common/memcmplen.h:19:11: fatal error: 'immintrin.h' file not found
#       include <immintrin.h>
                ^~~~~~~~~~~~~
1 error generated.

Find shows me, that immintrin.h can be found in the following locations:

$ find / -name "immintrin.h"
/usr/lib/clang/4.0.0/include/immintrin.h
/usr/lib/clang/3.8.0/include/immintrin.h
/usr/lib/clang/5.0.0/include/immintrin.h
/usr/lib/clang/6.0.0/include/immintrin.h
/usr/lib/clang/5.0.1/include/immintrin.h
/usr/obj/usr/src/amd64.amd64/tmp/usr/lib/clang/6.0.1/include/immintrin.h
/usr/obj/usr/src/tmp/usr/lib/clang/5.0.0/include/immintrin.h
/usr/src/contrib/llvm/tools/clang/lib/Headers/immintrin.h
/usr/local/llvm60/lib/clang/6.0.1/include/immintrin.h
/compat/linux/usr/lib/gcc/x86_64-redhat-linux/4.8.2/include/immintrin.h

I'm usually compiling with meta-mode and ccache. I've turned off both
and still encounter the same error.

How can I figure out what is missing here?

Best Regards,
Stefan

-- 
Stefan Hagen
Mail: sh at codevoid.de | encryption key in header.
gopher://codevoid.de | https://codevoid.de


From dim at FreeBSD.org  Sun Jul 22 20:37:35 2018
From: dim at FreeBSD.org (Dimitry Andric)
Date: Sun, 22 Jul 2018 22:37:20 +0200
Subject: fatal error: 'immintrin.h' file not found
In-Reply-To: <20180722195900.GA75436@ptrace.hagen.corp>
References: <20180722195900.GA75436@ptrace.hagen.corp>
Message-ID: <82B3EB35-676F-42B6-9577-3BAF43F2719F@FreeBSD.org>

On 22 Jul 2018, at 21:59, Stefan Hagen <sh+freebsd-current at codevoid.de> wrote:
> 
> I think I broke something and I can't figure out what it is. Since a few
> weeks, I'm not able to build current anymore.
> 
> make buildkernel, buildworld, toolchain - all abort with the following
> error:
> 
> --- lz_encoder.o ---
> In file included from /usr/src/contrib/xz/src/liblzma/lz/lz_encoder.c:23:
> /usr/src/contrib/xz/src/liblzma/common/memcmplen.h:19:11: fatal error: 'immintrin.h' file not found
> #       include <immintrin.h>
>                ^~~~~~~~~~~~~
> 1 error generated.
> 
> Find shows me, that immintrin.h can be found in the following locations:
> 
> $ find / -name "immintrin.h"
> /usr/lib/clang/4.0.0/include/immintrin.h
> /usr/lib/clang/3.8.0/include/immintrin.h
> /usr/lib/clang/5.0.0/include/immintrin.h
> /usr/lib/clang/6.0.0/include/immintrin.h
> /usr/lib/clang/5.0.1/include/immintrin.h

What does "cc -v" show?  If it is clang 6.0.1, you are missing the 6.0.1
intrinsics headers, located in /usr/lib/clang/6.0.1/include.  As a quick
hack, you can try copying the /usr/lib/clang/6.0.0 headers there, or
attempt to run "make install" in /usr/src/lib/clang/headers.

-Dimitry

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 223 bytes
Desc: Message signed with OpenPGP
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180722/c2150da2/attachment.sig>

From kostikbel at gmail.com  Sun Jul 22 21:27:08 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Mon, 23 Jul 2018 00:26:55 +0300
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180722171601.GA25771@x1c.lwhsu.org>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
 <20180722154505.GE65334@kib.kiev.ua>
 <20180722171601.GA25771@x1c.lwhsu.org>
Message-ID: <20180722212655.GF65334@kib.kiev.ua>

On Sun, Jul 22, 2018 at 06:16:02PM +0100, Li-Wen Hsu wrote:
> On Sun, Jul 22, 2018 at 18:45:05 +0300, Konstantin Belousov wrote:
> > On Sun, Jul 22, 2018 at 01:01:16AM +0000, Li-Wen Hsu wrote:
> > > On Sun, Jul 22, 2018 at 02:18:32 +0300, Konstantin Belousov wrote:
> > > > On Sat, Jul 21, 2018 at 02:16:17AM +0000, jenkins-admin at FreeBSD.org wrote:
> > > > > --- lib/ofed/libmlx5__L ---
> > > > > In file included from /workspace/src/contrib/ofed/libmlx5/mlx5.h:44:0,
> > > > >                  from /workspace/src/contrib/ofed/libmlx5/buf.c:42:
> > > > > /workspace/obj/workspace/src/riscv.riscv64/tmp/usr/include/infiniband/udma_barrier.h:108:2: error: #error No architecture specific memory barrier defines found!
> > > > >  #error No architecture specific memory barrier defines found!
> > > > >   ^~~~~
> > > > 
> > > > The patch below should be enough to fix the build,  modulo the syntax
> > > > errors which I cannot check.  The reason is that it seems riscv is not
> > > > cross-buildable from stable/11 host:
> > > > --- includes_subdir_include/rpcsvc ---
> > > > RPCGEN_CPP=cpp\ -target\ riscv64-unknown-freebsd12.0\ --sysroot=/usr/home/konstantinb/build/bsd/DEV/obj/usr/home/konstantinb/build/bsd/DEV/src/riscv.riscv64/tmp\ -B/usr/local rpcgen -C -h -DWANT_NFS3 /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc/klm_prot.x -o klm_prot.h
> > > > --- key_prot.h ---
> > > > error: unknown target triple 'riscv64-unknown-freebsd12.0', please use -triple or -arch
> > > > *** [key_prot.h] Error code 1
> > > > 
> > > > make[4]: stopped in /usr/home/konstantinb/build/bsd/DEV/src/include/rpcsvc
> > > > 
> > > > So if somebody who care about riscv and can build the world could
> > > > confirm the fix, I will commit it.
> > > > 
> > > > diff --git a/contrib/ofed/include/udma_barrier.h b/contrib/ofed/include/udma_barrier.h
> > > > index 71d264f8dce..6709d4433a7 100644
> > > > --- a/contrib/ofed/include/udma_barrier.h
> > > > +++ b/contrib/ofed/include/udma_barrier.h
> > > > @@ -104,6 +104,10 @@
> > > >  #include <sys/types.h>
> > > >  #include <machine/atomic.h>
> > > >  #define udma_to_device_barrier() dmb()
> > > > +#elif defined(__riscv__)
> > > > +#include <sys/types.h>
> > > > +#include <machine/atomic.h>
> > > > +#define	udma_to_device_barrier() fence()
> > > >  #else
> > > >  #error No architecture specific memory barrier defines found!
> > > >  #endif
> > > 
> > > Thanks for looking into this.  Attached patch is slightly modified.
> > > RISC-V is using __riscv and there are few more atomic macros need to be
> > > defined.
> > Well, the arch(7) manpage documents __riscv__.   Compilers typically
> > provide both __XXX__ and __XXX, while FreeBSD traditionally uses
> > the __XXX__ form.
> 
> Please check r322168, __riscv__ is replaced by __riscv and
> __riscv64 is replaced by (__riscv && __riscv_xlen == 64).  Details are
> in the commit message.
> 
> Alghough I grep'd sys/ and there are some __riscv__ still existing:
> 
> sys/vm/vm_unix.c:72:#if !defined(__aarch64__) && !defined(__riscv__)
> sys/vm/vm_unix.c:81:#else /* defined(__aarch64__) || defined(__riscv__) */
> sys/vm/vm_unix.c:83:#endif /* defined(__aarch64__) || defined(__riscv__) */
> 
> I guess those also need changing, as well as arch(7)
> 
> 
> > With that change, I think that your patch should go in regardless of
> > the second issue below.
> 
> Thanks, please commit or approve it.
Why do you need an approval ?  I already said that your patch looks fine.

From sh+freebsd-current at codevoid.de  Sun Jul 22 21:48:54 2018
From: sh+freebsd-current at codevoid.de (Stefan Hagen)
Date: Sun, 22 Jul 2018 23:48:52 +0200
Subject: fatal error: 'immintrin.h' file not found
In-Reply-To: <82B3EB35-676F-42B6-9577-3BAF43F2719F@FreeBSD.org>
References: <20180722195900.GA75436@ptrace.hagen.corp>
 <82B3EB35-676F-42B6-9577-3BAF43F2719F@FreeBSD.org>
Message-ID: <20180722214852.GA76585@ptrace.hagen.corp>

Hi Dimitry,

Dimitry Andric wrote:
> Stefan Hagen wrote:
>> --- lz_encoder.o ---
>> In file included from /usr/src/contrib/xz/src/liblzma/lz/lz_encoder.c:23:
>> /usr/src/contrib/xz/src/liblzma/common/memcmplen.h:19:11: fatal error: 'immintrin.h' file not found
>> #       include <immintrin.h>
>>              ^~~~~~~~~~~~~
>> 1 error generated.
>>
>> Find shows me, that immintrin.h can be found in the following locations:
>>
>> $ find / -name "immintrin.h"
>> /usr/lib/clang/4.0.0/include/immintrin.h
>> /usr/lib/clang/3.8.0/include/immintrin.h
>> /usr/lib/clang/5.0.0/include/immintrin.h
>> /usr/lib/clang/6.0.0/include/immintrin.h
>> /usr/lib/clang/5.0.1/include/immintrin.h
>
> What does "cc -v" show?  If it is clang 6.0.1, you are missing the 6.0.1
> intrinsics headers, located in /usr/lib/clang/6.0.1/include.  As a quick
> hack, you can try copying the /usr/lib/clang/6.0.0 headers there, or
> attempt to run "make install" in /usr/src/lib/clang/headers.

$ cc -v
FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based on LLVM 6.0.1)

The following fixed it for me:

mkdir -p /usr/lib/clang/6.0.1/include/
cd /usr/src/lib/clang/headers && make install

Shouldn't these headers be included in the llvm60-6.0.1_1 package?
Or are they part of the base system?

I just wonder why I never had to install them before.

Kind Regards && thank you,
Stefan

-- 
Stefan Hagen
Mail: sh at codevoid.de | encryption key in header.
gopher://codevoid.de | https://codevoid.de

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 915 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180722/a83205cd/attachment.sig>

From kostikbel at gmail.com  Sun Jul 22 22:04:22 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Mon, 23 Jul 2018 01:04:13 +0300
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <CAKBkRUzRUdNLP6oWZc_DaySX-w7sPFv_qhBk_cWkmR-DtGun4A@mail.gmail.com>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
 <20180722154505.GE65334@kib.kiev.ua>
 <20180722171601.GA25771@x1c.lwhsu.org>
 <20180722212655.GF65334@kib.kiev.ua>
 <CAKBkRUzRUdNLP6oWZc_DaySX-w7sPFv_qhBk_cWkmR-DtGun4A@mail.gmail.com>
Message-ID: <20180722220413.GG65334@kib.kiev.ua>

On Sun, Jul 22, 2018 at 10:39:08PM +0100, Li-Wen Hsu wrote:
> On Sun, Jul 22, 2018 at 10:27 PM Konstantin Belousov
> <kostikbel at gmail.com> wrote:
> >
> > On Sun, Jul 22, 2018 at 06:16:02PM +0100, Li-Wen Hsu wrote:
> > > On Sun, Jul 22, 2018 at 18:45:05 +0300, Konstantin Belousov wrote:
> > > > On Sun, Jul 22, 2018 at 01:01:16AM +0000, Li-Wen Hsu wrote:
> > > > Well, the arch(7) manpage documents __riscv__.   Compilers typically
> > > > provide both __XXX__ and __XXX, while FreeBSD traditionally uses
> > > > the __XXX__ form.
> > >
> > > Please check r322168, __riscv__ is replaced by __riscv and
> > > __riscv64 is replaced by (__riscv && __riscv_xlen == 64).  Details are
> > > in the commit message.
> > >
> > > Alghough I grep'd sys/ and there are some __riscv__ still existing:
> > >
> > > sys/vm/vm_unix.c:72:#if !defined(__aarch64__) && !defined(__riscv__)
> > > sys/vm/vm_unix.c:81:#else /* defined(__aarch64__) || defined(__riscv__) */
> > > sys/vm/vm_unix.c:83:#endif /* defined(__aarch64__) || defined(__riscv__) */
> > >
> > > I guess those also need changing, as well as arch(7)
> > >
> > >
> > > > With that change, I think that your patch should go in regardless of
> > > > the second issue below.
> > >
> > > Thanks, please commit or approve it.
> > Why do you need an approval ?  I already said that your patch looks fine.
> 
> Oh, I did not realize that means a green light.  Also I am not sure
> about your opinion of __riscv and __riscv__.  Does my original patch
> look OK to you?

The change to __riscv looks strange.  At least arch(7) should be updated,
but this also contradicts the usual syntax.

Anyway, I do not have an opinion there, perhaps use __riscv since this
apparently is what Ruslan wants to use.

From lwhsu at freebsd.org  Sun Jul 22 22:33:39 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Sun, 22 Jul 2018 22:39:08 +0100
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180722212655.GF65334@kib.kiev.ua>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
 <20180722154505.GE65334@kib.kiev.ua> <20180722171601.GA25771@x1c.lwhsu.org>
 <20180722212655.GF65334@kib.kiev.ua>
Message-ID: <CAKBkRUzRUdNLP6oWZc_DaySX-w7sPFv_qhBk_cWkmR-DtGun4A@mail.gmail.com>

On Sun, Jul 22, 2018 at 10:27 PM Konstantin Belousov
<kostikbel at gmail.com> wrote:
>
> On Sun, Jul 22, 2018 at 06:16:02PM +0100, Li-Wen Hsu wrote:
> > On Sun, Jul 22, 2018 at 18:45:05 +0300, Konstantin Belousov wrote:
> > > On Sun, Jul 22, 2018 at 01:01:16AM +0000, Li-Wen Hsu wrote:
> > > Well, the arch(7) manpage documents __riscv__.   Compilers typically
> > > provide both __XXX__ and __XXX, while FreeBSD traditionally uses
> > > the __XXX__ form.
> >
> > Please check r322168, __riscv__ is replaced by __riscv and
> > __riscv64 is replaced by (__riscv && __riscv_xlen == 64).  Details are
> > in the commit message.
> >
> > Alghough I grep'd sys/ and there are some __riscv__ still existing:
> >
> > sys/vm/vm_unix.c:72:#if !defined(__aarch64__) && !defined(__riscv__)
> > sys/vm/vm_unix.c:81:#else /* defined(__aarch64__) || defined(__riscv__) */
> > sys/vm/vm_unix.c:83:#endif /* defined(__aarch64__) || defined(__riscv__) */
> >
> > I guess those also need changing, as well as arch(7)
> >
> >
> > > With that change, I think that your patch should go in regardless of
> > > the second issue below.
> >
> > Thanks, please commit or approve it.
> Why do you need an approval ?  I already said that your patch looks fine.

Oh, I did not realize that means a green light.  Also I am not sure
about your opinion of __riscv and __riscv__.  Does my original patch
look OK to you?

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From lwhsu at freebsd.org  Sun Jul 22 23:08:45 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Mon, 23 Jul 2018 00:01:35 +0100
Subject: FreeBSD-head-riscv64-build - Build #9623 (r336573) - Failure
In-Reply-To: <20180722220413.GG65334@kib.kiev.ua>
References: <941706773.1.1532139392496.JavaMail.jenkins@jenkins.ci.freebsd.org>
 <20180721231832.GC65334@kib.kiev.ua>
 <20180722010116.GA13419@freefall.freebsd.org>
 <20180722154505.GE65334@kib.kiev.ua> <20180722171601.GA25771@x1c.lwhsu.org>
 <20180722212655.GF65334@kib.kiev.ua>
 <CAKBkRUzRUdNLP6oWZc_DaySX-w7sPFv_qhBk_cWkmR-DtGun4A@mail.gmail.com>
 <20180722220413.GG65334@kib.kiev.ua>
Message-ID: <CAKBkRUzMEBk2OBh0r44W2Yj7ZwBfGsTViKgAwLmfSgXjy5s7vw@mail.gmail.com>

On Sun, Jul 22, 2018 at 11:04 PM Konstantin Belousov
<kostikbel at gmail.com> wrote:
> The change to __riscv looks strange.  At least arch(7) should be updated,
> but this also contradicts the usual syntax.

Just found that arch(7) was also updated in r322168.

> Anyway, I do not have an opinion there, perhaps use __riscv since this
> apparently is what Ruslan wants to use.

I committed the original patch as r336620.

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From fbsd at www.zefox.net  Mon Jul 23 04:55:46 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Sun, 22 Jul 2018 21:55:52 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
Message-ID: <20180723045552.GA44941@www.zefox.net>

On Sun, Jul 22, 2018 at 01:49:41AM +0200, Herbert J. Skuhra wrote:
> On Sat, Jul 21, 2018 at 03:09:26PM -0700, bob prohaska wrote:

> > The failure is a little surprising, is ntpd a reserved name?
> 
> Why? You obviously entered the string "ntpd" instead of an integer when
> asked for the uid!?
> 

Sigh...you're right. Must have been sleepier than I thought.

> > The machine is re-running buildworld/installworld from a clean start,
> > so presumably it'll halt over the same error again. When that happens, 
> > what's the simplest way to recover? Mergemaster is a big hammer, something
> > less comprehensive might suffice, even manual editing of files.
> 
> In this case 'mergemaster -p' is enough.
> 

An example or two on the use of mergemaster might be a considerable help. There's something
very basic that I don't understand.

What is the correct response to the prompts for this simple case? The output displayed
is said to be differences, so the "temporary" file's nature isn't self-evident. It looks
as if the most obvious option is m, followed by eb, but that leaves me editing by hand, 
which is what I thought mergemaster was supposed to avoid. 


Thanks for reading, and apologies for being dense.

bob prohaska



From dim at FreeBSD.org  Mon Jul 23 05:47:49 2018
From: dim at FreeBSD.org (Dimitry Andric)
Date: Mon, 23 Jul 2018 07:47:36 +0200
Subject: fatal error: 'immintrin.h' file not found
In-Reply-To: <20180722214852.GA76585@ptrace.hagen.corp>
References: <20180722195900.GA75436@ptrace.hagen.corp>
 <82B3EB35-676F-42B6-9577-3BAF43F2719F@FreeBSD.org>
 <20180722214852.GA76585@ptrace.hagen.corp>
Message-ID: <3D7D1A21-5D35-4246-83E4-1D64FBB8716D@FreeBSD.org>

On 22 Jul 2018, at 23:48, Stefan Hagen <sh+freebsd-current at codevoid.de> wrote
> 
> Dimitry Andric wrote:
>> Stefan Hagen wrote:
>>> --- lz_encoder.o ---
>>> In file included from /usr/src/contrib/xz/src/liblzma/lz/lz_encoder.c:23:
>>> /usr/src/contrib/xz/src/liblzma/common/memcmplen.h:19:11: fatal error: 'immintrin.h' file not found
>>> #       include <immintrin.h>
>>>             ^~~~~~~~~~~~~
>>> 1 error generated.
>>> 
>>> Find shows me, that immintrin.h can be found in the following locations:
>>> 
>>> $ find / -name "immintrin.h"
>>> /usr/lib/clang/4.0.0/include/immintrin.h
>>> /usr/lib/clang/3.8.0/include/immintrin.h
>>> /usr/lib/clang/5.0.0/include/immintrin.h
>>> /usr/lib/clang/6.0.0/include/immintrin.h
>>> /usr/lib/clang/5.0.1/include/immintrin.h
>> 
>> What does "cc -v" show?  If it is clang 6.0.1, you are missing the 6.0.1
>> intrinsics headers, located in /usr/lib/clang/6.0.1/include.  As a quick
>> hack, you can try copying the /usr/lib/clang/6.0.0 headers there, or
>> attempt to run "make install" in /usr/src/lib/clang/headers.
> 
> $ cc -v
> FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) (based on LLVM 6.0.1)
> 
> The following fixed it for me:
> 
> mkdir -p /usr/lib/clang/6.0.1/include/
> cd /usr/src/lib/clang/headers && make install
> 
> Shouldn't these headers be included in the llvm60-6.0.1_1 package?
> Or are they part of the base system?

They are part of the base system, but the port will install them in a
similar location, under /usr/local.


> I just wonder why I never had to install them before.

That is the real mystery: during a normal installworld, these headers
get installed.  Maybe you ran an installworld using WITHOUT_CLANG, and
then attempted to build a new one?

Btw, you still have the /usr/lib/clang/3.8.0 through 6.0.0 directories,
so maybe it is time to run "make delete-old" at some point. :)

-Dimitry

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 223 bytes
Desc: Message signed with OpenPGP
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180723/98d405bb/attachment.sig>

From ohartmann at walstatt.org  Mon Jul 23 07:33:00 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Mon, 23 Jul 2018 09:27:38 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
Message-ID: <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>

On Fri, 13 Jul 2018 18:44:23 +0300
Toomas Soome <tsoome at me.com> wrote:

> > On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org> wrote:
> > 
> > -----BEGIN PGP SIGNED MESSAGE-----
> > Hash: SHA512
> > 
> > Am Fri, 13 Jul 2018 14:26:51 +0300
> > Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> schrieb:
> >   
> >>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> The problem is some kind of weird. I face UEFI boot problems on GPT drives
> >>> where the first partition begins at block 40 of the hdd/ssd.
> >>> 
> >>> I have two host in private use based on an
> >>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>> LGA1155). Both boards are equipted with the lates official available AMI
> >>> firmware revision, dating to 2013. This is for the Z77-Pro4-M revision
> >>> 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8 (2013/7/17). For both
> >>> boards a BETA revision for the Spectre/Meltdown mitigation is available,
> >>> but I didn't test that. But please read.
> >>> 
> >>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>> 05/25/2018 (or 20180525).
> >>> 
> >>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
> >>> using UEFI-only boot method on a GPT partitioned device fails. The ASRock
> >>> boards jump immediately into the firmware, the Fujitsu offers some kind
> >>> of CPU/Memory/HDD test facility.
> >>> 
> >>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
> >>> implied, the MBR partitioned FreeBSD installation USB flash device does
> >>> boot in UEFI! I guess I can assume this when the well known clumsy 80x25
> >>> char console suddenly gets bright and shiny with a much higher resoltion
> >>> as long the GPU supports EFI GOP. Looking with gpart at the USB flash
> >>> drives reveals that the EFI partition starts at block 1 of the device and
> >>> the device has a MBR layout. I haven't found a way to force the GPT
> >>> scheme, when initialised via gpart, to let the partitions start at block
> >>> 1. This might be a naiv thinking, so please be patient with me.
> >>> 
> >>> I do not know whether this is a well-known issue. On the ASRock boards, I
> >>> tried years ago some LinuxRed Hat and Suse with UEFI and that worked -
> >>> FreeBSD not. I gave up on that that time. Now, having the very same
> >>> issues with a new Fujitsu system, leaves me with the impression that
> >>> FreeBSD's UEFI implementation might have problems I'm not aware of.
> >>> 
> >>> Can someone shed some light onto this? 
> >>>   
> >> 
> >> The first thing to check is if the secure boot is disabled. We do not
> >> support secure boot at all at this time.  
> > 
> > Secure boot is in every scenario disabled!
> >   
> >> 
> >> If you have efi or bios version running - you can check from either
> >> console variable value (it can have efi or vidconsole or comconsole) or
> >> better yet, see if efi-version is set (show efi-version) - if efi-version
> >> is not set, it is BIOS loader running. Another indirect way is to see
> >> lsdev -v, with device paths present, it is uefi:)  
> > 
> > What are you talking about?
> > What is the point of entry - running system, loader?
> > 
> > sysct machdep.bootmethod: BIOS
> > 
> > This makes me quite sure that the system has booted via BIOS - as I'm sure
> > since I've checked that many times. UEFI doesn't work on those systems with
> > FreeBSD. I'm not sure antmore, but I tried also Windows 7 on those
> > mainboards booting via UEFI - and I might recall that they failed also. I
> > also recall that there were issues with earlier UEFI versions regarding
> > booting only Windows 8/8.1 - and nothing else, but the fact that Linux
> > worked confuses me a bit.
> > 
> > If this ASRock crap (never ever again this brand!) doesn't work at all -
> > who cares, I intend to purchase new server grade hardware. But the more
> > puzzling issue is with the Fujitsu, which I consider serious and from the
> > behaviour the Fujitsu failure looks exactly like the ASRock - Windows 7
> > works, RedHat 7.5 works (I assume I can trust the Firmware settings when I
> > disable CSM support, that the Firmware will only EFI/UEFI capable loader?
> > Or is there a ghosty override somwhere to be expected?). Also on ASRock
> > disabling CSM should ensure not booting a dual-bootstrap-capable system.
> > This said, on the recent Fujitsu, it seems to boil down to a FreeBSD
> > UEFI-firmware interaction problem, while the ASRock is still under
> > suspicion to be broken by design. 
> >> 
> >> GPT partitions can never start from disk absolute sector 1; this is
> >> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >> table and then sectors 2-33 have GPT partition table entries, so the first
> >> possible data sector is 34 (absolute 34). Thats assuming 512B sectors.
> >> For details see UEFI 2.7 Chapter 5.3.1 page 131.  
> > 
> > Thanks for the explanation. That implies the installer did right, gpart did
> > also right and therefore there must be an issue with the stuff located
> > within the EFI partition? 
> 
> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS loader
> at all or not - that is, if the BIOS bootstrap is actually caring to read the
> MBR code and start it, since once the MBR code is started, it is all about
> our code.

I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you mean
that specific portion of the UEFI firmware, which looks for the proper UEFI
partition?


The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
refuse booting UEFI, even if properly setup (in terms of what FreeBSD provides
on recent CURRENT) is applied and CSM is switched off in the firmware. Again:
GPT partition scheme.

The system boots properly if a second partition of type "freebsd-boot" is
applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
-p /boot/gptboot -i 2 ada0" (ada0 is the device). 
> 
> btw, you can try to validate the installed boot blocks by using recent enough
> loader (usb or iso) and then you can use from OK prompt:

lsdev provides me with the follwoing informations (CSM enabled):

OK lsdev
disk devices:
	disk0:		BIOS DRIVE C ...

		disk0p1:	EFI
		disk0p2:	FreeBSD BOOT
		disk0p3:	FreeBSD SWAP
		disk0p4:	FreeBSD ZFS
zfs devices:
	zfs:zroot

OK chain disk0
open failed     (so for disk0p{1-4}.

OK chain zroot
failed to read disk (just for completeness)
> 
> OK chain diskX:
> 
> (replace X by correct disk number from lsdev) to read and start the MBR code.
> If that is working, then its really about BIOS refusing to read the MBR and
> execute it.

See above.

I do not get that far to the loader if CSM is disabled (pure UEFI). The same on
the ASROCK boards. 

The ASRock systems boot off of an SSD with GPT partition scheme and UFS
filesystem only (running recent 12-CURRENT), while the Esprimo box is also an
SSD, but GPT/ZFS (11.2-RELENG).

I do not doubt the principle here, since a bunch of Fujitsu servers around here
boot off 12-CURRENT and 11.2-RELENG from GPT/UFS SSDs as well as GPT/ZFS SSDs.
Not problem so far.

I checked out for the most recent Firmware for the ASRock boards and applied
the may, 2018 Spectre/Meltdown mitigation images found in the BETA section. No
changes for boot at all.

Can I do something to help?

> 
> rgds,
> toomas
> 

Kind regards,
oh

From tsoome at me.com  Mon Jul 23 07:56:27 2018
From: tsoome at me.com (Toomas Soome)
Date: Mon, 23 Jul 2018 10:56:04 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <80523BE6-C035-482D-B134-23812183DE83@me.com>



> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Fri, 13 Jul 2018 18:44:23 +0300
> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> 
>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org <mailto:o.hartmann at walstatt.org>> wrote:
>>> 
>>> -----BEGIN PGP SIGNED MESSAGE-----
>>> Hash: SHA512
>>> 
>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:
>>> 
>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>> 
>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT drives
>>>>> where the first partition begins at block 40 of the hdd/ssd.
>>>>> 
>>>>> I have two host in private use based on an
>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
>>>>> LGA1155). Both boards are equipted with the lates official available AMI
>>>>> firmware revision, dating to 2013. This is for the Z77-Pro4-M revision
>>>>> 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8 (2013/7/17). For both
>>>>> boards a BETA revision for the Spectre/Meltdown mitigation is available,
>>>>> but I didn't test that. But please read.
>>>>> 
>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
>>>>> 05/25/2018 (or 20180525).
>>>>> 
>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
>>>>> using UEFI-only boot method on a GPT partitioned device fails. The ASRock
>>>>> boards jump immediately into the firmware, the Fujitsu offers some kind
>>>>> of CPU/Memory/HDD test facility.
>>>>> 
>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
>>>>> implied, the MBR partitioned FreeBSD installation USB flash device does
>>>>> boot in UEFI! I guess I can assume this when the well known clumsy 80x25
>>>>> char console suddenly gets bright and shiny with a much higher resoltion
>>>>> as long the GPU supports EFI GOP. Looking with gpart at the USB flash
>>>>> drives reveals that the EFI partition starts at block 1 of the device and
>>>>> the device has a MBR layout. I haven't found a way to force the GPT
>>>>> scheme, when initialised via gpart, to let the partitions start at block
>>>>> 1. This might be a naiv thinking, so please be patient with me.
>>>>> 
>>>>> I do not know whether this is a well-known issue. On the ASRock boards, I
>>>>> tried years ago some LinuxRed Hat and Suse with UEFI and that worked -
>>>>> FreeBSD not. I gave up on that that time. Now, having the very same
>>>>> issues with a new Fujitsu system, leaves me with the impression that
>>>>> FreeBSD's UEFI implementation might have problems I'm not aware of.
>>>>> 
>>>>> Can someone shed some light onto this? 
>>>>> 
>>>> 
>>>> The first thing to check is if the secure boot is disabled. We do not
>>>> support secure boot at all at this time.  
>>> 
>>> Secure boot is in every scenario disabled!
>>> 
>>>> 
>>>> If you have efi or bios version running - you can check from either
>>>> console variable value (it can have efi or vidconsole or comconsole) or
>>>> better yet, see if efi-version is set (show efi-version) - if efi-version
>>>> is not set, it is BIOS loader running. Another indirect way is to see
>>>> lsdev -v, with device paths present, it is uefi:)  
>>> 
>>> What are you talking about?
>>> What is the point of entry - running system, loader?
>>> 
>>> sysct machdep.bootmethod: BIOS
>>> 
>>> This makes me quite sure that the system has booted via BIOS - as I'm sure
>>> since I've checked that many times. UEFI doesn't work on those systems with
>>> FreeBSD. I'm not sure antmore, but I tried also Windows 7 on those
>>> mainboards booting via UEFI - and I might recall that they failed also. I
>>> also recall that there were issues with earlier UEFI versions regarding
>>> booting only Windows 8/8.1 - and nothing else, but the fact that Linux
>>> worked confuses me a bit.
>>> 
>>> If this ASRock crap (never ever again this brand!) doesn't work at all -
>>> who cares, I intend to purchase new server grade hardware. But the more
>>> puzzling issue is with the Fujitsu, which I consider serious and from the
>>> behaviour the Fujitsu failure looks exactly like the ASRock - Windows 7
>>> works, RedHat 7.5 works (I assume I can trust the Firmware settings when I
>>> disable CSM support, that the Firmware will only EFI/UEFI capable loader?
>>> Or is there a ghosty override somwhere to be expected?). Also on ASRock
>>> disabling CSM should ensure not booting a dual-bootstrap-capable system.
>>> This said, on the recent Fujitsu, it seems to boil down to a FreeBSD
>>> UEFI-firmware interaction problem, while the ASRock is still under
>>> suspicion to be broken by design. 
>>>> 
>>>> GPT partitions can never start from disk absolute sector 1; this is
>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
>>>> table and then sectors 2-33 have GPT partition table entries, so the first
>>>> possible data sector is 34 (absolute 34). Thats assuming 512B sectors.
>>>> For details see UEFI 2.7 Chapter 5.3.1 page 131.  
>>> 
>>> Thanks for the explanation. That implies the installer did right, gpart did
>>> also right and therefore there must be an issue with the stuff located
>>> within the EFI partition? 
>> 
>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS loader
>> at all or not - that is, if the BIOS bootstrap is actually caring to read the
>> MBR code and start it, since once the MBR code is started, it is all about
>> our code.
> 
> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you mean
> that specific portion of the UEFI firmware, which looks for the proper UEFI
> partition?
> 

BIOS as either native or CSM. Note that from boot code point of view the CSM boot *is* BIOS boot, we have no access to UEFI features.

> 
> The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
> refuse booting UEFI, even if properly setup (in terms of what FreeBSD provides
> on recent CURRENT) is applied and CSM is switched off in the firmware. Again:
> GPT partition scheme.
> 
> The system boots properly if a second partition of type "freebsd-boot" is
> applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
> -p /boot/gptboot -i 2 ada0" (ada0 is the device). 
>> 
>> btw, you can try to validate the installed boot blocks by using recent enough
>> loader (usb or iso) and then you can use from OK prompt:
> 
> lsdev provides me with the follwoing informations (CSM enabled):
> 
> OK lsdev
> disk devices:
> 	disk0:		BIOS DRIVE C ...
> 
> 		disk0p1:	EFI
> 		disk0p2:	FreeBSD BOOT
> 		disk0p3:	FreeBSD SWAP
> 		disk0p4:	FreeBSD ZFS
> zfs devices:
> 	zfs:zroot
> 
> OK chain disk0
> open failed     (so for disk0p{1-4}.
> 
> OK chain zroot
> failed to read disk (just for completeness)


chain command does use only device name (such as disk0: or disk0p2: ), but not zfs pool as device.  I just found I haven?t ported the code to read the file.

the point for chain command test is to see if the normal read and execute would work, so in your case please try:

chain disk0:

to read pmbr (512B) and execute it. The expected outcome would be that pmbr boot code would browse the GPT, read stage1 from disk0p2: and execute it; stage1 would detect FreeBSD ZFS from disk0p4: and load and execute /boot/loader. If that will happen, it means the boot code in our stages is just fine, but the bios (CSM) does not load pmbr?.  if thats true, it would mean that you either need to use UEFI boot or need to have some hack to fool the BIOS or just not use GPT on that machine with CSM.

rgds,
toomas

>> 
>> OK chain diskX:
>> 
>> (replace X by correct disk number from lsdev) to read and start the MBR code.
>> If that is working, then its really about BIOS refusing to read the MBR and
>> execute it.
> 
> See above.
> 
> I do not get that far to the loader if CSM is disabled (pure UEFI). The same on
> the ASROCK boards. 
> 
> The ASRock systems boot off of an SSD with GPT partition scheme and UFS
> filesystem only (running recent 12-CURRENT), while the Esprimo box is also an
> SSD, but GPT/ZFS (11.2-RELENG).
> 
> I do not doubt the principle here, since a bunch of Fujitsu servers around here
> boot off 12-CURRENT and 11.2-RELENG from GPT/UFS SSDs as well as GPT/ZFS SSDs.
> Not problem so far.
> 
> I checked out for the most recent Firmware for the ASRock boards and applied
> the may, 2018 Spectre/Meltdown mitigation images found in the BETA section. No
> changes for boot at all.
> 
> Can I do something to help?
> 
>> 
>> rgds,
>> toomas
>> 
> 
> Kind regards,
> oh
> _______________________________________________
> freebsd-current at freebsd.org <mailto:freebsd-current at freebsd.org> mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current <https://lists.freebsd.org/mailman/listinfo/freebsd-current>
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org <mailto:freebsd-current-unsubscribe at freebsd.org>"


From zeising+freebsd at daemonic.se  Mon Jul 23 10:57:45 2018
From: zeising+freebsd at daemonic.se (Niclas Zeising)
Date: Mon, 23 Jul 2018 12:57:28 +0200
Subject: ntpd as ntpd user question
In-Reply-To: <20180721185654.239b4c8b@gumby.homeunix.com>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721185654.239b4c8b@gumby.homeunix.com>
Message-ID: <de060c0d-5b7f-5893-5c29-a251be0b0415@daemonic.se>

On 07/21/18 19:56, RW wrote:
> On Sat, 21 Jul 2018 11:14:45 -0600
> Ian Lepore wrote:
> 
> 
>> There's a "pre-world" stage of mergemaster (-Fp option I think) which
>> isn't needed often, but one of the times it is needed is apparently
>> when new user ids are added.
> 
> I wish mergemaster had an option to just add new users and groups,
> rather than merging the files.

etcupdate is usually pretty good at automatically merge updates to files 
without user interaction, even when the files are locally edited as 
well.  For instance, I had no problem merging /etc/master.passwd and 
/etc/group for the ntp change.
Regards
-- 
Niclas

From filippomore at yahoo.com  Mon Jul 23 16:00:15 2018
From: filippomore at yahoo.com (Filippo Moretti)
Date: Mon, 23 Jul 2018 16:00:04 +0000 (UTC)
Subject: ntpd as ntpd user question
In-Reply-To: <de060c0d-5b7f-5893-5c29-a251be0b0415@daemonic.se>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721185654.239b4c8b@gumby.homeunix.com>
 <de060c0d-5b7f-5893-5c29-a251be0b0415@daemonic.se>
Message-ID: <1712153218.980034.1532361604176@mail.yahoo.com>

 I have ntpd both in etc(passwd and /etc/group but installworld fail saying that user ntpd is missing can you please let me know how
to manually edit the entries for ntpd in both files.Etcupdate fails
.It is rather odd because with the same hardware using ufs I did not run into problem with zfs system I get this error
Filippo

    On Monday, July 23, 2018, 1:00:10 PM GMT+2, Niclas Zeising <zeising+freebsd at daemonic.se> wrote:  
 
 On 07/21/18 19:56, RW wrote:
> On Sat, 21 Jul 2018 11:14:45 -0600
> Ian Lepore wrote:
> 
> 
>> There's a "pre-world" stage of mergemaster (-Fp option I think) which
>> isn't needed often, but one of the times it is needed is apparently
>> when new user ids are added.
> 
> I wish mergemaster had an option to just add new users and groups,
> rather than merging the files.

etcupdate is usually pretty good at automatically merge updates to files 
without user interaction, even when the files are locally edited as 
well.? For instance, I had no problem merging /etc/master.passwd and 
/etc/group for the ntp change.
Regards
-- 
Niclas
_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
  

From filippomore at yahoo.com  Mon Jul 23 16:03:15 2018
From: filippomore at yahoo.com (Filippo Moretti)
Date: Mon, 23 Jul 2018 16:03:10 +0000 (UTC)
Subject: ntpd as ntpd user question
In-Reply-To: <1712153218.980034.1532361604176@mail.yahoo.com>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721185654.239b4c8b@gumby.homeunix.com>
 <de060c0d-5b7f-5893-5c29-a251be0b0415@daemonic.se>
 <1712153218.980034.1532361604176@mail.yahoo.com>
Message-ID: <54187900.992082.1532361790393@mail.yahoo.com>

 
It does not matter the system no longer boot.
Filippo
    On Monday, July 23, 2018, 6:00:04 PM GMT+2, Filippo Moretti <filippomore at yahoo.com> wrote:  
 
  I have ntpd both in etc(passwd and /etc/group but installworld fail saying that user ntpd is missing can you please let me know how
to manually edit the entries for ntpd in both files.Etcupdate fails
.It is rather odd because with the same hardware using ufs I did not run into problem with zfs system I get this error
Filippo

    On Monday, July 23, 2018, 1:00:10 PM GMT+2, Niclas Zeising <zeising+freebsd at daemonic.se> wrote:  
 
 On 07/21/18 19:56, RW wrote:
> On Sat, 21 Jul 2018 11:14:45 -0600
> Ian Lepore wrote:
> 
> 
>> There's a "pre-world" stage of mergemaster (-Fp option I think) which
>> isn't needed often, but one of the times it is needed is apparently
>> when new user ids are added.
> 
> I wish mergemaster had an option to just add new users and groups,
> rather than merging the files.

etcupdate is usually pretty good at automatically merge updates to files 
without user interaction, even when the files are locally edited as 
well.? For instance, I had no problem merging /etc/master.passwd and 
/etc/group for the ntp change.
Regards
-- 
Niclas
_______________________________________________
freebsd-current at freebsd.org mailing list
https://lists.freebsd.org/mailman/listinfo/freebsd-current
To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
    

From david at catwhisker.org  Mon Jul 23 16:07:46 2018
From: david at catwhisker.org (David Wolfskill)
Date: Mon, 23 Jul 2018 09:07:35 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1712153218.980034.1532361604176@mail.yahoo.com>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721185654.239b4c8b@gumby.homeunix.com>
 <de060c0d-5b7f-5893-5c29-a251be0b0415@daemonic.se>
 <1712153218.980034.1532361604176@mail.yahoo.com>
Message-ID: <20180723160735.GF1596@albert.catwhisker.org>

On Mon, Jul 23, 2018 at 04:00:04PM +0000, Filippo Moretti wrote:
>  I have ntpd both in etc(passwd and /etc/group but installworld fail saying that user ntpd is missing can you please let me know how
> to manually edit the entries for ntpd in both files.Etcupdate fails
> .It is rather odd because with the same hardware using ufs I did not run into problem with zfs system I get this error
> ....

Depending on how you updated /etc/master.passwd, you may also need to
run pwd_mkdb.

Peace,
david
-- 
David H. Wolfskill				david at catwhisker.org
Can a "stable genius" get a Nobel Peace Prize for firing off ALL CAPS tweets?

See http://www.catwhisker.org/~david/publickey.gpg for my public key.
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 618 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180723/5561c79f/attachment.sig>

From herbert at gojira.at  Mon Jul 23 19:34:35 2018
From: herbert at gojira.at (Herbert J. Skuhra)
Date: Mon, 23 Jul 2018 21:34:26 +0200
Subject: ntpd as ntpd user question
In-Reply-To: <20180723045552.GA44941@www.zefox.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net>
Message-ID: <87r2jtiw59.wl-herbert@gojira.at>

On Mon, 23 Jul 2018 06:55:52 +0200,
bob prohaska <fbsd at www.zefox.net> wrote:
> 
> On Sun, Jul 22, 2018 at 01:49:41AM +0200, Herbert J. Skuhra wrote:
> > On Sat, Jul 21, 2018 at 03:09:26PM -0700, bob prohaska wrote:
> 
> > > The failure is a little surprising, is ntpd a reserved name?
> > 
> > Why? You obviously entered the string "ntpd" instead of an integer when
> > asked for the uid!?
> > 
> 
> Sigh...you're right. Must have been sleepier than I thought.
> 
> > > The machine is re-running buildworld/installworld from a clean start,
> > > so presumably it'll halt over the same error again. When that happens, 
> > > what's the simplest way to recover? Mergemaster is a big hammer, something
> > > less comprehensive might suffice, even manual editing of files.
> > 
> > In this case 'mergemaster -p' is enough.
> > 
> 
> An example or two on the use of mergemaster might be a considerable help. There's something
> very basic that I don't understand.
> 
> What is the correct response to the prompts for this simple case? The output displayed
> is said to be differences, so the "temporary" file's nature isn't self-evident. It looks
> as if the most obvious option is m, followed by eb, but that leaves me editing by hand, 
> which is what I thought mergemaster was supposed to avoid. 

Yes, first you press m. Then you will see differences of installed
file (left) and new file (right). Then you press either l or
r:

l | 1:	choose left diff
r | 2:	choose right diff

If the diff tries to remove/add to many lines you can:

el:	edit left diff
er:	edit right diff

And if done you can view the merged file (v) before installing (i) it.

I am sure, someone can explain it better! :)

--
Herbert

From samy.mahmoudi at gmail.com  Mon Jul 23 23:06:21 2018
From: samy.mahmoudi at gmail.com (Samy Mahmoudi)
Date: Tue, 24 Jul 2018 01:06:19 +0200
Subject: awk manual
Message-ID: <CAFigVTNvfk6WZFu++_w2f9T8jgkis5-Cdu_YHHrpx+EOZY=abQ@mail.gmail.com>

Hello,

The awk manual seems out of date.

For example, the -V option is documented but is unknown at execution.
Reciprocally, --version is not documented but is functional at execution.
Under FreeBSD 12.0-CURRENT, the date at the end of the manual also seems
older than expected, as the FreeBSD Manual Pages indicates a newer date for
FreeBSD 11.2.

I could edit awk.1 and copy/paste a patch to solve these but reviewing the
whole manual may be better to eradicate other omissions. From the FreeBSD
Manual Pages, I have found out that options (including -V) were introduced
between 11.0 RELEASE and 11.1 RELEASE.

By the way, choosing the "FreeBSD 12-current" manual on that web page
<https://www.freebsd.org/cgi/man.cgi?query=awk&apropos=0&sektion=1&manpath=FreeBSD+12-current&arch=default&format=html>
actually gives the "FreeBSD 11.2" manual, seemingly.

Best regards,
Samy

From fbsd at www.zefox.net  Tue Jul 24 01:54:17 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Mon, 23 Jul 2018 18:54:28 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <87r2jtiw59.wl-herbert@gojira.at>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net>
 <87r2jtiw59.wl-herbert@gojira.at>
Message-ID: <20180724015428.GB47869@www.zefox.net>

On Mon, Jul 23, 2018 at 09:34:26PM +0200, Herbert J. Skuhra wrote:
> 
> Yes, first you press m. Then you will see differences of installed
> file (left) and new file (right). Then you press either l or
> r:
> 
> l | 1:	choose left diff
> r | 2:	choose right diff
> 
> If the diff tries to remove/add to many lines you can:
> 
> el:	edit left diff
> er:	edit right diff
> 
> And if done you can view the merged file (v) before installing (i) it.
> 
> I am sure, someone can explain it better! :)
> 

Perhaps, but you've made the essential point. Your reply let me understand that 
mergemaster does not really "master" the merge, it rather identifies files needing 
to be merged and then starts sdiff to let me modify files. Never having even looked 
at sdiff, the learning curve proved very steep. Too steep, in fact.

I'm going to try a more incremental approach. 

Thank you _very_ much!

bob prohaska
 



From ian at freebsd.org  Tue Jul 24 02:26:13 2018
From: ian at freebsd.org (Ian Lepore)
Date: Mon, 23 Jul 2018 20:25:59 -0600
Subject: ntpd as ntpd user question
In-Reply-To: <20180724015428.GB47869@www.zefox.net>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net> <87r2jtiw59.wl-herbert@gojira.at>
 <20180724015428.GB47869@www.zefox.net>
Message-ID: <1532399159.1344.211.camel@freebsd.org>

On Mon, 2018-07-23 at 18:54 -0700, bob prohaska wrote:
> On Mon, Jul 23, 2018 at 09:34:26PM +0200, Herbert J. Skuhra wrote:
> > 
> > 
> > Yes, first you press m. Then you will see differences of installed
> > file (left) and new file (right). Then you press either l or
> > r:
> > 
> > l | 1:	choose left diff
> > r | 2:	choose right diff
> > 
> > If the diff tries to remove/add to many lines you can:
> > 
> > el:	edit left diff
> > er:	edit right diff
> > 
> > And if done you can view the merged file (v) before installing (i)
> > it.
> > 
> > I am sure, someone can explain it better! :)
> > 
> Perhaps, but you've made the essential point. Your reply let me
> understand that?
> mergemaster does not really "master" the merge, it rather identifies
> files needing?
> to be merged and then starts sdiff to let me modify files. Never
> having even looked?
> at sdiff, the learning curve proved very steep. Too steep, in fact.
> 
> I'm going to try a more incremental approach.?
> 
> Thank you _very_ much!
> 
> bob prohaska

Your reaction to mergemaster is about the same as mine was when I first
encountered it very long ago, and re-discovered when I tried it a
couple years ago. It just seems like more trouble than it's worth, I
can usually figure out what's broken and fix it by hand faster than
messing with all the merge stuff.

But, someone told me that if you give mergemaster the right flags it
can potentially be intervention-free. Those apparently aren't the flag
or two that're suggested at the bottom of UPDATING. So I didn't really
dig into that any deeper, but I toss it out there in case someone can
expand on it.

It certainly makes some sense that it could be done intervention-free.
When doing other diff-based merges (like 'svn update') you only have to
intervene when there's an actual conflict between some local change
you've made and the incoming changes.

-- Ian

From fbsd at www.zefox.net  Tue Jul 24 03:10:46 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Mon, 23 Jul 2018 20:10:58 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532399159.1344.211.camel@freebsd.org>
References: <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net>
 <87r2jtiw59.wl-herbert@gojira.at>
 <20180724015428.GB47869@www.zefox.net>
 <1532399159.1344.211.camel@freebsd.org>
Message-ID: <20180724031058.GC47869@www.zefox.net>

On Mon, Jul 23, 2018 at 08:25:59PM -0600, Ian Lepore wrote:
> On Mon, 2018-07-23 at 18:54 -0700, bob prohaska wrote:
> > at sdiff, the learning curve proved very steep. Too steep, in fact.
> > 
> > I'm going to try a more incremental approach.?
> > 
> > Thank you _very_ much!
> > 
> > bob prohaska
> 
> Your reaction to mergemaster is about the same as mine was when I first
> encountered it very long ago, and re-discovered when I tried it a
> couple years ago. It just seems like more trouble than it's worth, I
> can usually figure out what's broken and fix it by hand faster than
> messing with all the merge stuff.
> 
Your suggestion to use vipw seems to have worked. Copied the required
line, ran /usr/sbin/pwd_mkdb -p /etc/master.passwd and installworld ran
without issue.

The machine has now rebooted and ntp has set the clock correctly. 
I don't see ntpd in a ps -aux output.

It's unclear what I need to do next, but at least I'm over the first
hurdle. I'll go back to your earlier email and attempt the rest of the
updates by hand.

Thanks for all your help!

bob prohaska


> But, someone told me that if you give mergemaster the right flags it
> can potentially be intervention-free. Those apparently aren't the flag
> or two that're suggested at the bottom of UPDATING. So I didn't really
> dig into that any deeper, but I toss it out there in case someone can
> expand on it.
> 
> It certainly makes some sense that it could be done intervention-free.
> When doing other diff-based merges (like 'svn update') you only have to
> intervene when there's an actual conflict between some local change
> you've made and the incoming changes.
> 
> -- Ian
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

From rkoberman at gmail.com  Tue Jul 24 04:28:43 2018
From: rkoberman at gmail.com (Kevin Oberman)
Date: Mon, 23 Jul 2018 21:28:41 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <1532399159.1344.211.camel@freebsd.org>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org> <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org> <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net>
 <87r2jtiw59.wl-herbert@gojira.at> <20180724015428.GB47869@www.zefox.net>
 <1532399159.1344.211.camel@freebsd.org>
Message-ID: <CAN6yY1s12iehNc2XgT762oQ5AVH6LD_fC7L2zm5Jkgnr=vrSCg@mail.gmail.com>

On Mon, Jul 23, 2018 at 7:25 PM, Ian Lepore <ian at freebsd.org> wrote:

> On Mon, 2018-07-23 at 18:54 -0700, bob prohaska wrote:
> > On Mon, Jul 23, 2018 at 09:34:26PM +0200, Herbert J. Skuhra wrote:
> > >
> > >
> > > Yes, first you press m. Then you will see differences of installed
> > > file (left) and new file (right). Then you press either l or
> > > r:
> > >
> > > l | 1:      choose left diff
> > > r | 2:      choose right diff
> > >
> > > If the diff tries to remove/add to many lines you can:
> > >
> > > el: edit left diff
> > > er: edit right diff
> > >
> > > And if done you can view the merged file (v) before installing (i)
> > > it.
> > >
> > > I am sure, someone can explain it better! :)
> > >
> > Perhaps, but you've made the essential point. Your reply let me
> > understand that
> > mergemaster does not really "master" the merge, it rather identifies
> > files needing
> > to be merged and then starts sdiff to let me modify files. Never
> > having even looked
> > at sdiff, the learning curve proved very steep. Too steep, in fact.
> >
> > I'm going to try a more incremental approach.
> >
> > Thank you _very_ much!
> >
> > bob prohaska
>
> Your reaction to mergemaster is about the same as mine was when I first
> encountered it very long ago, and re-discovered when I tried it a
> couple years ago. It just seems like more trouble than it's worth, I
> can usually figure out what's broken and fix it by hand faster than
> messing with all the merge stuff.
>
> But, someone told me that if you give mergemaster the right flags it
> can potentially be intervention-free. Those apparently aren't the flag
> or two that're suggested at the bottom of UPDATING. So I didn't really
> dig into that any deeper, but I toss it out there in case someone can
> expand on it.
>
> It certainly makes some sense that it could be done intervention-free.
> When doing other diff-based merges (like 'svn update') you only have to
> intervene when there's an actual conflict between some local change
> you've made and the incoming changes.
>
>
It gets a LOT simpler if you use "mergemaster -iPUF" Only those files you
have modified will show up. In most cases, it just zips right by. In most
that it does not, the use of 'r' or 'l' in merge is all you need and always
'r' eccepton lines you have modified, yourself, so you should know about
them.

I should note that 'U' does have a small "race" in it, so it i possible to
get biten by it, but it is very unlikely. Has to do with multiple commits
that touch the same lines in the file in a timing that is out of sync with
your running it. I use '-iPF' because I m paranoid.
--
Kevin Oberman, Part time kid herder and retired Network Engineer
E-mail: rkoberman at gmail.com
PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683

From ohartmann at walstatt.org  Tue Jul 24 05:17:07 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Tue, 24 Jul 2018 07:16:45 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <80523BE6-C035-482D-B134-23812183DE83@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
Message-ID: <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>

On Mon, 23 Jul 2018 10:56:04 +0300
Toomas Soome <tsoome at me.com> wrote:

> > On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Fri, 13 Jul 2018 18:44:23 +0300
> > Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >   
> >>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>> 
> >>> -----BEGIN PGP SIGNED MESSAGE-----
> >>> Hash: SHA512
> >>> 
> >>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com> <mailto:tsoome at me.com
> >>> <mailto:tsoome at me.com>>> schrieb: 
> >>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>> 
> >>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
> >>>>> drives where the first partition begins at block 40 of the hdd/ssd.
> >>>>> 
> >>>>> I have two host in private use based on an
> >>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>>>> LGA1155). Both boards are equipted with the lates official available AMI
> >>>>> firmware revision, dating to 2013. This is for the Z77-Pro4-M revision
> >>>>> 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8 (2013/7/17). For both
> >>>>> boards a BETA revision for the Spectre/Meltdown mitigation is available,
> >>>>> but I didn't test that. But please read.
> >>>>> 
> >>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>>>> 05/25/2018 (or 20180525).
> >>>>> 
> >>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
> >>>>> using UEFI-only boot method on a GPT partitioned device fails. The
> >>>>> ASRock boards jump immediately into the firmware, the Fujitsu offers
> >>>>> some kind of CPU/Memory/HDD test facility.
> >>>>> 
> >>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
> >>>>> implied, the MBR partitioned FreeBSD installation USB flash device does
> >>>>> boot in UEFI! I guess I can assume this when the well known clumsy 80x25
> >>>>> char console suddenly gets bright and shiny with a much higher resoltion
> >>>>> as long the GPU supports EFI GOP. Looking with gpart at the USB flash
> >>>>> drives reveals that the EFI partition starts at block 1 of the device
> >>>>> and the device has a MBR layout. I haven't found a way to force the GPT
> >>>>> scheme, when initialised via gpart, to let the partitions start at block
> >>>>> 1. This might be a naiv thinking, so please be patient with me.
> >>>>> 
> >>>>> I do not know whether this is a well-known issue. On the ASRock boards,
> >>>>> I tried years ago some LinuxRed Hat and Suse with UEFI and that worked -
> >>>>> FreeBSD not. I gave up on that that time. Now, having the very same
> >>>>> issues with a new Fujitsu system, leaves me with the impression that
> >>>>> FreeBSD's UEFI implementation might have problems I'm not aware of.
> >>>>> 
> >>>>> Can someone shed some light onto this? 
> >>>>>   
> >>>> 
> >>>> The first thing to check is if the secure boot is disabled. We do not
> >>>> support secure boot at all at this time.    
> >>> 
> >>> Secure boot is in every scenario disabled!
> >>>   
> >>>> 
> >>>> If you have efi or bios version running - you can check from either
> >>>> console variable value (it can have efi or vidconsole or comconsole) or
> >>>> better yet, see if efi-version is set (show efi-version) - if efi-version
> >>>> is not set, it is BIOS loader running. Another indirect way is to see
> >>>> lsdev -v, with device paths present, it is uefi:)    
> >>> 
> >>> What are you talking about?
> >>> What is the point of entry - running system, loader?
> >>> 
> >>> sysct machdep.bootmethod: BIOS
> >>> 
> >>> This makes me quite sure that the system has booted via BIOS - as I'm sure
> >>> since I've checked that many times. UEFI doesn't work on those systems
> >>> with FreeBSD. I'm not sure antmore, but I tried also Windows 7 on those
> >>> mainboards booting via UEFI - and I might recall that they failed also. I
> >>> also recall that there were issues with earlier UEFI versions regarding
> >>> booting only Windows 8/8.1 - and nothing else, but the fact that Linux
> >>> worked confuses me a bit.
> >>> 
> >>> If this ASRock crap (never ever again this brand!) doesn't work at all -
> >>> who cares, I intend to purchase new server grade hardware. But the more
> >>> puzzling issue is with the Fujitsu, which I consider serious and from the
> >>> behaviour the Fujitsu failure looks exactly like the ASRock - Windows 7
> >>> works, RedHat 7.5 works (I assume I can trust the Firmware settings when I
> >>> disable CSM support, that the Firmware will only EFI/UEFI capable loader?
> >>> Or is there a ghosty override somwhere to be expected?). Also on ASRock
> >>> disabling CSM should ensure not booting a dual-bootstrap-capable system.
> >>> This said, on the recent Fujitsu, it seems to boil down to a FreeBSD
> >>> UEFI-firmware interaction problem, while the ASRock is still under
> >>> suspicion to be broken by design.   
> >>>> 
> >>>> GPT partitions can never start from disk absolute sector 1; this is
> >>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >>>> table and then sectors 2-33 have GPT partition table entries, so the
> >>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
> >>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.    
> >>> 
> >>> Thanks for the explanation. That implies the installer did right, gpart
> >>> did also right and therefore there must be an issue with the stuff located
> >>> within the EFI partition?   
> >> 
> >> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS loader
> >> at all or not - that is, if the BIOS bootstrap is actually caring to read
> >> the MBR code and start it, since once the MBR code is started, it is all
> >> about our code.  
> > 
> > I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you
> > mean that specific portion of the UEFI firmware, which looks for the proper
> > UEFI partition?
> >   
> 
> BIOS as either native or CSM. Note that from boot code point of view the CSM
> boot *is* BIOS boot, we have no access to UEFI features.
> 
> > 
> > The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
> > refuse booting UEFI, even if properly setup (in terms of what FreeBSD
> > provides on recent CURRENT) is applied and CSM is switched off in the
> > firmware. Again: GPT partition scheme.
> > 
> > The system boots properly if a second partition of type "freebsd-boot" is
> > applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
> > -p /boot/gptboot -i 2 ada0" (ada0 is the device).   
> >> 
> >> btw, you can try to validate the installed boot blocks by using recent
> >> enough loader (usb or iso) and then you can use from OK prompt:  
> > 
> > lsdev provides me with the follwoing informations (CSM enabled):
> > 
> > OK lsdev
> > disk devices:
> > 	disk0:		BIOS DRIVE C ...
> > 
> > 		disk0p1:	EFI
> > 		disk0p2:	FreeBSD BOOT
> > 		disk0p3:	FreeBSD SWAP
> > 		disk0p4:	FreeBSD ZFS
> > zfs devices:
> > 	zfs:zroot
> > 
> > OK chain disk0
> > open failed     (so for disk0p{1-4}.
> > 
> > OK chain zroot
> > failed to read disk (just for completeness)  
> 
> 
> chain command does use only device name (such as disk0: or disk0p2: ), but
> not zfs pool as device.  I just found I haven?t ported the code to read the
> file.

??

> 
> the point for chain command test is to see if the normal read and execute
> would work, so in your case please try:
> 
> chain disk0:

As stated above, I did so, and the result is also mentioned above, I always get 
"open failed".
This is the same for 

chain disk0
chain disk0p1
chain disk0p2
chain disk0p3
chain disk0p4

as already said. CSM is enabled in this case.

> 
> to read pmbr (512B) and execute it. The expected outcome would be that pmbr
> boot code would browse the GPT, read stage1 from disk0p2: and execute it;
> stage1 would detect FreeBSD ZFS from disk0p4: and load and
> execute /boot/loader. If that will happen, it means the boot code in our
> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats true,
> it would mean that you either need to use UEFI boot or need to have some hack
> to fool the BIOS or just not use GPT on that machine with CSM.

To make it clear here: The only way to boot this box is using CSM (as it is the
same with the ASRock boards mentioned earlier). But my intention is to disable
CSM and use a GPT/UEFI environment only! And GPT/UEFI doesn't work with
FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.

It would be nice if this could be fixed. I'm more interested in the fix on the
recent Fujitsu device than the outdated ASRock crap, but if the fix for the
Fujitsu Firmware could fix older issues as a byproduct, I'd appreciate that.

Kind regards,

oh

> 
> rgds,
> toomas
> 
> >> 
> >> OK chain diskX:
> >> 
> >> (replace X by correct disk number from lsdev) to read and start the MBR
> >> code. If that is working, then its really about BIOS refusing to read the
> >> MBR and execute it.  
> > 
> > See above.
> > 
> > I do not get that far to the loader if CSM is disabled (pure UEFI). The
> > same on the ASROCK boards. 
> > 
> > The ASRock systems boot off of an SSD with GPT partition scheme and UFS
> > filesystem only (running recent 12-CURRENT), while the Esprimo box is also
> > an SSD, but GPT/ZFS (11.2-RELENG).
> > 
> > I do not doubt the principle here, since a bunch of Fujitsu servers around
> > here boot off 12-CURRENT and 11.2-RELENG from GPT/UFS SSDs as well as
> > GPT/ZFS SSDs. Not problem so far.
> > 
> > I checked out for the most recent Firmware for the ASRock boards and applied
> > the may, 2018 Spectre/Meltdown mitigation images found in the BETA section.
> > No changes for boot at all.
> > 
> > Can I do something to help?
> >   
> >> 
> >> rgds,
> >> toomas
> >>   
> > 
> > Kind regards,
> > oh
> > _______________________________________________
> > freebsd-current at freebsd.org <mailto:freebsd-current at freebsd.org> mailing
> > list https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > <https://lists.freebsd.org/mailman/listinfo/freebsd-current> To
> > unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org
> > <mailto:freebsd-current-unsubscribe at freebsd.org>"  
> 


From tsoome at me.com  Tue Jul 24 05:53:43 2018
From: tsoome at me.com (Toomas Soome)
Date: Tue, 24 Jul 2018 08:53:36 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>



> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Mon, 23 Jul 2018 10:56:04 +0300
> Toomas Soome <tsoome at me.com> wrote:
> 
>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>> 
>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>> 
>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>> Hash: SHA512
>>>>> 
>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com> <mailto:tsoome at me.com
>>>>> <mailto:tsoome at me.com>>> schrieb: 
>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>> 
>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
>>>>>>> 
>>>>>>> I have two host in private use based on an
>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
>>>>>>> LGA1155). Both boards are equipted with the lates official available AMI
>>>>>>> firmware revision, dating to 2013. This is for the Z77-Pro4-M revision
>>>>>>> 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8 (2013/7/17). For both
>>>>>>> boards a BETA revision for the Spectre/Meltdown mitigation is available,
>>>>>>> but I didn't test that. But please read.
>>>>>>> 
>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
>>>>>>> 05/25/2018 (or 20180525).
>>>>>>> 
>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
>>>>>>> using UEFI-only boot method on a GPT partitioned device fails. The
>>>>>>> ASRock boards jump immediately into the firmware, the Fujitsu offers
>>>>>>> some kind of CPU/Memory/HDD test facility.
>>>>>>> 
>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
>>>>>>> implied, the MBR partitioned FreeBSD installation USB flash device does
>>>>>>> boot in UEFI! I guess I can assume this when the well known clumsy 80x25
>>>>>>> char console suddenly gets bright and shiny with a much higher resoltion
>>>>>>> as long the GPU supports EFI GOP. Looking with gpart at the USB flash
>>>>>>> drives reveals that the EFI partition starts at block 1 of the device
>>>>>>> and the device has a MBR layout. I haven't found a way to force the GPT
>>>>>>> scheme, when initialised via gpart, to let the partitions start at block
>>>>>>> 1. This might be a naiv thinking, so please be patient with me.
>>>>>>> 
>>>>>>> I do not know whether this is a well-known issue. On the ASRock boards,
>>>>>>> I tried years ago some LinuxRed Hat and Suse with UEFI and that worked -
>>>>>>> FreeBSD not. I gave up on that that time. Now, having the very same
>>>>>>> issues with a new Fujitsu system, leaves me with the impression that
>>>>>>> FreeBSD's UEFI implementation might have problems I'm not aware of.
>>>>>>> 
>>>>>>> Can someone shed some light onto this? 
>>>>>>> 
>>>>>> 
>>>>>> The first thing to check is if the secure boot is disabled. We do not
>>>>>> support secure boot at all at this time.    
>>>>> 
>>>>> Secure boot is in every scenario disabled!
>>>>> 
>>>>>> 
>>>>>> If you have efi or bios version running - you can check from either
>>>>>> console variable value (it can have efi or vidconsole or comconsole) or
>>>>>> better yet, see if efi-version is set (show efi-version) - if efi-version
>>>>>> is not set, it is BIOS loader running. Another indirect way is to see
>>>>>> lsdev -v, with device paths present, it is uefi:)    
>>>>> 
>>>>> What are you talking about?
>>>>> What is the point of entry - running system, loader?
>>>>> 
>>>>> sysct machdep.bootmethod: BIOS
>>>>> 
>>>>> This makes me quite sure that the system has booted via BIOS - as I'm sure
>>>>> since I've checked that many times. UEFI doesn't work on those systems
>>>>> with FreeBSD. I'm not sure antmore, but I tried also Windows 7 on those
>>>>> mainboards booting via UEFI - and I might recall that they failed also. I
>>>>> also recall that there were issues with earlier UEFI versions regarding
>>>>> booting only Windows 8/8.1 - and nothing else, but the fact that Linux
>>>>> worked confuses me a bit.
>>>>> 
>>>>> If this ASRock crap (never ever again this brand!) doesn't work at all -
>>>>> who cares, I intend to purchase new server grade hardware. But the more
>>>>> puzzling issue is with the Fujitsu, which I consider serious and from the
>>>>> behaviour the Fujitsu failure looks exactly like the ASRock - Windows 7
>>>>> works, RedHat 7.5 works (I assume I can trust the Firmware settings when I
>>>>> disable CSM support, that the Firmware will only EFI/UEFI capable loader?
>>>>> Or is there a ghosty override somwhere to be expected?). Also on ASRock
>>>>> disabling CSM should ensure not booting a dual-bootstrap-capable system.
>>>>> This said, on the recent Fujitsu, it seems to boil down to a FreeBSD
>>>>> UEFI-firmware interaction problem, while the ASRock is still under
>>>>> suspicion to be broken by design.   
>>>>>> 
>>>>>> GPT partitions can never start from disk absolute sector 1; this is
>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.    
>>>>> 
>>>>> Thanks for the explanation. That implies the installer did right, gpart
>>>>> did also right and therefore there must be an issue with the stuff located
>>>>> within the EFI partition?   
>>>> 
>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS loader
>>>> at all or not - that is, if the BIOS bootstrap is actually caring to read
>>>> the MBR code and start it, since once the MBR code is started, it is all
>>>> about our code.  
>>> 
>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you
>>> mean that specific portion of the UEFI firmware, which looks for the proper
>>> UEFI partition?
>>> 
>> 
>> BIOS as either native or CSM. Note that from boot code point of view the CSM
>> boot *is* BIOS boot, we have no access to UEFI features.
>> 
>>> 
>>> The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
>>> refuse booting UEFI, even if properly setup (in terms of what FreeBSD
>>> provides on recent CURRENT) is applied and CSM is switched off in the
>>> firmware. Again: GPT partition scheme.
>>> 
>>> The system boots properly if a second partition of type "freebsd-boot" is
>>> applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
>>> -p /boot/gptboot -i 2 ada0" (ada0 is the device).   
>>>> 
>>>> btw, you can try to validate the installed boot blocks by using recent
>>>> enough loader (usb or iso) and then you can use from OK prompt:  
>>> 
>>> lsdev provides me with the follwoing informations (CSM enabled):
>>> 
>>> OK lsdev
>>> disk devices:
>>> 	disk0:		BIOS DRIVE C ...
>>> 
>>> 		disk0p1:	EFI
>>> 		disk0p2:	FreeBSD BOOT
>>> 		disk0p3:	FreeBSD SWAP
>>> 		disk0p4:	FreeBSD ZFS
>>> zfs devices:
>>> 	zfs:zroot
>>> 
>>> OK chain disk0
>>> open failed     (so for disk0p{1-4}.
>>> 
>>> OK chain zroot
>>> failed to read disk (just for completeness)  
>> 
>> 
>> chain command does use only device name (such as disk0: or disk0p2: ), but
>> not zfs pool as device.  I just found I haven?t ported the code to read the
>> file.
> 
> ??
> 
>> 
>> the point for chain command test is to see if the normal read and execute
>> would work, so in your case please try:
>> 
>> chain disk0:
> 
> As stated above, I did so, and the result is also mentioned above, I always get 
> "open failed".
> This is the same for 
> 
> chain disk0
> chain disk0p1
> chain disk0p2
> chain disk0p3
> chain disk0p4
> 
> as already said. CSM is enabled in this case.

sigh? chain command does take device as argument, device must always end with colon?. in this case, the devil is in details:) as I wrote above, the command should be:

chain disk0:

The disk0p1: etc will only work when partition boot code was installed (which you most likely do not have - the only possible candidate could be FreeBSD ZFS partition).

> 
>> 
>> to read pmbr (512B) and execute it. The expected outcome would be that pmbr
>> boot code would browse the GPT, read stage1 from disk0p2: and execute it;
>> stage1 would detect FreeBSD ZFS from disk0p4: and load and
>> execute /boot/loader. If that will happen, it means the boot code in our
>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats true,
>> it would mean that you either need to use UEFI boot or need to have some hack
>> to fool the BIOS or just not use GPT on that machine with CSM.
> 
> To make it clear here: The only way to boot this box is using CSM (as it is the
> same with the ASRock boards mentioned earlier). But my intention is to disable
> CSM and use a GPT/UEFI environment only! And GPT/UEFI doesn't work with
> FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
> 
> It would be nice if this could be fixed. I'm more interested in the fix on the
> recent Fujitsu device than the outdated ASRock crap, but if the fix for the
> Fujitsu Firmware could fix older issues as a byproduct, I'd appreciate that.
> 
> Kind regards,
> 

ok, somehow I have lost that part of the discussion. Well, you wrote that the UEFI boot fails when the first partition starts from sector 40 - does it mean you have boot when the partition will start from some other sector? I think, there is something else going on.

What you can do is to see if that firmware will offer you EFI shell option, from there you can try to start the bootx64.efi manually and see what error you will get. However, the number 1 cause for failing to start the bootloader in UEFI is secure boot - we do not support it and secure boot must be switched off. 

However, they seem to claim "The Secure Boot option is available in the UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 

Still suggest to double check if thats really the case. Also, if the bootx64.efi start will fail and no messages are appearing on screen, then either there is something in firmware logs or you could get them from trying to start bootx64.efi from UEFI shell.

thds,
toomas

> 
>> 
>> rgds,
>> toomas
>> 
>>>> 
>>>> OK chain diskX:
>>>> 
>>>> (replace X by correct disk number from lsdev) to read and start the MBR
>>>> code. If that is working, then its really about BIOS refusing to read the
>>>> MBR and execute it.  
>>> 
>>> See above.
>>> 
>>> I do not get that far to the loader if CSM is disabled (pure UEFI). The
>>> same on the ASROCK boards. 
>>> 
>>> The ASRock systems boot off of an SSD with GPT partition scheme and UFS
>>> filesystem only (running recent 12-CURRENT), while the Esprimo box is also
>>> an SSD, but GPT/ZFS (11.2-RELENG).
>>> 
>>> I do not doubt the principle here, since a bunch of Fujitsu servers around
>>> here boot off 12-CURRENT and 11.2-RELENG from GPT/UFS SSDs as well as
>>> GPT/ZFS SSDs. Not problem so far.
>>> 
>>> I checked out for the most recent Firmware for the ASRock boards and applied
>>> the may, 2018 Spectre/Meltdown mitigation images found in the BETA section.
>>> No changes for boot at all.
>>> 
>>> Can I do something to help?
>>> 
>>>> 
>>>> rgds,
>>>> toomas
>>>> 
>>> 
>>> Kind regards,
>>> oh
>>> _______________________________________________
>>> freebsd-current at freebsd.org <mailto:freebsd-current at freebsd.org> mailing
>>> list https://lists.freebsd.org/mailman/listinfo/freebsd-current
>>> <https://lists.freebsd.org/mailman/listinfo/freebsd-current> To
>>> unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org
>>> <mailto:freebsd-current-unsubscribe at freebsd.org>"  
>> 
> 


From allanjude at freebsd.org  Tue Jul 24 06:20:11 2018
From: allanjude at freebsd.org (Allan Jude)
Date: Tue, 24 Jul 2018 02:20:00 -0400
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <fd135b65-bc86-0e73-a6a4-c420304b8d30@freebsd.org>

On 2018-07-13 07:00, O. Hartmann wrote:
> The problem is some kind of weird. I face UEFI boot problems on GPT drives
> where the first partition begins at block 40 of the hdd/ssd.
> 
> I have two host in private use based on an
> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
> Both boards are equipted with the lates official available AMI firmware
> revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
> and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> for the Spectre/Meltdown mitigation is available, but I didn't test that. But
> please read.
> 
> The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
> AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
> 
> Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
> UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
> immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
> test facility.
> 
> If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
> the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
> guess I can assume this when the well known clumsy 80x25 char console suddenly
> gets bright and shiny with a much higher resoltion as long the GPU supports
> EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
> partition starts at block 1 of the device and the device has a MBR layout. I
> haven't found a way to force the GPT scheme, when initialised via gpart, to let
> the partitions start at block 1. This might be a naiv thinking, so please be
> patient with me.
> 
> I do not know whether this is a well-known issue. On the ASRock boards, I
> tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
> not. I gave up on that that time. Now, having the very same issues with a new
> Fujitsu system, leaves me with the impression that FreeBSD's UEFI
> implementation might have problems I'm not aware of.
> 
> Can someone shed some light onto this? 
> 
> Thanks in advance,
> 
> Oliver 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 

If you are up for experimenting, see if either of these results in your
system booting:
gpart set -a active ada0
gpart set -a lenovofix ada0

Although both of these should only impact BIOS boot, not UEFI, you never
know.

The other option is to try an ESP (EFI System Partition) that is
formatted FAT32 instead of FAT12/FAT16)

-- 
Allan Jude

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 834 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180724/8feaf93d/attachment.sig>

From tsoome at me.com  Tue Jul 24 07:30:40 2018
From: tsoome at me.com (Toomas Soome)
Date: Tue, 24 Jul 2018 09:30:08 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <fd135b65-bc86-0e73-a6a4-c420304b8d30@freebsd.org>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <fd135b65-bc86-0e73-a6a4-c420304b8d30@freebsd.org>
Message-ID: <5BE9BA38-4B13-4BC8-A0CE-EEE4F34CFF08@me.com>



> On 24 Jul 2018, at 09:20, Allan Jude <allanjude at freebsd.org> wrote:
> 
> On 2018-07-13 07:00, O. Hartmann wrote:
>> The problem is some kind of weird. I face UEFI boot problems on GPT drives
>> where the first partition begins at block 40 of the hdd/ssd.
>> 
>> I have two host in private use based on an
>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket LGA1155).
>> Both boards are equipted with the lates official available AMI firmware
>> revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
>> and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
>> for the Spectre/Meltdown mitigation is available, but I didn't test that. But
>> please read.
>> 
>> The third box I realised this problem is a brand new Fujitsu Esprimo Q956, also
>> AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or 20180525).
>> 
>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
>> UEFI-only boot method on a GPT partitioned device fails. The ASRock boards jump
>> immediately into the firmware, the Fujitsu offers some kind of CPU/Memory/HDD
>> test facility.
>> 
>> If on both type of vendor/boards CSM is disabled and UEFI boot only is implied,
>> the MBR partitioned FreeBSD installation USB flash device does boot in UEFI! I
>> guess I can assume this when the well known clumsy 80x25 char console suddenly
>> gets bright and shiny with a much higher resoltion as long the GPU supports
>> EFI GOP. Looking with gpart at the USB flash drives reveals that the EFI
>> partition starts at block 1 of the device and the device has a MBR layout. I
>> haven't found a way to force the GPT scheme, when initialised via gpart, to let
>> the partitions start at block 1. This might be a naiv thinking, so please be
>> patient with me.
>> 
>> I do not know whether this is a well-known issue. On the ASRock boards, I
>> tried years ago some LinuxRed Hat and Suse with UEFI and that worked - FreeBSD
>> not. I gave up on that that time. Now, having the very same issues with a new
>> Fujitsu system, leaves me with the impression that FreeBSD's UEFI
>> implementation might have problems I'm not aware of.
>> 
>> Can someone shed some light onto this? 
>> 
>> Thanks in advance,
>> 
>> Oliver 
>> _______________________________________________
>> freebsd-current at freebsd.org mailing list
>> https://lists.freebsd.org/mailman/listinfo/freebsd-current
>> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
>> 
> 
> If you are up for experimenting, see if either of these results in your
> system booting:
> gpart set -a active ada0
> gpart set -a lenovofix ada0
> 
> Although both of these should only impact BIOS boot, not UEFI, you never
> know.
> 
> The other option is to try an ESP (EFI System Partition) that is
> formatted FAT32 instead of FAT12/FAT16)
> 
> 

oops, indeed, and not just FAT32, but rather large one; first, the minimum size for FAT32 is ~32MB - it can not be smaller, and with 4kn you can not get below 256MB:)

but, I recall there were some reports about systems refusing to boot if ESP was not FAT32. I can not remember if there was some size limit involved too or not (the UEFI specification does not set requirements for ESP size).

my 2cents,
toomas


From o.hartmann at walstatt.org  Tue Jul 24 12:23:09 2018
From: o.hartmann at walstatt.org (O. Hartmann)
Date: Tue, 24 Jul 2018 14:22:59 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <fd135b65-bc86-0e73-a6a4-c420304b8d30@freebsd.org>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <fd135b65-bc86-0e73-a6a4-c420304b8d30@freebsd.org>
Message-ID: <20180724142255.23e120c6@freyja.zeit4.iv.bundesimmobilien.de>

On Tue, 24 Jul 2018 02:20:00 -0400
Allan Jude <allanjude at freebsd.org> wrote:

> On 2018-07-13 07:00, O. Hartmann wrote:
> > The problem is some kind of weird. I face UEFI boot problems on GPT drives
> > where the first partition begins at block 40 of the hdd/ssd.
> > 
> > I have two host in private use based on an
> > outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> > LGA1155). Both boards are equipted with the lates official available AMI
> > firmware revision, dating to 2013. This is for the Z77-Pro4-M revision 2.0
> > (2013/7/23) and for the Z77 Pro4 revision 1.8 (2013/7/17). For both boards
> > a BETA revision for the Spectre/Meltdown mitigation is available, but I
> > didn't test that. But please read.
> > 
> > The third box I realised this problem is a brand new Fujitsu Esprimo Q956,
> > also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date 05/25/2018 (or
> > 20180525).
> > 
> > Installing on any kind of HDD or SSD manually or via bsdinstall the OS using
> > UEFI-only boot method on a GPT partitioned device fails. The ASRock boards
> > jump immediately into the firmware, the Fujitsu offers some kind of
> > CPU/Memory/HDD test facility.
> > 
> > If on both type of vendor/boards CSM is disabled and UEFI boot only is
> > implied, the MBR partitioned FreeBSD installation USB flash device does
> > boot in UEFI! I guess I can assume this when the well known clumsy 80x25
> > char console suddenly gets bright and shiny with a much higher resoltion as
> > long the GPU supports EFI GOP. Looking with gpart at the USB flash drives
> > reveals that the EFI partition starts at block 1 of the device and the
> > device has a MBR layout. I haven't found a way to force the GPT scheme,
> > when initialised via gpart, to let the partitions start at block 1. This
> > might be a naiv thinking, so please be patient with me.
> > 
> > I do not know whether this is a well-known issue. On the ASRock boards, I
> > tried years ago some LinuxRed Hat and Suse with UEFI and that worked -
> > FreeBSD not. I gave up on that that time. Now, having the very same issues
> > with a new Fujitsu system, leaves me with the impression that FreeBSD's UEFI
> > implementation might have problems I'm not aware of.
> > 
> > Can someone shed some light onto this? 
> > 
> > Thanks in advance,
> > 
> > Oliver 
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> >   
> 
> If you are up for experimenting, see if either of these results in your
> system booting:
> gpart set -a active ada0
> gpart set -a lenovofix ada0
> 
> Although both of these should only impact BIOS boot, not UEFI, you never
> know.
> 
> The other option is to try an ESP (EFI System Partition) that is
> formatted FAT32 instead of FAT12/FAT16)

How can I detect the format of the EFI partition? Suppose I create the EFI
partition via gpart, 12-CURRENT installer or 11.2-RELENG installer, what format
would that EFI partition be (the partition scheme I use is always GPT so far
and as far as I know)? What format is the result, if I would
dd /boot/boot1.efifat to the EFI partition?

From a first glimpse I guess its FAT12/16, since creating an EFI partition via
gpart myself of 500m and try to newfs_msdos -F 32, I receive an error about
insufficient clusters with no further parameters. I tried to create a 512m
partition fiddling around with the blocksize option -b of newfs_msdos

When created manually /dev/gpt/efiboot0, formatted FAT32 (with -b 512 or -b
1024, I forgot) and preparing/copying the content of /boot/boot1.efifat
(mdconfig mounted ...) with proper folder structure to efi/boot/ on the newly
created FAT32 formatted EFI partition, I struggle then with a quick
installation of FreeBSD using "bsdinstall". Having created according to a pure
ZFS disk swap, gptboot (to be on the secure side if UEFI fails again) and a
zroot ZFS pool, the dumb installer doesn't let me create a filesystem structure
on ZFS for the installation without destroying the initial layout :-( 

So I stopped at that point and tried booting the box with only the FAT32
EFI/ESP partition with the loader copied from boot1.efifat as described. 

The result is annoying, the ESPRIMO Q956 firmware shows up with some kind of
testing tool/shell as reported in the initial posting of mine. I'd have
expected some signs from the FreeBSD UEFI bootloader so far at this point, but
I might be mislead here.

I also have applied the "gpart set -a" commands, without any effect.

> 


From julian at freebsd.org  Tue Jul 24 16:40:29 2018
From: julian at freebsd.org (Julian Elischer)
Date: Wed, 25 Jul 2018 00:40:11 +0800
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <F5832A14-009D-4FD2-BCE7-D07F96165041@FreeBSD.org>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
 <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
 <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
 <F5832A14-009D-4FD2-BCE7-D07F96165041@FreeBSD.org>
Message-ID: <0a54cb6e-f528-df63-57f2-6caa3d76ff6c@freebsd.org>

On 22/7/18 4:32 am, Dimitry Andric wrote:
> On 21 Jul 2018, at 21:11, Yuri Pankov <yuripv at yuripv.net> wrote:
>> Yuri Pankov wrote:
>>> Julian Elischer wrote:
> ...
>>>>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
>>> In later GCC versions the cpp's -lang-asm seems to be deprecated in
>>> favor of -x assembler-with-cpp as it conflicts with -l option.
>>> Could you try changing the -Wp,-E,-lang-asm to -Wp,-E,-xassembler-with-cpp?
>> Just tried it myself, and if you indeed mean the third_party/aesni-intel/aesni-intel_asm.c, the following seems to work for me:
>>
>> clang -xassembler-with-cpp -c third_party/aesni-intel/aesni-intel_asm.c
> Yes, that is exactly what I suggested to Julian on IRC.  The point is
> that the ".c" extension is misleading, it should more likely be a ".S"
> extension.  But maybe this source file is used for multiple purposes.
>
> Note that -x assembler-with-cpp should also work fine for gcc.
>
> -Dimitry
>
thanks

I tried that but the version of the file we have has several lines 
that caused problems...

a lot of the assembler has assembler comments (starting with '#') 
which clang complained about and died..

it also had #.align 4

which I HOPE is just a commented out line..

From emaste at freebsd.org  Tue Jul 24 17:44:17 2018
From: emaste at freebsd.org (Ed Maste)
Date: Tue, 24 Jul 2018 13:43:55 -0400
Subject: i386 top reporting nan% or inf% WCPU
Message-ID: <CAPyFy2Bo2H+iUmMt22vkg4c5tg+ymPLUEz7Qxr-VFKU1WHX0TQ@mail.gmail.com>

I recently merged my work in progress tree up to r336665 and built a
i386 VM image. Running the image in QEMU (qemu-system-x86_64) and
executing 'top' I see the WCPU column reported as either nan% or inf%
for all processes.

Prior to today I hadn't built or tested i386 in a while, so I am not
sure off hand if this is a recent issue. amd64 is fine. Is anyone else
seeing this?

From kostikbel at gmail.com  Tue Jul 24 18:17:11 2018
From: kostikbel at gmail.com (Konstantin Belousov)
Date: Tue, 24 Jul 2018 21:17:03 +0300
Subject: i386 top reporting nan% or inf% WCPU
In-Reply-To: <CAPyFy2Bo2H+iUmMt22vkg4c5tg+ymPLUEz7Qxr-VFKU1WHX0TQ@mail.gmail.com>
References: <CAPyFy2Bo2H+iUmMt22vkg4c5tg+ymPLUEz7Qxr-VFKU1WHX0TQ@mail.gmail.com>
Message-ID: <20180724181703.GK65334@kib.kiev.ua>

On Tue, Jul 24, 2018 at 01:43:55PM -0400, Ed Maste wrote:
> I recently merged my work in progress tree up to r336665 and built a
> i386 VM image. Running the image in QEMU (qemu-system-x86_64) and
> executing 'top' I see the WCPU column reported as either nan% or inf%
> for all processes.
> 
> Prior to today I hadn't built or tested i386 in a while, so I am not
> sure off hand if this is a recent issue. amd64 is fine. Is anyone else
> seeing this?

I believe this is a qemu bug.  Their FPU emulation is very basic, at least
it was so several years ago, when not using accelerated emulation.

From Cy.Schubert at cschubert.com  Tue Jul 24 20:02:06 2018
From: Cy.Schubert at cschubert.com (Cy Schubert)
Date: Tue, 24 Jul 2018 13:01:47 -0700
Subject: i386 top reporting nan% or inf% WCPU
In-Reply-To: Message from Konstantin Belousov <kostikbel@gmail.com>
 of "Tue, 24 Jul 2018 21:17:03 +0300." <20180724181703.GK65334@kib.kiev.ua>
Message-ID: <201807242001.w6OK1lFG002262@slippy.cwsent.com>

In message <20180724181703.GK65334 at kib.kiev.ua>, Konstantin Belousov 
writes:
> On Tue, Jul 24, 2018 at 01:43:55PM -0400, Ed Maste wrote:
> > I recently merged my work in progress tree up to r336665 and built a
> > i386 VM image. Running the image in QEMU (qemu-system-x86_64) and
> > executing 'top' I see the WCPU column reported as either nan% or inf%
> > for all processes.
> > 
> > Prior to today I hadn't built or tested i386 in a while, so I am not
> > sure off hand if this is a recent issue. amd64 is fine. Is anyone else
> > seeing this?
>
> I believe this is a qemu bug.  Their FPU emulation is very basic, at least
> it was so several years ago, when not using accelerated emulation.

Just tested on the i386 slice on my laptop. No problems there.


-- 
Cheers,
Cy Schubert <Cy.Schubert at cschubert.com>
FreeBSD UNIX:  <cy at FreeBSD.org>   Web:  http://www.FreeBSD.org

	The need of the many outweighs the greed of the few.



From fbsd at www.zefox.net  Tue Jul 24 20:11:07 2018
From: fbsd at www.zefox.net (bob prohaska)
Date: Tue, 24 Jul 2018 13:11:13 -0700
Subject: ntpd as ntpd user question
In-Reply-To: <CAN6yY1s12iehNc2XgT762oQ5AVH6LD_fC7L2zm5Jkgnr=vrSCg@mail.gmail.com>
References: <1532193285.1344.83.camel@freebsd.org>
 <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org>
 <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net>
 <87r2jtiw59.wl-herbert@gojira.at>
 <20180724015428.GB47869@www.zefox.net>
 <1532399159.1344.211.camel@freebsd.org>
 <CAN6yY1s12iehNc2XgT762oQ5AVH6LD_fC7L2zm5Jkgnr=vrSCg@mail.gmail.com>
Message-ID: <20180724201113.GA52627@www.zefox.net>

On Mon, Jul 23, 2018 at 09:28:41PM -0700, Kevin Oberman wrote:
> On Mon, Jul 23, 2018 at 7:25 PM, Ian Lepore <ian at freebsd.org> wrote:
> 
> > On Mon, 2018-07-23 at 18:54 -0700, bob prohaska wrote:
> > > On Mon, Jul 23, 2018 at 09:34:26PM +0200, Herbert J. Skuhra wrote:
> > > >
> > > >
> > > > Yes, first you press m. Then you will see differences of installed
> > > > file (left) and new file (right). Then you press either l or
> > > > r:
> > > >
> > > > l | 1:      choose left diff
> > > > r | 2:      choose right diff
> > > >
> > > > If the diff tries to remove/add to many lines you can:
> > > >
> > > > el: edit left diff
> > > > er: edit right diff
> > > >
> > > > And if done you can view the merged file (v) before installing (i)
> > > > it.
> > > >
> > > > I am sure, someone can explain it better! :)
> > > >
> > > Perhaps, but you've made the essential point. Your reply let me
> > > understand that
> > > mergemaster does not really "master" the merge, it rather identifies
> > > files needing
> > > to be merged and then starts sdiff to let me modify files. Never
> > > having even looked
> > > at sdiff, the learning curve proved very steep. Too steep, in fact.
> > >
> > > I'm going to try a more incremental approach.
> > >
> > > Thank you _very_ much!
> > >
> > > bob prohaska
> >
> > Your reaction to mergemaster is about the same as mine was when I first
> > encountered it very long ago, and re-discovered when I tried it a
> > couple years ago. It just seems like more trouble than it's worth, I
> > can usually figure out what's broken and fix it by hand faster than
> > messing with all the merge stuff.
> >
> > But, someone told me that if you give mergemaster the right flags it
> > can potentially be intervention-free. Those apparently aren't the flag
> > or two that're suggested at the bottom of UPDATING. So I didn't really
> > dig into that any deeper, but I toss it out there in case someone can
> > expand on it.
> >
> > It certainly makes some sense that it could be done intervention-free.
> > When doing other diff-based merges (like 'svn update') you only have to
> > intervene when there's an actual conflict between some local change
> > you've made and the incoming changes.
> >
> >
> It gets a LOT simpler if you use "mergemaster -iPUF" Only those files you
> have modified will show up. In most cases, it just zips right by. In most
> that it does not, the use of 'r' or 'l' in merge is all you need and always
> 'r' eccepton lines you have modified, yourself, so you should know about
> them.
> 
I realize your comments are directed to Ian and not me, so please take these
$.02 for no more than they're worth. 

My problems with mergemaster are _not_ with mergemaster. They're with sdiff.
The window presented, along with the prompts, are simply bewildering. I suspect
that someboey truly fluent with vi would recognize what's going on at once and
have no trouble. I've used vi for a long time, but only in the most naive way,
and sdiff's man page is little help for a newcomer. Even a Web search for tutorials
found nothing very useful, at least not quickly. 

A plain language discription of what sdif does and how might make the minutia of the
man page comprehensible to non-experts. 

Apologies if I'm belaboring the obvious, and thanks for reading!

bob prohaska


From ronald-lists at klop.ws  Tue Jul 24 21:04:25 2018
From: ronald-lists at klop.ws (Ronald Klop)
Date: Tue, 24 Jul 2018 23:04:16 +0200
Subject: ntpd as ntpd user question
In-Reply-To: <CAN6yY1s12iehNc2XgT762oQ5AVH6LD_fC7L2zm5Jkgnr=vrSCg@mail.gmail.com>
References: <5b90c49f-4616-9ef7-28a1-6445137245ef@nomadlogic.org>
 <1532191655.1344.80.camel@freebsd.org>
 <4b7acbd2-0230-345c-4370-24a72d0b492a@nomadlogic.org>
 <1532193285.1344.83.camel@freebsd.org> <20180721174722.GA40167@www.zefox.net>
 <1532196850.1344.87.camel@freebsd.org> <20180721220925.GA40238@www.zefox.net>
 <20180721234941.2ojf76kxxqfhnys7@mail.bsd4all.net>
 <20180723045552.GA44941@www.zefox.net> <87r2jtiw59.wl-herbert@gojira.at>
 <20180724015428.GB47869@www.zefox.net> <1532399159.1344.211.camel@freebsd.org>
 <CAN6yY1s12iehNc2XgT762oQ5AVH6LD_fC7L2zm5Jkgnr=vrSCg@mail.gmail.com>
Message-ID: <op.zmoctee5kndu52@klop.ws>

On Tue, 24 Jul 2018 06:28:41 +0200, Kevin Oberman <rkoberman at gmail.com>  
wrote:

> On Mon, Jul 23, 2018 at 7:25 PM, Ian Lepore <ian at freebsd.org> wrote:
>
>> On Mon, 2018-07-23 at 18:54 -0700, bob prohaska wrote:
>> > On Mon, Jul 23, 2018 at 09:34:26PM +0200, Herbert J. Skuhra wrote:
>> > >
>> > >
>> > > Yes, first you press m. Then you will see differences of installed
>> > > file (left) and new file (right). Then you press either l or
>> > > r:
>> > >
>> > > l | 1:      choose left diff
>> > > r | 2:      choose right diff
>> > >
>> > > If the diff tries to remove/add to many lines you can:
>> > >
>> > > el: edit left diff
>> > > er: edit right diff
>> > >
>> > > And if done you can view the merged file (v) before installing (i)
>> > > it.
>> > >
>> > > I am sure, someone can explain it better! :)
>> > >
>> > Perhaps, but you've made the essential point. Your reply let me
>> > understand that
>> > mergemaster does not really "master" the merge, it rather identifies
>> > files needing
>> > to be merged and then starts sdiff to let me modify files. Never
>> > having even looked
>> > at sdiff, the learning curve proved very steep. Too steep, in fact.
>> >
>> > I'm going to try a more incremental approach.
>> >
>> > Thank you _very_ much!
>> >
>> > bob prohaska
>>
>> Your reaction to mergemaster is about the same as mine was when I first
>> encountered it very long ago, and re-discovered when I tried it a
>> couple years ago. It just seems like more trouble than it's worth, I
>> can usually figure out what's broken and fix it by hand faster than
>> messing with all the merge stuff.
>>
>> But, someone told me that if you give mergemaster the right flags it
>> can potentially be intervention-free. Those apparently aren't the flag
>> or two that're suggested at the bottom of UPDATING. So I didn't really
>> dig into that any deeper, but I toss it out there in case someone can
>> expand on it.
>>
>> It certainly makes some sense that it could be done intervention-free.
>> When doing other diff-based merges (like 'svn update') you only have to
>> intervene when there's an actual conflict between some local change
>> you've made and the incoming changes.
>>
>>
> It gets a LOT simpler if you use "mergemaster -iPUF" Only those files you
> have modified will show up. In most cases, it just zips right by. In most
> that it does not, the use of 'r' or 'l' in merge is all you need and  
> always
> 'r' eccepton lines you have modified, yourself, so you should know about
> them.
>
> I should note that 'U' does have a small "race" in it, so it i possible  
> to
> get biten by it, but it is very unlikely. Has to do with multiple commits
> that touch the same lines in the file in a timing that is out of sync  
> with
> your running it. I use '-iPF' because I m paranoid.


$ cat /etc/mergemaster.rc
AUTO_INSTALL=yes
AUTO_UPGRADE=yes
COMP_CONFS=yes
FREEBSD_ID=yes
IGNORE_FILES='/etc/motd /etc/printcap'


This helps me a lot.

Cheers,
Ronald.



> --
> Kevin Oberman, Part time kid herder and retired Network Engineer
> E-mail: rkoberman at gmail.com
> PGP Fingerprint: D03FB98AFA78E3B78C1694B318AB39EF1B055683
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to  
> "freebsd-current-unsubscribe at freebsd.org"

From marklmi at yahoo.com  Wed Jul 25 05:53:10 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Tue, 24 Jul 2018 22:32:48 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand type
 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
Message-ID: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>

https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
(head -r336573 after the prior 6596's -r336565 ):

--- all_subdir_lib/ofed ---
In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
                 from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
/workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
/workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
  atomic_store(&lock->cnt, 0);
  ^
In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
/workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
/workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
  if (atomic_fetch_add(&lock->cnt, 1) > 0)
  ^~
/workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
/workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
  ^~
. . .
--- all_subdir_lib/ofed ---
*** [acm.o] Error code 1


https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
-r336700 ) still shows this type of error.

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From marklmi at yahoo.com  Wed Jul 25 06:39:30 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Tue, 24 Jul 2018 23:39:21 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
Message-ID: <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>

On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:

> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
> (head -r336573 after the prior 6596's -r336565 ):
> 
> --- all_subdir_lib/ofed ---
> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>                 from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>  atomic_store(&lock->cnt, 0);
>  ^
> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>  if (atomic_fetch_add(&lock->cnt, 1) > 0)
>  ^~
> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>  ^~
> . . .
> --- all_subdir_lib/ofed ---
> *** [acm.o] Error code 1
> 
> 
> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
> -r336700 ) still shows this type of error.


[I should have a subject with "head -r336568 through -r336570 . . .".]

From what I can tell looking around having something like:

if (atomic_fetch_add(&lock->cnt, 1) > 0)

involve a __atomic_fetch_add indicates that:

/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h

was in use instead of FreeBSD's stdatomic.h file.

If this is right, then the issue may be tied to head -r335782
implicitly changing the order of the include file directory
searching for builds via the devel/*-gcc .

(I reverted -r335782 in my environment some time ago and have
not run into this problem in my context so far.)

===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From ohartmann at walstatt.org  Wed Jul 25 08:12:46 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Wed, 25 Jul 2018 09:59:32 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
 <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
Message-ID: <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>

On Tue, 24 Jul 2018 08:53:36 +0300
Toomas Soome <tsoome at me.com> wrote:


Hello  Toomas Soome,

I CC Allan Jude since I discovered something  weird today regarding the UEFI
boot capabilities of USB flash devices and SSDs. See below.
 
> > On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Mon, 23 Jul 2018 10:56:04 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> >   
> >>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>   
> >>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>> 
> >>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>> Hash: SHA512
> >>>>> 
> >>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com> <mailto:tsoome at me.com
> >>>>> <mailto:tsoome at me.com>>> schrieb:   
> >>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>> 
> >>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
> >>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
> >>>>>>> 
> >>>>>>> I have two host in private use based on an
> >>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>>>>>> LGA1155). Both boards are equipted with the lates official available
> >>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
> >>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
> >>>>>>> (2013/7/17). For both boards a BETA revision for the Spectre/Meltdown
> >>>>>>> mitigation is available, but I didn't test that. But please read.
> >>>>>>> 
> >>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>>>>>> 05/25/2018 (or 20180525).
> >>>>>>> 
> >>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
> >>>>>>> using UEFI-only boot method on a GPT partitioned device fails. The
> >>>>>>> ASRock boards jump immediately into the firmware, the Fujitsu offers
> >>>>>>> some kind of CPU/Memory/HDD test facility.
> >>>>>>> 
> >>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
> >>>>>>> implied, the MBR partitioned FreeBSD installation USB flash device
> >>>>>>> does boot in UEFI! I guess I can assume this when the well known
> >>>>>>> clumsy 80x25 char console suddenly gets bright and shiny with a much
> >>>>>>> higher resoltion as long the GPU supports EFI GOP. Looking with gpart
> >>>>>>> at the USB flash drives reveals that the EFI partition starts at
> >>>>>>> block 1 of the device and the device has a MBR layout. I haven't
> >>>>>>> found a way to force the GPT scheme, when initialised via gpart, to
> >>>>>>> let the partitions start at block 1. This might be a naiv thinking,
> >>>>>>> so please be patient with me.
> >>>>>>> 
> >>>>>>> I do not know whether this is a well-known issue. On the ASRock
> >>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
> >>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
> >>>>>>> the very same issues with a new Fujitsu system, leaves me with the
> >>>>>>> impression that FreeBSD's UEFI implementation might have problems I'm
> >>>>>>> not aware of.
> >>>>>>> 
> >>>>>>> Can someone shed some light onto this? 
> >>>>>>>   
> >>>>>> 
> >>>>>> The first thing to check is if the secure boot is disabled. We do not
> >>>>>> support secure boot at all at this time.      
> >>>>> 
> >>>>> Secure boot is in every scenario disabled!
> >>>>>   
> >>>>>> 
> >>>>>> If you have efi or bios version running - you can check from either
> >>>>>> console variable value (it can have efi or vidconsole or comconsole) or
> >>>>>> better yet, see if efi-version is set (show efi-version) - if
> >>>>>> efi-version is not set, it is BIOS loader running. Another indirect
> >>>>>> way is to see lsdev -v, with device paths present, it is uefi:)      
> >>>>> 
> >>>>> What are you talking about?
> >>>>> What is the point of entry - running system, loader?
> >>>>> 
> >>>>> sysct machdep.bootmethod: BIOS
> >>>>> 
> >>>>> This makes me quite sure that the system has booted via BIOS - as I'm
> >>>>> sure since I've checked that many times. UEFI doesn't work on those
> >>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
> >>>>> on those mainboards booting via UEFI - and I might recall that they
> >>>>> failed also. I also recall that there were issues with earlier UEFI
> >>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
> >>>>> the fact that Linux worked confuses me a bit.
> >>>>> 
> >>>>> If this ASRock crap (never ever again this brand!) doesn't work at all -
> >>>>> who cares, I intend to purchase new server grade hardware. But the more
> >>>>> puzzling issue is with the Fujitsu, which I consider serious and from
> >>>>> the behaviour the Fujitsu failure looks exactly like the ASRock -
> >>>>> Windows 7 works, RedHat 7.5 works (I assume I can trust the Firmware
> >>>>> settings when I disable CSM support, that the Firmware will only
> >>>>> EFI/UEFI capable loader? Or is there a ghosty override somwhere to be
> >>>>> expected?). Also on ASRock disabling CSM should ensure not booting a
> >>>>> dual-bootstrap-capable system. This said, on the recent Fujitsu, it
> >>>>> seems to boil down to a FreeBSD UEFI-firmware interaction problem,
> >>>>> while the ASRock is still under suspicion to be broken by design.     
> >>>>>> 
> >>>>>> GPT partitions can never start from disk absolute sector 1; this is
> >>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >>>>>> table and then sectors 2-33 have GPT partition table entries, so the
> >>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
> >>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.      
> >>>>> 
> >>>>> Thanks for the explanation. That implies the installer did right, gpart
> >>>>> did also right and therefore there must be an issue with the stuff
> >>>>> located within the EFI partition?     
> >>>> 
> >>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
> >>>> loader at all or not - that is, if the BIOS bootstrap is actually caring
> >>>> to read the MBR code and start it, since once the MBR code is started,
> >>>> it is all about our code.    
> >>> 
> >>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you
> >>> mean that specific portion of the UEFI firmware, which looks for the
> >>> proper UEFI partition?
> >>>   
> >> 
> >> BIOS as either native or CSM. Note that from boot code point of view the
> >> CSM boot *is* BIOS boot, we have no access to UEFI features.
> >>   
> >>> 
> >>> The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
> >>> refuse booting UEFI, even if properly setup (in terms of what FreeBSD
> >>> provides on recent CURRENT) is applied and CSM is switched off in the
> >>> firmware. Again: GPT partition scheme.
> >>> 
> >>> The system boots properly if a second partition of type "freebsd-boot" is
> >>> applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
> >>> -p /boot/gptboot -i 2 ada0" (ada0 is the device).     
> >>>> 
> >>>> btw, you can try to validate the installed boot blocks by using recent
> >>>> enough loader (usb or iso) and then you can use from OK prompt:    
> >>> 
> >>> lsdev provides me with the follwoing informations (CSM enabled):
> >>> 
> >>> OK lsdev
> >>> disk devices:
> >>> 	disk0:		BIOS DRIVE C ...
> >>> 
> >>> 		disk0p1:	EFI
> >>> 		disk0p2:	FreeBSD BOOT
> >>> 		disk0p3:	FreeBSD SWAP
> >>> 		disk0p4:	FreeBSD ZFS
> >>> zfs devices:
> >>> 	zfs:zroot
> >>> 
> >>> OK chain disk0
> >>> open failed     (so for disk0p{1-4}.
> >>> 
> >>> OK chain zroot
> >>> failed to read disk (just for completeness)    
> >> 
> >> 
> >> chain command does use only device name (such as disk0: or disk0p2: ), but
> >> not zfs pool as device.  I just found I haven?t ported the code to read the
> >> file.  
> > 
> > ??
> >   
> >> 
> >> the point for chain command test is to see if the normal read and execute
> >> would work, so in your case please try:
> >> 
> >> chain disk0:  
> > 
> > As stated above, I did so, and the result is also mentioned above, I always
> > get "open failed".
> > This is the same for 
> > 
> > chain disk0
> > chain disk0p1
> > chain disk0p2
> > chain disk0p3
> > chain disk0p4
> > 
> > as already said. CSM is enabled in this case.  
> 
> sigh? chain command does take device as argument, device must always end with
> colon?. in this case, the devil is in details:) as I wrote above, the command
> should be:
> 
> chain disk0:
> 
> The disk0p1: etc will only work when partition boot code was installed (which
> you most likely do not have - the only possible candidate could be FreeBSD
> ZFS partition).

The command "chain disk0:" works as expected (CSM enabled, GPT partition
scheme, but with PMBR bootblock installed and freebsd-boot partition conatining
gptzfsboot installed.


> 
> >   
> >> 
> >> to read pmbr (512B) and execute it. The expected outcome would be that pmbr
> >> boot code would browse the GPT, read stage1 from disk0p2: and execute it;
> >> stage1 would detect FreeBSD ZFS from disk0p4: and load and
> >> execute /boot/loader. If that will happen, it means the boot code in our
> >> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
> >> true, it would mean that you either need to use UEFI boot or need to have
> >> some hack to fool the BIOS or just not use GPT on that machine with CSM.  
> > 
> > To make it clear here: The only way to boot this box is using CSM (as it is
> > the same with the ASRock boards mentioned earlier). But my intention is to
> > disable CSM and use a GPT/UEFI environment only! And GPT/UEFI doesn't work
> > with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
> > 
> > It would be nice if this could be fixed. I'm more interested in the fix on
> > the recent Fujitsu device than the outdated ASRock crap, but if the fix for
> > the Fujitsu Firmware could fix older issues as a byproduct, I'd appreciate
> > that.
> > 
> > Kind regards,
> >   
> 
> ok, somehow I have lost that part of the discussion. Well, you wrote that the
> UEFI boot fails when the first partition starts from sector 40 - does it mean
> you have boot when the partition will start from some other sector? I think,
> there is something else going on.

Well, I simply try to describe what I "see" to make things disambiguous. I'm
not familiar with the deeper insights of disk layouts on a binary level. So,
you explained to me the reason, why ESP (EGI partition) starts at block 40. I
compared that to the FreeBSD USB flash image FreeBSD provides, but this is
another story since the image uses MBR scheme as I figured out.
 

> 
> What you can do is to see if that firmware will offer you EFI shell option,
> from there you can try to start the bootx64.efi manually and see what error
> you will get. However, the number 1 cause for failing to start the bootloader
> in UEFI is secure boot - we do not support it and secure boot must be
> switched off. 
> 
> However, they seem to claim "The Secure Boot option is available in the
> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
> 
> Still suggest to double check if thats really the case. Also, if the
> bootx64.efi start will fail and no messages are appearing on screen, then
> either there is something in firmware logs or you could get them from trying
> to start bootx64.efi from UEFI shell.

Since I'm with this problem since 2014 and try from time to time, be ausred
that I tried every possible permutationof all reasonable options, even those
nonsense, to get rid of that problem.

I never had any problems with any other UEFI capable server/workstation
firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme, CSM
disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956 with
the most recent firmware (as of lat week, week 29 of 2018) having the very same
problems. 



I figured out something strange on the Fujitsu - and that is the same with the
ASRock boards.

We/I prepare some USB flash drives to boot a NanoBSD for a very small
appliance, but nevertheless, the USB flash device is booted on Fujitsu servers
with UEFI-only configurations. I assume at this point that disabling on the
most recent Fujitsu firmwares on reasonable "new" hardware (not older than
three years) will disable any(!) legacy BIOS capabilities. The same is assumed
for the Fujitus ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
mentioned above/earlier, they are from 2012/2013 and "quite old".

The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
partition scheme of the flash device is GPT. The layout looks like this:

gpart show -l da4
=>      40  15425456  da4  GPT  (7.4G)
        40      2000    1  efiboot0  (1.0M)
      2040   1453584    3  disk1a  (710M)
   1455624      4096    5  disk3  (2.0M)
   1459720  13965776       - free -  (6.7G)

I created the flash with md, gpart and dd straightforward, efiboot0 is the ESP
partition and its format/content is created via dd if=/boot/boot1.efifat
of=/dev/da4p1 - I presume this is very simple.

This USB flash device boots(!) successfully (UEFI!) on both the ASRock boards
and the Esprimo Q956!

But any SSD prepared the same way doesn't. Why? 

On the ASRock, I recall having fiddled around with HDD also for a while
conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
remember. 

In the lack of proper hardware I'm unable to check whether USB-attached HDD or
SSD will boot or HDD will boot (just in case the local SATA has problems
booting UEFI and USB not).

Kind regards,

Oliver 

> 
> thds,
> toomas
[...]


From tsoome at me.com  Wed Jul 25 08:46:20 2018
From: tsoome at me.com (Toomas Soome)
Date: Wed, 25 Jul 2018 11:46:07 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
 <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
 <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <2FCF2BCC-05E5-466A-B1AE-90300990ED1A@me.com>



> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Tue, 24 Jul 2018 08:53:36 +0300
> Toomas Soome <tsoome at me.com> wrote:
> 
> 
> Hello  Toomas Soome,
> 
> I CC Allan Jude since I discovered something  weird today regarding the UEFI
> boot capabilities of USB flash devices and SSDs. See below.
> 
>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> On Mon, 23 Jul 2018 10:56:04 +0300
>>> Toomas Soome <tsoome at me.com> wrote:
>>> 
>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>> 
>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>>>> 
>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>>>> 
>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>>> Hash: SHA512
>>>>>>> 
>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com> <mailto:tsoome at me.com
>>>>>>> <mailto:tsoome at me.com>>> schrieb:   
>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>>>> 
>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
>>>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
>>>>>>>>> 
>>>>>>>>> I have two host in private use based on an
>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
>>>>>>>>> LGA1155). Both boards are equipted with the lates official available
>>>>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
>>>>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
>>>>>>>>> (2013/7/17). For both boards a BETA revision for the Spectre/Meltdown
>>>>>>>>> mitigation is available, but I didn't test that. But please read.
>>>>>>>>> 
>>>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
>>>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
>>>>>>>>> 05/25/2018 (or 20180525).
>>>>>>>>> 
>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the OS
>>>>>>>>> using UEFI-only boot method on a GPT partitioned device fails. The
>>>>>>>>> ASRock boards jump immediately into the firmware, the Fujitsu offers
>>>>>>>>> some kind of CPU/Memory/HDD test facility.
>>>>>>>>> 
>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only is
>>>>>>>>> implied, the MBR partitioned FreeBSD installation USB flash device
>>>>>>>>> does boot in UEFI! I guess I can assume this when the well known
>>>>>>>>> clumsy 80x25 char console suddenly gets bright and shiny with a much
>>>>>>>>> higher resoltion as long the GPU supports EFI GOP. Looking with gpart
>>>>>>>>> at the USB flash drives reveals that the EFI partition starts at
>>>>>>>>> block 1 of the device and the device has a MBR layout. I haven't
>>>>>>>>> found a way to force the GPT scheme, when initialised via gpart, to
>>>>>>>>> let the partitions start at block 1. This might be a naiv thinking,
>>>>>>>>> so please be patient with me.
>>>>>>>>> 
>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
>>>>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
>>>>>>>>> the very same issues with a new Fujitsu system, leaves me with the
>>>>>>>>> impression that FreeBSD's UEFI implementation might have problems I'm
>>>>>>>>> not aware of.
>>>>>>>>> 
>>>>>>>>> Can someone shed some light onto this? 
>>>>>>>>> 
>>>>>>>> 
>>>>>>>> The first thing to check is if the secure boot is disabled. We do not
>>>>>>>> support secure boot at all at this time.      
>>>>>>> 
>>>>>>> Secure boot is in every scenario disabled!
>>>>>>> 
>>>>>>>> 
>>>>>>>> If you have efi or bios version running - you can check from either
>>>>>>>> console variable value (it can have efi or vidconsole or comconsole) or
>>>>>>>> better yet, see if efi-version is set (show efi-version) - if
>>>>>>>> efi-version is not set, it is BIOS loader running. Another indirect
>>>>>>>> way is to see lsdev -v, with device paths present, it is uefi:)      
>>>>>>> 
>>>>>>> What are you talking about?
>>>>>>> What is the point of entry - running system, loader?
>>>>>>> 
>>>>>>> sysct machdep.bootmethod: BIOS
>>>>>>> 
>>>>>>> This makes me quite sure that the system has booted via BIOS - as I'm
>>>>>>> sure since I've checked that many times. UEFI doesn't work on those
>>>>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
>>>>>>> on those mainboards booting via UEFI - and I might recall that they
>>>>>>> failed also. I also recall that there were issues with earlier UEFI
>>>>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
>>>>>>> the fact that Linux worked confuses me a bit.
>>>>>>> 
>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at all -
>>>>>>> who cares, I intend to purchase new server grade hardware. But the more
>>>>>>> puzzling issue is with the Fujitsu, which I consider serious and from
>>>>>>> the behaviour the Fujitsu failure looks exactly like the ASRock -
>>>>>>> Windows 7 works, RedHat 7.5 works (I assume I can trust the Firmware
>>>>>>> settings when I disable CSM support, that the Firmware will only
>>>>>>> EFI/UEFI capable loader? Or is there a ghosty override somwhere to be
>>>>>>> expected?). Also on ASRock disabling CSM should ensure not booting a
>>>>>>> dual-bootstrap-capable system. This said, on the recent Fujitsu, it
>>>>>>> seems to boil down to a FreeBSD UEFI-firmware interaction problem,
>>>>>>> while the ASRock is still under suspicion to be broken by design.     
>>>>>>>> 
>>>>>>>> GPT partitions can never start from disk absolute sector 1; this is
>>>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
>>>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
>>>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
>>>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.      
>>>>>>> 
>>>>>>> Thanks for the explanation. That implies the installer did right, gpart
>>>>>>> did also right and therefore there must be an issue with the stuff
>>>>>>> located within the EFI partition?     
>>>>>> 
>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
>>>>>> loader at all or not - that is, if the BIOS bootstrap is actually caring
>>>>>> to read the MBR code and start it, since once the MBR code is started,
>>>>>> it is all about our code.    
>>>>> 
>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do you
>>>>> mean that specific portion of the UEFI firmware, which looks for the
>>>>> proper UEFI partition?
>>>>> 
>>>> 
>>>> BIOS as either native or CSM. Note that from boot code point of view the
>>>> CSM boot *is* BIOS boot, we have no access to UEFI features.
>>>> 
>>>>> 
>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo Q956,
>>>>> refuse booting UEFI, even if properly setup (in terms of what FreeBSD
>>>>> provides on recent CURRENT) is applied and CSM is switched off in the
>>>>> firmware. Again: GPT partition scheme.
>>>>> 
>>>>> The system boots properly if a second partition of type "freebsd-boot" is
>>>>> applied and bootcode is properly applied via "gpart bootcode -b /boot/pmbr
>>>>> -p /boot/gptboot -i 2 ada0" (ada0 is the device).     
>>>>>> 
>>>>>> btw, you can try to validate the installed boot blocks by using recent
>>>>>> enough loader (usb or iso) and then you can use from OK prompt:    
>>>>> 
>>>>> lsdev provides me with the follwoing informations (CSM enabled):
>>>>> 
>>>>> OK lsdev
>>>>> disk devices:
>>>>> 	disk0:		BIOS DRIVE C ...
>>>>> 
>>>>> 		disk0p1:	EFI
>>>>> 		disk0p2:	FreeBSD BOOT
>>>>> 		disk0p3:	FreeBSD SWAP
>>>>> 		disk0p4:	FreeBSD ZFS
>>>>> zfs devices:
>>>>> 	zfs:zroot
>>>>> 
>>>>> OK chain disk0
>>>>> open failed     (so for disk0p{1-4}.
>>>>> 
>>>>> OK chain zroot
>>>>> failed to read disk (just for completeness)    
>>>> 
>>>> 
>>>> chain command does use only device name (such as disk0: or disk0p2: ), but
>>>> not zfs pool as device.  I just found I haven?t ported the code to read the
>>>> file.  
>>> 
>>> ??
>>> 
>>>> 
>>>> the point for chain command test is to see if the normal read and execute
>>>> would work, so in your case please try:
>>>> 
>>>> chain disk0:  
>>> 
>>> As stated above, I did so, and the result is also mentioned above, I always
>>> get "open failed".
>>> This is the same for 
>>> 
>>> chain disk0
>>> chain disk0p1
>>> chain disk0p2
>>> chain disk0p3
>>> chain disk0p4
>>> 
>>> as already said. CSM is enabled in this case.  
>> 
>> sigh? chain command does take device as argument, device must always end with
>> colon?. in this case, the devil is in details:) as I wrote above, the command
>> should be:
>> 
>> chain disk0:
>> 
>> The disk0p1: etc will only work when partition boot code was installed (which
>> you most likely do not have - the only possible candidate could be FreeBSD
>> ZFS partition).
> 
> The command "chain disk0:" works as expected (CSM enabled, GPT partition
> scheme, but with PMBR bootblock installed and freebsd-boot partition conatining
> gptzfsboot installed.
> 
> 
>> 
>>> 
>>>> 
>>>> to read pmbr (512B) and execute it. The expected outcome would be that pmbr
>>>> boot code would browse the GPT, read stage1 from disk0p2: and execute it;
>>>> stage1 would detect FreeBSD ZFS from disk0p4: and load and
>>>> execute /boot/loader. If that will happen, it means the boot code in our
>>>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
>>>> true, it would mean that you either need to use UEFI boot or need to have
>>>> some hack to fool the BIOS or just not use GPT on that machine with CSM.  
>>> 
>>> To make it clear here: The only way to boot this box is using CSM (as it is
>>> the same with the ASRock boards mentioned earlier). But my intention is to
>>> disable CSM and use a GPT/UEFI environment only! And GPT/UEFI doesn't work
>>> with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
>>> 
>>> It would be nice if this could be fixed. I'm more interested in the fix on
>>> the recent Fujitsu device than the outdated ASRock crap, but if the fix for
>>> the Fujitsu Firmware could fix older issues as a byproduct, I'd appreciate
>>> that.
>>> 
>>> Kind regards,
>>> 
>> 
>> ok, somehow I have lost that part of the discussion. Well, you wrote that the
>> UEFI boot fails when the first partition starts from sector 40 - does it mean
>> you have boot when the partition will start from some other sector? I think,
>> there is something else going on.
> 
> Well, I simply try to describe what I "see" to make things disambiguous. I'm
> not familiar with the deeper insights of disk layouts on a binary level. So,
> you explained to me the reason, why ESP (EGI partition) starts at block 40. I
> compared that to the FreeBSD USB flash image FreeBSD provides, but this is
> another story since the image uses MBR scheme as I figured out.
> 
> 
>> 
>> What you can do is to see if that firmware will offer you EFI shell option,
>> from there you can try to start the bootx64.efi manually and see what error
>> you will get. However, the number 1 cause for failing to start the bootloader
>> in UEFI is secure boot - we do not support it and secure boot must be
>> switched off. 
>> 
>> However, they seem to claim "The Secure Boot option is available in the
>> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
>> 
>> Still suggest to double check if thats really the case. Also, if the
>> bootx64.efi start will fail and no messages are appearing on screen, then
>> either there is something in firmware logs or you could get them from trying
>> to start bootx64.efi from UEFI shell.
> 
> Since I'm with this problem since 2014 and try from time to time, be ausred
> that I tried every possible permutationof all reasonable options, even those
> nonsense, to get rid of that problem.
> 
> I never had any problems with any other UEFI capable server/workstation
> firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme, CSM
> disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956 with
> the most recent firmware (as of lat week, week 29 of 2018) having the very same
> problems. 
> 
> 
> 
> I figured out something strange on the Fujitsu - and that is the same with the
> ASRock boards.
> 
> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> appliance, but nevertheless, the USB flash device is booted on Fujitsu servers
> with UEFI-only configurations. I assume at this point that disabling on the
> most recent Fujitsu firmwares on reasonable "new" hardware (not older than
> three years) will disable any(!) legacy BIOS capabilities. The same is assumed
> for the Fujitus ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
> mentioned above/earlier, they are from 2012/2013 and "quite old".
> 
> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> partition scheme of the flash device is GPT. The layout looks like this:
> 
> gpart show -l da4
> =>      40  15425456  da4  GPT  (7.4G)
>        40      2000    1  efiboot0  (1.0M)
>      2040   1453584    3  disk1a  (710M)
>   1455624      4096    5  disk3  (2.0M)
>   1459720  13965776       - free -  (6.7G)
> 
> I created the flash with md, gpart and dd straightforward, efiboot0 is the ESP
> partition and its format/content is created via dd if=/boot/boot1.efifat
> of=/dev/da4p1 - I presume this is very simple.
> 
> This USB flash device boots(!) successfully (UEFI!) on both the ASRock boards
> and the Esprimo Q956!
> 
> But any SSD prepared the same way doesn't. Why? 
> 
> On the ASRock, I recall having fiddled around with HDD also for a while
> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
> remember. 
> 
> In the lack of proper hardware I'm unable to check whether USB-attached HDD or
> SSD will boot or HDD will boot (just in case the local SATA has problems
> booting UEFI and USB not).
> 
> Kind regards,
> 
> Oliver 
> 

Am. well. I think the suggestion to test out FAT32 is still good one to test. This is because it is known that some vendors do not support booting FAT12/FAT16 from HDD (the likely reason is that UEFI specification does not tell which FAT must be supported, and only hint about FAT12/FAT16 in context of removable devices).

There are other possible causes too, for example: https://ubuntuforums.org/showthread.php?t=2147295 

Also about the ESP sizes: https://www.ctrl.blog/entry/esp-size-guide

"The UEFI System Partition should be at least 260 MiB (273 MB) to ensure its properly formatted with FAT32 so that you avoid UEFI implementation compatibility issues. (If you do have incompatible hardware that requires FAT16-formatting, then I suggest you move aside the files on the UEFI System Partition, convert the partition to FAT16, and copy the files back over to it.)?

So, as you see, even just telling ?use FAT32? is not universal medicine, but I suspect it is still more universal than using FAT12/FAT16:)

Just to be clear, there is *no* standard size rule for ESP, there are only suggestions from vendors? 

Yes, this all means that if the solution from default installer does not work, the manual work is needed to identify why the default is not working and the findings should be reported, so the installer (and possibly other parts of the system) could be adjusted. Since this all is vendor specific, it has to be handled case by case.

rgds,
toomas





From tsoome at me.com  Wed Jul 25 09:26:27 2018
From: tsoome at me.com (Toomas Soome)
Date: Wed, 25 Jul 2018 12:26:13 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180725111032.1632b885@freyja.zeit4.iv.bundesimmobilien.de>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
 <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
 <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>
 <2FCF2BCC-05E5-466A-B1AE-90300990ED1A@me.com>
 <20180725111032.1632b885@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>



> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> 
> On Wed, 25 Jul 2018 11:46:07 +0300
> Toomas Soome <tsoome at me.com> wrote:
> 
>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> On Tue, 24 Jul 2018 08:53:36 +0300
>>> Toomas Soome <tsoome at me.com> wrote:
>>> 
>>> 
>>> Hello  Toomas Soome,
>>> 
>>> I CC Allan Jude since I discovered something  weird today regarding the UEFI
>>> boot capabilities of USB flash devices and SSDs. See below.
>>> 
>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>> 
>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>> 
>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>> 
>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>>>>>> 
>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>>>>>> 
>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>>>>> Hash: SHA512
>>>>>>>>> 
>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:     
>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>> wrote:
>>>>>>>>>>> 
>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
>>>>>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
>>>>>>>>>>> 
>>>>>>>>>>> I have two host in private use based on an
>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
>>>>>>>>>>> LGA1155). Both boards are equipted with the lates official available
>>>>>>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
>>>>>>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
>>>>>>>>>>> (2013/7/17). For both boards a BETA revision for the
>>>>>>>>>>> Spectre/Meltdown mitigation is available, but I didn't test that.
>>>>>>>>>>> But please read.
>>>>>>>>>>> 
>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
>>>>>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
>>>>>>>>>>> 05/25/2018 (or 20180525).
>>>>>>>>>>> 
>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the
>>>>>>>>>>> OS using UEFI-only boot method on a GPT partitioned device fails.
>>>>>>>>>>> The ASRock boards jump immediately into the firmware, the Fujitsu
>>>>>>>>>>> offers some kind of CPU/Memory/HDD test facility.
>>>>>>>>>>> 
>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only
>>>>>>>>>>> is implied, the MBR partitioned FreeBSD installation USB flash
>>>>>>>>>>> device does boot in UEFI! I guess I can assume this when the well
>>>>>>>>>>> known clumsy 80x25 char console suddenly gets bright and shiny with
>>>>>>>>>>> a much higher resoltion as long the GPU supports EFI GOP. Looking
>>>>>>>>>>> with gpart at the USB flash drives reveals that the EFI partition
>>>>>>>>>>> starts at block 1 of the device and the device has a MBR layout. I
>>>>>>>>>>> haven't found a way to force the GPT scheme, when initialised via
>>>>>>>>>>> gpart, to let the partitions start at block 1. This might be a naiv
>>>>>>>>>>> thinking, so please be patient with me.
>>>>>>>>>>> 
>>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
>>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
>>>>>>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
>>>>>>>>>>> the very same issues with a new Fujitsu system, leaves me with the
>>>>>>>>>>> impression that FreeBSD's UEFI implementation might have problems
>>>>>>>>>>> I'm not aware of.
>>>>>>>>>>> 
>>>>>>>>>>> Can someone shed some light onto this? 
>>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> The first thing to check is if the secure boot is disabled. We do not
>>>>>>>>>> support secure boot at all at this time.        
>>>>>>>>> 
>>>>>>>>> Secure boot is in every scenario disabled!
>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> If you have efi or bios version running - you can check from either
>>>>>>>>>> console variable value (it can have efi or vidconsole or comconsole)
>>>>>>>>>> or better yet, see if efi-version is set (show efi-version) - if
>>>>>>>>>> efi-version is not set, it is BIOS loader running. Another indirect
>>>>>>>>>> way is to see lsdev -v, with device paths present, it is
>>>>>>>>>> uefi:)        
>>>>>>>>> 
>>>>>>>>> What are you talking about?
>>>>>>>>> What is the point of entry - running system, loader?
>>>>>>>>> 
>>>>>>>>> sysct machdep.bootmethod: BIOS
>>>>>>>>> 
>>>>>>>>> This makes me quite sure that the system has booted via BIOS - as I'm
>>>>>>>>> sure since I've checked that many times. UEFI doesn't work on those
>>>>>>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
>>>>>>>>> on those mainboards booting via UEFI - and I might recall that they
>>>>>>>>> failed also. I also recall that there were issues with earlier UEFI
>>>>>>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
>>>>>>>>> the fact that Linux worked confuses me a bit.
>>>>>>>>> 
>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
>>>>>>>>> all - who cares, I intend to purchase new server grade hardware. But
>>>>>>>>> the more puzzling issue is with the Fujitsu, which I consider serious
>>>>>>>>> and from the behaviour the Fujitsu failure looks exactly like the
>>>>>>>>> ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
>>>>>>>>> Firmware settings when I disable CSM support, that the Firmware will
>>>>>>>>> only EFI/UEFI capable loader? Or is there a ghosty override somwhere
>>>>>>>>> to be expected?). Also on ASRock disabling CSM should ensure not
>>>>>>>>> booting a dual-bootstrap-capable system. This said, on the recent
>>>>>>>>> Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
>>>>>>>>> problem, while the ASRock is still under suspicion to be broken by
>>>>>>>>> design.       
>>>>>>>>>> 
>>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this is
>>>>>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
>>>>>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
>>>>>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
>>>>>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.        
>>>>>>>>> 
>>>>>>>>> Thanks for the explanation. That implies the installer did right,
>>>>>>>>> gpart did also right and therefore there must be an issue with the
>>>>>>>>> stuff located within the EFI partition?       
>>>>>>>> 
>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
>>>>>>>> loader at all or not - that is, if the BIOS bootstrap is actually
>>>>>>>> caring to read the MBR code and start it, since once the MBR code is
>>>>>>>> started, it is all about our code.      
>>>>>>> 
>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do
>>>>>>> you mean that specific portion of the UEFI firmware, which looks for the
>>>>>>> proper UEFI partition?
>>>>>>> 
>>>>>> 
>>>>>> BIOS as either native or CSM. Note that from boot code point of view the
>>>>>> CSM boot *is* BIOS boot, we have no access to UEFI features.
>>>>>> 
>>>>>>> 
>>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
>>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
>>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched off
>>>>>>> in the firmware. Again: GPT partition scheme.
>>>>>>> 
>>>>>>> The system boots properly if a second partition of type "freebsd-boot"
>>>>>>> is applied and bootcode is properly applied via "gpart bootcode
>>>>>>> -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is the device).       
>>>>>>>> 
>>>>>>>> btw, you can try to validate the installed boot blocks by using recent
>>>>>>>> enough loader (usb or iso) and then you can use from OK prompt:      
>>>>>>> 
>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
>>>>>>> 
>>>>>>> OK lsdev
>>>>>>> disk devices:
>>>>>>> 	disk0:		BIOS DRIVE C ...
>>>>>>> 
>>>>>>> 		disk0p1:	EFI
>>>>>>> 		disk0p2:	FreeBSD BOOT
>>>>>>> 		disk0p3:	FreeBSD SWAP
>>>>>>> 		disk0p4:	FreeBSD ZFS
>>>>>>> zfs devices:
>>>>>>> 	zfs:zroot
>>>>>>> 
>>>>>>> OK chain disk0
>>>>>>> open failed     (so for disk0p{1-4}.
>>>>>>> 
>>>>>>> OK chain zroot
>>>>>>> failed to read disk (just for completeness)      
>>>>>> 
>>>>>> 
>>>>>> chain command does use only device name (such as disk0: or disk0p2: ),
>>>>>> but not zfs pool as device.  I just found I haven?t ported the code to
>>>>>> read the file.    
>>>>> 
>>>>> ??
>>>>> 
>>>>>> 
>>>>>> the point for chain command test is to see if the normal read and execute
>>>>>> would work, so in your case please try:
>>>>>> 
>>>>>> chain disk0:    
>>>>> 
>>>>> As stated above, I did so, and the result is also mentioned above, I
>>>>> always get "open failed".
>>>>> This is the same for 
>>>>> 
>>>>> chain disk0
>>>>> chain disk0p1
>>>>> chain disk0p2
>>>>> chain disk0p3
>>>>> chain disk0p4
>>>>> 
>>>>> as already said. CSM is enabled in this case.    
>>>> 
>>>> sigh? chain command does take device as argument, device must always end
>>>> with colon?. in this case, the devil is in details:) as I wrote above, the
>>>> command should be:
>>>> 
>>>> chain disk0:
>>>> 
>>>> The disk0p1: etc will only work when partition boot code was installed
>>>> (which you most likely do not have - the only possible candidate could be
>>>> FreeBSD ZFS partition).  
>>> 
>>> The command "chain disk0:" works as expected (CSM enabled, GPT partition
>>> scheme, but with PMBR bootblock installed and freebsd-boot partition
>>> conatining gptzfsboot installed.
>>> 
>>> 
>>>> 
>>>>> 
>>>>>> 
>>>>>> to read pmbr (512B) and execute it. The expected outcome would be that
>>>>>> pmbr boot code would browse the GPT, read stage1 from disk0p2: and
>>>>>> execute it; stage1 would detect FreeBSD ZFS from disk0p4: and load and
>>>>>> execute /boot/loader. If that will happen, it means the boot code in our
>>>>>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
>>>>>> true, it would mean that you either need to use UEFI boot or need to have
>>>>>> some hack to fool the BIOS or just not use GPT on that machine with
>>>>>> CSM.    
>>>>> 
>>>>> To make it clear here: The only way to boot this box is using CSM (as it
>>>>> is the same with the ASRock boards mentioned earlier). But my intention
>>>>> is to disable CSM and use a GPT/UEFI environment only! And GPT/UEFI
>>>>> doesn't work with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
>>>>> 
>>>>> It would be nice if this could be fixed. I'm more interested in the fix on
>>>>> the recent Fujitsu device than the outdated ASRock crap, but if the fix
>>>>> for the Fujitsu Firmware could fix older issues as a byproduct, I'd
>>>>> appreciate that.
>>>>> 
>>>>> Kind regards,
>>>>> 
>>>> 
>>>> ok, somehow I have lost that part of the discussion. Well, you wrote that
>>>> the UEFI boot fails when the first partition starts from sector 40 - does
>>>> it mean you have boot when the partition will start from some other
>>>> sector? I think, there is something else going on.  
>>> 
>>> Well, I simply try to describe what I "see" to make things disambiguous. I'm
>>> not familiar with the deeper insights of disk layouts on a binary level. So,
>>> you explained to me the reason, why ESP (EGI partition) starts at block 40.
>>> I compared that to the FreeBSD USB flash image FreeBSD provides, but this is
>>> another story since the image uses MBR scheme as I figured out.
>>> 
>>> 
>>>> 
>>>> What you can do is to see if that firmware will offer you EFI shell option,
>>>> from there you can try to start the bootx64.efi manually and see what error
>>>> you will get. However, the number 1 cause for failing to start the
>>>> bootloader in UEFI is secure boot - we do not support it and secure boot
>>>> must be switched off. 
>>>> 
>>>> However, they seem to claim "The Secure Boot option is available in the
>>>> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
>>>> 
>>>> Still suggest to double check if thats really the case. Also, if the
>>>> bootx64.efi start will fail and no messages are appearing on screen, then
>>>> either there is something in firmware logs or you could get them from
>>>> trying to start bootx64.efi from UEFI shell.  
>>> 
>>> Since I'm with this problem since 2014 and try from time to time, be ausred
>>> that I tried every possible permutationof all reasonable options, even those
>>> nonsense, to get rid of that problem.
>>> 
>>> I never had any problems with any other UEFI capable server/workstation
>>> firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme,
>>> CSM disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956
>>> with the most recent firmware (as of lat week, week 29 of 2018) having the
>>> very same problems. 
>>> 
>>> 
>>> 
>>> I figured out something strange on the Fujitsu - and that is the same with
>>> the ASRock boards.
>>> 
>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
>>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
>>> servers with UEFI-only configurations. I assume at this point that
>>> disabling on the most recent Fujitsu firmwares on reasonable "new" hardware
>>> (not older than three years) will disable any(!) legacy BIOS capabilities.
>>> The same is assumed for the Fujitus ESPRIMO Q956. I can not speak for the
>>> ASRock A77 Pro4/m boards mentioned above/earlier, they are from 2012/2013
>>> and "quite old".
>>> 
>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
>>> partition scheme of the flash device is GPT. The layout looks like this:
>>> 
>>> gpart show -l da4  
>>> =>      40  15425456  da4  GPT  (7.4G)  
>>>       40      2000    1  efiboot0  (1.0M)
>>>     2040   1453584    3  disk1a  (710M)
>>>  1455624      4096    5  disk3  (2.0M)
>>>  1459720  13965776       - free -  (6.7G)
>>> 
>>> I created the flash with md, gpart and dd straightforward, efiboot0 is the
>>> ESP partition and its format/content is created via dd if=/boot/boot1.efifat
>>> of=/dev/da4p1 - I presume this is very simple.
>>> 
>>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
>>> boards and the Esprimo Q956!
>>> 
>>> But any SSD prepared the same way doesn't. Why? 
>>> 
>>> On the ASRock, I recall having fiddled around with HDD also for a while
>>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
>>> remember. 
>>> 
>>> In the lack of proper hardware I'm unable to check whether USB-attached HDD
>>> or SSD will boot or HDD will boot (just in case the local SATA has problems
>>> booting UEFI and USB not).
>>> 
>>> Kind regards,
>>> 
>>> Oliver 
>>> 
>> 
>> Am. well. I think the suggestion to test out FAT32 is still good one to test.
>> This is because it is known that some vendors do not support booting
>> FAT12/FAT16 from HDD (the likely reason is that UEFI specification does not
>> tell which FAT must be supported, and only hint about FAT12/FAT16 in context
>> of removable devices).
> 
> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It took me
> a time to circumvent the installer and I had to install the system manually. In
> that strain, I also "tried" to establish the ESP with FAT32, as Allen Jude
> suggested earlier. I didn't find any ad hoc help how to find out the format
> (FAT12/16/32) of the ESP, so I assume when using 12-CURRENT's or 11.2-RELENG's
> installer with AUTO-ZFS and GPT (UEFI) (only!) the resulting ESP is FAT12 or
> FAT16 (300mb by default). I also assume, that when dd'ing the /boo/boot1.efifat
> image to a partition, the format is FAT, but not FAT32. Therefore, I refomatted
> the manually created ESP (using "gpart add -t efi ...") using "newfs_msdos -F
> 32 -b xxx ...". I had to fiddle around a bit with option -b to fit in a proper
> format to meet a 512mb ESP - I'm not sure whether this is the proper option to
> deal with. When using the default and only -F32, the size of the partition has
> to be 4G at least I assume. Having done that, I copied the the content of
> boot1.efifat (mdconfig -t vnode ..., I guess we know the drill ...) to the
> newly formatted ESP to /boot/efi/ ...
> 
> Having so far no knowledge of how to asure that the created ESP is FAT32, I
> assume it is FAT32.
> 
> The result is negative on the ESPRIMO Q956. When disabling the CSM, the box is
> not willing to boot from SSD with the ESP prepared as decribed. So, a chance
> that this might still be due to a misconfiguration lies now within the -b
> option of newfs_msdos - if the -b option is assumed the proper option?
> 
> At the moment, the ESP of the Esprimo is subject to changes, if you wish, but
> not in size, since it is limited to 512mb.
> 
> Thanks and kind regards,
> 
> Oliver

Yea, i was hoping fstyp command would report the FAT type, but it does not (request for feature?:)

However, the more annoying idea would be to install some OS which will boot with UEFI on this machine, then copy boot1.efi from freebsd to it (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do not support EFI32.

note that boot1.efi alone will not do much but printing on screen how it will search for freebsd, but for the purpose of the test it would suffice - that would give us confirmed working ESP file system (since the other os would be able to boot) and then we can confirm if boot1.efi itself is OK.

rgds,
toomas


From o.hartmann at walstatt.org  Wed Jul 25 09:10:39 2018
From: o.hartmann at walstatt.org (O. Hartmann)
Date: Wed, 25 Jul 2018 11:10:32 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <2FCF2BCC-05E5-466A-B1AE-90300990ED1A@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
 <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
 <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>
 <2FCF2BCC-05E5-466A-B1AE-90300990ED1A@me.com>
Message-ID: <20180725111032.1632b885@freyja.zeit4.iv.bundesimmobilien.de>

On Wed, 25 Jul 2018 11:46:07 +0300
Toomas Soome <tsoome at me.com> wrote:

> > On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Tue, 24 Jul 2018 08:53:36 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> > 
> > 
> > Hello  Toomas Soome,
> > 
> > I CC Allan Jude since I discovered something  weird today regarding the UEFI
> > boot capabilities of USB flash devices and SSDs. See below.
> >   
> >>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>> Toomas Soome <tsoome at me.com> wrote:
> >>>   
> >>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>> 
> >>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>   
> >>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>> 
> >>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>> Hash: SHA512
> >>>>>>> 
> >>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:     
> >>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>> wrote:
> >>>>>>>>> 
> >>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
> >>>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
> >>>>>>>>> 
> >>>>>>>>> I have two host in private use based on an
> >>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>>>>>>>> LGA1155). Both boards are equipted with the lates official available
> >>>>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
> >>>>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
> >>>>>>>>> (2013/7/17). For both boards a BETA revision for the
> >>>>>>>>> Spectre/Meltdown mitigation is available, but I didn't test that.
> >>>>>>>>> But please read.
> >>>>>>>>> 
> >>>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>>>>>>>> 05/25/2018 (or 20180525).
> >>>>>>>>> 
> >>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the
> >>>>>>>>> OS using UEFI-only boot method on a GPT partitioned device fails.
> >>>>>>>>> The ASRock boards jump immediately into the firmware, the Fujitsu
> >>>>>>>>> offers some kind of CPU/Memory/HDD test facility.
> >>>>>>>>> 
> >>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only
> >>>>>>>>> is implied, the MBR partitioned FreeBSD installation USB flash
> >>>>>>>>> device does boot in UEFI! I guess I can assume this when the well
> >>>>>>>>> known clumsy 80x25 char console suddenly gets bright and shiny with
> >>>>>>>>> a much higher resoltion as long the GPU supports EFI GOP. Looking
> >>>>>>>>> with gpart at the USB flash drives reveals that the EFI partition
> >>>>>>>>> starts at block 1 of the device and the device has a MBR layout. I
> >>>>>>>>> haven't found a way to force the GPT scheme, when initialised via
> >>>>>>>>> gpart, to let the partitions start at block 1. This might be a naiv
> >>>>>>>>> thinking, so please be patient with me.
> >>>>>>>>> 
> >>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
> >>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
> >>>>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
> >>>>>>>>> the very same issues with a new Fujitsu system, leaves me with the
> >>>>>>>>> impression that FreeBSD's UEFI implementation might have problems
> >>>>>>>>> I'm not aware of.
> >>>>>>>>> 
> >>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>   
> >>>>>>>> 
> >>>>>>>> The first thing to check is if the secure boot is disabled. We do not
> >>>>>>>> support secure boot at all at this time.        
> >>>>>>> 
> >>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>   
> >>>>>>>> 
> >>>>>>>> If you have efi or bios version running - you can check from either
> >>>>>>>> console variable value (it can have efi or vidconsole or comconsole)
> >>>>>>>> or better yet, see if efi-version is set (show efi-version) - if
> >>>>>>>> efi-version is not set, it is BIOS loader running. Another indirect
> >>>>>>>> way is to see lsdev -v, with device paths present, it is
> >>>>>>>> uefi:)        
> >>>>>>> 
> >>>>>>> What are you talking about?
> >>>>>>> What is the point of entry - running system, loader?
> >>>>>>> 
> >>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>> 
> >>>>>>> This makes me quite sure that the system has booted via BIOS - as I'm
> >>>>>>> sure since I've checked that many times. UEFI doesn't work on those
> >>>>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
> >>>>>>> on those mainboards booting via UEFI - and I might recall that they
> >>>>>>> failed also. I also recall that there were issues with earlier UEFI
> >>>>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
> >>>>>>> the fact that Linux worked confuses me a bit.
> >>>>>>> 
> >>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
> >>>>>>> all - who cares, I intend to purchase new server grade hardware. But
> >>>>>>> the more puzzling issue is with the Fujitsu, which I consider serious
> >>>>>>> and from the behaviour the Fujitsu failure looks exactly like the
> >>>>>>> ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
> >>>>>>> Firmware settings when I disable CSM support, that the Firmware will
> >>>>>>> only EFI/UEFI capable loader? Or is there a ghosty override somwhere
> >>>>>>> to be expected?). Also on ASRock disabling CSM should ensure not
> >>>>>>> booting a dual-bootstrap-capable system. This said, on the recent
> >>>>>>> Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
> >>>>>>> problem, while the ASRock is still under suspicion to be broken by
> >>>>>>> design.       
> >>>>>>>> 
> >>>>>>>> GPT partitions can never start from disk absolute sector 1; this is
> >>>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >>>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
> >>>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
> >>>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.        
> >>>>>>> 
> >>>>>>> Thanks for the explanation. That implies the installer did right,
> >>>>>>> gpart did also right and therefore there must be an issue with the
> >>>>>>> stuff located within the EFI partition?       
> >>>>>> 
> >>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
> >>>>>> loader at all or not - that is, if the BIOS bootstrap is actually
> >>>>>> caring to read the MBR code and start it, since once the MBR code is
> >>>>>> started, it is all about our code.      
> >>>>> 
> >>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do
> >>>>> you mean that specific portion of the UEFI firmware, which looks for the
> >>>>> proper UEFI partition?
> >>>>>   
> >>>> 
> >>>> BIOS as either native or CSM. Note that from boot code point of view the
> >>>> CSM boot *is* BIOS boot, we have no access to UEFI features.
> >>>>   
> >>>>> 
> >>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
> >>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
> >>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched off
> >>>>> in the firmware. Again: GPT partition scheme.
> >>>>> 
> >>>>> The system boots properly if a second partition of type "freebsd-boot"
> >>>>> is applied and bootcode is properly applied via "gpart bootcode
> >>>>> -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is the device).       
> >>>>>> 
> >>>>>> btw, you can try to validate the installed boot blocks by using recent
> >>>>>> enough loader (usb or iso) and then you can use from OK prompt:      
> >>>>> 
> >>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>> 
> >>>>> OK lsdev
> >>>>> disk devices:
> >>>>> 	disk0:		BIOS DRIVE C ...
> >>>>> 
> >>>>> 		disk0p1:	EFI
> >>>>> 		disk0p2:	FreeBSD BOOT
> >>>>> 		disk0p3:	FreeBSD SWAP
> >>>>> 		disk0p4:	FreeBSD ZFS
> >>>>> zfs devices:
> >>>>> 	zfs:zroot
> >>>>> 
> >>>>> OK chain disk0
> >>>>> open failed     (so for disk0p{1-4}.
> >>>>> 
> >>>>> OK chain zroot
> >>>>> failed to read disk (just for completeness)      
> >>>> 
> >>>> 
> >>>> chain command does use only device name (such as disk0: or disk0p2: ),
> >>>> but not zfs pool as device.  I just found I haven?t ported the code to
> >>>> read the file.    
> >>> 
> >>> ??
> >>>   
> >>>> 
> >>>> the point for chain command test is to see if the normal read and execute
> >>>> would work, so in your case please try:
> >>>> 
> >>>> chain disk0:    
> >>> 
> >>> As stated above, I did so, and the result is also mentioned above, I
> >>> always get "open failed".
> >>> This is the same for 
> >>> 
> >>> chain disk0
> >>> chain disk0p1
> >>> chain disk0p2
> >>> chain disk0p3
> >>> chain disk0p4
> >>> 
> >>> as already said. CSM is enabled in this case.    
> >> 
> >> sigh? chain command does take device as argument, device must always end
> >> with colon?. in this case, the devil is in details:) as I wrote above, the
> >> command should be:
> >> 
> >> chain disk0:
> >> 
> >> The disk0p1: etc will only work when partition boot code was installed
> >> (which you most likely do not have - the only possible candidate could be
> >> FreeBSD ZFS partition).  
> > 
> > The command "chain disk0:" works as expected (CSM enabled, GPT partition
> > scheme, but with PMBR bootblock installed and freebsd-boot partition
> > conatining gptzfsboot installed.
> > 
> >   
> >>   
> >>>   
> >>>> 
> >>>> to read pmbr (512B) and execute it. The expected outcome would be that
> >>>> pmbr boot code would browse the GPT, read stage1 from disk0p2: and
> >>>> execute it; stage1 would detect FreeBSD ZFS from disk0p4: and load and
> >>>> execute /boot/loader. If that will happen, it means the boot code in our
> >>>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
> >>>> true, it would mean that you either need to use UEFI boot or need to have
> >>>> some hack to fool the BIOS or just not use GPT on that machine with
> >>>> CSM.    
> >>> 
> >>> To make it clear here: The only way to boot this box is using CSM (as it
> >>> is the same with the ASRock boards mentioned earlier). But my intention
> >>> is to disable CSM and use a GPT/UEFI environment only! And GPT/UEFI
> >>> doesn't work with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
> >>> 
> >>> It would be nice if this could be fixed. I'm more interested in the fix on
> >>> the recent Fujitsu device than the outdated ASRock crap, but if the fix
> >>> for the Fujitsu Firmware could fix older issues as a byproduct, I'd
> >>> appreciate that.
> >>> 
> >>> Kind regards,
> >>>   
> >> 
> >> ok, somehow I have lost that part of the discussion. Well, you wrote that
> >> the UEFI boot fails when the first partition starts from sector 40 - does
> >> it mean you have boot when the partition will start from some other
> >> sector? I think, there is something else going on.  
> > 
> > Well, I simply try to describe what I "see" to make things disambiguous. I'm
> > not familiar with the deeper insights of disk layouts on a binary level. So,
> > you explained to me the reason, why ESP (EGI partition) starts at block 40.
> > I compared that to the FreeBSD USB flash image FreeBSD provides, but this is
> > another story since the image uses MBR scheme as I figured out.
> > 
> >   
> >> 
> >> What you can do is to see if that firmware will offer you EFI shell option,
> >> from there you can try to start the bootx64.efi manually and see what error
> >> you will get. However, the number 1 cause for failing to start the
> >> bootloader in UEFI is secure boot - we do not support it and secure boot
> >> must be switched off. 
> >> 
> >> However, they seem to claim "The Secure Boot option is available in the
> >> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
> >> 
> >> Still suggest to double check if thats really the case. Also, if the
> >> bootx64.efi start will fail and no messages are appearing on screen, then
> >> either there is something in firmware logs or you could get them from
> >> trying to start bootx64.efi from UEFI shell.  
> > 
> > Since I'm with this problem since 2014 and try from time to time, be ausred
> > that I tried every possible permutationof all reasonable options, even those
> > nonsense, to get rid of that problem.
> > 
> > I never had any problems with any other UEFI capable server/workstation
> > firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme,
> > CSM disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956
> > with the most recent firmware (as of lat week, week 29 of 2018) having the
> > very same problems. 
> > 
> > 
> > 
> > I figured out something strange on the Fujitsu - and that is the same with
> > the ASRock boards.
> > 
> > We/I prepare some USB flash drives to boot a NanoBSD for a very small
> > appliance, but nevertheless, the USB flash device is booted on Fujitsu
> > servers with UEFI-only configurations. I assume at this point that
> > disabling on the most recent Fujitsu firmwares on reasonable "new" hardware
> > (not older than three years) will disable any(!) legacy BIOS capabilities.
> > The same is assumed for the Fujitus ESPRIMO Q956. I can not speak for the
> > ASRock A77 Pro4/m boards mentioned above/earlier, they are from 2012/2013
> > and "quite old".
> > 
> > The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> > partition scheme of the flash device is GPT. The layout looks like this:
> > 
> > gpart show -l da4  
> > =>      40  15425456  da4  GPT  (7.4G)  
> >        40      2000    1  efiboot0  (1.0M)
> >      2040   1453584    3  disk1a  (710M)
> >   1455624      4096    5  disk3  (2.0M)
> >   1459720  13965776       - free -  (6.7G)
> > 
> > I created the flash with md, gpart and dd straightforward, efiboot0 is the
> > ESP partition and its format/content is created via dd if=/boot/boot1.efifat
> > of=/dev/da4p1 - I presume this is very simple.
> > 
> > This USB flash device boots(!) successfully (UEFI!) on both the ASRock
> > boards and the Esprimo Q956!
> > 
> > But any SSD prepared the same way doesn't. Why? 
> > 
> > On the ASRock, I recall having fiddled around with HDD also for a while
> > conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
> > remember. 
> > 
> > In the lack of proper hardware I'm unable to check whether USB-attached HDD
> > or SSD will boot or HDD will boot (just in case the local SATA has problems
> > booting UEFI and USB not).
> > 
> > Kind regards,
> > 
> > Oliver 
> >   
> 
> Am. well. I think the suggestion to test out FAT32 is still good one to test.
> This is because it is known that some vendors do not support booting
> FAT12/FAT16 from HDD (the likely reason is that UEFI specification does not
> tell which FAT must be supported, and only hint about FAT12/FAT16 in context
> of removable devices).

I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It took me
a time to circumvent the installer and I had to install the system manually. In
that strain, I also "tried" to establish the ESP with FAT32, as Allen Jude
suggested earlier. I didn't find any ad hoc help how to find out the format
(FAT12/16/32) of the ESP, so I assume when using 12-CURRENT's or 11.2-RELENG's
installer with AUTO-ZFS and GPT (UEFI) (only!) the resulting ESP is FAT12 or
FAT16 (300mb by default). I also assume, that when dd'ing the /boo/boot1.efifat
image to a partition, the format is FAT, but not FAT32. Therefore, I refomatted
the manually created ESP (using "gpart add -t efi ...") using "newfs_msdos -F
32 -b xxx ...". I had to fiddle around a bit with option -b to fit in a proper
format to meet a 512mb ESP - I'm not sure whether this is the proper option to
deal with. When using the default and only -F32, the size of the partition has
to be 4G at least I assume. Having done that, I copied the the content of
boot1.efifat (mdconfig -t vnode ..., I guess we know the drill ...) to the
newly formatted ESP to /boot/efi/ ...

Having so far no knowledge of how to asure that the created ESP is FAT32, I
assume it is FAT32.

The result is negative on the ESPRIMO Q956. When disabling the CSM, the box is
not willing to boot from SSD with the ESP prepared as decribed. So, a chance
that this might still be due to a misconfiguration lies now within the -b
option of newfs_msdos - if the -b option is assumed the proper option?

At the moment, the ESP of the Esprimo is subject to changes, if you wish, but
not in size, since it is limited to 512mb.

Thanks and kind regards,

Oliver

> 
> There are other possible causes too, for example:
> https://ubuntuforums.org/showthread.php?t=2147295 
> 
> Also about the ESP sizes: https://www.ctrl.blog/entry/esp-size-guide
> 
> "The UEFI System Partition should be at least 260 MiB (273 MB) to ensure its
> properly formatted with FAT32 so that you avoid UEFI implementation
> compatibility issues. (If you do have incompatible hardware that requires
> FAT16-formatting, then I suggest you move aside the files on the UEFI System
> Partition, convert the partition to FAT16, and copy the files back over to
> it.)?
> 
> So, as you see, even just telling ?use FAT32? is not universal medicine, but
> I suspect it is still more universal than using FAT12/FAT16:)
> 
> Just to be clear, there is *no* standard size rule for ESP, there are only
> suggestions from vendors? 
> 
> Yes, this all means that if the solution from default installer does not
> work, the manual work is needed to identify why the default is not working
> and the findings should be reported, so the installer (and possibly other
> parts of the system) could be adjusted. Since this all is vendor specific, it
> has to be handled case by case.
> 
> rgds,
> toomas
> 
> 
> 
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


From f0andrey at gmail.com  Wed Jul 25 13:20:24 2018
From: f0andrey at gmail.com (Andrey Fesenko)
Date: Wed, 25 Jul 2018 16:20:22 +0300
Subject: Spam in console after r336593 (NFS mounted)
Message-ID: <CA+K5SrN44jEEuK4h0Dn=-tfoohirir6rkyRVvGUkJ+Dnk=X+CQ@mail.gmail.com>

Hello.
After https://svnweb.freebsd.org/base?view=revision&revision=336593
any make action starting spam errors (svn not work on NFS mounted
partitions)

svn: E155016: The working copy database at '/usr/src' is corrupt.
svn: E155016: The working copy database at '/usr/src' is corrupt.
make[2]: "/usr/src/release/Makefile.ec2" line 24: warning:
"/usr/local/bin/svn info --show-item last-changed-revision /usr/sr
c/release/.." returned non-zero status
svn: E155016: The working copy database at '/usr/src' is corrupt.
svn: E155016: The working copy database at '/usr/src' is corrupt.
make[2]: "/usr/src/release/Makefile.ec2" line 24: warning:
"/usr/local/bin/svn info --show-item last-changed-revision /usr/sr
c/release/.." returned non-zero status

From lists at eitanadler.com  Wed Jul 25 13:32:19 2018
From: lists at eitanadler.com (Eitan Adler)
Date: Wed, 25 Jul 2018 06:31:51 -0700
Subject: error building r336696: cp: asn1_OCSPResponseStatus.c: Bad address
Message-ID: <CAF6rxgngWQJHVgk=Tqcqdai-gk+qDXb51rWjYaVVXeSCBocE=w@mail.gmail.com>

I'm currently on r335788 and trying to build r336696.

When running make -s buildworld buildkernel -j33 I get the following.
Any help is appreciated to fix.

CMD cp -f asn1_OCSPResponseStatus.x asn1_OCSPResponseStatus.c
CWD /srv/obj/fbsd/usr/src/amd64.amd64/kerberos5/lib/libhx509
TARGET asn1_OCSPResponseStatus.c
-- command output --
cp: asn1_OCSPResponseStatus.c: Bad address


src.conf
===
MALLOC_PRODUCTION=true
WITHOUT_SVNLITE=true
WITHOUT_LIB32=true
WITH_CLANG_EXTRAS=true
WITH_BSD_GREP=true
WITH_GNU_GREP_COMPAT=true
WITH_EXTRA_TCP_STACKS=true
WITH_LOADER_LUA=true
WITHOUT_FORTH=true
WITH_SORT_THREADS=true

src-env.conf
===
MAKEOBJDIRPREFIX?=/srv/obj/fbsd
WITH_META_MODE=yes

make.conf
===
WRKDIRPREFIX=/srv/obj/fbsd/ports
DISTDIR=/srv/obj/distfiles
FORMATS=html
DEVELOPER=yes
WITH_PKGNG=devel
CPUTYPE?=znver1

# Set here for ports development only
DEFAULT_VERSIONS+=ssl=openssl


-- 
Eitan Adler

From freebsd-rwg at pdx.rh.CN85.dnsmgr.net  Wed Jul 25 14:30:38 2018
From: freebsd-rwg at pdx.rh.CN85.dnsmgr.net (Rodney W. Grimes)
Date: Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
Message-ID: <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>

> > On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> > 
> > On Wed, 25 Jul 2018 11:46:07 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> > 
> >>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Tue, 24 Jul 2018 08:53:36 +0300
> >>> Toomas Soome <tsoome at me.com> wrote:
> >>> 
> >>> 
> >>> Hello  Toomas Soome,
> >>> 
> >>> I CC Allan Jude since I discovered something  weird today regarding the UEFI
> >>> boot capabilities of USB flash devices and SSDs. See below.
> >>> 
> >>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>> 
> >>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>> 
> >>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>> 
> >>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>>> 
> >>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>>>> 
> >>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>>>> Hash: SHA512
> >>>>>>>>> 
> >>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:     
> >>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>> wrote:
> >>>>>>>>>>> 
> >>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
> >>>>>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
> >>>>>>>>>>> 
> >>>>>>>>>>> I have two host in private use based on an
> >>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>>>>>>>>>> LGA1155). Both boards are equipted with the lates official available
> >>>>>>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
> >>>>>>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
> >>>>>>>>>>> (2013/7/17). For both boards a BETA revision for the
> >>>>>>>>>>> Spectre/Meltdown mitigation is available, but I didn't test that.
> >>>>>>>>>>> But please read.
> >>>>>>>>>>> 
> >>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>>>>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>>>>>>>>>> 05/25/2018 (or 20180525).
> >>>>>>>>>>> 
> >>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the
> >>>>>>>>>>> OS using UEFI-only boot method on a GPT partitioned device fails.
> >>>>>>>>>>> The ASRock boards jump immediately into the firmware, the Fujitsu
> >>>>>>>>>>> offers some kind of CPU/Memory/HDD test facility.
> >>>>>>>>>>> 
> >>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only
> >>>>>>>>>>> is implied, the MBR partitioned FreeBSD installation USB flash
> >>>>>>>>>>> device does boot in UEFI! I guess I can assume this when the well
> >>>>>>>>>>> known clumsy 80x25 char console suddenly gets bright and shiny with
> >>>>>>>>>>> a much higher resoltion as long the GPU supports EFI GOP. Looking
> >>>>>>>>>>> with gpart at the USB flash drives reveals that the EFI partition
> >>>>>>>>>>> starts at block 1 of the device and the device has a MBR layout. I
> >>>>>>>>>>> haven't found a way to force the GPT scheme, when initialised via
> >>>>>>>>>>> gpart, to let the partitions start at block 1. This might be a naiv
> >>>>>>>>>>> thinking, so please be patient with me.
> >>>>>>>>>>> 
> >>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
> >>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
> >>>>>>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
> >>>>>>>>>>> the very same issues with a new Fujitsu system, leaves me with the
> >>>>>>>>>>> impression that FreeBSD's UEFI implementation might have problems
> >>>>>>>>>>> I'm not aware of.
> >>>>>>>>>>> 
> >>>>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>>> 
> >>>>>>>>>> 
> >>>>>>>>>> The first thing to check is if the secure boot is disabled. We do not
> >>>>>>>>>> support secure boot at all at this time.        
> >>>>>>>>> 
> >>>>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>>> 
> >>>>>>>>>> 
> >>>>>>>>>> If you have efi or bios version running - you can check from either
> >>>>>>>>>> console variable value (it can have efi or vidconsole or comconsole)
> >>>>>>>>>> or better yet, see if efi-version is set (show efi-version) - if
> >>>>>>>>>> efi-version is not set, it is BIOS loader running. Another indirect
> >>>>>>>>>> way is to see lsdev -v, with device paths present, it is
> >>>>>>>>>> uefi:)        
> >>>>>>>>> 
> >>>>>>>>> What are you talking about?
> >>>>>>>>> What is the point of entry - running system, loader?
> >>>>>>>>> 
> >>>>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>>>> 
> >>>>>>>>> This makes me quite sure that the system has booted via BIOS - as I'm
> >>>>>>>>> sure since I've checked that many times. UEFI doesn't work on those
> >>>>>>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
> >>>>>>>>> on those mainboards booting via UEFI - and I might recall that they
> >>>>>>>>> failed also. I also recall that there were issues with earlier UEFI
> >>>>>>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
> >>>>>>>>> the fact that Linux worked confuses me a bit.
> >>>>>>>>> 
> >>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
> >>>>>>>>> all - who cares, I intend to purchase new server grade hardware. But
> >>>>>>>>> the more puzzling issue is with the Fujitsu, which I consider serious
> >>>>>>>>> and from the behaviour the Fujitsu failure looks exactly like the
> >>>>>>>>> ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
> >>>>>>>>> Firmware settings when I disable CSM support, that the Firmware will
> >>>>>>>>> only EFI/UEFI capable loader? Or is there a ghosty override somwhere
> >>>>>>>>> to be expected?). Also on ASRock disabling CSM should ensure not
> >>>>>>>>> booting a dual-bootstrap-capable system. This said, on the recent
> >>>>>>>>> Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
> >>>>>>>>> problem, while the ASRock is still under suspicion to be broken by
> >>>>>>>>> design.       
> >>>>>>>>>> 
> >>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this is
> >>>>>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >>>>>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
> >>>>>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
> >>>>>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.        
> >>>>>>>>> 
> >>>>>>>>> Thanks for the explanation. That implies the installer did right,
> >>>>>>>>> gpart did also right and therefore there must be an issue with the
> >>>>>>>>> stuff located within the EFI partition?       
> >>>>>>>> 
> >>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
> >>>>>>>> loader at all or not - that is, if the BIOS bootstrap is actually
> >>>>>>>> caring to read the MBR code and start it, since once the MBR code is
> >>>>>>>> started, it is all about our code.      
> >>>>>>> 
> >>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do
> >>>>>>> you mean that specific portion of the UEFI firmware, which looks for the
> >>>>>>> proper UEFI partition?
> >>>>>>> 
> >>>>>> 
> >>>>>> BIOS as either native or CSM. Note that from boot code point of view the
> >>>>>> CSM boot *is* BIOS boot, we have no access to UEFI features.
> >>>>>> 
> >>>>>>> 
> >>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
> >>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
> >>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched off
> >>>>>>> in the firmware. Again: GPT partition scheme.
> >>>>>>> 
> >>>>>>> The system boots properly if a second partition of type "freebsd-boot"
> >>>>>>> is applied and bootcode is properly applied via "gpart bootcode
> >>>>>>> -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is the device).       
> >>>>>>>> 
> >>>>>>>> btw, you can try to validate the installed boot blocks by using recent
> >>>>>>>> enough loader (usb or iso) and then you can use from OK prompt:      
> >>>>>>> 
> >>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>>>> 
> >>>>>>> OK lsdev
> >>>>>>> disk devices:
> >>>>>>> 	disk0:		BIOS DRIVE C ...
> >>>>>>> 
> >>>>>>> 		disk0p1:	EFI
> >>>>>>> 		disk0p2:	FreeBSD BOOT
> >>>>>>> 		disk0p3:	FreeBSD SWAP
> >>>>>>> 		disk0p4:	FreeBSD ZFS
> >>>>>>> zfs devices:
> >>>>>>> 	zfs:zroot
> >>>>>>> 
> >>>>>>> OK chain disk0
> >>>>>>> open failed     (so for disk0p{1-4}.
> >>>>>>> 
> >>>>>>> OK chain zroot
> >>>>>>> failed to read disk (just for completeness)      
> >>>>>> 
> >>>>>> 
> >>>>>> chain command does use only device name (such as disk0: or disk0p2: ),
> >>>>>> but not zfs pool as device.  I just found I haven?t ported the code to
> >>>>>> read the file.    
> >>>>> 
> >>>>> ??
> >>>>> 
> >>>>>> 
> >>>>>> the point for chain command test is to see if the normal read and execute
> >>>>>> would work, so in your case please try:
> >>>>>> 
> >>>>>> chain disk0:    
> >>>>> 
> >>>>> As stated above, I did so, and the result is also mentioned above, I
> >>>>> always get "open failed".
> >>>>> This is the same for 
> >>>>> 
> >>>>> chain disk0
> >>>>> chain disk0p1
> >>>>> chain disk0p2
> >>>>> chain disk0p3
> >>>>> chain disk0p4
> >>>>> 
> >>>>> as already said. CSM is enabled in this case.    
> >>>> 
> >>>> sigh? chain command does take device as argument, device must always end
> >>>> with colon?. in this case, the devil is in details:) as I wrote above, the
> >>>> command should be:
> >>>> 
> >>>> chain disk0:
> >>>> 
> >>>> The disk0p1: etc will only work when partition boot code was installed
> >>>> (which you most likely do not have - the only possible candidate could be
> >>>> FreeBSD ZFS partition).  
> >>> 
> >>> The command "chain disk0:" works as expected (CSM enabled, GPT partition
> >>> scheme, but with PMBR bootblock installed and freebsd-boot partition
> >>> conatining gptzfsboot installed.
> >>> 
> >>> 
> >>>> 
> >>>>> 
> >>>>>> 
> >>>>>> to read pmbr (512B) and execute it. The expected outcome would be that
> >>>>>> pmbr boot code would browse the GPT, read stage1 from disk0p2: and
> >>>>>> execute it; stage1 would detect FreeBSD ZFS from disk0p4: and load and
> >>>>>> execute /boot/loader. If that will happen, it means the boot code in our
> >>>>>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
> >>>>>> true, it would mean that you either need to use UEFI boot or need to have
> >>>>>> some hack to fool the BIOS or just not use GPT on that machine with
> >>>>>> CSM.    
> >>>>> 
> >>>>> To make it clear here: The only way to boot this box is using CSM (as it
> >>>>> is the same with the ASRock boards mentioned earlier). But my intention
> >>>>> is to disable CSM and use a GPT/UEFI environment only! And GPT/UEFI
> >>>>> doesn't work with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
> >>>>> 
> >>>>> It would be nice if this could be fixed. I'm more interested in the fix on
> >>>>> the recent Fujitsu device than the outdated ASRock crap, but if the fix
> >>>>> for the Fujitsu Firmware could fix older issues as a byproduct, I'd
> >>>>> appreciate that.
> >>>>> 
> >>>>> Kind regards,
> >>>>> 
> >>>> 
> >>>> ok, somehow I have lost that part of the discussion. Well, you wrote that
> >>>> the UEFI boot fails when the first partition starts from sector 40 - does
> >>>> it mean you have boot when the partition will start from some other
> >>>> sector? I think, there is something else going on.  
> >>> 
> >>> Well, I simply try to describe what I "see" to make things disambiguous. I'm
> >>> not familiar with the deeper insights of disk layouts on a binary level. So,
> >>> you explained to me the reason, why ESP (EGI partition) starts at block 40.
> >>> I compared that to the FreeBSD USB flash image FreeBSD provides, but this is
> >>> another story since the image uses MBR scheme as I figured out.
> >>> 
> >>> 
> >>>> 
> >>>> What you can do is to see if that firmware will offer you EFI shell option,
> >>>> from there you can try to start the bootx64.efi manually and see what error
> >>>> you will get. However, the number 1 cause for failing to start the
> >>>> bootloader in UEFI is secure boot - we do not support it and secure boot
> >>>> must be switched off. 
> >>>> 
> >>>> However, they seem to claim "The Secure Boot option is available in the
> >>>> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
> >>>> 
> >>>> Still suggest to double check if thats really the case. Also, if the
> >>>> bootx64.efi start will fail and no messages are appearing on screen, then
> >>>> either there is something in firmware logs or you could get them from
> >>>> trying to start bootx64.efi from UEFI shell.  
> >>> 
> >>> Since I'm with this problem since 2014 and try from time to time, be ausred
> >>> that I tried every possible permutationof all reasonable options, even those
> >>> nonsense, to get rid of that problem.
> >>> 
> >>> I never had any problems with any other UEFI capable server/workstation
> >>> firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme,
> >>> CSM disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956
> >>> with the most recent firmware (as of lat week, week 29 of 2018) having the
> >>> very same problems. 
> >>> 
> >>> 
> >>> 
> >>> I figured out something strange on the Fujitsu - and that is the same with
> >>> the ASRock boards.
> >>> 
> >>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> >>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
> >>> servers with UEFI-only configurations. I assume at this point that
> >>> disabling on the most recent Fujitsu firmwares on reasonable "new" hardware
> >>> (not older than three years) will disable any(!) legacy BIOS capabilities.
> >>> The same is assumed for the Fujitus ESPRIMO Q956. I can not speak for the
> >>> ASRock A77 Pro4/m boards mentioned above/earlier, they are from 2012/2013
> >>> and "quite old".
> >>> 
> >>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> >>> partition scheme of the flash device is GPT. The layout looks like this:
> >>> 
> >>> gpart show -l da4  
> >>> =>      40  15425456  da4  GPT  (7.4G)  
> >>>       40      2000    1  efiboot0  (1.0M)
> >>>     2040   1453584    3  disk1a  (710M)
> >>>  1455624      4096    5  disk3  (2.0M)
> >>>  1459720  13965776       - free -  (6.7G)
> >>> 
> >>> I created the flash with md, gpart and dd straightforward, efiboot0 is the
> >>> ESP partition and its format/content is created via dd if=/boot/boot1.efifat
> >>> of=/dev/da4p1 - I presume this is very simple.
> >>> 
> >>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
> >>> boards and the Esprimo Q956!
> >>> 
> >>> But any SSD prepared the same way doesn't. Why? 
> >>> 
> >>> On the ASRock, I recall having fiddled around with HDD also for a while
> >>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
> >>> remember. 
> >>> 
> >>> In the lack of proper hardware I'm unable to check whether USB-attached HDD
> >>> or SSD will boot or HDD will boot (just in case the local SATA has problems
> >>> booting UEFI and USB not).
> >>> 
> >>> Kind regards,
> >>> 
> >>> Oliver 
> >>> 
> >> 
> >> Am. well. I think the suggestion to test out FAT32 is still good one to test.
> >> This is because it is known that some vendors do not support booting
> >> FAT12/FAT16 from HDD (the likely reason is that UEFI specification does not
> >> tell which FAT must be supported, and only hint about FAT12/FAT16 in context
> >> of removable devices).
> > 
> > I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It took me
> > a time to circumvent the installer and I had to install the system manually. In
> > that strain, I also "tried" to establish the ESP with FAT32, as Allen Jude
> > suggested earlier. I didn't find any ad hoc help how to find out the format
> > (FAT12/16/32) of the ESP, so I assume when using 12-CURRENT's or 11.2-RELENG's
> > installer with AUTO-ZFS and GPT (UEFI) (only!) the resulting ESP is FAT12 or
> > FAT16 (300mb by default). I also assume, that when dd'ing the /boo/boot1.efifat
> > image to a partition, the format is FAT, but not FAT32. Therefore, I refomatted
> > the manually created ESP (using "gpart add -t efi ...") using "newfs_msdos -F
> > 32 -b xxx ...". I had to fiddle around a bit with option -b to fit in a proper
> > format to meet a 512mb ESP - I'm not sure whether this is the proper option to
> > deal with. When using the default and only -F32, the size of the partition has
> > to be 4G at least I assume. Having done that, I copied the the content of
> > boot1.efifat (mdconfig -t vnode ..., I guess we know the drill ...) to the
> > newly formatted ESP to /boot/efi/ ...
> > 
> > Having so far no knowledge of how to asure that the created ESP is FAT32, I
> > assume it is FAT32.
> > 
> > The result is negative on the ESPRIMO Q956. When disabling the CSM, the box is
> > not willing to boot from SSD with the ESP prepared as decribed. So, a chance
> > that this might still be due to a misconfiguration lies now within the -b
> > option of newfs_msdos - if the -b option is assumed the proper option?
> > 
> > At the moment, the ESP of the Esprimo is subject to changes, if you wish, but
> > not in size, since it is limited to 512mb.
> > 
> > Thanks and kind regards,
> > 
> > Oliver
> 
> Yea, i was hoping fstyp command would report the FAT type, but it does not (request for feature?:)

FYI, the file(1) command is very good at disecting a disk image to tell
you what the MBR looks like, and at looking at partitions if pointed at
them with the -s option.  It should be able to detect FAT12/16/32.

root at x230a:/home/ISO/x # file -s /dev/md2s1
/dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ", root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5, sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS     ", FAT (12 bit), followed by FAT

> 
> However, the more annoying idea would be to install some OS which will boot with UEFI on this machine, then copy boot1.efi from freebsd to it (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do not support EFI32.
> 
> note that boot1.efi alone will not do much but printing on screen how it will search for freebsd, but for the purpose of the test it would suffice - that would give us confirmed working ESP file system (since the other os would be able to boot) and then we can confirm if boot1.efi itself is OK.

-- 
Rod Grimes                                                 rgrimes at freebsd.org

From julian at freebsd.org  Wed Jul 25 14:45:58 2018
From: julian at freebsd.org (Julian Elischer)
Date: Wed, 25 Jul 2018 22:45:46 +0800
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
 <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
 <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
Message-ID: <05c98785-4812-e519-5555-3d2315d28a1f@freebsd.org>

On 22/7/18 3:11 am, Yuri Pankov wrote:
> Yuri Pankov wrote:
>> Julian Elischer wrote:
>>> I would really like ot get some pointers as to who are our tools
>>> committers at the moment, in particular who might know about these 
>>> issues.
>>> The main issue for me at the moment is the ability to compile the
>>> aesni code in Samba from clang..
>>>
>>> Julian
>>>
>>>
>>> On 20/7/18 7:32 pm, Julian Elischer wrote:
>>>> compiling our samba with gcc 4.2.1 in 12 gave us some off behaviour
>>>> when lld became the linker I think..
>>>>
>>>> 1/ linking needed some directories added to some of the build
>>>> scripts because previously apparently it looked in $SYSROOT/usr/lib
>>>> by default and now it doesn't.
>>>>
>>>> 2/ compiling our samba produces a libtdb.so that has various symbols
>>>> in it, (according to nm(1) ), but when we try link against it we get
>>>> complaints about those symbols not being defined.
>>>>
>>>> 3/ an attempt to switch to using clang to compile everything 
>>>> leads to:
>>>>
>>>>
>>>> "--aes-accel=intelaesni selected and compiler rejects 
>>>> -Wp,-E,-lang-asm.
>>>>
>>>> One wonders whether there is a clang equivalent of 
>>>> "-Wp,-E,-lang-asm"
>>>>
>>>> The AES acceleration is a configure option for the samba package.
>>>>
>>>> Apparently turning it on requires -Wp,-E,-lang-asm.
>>>>
>>>> which apparently gcc 4.2.1 has, but clang doesn't have.
>>>>
>>>> ? ?? FreeBSD clang version 6.0.1 (tags/RELEASE_601/final 335540) 
>>>> (based
>>>> ? ?? on LLVM 6.0.1)
>>>> ? ?? Target: x86_64-unknown-freebsd12.0
>>>> ? ?? Thread model: posix
>>>> ? ?? InstalledDir: /usr/bin
>>>>
>>>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
>>
>> In later GCC versions the cpp's -lang-asm seems to be deprecated in
>> favor of -x assembler-with-cpp as it conflicts with -l option.
>>
>> Could you try changing the -Wp,-E,-lang-asm to 
>> -Wp,-E,-xassembler-with-cpp?
>
> Just tried it myself, and if you indeed mean the 
> third_party/aesni-intel/aesni-intel_asm.c, the following seems to 
> work for me:
>
> clang -xassembler-with-cpp -c third_party/aesni-intel/aesni-intel_asm.c

when I try it I get lots of errors due to hte fact that there are 
assembled comments that start with #
and they are all cited as errors by clang.
I had to put '//' before about 80 lines line that.


>
>>>> possible work arrounds include:
>>>>
>>>> 1/ Get gcc/lld to produce a library from which lld can find the 
>>>> symbols
>>>>
>>>> 2/ find a way to compile this with clang but everything else with 
>>>> gcc?
>>>>
>>>> 3/ find a way to allow clang to use
>>>> -Wp,-E,-lang-asm
>>>>
>>>> whatever that means
>>>>
>>>>
>>>> Thoughts from any tools people?
>
>


From jhb at FreeBSD.org  Wed Jul 25 15:40:03 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Wed, 25 Jul 2018 08:39:53 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
Message-ID: <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>

On 7/24/18 11:39 PM, Mark Millard wrote:
> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>> (head -r336573 after the prior 6596's -r336565 ):
>>
>> --- all_subdir_lib/ofed ---
>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>                 from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>  atomic_store(&lock->cnt, 0);
>>  ^
>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>  if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>  ^~
>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>  ^~
>> . . .
>> --- all_subdir_lib/ofed ---
>> *** [acm.o] Error code 1
>>
>>
>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>> -r336700 ) still shows this type of error.
> 
> 
> [I should have a subject with "head -r336568 through -r336570 . . .".]
> 
> From what I can tell looking around having something like:
> 
> if (atomic_fetch_add(&lock->cnt, 1) > 0)
> 
> involve a __atomic_fetch_add indicates that:
> 
> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
> 
> was in use instead of FreeBSD's stdatomic.h file.
> 
> If this is right, then the issue may be tied to head -r335782
> implicitly changing the order of the include file directory
> searching for builds via the devel/*-gcc .
> 
> (I reverted -r335782 in my environment some time ago and have
> not run into this problem in my context so far.)

C11 atomics should work fine with compiler-provided headers since they
are a part of the language (and the system stdatomic.h simply attempts
to mimic the compiler-provided header in case it is missing).

Simple standalone tests of _Atomic(int) with GCC don't trigger those
failures when using its stdatomic.h, so there is probably something else
going on with kernel includes being used while building the library,
etc.  The last time we had this issue with stdarg.h it was because a
header shared between the kernel and userland always used '<machine/stdarg.h>'
which is correct for the kernel but not for userland.

-- 
John Baldwin

From marklmi at yahoo.com  Wed Jul 25 17:09:26 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Wed, 25 Jul 2018 10:09:14 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
Message-ID: <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>



On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:

> On 7/24/18 11:39 PM, Mark Millard wrote:
>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>> 
>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>> (head -r336573 after the prior 6596's -r336565 ):
>>> 
>>> --- all_subdir_lib/ofed ---
>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>                from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>> atomic_store(&lock->cnt, 0);
>>> ^
>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>> ^~
>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>> ^~
>>> . . .
>>> --- all_subdir_lib/ofed ---
>>> *** [acm.o] Error code 1
>>> 
>>> 
>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>> -r336700 ) still shows this type of error.
>> 
>> 
>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>> 
>> From what I can tell looking around having something like:
>> 
>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>> 
>> involve a __atomic_fetch_add indicates that:
>> 
>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>> 
>> was in use instead of FreeBSD's stdatomic.h file.
>> 
>> If this is right, then the issue may be tied to head -r335782
>> implicitly changing the order of the include file directory
>> searching for builds via the devel/*-gcc .
>> 
>> (I reverted -r335782 in my environment some time ago and have
>> not run into this problem in my context so far.)
> 
> C11 atomics should work fine with compiler-provided headers since they
> are a part of the language (and the system stdatomic.h simply attempts
> to mimic the compiler-provided header in case it is missing).
> 
> Simple standalone tests of _Atomic(int) with GCC don't trigger those
> failures when using its stdatomic.h, so there is probably something else
> going on with kernel includes being used while building the library,
> etc.  The last time we had this issue with stdarg.h it was because a
> header shared between the kernel and userland always used '<machine/stdarg.h>'
> which is correct for the kernel but not for userland.

I did misread the headers. FreeBSD has the likes of:

#if defined(__CLANG_ATOMICS)
. . .
#define	atomic_fetch_add_explicit(object, operand, order)		\
	__c11_atomic_fetch_add(object, operand, order)
. . .
#elif defined(__GNUC_ATOMICS)
. . .
#define	atomic_fetch_add_explicit(object, operand, order)		\
	__atomic_fetch_add(&(object)->__val, operand, order)
. . .
#endif
. . .
#define	atomic_fetch_add(object, operand)				\
	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)

so __atomic_fetch_add would occur.

But so far I do not see the problem with -r335782 reverted. I last built
-r336693 last night via devel/amd64-gcc (via xtoolchain).

From what I can tell FreeBSD defines:

#if !defined(__CLANG_ATOMICS)
#define	_Atomic(T)			struct { volatile T __val; }
#endif

and that struct is being used in &(object)->__val is what the
error reports are about. So that would be, for example,

&(&lock->cnt)->__val

This would appear to suggest that __val itself had a type meeting:

operand type struct <anonymous>

for T in _Atomic(T) .

(This is independent of just what the issue traces back to: just
the net result on ci.freebsd.org . No claim that you are right
or wrong here. I'll not be looking any more until this afternoon
or night.)


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From jhb at FreeBSD.org  Wed Jul 25 17:53:30 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Wed, 25 Jul 2018 10:53:27 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
Message-ID: <7c4e995d-ec64-030a-ed84-7a211166b993@FreeBSD.org>

On 7/25/18 10:09 AM, Mark Millard wrote:
> 
> 
> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
> 
>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>
>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>>
>>>> --- all_subdir_lib/ofed ---
>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>                from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>> atomic_store(&lock->cnt, 0);
>>>> ^
>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>> ^~
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>> ^~
>>>> . . .
>>>> --- all_subdir_lib/ofed ---
>>>> *** [acm.o] Error code 1
>>>>
>>>>
>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>> -r336700 ) still shows this type of error.
>>>
>>>
>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>>
>>> From what I can tell looking around having something like:
>>>
>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>
>>> involve a __atomic_fetch_add indicates that:
>>>
>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>>
>>> was in use instead of FreeBSD's stdatomic.h file.
>>>
>>> If this is right, then the issue may be tied to head -r335782
>>> implicitly changing the order of the include file directory
>>> searching for builds via the devel/*-gcc .
>>>
>>> (I reverted -r335782 in my environment some time ago and have
>>> not run into this problem in my context so far.)
>>
>> C11 atomics should work fine with compiler-provided headers since they
>> are a part of the language (and the system stdatomic.h simply attempts
>> to mimic the compiler-provided header in case it is missing).
>>
>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>> failures when using its stdatomic.h, so there is probably something else
>> going on with kernel includes being used while building the library,
>> etc.  The last time we had this issue with stdarg.h it was because a
>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>> which is correct for the kernel but not for userland.
> 
> I did misread the headers. FreeBSD has the likes of:
> 
> #if defined(__CLANG_ATOMICS)
> . . .
> #define	atomic_fetch_add_explicit(object, operand, order)		\
> 	__c11_atomic_fetch_add(object, operand, order)
> . . .
> #elif defined(__GNUC_ATOMICS)
> . . .
> #define	atomic_fetch_add_explicit(object, operand, order)		\
> 	__atomic_fetch_add(&(object)->__val, operand, order)
> . . .
> #endif
> . . .
> #define	atomic_fetch_add(object, operand)				\
> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
> 
> so __atomic_fetch_add would occur.
> 
> But so far I do not see the problem with -r335782 reverted. I last built
> -r336693 last night via devel/amd64-gcc (via xtoolchain).
> 
> From what I can tell FreeBSD defines:
> 
> #if !defined(__CLANG_ATOMICS)
> #define	_Atomic(T)			struct { volatile T __val; }
> #endif

This looks wrong for modern GCC supporting C11 atomics.  What is happening is
that this is probably overriding the compiler's builtin _Atomic and then the
compiler's stdatomic.h which doesn't look for __val but expects 'object' to
be a plain int is then failing to compile.  Just including sys/cdefs.h in
my test program doesn't trigger the failure though.

-- 
John Baldwin

From o.hartmann at walstatt.org  Wed Jul 25 17:41:41 2018
From: o.hartmann at walstatt.org (O. Hartmann)
Date: Wed, 25 Jul 2018 19:40:51 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
Message-ID: <20180725194118.37c2b442@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
"Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net> schrieb:

[...]

> > Yea, i was hoping fstyp command would report the FAT type, but it does not (request
> > for feature?:)  
> 
> FYI, the file(1) command is very good at disecting a disk image to tell
> you what the MBR looks like, and at looking at partitions if pointed at
> them with the -s option.  It should be able to detect FAT12/16/32.
> 
> root at x230a:/home/ISO/x # file -s /dev/md2s1
> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ", root entries
> 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5, sectors/track 63, heads 1, serial
> number 0xbd4111ee, label: "EFISYS     ", FAT (12 bit), followed by FAT

Thanks for this very helpful hint!

> 
> > 
> > However, the more annoying idea would be to install some OS which will boot with UEFI
> > on this machine, then copy boot1.efi from freebsd to it (the default program the UEFI
> > will load is ESP:EFI/boot/bootx64.efi  in case of UEFI64 and
> > ESP:EFI/boot/bootia32.efi for EFI32. However, we do not support EFI32.
> > 
> > note that boot1.efi alone will not do much but printing on screen how it will search
> > for freebsd, but for the purpose of the test it would suffice - that would give us
> > confirmed working ESP file system (since the other os would be able to boot) and then
> > we can confirm if boot1.efi itself is OK.  
> 



- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW1i2PwAKCRDS528fyFhY
lFz5Af9MY41hoAND4OoKCOwExAM7oQYVCpHSz+mo94OBVqSCqcnprdvdE2C1+PiN
Uza7lMvB8KVSqcyxuYbIFD0E5A4bAgCk/lzKwE9hTPBt4gdBx4t7N/XPafOEBEGM
8irGozKbAvikSkhAQTMPtwyE+861AvKy2Dw1o+mQo4AfikJI0dgq
=9cKL
-----END PGP SIGNATURE-----

From o.hartmann at walstatt.org  Wed Jul 25 17:53:31 2018
From: o.hartmann at walstatt.org (O. Hartmann)
Date: Wed, 25 Jul 2018 19:52:50 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
References: <20180713130001.219a0a84@freyja.zeit4.iv.bundesimmobilien.de>
 <68505F98-E840-4148-9E48-BDB350F7431A@me.com>
 <20180713164447.42430301@thor.intern.walstatt.dynvpn.de>
 <680FBB42-75BF-427F-AA3B-6D864E83ED1F@me.com>
 <20180723092735.12a5d2a8@freyja.zeit4.iv.bundesimmobilien.de>
 <80523BE6-C035-482D-B134-23812183DE83@me.com>
 <20180724071514.6cb9d111@freyja.zeit4.iv.bundesimmobilien.de>
 <16439773-3E9A-40FF-99A1-32E97CCEE2C3@me.com>
 <20180725095926.7d52a15a@freyja.zeit4.iv.bundesimmobilien.de>
 <2FCF2BCC-05E5-466A-B1AE-90300990ED1A@me.com>
 <20180725111032.1632b885@freyja.zeit4.iv.bundesimmobilien.de>
 <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
Message-ID: <20180725195317.027a8acd@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Wed, 25 Jul 2018 12:26:13 +0300
Toomas Soome <tsoome at me.com> schrieb:

> > On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> > 
> > On Wed, 25 Jul 2018 11:46:07 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> >   
> >>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Tue, 24 Jul 2018 08:53:36 +0300
> >>> Toomas Soome <tsoome at me.com> wrote:
> >>> 
> >>> 
> >>> Hello  Toomas Soome,
> >>> 
> >>> I CC Allan Jude since I discovered something  weird today regarding the UEFI
> >>> boot capabilities of USB flash devices and SSDs. See below.
> >>>   
> >>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>> 
> >>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>   
> >>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>> 
> >>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>>>   
> >>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>>>> 
> >>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>>>> Hash: SHA512
> >>>>>>>>> 
> >>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:       
> >>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>> wrote:
> >>>>>>>>>>> 
> >>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on GPT
> >>>>>>>>>>> drives where the first partition begins at block 40 of the hdd/ssd.
> >>>>>>>>>>> 
> >>>>>>>>>>> I have two host in private use based on an
> >>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge, Socket
> >>>>>>>>>>> LGA1155). Both boards are equipted with the lates official available
> >>>>>>>>>>> AMI firmware revision, dating to 2013. This is for the Z77-Pro4-M
> >>>>>>>>>>> revision 2.0 (2013/7/23) and for the Z77 Pro4 revision 1.8
> >>>>>>>>>>> (2013/7/17). For both boards a BETA revision for the
> >>>>>>>>>>> Spectre/Meltdown mitigation is available, but I didn't test that.
> >>>>>>>>>>> But please read.
> >>>>>>>>>>> 
> >>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu Esprimo
> >>>>>>>>>>> Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for 3413-A1x, date
> >>>>>>>>>>> 05/25/2018 (or 20180525).
> >>>>>>>>>>> 
> >>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall the
> >>>>>>>>>>> OS using UEFI-only boot method on a GPT partitioned device fails.
> >>>>>>>>>>> The ASRock boards jump immediately into the firmware, the Fujitsu
> >>>>>>>>>>> offers some kind of CPU/Memory/HDD test facility.
> >>>>>>>>>>> 
> >>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot only
> >>>>>>>>>>> is implied, the MBR partitioned FreeBSD installation USB flash
> >>>>>>>>>>> device does boot in UEFI! I guess I can assume this when the well
> >>>>>>>>>>> known clumsy 80x25 char console suddenly gets bright and shiny with
> >>>>>>>>>>> a much higher resoltion as long the GPU supports EFI GOP. Looking
> >>>>>>>>>>> with gpart at the USB flash drives reveals that the EFI partition
> >>>>>>>>>>> starts at block 1 of the device and the device has a MBR layout. I
> >>>>>>>>>>> haven't found a way to force the GPT scheme, when initialised via
> >>>>>>>>>>> gpart, to let the partitions start at block 1. This might be a naiv
> >>>>>>>>>>> thinking, so please be patient with me.
> >>>>>>>>>>> 
> >>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
> >>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI and
> >>>>>>>>>>> that worked - FreeBSD not. I gave up on that that time. Now, having
> >>>>>>>>>>> the very same issues with a new Fujitsu system, leaves me with the
> >>>>>>>>>>> impression that FreeBSD's UEFI implementation might have problems
> >>>>>>>>>>> I'm not aware of.
> >>>>>>>>>>> 
> >>>>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>>>   
> >>>>>>>>>> 
> >>>>>>>>>> The first thing to check is if the secure boot is disabled. We do not
> >>>>>>>>>> support secure boot at all at this time.          
> >>>>>>>>> 
> >>>>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>>>   
> >>>>>>>>>> 
> >>>>>>>>>> If you have efi or bios version running - you can check from either
> >>>>>>>>>> console variable value (it can have efi or vidconsole or comconsole)
> >>>>>>>>>> or better yet, see if efi-version is set (show efi-version) - if
> >>>>>>>>>> efi-version is not set, it is BIOS loader running. Another indirect
> >>>>>>>>>> way is to see lsdev -v, with device paths present, it is
> >>>>>>>>>> uefi:)          
> >>>>>>>>> 
> >>>>>>>>> What are you talking about?
> >>>>>>>>> What is the point of entry - running system, loader?
> >>>>>>>>> 
> >>>>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>>>> 
> >>>>>>>>> This makes me quite sure that the system has booted via BIOS - as I'm
> >>>>>>>>> sure since I've checked that many times. UEFI doesn't work on those
> >>>>>>>>> systems with FreeBSD. I'm not sure antmore, but I tried also Windows 7
> >>>>>>>>> on those mainboards booting via UEFI - and I might recall that they
> >>>>>>>>> failed also. I also recall that there were issues with earlier UEFI
> >>>>>>>>> versions regarding booting only Windows 8/8.1 - and nothing else, but
> >>>>>>>>> the fact that Linux worked confuses me a bit.
> >>>>>>>>> 
> >>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
> >>>>>>>>> all - who cares, I intend to purchase new server grade hardware. But
> >>>>>>>>> the more puzzling issue is with the Fujitsu, which I consider serious
> >>>>>>>>> and from the behaviour the Fujitsu failure looks exactly like the
> >>>>>>>>> ASRock - Windows 7 works, RedHat 7.5 works (I assume I can trust the
> >>>>>>>>> Firmware settings when I disable CSM support, that the Firmware will
> >>>>>>>>> only EFI/UEFI capable loader? Or is there a ghosty override somwhere
> >>>>>>>>> to be expected?). Also on ASRock disabling CSM should ensure not
> >>>>>>>>> booting a dual-bootstrap-capable system. This said, on the recent
> >>>>>>>>> Fujitsu, it seems to boil down to a FreeBSD UEFI-firmware interaction
> >>>>>>>>> problem, while the ASRock is still under suspicion to be broken by
> >>>>>>>>> design.         
> >>>>>>>>>> 
> >>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this is
> >>>>>>>>>> because at sector 0 there is MBR (for compatibility), sector 1 is GPT
> >>>>>>>>>> table and then sectors 2-33 have GPT partition table entries, so the
> >>>>>>>>>> first possible data sector is 34 (absolute 34). Thats assuming 512B
> >>>>>>>>>> sectors. For details see UEFI 2.7 Chapter 5.3.1 page 131.          
> >>>>>>>>> 
> >>>>>>>>> Thanks for the explanation. That implies the installer did right,
> >>>>>>>>> gpart did also right and therefore there must be an issue with the
> >>>>>>>>> stuff located within the EFI partition?         
> >>>>>>>> 
> >>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach BIOS
> >>>>>>>> loader at all or not - that is, if the BIOS bootstrap is actually
> >>>>>>>> caring to read the MBR code and start it, since once the MBR code is
> >>>>>>>> started, it is all about our code.        
> >>>>>>> 
> >>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or do
> >>>>>>> you mean that specific portion of the UEFI firmware, which looks for the
> >>>>>>> proper UEFI partition?
> >>>>>>>   
> >>>>>> 
> >>>>>> BIOS as either native or CSM. Note that from boot code point of view the
> >>>>>> CSM boot *is* BIOS boot, we have no access to UEFI features.
> >>>>>>   
> >>>>>>> 
> >>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
> >>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
> >>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched off
> >>>>>>> in the firmware. Again: GPT partition scheme.
> >>>>>>> 
> >>>>>>> The system boots properly if a second partition of type "freebsd-boot"
> >>>>>>> is applied and bootcode is properly applied via "gpart bootcode
> >>>>>>> -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is the device).         
> >>>>>>>> 
> >>>>>>>> btw, you can try to validate the installed boot blocks by using recent
> >>>>>>>> enough loader (usb or iso) and then you can use from OK prompt:        
> >>>>>>> 
> >>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>>>> 
> >>>>>>> OK lsdev
> >>>>>>> disk devices:
> >>>>>>> 	disk0:		BIOS DRIVE C ...
> >>>>>>> 
> >>>>>>> 		disk0p1:	EFI
> >>>>>>> 		disk0p2:	FreeBSD BOOT
> >>>>>>> 		disk0p3:	FreeBSD SWAP
> >>>>>>> 		disk0p4:	FreeBSD ZFS
> >>>>>>> zfs devices:
> >>>>>>> 	zfs:zroot
> >>>>>>> 
> >>>>>>> OK chain disk0
> >>>>>>> open failed     (so for disk0p{1-4}.
> >>>>>>> 
> >>>>>>> OK chain zroot
> >>>>>>> failed to read disk (just for completeness)        
> >>>>>> 
> >>>>>> 
> >>>>>> chain command does use only device name (such as disk0: or disk0p2: ),
> >>>>>> but not zfs pool as device.  I just found I haven?t ported the code to
> >>>>>> read the file.      
> >>>>> 
> >>>>> ??
> >>>>>   
> >>>>>> 
> >>>>>> the point for chain command test is to see if the normal read and execute
> >>>>>> would work, so in your case please try:
> >>>>>> 
> >>>>>> chain disk0:      
> >>>>> 
> >>>>> As stated above, I did so, and the result is also mentioned above, I
> >>>>> always get "open failed".
> >>>>> This is the same for 
> >>>>> 
> >>>>> chain disk0
> >>>>> chain disk0p1
> >>>>> chain disk0p2
> >>>>> chain disk0p3
> >>>>> chain disk0p4
> >>>>> 
> >>>>> as already said. CSM is enabled in this case.      
> >>>> 
> >>>> sigh? chain command does take device as argument, device must always end
> >>>> with colon?. in this case, the devil is in details:) as I wrote above, the
> >>>> command should be:
> >>>> 
> >>>> chain disk0:
> >>>> 
> >>>> The disk0p1: etc will only work when partition boot code was installed
> >>>> (which you most likely do not have - the only possible candidate could be
> >>>> FreeBSD ZFS partition).    
> >>> 
> >>> The command "chain disk0:" works as expected (CSM enabled, GPT partition
> >>> scheme, but with PMBR bootblock installed and freebsd-boot partition
> >>> conatining gptzfsboot installed.
> >>> 
> >>>   
> >>>>   
> >>>>>   
> >>>>>> 
> >>>>>> to read pmbr (512B) and execute it. The expected outcome would be that
> >>>>>> pmbr boot code would browse the GPT, read stage1 from disk0p2: and
> >>>>>> execute it; stage1 would detect FreeBSD ZFS from disk0p4: and load and
> >>>>>> execute /boot/loader. If that will happen, it means the boot code in our
> >>>>>> stages is just fine, but the bios (CSM) does not load pmbr?.  if thats
> >>>>>> true, it would mean that you either need to use UEFI boot or need to have
> >>>>>> some hack to fool the BIOS or just not use GPT on that machine with
> >>>>>> CSM.      
> >>>>> 
> >>>>> To make it clear here: The only way to boot this box is using CSM (as it
> >>>>> is the same with the ASRock boards mentioned earlier). But my intention
> >>>>> is to disable CSM and use a GPT/UEFI environment only! And GPT/UEFI
> >>>>> doesn't work with FreeBSD, neither with 12-CURRENT, nor 11.2-RELENG.
> >>>>> 
> >>>>> It would be nice if this could be fixed. I'm more interested in the fix on
> >>>>> the recent Fujitsu device than the outdated ASRock crap, but if the fix
> >>>>> for the Fujitsu Firmware could fix older issues as a byproduct, I'd
> >>>>> appreciate that.
> >>>>> 
> >>>>> Kind regards,
> >>>>>   
> >>>> 
> >>>> ok, somehow I have lost that part of the discussion. Well, you wrote that
> >>>> the UEFI boot fails when the first partition starts from sector 40 - does
> >>>> it mean you have boot when the partition will start from some other
> >>>> sector? I think, there is something else going on.    
> >>> 
> >>> Well, I simply try to describe what I "see" to make things disambiguous. I'm
> >>> not familiar with the deeper insights of disk layouts on a binary level. So,
> >>> you explained to me the reason, why ESP (EGI partition) starts at block 40.
> >>> I compared that to the FreeBSD USB flash image FreeBSD provides, but this is
> >>> another story since the image uses MBR scheme as I figured out.
> >>> 
> >>>   
> >>>> 
> >>>> What you can do is to see if that firmware will offer you EFI shell option,
> >>>> from there you can try to start the bootx64.efi manually and see what error
> >>>> you will get. However, the number 1 cause for failing to start the
> >>>> bootloader in UEFI is secure boot - we do not support it and secure boot
> >>>> must be switched off. 
> >>>> 
> >>>> However, they seem to claim "The Secure Boot option is available in the
> >>>> UEFI/BIOS of most if not all ASRock boards. It is disabled by default.? 
> >>>> 
> >>>> Still suggest to double check if thats really the case. Also, if the
> >>>> bootx64.efi start will fail and no messages are appearing on screen, then
> >>>> either there is something in firmware logs or you could get them from
> >>>> trying to start bootx64.efi from UEFI shell.    
> >>> 
> >>> Since I'm with this problem since 2014 and try from time to time, be ausred
> >>> that I tried every possible permutationof all reasonable options, even those
> >>> nonsense, to get rid of that problem.
> >>> 
> >>> I never had any problems with any other UEFI capable server/workstation
> >>> firmware so far booting FreeBSD off in UEFI-native (GPT partition scheme,
> >>> CSM disabled) so far - until now, when I ran into this Fujitsu ESPRIMO Q956
> >>> with the most recent firmware (as of lat week, week 29 of 2018) having the
> >>> very same problems. 
> >>> 
> >>> 
> >>> 
> >>> I figured out something strange on the Fujitsu - and that is the same with
> >>> the ASRock boards.
> >>> 
> >>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> >>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
> >>> servers with UEFI-only configurations. I assume at this point that
> >>> disabling on the most recent Fujitsu firmwares on reasonable "new" hardware
> >>> (not older than three years) will disable any(!) legacy BIOS capabilities.
> >>> The same is assumed for the Fujitus ESPRIMO Q956. I can not speak for the
> >>> ASRock A77 Pro4/m boards mentioned above/earlier, they are from 2012/2013
> >>> and "quite old".
> >>> 
> >>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> >>> partition scheme of the flash device is GPT. The layout looks like this:
> >>> 
> >>> gpart show -l da4    
> >>> =>      40  15425456  da4  GPT  (7.4G)    
> >>>       40      2000    1  efiboot0  (1.0M)
> >>>     2040   1453584    3  disk1a  (710M)
> >>>  1455624      4096    5  disk3  (2.0M)
> >>>  1459720  13965776       - free -  (6.7G)
> >>> 
> >>> I created the flash with md, gpart and dd straightforward, efiboot0 is the
> >>> ESP partition and its format/content is created via dd if=/boot/boot1.efifat
> >>> of=/dev/da4p1 - I presume this is very simple.
> >>> 
> >>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
> >>> boards and the Esprimo Q956!
> >>> 
> >>> But any SSD prepared the same way doesn't. Why? 
> >>> 
> >>> On the ASRock, I recall having fiddled around with HDD also for a while
> >>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
> >>> remember. 
> >>> 
> >>> In the lack of proper hardware I'm unable to check whether USB-attached HDD
> >>> or SSD will boot or HDD will boot (just in case the local SATA has problems
> >>> booting UEFI and USB not).
> >>> 
> >>> Kind regards,
> >>> 
> >>> Oliver 
> >>>   
> >> 
> >> Am. well. I think the suggestion to test out FAT32 is still good one to test.
> >> This is because it is known that some vendors do not support booting
> >> FAT12/FAT16 from HDD (the likely reason is that UEFI specification does not
> >> tell which FAT must be supported, and only hint about FAT12/FAT16 in context
> >> of removable devices).  
> > 
> > I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It took me
> > a time to circumvent the installer and I had to install the system manually. In
> > that strain, I also "tried" to establish the ESP with FAT32, as Allen Jude
> > suggested earlier. I didn't find any ad hoc help how to find out the format
> > (FAT12/16/32) of the ESP, so I assume when using 12-CURRENT's or 11.2-RELENG's
> > installer with AUTO-ZFS and GPT (UEFI) (only!) the resulting ESP is FAT12 or
> > FAT16 (300mb by default). I also assume, that when dd'ing the /boo/boot1.efifat
> > image to a partition, the format is FAT, but not FAT32. Therefore, I refomatted
> > the manually created ESP (using "gpart add -t efi ...") using "newfs_msdos -F
> > 32 -b xxx ...". I had to fiddle around a bit with option -b to fit in a proper
> > format to meet a 512mb ESP - I'm not sure whether this is the proper option to
> > deal with. When using the default and only -F32, the size of the partition has
> > to be 4G at least I assume. Having done that, I copied the the content of
> > boot1.efifat (mdconfig -t vnode ..., I guess we know the drill ...) to the
> > newly formatted ESP to /boot/efi/ ...
> > 
> > Having so far no knowledge of how to asure that the created ESP is FAT32, I
> > assume it is FAT32.
> > 
> > The result is negative on the ESPRIMO Q956. When disabling the CSM, the box is
> > not willing to boot from SSD with the ESP prepared as decribed. So, a chance
> > that this might still be due to a misconfiguration lies now within the -b
> > option of newfs_msdos - if the -b option is assumed the proper option?
> > 
> > At the moment, the ESP of the Esprimo is subject to changes, if you wish, but
> > not in size, since it is limited to 512mb.
> > 
> > Thanks and kind regards,
> > 
> > Oliver  
> 
> Yea, i was hoping fstyp command would report the FAT type, but it does not (request for
> feature?:)
> 
> However, the more annoying idea would be to install some OS which will boot with UEFI
> on this machine, then copy boot1.efi from freebsd to it (the default program the UEFI
> will load is ESP:EFI/boot/bootx64.efi  in case of UEFI64 and ESP:EFI/boot/bootia32.efi
> for EFI32. However, we do not support EFI32.

I checked on one of the ASRock Z77-Pro4 systems. On one, I exchangd recently the old SSD
with a new one and installed the new standard ESP of 300mb. Using 

mewfs_msdos -F 32 -b 512 /dev/gpt/efiboot0

workded so far, file -s /dev/gpt/efiboot0 results in:

 /dev/gpt/efiboot0: DOS/MBR boot sector, code offset 0x58+2, OEM-ID "BSD4.4  ",
sectors/track 63, heads 16, sectors 614400 (volumes > 32 MB), FAT (32 bit), sectors/FAT
4726, serial number 0xcefd1106, unlabeled

It doesn't work with either.

> 
> note that boot1.efi alone will not do much but printing on screen how it will search
> for freebsd, but for the purpose of the test it would suffice - that would give us
> confirmed working ESP file system (since the other os would be able to boot) and then
> we can confirm if boot1.efi itself is OK.

I understand. That was also my intention when created manually the FAT32 ESP and
installed manually the ZFS-based 11.2 FBSD - I hoped for any kind of a response from the
firmware having found the EFI partition. But nothing. Even the recent Esprimo is very
resilient to such attempts.

What OS do you suggest? The only available options are RedtHat 7.5 and/or Windows 7/SP1.
I assume disabling CSM leads me towards a UEFI-only installation? I have no experience in
how to deal with Linux' boot mechanism - but I'll give it a try if it helps.

By the way: newfs_msdos offers 3 options with special meanings influencing the result
whether to be able to format a partition FAT32 or not: -b (block-size), -S (sector-size)
and -c (cluster-size). Do they have any serious influence on the capabilities of the
firmware to detect the ESP or not?

Kind regards,
Oliver

> 
> rgds,
> toomas
> 


- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW1i5DQAKCRDS528fyFhY
lAp2Af997RRZjZLuNLG8dD39OqV275K023GEpp56NPld9mOI+DdF/deum7oh8wau
jMOaF42V2y+dsLKIdTR9hdQpMrOqAgCILAhB9qfb8GjK6Q7x4NjlakcVnWZkqGf/
j9cUQ5fCGCh2yA2tnl2J+JVUKFqMLsIKhxvw6HmC1beJRiABVkWV
=vxE8
-----END PGP SIGNATURE-----

From marklmi at yahoo.com  Wed Jul 25 21:10:14 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Wed, 25 Jul 2018 14:10:00 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
Message-ID: <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>



On 2018-Jul-25, at 10:09 AM, Mark Millard <marklmi at yahoo.com> wrote:

> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
> 
>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>> 
>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>> 
>>>> --- all_subdir_lib/ofed ---
>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>               from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>> atomic_store(&lock->cnt, 0);
>>>> ^
>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>> ^~
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>> ^~
>>>> . . .
>>>> --- all_subdir_lib/ofed ---
>>>> *** [acm.o] Error code 1
>>>> 
>>>> 
>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>> -r336700 ) still shows this type of error.
>>> 
>>> 
>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>> 
>>> From what I can tell looking around having something like:
>>> 
>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>> 
>>> involve a __atomic_fetch_add indicates that:
>>> 
>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>> 
>>> was in use instead of FreeBSD's stdatomic.h file.
>>> 
>>> If this is right, then the issue may be tied to head -r335782
>>> implicitly changing the order of the include file directory
>>> searching for builds via the devel/*-gcc .
>>> 
>>> (I reverted -r335782 in my environment some time ago and have
>>> not run into this problem in my context so far.)
>> 
>> C11 atomics should work fine with compiler-provided headers since they
>> are a part of the language (and the system stdatomic.h simply attempts
>> to mimic the compiler-provided header in case it is missing).
>> 
>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>> failures when using its stdatomic.h, so there is probably something else
>> going on with kernel includes being used while building the library,
>> etc.  The last time we had this issue with stdarg.h it was because a
>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>> which is correct for the kernel but not for userland.
> 
> I did misread the headers. FreeBSD has the likes of:
> 
> #if defined(__CLANG_ATOMICS)
> . . .
> #define	atomic_fetch_add_explicit(object, operand, order)		\
> 	__c11_atomic_fetch_add(object, operand, order)
> . . .
> #elif defined(__GNUC_ATOMICS)
> . . .
> #define	atomic_fetch_add_explicit(object, operand, order)		\
> 	__atomic_fetch_add(&(object)->__val, operand, order)
> . . .
> #endif
> . . .
> #define	atomic_fetch_add(object, operand)				\
> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
> 
> so __atomic_fetch_add would occur.
> 
> But so far I do not see the problem with -r335782 reverted. I last built
> -r336693 last night via devel/amd64-gcc (via xtoolchain).
> 
> From what I can tell FreeBSD defines:
> 
> #if !defined(__CLANG_ATOMICS)
> #define	_Atomic(T)			struct { volatile T __val; }
> #endif
> 
> and that struct is being used in &(object)->__val is what the
> error reports are about. So that would be, for example,
> 
> &(&lock->cnt)->__val
> 
> This would appear to suggest that __val itself had a type meeting:
> 
> operand type struct <anonymous>
> 
> for T in _Atomic(T) .
> 
> (This is independent of just what the issue traces back to: just
> the net result on ci.freebsd.org . No claim that you are right
> or wrong here. I'll not be looking any more until this afternoon
> or night.)

Going in a somewhat different direction . . .

Looking around I found https://bugs.llvm.org/show_bug.cgi?id=26462
which is titled:

26462 ? GCC/clang C11 _Atomic incompatibility

It appears that the normal source of platform ABI definitions are
not explicit/detailed in the area and allow for incompatibilities
in this area. clang and gcc made differing choices absent being
constrained to match.

An example (a powerpc64 context was indicated):

struct A16 { char val[16]; }; 
_Atomic struct A16 a16; 
// GCC:
_Static_assert(_Alignof(a16) == 16, ""); 
// Clang:
_Static_assert(_Alignof(a16) == 1, ""); 


Non-power-of-2 is a general problem
(not a powerpc64 context from what I can
tell):

struct A3 { char val[3]; };
_Atomic struct A3 a3;
// GCC:
_Static_assert(sizeof(a3) == 3, "");
_Static_assert(_Alignof(a3) == 1, "");
// Clang:
_Static_assert(sizeof(a3) == 4, "");
_Static_assert(_Alignof(a3) == 4, "");



Comment 6 (by John McCall) is relevant:

QUOTE
Anyway, while I prefer the Clang rule, the GCC rule is defensible, as are any number of other rules.  The important point, however, is that having this discussion is not the right approach to solving this problem.  The layout of _Atomic(T) is ABI.  ABI rules are not generally determined by compiler implementors making things up as they go along, or at least they shouldn't be.  The Darwin ABI for _Atomic is the rule implemented in Clang, which we actually did think about carefully when we adopted it.  Other platforms need to make their own call, and it probably shouldn't just be "whatever's implemented in GCC", especially on other platforms where GCC is not the system compiler.
END QUOTE


(I do nto claim to have proivided all the material that should
be read in https://bugs.llvm.org/show_bug.cgi?id=26462 .)

It may be that FreeBSD needs to be the source of the ABI definitions
involved if clang and gcc freeBSD builds are to be interoperable in
this area. But this could mean avoiding builtins?

If any of this is inlined and so not behind a more stable interface,
it looks like clang and gcc can not be mixed for the same instances
of various _Atomic possibilities.


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From marklmi at yahoo.com  Thu Jul 26 01:52:20 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Wed, 25 Jul 2018 18:52:05 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
Message-ID: <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>



On 2018-Jul-25, at 2:10 PM, Mark Millard <marklmi at yahoo.com> wrote:



> On 2018-Jul-25, at 10:09 AM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
>> 
>>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>> 
>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>>> 
>>>>> --- all_subdir_lib/ofed ---
>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>>              from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>>> atomic_store(&lock->cnt, 0);
>>>>> ^
>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>> ^~
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>>> ^~
>>>>> . . .
>>>>> --- all_subdir_lib/ofed ---
>>>>> *** [acm.o] Error code 1
>>>>> 
>>>>> 
>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>>> -r336700 ) still shows this type of error.
>>>> 
>>>> 
>>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>>> 
>>>> From what I can tell looking around having something like:
>>>> 
>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>> 
>>>> involve a __atomic_fetch_add indicates that:
>>>> 
>>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>>> 
>>>> was in use instead of FreeBSD's stdatomic.h file.
>>>> 
>>>> If this is right, then the issue may be tied to head -r335782
>>>> implicitly changing the order of the include file directory
>>>> searching for builds via the devel/*-gcc .
>>>> 
>>>> (I reverted -r335782 in my environment some time ago and have
>>>> not run into this problem in my context so far.)
>>> 
>>> C11 atomics should work fine with compiler-provided headers since they
>>> are a part of the language (and the system stdatomic.h simply attempts
>>> to mimic the compiler-provided header in case it is missing).
>>> 
>>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>>> failures when using its stdatomic.h, so there is probably something else
>>> going on with kernel includes being used while building the library,
>>> etc.  The last time we had this issue with stdarg.h it was because a
>>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>>> which is correct for the kernel but not for userland.
>> 
>> I did misread the headers. FreeBSD has the likes of:
>> 
>> #if defined(__CLANG_ATOMICS)
>> . . .
>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>> 	__c11_atomic_fetch_add(object, operand, order)
>> . . .
>> #elif defined(__GNUC_ATOMICS)
>> . . .
>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>> 	__atomic_fetch_add(&(object)->__val, operand, order)
>> . . .
>> #endif
>> . . .
>> #define	atomic_fetch_add(object, operand)				\
>> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
>> 
>> so __atomic_fetch_add would occur.
>> 
>> But so far I do not see the problem with -r335782 reverted. I last built
>> -r336693 last night via devel/amd64-gcc (via xtoolchain).
>> 
>> From what I can tell FreeBSD defines:
>> 
>> #if !defined(__CLANG_ATOMICS)
>> #define	_Atomic(T)			struct { volatile T __val; }
>> #endif
>> 
>> and that struct is being used in &(object)->__val is what the
>> error reports are about. So that would be, for example,
>> 
>> &(&lock->cnt)->__val
>> 
>> This would appear to suggest that __val itself had a type meeting:
>> 
>> operand type struct <anonymous>
>> 
>> for T in _Atomic(T) .
>> 
>> (This is independent of just what the issue traces back to: just
>> the net result on ci.freebsd.org . No claim that you are right
>> or wrong here. I'll not be looking any more until this afternoon
>> or night.)
> 
> Going in a somewhat different direction . . .
> 
> Looking around I found https://bugs.llvm.org/show_bug.cgi?id=26462
> which is titled:
> 
> 26462 ? GCC/clang C11 _Atomic incompatibility
> 
> It appears that the normal source of platform ABI definitions are
> not explicit/detailed in the area and allow for incompatibilities
> in this area. clang and gcc made differing choices absent being
> constrained to match.
> 
> An example (a powerpc64 context was indicated):
> 
> struct A16 { char val[16]; }; 
> _Atomic struct A16 a16; 
> // GCC:
> _Static_assert(_Alignof(a16) == 16, ""); 
> // Clang:
> _Static_assert(_Alignof(a16) == 1, ""); 
> 
> 
> Non-power-of-2 is a general problem
> (not a powerpc64 context from what I can
> tell):
> 
> struct A3 { char val[3]; };
> _Atomic struct A3 a3;
> // GCC:
> _Static_assert(sizeof(a3) == 3, "");
> _Static_assert(_Alignof(a3) == 1, "");
> // Clang:
> _Static_assert(sizeof(a3) == 4, "");
> _Static_assert(_Alignof(a3) == 4, "");
> 
> 
> 
> Comment 6 (by John McCall) is relevant:
> 
> QUOTE
> Anyway, while I prefer the Clang rule, the GCC rule is defensible, as are any number of other rules.  The important point, however, is that having this discussion is not the right approach to solving this problem.  The layout of _Atomic(T) is ABI.  ABI rules are not generally determined by compiler implementors making things up as they go along, or at least they shouldn't be.  The Darwin ABI for _Atomic is the rule implemented in Clang, which we actually did think about carefully when we adopted it.  Other platforms need to make their own call, and it probably shouldn't just be "whatever's implemented in GCC", especially on other platforms where GCC is not the system compiler.
> END QUOTE
> 
> 
> (I do nto claim to have proivided all the material that should
> be read in https://bugs.llvm.org/show_bug.cgi?id=26462 .)
> 
> It may be that FreeBSD needs to be the source of the ABI definitions
> involved if clang and gcc freeBSD builds are to be interoperable in
> this area. But this could mean avoiding builtins?
> 
> If any of this is inlined and so not behind a more stable interface,
> it looks like clang and gcc can not be mixed for the same instances
> of various _Atomic possibilities.
> 
> 


Going back to the code being compiled and 
confirming your note:
( /usr/src/contrib/ofed/librdmacm/cma.h )

typedef struct {
        sem_t sem;
        _Atomic(int) cnt;
} fastlock_t;
. . .
static inline void fastlock_acquire(fastlock_t *lock)
{
        if (atomic_fetch_add(&lock->cnt, 1) > 0)
                sem_wait(&lock->sem);
}

So lock->cnt is an _Atomic(int) , i.e.,

struct { volatile int __val; }

so overall:

typedef struct {
        sem_t sem;
        struct { volatile int __val; } cnt;
} fastlock_t;


for which: atomic_fetch_add(&lock->cnt, 1) has
for A filled-in in the C11 language official:

atomic_fetch_add (volatile A* obj, M arg)

(generic function) being:

atomic_fetch_add (volatile struct { volatile int __val; }* obj, M arg)

and a direct type-check of that notation for obj would find:

operand type 'struct <anonymous> *'

and that would propagate to GCC's translation to __atomic_fetch_add
via gcc's stdatomic.h :

#define atomic_fetch_add(PTR, VAL) __atomic_fetch_add ((PTR), (VAL), 	\
						       __ATOMIC_SEQ_CST)

So, yes, it looks like the:

#if !defined(__CLANG_ATOMICS)
#define	_Atomic(T)			struct { volatile T __val; }
#endif

overriding the GCC compiler's _Atomic(T) notation is inappropriate
if one is trying for the GCC atomic ABI (via GCC's builtins). (Such
is not the same as the clang atomic ABI for at least some T's on
some architectures.)

(But if always being compatible with clang's atomic ABI was a criteria,
I'm not sure what things should be like when compiling via gcc.)



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From tyler at monkeypox.org  Thu Jul 26 04:53:54 2018
From: tyler at monkeypox.org (R. Tyler Croy)
Date: Wed, 25 Jul 2018 21:47:06 -0700
Subject: em0 link fail
In-Reply-To: <bbfba7da-3f62-17d0-3846-b08f398aac30@protected-networks.net>
References: <739ef71a-f29f-68ea-955a-fb53c57960a6@protected-networks.net>
 <c077fa70-e213-7229-1c19-2509f5db191b@freebsd.org>
 <8e2bf594-6d7e-477e-836b-4cc4483cb525@protected-networks.net>
 <64e462dd-16fc-b57f-7bf2-02068d0e24c8@zyxst.net>
 <7a4607ce-e212-5cba-bc04-1d0abf1a7824@protected-networks.net>
 <bbfba7da-3f62-17d0-3846-b08f398aac30@protected-networks.net>
Message-ID: <20180726044705.GB5081@grape.lasagna.io>

(replies inline)

On Sun, 15 Jul 2018, Michael Butler wrote:

> On 07/05/18 09:54, I wrote:
> > On 07/05/18 09:27, tech-lists wrote:
> >> On 03/07/2018 19:47, Michael Butler wrote:
> >>> That would've been ..
> >>>
> >>> Jun? 1 09:56:15 toshi kernel: FreeBSD 12.0-CURRENT #35 r334484: Fri Jun
> >>> 1 08:25:58 EDT 2018
> >>>
> >>> I'm going to build one with SVN r334862 reverted to see if that works,
> >>
> >> Hi,
> >>
> >> Is it working now? Am asking because a system I'd like to take from
> >> 11-stable to 12 uses the em driver.
> > 
> > No :-( I haven't had the chance yet to revisit it,
> 
> As it turns out, SVN r336313 (committed today) solves the issue I was
> having with the hardware stalling,



Just to add a bit more metadata to this thread, I've seen this exact same behavior for a few months now! I've recently rebuilt to r336294 which still exhibited the problem, with periodic logs such as these:

	Jul 26 04:09:53 strawberry kernel: em1: Watchdog timeout Queue[0]-- resetting
	Jul 26 04:09:53 strawberry kernel: Interface is RUNNING and ACTIVE
	Jul 26 04:09:53 strawberry kernel: em1: TX Queue 0 ------
	Jul 26 04:09:53 strawberry kernel: em1: hw tdh = 524, hw tdt = 544
	Jul 26 04:09:53 strawberry kernel: em1: Tx Queue Status = -2147483648
	Jul 26 04:09:53 strawberry kernel: em1: TX descriptors avail = 1004
	Jul 26 04:09:53 strawberry kernel: em1: Tx Descriptors avail failure = 0
	Jul 26 04:09:53 strawberry kernel: em1: RX Queue 0 ------
	Jul 26 04:09:53 strawberry kernel: em1: hw rdh = 172, hw rdt = 170
	Jul 26 04:09:53 strawberry kernel: em1: RX discarded packets = 0
	Jul 26 04:09:53 strawberry kernel: em1: RX Next to Check = 171
	Jul 26 04:09:53 strawberry kernel: em1: RX Next to Refresh = 170
	Jul 26 04:09:53 strawberry kernel: em1: link state changed to DOWN
	Jul 26 04:09:54 strawberry kernel: em1: link state changed to UP
	Jul 26 04:10:20 strawberry kernel: em1: Watchdog timeout Queue[0]-- resetting
	Jul 26 04:10:20 strawberry kernel: Interface is RUNNING and ACTIVE
	Jul 26 04:10:20 strawberry kernel: em1: TX Queue 0 ------
	Jul 26 04:10:20 strawberry kernel: em1: hw tdh = 0, hw tdt = 358
	Jul 26 04:10:20 strawberry kernel: em1: Tx Queue Status = -2147483648
	Jul 26 04:10:20 strawberry kernel: em1: TX descriptors avail = 666
	Jul 26 04:10:20 strawberry kernel: em1: Tx Descriptors avail failure = 0
	Jul 26 04:10:20 strawberry kernel: em1: RX Queue 0 ------
	Jul 26 04:10:20 strawberry kernel: em1: hw rdh = 0, hw rdt = 1023
	Jul 26 04:10:20 strawberry kernel: em1: RX discarded packets = 0
	Jul 26 04:10:20 strawberry kernel: em1: RX Next to Check = 0
	Jul 26 04:10:20 strawberry kernel: em1: RX Next to Refresh = 1023
	Jul 26 04:10:20 strawberry kernel: em1: link state changed to DOWN


I'll give r336313 a try as soon as possible and corroborate the fixes!


Cheers,
R Tyler Croy
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 195 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180725/4ba93ae0/attachment-0001.sig>

From lists at eitanadler.com  Thu Jul 26 06:29:58 2018
From: lists at eitanadler.com (Eitan Adler)
Date: Wed, 25 Jul 2018 23:29:31 -0700
Subject: error building r336696: cp: asn1_OCSPResponseStatus.c: Bad address
In-Reply-To: <CAF6rxgngWQJHVgk=Tqcqdai-gk+qDXb51rWjYaVVXeSCBocE=w@mail.gmail.com>
References: <CAF6rxgngWQJHVgk=Tqcqdai-gk+qDXb51rWjYaVVXeSCBocE=w@mail.gmail.com>
Message-ID: <CAF6rxgn0Kad0qHDLYqwXr1T9suRPjnJpdAMExBSZP1B07NNXGA@mail.gmail.com>

On Wed, 25 Jul 2018 at 06:31, Eitan Adler <lists at eitanadler.com> wrote:
>
> I'm currently on r335788 and trying to build r336696.

Going to r336238 and then r336732 seems to have succeeded.


-- 
Eitan Adler

From julian at freebsd.org  Thu Jul 26 06:35:10 2018
From: julian at freebsd.org (Julian Elischer)
Date: Thu, 26 Jul 2018 14:34:59 +0800
Subject: gcc/clang interoperability problem with a custom "samba" build in
 recent -current.
In-Reply-To: <0a54cb6e-f528-df63-57f2-6caa3d76ff6c@freebsd.org>
References: <abe47622-ba13-7c3f-9ddd-51c9fd3c40cd@freebsd.org>
 <bd0ad5d1-76ce-28b0-3813-4c11a82cd27d@freebsd.org>
 <c77253cd-3fca-a3a6-2f98-73ecb8c656bc@yuripv.net>
 <3dd60a0d-7a5e-e9f0-3018-d09b5b8ac389@yuripv.net>
 <F5832A14-009D-4FD2-BCE7-D07F96165041@FreeBSD.org>
 <0a54cb6e-f528-df63-57f2-6caa3d76ff6c@freebsd.org>
Message-ID: <2c5d8af1-f703-e33b-2b71-905dc8fe0908@freebsd.org>

On 25/7/18 12:40 am, Julian Elischer wrote:
> On 22/7/18 4:32 am, Dimitry Andric wrote:
>> On 21 Jul 2018, at 21:11, Yuri Pankov <yuripv at yuripv.net> wrote:
>>> Yuri Pankov wrote:
>>>> Julian Elischer wrote:
>> ...
>>>>>> anyone know if there is a clang equivalent of -Wp, -E,-lang-asm?
>>>> In later GCC versions the cpp's -lang-asm seems to be deprecated in
>>>> favor of -x assembler-with-cpp as it conflicts with -l option.
>>>> Could you try changing the -Wp,-E,-lang-asm to 
>>>> -Wp,-E,-xassembler-with-cpp?
I did this but if failed.. I had to reread this email? a few times to 
think of replacing the whole
-Wp,-E,-lang-asm? with just? -xassembler-with-cpp!


>>> Just tried it myself, and if you indeed mean the 
>>> third_party/aesni-intel/aesni-intel_asm.c, the following seems to 
>>> work for me:
>>>
>>> clang -xassembler-with-cpp -c 
>>> third_party/aesni-intel/aesni-intel_asm.c
>> Yes, that is exactly what I suggested to Julian on IRC.? The point is
>> that the ".c" extension is misleading, it should more likely be a ".S"
>> extension.? But maybe this source file is used for multiple purposes.
>>
>> Note that -x assembler-with-cpp should also work fine for gcc.
Ah..? the trick is to remove the -Wp,-E as well...
>>
>> -Dimitry
>>
> thanks
>
> I tried that but the version of the file we have has several lines 
> that caused problems...
>
> a lot of the assembler has assembler comments (starting with '#') 
> which clang complained about and died..
>
> it also had #.align 4
>
> which I HOPE is just a commented out line..
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to 
> "freebsd-current-unsubscribe at freebsd.org"
>


From ohartmann at walstatt.org  Thu Jul 26 13:58:43 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Thu, 26 Jul 2018 15:58:26 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
Message-ID: <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>

On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
"Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net> wrote:

> > > On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> > > 
> > > On Wed, 25 Jul 2018 11:46:07 +0300
> > > Toomas Soome <tsoome at me.com> wrote:
> > >   
> > >>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> > >>> 
> > >>> On Tue, 24 Jul 2018 08:53:36 +0300
> > >>> Toomas Soome <tsoome at me.com> wrote:
> > >>> 
> > >>> 
> > >>> Hello  Toomas Soome,
> > >>> 
> > >>> I CC Allan Jude since I discovered something  weird today regarding the
> > >>> UEFI boot capabilities of USB flash devices and SSDs. See below.
> > >>>   
> > >>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> > >>>>> 
> > >>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> > >>>>> Toomas Soome <tsoome at me.com> wrote:
> > >>>>>   
> > >>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
> > >>>>>>> wrote:
> > >>>>>>> 
> > >>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> > >>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> > >>>>>>>   
> > >>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> > >>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> > >>>>>>>>> 
> > >>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> > >>>>>>>>> Hash: SHA512
> > >>>>>>>>> 
> > >>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> > >>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> > >>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:       
> > >>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
> > >>>>>>>>>>> wrote:
> > >>>>>>>>>>> 
> > >>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on
> > >>>>>>>>>>> GPT drives where the first partition begins at block 40 of the
> > >>>>>>>>>>> hdd/ssd.
> > >>>>>>>>>>> 
> > >>>>>>>>>>> I have two host in private use based on an
> > >>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
> > >>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
> > >>>>>>>>>>> official available AMI firmware revision, dating to 2013. This
> > >>>>>>>>>>> is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for the Z77
> > >>>>>>>>>>> Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> > >>>>>>>>>>> for the Spectre/Meltdown mitigation is available, but I didn't
> > >>>>>>>>>>> test that. But please read.
> > >>>>>>>>>>> 
> > >>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
> > >>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
> > >>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
> > >>>>>>>>>>> 
> > >>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall
> > >>>>>>>>>>> the OS using UEFI-only boot method on a GPT partitioned device
> > >>>>>>>>>>> fails. The ASRock boards jump immediately into the firmware,
> > >>>>>>>>>>> the Fujitsu offers some kind of CPU/Memory/HDD test facility.
> > >>>>>>>>>>> 
> > >>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot
> > >>>>>>>>>>> only is implied, the MBR partitioned FreeBSD installation USB
> > >>>>>>>>>>> flash device does boot in UEFI! I guess I can assume this when
> > >>>>>>>>>>> the well known clumsy 80x25 char console suddenly gets bright
> > >>>>>>>>>>> and shiny with a much higher resoltion as long the GPU supports
> > >>>>>>>>>>> EFI GOP. Looking with gpart at the USB flash drives reveals
> > >>>>>>>>>>> that the EFI partition starts at block 1 of the device and the
> > >>>>>>>>>>> device has a MBR layout. I haven't found a way to force the GPT
> > >>>>>>>>>>> scheme, when initialised via gpart, to let the partitions start
> > >>>>>>>>>>> at block 1. This might be a naiv thinking, so please be patient
> > >>>>>>>>>>> with me.
> > >>>>>>>>>>> 
> > >>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
> > >>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI
> > >>>>>>>>>>> and that worked - FreeBSD not. I gave up on that that time.
> > >>>>>>>>>>> Now, having the very same issues with a new Fujitsu system,
> > >>>>>>>>>>> leaves me with the impression that FreeBSD's UEFI
> > >>>>>>>>>>> implementation might have problems I'm not aware of.
> > >>>>>>>>>>> 
> > >>>>>>>>>>> Can someone shed some light onto this? 
> > >>>>>>>>>>>   
> > >>>>>>>>>> 
> > >>>>>>>>>> The first thing to check is if the secure boot is disabled. We
> > >>>>>>>>>> do not support secure boot at all at this time.          
> > >>>>>>>>> 
> > >>>>>>>>> Secure boot is in every scenario disabled!
> > >>>>>>>>>   
> > >>>>>>>>>> 
> > >>>>>>>>>> If you have efi or bios version running - you can check from
> > >>>>>>>>>> either console variable value (it can have efi or vidconsole or
> > >>>>>>>>>> comconsole) or better yet, see if efi-version is set (show
> > >>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
> > >>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
> > >>>>>>>>>> paths present, it is uefi:)          
> > >>>>>>>>> 
> > >>>>>>>>> What are you talking about?
> > >>>>>>>>> What is the point of entry - running system, loader?
> > >>>>>>>>> 
> > >>>>>>>>> sysct machdep.bootmethod: BIOS
> > >>>>>>>>> 
> > >>>>>>>>> This makes me quite sure that the system has booted via BIOS - as
> > >>>>>>>>> I'm sure since I've checked that many times. UEFI doesn't work on
> > >>>>>>>>> those systems with FreeBSD. I'm not sure antmore, but I tried
> > >>>>>>>>> also Windows 7 on those mainboards booting via UEFI - and I might
> > >>>>>>>>> recall that they failed also. I also recall that there were
> > >>>>>>>>> issues with earlier UEFI versions regarding booting only Windows
> > >>>>>>>>> 8/8.1 - and nothing else, but the fact that Linux worked confuses
> > >>>>>>>>> me a bit.
> > >>>>>>>>> 
> > >>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
> > >>>>>>>>> all - who cares, I intend to purchase new server grade hardware.
> > >>>>>>>>> But the more puzzling issue is with the Fujitsu, which I consider
> > >>>>>>>>> serious and from the behaviour the Fujitsu failure looks exactly
> > >>>>>>>>> like the ASRock - Windows 7 works, RedHat 7.5 works (I assume I
> > >>>>>>>>> can trust the Firmware settings when I disable CSM support, that
> > >>>>>>>>> the Firmware will only EFI/UEFI capable loader? Or is there a
> > >>>>>>>>> ghosty override somwhere to be expected?). Also on ASRock
> > >>>>>>>>> disabling CSM should ensure not booting a dual-bootstrap-capable
> > >>>>>>>>> system. This said, on the recent Fujitsu, it seems to boil down
> > >>>>>>>>> to a FreeBSD UEFI-firmware interaction problem, while the ASRock
> > >>>>>>>>> is still under suspicion to be broken by design.         
> > >>>>>>>>>> 
> > >>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this
> > >>>>>>>>>> is because at sector 0 there is MBR (for compatibility), sector
> > >>>>>>>>>> 1 is GPT table and then sectors 2-33 have GPT partition table
> > >>>>>>>>>> entries, so the first possible data sector is 34 (absolute 34).
> > >>>>>>>>>> Thats assuming 512B sectors. For details see UEFI 2.7 Chapter
> > >>>>>>>>>> 5.3.1 page 131.          
> > >>>>>>>>> 
> > >>>>>>>>> Thanks for the explanation. That implies the installer did right,
> > >>>>>>>>> gpart did also right and therefore there must be an issue with the
> > >>>>>>>>> stuff located within the EFI partition?         
> > >>>>>>>> 
> > >>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
> > >>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
> > >>>>>>>> actually caring to read the MBR code and start it, since once the
> > >>>>>>>> MBR code is started, it is all about our code.        
> > >>>>>>> 
> > >>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or
> > >>>>>>> do you mean that specific portion of the UEFI firmware, which looks
> > >>>>>>> for the proper UEFI partition?
> > >>>>>>>   
> > >>>>>> 
> > >>>>>> BIOS as either native or CSM. Note that from boot code point of view
> > >>>>>> the CSM boot *is* BIOS boot, we have no access to UEFI features.
> > >>>>>>   
> > >>>>>>> 
> > >>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
> > >>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
> > >>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched
> > >>>>>>> off in the firmware. Again: GPT partition scheme.
> > >>>>>>> 
> > >>>>>>> The system boots properly if a second partition of type
> > >>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
> > >>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is
> > >>>>>>> the device).         
> > >>>>>>>> 
> > >>>>>>>> btw, you can try to validate the installed boot blocks by using
> > >>>>>>>> recent enough loader (usb or iso) and then you can use from OK
> > >>>>>>>> prompt:        
> > >>>>>>> 
> > >>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> > >>>>>>> 
> > >>>>>>> OK lsdev
> > >>>>>>> disk devices:
> > >>>>>>> 	disk0:		BIOS DRIVE C ...
> > >>>>>>> 
> > >>>>>>> 		disk0p1:	EFI
> > >>>>>>> 		disk0p2:	FreeBSD BOOT
> > >>>>>>> 		disk0p3:	FreeBSD SWAP
> > >>>>>>> 		disk0p4:	FreeBSD ZFS
> > >>>>>>> zfs devices:
> > >>>>>>> 	zfs:zroot
> > >>>>>>> 
> > >>>>>>> OK chain disk0
> > >>>>>>> open failed     (so for disk0p{1-4}.
> > >>>>>>> 
> > >>>>>>> OK chain zroot
> > >>>>>>> failed to read disk (just for completeness)        
> > >>>>>> 
> > >>>>>> 
> > >>>>>> chain command does use only device name (such as disk0: or
> > >>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
> > >>>>>> ported the code to read the file.      
> > >>>>> 
> > >>>>> ??
> > >>>>>   
> > >>>>>> 
> > >>>>>> the point for chain command test is to see if the normal read and
> > >>>>>> execute would work, so in your case please try:
> > >>>>>> 
> > >>>>>> chain disk0:      
> > >>>>> 
> > >>>>> As stated above, I did so, and the result is also mentioned above, I
> > >>>>> always get "open failed".
> > >>>>> This is the same for 
> > >>>>> 
> > >>>>> chain disk0
> > >>>>> chain disk0p1
> > >>>>> chain disk0p2
> > >>>>> chain disk0p3
> > >>>>> chain disk0p4
> > >>>>> 
> > >>>>> as already said. CSM is enabled in this case.      
> > >>>> 
> > >>>> sigh? chain command does take device as argument, device must always
> > >>>> end with colon?. in this case, the devil is in details:) as I wrote
> > >>>> above, the command should be:
> > >>>> 
> > >>>> chain disk0:
> > >>>> 
> > >>>> The disk0p1: etc will only work when partition boot code was installed
> > >>>> (which you most likely do not have - the only possible candidate could
> > >>>> be FreeBSD ZFS partition).    
> > >>> 
> > >>> The command "chain disk0:" works as expected (CSM enabled, GPT partition
> > >>> scheme, but with PMBR bootblock installed and freebsd-boot partition
> > >>> conatining gptzfsboot installed.
> > >>> 
> > >>>   
> > >>>>   
> > >>>>>   
> > >>>>>> 
> > >>>>>> to read pmbr (512B) and execute it. The expected outcome would be
> > >>>>>> that pmbr boot code would browse the GPT, read stage1 from disk0p2:
> > >>>>>> and execute it; stage1 would detect FreeBSD ZFS from disk0p4: and
> > >>>>>> load and execute /boot/loader. If that will happen, it means the
> > >>>>>> boot code in our stages is just fine, but the bios (CSM) does not
> > >>>>>> load pmbr?.  if thats true, it would mean that you either need to
> > >>>>>> use UEFI boot or need to have some hack to fool the BIOS or just not
> > >>>>>> use GPT on that machine with CSM.      
> > >>>>> 
> > >>>>> To make it clear here: The only way to boot this box is using CSM (as
> > >>>>> it is the same with the ASRock boards mentioned earlier). But my
> > >>>>> intention is to disable CSM and use a GPT/UEFI environment only! And
> > >>>>> GPT/UEFI doesn't work with FreeBSD, neither with 12-CURRENT, nor
> > >>>>> 11.2-RELENG.
> > >>>>> 
> > >>>>> It would be nice if this could be fixed. I'm more interested in the
> > >>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
> > >>>>> if the fix for the Fujitsu Firmware could fix older issues as a
> > >>>>> byproduct, I'd appreciate that.
> > >>>>> 
> > >>>>> Kind regards,
> > >>>>>   
> > >>>> 
> > >>>> ok, somehow I have lost that part of the discussion. Well, you wrote
> > >>>> that the UEFI boot fails when the first partition starts from sector
> > >>>> 40 - does it mean you have boot when the partition will start from
> > >>>> some other sector? I think, there is something else going on.    
> > >>> 
> > >>> Well, I simply try to describe what I "see" to make things
> > >>> disambiguous. I'm not familiar with the deeper insights of disk layouts
> > >>> on a binary level. So, you explained to me the reason, why ESP (EGI
> > >>> partition) starts at block 40. I compared that to the FreeBSD USB flash
> > >>> image FreeBSD provides, but this is another story since the image uses
> > >>> MBR scheme as I figured out.
> > >>> 
> > >>>   
> > >>>> 
> > >>>> What you can do is to see if that firmware will offer you EFI shell
> > >>>> option, from there you can try to start the bootx64.efi manually and
> > >>>> see what error you will get. However, the number 1 cause for failing
> > >>>> to start the bootloader in UEFI is secure boot - we do not support it
> > >>>> and secure boot must be switched off. 
> > >>>> 
> > >>>> However, they seem to claim "The Secure Boot option is available in the
> > >>>> UEFI/BIOS of most if not all ASRock boards. It is disabled by
> > >>>> default.? 
> > >>>> 
> > >>>> Still suggest to double check if thats really the case. Also, if the
> > >>>> bootx64.efi start will fail and no messages are appearing on screen,
> > >>>> then either there is something in firmware logs or you could get them
> > >>>> from trying to start bootx64.efi from UEFI shell.    
> > >>> 
> > >>> Since I'm with this problem since 2014 and try from time to time, be
> > >>> ausred that I tried every possible permutationof all reasonable
> > >>> options, even those nonsense, to get rid of that problem.
> > >>> 
> > >>> I never had any problems with any other UEFI capable server/workstation
> > >>> firmware so far booting FreeBSD off in UEFI-native (GPT partition
> > >>> scheme, CSM disabled) so far - until now, when I ran into this Fujitsu
> > >>> ESPRIMO Q956 with the most recent firmware (as of lat week, week 29 of
> > >>> 2018) having the very same problems. 
> > >>> 
> > >>> 
> > >>> 
> > >>> I figured out something strange on the Fujitsu - and that is the same
> > >>> with the ASRock boards.
> > >>> 
> > >>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> > >>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
> > >>> servers with UEFI-only configurations. I assume at this point that
> > >>> disabling on the most recent Fujitsu firmwares on reasonable "new"
> > >>> hardware (not older than three years) will disable any(!) legacy BIOS
> > >>> capabilities. The same is assumed for the Fujitus ESPRIMO Q956. I can
> > >>> not speak for the ASRock A77 Pro4/m boards mentioned above/earlier,
> > >>> they are from 2012/2013 and "quite old".
> > >>> 
> > >>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> > >>> partition scheme of the flash device is GPT. The layout looks like this:
> > >>> 
> > >>> gpart show -l da4    
> > >>> =>      40  15425456  da4  GPT  (7.4G)    
> > >>>       40      2000    1  efiboot0  (1.0M)
> > >>>     2040   1453584    3  disk1a  (710M)
> > >>>  1455624      4096    5  disk3  (2.0M)
> > >>>  1459720  13965776       - free -  (6.7G)
> > >>> 
> > >>> I created the flash with md, gpart and dd straightforward, efiboot0 is
> > >>> the ESP partition and its format/content is created via dd
> > >>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
> > >>> 
> > >>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
> > >>> boards and the Esprimo Q956!
> > >>> 
> > >>> But any SSD prepared the same way doesn't. Why? 
> > >>> 
> > >>> On the ASRock, I recall having fiddled around with HDD also for a while
> > >>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
> > >>> remember. 
> > >>> 
> > >>> In the lack of proper hardware I'm unable to check whether USB-attached
> > >>> HDD or SSD will boot or HDD will boot (just in case the local SATA has
> > >>> problems booting UEFI and USB not).
> > >>> 
> > >>> Kind regards,
> > >>> 
> > >>> Oliver 
> > >>>   
> > >> 
> > >> Am. well. I think the suggestion to test out FAT32 is still good one to
> > >> test. This is because it is known that some vendors do not support
> > >> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
> > >> specification does not tell which FAT must be supported, and only hint
> > >> about FAT12/FAT16 in context of removable devices).  
> > > 
> > > I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
> > > took me a time to circumvent the installer and I had to install the
> > > system manually. In that strain, I also "tried" to establish the ESP with
> > > FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc help how
> > > to find out the format (FAT12/16/32) of the ESP, so I assume when using
> > > 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and GPT (UEFI)
> > > (only!) the resulting ESP is FAT12 or FAT16 (300mb by default). I also
> > > assume, that when dd'ing the /boo/boot1.efifat image to a partition, the
> > > format is FAT, but not FAT32. Therefore, I refomatted the manually
> > > created ESP (using "gpart add -t efi ...") using "newfs_msdos -F 32 -b
> > > xxx ...". I had to fiddle around a bit with option -b to fit in a proper
> > > format to meet a 512mb ESP - I'm not sure whether this is the proper
> > > option to deal with. When using the default and only -F32, the size of
> > > the partition has to be 4G at least I assume. Having done that, I copied
> > > the the content of boot1.efifat (mdconfig -t vnode ..., I guess we know
> > > the drill ...) to the newly formatted ESP to /boot/efi/ ...
> > > 
> > > Having so far no knowledge of how to asure that the created ESP is FAT32,
> > > I assume it is FAT32.
> > > 
> > > The result is negative on the ESPRIMO Q956. When disabling the CSM, the
> > > box is not willing to boot from SSD with the ESP prepared as decribed.
> > > So, a chance that this might still be due to a misconfiguration lies now
> > > within the -b option of newfs_msdos - if the -b option is assumed the
> > > proper option?
> > > 
> > > At the moment, the ESP of the Esprimo is subject to changes, if you wish,
> > > but not in size, since it is limited to 512mb.
> > > 
> > > Thanks and kind regards,
> > > 
> > > Oliver  
> > 
> > Yea, i was hoping fstyp command would report the FAT type, but it does not
> > (request for feature?:)  
> 
> FYI, the file(1) command is very good at disecting a disk image to tell
> you what the MBR looks like, and at looking at partitions if pointed at
> them with the -s option.  It should be able to detect FAT12/16/32.
> 
> root at x230a:/home/ISO/x # file -s /dev/md2s1
> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ", root
> entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5, sectors/track
> 63, heads 1, serial number 0xbd4111ee, label: "EFISYS     ", FAT (12 bit),
> followed by FAT
> 
> > 
> > However, the more annoying idea would be to install some OS which will boot
> > with UEFI on this machine, then copy boot1.efi from freebsd to it (the
> > default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in case of
> > UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do not support
> > EFI32.
> > 
> > note that boot1.efi alone will not do much but printing on screen how it
> > will search for freebsd, but for the purpose of the test it would suffice -
> > that would give us confirmed working ESP file system (since the other os
> > would be able to boot) and then we can confirm if boot1.efi itself is OK.  
> 

Some new results.
I installed RedHat 7.5 and inestigated the ESP.

- The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
- size is both 200mb if installed automatically. I forgit to investigate the
  FAT format, but this might be unnecessary as shown further in this post.
- RedHat's ESP contains ~ 10 MB of data in two folders, /efi/boot, /efi/redhat.
copying FreeBSD's BOOTX64.efi over RedHat's doesn't change anything, also
renaming /efi/boot/fbx64.efi of RedHat's installation. But renaming /efi/redhat
renders RedHat to fail the boot process on the Fujitsu with the signs of the
built-in testprogram as reported.

I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot only
(CSM in firmware disabled, but there is still a gptzfsboot-prepared partition
for later use, just for the record). Booting UEFI-only fails as reported. On
this installation I copied the RedHat ESP completely into FreeBSD's ESP,
renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh and copied FreeBSD's
BOOTX64.efi to /efi/boot. 
The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
the /efi/redhat folder of the ESP is important, if renamed, the whole process
dies as I reported earlier.

Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB flash
booting with CSM disabled (so asumingly UEFI only then) on both ASRock and
Fujitsu (as described in more detail initially and earlier), while SSDs fail?
Is there a difference? Since FreeBSD boots in UEFI mode from USB flash prepared
as described (straight forward, 800k ESP starting at block 40, the boot1.efifat
image dd'ed onto the partition, UFS partition following, no freebsd-boot
partition or MBR/PMBR bootcode applied ever!), I think BOOTX64.EFI is
technically all right. There must be then an issue with the SATA/SSD/HDD boot
pathway.

Hope I could provide some more details, sorry if it sounds confusing or way too
long, but I try to descibe the situation as thorough as possible.

Kind regards

Oliver

From tsoome at me.com  Thu Jul 26 16:23:57 2018
From: tsoome at me.com (Toomas Soome)
Date: Thu, 26 Jul 2018 19:23:43 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>



> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote:
> 
>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
>>>> 
>>>> On Wed, 25 Jul 2018 11:46:07 +0300
>>>> Toomas Soome <tsoome at me.com> wrote:
>>>> 
>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>> 
>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>> 
>>>>>> 
>>>>>> Hello  Toomas Soome,
>>>>>> 
>>>>>> I CC Allan Jude since I discovered something  weird today regarding the
>>>>>> UEFI boot capabilities of USB flash devices and SSDs. See below.
>>>>>> 
>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>>> 
>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>> 
>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>> wrote:
>>>>>>>>>> 
>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>>>>>>>>> 
>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>>>>>>>>> 
>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>>>>>>>> Hash: SHA512
>>>>>>>>>>>> 
>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:       
>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>>>>> wrote:
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on
>>>>>>>>>>>>>> GPT drives where the first partition begins at block 40 of the
>>>>>>>>>>>>>> hdd/ssd.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> I have two host in private use based on an
>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
>>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013. This
>>>>>>>>>>>>>> is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for the Z77
>>>>>>>>>>>>>> Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
>>>>>>>>>>>>>> for the Spectre/Meltdown mitigation is available, but I didn't
>>>>>>>>>>>>>> test that. But please read.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall
>>>>>>>>>>>>>> the OS using UEFI-only boot method on a GPT partitioned device
>>>>>>>>>>>>>> fails. The ASRock boards jump immediately into the firmware,
>>>>>>>>>>>>>> the Fujitsu offers some kind of CPU/Memory/HDD test facility.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot
>>>>>>>>>>>>>> only is implied, the MBR partitioned FreeBSD installation USB
>>>>>>>>>>>>>> flash device does boot in UEFI! I guess I can assume this when
>>>>>>>>>>>>>> the well known clumsy 80x25 char console suddenly gets bright
>>>>>>>>>>>>>> and shiny with a much higher resoltion as long the GPU supports
>>>>>>>>>>>>>> EFI GOP. Looking with gpart at the USB flash drives reveals
>>>>>>>>>>>>>> that the EFI partition starts at block 1 of the device and the
>>>>>>>>>>>>>> device has a MBR layout. I haven't found a way to force the GPT
>>>>>>>>>>>>>> scheme, when initialised via gpart, to let the partitions start
>>>>>>>>>>>>>> at block 1. This might be a naiv thinking, so please be patient
>>>>>>>>>>>>>> with me.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
>>>>>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI
>>>>>>>>>>>>>> and that worked - FreeBSD not. I gave up on that that time.
>>>>>>>>>>>>>> Now, having the very same issues with a new Fujitsu system,
>>>>>>>>>>>>>> leaves me with the impression that FreeBSD's UEFI
>>>>>>>>>>>>>> implementation might have problems I'm not aware of.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> Can someone shed some light onto this? 
>>>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
>>>>>>>>>>>>> do not support secure boot at all at this time.          
>>>>>>>>>>>> 
>>>>>>>>>>>> Secure boot is in every scenario disabled!
>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> If you have efi or bios version running - you can check from
>>>>>>>>>>>>> either console variable value (it can have efi or vidconsole or
>>>>>>>>>>>>> comconsole) or better yet, see if efi-version is set (show
>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
>>>>>>>>>>>>> paths present, it is uefi:)          
>>>>>>>>>>>> 
>>>>>>>>>>>> What are you talking about?
>>>>>>>>>>>> What is the point of entry - running system, loader?
>>>>>>>>>>>> 
>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
>>>>>>>>>>>> 
>>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS - as
>>>>>>>>>>>> I'm sure since I've checked that many times. UEFI doesn't work on
>>>>>>>>>>>> those systems with FreeBSD. I'm not sure antmore, but I tried
>>>>>>>>>>>> also Windows 7 on those mainboards booting via UEFI - and I might
>>>>>>>>>>>> recall that they failed also. I also recall that there were
>>>>>>>>>>>> issues with earlier UEFI versions regarding booting only Windows
>>>>>>>>>>>> 8/8.1 - and nothing else, but the fact that Linux worked confuses
>>>>>>>>>>>> me a bit.
>>>>>>>>>>>> 
>>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work at
>>>>>>>>>>>> all - who cares, I intend to purchase new server grade hardware.
>>>>>>>>>>>> But the more puzzling issue is with the Fujitsu, which I consider
>>>>>>>>>>>> serious and from the behaviour the Fujitsu failure looks exactly
>>>>>>>>>>>> like the ASRock - Windows 7 works, RedHat 7.5 works (I assume I
>>>>>>>>>>>> can trust the Firmware settings when I disable CSM support, that
>>>>>>>>>>>> the Firmware will only EFI/UEFI capable loader? Or is there a
>>>>>>>>>>>> ghosty override somwhere to be expected?). Also on ASRock
>>>>>>>>>>>> disabling CSM should ensure not booting a dual-bootstrap-capable
>>>>>>>>>>>> system. This said, on the recent Fujitsu, it seems to boil down
>>>>>>>>>>>> to a FreeBSD UEFI-firmware interaction problem, while the ASRock
>>>>>>>>>>>> is still under suspicion to be broken by design.         
>>>>>>>>>>>>> 
>>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this
>>>>>>>>>>>>> is because at sector 0 there is MBR (for compatibility), sector
>>>>>>>>>>>>> 1 is GPT table and then sectors 2-33 have GPT partition table
>>>>>>>>>>>>> entries, so the first possible data sector is 34 (absolute 34).
>>>>>>>>>>>>> Thats assuming 512B sectors. For details see UEFI 2.7 Chapter
>>>>>>>>>>>>> 5.3.1 page 131.          
>>>>>>>>>>>> 
>>>>>>>>>>>> Thanks for the explanation. That implies the installer did right,
>>>>>>>>>>>> gpart did also right and therefore there must be an issue with the
>>>>>>>>>>>> stuff located within the EFI partition?         
>>>>>>>>>>> 
>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
>>>>>>>>>>> actually caring to read the MBR code and start it, since once the
>>>>>>>>>>> MBR code is started, it is all about our code.        
>>>>>>>>>> 
>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or
>>>>>>>>>> do you mean that specific portion of the UEFI firmware, which looks
>>>>>>>>>> for the proper UEFI partition?
>>>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> BIOS as either native or CSM. Note that from boot code point of view
>>>>>>>>> the CSM boot *is* BIOS boot, we have no access to UEFI features.
>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
>>>>>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
>>>>>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched
>>>>>>>>>> off in the firmware. Again: GPT partition scheme.
>>>>>>>>>> 
>>>>>>>>>> The system boots properly if a second partition of type
>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is
>>>>>>>>>> the device).         
>>>>>>>>>>> 
>>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
>>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
>>>>>>>>>>> prompt:        
>>>>>>>>>> 
>>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
>>>>>>>>>> 
>>>>>>>>>> OK lsdev
>>>>>>>>>> disk devices:
>>>>>>>>>> 	disk0:		BIOS DRIVE C ...
>>>>>>>>>> 
>>>>>>>>>> 		disk0p1:	EFI
>>>>>>>>>> 		disk0p2:	FreeBSD BOOT
>>>>>>>>>> 		disk0p3:	FreeBSD SWAP
>>>>>>>>>> 		disk0p4:	FreeBSD ZFS
>>>>>>>>>> zfs devices:
>>>>>>>>>> 	zfs:zroot
>>>>>>>>>> 
>>>>>>>>>> OK chain disk0
>>>>>>>>>> open failed     (so for disk0p{1-4}.
>>>>>>>>>> 
>>>>>>>>>> OK chain zroot
>>>>>>>>>> failed to read disk (just for completeness)        
>>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> chain command does use only device name (such as disk0: or
>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
>>>>>>>>> ported the code to read the file.      
>>>>>>>> 
>>>>>>>> ??
>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> the point for chain command test is to see if the normal read and
>>>>>>>>> execute would work, so in your case please try:
>>>>>>>>> 
>>>>>>>>> chain disk0:      
>>>>>>>> 
>>>>>>>> As stated above, I did so, and the result is also mentioned above, I
>>>>>>>> always get "open failed".
>>>>>>>> This is the same for 
>>>>>>>> 
>>>>>>>> chain disk0
>>>>>>>> chain disk0p1
>>>>>>>> chain disk0p2
>>>>>>>> chain disk0p3
>>>>>>>> chain disk0p4
>>>>>>>> 
>>>>>>>> as already said. CSM is enabled in this case.      
>>>>>>> 
>>>>>>> sigh? chain command does take device as argument, device must always
>>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
>>>>>>> above, the command should be:
>>>>>>> 
>>>>>>> chain disk0:
>>>>>>> 
>>>>>>> The disk0p1: etc will only work when partition boot code was installed
>>>>>>> (which you most likely do not have - the only possible candidate could
>>>>>>> be FreeBSD ZFS partition).    
>>>>>> 
>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT partition
>>>>>> scheme, but with PMBR bootblock installed and freebsd-boot partition
>>>>>> conatining gptzfsboot installed.
>>>>>> 
>>>>>> 
>>>>>>> 
>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from disk0p2:
>>>>>>>>> and execute it; stage1 would detect FreeBSD ZFS from disk0p4: and
>>>>>>>>> load and execute /boot/loader. If that will happen, it means the
>>>>>>>>> boot code in our stages is just fine, but the bios (CSM) does not
>>>>>>>>> load pmbr?.  if thats true, it would mean that you either need to
>>>>>>>>> use UEFI boot or need to have some hack to fool the BIOS or just not
>>>>>>>>> use GPT on that machine with CSM.      
>>>>>>>> 
>>>>>>>> To make it clear here: The only way to boot this box is using CSM (as
>>>>>>>> it is the same with the ASRock boards mentioned earlier). But my
>>>>>>>> intention is to disable CSM and use a GPT/UEFI environment only! And
>>>>>>>> GPT/UEFI doesn't work with FreeBSD, neither with 12-CURRENT, nor
>>>>>>>> 11.2-RELENG.
>>>>>>>> 
>>>>>>>> It would be nice if this could be fixed. I'm more interested in the
>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
>>>>>>>> byproduct, I'd appreciate that.
>>>>>>>> 
>>>>>>>> Kind regards,
>>>>>>>> 
>>>>>>> 
>>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
>>>>>>> that the UEFI boot fails when the first partition starts from sector
>>>>>>> 40 - does it mean you have boot when the partition will start from
>>>>>>> some other sector? I think, there is something else going on.    
>>>>>> 
>>>>>> Well, I simply try to describe what I "see" to make things
>>>>>> disambiguous. I'm not familiar with the deeper insights of disk layouts
>>>>>> on a binary level. So, you explained to me the reason, why ESP (EGI
>>>>>> partition) starts at block 40. I compared that to the FreeBSD USB flash
>>>>>> image FreeBSD provides, but this is another story since the image uses
>>>>>> MBR scheme as I figured out.
>>>>>> 
>>>>>> 
>>>>>>> 
>>>>>>> What you can do is to see if that firmware will offer you EFI shell
>>>>>>> option, from there you can try to start the bootx64.efi manually and
>>>>>>> see what error you will get. However, the number 1 cause for failing
>>>>>>> to start the bootloader in UEFI is secure boot - we do not support it
>>>>>>> and secure boot must be switched off. 
>>>>>>> 
>>>>>>> However, they seem to claim "The Secure Boot option is available in the
>>>>>>> UEFI/BIOS of most if not all ASRock boards. It is disabled by
>>>>>>> default.? 
>>>>>>> 
>>>>>>> Still suggest to double check if thats really the case. Also, if the
>>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
>>>>>>> then either there is something in firmware logs or you could get them
>>>>>>> from trying to start bootx64.efi from UEFI shell.    
>>>>>> 
>>>>>> Since I'm with this problem since 2014 and try from time to time, be
>>>>>> ausred that I tried every possible permutationof all reasonable
>>>>>> options, even those nonsense, to get rid of that problem.
>>>>>> 
>>>>>> I never had any problems with any other UEFI capable server/workstation
>>>>>> firmware so far booting FreeBSD off in UEFI-native (GPT partition
>>>>>> scheme, CSM disabled) so far - until now, when I ran into this Fujitsu
>>>>>> ESPRIMO Q956 with the most recent firmware (as of lat week, week 29 of
>>>>>> 2018) having the very same problems. 
>>>>>> 
>>>>>> 
>>>>>> 
>>>>>> I figured out something strange on the Fujitsu - and that is the same
>>>>>> with the ASRock boards.
>>>>>> 
>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
>>>>>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
>>>>>> servers with UEFI-only configurations. I assume at this point that
>>>>>> disabling on the most recent Fujitsu firmwares on reasonable "new"
>>>>>> hardware (not older than three years) will disable any(!) legacy BIOS
>>>>>> capabilities. The same is assumed for the Fujitus ESPRIMO Q956. I can
>>>>>> not speak for the ASRock A77 Pro4/m boards mentioned above/earlier,
>>>>>> they are from 2012/2013 and "quite old".
>>>>>> 
>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
>>>>>> partition scheme of the flash device is GPT. The layout looks like this:
>>>>>> 
>>>>>> gpart show -l da4    
>>>>>> =>      40  15425456  da4  GPT  (7.4G)    
>>>>>>      40      2000    1  efiboot0  (1.0M)
>>>>>>    2040   1453584    3  disk1a  (710M)
>>>>>> 1455624      4096    5  disk3  (2.0M)
>>>>>> 1459720  13965776       - free -  (6.7G)
>>>>>> 
>>>>>> I created the flash with md, gpart and dd straightforward, efiboot0 is
>>>>>> the ESP partition and its format/content is created via dd
>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
>>>>>> 
>>>>>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
>>>>>> boards and the Esprimo Q956!
>>>>>> 
>>>>>> But any SSD prepared the same way doesn't. Why? 
>>>>>> 
>>>>>> On the ASRock, I recall having fiddled around with HDD also for a while
>>>>>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I can't
>>>>>> remember. 
>>>>>> 
>>>>>> In the lack of proper hardware I'm unable to check whether USB-attached
>>>>>> HDD or SSD will boot or HDD will boot (just in case the local SATA has
>>>>>> problems booting UEFI and USB not).
>>>>>> 
>>>>>> Kind regards,
>>>>>> 
>>>>>> Oliver 
>>>>>> 
>>>>> 
>>>>> Am. well. I think the suggestion to test out FAT32 is still good one to
>>>>> test. This is because it is known that some vendors do not support
>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
>>>>> specification does not tell which FAT must be supported, and only hint
>>>>> about FAT12/FAT16 in context of removable devices).  
>>>> 
>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
>>>> took me a time to circumvent the installer and I had to install the
>>>> system manually. In that strain, I also "tried" to establish the ESP with
>>>> FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc help how
>>>> to find out the format (FAT12/16/32) of the ESP, so I assume when using
>>>> 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and GPT (UEFI)
>>>> (only!) the resulting ESP is FAT12 or FAT16 (300mb by default). I also
>>>> assume, that when dd'ing the /boo/boot1.efifat image to a partition, the
>>>> format is FAT, but not FAT32. Therefore, I refomatted the manually
>>>> created ESP (using "gpart add -t efi ...") using "newfs_msdos -F 32 -b
>>>> xxx ...". I had to fiddle around a bit with option -b to fit in a proper
>>>> format to meet a 512mb ESP - I'm not sure whether this is the proper
>>>> option to deal with. When using the default and only -F32, the size of
>>>> the partition has to be 4G at least I assume. Having done that, I copied
>>>> the the content of boot1.efifat (mdconfig -t vnode ..., I guess we know
>>>> the drill ...) to the newly formatted ESP to /boot/efi/ ...
>>>> 
>>>> Having so far no knowledge of how to asure that the created ESP is FAT32,
>>>> I assume it is FAT32.
>>>> 
>>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
>>>> box is not willing to boot from SSD with the ESP prepared as decribed.
>>>> So, a chance that this might still be due to a misconfiguration lies now
>>>> within the -b option of newfs_msdos - if the -b option is assumed the
>>>> proper option?
>>>> 
>>>> At the moment, the ESP of the Esprimo is subject to changes, if you wish,
>>>> but not in size, since it is limited to 512mb.
>>>> 
>>>> Thanks and kind regards,
>>>> 
>>>> Oliver  
>>> 
>>> Yea, i was hoping fstyp command would report the FAT type, but it does not
>>> (request for feature?:)  
>> 
>> FYI, the file(1) command is very good at disecting a disk image to tell
>> you what the MBR looks like, and at looking at partitions if pointed at
>> them with the -s option.  It should be able to detect FAT12/16/32.
>> 
>> root at x230a:/home/ISO/x # file -s /dev/md2s1
>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ", root
>> entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5, sectors/track
>> 63, heads 1, serial number 0xbd4111ee, label: "EFISYS     ", FAT (12 bit),
>> followed by FAT
>> 
>>> 
>>> However, the more annoying idea would be to install some OS which will boot
>>> with UEFI on this machine, then copy boot1.efi from freebsd to it (the
>>> default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in case of
>>> UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do not support
>>> EFI32.
>>> 
>>> note that boot1.efi alone will not do much but printing on screen how it
>>> will search for freebsd, but for the purpose of the test it would suffice -
>>> that would give us confirmed working ESP file system (since the other os
>>> would be able to boot) and then we can confirm if boot1.efi itself is OK.  
>> 
> 
> Some new results.
> I installed RedHat 7.5 and inestigated the ESP.
> 
> - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
> - size is both 200mb if installed automatically. I forgit to investigate the
>  FAT format, but this might be unnecessary as shown further in this post.
> - RedHat's ESP contains ~ 10 MB of data in two folders, /efi/boot, /efi/redhat.
> copying FreeBSD's BOOTX64.efi over RedHat's doesn't change anything, also
> renaming /efi/boot/fbx64.efi of RedHat's installation. But renaming /efi/redhat
> renders RedHat to fail the boot process on the Fujitsu with the signs of the
> built-in testprogram as reported.
> 
> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot only
> (CSM in firmware disabled, but there is still a gptzfsboot-prepared partition
> for later use, just for the record). Booting UEFI-only fails as reported. On
> this installation I copied the RedHat ESP completely into FreeBSD's ESP,
> renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh and copied FreeBSD's
> BOOTX64.efi to /efi/boot. 
> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
> the /efi/redhat folder of the ESP is important, if renamed, the whole process
> dies as I reported earlier.
> 
> Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB flash
> booting with CSM disabled (so asumingly UEFI only then) on both ASRock and
> Fujitsu (as described in more detail initially and earlier), while SSDs fail?
> Is there a difference? Since FreeBSD boots in UEFI mode from USB flash prepared
> as described (straight forward, 800k ESP starting at block 40, the boot1.efifat
> image dd'ed onto the partition, UFS partition following, no freebsd-boot
> partition or MBR/PMBR bootcode applied ever!), I think BOOTX64.EFI is
> technically all right. There must be then an issue with the SATA/SSD/HDD boot
> pathway.
> 
> Hope I could provide some more details, sorry if it sounds confusing or way too
> long, but I try to descibe the situation as thorough as possible.
> 

OK, this is already good hint. The thing with ESP is that there is ?default? file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as default for *removable* media, fortunately it is usable for hard disks as well, or at least in most cases.

Now, for non-removable media, the UEFI does provide boot manager interface to define boot entries, and the fact that renaming efi/redhad directory did break the redhat boot, is very loud hint. And this means, this system is probably ignoring efi/boot tree on non-removable media and is expecting the boot manager entry to be created instead.

UEFI boot manager can be configured /usually/ manually via firmware menu, or by application, such as efibootmgr. The normal approach is to create efi/<vendorname> directory and to copy the application there, then create the boot manager configuration.

See UEFI specification v2.7, chapter 3 Boot Manager, page 79.

What is different in FreeBSD case is that the whole interface to program the UEFI Boot Manager is currently being developed, so either it has to be done manually or from some other OS (see https://wiki.gentoo.org/wiki/Efibootmgr <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from google:D).

rgds,
toomas


From jhb at FreeBSD.org  Thu Jul 26 17:21:11 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Thu, 26 Jul 2018 10:21:07 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
Message-ID: <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>

On 7/25/18 6:52 PM, Mark Millard wrote:
> 
> 
> On 2018-Jul-25, at 2:10 PM, Mark Millard <marklmi at yahoo.com> wrote:
> 
> 
> 
>> On 2018-Jul-25, at 10:09 AM, Mark Millard <marklmi at yahoo.com> wrote:
>>
>>> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
>>>
>>>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>>>
>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>>>>
>>>>>> --- all_subdir_lib/ofed ---
>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>>>              from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>>>> atomic_store(&lock->cnt, 0);
>>>>>> ^
>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>> ^~
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>>>> ^~
>>>>>> . . .
>>>>>> --- all_subdir_lib/ofed ---
>>>>>> *** [acm.o] Error code 1
>>>>>>
>>>>>>
>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>>>> -r336700 ) still shows this type of error.
>>>>>
>>>>>
>>>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>>>>
>>>>> From what I can tell looking around having something like:
>>>>>
>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>
>>>>> involve a __atomic_fetch_add indicates that:
>>>>>
>>>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>>>>
>>>>> was in use instead of FreeBSD's stdatomic.h file.
>>>>>
>>>>> If this is right, then the issue may be tied to head -r335782
>>>>> implicitly changing the order of the include file directory
>>>>> searching for builds via the devel/*-gcc .
>>>>>
>>>>> (I reverted -r335782 in my environment some time ago and have
>>>>> not run into this problem in my context so far.)
>>>>
>>>> C11 atomics should work fine with compiler-provided headers since they
>>>> are a part of the language (and the system stdatomic.h simply attempts
>>>> to mimic the compiler-provided header in case it is missing).
>>>>
>>>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>>>> failures when using its stdatomic.h, so there is probably something else
>>>> going on with kernel includes being used while building the library,
>>>> etc.  The last time we had this issue with stdarg.h it was because a
>>>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>>>> which is correct for the kernel but not for userland.
>>>
>>> I did misread the headers. FreeBSD has the likes of:
>>>
>>> #if defined(__CLANG_ATOMICS)
>>> . . .
>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>> 	__c11_atomic_fetch_add(object, operand, order)
>>> . . .
>>> #elif defined(__GNUC_ATOMICS)
>>> . . .
>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>> 	__atomic_fetch_add(&(object)->__val, operand, order)
>>> . . .
>>> #endif
>>> . . .
>>> #define	atomic_fetch_add(object, operand)				\
>>> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
>>>
>>> so __atomic_fetch_add would occur.
>>>
>>> But so far I do not see the problem with -r335782 reverted. I last built
>>> -r336693 last night via devel/amd64-gcc (via xtoolchain).
>>>
>>> From what I can tell FreeBSD defines:
>>>
>>> #if !defined(__CLANG_ATOMICS)
>>> #define	_Atomic(T)			struct { volatile T __val; }
>>> #endif
>>>
>>> and that struct is being used in &(object)->__val is what the
>>> error reports are about. So that would be, for example,
>>>
>>> &(&lock->cnt)->__val
>>>
>>> This would appear to suggest that __val itself had a type meeting:
>>>
>>> operand type struct <anonymous>
>>>
>>> for T in _Atomic(T) .
>>>
>>> (This is independent of just what the issue traces back to: just
>>> the net result on ci.freebsd.org . No claim that you are right
>>> or wrong here. I'll not be looking any more until this afternoon
>>> or night.)
>>
>> Going in a somewhat different direction . . .
>>
>> Looking around I found https://bugs.llvm.org/show_bug.cgi?id=26462
>> which is titled:
>>
>> 26462 ? GCC/clang C11 _Atomic incompatibility
>>
>> It appears that the normal source of platform ABI definitions are
>> not explicit/detailed in the area and allow for incompatibilities
>> in this area. clang and gcc made differing choices absent being
>> constrained to match.
>>
>> An example (a powerpc64 context was indicated):
>>
>> struct A16 { char val[16]; }; 
>> _Atomic struct A16 a16; 
>> // GCC:
>> _Static_assert(_Alignof(a16) == 16, ""); 
>> // Clang:
>> _Static_assert(_Alignof(a16) == 1, ""); 
>>
>>
>> Non-power-of-2 is a general problem
>> (not a powerpc64 context from what I can
>> tell):
>>
>> struct A3 { char val[3]; };
>> _Atomic struct A3 a3;
>> // GCC:
>> _Static_assert(sizeof(a3) == 3, "");
>> _Static_assert(_Alignof(a3) == 1, "");
>> // Clang:
>> _Static_assert(sizeof(a3) == 4, "");
>> _Static_assert(_Alignof(a3) == 4, "");
>>
>>
>>
>> Comment 6 (by John McCall) is relevant:
>>
>> QUOTE
>> Anyway, while I prefer the Clang rule, the GCC rule is defensible, as are any number of other rules.  The important point, however, is that having this discussion is not the right approach to solving this problem.  The layout of _Atomic(T) is ABI.  ABI rules are not generally determined by compiler implementors making things up as they go along, or at least they shouldn't be.  The Darwin ABI for _Atomic is the rule implemented in Clang, which we actually did think about carefully when we adopted it.  Other platforms need to make their own call, and it probably shouldn't just be "whatever's implemented in GCC", especially on other platforms where GCC is not the system compiler.
>> END QUOTE
>>
>>
>> (I do nto claim to have proivided all the material that should
>> be read in https://bugs.llvm.org/show_bug.cgi?id=26462 .)
>>
>> It may be that FreeBSD needs to be the source of the ABI definitions
>> involved if clang and gcc freeBSD builds are to be interoperable in
>> this area. But this could mean avoiding builtins?
>>
>> If any of this is inlined and so not behind a more stable interface,
>> it looks like clang and gcc can not be mixed for the same instances
>> of various _Atomic possibilities.
>>
>>
> 
> 
> Going back to the code being compiled and 
> confirming your note:
> ( /usr/src/contrib/ofed/librdmacm/cma.h )
> 
> typedef struct {
>         sem_t sem;
>         _Atomic(int) cnt;
> } fastlock_t;
> . . .
> static inline void fastlock_acquire(fastlock_t *lock)
> {
>         if (atomic_fetch_add(&lock->cnt, 1) > 0)
>                 sem_wait(&lock->sem);
> }
> 
> So lock->cnt is an _Atomic(int) , i.e.,
> 
> struct { volatile int __val; }
> 
> so overall:
> 
> typedef struct {
>         sem_t sem;
>         struct { volatile int __val; } cnt;
> } fastlock_t;
> 
> 
> for which: atomic_fetch_add(&lock->cnt, 1) has
> for A filled-in in the C11 language official:
> 
> atomic_fetch_add (volatile A* obj, M arg)
> 
> (generic function) being:
> 
> atomic_fetch_add (volatile struct { volatile int __val; }* obj, M arg)
> 
> and a direct type-check of that notation for obj would find:
> 
> operand type 'struct <anonymous> *'
> 
> and that would propagate to GCC's translation to __atomic_fetch_add
> via gcc's stdatomic.h :
> 
> #define atomic_fetch_add(PTR, VAL) __atomic_fetch_add ((PTR), (VAL), 	\
> 						       __ATOMIC_SEQ_CST)
> 
> So, yes, it looks like the:
> 
> #if !defined(__CLANG_ATOMICS)
> #define	_Atomic(T)			struct { volatile T __val; }
> #endif

So where are you seeing this btw?  In head the conditional is different:

#if !defined(__cplusplus) && !__has_extension(c_atomic) && \
    !__has_extension(cxx_atomic)
/*
 * No native support for _Atomic(). Place object in structure to prevent
 * most forms of direct non-atomic access.
 */
#define _Atomic(T)              struct { T volatile __val; }
#endif

And external GCC does support those extensions so should end up not defining
an _Atomic macro, and in fact when I use -E with external GCC it leaves
_Atomic(int) alone:

% x86_64-unknown-freebsd11.2-gcc -E bar.c
...
# 1 "bar.c"
# 1 "/usr/include/sys/cdefs.h" 1 3 4
# 2 "bar.c" 2
# 1 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 1 3 4
# 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4

# 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4
typedef enum
  {
    memory_order_relaxed = 0,
    memory_order_consume = 1,
    memory_order_acquire = 2,
    memory_order_release = 3,
    memory_order_acq_rel = 4,
    memory_order_seq_cst = 5
  } memory_order;


typedef _Atomic _Bool atomic_bool;
typedef _Atomic char atomic_char;
...

So cdefs.h isn't overriding _Atomic and should be using the CLANG_ATOMICS case
for external GCC.

-- 
John Baldwin

From marklmi at yahoo.com  Thu Jul 26 17:56:06 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 26 Jul 2018 10:55:58 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
Message-ID: <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>



On 2018-Jul-26, at 10:21 AM, John Baldwin <jhb at FreeBSD.org> wrote:

> On 7/25/18 6:52 PM, Mark Millard wrote:
>> 
>> 
>> On 2018-Jul-25, at 2:10 PM, Mark Millard <marklmi at yahoo.com> wrote:
>> 
>> 
>> 
>>> On 2018-Jul-25, at 10:09 AM, Mark Millard <marklmi at yahoo.com> wrote:
>>> 
>>>> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
>>>> 
>>>>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>>>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>>>> 
>>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>>>>> 
>>>>>>> --- all_subdir_lib/ofed ---
>>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>>>>             from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>>>>> atomic_store(&lock->cnt, 0);
>>>>>>> ^
>>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>>> ^~
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>>>>> ^~
>>>>>>> . . .
>>>>>>> --- all_subdir_lib/ofed ---
>>>>>>> *** [acm.o] Error code 1
>>>>>>> 
>>>>>>> 
>>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>>>>> -r336700 ) still shows this type of error.
>>>>>> 
>>>>>> 
>>>>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>>>>> 
>>>>>> From what I can tell looking around having something like:
>>>>>> 
>>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>> 
>>>>>> involve a __atomic_fetch_add indicates that:
>>>>>> 
>>>>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>>>>> 
>>>>>> was in use instead of FreeBSD's stdatomic.h file.
>>>>>> 
>>>>>> If this is right, then the issue may be tied to head -r335782
>>>>>> implicitly changing the order of the include file directory
>>>>>> searching for builds via the devel/*-gcc .
>>>>>> 
>>>>>> (I reverted -r335782 in my environment some time ago and have
>>>>>> not run into this problem in my context so far.)
>>>>> 
>>>>> C11 atomics should work fine with compiler-provided headers since they
>>>>> are a part of the language (and the system stdatomic.h simply attempts
>>>>> to mimic the compiler-provided header in case it is missing).
>>>>> 
>>>>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>>>>> failures when using its stdatomic.h, so there is probably something else
>>>>> going on with kernel includes being used while building the library,
>>>>> etc.  The last time we had this issue with stdarg.h it was because a
>>>>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>>>>> which is correct for the kernel but not for userland.
>>>> 
>>>> I did misread the headers. FreeBSD has the likes of:
>>>> 
>>>> #if defined(__CLANG_ATOMICS)
>>>> . . .
>>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>>> 	__c11_atomic_fetch_add(object, operand, order)
>>>> . . .
>>>> #elif defined(__GNUC_ATOMICS)
>>>> . . .
>>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>>> 	__atomic_fetch_add(&(object)->__val, operand, order)
>>>> . . .
>>>> #endif
>>>> . . .
>>>> #define	atomic_fetch_add(object, operand)				\
>>>> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
>>>> 
>>>> so __atomic_fetch_add would occur.
>>>> 
>>>> But so far I do not see the problem with -r335782 reverted. I last built
>>>> -r336693 last night via devel/amd64-gcc (via xtoolchain).
>>>> 
>>>> From what I can tell FreeBSD defines:
>>>> 
>>>> #if !defined(__CLANG_ATOMICS)
>>>> #define	_Atomic(T)			struct { volatile T __val; }
>>>> #endif
>>>> 
>>>> and that struct is being used in &(object)->__val is what the
>>>> error reports are about. So that would be, for example,
>>>> 
>>>> &(&lock->cnt)->__val
>>>> 
>>>> This would appear to suggest that __val itself had a type meeting:
>>>> 
>>>> operand type struct <anonymous>
>>>> 
>>>> for T in _Atomic(T) .
>>>> 
>>>> (This is independent of just what the issue traces back to: just
>>>> the net result on ci.freebsd.org . No claim that you are right
>>>> or wrong here. I'll not be looking any more until this afternoon
>>>> or night.)
>>> 
>>> Going in a somewhat different direction . . .
>>> 
>>> Looking around I found https://bugs.llvm.org/show_bug.cgi?id=26462
>>> which is titled:
>>> 
>>> 26462 ? GCC/clang C11 _Atomic incompatibility
>>> 
>>> It appears that the normal source of platform ABI definitions are
>>> not explicit/detailed in the area and allow for incompatibilities
>>> in this area. clang and gcc made differing choices absent being
>>> constrained to match.
>>> 
>>> An example (a powerpc64 context was indicated):
>>> 
>>> struct A16 { char val[16]; }; 
>>> _Atomic struct A16 a16; 
>>> // GCC:
>>> _Static_assert(_Alignof(a16) == 16, ""); 
>>> // Clang:
>>> _Static_assert(_Alignof(a16) == 1, ""); 
>>> 
>>> 
>>> Non-power-of-2 is a general problem
>>> (not a powerpc64 context from what I can
>>> tell):
>>> 
>>> struct A3 { char val[3]; };
>>> _Atomic struct A3 a3;
>>> // GCC:
>>> _Static_assert(sizeof(a3) == 3, "");
>>> _Static_assert(_Alignof(a3) == 1, "");
>>> // Clang:
>>> _Static_assert(sizeof(a3) == 4, "");
>>> _Static_assert(_Alignof(a3) == 4, "");
>>> 
>>> 
>>> 
>>> Comment 6 (by John McCall) is relevant:
>>> 
>>> QUOTE
>>> Anyway, while I prefer the Clang rule, the GCC rule is defensible, as are any number of other rules.  The important point, however, is that having this discussion is not the right approach to solving this problem.  The layout of _Atomic(T) is ABI.  ABI rules are not generally determined by compiler implementors making things up as they go along, or at least they shouldn't be.  The Darwin ABI for _Atomic is the rule implemented in Clang, which we actually did think about carefully when we adopted it.  Other platforms need to make their own call, and it probably shouldn't just be "whatever's implemented in GCC", especially on other platforms where GCC is not the system compiler.
>>> END QUOTE
>>> 
>>> 
>>> (I do nto claim to have proivided all the material that should
>>> be read in https://bugs.llvm.org/show_bug.cgi?id=26462 .)
>>> 
>>> It may be that FreeBSD needs to be the source of the ABI definitions
>>> involved if clang and gcc freeBSD builds are to be interoperable in
>>> this area. But this could mean avoiding builtins?
>>> 
>>> If any of this is inlined and so not behind a more stable interface,
>>> it looks like clang and gcc can not be mixed for the same instances
>>> of various _Atomic possibilities.
>>> 
>>> 
>> 
>> 
>> Going back to the code being compiled and 
>> confirming your note:
>> ( /usr/src/contrib/ofed/librdmacm/cma.h )
>> 
>> typedef struct {
>>        sem_t sem;
>>        _Atomic(int) cnt;
>> } fastlock_t;
>> . . .
>> static inline void fastlock_acquire(fastlock_t *lock)
>> {
>>        if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>                sem_wait(&lock->sem);
>> }
>> 
>> So lock->cnt is an _Atomic(int) , i.e.,
>> 
>> struct { volatile int __val; }
>> 
>> so overall:
>> 
>> typedef struct {
>>        sem_t sem;
>>        struct { volatile int __val; } cnt;
>> } fastlock_t;
>> 
>> 
>> for which: atomic_fetch_add(&lock->cnt, 1) has
>> for A filled-in in the C11 language official:
>> 
>> atomic_fetch_add (volatile A* obj, M arg)
>> 
>> (generic function) being:
>> 
>> atomic_fetch_add (volatile struct { volatile int __val; }* obj, M arg)
>> 
>> and a direct type-check of that notation for obj would find:
>> 
>> operand type 'struct <anonymous> *'
>> 
>> and that would propagate to GCC's translation to __atomic_fetch_add
>> via gcc's stdatomic.h :
>> 
>> #define atomic_fetch_add(PTR, VAL) __atomic_fetch_add ((PTR), (VAL), 	\
>> 						       __ATOMIC_SEQ_CST)
>> 
>> So, yes, it looks like the:
>> 
>> #if !defined(__CLANG_ATOMICS)
>> #define	_Atomic(T)			struct { volatile T __val; }
>> #endif
> 
> So where are you seeing this btw?  In head the conditional is different:
> 
> #if !defined(__cplusplus) && !__has_extension(c_atomic) && \
>    !__has_extension(cxx_atomic)
> /*
> * No native support for _Atomic(). Place object in structure to prevent
> * most forms of direct non-atomic access.
> */
> #define _Atomic(T)              struct { T volatile __val; }
> #endif
> 
> And external GCC does support those extensions so should end up not defining
> an _Atomic macro, and in fact when I use -E with external GCC it leaves
> _Atomic(int) alone:
> 
> % x86_64-unknown-freebsd11.2-gcc -E bar.c
> ...
> # 1 "bar.c"
> # 1 "/usr/include/sys/cdefs.h" 1 3 4
> # 2 "bar.c" 2
> # 1 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 1 3 4
> # 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4
> 
> # 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4
> typedef enum
>  {
>    memory_order_relaxed = 0,
>    memory_order_consume = 1,
>    memory_order_acquire = 2,
>    memory_order_release = 3,
>    memory_order_acq_rel = 4,
>    memory_order_seq_cst = 5
>  } memory_order;
> 
> 
> typedef _Atomic _Bool atomic_bool;
> typedef _Atomic char atomic_char;
> ...
> 
> So cdefs.h isn't overriding _Atomic and should be using the CLANG_ATOMICS case
> for external GCC.

Some of my research was when I did not have FreeBSD available and was over
the web and I did not cross check all of it later. I apparently looked
at some older source at some point. I now see what you report for the
#if test.

Sorry for the confusion.

However, there is in /usr/src/sys/sys/cdefs.h :

/*
 * Testing against Clang-specific extensions.
 */
#ifndef __has_attribute
#define __has_attribute(x)      0
#endif
#ifndef __has_extension
#define __has_extension         __has_feature
#endif
#ifndef __has_feature
#define __has_feature(x)        0
#endif

so if those are clang specific then:

#if !defined(__cplusplus) && !__has_extension(c_atomic) && \
    !__has_extension(cxx_atomic)

will test for C code: !0 && !0 && !0 and then the code
will select to:

#define _Atomic(T)              struct { T volatile __val; }


https://clang.llvm.org/docs/LanguageExtensions.html (for clang 7)
lists:

QUOTE

__has_feature and __has_extension

These function-like macros take a single identifier argument that is the name of a feature.  __has_feature evaluates to 1 if the feature is both supported by Clang and standardized in the current language standard or 0 if not (but see below), while __has_extension evaluates to 1 if the feature is supported by Clang in the current language (either as a language extension or a standard language feature) or 0 if not. They can be used like this:

#ifndef __has_feature         // Optional of course.

  
#define __has_feature(x) 0  // Compatibility with non-clang compilers.
#endif
#ifndef __has_extension

  
#define __has_extension __has_feature // Compatibility with pre-3.0 compilers.
#endif

END QUOTE

so I think that:

#define _Atomic(T)              struct { T volatile __val; }

is being done.




===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From jhb at FreeBSD.org  Thu Jul 26 18:21:59 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Thu, 26 Jul 2018 11:21:54 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
Message-ID: <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>

On 7/26/18 10:55 AM, Mark Millard wrote:
> 
> 
> On 2018-Jul-26, at 10:21 AM, John Baldwin <jhb at FreeBSD.org> wrote:
> 
>> On 7/25/18 6:52 PM, Mark Millard wrote:
>>>
>>>
>>> On 2018-Jul-25, at 2:10 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>
>>>
>>>
>>>> On 2018-Jul-25, at 10:09 AM, Mark Millard <marklmi at yahoo.com> wrote:
>>>>
>>>>> On 2018-Jul-25, at 8:39 AM, John Baldwin <jhb at freebsd.org> wrote:
>>>>>
>>>>>> On 7/24/18 11:39 PM, Mark Millard wrote:
>>>>>>> On 2018-Jul-24, at 10:32 PM, Mark Millard <marklmi at yahoo.com> wrote:
>>>>>>>
>>>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6597/consoleText
>>>>>>>> (head -r336573 after the prior 6596's -r336565 ):
>>>>>>>>
>>>>>>>> --- all_subdir_lib/ofed ---
>>>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>>>>>>             from /workspace/src/contrib/ofed/librdmacm/acm.c:42:
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>>>>>>> atomic_store(&lock->cnt, 0);
>>>>>>>> ^
>>>>>>>> In file included from /workspace/src/contrib/ofed/librdmacm/acm.c:42:0:
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>>>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>>>> ^~
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>>>>>>> /workspace/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>>>>>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>>>>>>> ^~
>>>>>>>> . . .
>>>>>>>> --- all_subdir_lib/ofed ---
>>>>>>>> *** [acm.o] Error code 1
>>>>>>>>
>>>>>>>>
>>>>>>>> https://ci.freebsd.org/job/FreeBSD-head-amd64-gcc/6621/consoleText ( for
>>>>>>>> -r336700 ) still shows this type of error.
>>>>>>>
>>>>>>>
>>>>>>> [I should have a subject with "head -r336568 through -r336570 . . .".]
>>>>>>>
>>>>>>> From what I can tell looking around having something like:
>>>>>>>
>>>>>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>>>>>
>>>>>>> involve a __atomic_fetch_add indicates that:
>>>>>>>
>>>>>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>>>>>>
>>>>>>> was in use instead of FreeBSD's stdatomic.h file.
>>>>>>>
>>>>>>> If this is right, then the issue may be tied to head -r335782
>>>>>>> implicitly changing the order of the include file directory
>>>>>>> searching for builds via the devel/*-gcc .
>>>>>>>
>>>>>>> (I reverted -r335782 in my environment some time ago and have
>>>>>>> not run into this problem in my context so far.)
>>>>>>
>>>>>> C11 atomics should work fine with compiler-provided headers since they
>>>>>> are a part of the language (and the system stdatomic.h simply attempts
>>>>>> to mimic the compiler-provided header in case it is missing).
>>>>>>
>>>>>> Simple standalone tests of _Atomic(int) with GCC don't trigger those
>>>>>> failures when using its stdatomic.h, so there is probably something else
>>>>>> going on with kernel includes being used while building the library,
>>>>>> etc.  The last time we had this issue with stdarg.h it was because a
>>>>>> header shared between the kernel and userland always used '<machine/stdarg.h>'
>>>>>> which is correct for the kernel but not for userland.
>>>>>
>>>>> I did misread the headers. FreeBSD has the likes of:
>>>>>
>>>>> #if defined(__CLANG_ATOMICS)
>>>>> . . .
>>>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>>>> 	__c11_atomic_fetch_add(object, operand, order)
>>>>> . . .
>>>>> #elif defined(__GNUC_ATOMICS)
>>>>> . . .
>>>>> #define	atomic_fetch_add_explicit(object, operand, order)		\
>>>>> 	__atomic_fetch_add(&(object)->__val, operand, order)
>>>>> . . .
>>>>> #endif
>>>>> . . .
>>>>> #define	atomic_fetch_add(object, operand)				\
>>>>> 	atomic_fetch_add_explicit(object, operand, memory_order_seq_cst)
>>>>>
>>>>> so __atomic_fetch_add would occur.
>>>>>
>>>>> But so far I do not see the problem with -r335782 reverted. I last built
>>>>> -r336693 last night via devel/amd64-gcc (via xtoolchain).
>>>>>
>>>>> From what I can tell FreeBSD defines:
>>>>>
>>>>> #if !defined(__CLANG_ATOMICS)
>>>>> #define	_Atomic(T)			struct { volatile T __val; }
>>>>> #endif
>>>>>
>>>>> and that struct is being used in &(object)->__val is what the
>>>>> error reports are about. So that would be, for example,
>>>>>
>>>>> &(&lock->cnt)->__val
>>>>>
>>>>> This would appear to suggest that __val itself had a type meeting:
>>>>>
>>>>> operand type struct <anonymous>
>>>>>
>>>>> for T in _Atomic(T) .
>>>>>
>>>>> (This is independent of just what the issue traces back to: just
>>>>> the net result on ci.freebsd.org . No claim that you are right
>>>>> or wrong here. I'll not be looking any more until this afternoon
>>>>> or night.)
>>>>
>>>> Going in a somewhat different direction . . .
>>>>
>>>> Looking around I found https://bugs.llvm.org/show_bug.cgi?id=26462
>>>> which is titled:
>>>>
>>>> 26462 ? GCC/clang C11 _Atomic incompatibility
>>>>
>>>> It appears that the normal source of platform ABI definitions are
>>>> not explicit/detailed in the area and allow for incompatibilities
>>>> in this area. clang and gcc made differing choices absent being
>>>> constrained to match.
>>>>
>>>> An example (a powerpc64 context was indicated):
>>>>
>>>> struct A16 { char val[16]; }; 
>>>> _Atomic struct A16 a16; 
>>>> // GCC:
>>>> _Static_assert(_Alignof(a16) == 16, ""); 
>>>> // Clang:
>>>> _Static_assert(_Alignof(a16) == 1, ""); 
>>>>
>>>>
>>>> Non-power-of-2 is a general problem
>>>> (not a powerpc64 context from what I can
>>>> tell):
>>>>
>>>> struct A3 { char val[3]; };
>>>> _Atomic struct A3 a3;
>>>> // GCC:
>>>> _Static_assert(sizeof(a3) == 3, "");
>>>> _Static_assert(_Alignof(a3) == 1, "");
>>>> // Clang:
>>>> _Static_assert(sizeof(a3) == 4, "");
>>>> _Static_assert(_Alignof(a3) == 4, "");
>>>>
>>>>
>>>>
>>>> Comment 6 (by John McCall) is relevant:
>>>>
>>>> QUOTE
>>>> Anyway, while I prefer the Clang rule, the GCC rule is defensible, as are any number of other rules.  The important point, however, is that having this discussion is not the right approach to solving this problem.  The layout of _Atomic(T) is ABI.  ABI rules are not generally determined by compiler implementors making things up as they go along, or at least they shouldn't be.  The Darwin ABI for _Atomic is the rule implemented in Clang, which we actually did think about carefully when we adopted it.  Other platforms need to make their own call, and it probably shouldn't just be "whatever's implemented in GCC", especially on other platforms where GCC is not the system compiler.
>>>> END QUOTE
>>>>
>>>>
>>>> (I do nto claim to have proivided all the material that should
>>>> be read in https://bugs.llvm.org/show_bug.cgi?id=26462 .)
>>>>
>>>> It may be that FreeBSD needs to be the source of the ABI definitions
>>>> involved if clang and gcc freeBSD builds are to be interoperable in
>>>> this area. But this could mean avoiding builtins?
>>>>
>>>> If any of this is inlined and so not behind a more stable interface,
>>>> it looks like clang and gcc can not be mixed for the same instances
>>>> of various _Atomic possibilities.
>>>>
>>>>
>>>
>>>
>>> Going back to the code being compiled and 
>>> confirming your note:
>>> ( /usr/src/contrib/ofed/librdmacm/cma.h )
>>>
>>> typedef struct {
>>>        sem_t sem;
>>>        _Atomic(int) cnt;
>>> } fastlock_t;
>>> . . .
>>> static inline void fastlock_acquire(fastlock_t *lock)
>>> {
>>>        if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>>                sem_wait(&lock->sem);
>>> }
>>>
>>> So lock->cnt is an _Atomic(int) , i.e.,
>>>
>>> struct { volatile int __val; }
>>>
>>> so overall:
>>>
>>> typedef struct {
>>>        sem_t sem;
>>>        struct { volatile int __val; } cnt;
>>> } fastlock_t;
>>>
>>>
>>> for which: atomic_fetch_add(&lock->cnt, 1) has
>>> for A filled-in in the C11 language official:
>>>
>>> atomic_fetch_add (volatile A* obj, M arg)
>>>
>>> (generic function) being:
>>>
>>> atomic_fetch_add (volatile struct { volatile int __val; }* obj, M arg)
>>>
>>> and a direct type-check of that notation for obj would find:
>>>
>>> operand type 'struct <anonymous> *'
>>>
>>> and that would propagate to GCC's translation to __atomic_fetch_add
>>> via gcc's stdatomic.h :
>>>
>>> #define atomic_fetch_add(PTR, VAL) __atomic_fetch_add ((PTR), (VAL), 	\
>>> 						       __ATOMIC_SEQ_CST)
>>>
>>> So, yes, it looks like the:
>>>
>>> #if !defined(__CLANG_ATOMICS)
>>> #define	_Atomic(T)			struct { volatile T __val; }
>>> #endif
>>
>> So where are you seeing this btw?  In head the conditional is different:
>>
>> #if !defined(__cplusplus) && !__has_extension(c_atomic) && \
>>    !__has_extension(cxx_atomic)
>> /*
>> * No native support for _Atomic(). Place object in structure to prevent
>> * most forms of direct non-atomic access.
>> */
>> #define _Atomic(T)              struct { T volatile __val; }
>> #endif
>>
>> And external GCC does support those extensions so should end up not defining
>> an _Atomic macro, and in fact when I use -E with external GCC it leaves
>> _Atomic(int) alone:
>>
>> % x86_64-unknown-freebsd11.2-gcc -E bar.c
>> ...
>> # 1 "bar.c"
>> # 1 "/usr/include/sys/cdefs.h" 1 3 4
>> # 2 "bar.c" 2
>> # 1 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 1 3 4
>> # 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4
>>
>> # 29 "/usr/local/lib/gcc/x86_64-unknown-freebsd11.2/6.4.0/include/stdatomic.h" 3 4
>> typedef enum
>>  {
>>    memory_order_relaxed = 0,
>>    memory_order_consume = 1,
>>    memory_order_acquire = 2,
>>    memory_order_release = 3,
>>    memory_order_acq_rel = 4,
>>    memory_order_seq_cst = 5
>>  } memory_order;
>>
>>
>> typedef _Atomic _Bool atomic_bool;
>> typedef _Atomic char atomic_char;
>> ...
>>
>> So cdefs.h isn't overriding _Atomic and should be using the CLANG_ATOMICS case
>> for external GCC.
> 
> Some of my research was when I did not have FreeBSD available and was over
> the web and I did not cross check all of it later. I apparently looked
> at some older source at some point. I now see what you report for the
> #if test.

Yes, but the -E from above was when compiled with external GCC and it didn't change
_Atomic(int).  Here's part of the source of bar.c:

#include <sys/cdefs.h>
#include <stdatomic.h>

struct foo {
        _Atomic(int) one;
        _Atomic int two;
        atomic_int three;
};

And here is what that became after -E:

# 4 "bar.c"
struct foo {
 _Atomic(int) one;
 _Atomic int two;
 atomic_int three;
};

So cdefs.h did not define _Atomic.

Ah, if I add '-std=c99' then it does break.  Code that wants to use
C11 atomics via <stdatomic.h> should not be using -std=c99.  Try this:

Index: lib/ofed/librdmacm/Makefile
===================================================================
--- lib/ofed/librdmacm/Makefile (revision 335896)
+++ lib/ofed/librdmacm/Makefile (working copy)
@@ -8,6 +8,7 @@
 SHLIB_MAJOR=   1
 MK_PROFILE=    no
 CFLAGS+=       -I${_spath}
+CSTD=          gnu11
 
 SRCS= \
 acm.c \

If this works then we should probably mark OFED as a BROKEN_OPTION when
building with ancient GCC for now as well.

-- 
John Baldwin

From jhb at FreeBSD.org  Thu Jul 26 18:29:13 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Thu, 26 Jul 2018 11:29:10 -0700
Subject: head -r335782 (?) broke ci.freebsd.org's FreeBSD-head-amd64-gcc
 build (lib32 part of build)
In-Reply-To: <9251BE92-A8CE-45E3-B4BF-706E7219321A@yahoo.com>
References: <00D1127A-1F0E-4E0E-B86C-1C5AA5B2E085@yahoo.com>
 <CF0230A1-1384-4F0F-A96A-5AB555FD17AC@yahoo.com>
 <7A845F2C-C994-4828-823D-33A97B7B6EB0@yahoo.com>
 <72081b02-cf23-82ec-32df-7f5793c35f57@FreeBSD.org>
 <003509F0-F2F4-4A43-82FE-3F6FC23D19D4@yahoo.com>
 <65b19cc4-eaf0-13ed-43e6-9f04a1f7f196@FreeBSD.org>
 <FF369ACC-D496-49AF-BB41-406936E433B0@yahoo.com>
 <edcd2126-3554-f444-6ba0-3da94d887dfe@FreeBSD.org>
 <49BF6569-96A9-4104-BDE6-8BB94C0D9626@yahoo.com>
 <F60AE252-CB8E-429E-97BF-812CC4012A90@yahoo.com>
 <d9385d5b-85a7-3012-3024-c6d9ae8c6705@FreeBSD.org>
 <AA1986CC-E407-4085-BAF9-0C54D6FFB2F4@yahoo.com>
 <E7718790-DC0D-4D12-9758-6D240877A6C4@yahoo.com>
 <9251BE92-A8CE-45E3-B4BF-706E7219321A@yahoo.com>
Message-ID: <f598ee6e-4bef-4cce-d69b-9110af341e8a@FreeBSD.org>

On 7/16/18 11:27 PM, Mark Millard wrote:
> On 2018-Jul-1, at 6:34 AM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> My brain finally engaged for showing exactly what files are included
>> for the gcc builds: the .meta files include that information explicitly
>> (along with other files that are opened during the operation).
>>
>> amd64 is as I reported, just one header file from gcc: float.h .
>>
>> powerpc64 builds Lex/Lexer.cpp without defining __ALTIVEC__ and so
>> is not including <altivec.h> . Building without __ALTIVEC__ might
>> be an error itself but would be a workaround for the altivec.h
>> file name aliasing vs. search-path problem.
>>
>> . . .
> 
> Going in a different direction, what of the unchanged Makefile.inc1
> code block:
> 
> .if ${WANT_COMPILER_TYPE} == gcc || \
>     (defined(X_COMPILER_TYPE) && ${X_COMPILER_TYPE} == gcc)
> # GCC requires -isystem and -L when using a cross-compiler.  --sysroot
> # won't set header path and -L is used to ensure the base library path
> # is added before the port PREFIX library path.
> CD2CFLAGS+=     -isystem ${XDDESTDIR}/usr/include -L${XDDESTDIR}/usr/lib
> # GCC requires -B to find /usr/lib/crti.o when using a cross-compiler
> # combined with --sysroot.
> CD2CFLAGS+=     -B${XDDESTDIR}/usr/lib
> # Force using libc++ for external GCC.
> .if defined(X_COMPILER_TYPE) && \
>     ${X_COMPILER_TYPE} == gcc && ${X_COMPILER_VERSION} >= 40800
> CD2CXXFLAGS+=   -isystem ${XDDESTDIR}/usr/include/c++/v1 -std=c++11 \
>                 -nostdinc++
> .endif
> .endif
> 
> Why is that pair of -isystem uses that gives the old search order
> okay? Or was the block just missed? (Similarly for other options
> listed above.)

Just missed.  They should probably also be removed.

> Note: Locally I've reverted the -r335782 changes in order for my use
> of devel/*-gcc as cross compilers to work where they used to (hopefully:
> still building), restoring the historical search order for the
> directories for now.

I finally got the approval 2 days ago to remove float.h from amd64-gcc so
you shouldn't need this reverted anymore once the OFED thing is
straightened out.

-- 
John Baldwin

From yuri at rawbw.com  Thu Jul 26 20:12:54 2018
From: yuri at rawbw.com (Yuri)
Date: Thu, 26 Jul 2018 13:12:50 -0700
Subject: panic in btsocks_l2cap_sockets_mtx @ ng_btsocket_2cap.c:2438
Message-ID: <80605275-56ed-8f2d-0a08-1e768aa9db2e@rawbw.com>

Got this panic while trying to register the bluetooth mouse.

See the screenshot: https://imgur.com/a/RXZRIn9


r336271


Yuri


From marklmi at yahoo.com  Fri Jul 27 01:45:25 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 26 Jul 2018 18:14:48 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
Message-ID: <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>

On 2018-Jul-26, at 11:21 AM, John Baldwin <jhb at freebsd.org> wrote:

> On 7/26/18 10:55 AM, Mark Millard wrote:
>> . . .
> 
> Yes, but the -E from above was when compiled with external GCC and it didn't change
> _Atomic(int).  Here's part of the source of bar.c:
> 
> #include <sys/cdefs.h>
> #include <stdatomic.h>
> 
> struct foo {
>        _Atomic(int) one;
>        _Atomic int two;
>        atomic_int three;
> };
> 
> And here is what that became after -E:
> 
> # 4 "bar.c"
> struct foo {
> _Atomic(int) one;
> _Atomic int two;
> atomic_int three;
> };
> 
> So cdefs.h did not define _Atomic.
> 
> Ah, if I add '-std=c99' then it does break.  Code that wants to use
> C11 atomics via <stdatomic.h> should not be using -std=c99.  Try this:
> 
> Index: lib/ofed/librdmacm/Makefile
> ===================================================================
> --- lib/ofed/librdmacm/Makefile (revision 335896)
> +++ lib/ofed/librdmacm/Makefile (working copy)
> @@ -8,6 +8,7 @@
> SHLIB_MAJOR=   1
> MK_PROFILE=    no
> CFLAGS+=       -I${_spath}
> +CSTD=          gnu11
> 
> SRCS= \
> acm.c \
> 
> If this works then we should probably mark OFED as a BROKEN_OPTION when
> building with ancient GCC for now as well.

I've "unreverted" to set up a context for testing this.

So far I'll I've done is to test that I can still reproduce the failure
in my environment, same sort of error reports as ci.freebsd.org's
FreeBSD-head-amd64-gcc . This is without your patch.

But I've done this with gcc being given -v so that I've the exact commands
and search order and the like. It  does show: -std=gnu99 . I list the
filemon data from the .meta as well, showing the exact mix of
FreeBSD and gcc headers used. (I could also provide such for with
the reverted Makefile.{inc1,libcompat} [so non-failing] build if you
care.)


For now I just report the failure *without your patch*:
(I'll build again with your patch next.)

. . .
--- all_subdir_lib/ofed ---
Building /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o
--- acm.o ---
Using built-in specs.
COLLECT_GCC=/usr/local/bin/x86_64-unknown-freebsd12.0-gcc
Target: x86_64-unknown-freebsd12.0
Configured with: /wrkdirs/usr/ports/devel/amd64-gcc/work/gcc-6.4.0/configure --target=x86_64-unknown-freebsd12.0 --disable-nls --enable-languages=c,c++ --enable-gnu-indirect-function --without-headers --with-gmp=/usr/local --with-pkgversion='FreeBSD Ports Collection for amd64' --with-system-zlib --with-gxx-include-dir=/usr/include/c++/v1/ --with-sysroot=/ --with-as=/usr/local/bin/x86_64-unknown-freebsd12.0-as --with-ld=/usr/local/bin/x86_64-unknown-freebsd12.0-ld --enable-initfini-array --prefix=/usr/local --localstatedir=/var --mandir=/usr/local/man --infodir=/usr/local/info/ --build=x86_64-unknown-freebsd12.0
Thread model: posix
gcc version 6.4.0 (FreeBSD Ports Collection for amd64) 
COLLECT_GCC_OPTIONS='-B' '/usr/local/x86_64-unknown-freebsd12.0/bin/' '-O2' '-pipe' '-I' '/usr/src/contrib/ofed/librdmacm' '-g' '-std=gnu99' '-fstack-protector-strong' '-Wno-error=address' '-Wno-error=array-bounds' '-Wno-error=attributes' '-Wno-error=bool-compare' '-Wno-error=cast-align' '-Wno-error=clobbered' '-Wno-error=enum-compare' '-Wno-error=extra' '-Wno-error=inline' '-Wno-error=logical-not-parentheses' '-Wno-error=strict-aliasing' '-Wno-error=uninitialized' '-Wno-error=unused-but-set-variable' '-Wno-error=unused-function' '-Wno-error=unused-value' '-Wno-error=misleading-indentation' '-Wno-error=nonnull-compare' '-Wno-error=shift-negative-value' '-Wno-error=tautological-compare' '-Wno-error=unused-const-variable' '-v' '-c' '-o' 'acm.o' '-mtune=generic' '-march=x86-64'
 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1 -quiet -v -I /usr/src/contrib/ofed/librdmacm -isysroot /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp /usr/src/contrib/ofed/librdmacm/acm.c -quiet -dumpbase acm.c -mtune=generic -march=x86-64 -auxbase-strip acm.o -g -O2 -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable -std=gnu99 -version -fstack-protector-strong -o - |
 /usr/local/bin/x86_64-unknown-freebsd12.0-as -v -I /usr/src/contrib/ofed/librdmacm -o acm.o
GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include-fixed"
ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/../../../../x86_64-unknown-freebsd12.0/include"
#include "..." search starts here:
#include <...> search starts here:
 /usr/src/contrib/ofed/librdmacm
 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include
 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include
End of search list.
GNU assembler version 2.30 (x86_64-unknown-freebsd12.0) using BFD version (GNU Binutils) 2.30
GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
Compiler executable checksum: 0b55436e4202650149cc2feb351f4e0e
In file included from /usr/src/contrib/ofed/librdmacm/cma.h:43:0,
                 from /usr/src/contrib/ofed/librdmacm/acm.c:42:
/usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
/usr/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
  atomic_store(&lock->cnt, 0);
  ^
In file included from /usr/src/contrib/ofed/librdmacm/acm.c:42:0:
/usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
/usr/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
  if (atomic_fetch_add(&lock->cnt, 1) > 0)
  ^~
/usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
/usr/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
  ^~
*** [acm.o] Error code 1

make[6]: stopped in /usr/src/lib/ofed/librdmacm
.ERROR_TARGET='acm.o'
.ERROR_META_FILE='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta'
.MAKE.LEVEL='6'
MAKEFILE=''
.MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
_ERROR_CMD='/usr/local/bin/x86_64-unknown-freebsd12.0-gcc --sysroot=/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp -B/usr/local/x86_64-unknown-freebsd12.0/bin/  -O2 -pipe -I/usr/src/contrib/ofed/librdmacm   -g -std=gnu99 -fstack-protector-strong -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable   -v  -c /usr/src/contrib/ofed/librdmacm/acm.c -o acm.o; ;'
.CURDIR='/usr/src/lib/ofed/librdmacm'
.MAKE='make'
.OBJDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm'
.TARGETS='all'
DESTDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp'
LD_LIBRARY_PATH=''
MACHINE='amd64'
MACHINE_ARCH='amd64'
MAKEOBJDIRPREFIX=''
MAKESYSPATH='/usr/src/share/mk'
MAKE_VERSION='20180512'
PATH='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
SRCTOP='/usr/src'
OBJTOP='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64'
.MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.amd64-xtoolchain-gcc.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/lib/ofed/librdmacm/Makefile /usr/src/share/mk/bsd.lib.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/lib/ofed/librdmacm/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/share/mk/bsd.libnames.mk /usr/src/share/mk/src.libnames.mk /usr/src/share/mk/src.opts.mk /usr/src/share/mk/bsd.symver.mk /usr/src/share/mk/bsd.nls.mk /usr/src/share/mk/bsd.confs.mk /usr/src/share/mk/bsd.files.mk /usr/src/share/mk/bsd.dirs.mk /usr/src/share/mk/bsd.incs.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/share/mk/bsd.sys.mk'
.PATH='. /usr/src/lib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm/man'
1 error

From /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta
is the filemon data:

-- filemon acquired metadata --
# filemon version 5
# Target pid 95011
# Start 1532652684.414953
V 5
E 95033 /bin/sh
R 95033 /etc/libmap.conf
R 95033 /var/run/ld-elf.so.hints
R 95033 /lib/libedit.so.7
R 95033 /lib/libc.so.7
R 95033 /lib/libncursesw.so.8
F 95033 95034
E 95034 /usr/local/bin/x86_64-unknown-freebsd12.0-gcc
R 95034 /etc/libmap.conf
R 95034 /var/run/ld-elf.so.hints
R 95034 /usr/lib/libc++.so.1
R 95034 /lib/libcxxrt.so.1
R 95034 /lib/libm.so.5
R 95034 /lib/libc.so.7
R 95034 /lib/libgcc_s.so.1
F 95034 95035
E 95035 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1
F 95034 95036
R 95035 /etc/libmap.conf
R 95035 /var/run/ld-elf.so.hints
R 95035 /usr/local/lib/libmpc.so.3
R 95035 /usr/local/lib/libmpfr.so.6
R 95035 /usr/local/lib/libgmp.so.10
R 95035 /lib/libz.so.6
R 95035 /usr/lib/libc++.so.1
R 95035 /lib/libcxxrt.so.1
R 95035 /lib/libm.so.5
R 95035 /lib/libc.so.7
R 95035 /lib/libgcc_s.so.1
R 95035 /dev/urandom
R 95035 /usr/src/contrib/ofed/librdmacm/acm.c
E 95036 /usr/local/bin/x86_64-unknown-freebsd12.0-as
R 95036 /etc/libmap.conf
R 95036 /var/run/ld-elf.so.hints
R 95036 /lib/libc.so.7
R 95036 acm.o
W 95036 acm.o
R 95035 /usr/src/contrib/ofed/librdmacm/config.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdio.h
R 95035 /usr/src/sys/sys/cdefs.h
R 95035 /usr/src/sys/sys/_null.h
R 95035 /usr/src/sys/sys/_types.h
R 95035 /usr/src/sys/amd64/include/_types.h
R 95035 /usr/src/sys/x86/include/_types.h
R 95035 /usr/src/sys/amd64/include/_limits.h
R 95035 /usr/src/sys/x86/include/_limits.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/inttypes.h
R 95035 /usr/src/sys/amd64/include/_inttypes.h
R 95035 /usr/src/sys/x86/include/_inttypes.h
R 95035 /usr/src/sys/sys/stdint.h
R 95035 /usr/src/sys/amd64/include/_stdint.h
R 95035 /usr/src/sys/x86/include/_stdint.h
R 95035 /usr/src/sys/amd64/include/_limits.h
R 95035 /usr/src/sys/sys/_stdint.h
R 95035 /usr/src/sys/sys/types.h
R 95035 /usr/src/sys/amd64/include/endian.h
R 95035 /usr/src/sys/x86/include/endian.h
R 95035 /usr/src/sys/sys/_pthreadtypes.h
R 95035 /usr/src/sys/sys/select.h
R 95035 /usr/src/sys/sys/_sigset.h
R 95035 /usr/src/sys/sys/_timeval.h
R 95035 /usr/src/sys/sys/timespec.h
R 95035 /usr/src/sys/sys/_timespec.h
R 95035 /usr/src/sys/sys/socket.h
R 95035 /usr/src/sys/sys/_iovec.h
R 95035 /usr/src/sys/amd64/include/_align.h
R 95035 /usr/src/sys/x86/include/_align.h
R 95035 /usr/src/sys/sys/_sockaddr_storage.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/netdb.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/unistd.h
R 95035 /usr/src/sys/sys/unistd.h
R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
R 95035 /usr/src/contrib/ofed/librdmacm/config.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdlib.h
R 95035 /usr/src/sys/sys/errno.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/endian.h
R 95035 /usr/src/sys/sys/endian.h
R 95035 /usr/src/sys/amd64/include/endian.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/semaphore.h
R 95035 /usr/src/sys/sys/_umtx.h
R 95035 /usr/src/sys/amd64/include/_limits.h
R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/rdma/rdma_cma.h
R 95035 /usr/src/sys/netinet/in.h
R 95035 /usr/src/sys/amd64/include/endian.h
R 95035 /usr/src/sys/netinet6/in6.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/verbs.h
R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
R 95035 /usr/src/sys/sys/stdint.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/pthread.h
R 95035 /usr/src/sys/amd64/include/_limits.h
R 95035 /usr/src/sys/amd64/include/_types.h
R 95035 /usr/src/sys/sys/sched.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/time.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_time.h
R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/string.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/strings.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_strings.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_string.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/types.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/sa.h
R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/ib.h
R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
X 95036 0 0
X 95035 1 0
D 95034 acm.o
X 95034 1 0
X 95033 1 0
# Stop 1532652684.494688
# Bye bye



For reference the amd64-gcc is:

# pkg info amd64-gcc
amd64-gcc-6.4.0_1
Name           : amd64-gcc
Version        : 6.4.0_1
Installed on   : Sun Jul 15 09:15:38 2018 PDT
Origin         : devel/amd64-gcc
Architecture   : FreeBSD:12:amd64
Prefix         : /usr/local
Categories     : devel
Licenses       : GPLv3, GPLv3RLE
Maintainer     : kan at FreeBSD.org
WWW            : http://gcc.gnu.org/
Comment        : Cross GNU Compiler Collection for amd64
Shared Libs required:
	libmpc.so.3
	libgmp.so.10
	libmpfr.so.6
Shared Libs provided:
	liblto_plugin.so.0
Annotations    :
	FreeBSD_version: 1200069
	repo_type      : binary
	repository     : custom
Flat size      : 338MiB
Description    :
GCC, the GNU Compiler Collection supporting C and C++ for targetting crossbuilding.

WWW: http://gcc.gnu.org/


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From FreeBSD at ShaneWare.Biz  Fri Jul 27 03:57:37 2018
From: FreeBSD at ShaneWare.Biz (Shane Ambler)
Date: Fri, 27 Jul 2018 13:22:21 +0930
Subject: Changes to sysctl values
Message-ID: <e8498497-00df-81d8-3bf8-4d4179113532@ShaneWare.Biz>

I use devel/py-sysctl in some scripts to get values, using a recent
12-current (r336728) I see at least two values that get a different
value type than on 11-stable. Same version of python and port.

I have 12-current running in a bhyve on an 11-stable host.

Is there a recent change to sysctl calls that would cause this?
or is this bhyve related?

On 11-stable I get long int values that I expect

Python 2.7.15 (default, Jun  8 2018, 08:54:38)
[GCC 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final
326565)] on freebsd11
Type "help", "copyright", "credits" or "license" for more information.
>>> sysctl.filter('vm.stats.vm.v_wire_count')[0].value
1061486L
>>> sysctl.filter('vm.stats.vm.v_free_count')[0].value
77217L

On 12-current I get the same sysctls as a bytearray

Python 2.7.15 (default, Jul 26 2018, 10:32:28)
[GCC 4.2.1 Compatible FreeBSD Clang 6.0.1 (tags/RELEASE_601/final
335540)] on freebsd12
Type "help", "copyright", "credits" or "license" for more information.
>>> sysctl.filter('vm.stats.vm.v_wire_count')[0].value
bytearray(b"\'R\x12\x00")
>>> sysctl.filter('vm.stats.vm.v_free_count')[0].value
bytearray(b'\x06\\\x08\x00')



-- 
FreeBSD - the place to B...Software Developing

Shane Ambler


From marklmi at yahoo.com  Fri Jul 27 04:06:36 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 26 Jul 2018 21:06:29 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
Message-ID: <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>



On 2018-Jul-26, at 6:14 PM, Mark Millard <marklmi at yahoo.com> wrote:

> On 2018-Jul-26, at 11:21 AM, John Baldwin <jhb at freebsd.org> wrote:
> 
>> On 7/26/18 10:55 AM, Mark Millard wrote:
>>> . . .
>> 
>> Yes, but the -E from above was when compiled with external GCC and it didn't change
>> _Atomic(int).  Here's part of the source of bar.c:
>> 
>> #include <sys/cdefs.h>
>> #include <stdatomic.h>
>> 
>> struct foo {
>>       _Atomic(int) one;
>>       _Atomic int two;
>>       atomic_int three;
>> };
>> 
>> And here is what that became after -E:
>> 
>> # 4 "bar.c"
>> struct foo {
>> _Atomic(int) one;
>> _Atomic int two;
>> atomic_int three;
>> };
>> 
>> So cdefs.h did not define _Atomic.
>> 
>> Ah, if I add '-std=c99' then it does break.  Code that wants to use
>> C11 atomics via <stdatomic.h> should not be using -std=c99.  Try this:
>> 
>> Index: lib/ofed/librdmacm/Makefile
>> ===================================================================
>> --- lib/ofed/librdmacm/Makefile (revision 335896)
>> +++ lib/ofed/librdmacm/Makefile (working copy)
>> @@ -8,6 +8,7 @@
>> SHLIB_MAJOR=   1
>> MK_PROFILE=    no
>> CFLAGS+=       -I${_spath}
>> +CSTD=          gnu11
>> 
>> SRCS= \
>> acm.c \
>> 
>> If this works then we should probably mark OFED as a BROKEN_OPTION when
>> building with ancient GCC for now as well.
> 
> I've "unreverted" to set up a context for testing this.
> 
> So far I'll I've done is to test that I can still reproduce the failure
> in my environment, same sort of error reports as ci.freebsd.org's
> FreeBSD-head-amd64-gcc . This is without your patch.
> 
> But I've done this with gcc being given -v so that I've the exact commands
> and search order and the like. It  does show: -std=gnu99 . I list the
> filemon data from the .meta as well, showing the exact mix of
> FreeBSD and gcc headers used. (I could also provide such for with
> the reverted Makefile.{inc1,libcompat} [so non-failing] build if you
> care.)
> 
> 
> For now I just report the failure *without your patch*:
> (I'll build again with your patch next.)
> 
> . . .
> --- all_subdir_lib/ofed ---
> Building /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o
> --- acm.o ---
> Using built-in specs.
> COLLECT_GCC=/usr/local/bin/x86_64-unknown-freebsd12.0-gcc
> Target: x86_64-unknown-freebsd12.0
> Configured with: /wrkdirs/usr/ports/devel/amd64-gcc/work/gcc-6.4.0/configure --target=x86_64-unknown-freebsd12.0 --disable-nls --enable-languages=c,c++ --enable-gnu-indirect-function --without-headers --with-gmp=/usr/local --with-pkgversion='FreeBSD Ports Collection for amd64' --with-system-zlib --with-gxx-include-dir=/usr/include/c++/v1/ --with-sysroot=/ --with-as=/usr/local/bin/x86_64-unknown-freebsd12.0-as --with-ld=/usr/local/bin/x86_64-unknown-freebsd12.0-ld --enable-initfini-array --prefix=/usr/local --localstatedir=/var --mandir=/usr/local/man --infodir=/usr/local/info/ --build=x86_64-unknown-freebsd12.0
> Thread model: posix
> gcc version 6.4.0 (FreeBSD Ports Collection for amd64) 
> COLLECT_GCC_OPTIONS='-B' '/usr/local/x86_64-unknown-freebsd12.0/bin/' '-O2' '-pipe' '-I' '/usr/src/contrib/ofed/librdmacm' '-g' '-std=gnu99' '-fstack-protector-strong' '-Wno-error=address' '-Wno-error=array-bounds' '-Wno-error=attributes' '-Wno-error=bool-compare' '-Wno-error=cast-align' '-Wno-error=clobbered' '-Wno-error=enum-compare' '-Wno-error=extra' '-Wno-error=inline' '-Wno-error=logical-not-parentheses' '-Wno-error=strict-aliasing' '-Wno-error=uninitialized' '-Wno-error=unused-but-set-variable' '-Wno-error=unused-function' '-Wno-error=unused-value' '-Wno-error=misleading-indentation' '-Wno-error=nonnull-compare' '-Wno-error=shift-negative-value' '-Wno-error=tautological-compare' '-Wno-error=unused-const-variable' '-v' '-c' '-o' 'acm.o' '-mtune=generic' '-march=x86-64'
> /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1 -quiet -v -I /usr/src/contrib/ofed/librdmacm -isysroot /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp /usr/src/contrib/ofed/librdmacm/acm.c -quiet -dumpbase acm.c -mtune=generic -march=x86-64 -auxbase-strip acm.o -g -O2 -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable -std=gnu99 -version -fstack-protector-strong -o - |
> /usr/local/bin/x86_64-unknown-freebsd12.0-as -v -I /usr/src/contrib/ofed/librdmacm -o acm.o
> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include-fixed"
> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/../../../../x86_64-unknown-freebsd12.0/include"
> #include "..." search starts here:
> #include <...> search starts here:
> /usr/src/contrib/ofed/librdmacm
> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include
> /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include
> End of search list.
> GNU assembler version 2.30 (x86_64-unknown-freebsd12.0) using BFD version (GNU Binutils) 2.30
> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
> Compiler executable checksum: 0b55436e4202650149cc2feb351f4e0e
> In file included from /usr/src/contrib/ofed/librdmacm/cma.h:43:0,
>                 from /usr/src/contrib/ofed/librdmacm/acm.c:42:
> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
> /usr/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>  atomic_store(&lock->cnt, 0);
>  ^
> In file included from /usr/src/contrib/ofed/librdmacm/acm.c:42:0:
> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
> /usr/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>  if (atomic_fetch_add(&lock->cnt, 1) > 0)
>  ^~
> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
> /usr/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>  if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>  ^~
> *** [acm.o] Error code 1
> 
> make[6]: stopped in /usr/src/lib/ofed/librdmacm
> .ERROR_TARGET='acm.o'
> .ERROR_META_FILE='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta'
> .MAKE.LEVEL='6'
> MAKEFILE=''
> .MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
> _ERROR_CMD='/usr/local/bin/x86_64-unknown-freebsd12.0-gcc --sysroot=/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp -B/usr/local/x86_64-unknown-freebsd12.0/bin/  -O2 -pipe -I/usr/src/contrib/ofed/librdmacm   -g -std=gnu99 -fstack-protector-strong -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable   -v  -c /usr/src/contrib/ofed/librdmacm/acm.c -o acm.o; ;'
> .CURDIR='/usr/src/lib/ofed/librdmacm'
> .MAKE='make'
> .OBJDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm'
> .TARGETS='all'
> DESTDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp'
> LD_LIBRARY_PATH=''
> MACHINE='amd64'
> MACHINE_ARCH='amd64'
> MAKEOBJDIRPREFIX=''
> MAKESYSPATH='/usr/src/share/mk'
> MAKE_VERSION='20180512'
> PATH='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
> SRCTOP='/usr/src'
> OBJTOP='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64'
> .MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.amd64-xtoolchain-gcc.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/lib/ofed/librdmacm/Makefile /usr/src/share/mk/bsd.lib.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/lib/ofed/librdmacm/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/share/mk/bsd.libnames.mk /usr/src/share/mk/src.libnames.mk /usr/src/share/mk/src.opts.mk /usr/src/share/mk/bsd.symver.mk /usr/src/share/mk/bsd.nls.mk /usr/src/share/mk/bsd.confs.mk /usr/src/share/mk/bsd.files.mk /usr/src/share/mk/bsd.dirs.mk /usr/src/share/mk/bsd.incs.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/share/mk/bsd.sys.mk'
> .PATH='. /usr/src/lib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm/man'
> 1 error
> 
> From /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta
> is the filemon data:
> 
> -- filemon acquired metadata --
> # filemon version 5
> # Target pid 95011
> # Start 1532652684.414953
> V 5
> E 95033 /bin/sh
> R 95033 /etc/libmap.conf
> R 95033 /var/run/ld-elf.so.hints
> R 95033 /lib/libedit.so.7
> R 95033 /lib/libc.so.7
> R 95033 /lib/libncursesw.so.8
> F 95033 95034
> E 95034 /usr/local/bin/x86_64-unknown-freebsd12.0-gcc
> R 95034 /etc/libmap.conf
> R 95034 /var/run/ld-elf.so.hints
> R 95034 /usr/lib/libc++.so.1
> R 95034 /lib/libcxxrt.so.1
> R 95034 /lib/libm.so.5
> R 95034 /lib/libc.so.7
> R 95034 /lib/libgcc_s.so.1
> F 95034 95035
> E 95035 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1
> F 95034 95036
> R 95035 /etc/libmap.conf
> R 95035 /var/run/ld-elf.so.hints
> R 95035 /usr/local/lib/libmpc.so.3
> R 95035 /usr/local/lib/libmpfr.so.6
> R 95035 /usr/local/lib/libgmp.so.10
> R 95035 /lib/libz.so.6
> R 95035 /usr/lib/libc++.so.1
> R 95035 /lib/libcxxrt.so.1
> R 95035 /lib/libm.so.5
> R 95035 /lib/libc.so.7
> R 95035 /lib/libgcc_s.so.1
> R 95035 /dev/urandom
> R 95035 /usr/src/contrib/ofed/librdmacm/acm.c
> E 95036 /usr/local/bin/x86_64-unknown-freebsd12.0-as
> R 95036 /etc/libmap.conf
> R 95036 /var/run/ld-elf.so.hints
> R 95036 /lib/libc.so.7
> R 95036 acm.o
> W 95036 acm.o
> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdio.h
> R 95035 /usr/src/sys/sys/cdefs.h
> R 95035 /usr/src/sys/sys/_null.h
> R 95035 /usr/src/sys/sys/_types.h
> R 95035 /usr/src/sys/amd64/include/_types.h
> R 95035 /usr/src/sys/x86/include/_types.h
> R 95035 /usr/src/sys/amd64/include/_limits.h
> R 95035 /usr/src/sys/x86/include/_limits.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/inttypes.h
> R 95035 /usr/src/sys/amd64/include/_inttypes.h
> R 95035 /usr/src/sys/x86/include/_inttypes.h
> R 95035 /usr/src/sys/sys/stdint.h
> R 95035 /usr/src/sys/amd64/include/_stdint.h
> R 95035 /usr/src/sys/x86/include/_stdint.h
> R 95035 /usr/src/sys/amd64/include/_limits.h
> R 95035 /usr/src/sys/sys/_stdint.h
> R 95035 /usr/src/sys/sys/types.h
> R 95035 /usr/src/sys/amd64/include/endian.h
> R 95035 /usr/src/sys/x86/include/endian.h
> R 95035 /usr/src/sys/sys/_pthreadtypes.h
> R 95035 /usr/src/sys/sys/select.h
> R 95035 /usr/src/sys/sys/_sigset.h
> R 95035 /usr/src/sys/sys/_timeval.h
> R 95035 /usr/src/sys/sys/timespec.h
> R 95035 /usr/src/sys/sys/_timespec.h
> R 95035 /usr/src/sys/sys/socket.h
> R 95035 /usr/src/sys/sys/_iovec.h
> R 95035 /usr/src/sys/amd64/include/_align.h
> R 95035 /usr/src/sys/x86/include/_align.h
> R 95035 /usr/src/sys/sys/_sockaddr_storage.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/netdb.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/unistd.h
> R 95035 /usr/src/sys/sys/unistd.h
> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdlib.h
> R 95035 /usr/src/sys/sys/errno.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/endian.h
> R 95035 /usr/src/sys/sys/endian.h
> R 95035 /usr/src/sys/amd64/include/endian.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/semaphore.h
> R 95035 /usr/src/sys/sys/_umtx.h
> R 95035 /usr/src/sys/amd64/include/_limits.h
> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/rdma/rdma_cma.h
> R 95035 /usr/src/sys/netinet/in.h
> R 95035 /usr/src/sys/amd64/include/endian.h
> R 95035 /usr/src/sys/netinet6/in6.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/verbs.h
> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
> R 95035 /usr/src/sys/sys/stdint.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/pthread.h
> R 95035 /usr/src/sys/amd64/include/_limits.h
> R 95035 /usr/src/sys/amd64/include/_types.h
> R 95035 /usr/src/sys/sys/sched.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/time.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_time.h
> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/string.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/strings.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_strings.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_string.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/types.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/sa.h
> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/ib.h
> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
> X 95036 0 0
> X 95035 1 0
> D 95034 acm.o
> X 95034 1 0
> X 95033 1 0
> # Stop 1532652684.494688
> # Bye bye
> 
> 
> 
> For reference the amd64-gcc is:
> 
> # pkg info amd64-gcc
> amd64-gcc-6.4.0_1
> Name           : amd64-gcc
> Version        : 6.4.0_1
> Installed on   : Sun Jul 15 09:15:38 2018 PDT
> Origin         : devel/amd64-gcc
> Architecture   : FreeBSD:12:amd64
> Prefix         : /usr/local
> Categories     : devel
> Licenses       : GPLv3, GPLv3RLE
> Maintainer     : kan at FreeBSD.org
> WWW            : http://gcc.gnu.org/
> Comment        : Cross GNU Compiler Collection for amd64
> Shared Libs required:
> 	libmpc.so.3
> 	libgmp.so.10
> 	libmpfr.so.6
> Shared Libs provided:
> 	liblto_plugin.so.0
> Annotations    :
> 	FreeBSD_version: 1200069
> 	repo_type      : binary
> 	repository     : custom
> Flat size      : 338MiB
> Description    :
> GCC, the GNU Compiler Collection supporting C and C++ for targetting crossbuilding.
> 
> WWW: http://gcc.gnu.org/

With your patch it gets past that point of build failure.

But my devel/amd64-gcc predates the removal of float.h from
the installed devel/amd64-gcc so the following may not be as
it would be in such a context:

--- lib/msun__L ---
/usr/src/lib/msun/src/catrigl.c:90:2: error: #error "Unsupported long double format"
 #error "Unsupported long double format"
  ^~~~~
. . .
--- lib/msun__L ---
/usr/src/lib/msun/src/catrigl.c: In function 'casinhl':
/usr/src/lib/msun/src/catrigl.c:190:35: error: 'm_ln2' undeclared (first use in this function)
    w = clog_for_large_values(z) + m_ln2;
                                   ^~~~~
/usr/src/lib/msun/src/catrigl.c:190:35: note: each undeclared identifier is reported only once for each function it appears in
/usr/src/lib/msun/src/catrigl.c:202:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
  if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
           ^~~~~~~~~~~~~~
/usr/src/lib/msun/src/catrigl.c: In function 'cacosl':
/usr/src/lib/msun/src/catrigl.c:250:20: error: 'm_ln2' undeclared (first use in this function)
   ry = creall(w) + m_ln2;
                    ^~~~~
/usr/src/lib/msun/src/catrigl.c:261:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
  if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
           ^~~~~~~~~~~~~~
In file included from /usr/src/lib/msun/src/catrigl.c:45:0:



I can remove float.h and see what happens.


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From cem at freebsd.org  Fri Jul 27 05:37:53 2018
From: cem at freebsd.org (Conrad Meyer)
Date: Thu, 26 Jul 2018 22:08:15 -0700
Subject: Changes to sysctl values
In-Reply-To: <e8498497-00df-81d8-3bf8-4d4179113532@ShaneWare.Biz>
References: <e8498497-00df-81d8-3bf8-4d4179113532@ShaneWare.Biz>
Message-ID: <CAG6CVpXoa-f7Mp7_T4SOyC1wBKNuBv1EzjWkS5+zbgR_1pHvyA@mail.gmail.com>

On Thu, Jul 26, 2018 at 8:52 PM, Shane Ambler <FreeBSD at shaneware.biz> wrote:
> I use devel/py-sysctl in some scripts to get values, using a recent
> 12-current (r336728) I see at least two values that get a different
> value type than on 11-stable. Same version of python and port.
> ...

Hi Shane,

At some point, new sysctl types were added to the kernel, including
CTLTYPE_U32.  As part of the conversion to the counter(9) API, it
seems the v_wire_count (and other vm.stats sysctls) changed to U32
type.  py-sysctl lacks support for CTLTYPE_U32 and defaults to giving
you a bytearray for unrecognized types.

Best,
Conrad

From ohartmann at walstatt.org  Fri Jul 27 05:51:56 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 27 Jul 2018 07:46:21 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
Message-ID: <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>

On Thu, 26 Jul 2018 19:23:43 +0300
Toomas Soome <tsoome at me.com> wrote:

(reply inline/at the end)


> > On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
> > "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
> > <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote: 
> >>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> >>>> 
> >>>> On Wed, 25 Jul 2018 11:46:07 +0300
> >>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>   
> >>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>> 
> >>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
> >>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>> 
> >>>>>> 
> >>>>>> Hello  Toomas Soome,
> >>>>>> 
> >>>>>> I CC Allan Jude since I discovered something  weird today regarding the
> >>>>>> UEFI boot capabilities of USB flash devices and SSDs. See below.
> >>>>>>   
> >>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>>> 
> >>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>>   
> >>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>> wrote:
> >>>>>>>>>> 
> >>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>>>>>>   
> >>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>>>>>>> 
> >>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>>>>>>> Hash: SHA512
> >>>>>>>>>>>> 
> >>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:         
> >>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>>>>> wrote:
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on
> >>>>>>>>>>>>>> GPT drives where the first partition begins at block 40 of the
> >>>>>>>>>>>>>> hdd/ssd.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> I have two host in private use based on an
> >>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
> >>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
> >>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013. This
> >>>>>>>>>>>>>> is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for the Z77
> >>>>>>>>>>>>>> Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
> >>>>>>>>>>>>>> for the Spectre/Meltdown mitigation is available, but I didn't
> >>>>>>>>>>>>>> test that. But please read.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
> >>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
> >>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall
> >>>>>>>>>>>>>> the OS using UEFI-only boot method on a GPT partitioned device
> >>>>>>>>>>>>>> fails. The ASRock boards jump immediately into the firmware,
> >>>>>>>>>>>>>> the Fujitsu offers some kind of CPU/Memory/HDD test facility.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot
> >>>>>>>>>>>>>> only is implied, the MBR partitioned FreeBSD installation USB
> >>>>>>>>>>>>>> flash device does boot in UEFI! I guess I can assume this when
> >>>>>>>>>>>>>> the well known clumsy 80x25 char console suddenly gets bright
> >>>>>>>>>>>>>> and shiny with a much higher resoltion as long the GPU supports
> >>>>>>>>>>>>>> EFI GOP. Looking with gpart at the USB flash drives reveals
> >>>>>>>>>>>>>> that the EFI partition starts at block 1 of the device and the
> >>>>>>>>>>>>>> device has a MBR layout. I haven't found a way to force the GPT
> >>>>>>>>>>>>>> scheme, when initialised via gpart, to let the partitions start
> >>>>>>>>>>>>>> at block 1. This might be a naiv thinking, so please be patient
> >>>>>>>>>>>>>> with me.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
> >>>>>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI
> >>>>>>>>>>>>>> and that worked - FreeBSD not. I gave up on that that time.
> >>>>>>>>>>>>>> Now, having the very same issues with a new Fujitsu system,
> >>>>>>>>>>>>>> leaves me with the impression that FreeBSD's UEFI
> >>>>>>>>>>>>>> implementation might have problems I'm not aware of.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>>>>>>   
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
> >>>>>>>>>>>>> do not support secure boot at all at this time.            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>>>>>>   
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> If you have efi or bios version running - you can check from
> >>>>>>>>>>>>> either console variable value (it can have efi or vidconsole or
> >>>>>>>>>>>>> comconsole) or better yet, see if efi-version is set (show
> >>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
> >>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
> >>>>>>>>>>>>> paths present, it is uefi:)            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> What are you talking about?
> >>>>>>>>>>>> What is the point of entry - running system, loader?
> >>>>>>>>>>>> 
> >>>>>>>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>>>>>>> 
> >>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS - as
> >>>>>>>>>>>> I'm sure since I've checked that many times. UEFI doesn't work on
> >>>>>>>>>>>> those systems with FreeBSD. I'm not sure antmore, but I tried
> >>>>>>>>>>>> also Windows 7 on those mainboards booting via UEFI - and I might
> >>>>>>>>>>>> recall that they failed also. I also recall that there were
> >>>>>>>>>>>> issues with earlier UEFI versions regarding booting only Windows
> >>>>>>>>>>>> 8/8.1 - and nothing else, but the fact that Linux worked confuses
> >>>>>>>>>>>> me a bit.
> >>>>>>>>>>>> 
> >>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work
> >>>>>>>>>>>> at all - who cares, I intend to purchase new server grade
> >>>>>>>>>>>> hardware. But the more puzzling issue is with the Fujitsu, which
> >>>>>>>>>>>> I consider serious and from the behaviour the Fujitsu failure
> >>>>>>>>>>>> looks exactly like the ASRock - Windows 7 works, RedHat 7.5
> >>>>>>>>>>>> works (I assume I can trust the Firmware settings when I disable
> >>>>>>>>>>>> CSM support, that the Firmware will only EFI/UEFI capable
> >>>>>>>>>>>> loader? Or is there a ghosty override somwhere to be expected?).
> >>>>>>>>>>>> Also on ASRock disabling CSM should ensure not booting a
> >>>>>>>>>>>> dual-bootstrap-capable system. This said, on the recent Fujitsu,
> >>>>>>>>>>>> it seems to boil down to a FreeBSD UEFI-firmware interaction
> >>>>>>>>>>>> problem, while the ASRock is still under suspicion to be broken
> >>>>>>>>>>>> by design.           
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this
> >>>>>>>>>>>>> is because at sector 0 there is MBR (for compatibility), sector
> >>>>>>>>>>>>> 1 is GPT table and then sectors 2-33 have GPT partition table
> >>>>>>>>>>>>> entries, so the first possible data sector is 34 (absolute 34).
> >>>>>>>>>>>>> Thats assuming 512B sectors. For details see UEFI 2.7 Chapter
> >>>>>>>>>>>>> 5.3.1 page 131.            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> Thanks for the explanation. That implies the installer did right,
> >>>>>>>>>>>> gpart did also right and therefore there must be an issue with
> >>>>>>>>>>>> the stuff located within the EFI partition?           
> >>>>>>>>>>> 
> >>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
> >>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
> >>>>>>>>>>> actually caring to read the MBR code and start it, since once the
> >>>>>>>>>>> MBR code is started, it is all about our code.          
> >>>>>>>>>> 
> >>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or
> >>>>>>>>>> do you mean that specific portion of the UEFI firmware, which looks
> >>>>>>>>>> for the proper UEFI partition?
> >>>>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> BIOS as either native or CSM. Note that from boot code point of view
> >>>>>>>>> the CSM boot *is* BIOS boot, we have no access to UEFI features.
> >>>>>>>>>   
> >>>>>>>>>> 
> >>>>>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
> >>>>>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
> >>>>>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched
> >>>>>>>>>> off in the firmware. Again: GPT partition scheme.
> >>>>>>>>>> 
> >>>>>>>>>> The system boots properly if a second partition of type
> >>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
> >>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is
> >>>>>>>>>> the device).           
> >>>>>>>>>>> 
> >>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
> >>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
> >>>>>>>>>>> prompt:          
> >>>>>>>>>> 
> >>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>>>>>>> 
> >>>>>>>>>> OK lsdev
> >>>>>>>>>> disk devices:
> >>>>>>>>>> 	disk0:		BIOS DRIVE C ...
> >>>>>>>>>> 
> >>>>>>>>>> 		disk0p1:	EFI
> >>>>>>>>>> 		disk0p2:	FreeBSD BOOT
> >>>>>>>>>> 		disk0p3:	FreeBSD SWAP
> >>>>>>>>>> 		disk0p4:	FreeBSD ZFS
> >>>>>>>>>> zfs devices:
> >>>>>>>>>> 	zfs:zroot
> >>>>>>>>>> 
> >>>>>>>>>> OK chain disk0
> >>>>>>>>>> open failed     (so for disk0p{1-4}.
> >>>>>>>>>> 
> >>>>>>>>>> OK chain zroot
> >>>>>>>>>> failed to read disk (just for completeness)          
> >>>>>>>>> 
> >>>>>>>>> 
> >>>>>>>>> chain command does use only device name (such as disk0: or
> >>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
> >>>>>>>>> ported the code to read the file.        
> >>>>>>>> 
> >>>>>>>> ??
> >>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> the point for chain command test is to see if the normal read and
> >>>>>>>>> execute would work, so in your case please try:
> >>>>>>>>> 
> >>>>>>>>> chain disk0:        
> >>>>>>>> 
> >>>>>>>> As stated above, I did so, and the result is also mentioned above, I
> >>>>>>>> always get "open failed".
> >>>>>>>> This is the same for 
> >>>>>>>> 
> >>>>>>>> chain disk0
> >>>>>>>> chain disk0p1
> >>>>>>>> chain disk0p2
> >>>>>>>> chain disk0p3
> >>>>>>>> chain disk0p4
> >>>>>>>> 
> >>>>>>>> as already said. CSM is enabled in this case.        
> >>>>>>> 
> >>>>>>> sigh? chain command does take device as argument, device must always
> >>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
> >>>>>>> above, the command should be:
> >>>>>>> 
> >>>>>>> chain disk0:
> >>>>>>> 
> >>>>>>> The disk0p1: etc will only work when partition boot code was installed
> >>>>>>> (which you most likely do not have - the only possible candidate could
> >>>>>>> be FreeBSD ZFS partition).      
> >>>>>> 
> >>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
> >>>>>> partition scheme, but with PMBR bootblock installed and freebsd-boot
> >>>>>> partition conatining gptzfsboot installed.
> >>>>>> 
> >>>>>>   
> >>>>>>>   
> >>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
> >>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from disk0p2:
> >>>>>>>>> and execute it; stage1 would detect FreeBSD ZFS from disk0p4: and
> >>>>>>>>> load and execute /boot/loader. If that will happen, it means the
> >>>>>>>>> boot code in our stages is just fine, but the bios (CSM) does not
> >>>>>>>>> load pmbr?.  if thats true, it would mean that you either need to
> >>>>>>>>> use UEFI boot or need to have some hack to fool the BIOS or just not
> >>>>>>>>> use GPT on that machine with CSM.        
> >>>>>>>> 
> >>>>>>>> To make it clear here: The only way to boot this box is using CSM (as
> >>>>>>>> it is the same with the ASRock boards mentioned earlier). But my
> >>>>>>>> intention is to disable CSM and use a GPT/UEFI environment only! And
> >>>>>>>> GPT/UEFI doesn't work with FreeBSD, neither with 12-CURRENT, nor
> >>>>>>>> 11.2-RELENG.
> >>>>>>>> 
> >>>>>>>> It would be nice if this could be fixed. I'm more interested in the
> >>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
> >>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
> >>>>>>>> byproduct, I'd appreciate that.
> >>>>>>>> 
> >>>>>>>> Kind regards,
> >>>>>>>>   
> >>>>>>> 
> >>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
> >>>>>>> that the UEFI boot fails when the first partition starts from sector
> >>>>>>> 40 - does it mean you have boot when the partition will start from
> >>>>>>> some other sector? I think, there is something else going on.      
> >>>>>> 
> >>>>>> Well, I simply try to describe what I "see" to make things
> >>>>>> disambiguous. I'm not familiar with the deeper insights of disk layouts
> >>>>>> on a binary level. So, you explained to me the reason, why ESP (EGI
> >>>>>> partition) starts at block 40. I compared that to the FreeBSD USB flash
> >>>>>> image FreeBSD provides, but this is another story since the image uses
> >>>>>> MBR scheme as I figured out.
> >>>>>> 
> >>>>>>   
> >>>>>>> 
> >>>>>>> What you can do is to see if that firmware will offer you EFI shell
> >>>>>>> option, from there you can try to start the bootx64.efi manually and
> >>>>>>> see what error you will get. However, the number 1 cause for failing
> >>>>>>> to start the bootloader in UEFI is secure boot - we do not support it
> >>>>>>> and secure boot must be switched off. 
> >>>>>>> 
> >>>>>>> However, they seem to claim "The Secure Boot option is available in
> >>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is disabled by
> >>>>>>> default.? 
> >>>>>>> 
> >>>>>>> Still suggest to double check if thats really the case. Also, if the
> >>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
> >>>>>>> then either there is something in firmware logs or you could get them
> >>>>>>> from trying to start bootx64.efi from UEFI shell.      
> >>>>>> 
> >>>>>> Since I'm with this problem since 2014 and try from time to time, be
> >>>>>> ausred that I tried every possible permutationof all reasonable
> >>>>>> options, even those nonsense, to get rid of that problem.
> >>>>>> 
> >>>>>> I never had any problems with any other UEFI capable server/workstation
> >>>>>> firmware so far booting FreeBSD off in UEFI-native (GPT partition
> >>>>>> scheme, CSM disabled) so far - until now, when I ran into this Fujitsu
> >>>>>> ESPRIMO Q956 with the most recent firmware (as of lat week, week 29 of
> >>>>>> 2018) having the very same problems. 
> >>>>>> 
> >>>>>> 
> >>>>>> 
> >>>>>> I figured out something strange on the Fujitsu - and that is the same
> >>>>>> with the ASRock boards.
> >>>>>> 
> >>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> >>>>>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
> >>>>>> servers with UEFI-only configurations. I assume at this point that
> >>>>>> disabling on the most recent Fujitsu firmwares on reasonable "new"
> >>>>>> hardware (not older than three years) will disable any(!) legacy BIOS
> >>>>>> capabilities. The same is assumed for the Fujitus ESPRIMO Q956. I can
> >>>>>> not speak for the ASRock A77 Pro4/m boards mentioned above/earlier,
> >>>>>> they are from 2012/2013 and "quite old".
> >>>>>> 
> >>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
> >>>>>> partition scheme of the flash device is GPT. The layout looks like
> >>>>>> this:
> >>>>>> 
> >>>>>> gpart show -l da4      
> >>>>>> =>      40  15425456  da4  GPT  (7.4G)      
> >>>>>>      40      2000    1  efiboot0  (1.0M)
> >>>>>>    2040   1453584    3  disk1a  (710M)
> >>>>>> 1455624      4096    5  disk3  (2.0M)
> >>>>>> 1459720  13965776       - free -  (6.7G)
> >>>>>> 
> >>>>>> I created the flash with md, gpart and dd straightforward, efiboot0 is
> >>>>>> the ESP partition and its format/content is created via dd
> >>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
> >>>>>> 
> >>>>>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
> >>>>>> boards and the Esprimo Q956!
> >>>>>> 
> >>>>>> But any SSD prepared the same way doesn't. Why? 
> >>>>>> 
> >>>>>> On the ASRock, I recall having fiddled around with HDD also for a while
> >>>>>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I
> >>>>>> can't remember. 
> >>>>>> 
> >>>>>> In the lack of proper hardware I'm unable to check whether USB-attached
> >>>>>> HDD or SSD will boot or HDD will boot (just in case the local SATA has
> >>>>>> problems booting UEFI and USB not).
> >>>>>> 
> >>>>>> Kind regards,
> >>>>>> 
> >>>>>> Oliver 
> >>>>>>   
> >>>>> 
> >>>>> Am. well. I think the suggestion to test out FAT32 is still good one to
> >>>>> test. This is because it is known that some vendors do not support
> >>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
> >>>>> specification does not tell which FAT must be supported, and only hint
> >>>>> about FAT12/FAT16 in context of removable devices).    
> >>>> 
> >>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
> >>>> took me a time to circumvent the installer and I had to install the
> >>>> system manually. In that strain, I also "tried" to establish the ESP with
> >>>> FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc help how
> >>>> to find out the format (FAT12/16/32) of the ESP, so I assume when using
> >>>> 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and GPT (UEFI)
> >>>> (only!) the resulting ESP is FAT12 or FAT16 (300mb by default). I also
> >>>> assume, that when dd'ing the /boo/boot1.efifat image to a partition, the
> >>>> format is FAT, but not FAT32. Therefore, I refomatted the manually
> >>>> created ESP (using "gpart add -t efi ...") using "newfs_msdos -F 32 -b
> >>>> xxx ...". I had to fiddle around a bit with option -b to fit in a proper
> >>>> format to meet a 512mb ESP - I'm not sure whether this is the proper
> >>>> option to deal with. When using the default and only -F32, the size of
> >>>> the partition has to be 4G at least I assume. Having done that, I copied
> >>>> the the content of boot1.efifat (mdconfig -t vnode ..., I guess we know
> >>>> the drill ...) to the newly formatted ESP to /boot/efi/ ...
> >>>> 
> >>>> Having so far no knowledge of how to asure that the created ESP is FAT32,
> >>>> I assume it is FAT32.
> >>>> 
> >>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
> >>>> box is not willing to boot from SSD with the ESP prepared as decribed.
> >>>> So, a chance that this might still be due to a misconfiguration lies now
> >>>> within the -b option of newfs_msdos - if the -b option is assumed the
> >>>> proper option?
> >>>> 
> >>>> At the moment, the ESP of the Esprimo is subject to changes, if you wish,
> >>>> but not in size, since it is limited to 512mb.
> >>>> 
> >>>> Thanks and kind regards,
> >>>> 
> >>>> Oliver    
> >>> 
> >>> Yea, i was hoping fstyp command would report the FAT type, but it does not
> >>> (request for feature?:)    
> >> 
> >> FYI, the file(1) command is very good at disecting a disk image to tell
> >> you what the MBR looks like, and at looking at partitions if pointed at
> >> them with the -s option.  It should be able to detect FAT12/16/32.
> >> 
> >> root at x230a:/home/ISO/x # file -s /dev/md2s1
> >> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ",
> >> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
> >> sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS     ",
> >> FAT (12 bit), followed by FAT
> >>   
> >>> 
> >>> However, the more annoying idea would be to install some OS which will
> >>> boot with UEFI on this machine, then copy boot1.efi from freebsd to it
> >>> (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in
> >>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do
> >>> not support EFI32.
> >>> 
> >>> note that boot1.efi alone will not do much but printing on screen how it
> >>> will search for freebsd, but for the purpose of the test it would suffice
> >>> - that would give us confirmed working ESP file system (since the other os
> >>> would be able to boot) and then we can confirm if boot1.efi itself is
> >>> OK.    
> >>   
> > 
> > Some new results.
> > I installed RedHat 7.5 and inestigated the ESP.
> > 
> > - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
> > - size is both 200mb if installed automatically. I forgit to investigate the
> >  FAT format, but this might be unnecessary as shown further in this post.
> > - RedHat's ESP contains ~ 10 MB of data in two
> > folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
> > RedHat's doesn't change anything, also renaming /efi/boot/fbx64.efi of
> > RedHat's installation. But renaming /efi/redhat renders RedHat to fail the
> > boot process on the Fujitsu with the signs of the built-in testprogram as
> > reported.
> > 
> > I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot only
> > (CSM in firmware disabled, but there is still a gptzfsboot-prepared
> > partition for later use, just for the record). Booting UEFI-only fails as
> > reported. On this installation I copied the RedHat ESP completely into
> > FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh
> > and copied FreeBSD's BOOTX64.efi to /efi/boot. 
> > The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
> > the /efi/redhat folder of the ESP is important, if renamed, the whole
> > process dies as I reported earlier.
> > 
> > Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB
> > flash booting with CSM disabled (so asumingly UEFI only then) on both
> > ASRock and Fujitsu (as described in more detail initially and earlier),
> > while SSDs fail? Is there a difference? Since FreeBSD boots in UEFI mode
> > from USB flash prepared as described (straight forward, 800k ESP starting
> > at block 40, the boot1.efifat image dd'ed onto the partition, UFS partition
> > following, no freebsd-boot partition or MBR/PMBR bootcode applied ever!), I
> > think BOOTX64.EFI is technically all right. There must be then an issue
> > with the SATA/SSD/HDD boot pathway.
> > 
> > Hope I could provide some more details, sorry if it sounds confusing or way
> > too long, but I try to descibe the situation as thorough as possible.
> >   
> 
> OK, this is already good hint. The thing with ESP is that there is ?default?
> file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as default for
> *removable* media, fortunately it is usable for hard disks as well, or at
> least in most cases.
> 
> Now, for non-removable media, the UEFI does provide boot manager interface to
> define boot entries, and the fact that renaming efi/redhad directory did
> break the redhat boot, is very loud hint. And this means, this system is
> probably ignoring efi/boot tree on non-removable media and is expecting the
> boot manager entry to be created instead.

This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956 firmware (not
tested on ASRock Z77-Pro4 firmware).

> 
> UEFI boot manager can be configured /usually/ manually via firmware menu, or
> by application, such as efibootmgr. The normal approach is to create
> efi/<vendorname> directory and to copy the application there, then create the
> boot manager configuration.
> 
> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
> 
> What is different in FreeBSD case is that the whole interface to program the
> UEFI Boot Manager is currently being developed, so either it has to be done
> manually or from some other OS (see https://wiki.gentoo.org/wiki/Efibootmgr
> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from
> google:D).

Well, thanks for this important hint! FreeBSD 12-CURRENT's and FreeBSD
11.2-RELENG's USB flash devices are capable of booting off on Fujitsu's ESPRIMO
and ASRock's boards. As a note: after "kldload efirt.ko" I was able to use the
already in FreeBSD present toolset efibootmgr(8) and sibblings (the tools do
not do anything useful when booted non-UEFI).

Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and following
the steps in the examples and having created /efi/freebsd/BOOTx64.efi as
recommended by copy from /efi/boot, let me create a proper boot variable.

To make things sure, I also applied "efibootmgr -a VARIABLENAME".

And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do not know
whether this will also work with FAT12/16, I should test this case, too.

There is a bug in the manpage of efibootmg(8). It does not explain the options
-d and -p, although they could be "implied" by reading carefully. There is now
a PR at 

https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080

for this issue.

So, it's apity that the handbook has no note I could easily find on this; 

Thank you very much for your patience and help!

Kind regards,
Oliver
> 
> rgds,
> toomas
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


From tsoome at me.com  Fri Jul 27 05:54:54 2018
From: tsoome at me.com (Toomas Soome)
Date: Fri, 27 Jul 2018 08:54:48 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>



> On 27 Jul 2018, at 08:46, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Thu, 26 Jul 2018 19:23:43 +0300
> Toomas Soome <tsoome at me.com> wrote:
> 
> (reply inline/at the end)
> 
> 
>>> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
>>> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
>>> <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote: 
>>>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
>>>>>> 
>>>>>> On Wed, 25 Jul 2018 11:46:07 +0300
>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>> 
>>>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>>> 
>>>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>> 
>>>>>>>> 
>>>>>>>> Hello  Toomas Soome,
>>>>>>>> 
>>>>>>>> I CC Allan Jude since I discovered something  weird today regarding the
>>>>>>>> UEFI boot capabilities of USB flash devices and SSDs. See below.
>>>>>>>> 
>>>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>>>>> 
>>>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
>>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>>>> 
>>>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>>> wrote:
>>>>>>>>>>>> 
>>>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>>>>>>>>>>> 
>>>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>>>>>>>>>> Hash: SHA512
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
>>>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>> schrieb:         
>>>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>>>>>>> wrote:
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems on
>>>>>>>>>>>>>>>> GPT drives where the first partition begins at block 40 of the
>>>>>>>>>>>>>>>> hdd/ssd.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> I have two host in private use based on an
>>>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
>>>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
>>>>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013. This
>>>>>>>>>>>>>>>> is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for the Z77
>>>>>>>>>>>>>>>> Pro4 revision 1.8 (2013/7/17). For both boards a BETA revision
>>>>>>>>>>>>>>>> for the Spectre/Meltdown mitigation is available, but I didn't
>>>>>>>>>>>>>>>> test that. But please read.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
>>>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
>>>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via bsdinstall
>>>>>>>>>>>>>>>> the OS using UEFI-only boot method on a GPT partitioned device
>>>>>>>>>>>>>>>> fails. The ASRock boards jump immediately into the firmware,
>>>>>>>>>>>>>>>> the Fujitsu offers some kind of CPU/Memory/HDD test facility.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI boot
>>>>>>>>>>>>>>>> only is implied, the MBR partitioned FreeBSD installation USB
>>>>>>>>>>>>>>>> flash device does boot in UEFI! I guess I can assume this when
>>>>>>>>>>>>>>>> the well known clumsy 80x25 char console suddenly gets bright
>>>>>>>>>>>>>>>> and shiny with a much higher resoltion as long the GPU supports
>>>>>>>>>>>>>>>> EFI GOP. Looking with gpart at the USB flash drives reveals
>>>>>>>>>>>>>>>> that the EFI partition starts at block 1 of the device and the
>>>>>>>>>>>>>>>> device has a MBR layout. I haven't found a way to force the GPT
>>>>>>>>>>>>>>>> scheme, when initialised via gpart, to let the partitions start
>>>>>>>>>>>>>>>> at block 1. This might be a naiv thinking, so please be patient
>>>>>>>>>>>>>>>> with me.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the ASRock
>>>>>>>>>>>>>>>> boards, I tried years ago some LinuxRed Hat and Suse with UEFI
>>>>>>>>>>>>>>>> and that worked - FreeBSD not. I gave up on that that time.
>>>>>>>>>>>>>>>> Now, having the very same issues with a new Fujitsu system,
>>>>>>>>>>>>>>>> leaves me with the impression that FreeBSD's UEFI
>>>>>>>>>>>>>>>> implementation might have problems I'm not aware of.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> Can someone shed some light onto this? 
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
>>>>>>>>>>>>>>> do not support secure boot at all at this time.            
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> Secure boot is in every scenario disabled!
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> If you have efi or bios version running - you can check from
>>>>>>>>>>>>>>> either console variable value (it can have efi or vidconsole or
>>>>>>>>>>>>>>> comconsole) or better yet, see if efi-version is set (show
>>>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
>>>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
>>>>>>>>>>>>>>> paths present, it is uefi:)            
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> What are you talking about?
>>>>>>>>>>>>>> What is the point of entry - running system, loader?
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS - as
>>>>>>>>>>>>>> I'm sure since I've checked that many times. UEFI doesn't work on
>>>>>>>>>>>>>> those systems with FreeBSD. I'm not sure antmore, but I tried
>>>>>>>>>>>>>> also Windows 7 on those mainboards booting via UEFI - and I might
>>>>>>>>>>>>>> recall that they failed also. I also recall that there were
>>>>>>>>>>>>>> issues with earlier UEFI versions regarding booting only Windows
>>>>>>>>>>>>>> 8/8.1 - and nothing else, but the fact that Linux worked confuses
>>>>>>>>>>>>>> me a bit.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work
>>>>>>>>>>>>>> at all - who cares, I intend to purchase new server grade
>>>>>>>>>>>>>> hardware. But the more puzzling issue is with the Fujitsu, which
>>>>>>>>>>>>>> I consider serious and from the behaviour the Fujitsu failure
>>>>>>>>>>>>>> looks exactly like the ASRock - Windows 7 works, RedHat 7.5
>>>>>>>>>>>>>> works (I assume I can trust the Firmware settings when I disable
>>>>>>>>>>>>>> CSM support, that the Firmware will only EFI/UEFI capable
>>>>>>>>>>>>>> loader? Or is there a ghosty override somwhere to be expected?).
>>>>>>>>>>>>>> Also on ASRock disabling CSM should ensure not booting a
>>>>>>>>>>>>>> dual-bootstrap-capable system. This said, on the recent Fujitsu,
>>>>>>>>>>>>>> it seems to boil down to a FreeBSD UEFI-firmware interaction
>>>>>>>>>>>>>> problem, while the ASRock is still under suspicion to be broken
>>>>>>>>>>>>>> by design.           
>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1; this
>>>>>>>>>>>>>>> is because at sector 0 there is MBR (for compatibility), sector
>>>>>>>>>>>>>>> 1 is GPT table and then sectors 2-33 have GPT partition table
>>>>>>>>>>>>>>> entries, so the first possible data sector is 34 (absolute 34).
>>>>>>>>>>>>>>> Thats assuming 512B sectors. For details see UEFI 2.7 Chapter
>>>>>>>>>>>>>>> 5.3.1 page 131.            
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> Thanks for the explanation. That implies the installer did right,
>>>>>>>>>>>>>> gpart did also right and therefore there must be an issue with
>>>>>>>>>>>>>> the stuff located within the EFI partition?           
>>>>>>>>>>>>> 
>>>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
>>>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
>>>>>>>>>>>>> actually caring to read the MBR code and start it, since once the
>>>>>>>>>>>>> MBR code is started, it is all about our code.          
>>>>>>>>>>>> 
>>>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM? or
>>>>>>>>>>>> do you mean that specific portion of the UEFI firmware, which looks
>>>>>>>>>>>> for the proper UEFI partition?
>>>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> BIOS as either native or CSM. Note that from boot code point of view
>>>>>>>>>>> the CSM boot *is* BIOS boot, we have no access to UEFI features.
>>>>>>>>>>> 
>>>>>>>>>>>> 
>>>>>>>>>>>> The boxes in question, most notably the more recent Fujitsu Esprimo
>>>>>>>>>>>> Q956, refuse booting UEFI, even if properly setup (in terms of what
>>>>>>>>>>>> FreeBSD provides on recent CURRENT) is applied and CSM is switched
>>>>>>>>>>>> off in the firmware. Again: GPT partition scheme.
>>>>>>>>>>>> 
>>>>>>>>>>>> The system boots properly if a second partition of type
>>>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
>>>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0 is
>>>>>>>>>>>> the device).           
>>>>>>>>>>>>> 
>>>>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
>>>>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
>>>>>>>>>>>>> prompt:          
>>>>>>>>>>>> 
>>>>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
>>>>>>>>>>>> 
>>>>>>>>>>>> OK lsdev
>>>>>>>>>>>> disk devices:
>>>>>>>>>>>> 	disk0:		BIOS DRIVE C ...
>>>>>>>>>>>> 
>>>>>>>>>>>> 		disk0p1:	EFI
>>>>>>>>>>>> 		disk0p2:	FreeBSD BOOT
>>>>>>>>>>>> 		disk0p3:	FreeBSD SWAP
>>>>>>>>>>>> 		disk0p4:	FreeBSD ZFS
>>>>>>>>>>>> zfs devices:
>>>>>>>>>>>> 	zfs:zroot
>>>>>>>>>>>> 
>>>>>>>>>>>> OK chain disk0
>>>>>>>>>>>> open failed     (so for disk0p{1-4}.
>>>>>>>>>>>> 
>>>>>>>>>>>> OK chain zroot
>>>>>>>>>>>> failed to read disk (just for completeness)          
>>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> chain command does use only device name (such as disk0: or
>>>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
>>>>>>>>>>> ported the code to read the file.        
>>>>>>>>>> 
>>>>>>>>>> ??
>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> the point for chain command test is to see if the normal read and
>>>>>>>>>>> execute would work, so in your case please try:
>>>>>>>>>>> 
>>>>>>>>>>> chain disk0:        
>>>>>>>>>> 
>>>>>>>>>> As stated above, I did so, and the result is also mentioned above, I
>>>>>>>>>> always get "open failed".
>>>>>>>>>> This is the same for 
>>>>>>>>>> 
>>>>>>>>>> chain disk0
>>>>>>>>>> chain disk0p1
>>>>>>>>>> chain disk0p2
>>>>>>>>>> chain disk0p3
>>>>>>>>>> chain disk0p4
>>>>>>>>>> 
>>>>>>>>>> as already said. CSM is enabled in this case.        
>>>>>>>>> 
>>>>>>>>> sigh? chain command does take device as argument, device must always
>>>>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
>>>>>>>>> above, the command should be:
>>>>>>>>> 
>>>>>>>>> chain disk0:
>>>>>>>>> 
>>>>>>>>> The disk0p1: etc will only work when partition boot code was installed
>>>>>>>>> (which you most likely do not have - the only possible candidate could
>>>>>>>>> be FreeBSD ZFS partition).      
>>>>>>>> 
>>>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
>>>>>>>> partition scheme, but with PMBR bootblock installed and freebsd-boot
>>>>>>>> partition conatining gptzfsboot installed.
>>>>>>>> 
>>>>>>>> 
>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
>>>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from disk0p2:
>>>>>>>>>>> and execute it; stage1 would detect FreeBSD ZFS from disk0p4: and
>>>>>>>>>>> load and execute /boot/loader. If that will happen, it means the
>>>>>>>>>>> boot code in our stages is just fine, but the bios (CSM) does not
>>>>>>>>>>> load pmbr?.  if thats true, it would mean that you either need to
>>>>>>>>>>> use UEFI boot or need to have some hack to fool the BIOS or just not
>>>>>>>>>>> use GPT on that machine with CSM.        
>>>>>>>>>> 
>>>>>>>>>> To make it clear here: The only way to boot this box is using CSM (as
>>>>>>>>>> it is the same with the ASRock boards mentioned earlier). But my
>>>>>>>>>> intention is to disable CSM and use a GPT/UEFI environment only! And
>>>>>>>>>> GPT/UEFI doesn't work with FreeBSD, neither with 12-CURRENT, nor
>>>>>>>>>> 11.2-RELENG.
>>>>>>>>>> 
>>>>>>>>>> It would be nice if this could be fixed. I'm more interested in the
>>>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
>>>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
>>>>>>>>>> byproduct, I'd appreciate that.
>>>>>>>>>> 
>>>>>>>>>> Kind regards,
>>>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
>>>>>>>>> that the UEFI boot fails when the first partition starts from sector
>>>>>>>>> 40 - does it mean you have boot when the partition will start from
>>>>>>>>> some other sector? I think, there is something else going on.      
>>>>>>>> 
>>>>>>>> Well, I simply try to describe what I "see" to make things
>>>>>>>> disambiguous. I'm not familiar with the deeper insights of disk layouts
>>>>>>>> on a binary level. So, you explained to me the reason, why ESP (EGI
>>>>>>>> partition) starts at block 40. I compared that to the FreeBSD USB flash
>>>>>>>> image FreeBSD provides, but this is another story since the image uses
>>>>>>>> MBR scheme as I figured out.
>>>>>>>> 
>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> What you can do is to see if that firmware will offer you EFI shell
>>>>>>>>> option, from there you can try to start the bootx64.efi manually and
>>>>>>>>> see what error you will get. However, the number 1 cause for failing
>>>>>>>>> to start the bootloader in UEFI is secure boot - we do not support it
>>>>>>>>> and secure boot must be switched off. 
>>>>>>>>> 
>>>>>>>>> However, they seem to claim "The Secure Boot option is available in
>>>>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is disabled by
>>>>>>>>> default.? 
>>>>>>>>> 
>>>>>>>>> Still suggest to double check if thats really the case. Also, if the
>>>>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
>>>>>>>>> then either there is something in firmware logs or you could get them
>>>>>>>>> from trying to start bootx64.efi from UEFI shell.      
>>>>>>>> 
>>>>>>>> Since I'm with this problem since 2014 and try from time to time, be
>>>>>>>> ausred that I tried every possible permutationof all reasonable
>>>>>>>> options, even those nonsense, to get rid of that problem.
>>>>>>>> 
>>>>>>>> I never had any problems with any other UEFI capable server/workstation
>>>>>>>> firmware so far booting FreeBSD off in UEFI-native (GPT partition
>>>>>>>> scheme, CSM disabled) so far - until now, when I ran into this Fujitsu
>>>>>>>> ESPRIMO Q956 with the most recent firmware (as of lat week, week 29 of
>>>>>>>> 2018) having the very same problems. 
>>>>>>>> 
>>>>>>>> 
>>>>>>>> 
>>>>>>>> I figured out something strange on the Fujitsu - and that is the same
>>>>>>>> with the ASRock boards.
>>>>>>>> 
>>>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
>>>>>>>> appliance, but nevertheless, the USB flash device is booted on Fujitsu
>>>>>>>> servers with UEFI-only configurations. I assume at this point that
>>>>>>>> disabling on the most recent Fujitsu firmwares on reasonable "new"
>>>>>>>> hardware (not older than three years) will disable any(!) legacy BIOS
>>>>>>>> capabilities. The same is assumed for the Fujitus ESPRIMO Q956. I can
>>>>>>>> not speak for the ASRock A77 Pro4/m boards mentioned above/earlier,
>>>>>>>> they are from 2012/2013 and "quite old".
>>>>>>>> 
>>>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition. The
>>>>>>>> partition scheme of the flash device is GPT. The layout looks like
>>>>>>>> this:
>>>>>>>> 
>>>>>>>> gpart show -l da4      
>>>>>>>> =>      40  15425456  da4  GPT  (7.4G)      
>>>>>>>>     40      2000    1  efiboot0  (1.0M)
>>>>>>>>   2040   1453584    3  disk1a  (710M)
>>>>>>>> 1455624      4096    5  disk3  (2.0M)
>>>>>>>> 1459720  13965776       - free -  (6.7G)
>>>>>>>> 
>>>>>>>> I created the flash with md, gpart and dd straightforward, efiboot0 is
>>>>>>>> the ESP partition and its format/content is created via dd
>>>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
>>>>>>>> 
>>>>>>>> This USB flash device boots(!) successfully (UEFI!) on both the ASRock
>>>>>>>> boards and the Esprimo Q956!
>>>>>>>> 
>>>>>>>> But any SSD prepared the same way doesn't. Why? 
>>>>>>>> 
>>>>>>>> On the ASRock, I recall having fiddled around with HDD also for a while
>>>>>>>> conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD - I
>>>>>>>> can't remember. 
>>>>>>>> 
>>>>>>>> In the lack of proper hardware I'm unable to check whether USB-attached
>>>>>>>> HDD or SSD will boot or HDD will boot (just in case the local SATA has
>>>>>>>> problems booting UEFI and USB not).
>>>>>>>> 
>>>>>>>> Kind regards,
>>>>>>>> 
>>>>>>>> Oliver 
>>>>>>>> 
>>>>>>> 
>>>>>>> Am. well. I think the suggestion to test out FAT32 is still good one to
>>>>>>> test. This is because it is known that some vendors do not support
>>>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
>>>>>>> specification does not tell which FAT must be supported, and only hint
>>>>>>> about FAT12/FAT16 in context of removable devices).    
>>>>>> 
>>>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
>>>>>> took me a time to circumvent the installer and I had to install the
>>>>>> system manually. In that strain, I also "tried" to establish the ESP with
>>>>>> FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc help how
>>>>>> to find out the format (FAT12/16/32) of the ESP, so I assume when using
>>>>>> 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and GPT (UEFI)
>>>>>> (only!) the resulting ESP is FAT12 or FAT16 (300mb by default). I also
>>>>>> assume, that when dd'ing the /boo/boot1.efifat image to a partition, the
>>>>>> format is FAT, but not FAT32. Therefore, I refomatted the manually
>>>>>> created ESP (using "gpart add -t efi ...") using "newfs_msdos -F 32 -b
>>>>>> xxx ...". I had to fiddle around a bit with option -b to fit in a proper
>>>>>> format to meet a 512mb ESP - I'm not sure whether this is the proper
>>>>>> option to deal with. When using the default and only -F32, the size of
>>>>>> the partition has to be 4G at least I assume. Having done that, I copied
>>>>>> the the content of boot1.efifat (mdconfig -t vnode ..., I guess we know
>>>>>> the drill ...) to the newly formatted ESP to /boot/efi/ ...
>>>>>> 
>>>>>> Having so far no knowledge of how to asure that the created ESP is FAT32,
>>>>>> I assume it is FAT32.
>>>>>> 
>>>>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
>>>>>> box is not willing to boot from SSD with the ESP prepared as decribed.
>>>>>> So, a chance that this might still be due to a misconfiguration lies now
>>>>>> within the -b option of newfs_msdos - if the -b option is assumed the
>>>>>> proper option?
>>>>>> 
>>>>>> At the moment, the ESP of the Esprimo is subject to changes, if you wish,
>>>>>> but not in size, since it is limited to 512mb.
>>>>>> 
>>>>>> Thanks and kind regards,
>>>>>> 
>>>>>> Oliver    
>>>>> 
>>>>> Yea, i was hoping fstyp command would report the FAT type, but it does not
>>>>> (request for feature?:)    
>>>> 
>>>> FYI, the file(1) command is very good at disecting a disk image to tell
>>>> you what the MBR looks like, and at looking at partitions if pointed at
>>>> them with the -s option.  It should be able to detect FAT12/16/32.
>>>> 
>>>> root at x230a:/home/ISO/x # file -s /dev/md2s1
>>>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ",
>>>> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
>>>> sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS     ",
>>>> FAT (12 bit), followed by FAT
>>>> 
>>>>> 
>>>>> However, the more annoying idea would be to install some OS which will
>>>>> boot with UEFI on this machine, then copy boot1.efi from freebsd to it
>>>>> (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in
>>>>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do
>>>>> not support EFI32.
>>>>> 
>>>>> note that boot1.efi alone will not do much but printing on screen how it
>>>>> will search for freebsd, but for the purpose of the test it would suffice
>>>>> - that would give us confirmed working ESP file system (since the other os
>>>>> would be able to boot) and then we can confirm if boot1.efi itself is
>>>>> OK.    
>>>> 
>>> 
>>> Some new results.
>>> I installed RedHat 7.5 and inestigated the ESP.
>>> 
>>> - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
>>> - size is both 200mb if installed automatically. I forgit to investigate the
>>> FAT format, but this might be unnecessary as shown further in this post.
>>> - RedHat's ESP contains ~ 10 MB of data in two
>>> folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
>>> RedHat's doesn't change anything, also renaming /efi/boot/fbx64.efi of
>>> RedHat's installation. But renaming /efi/redhat renders RedHat to fail the
>>> boot process on the Fujitsu with the signs of the built-in testprogram as
>>> reported.
>>> 
>>> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot only
>>> (CSM in firmware disabled, but there is still a gptzfsboot-prepared
>>> partition for later use, just for the record). Booting UEFI-only fails as
>>> reported. On this installation I copied the RedHat ESP completely into
>>> FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh
>>> and copied FreeBSD's BOOTX64.efi to /efi/boot. 
>>> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
>>> the /efi/redhat folder of the ESP is important, if renamed, the whole
>>> process dies as I reported earlier.
>>> 
>>> Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB
>>> flash booting with CSM disabled (so asumingly UEFI only then) on both
>>> ASRock and Fujitsu (as described in more detail initially and earlier),
>>> while SSDs fail? Is there a difference? Since FreeBSD boots in UEFI mode
>>> from USB flash prepared as described (straight forward, 800k ESP starting
>>> at block 40, the boot1.efifat image dd'ed onto the partition, UFS partition
>>> following, no freebsd-boot partition or MBR/PMBR bootcode applied ever!), I
>>> think BOOTX64.EFI is technically all right. There must be then an issue
>>> with the SATA/SSD/HDD boot pathway.
>>> 
>>> Hope I could provide some more details, sorry if it sounds confusing or way
>>> too long, but I try to descibe the situation as thorough as possible.
>>> 
>> 
>> OK, this is already good hint. The thing with ESP is that there is ?default?
>> file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as default for
>> *removable* media, fortunately it is usable for hard disks as well, or at
>> least in most cases.
>> 
>> Now, for non-removable media, the UEFI does provide boot manager interface to
>> define boot entries, and the fact that renaming efi/redhad directory did
>> break the redhat boot, is very loud hint. And this means, this system is
>> probably ignoring efi/boot tree on non-removable media and is expecting the
>> boot manager entry to be created instead.
> 
> This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956 firmware (not
> tested on ASRock Z77-Pro4 firmware).
> 
>> 
>> UEFI boot manager can be configured /usually/ manually via firmware menu, or
>> by application, such as efibootmgr. The normal approach is to create
>> efi/<vendorname> directory and to copy the application there, then create the
>> boot manager configuration.
>> 
>> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
>> 
>> What is different in FreeBSD case is that the whole interface to program the
>> UEFI Boot Manager is currently being developed, so either it has to be done
>> manually or from some other OS (see https://wiki.gentoo.org/wiki/Efibootmgr
>> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from
>> google:D).
> 
> Well, thanks for this important hint! FreeBSD 12-CURRENT's and FreeBSD
> 11.2-RELENG's USB flash devices are capable of booting off on Fujitsu's ESPRIMO
> and ASRock's boards. As a note: after "kldload efirt.ko" I was able to use the
> already in FreeBSD present toolset efibootmgr(8) and sibblings (the tools do
> not do anything useful when booted non-UEFI).
> 
> Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and following
> the steps in the examples and having created /efi/freebsd/BOOTx64.efi as
> recommended by copy from /efi/boot, let me create a proper boot variable.
> 
> To make things sure, I also applied "efibootmgr -a VARIABLENAME".
> 
> And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do not know
> whether this will also work with FAT12/16, I should test this case, too.
> 
> There is a bug in the manpage of efibootmg(8). It does not explain the options
> -d and -p, although they could be "implied" by reading carefully. There is now
> a PR at 
> 
> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080
> 
> for this issue.
> 
> So, it's apity that the handbook has no note I could easily find on this; 
> 
> Thank you very much for your patience and help!
> 
> Kind regards,
> Oliver

yep, efibootmgr does call UEFI RuntimeServices to set up the variables, and this is only possible when booted UEFI. But glad we finally found the root cause. It would be good to have HW notes for such cases, it is important to know that those systems wont boot UEFI from HDD unless the boot manager setup is done.

rgds,
toomas

From marklmi at yahoo.com  Fri Jul 27 06:29:58 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Thu, 26 Jul 2018 23:29:49 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
 <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
Message-ID: <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>

On 2018-Jul-26, at 9:06 PM, Mark Millard <marklmi at yahoo.com> wrote:

> On 2018-Jul-26, at 6:14 PM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> On 2018-Jul-26, at 11:21 AM, John Baldwin <jhb at freebsd.org> wrote:
>> 
>>> On 7/26/18 10:55 AM, Mark Millard wrote:
>>>> . . .
>>> 
>>> Yes, but the -E from above was when compiled with external GCC and it didn't change
>>> _Atomic(int).  Here's part of the source of bar.c:
>>> 
>>> #include <sys/cdefs.h>
>>> #include <stdatomic.h>
>>> 
>>> struct foo {
>>>      _Atomic(int) one;
>>>      _Atomic int two;
>>>      atomic_int three;
>>> };
>>> 
>>> And here is what that became after -E:
>>> 
>>> # 4 "bar.c"
>>> struct foo {
>>> _Atomic(int) one;
>>> _Atomic int two;
>>> atomic_int three;
>>> };
>>> 
>>> So cdefs.h did not define _Atomic.
>>> 
>>> Ah, if I add '-std=c99' then it does break.  Code that wants to use
>>> C11 atomics via <stdatomic.h> should not be using -std=c99.  Try this:
>>> 
>>> Index: lib/ofed/librdmacm/Makefile
>>> ===================================================================
>>> --- lib/ofed/librdmacm/Makefile (revision 335896)
>>> +++ lib/ofed/librdmacm/Makefile (working copy)
>>> @@ -8,6 +8,7 @@
>>> SHLIB_MAJOR=   1
>>> MK_PROFILE=    no
>>> CFLAGS+=       -I${_spath}
>>> +CSTD=          gnu11
>>> 
>>> SRCS= \
>>> acm.c \
>>> 
>>> If this works then we should probably mark OFED as a BROKEN_OPTION when
>>> building with ancient GCC for now as well.
>> 
>> I've "unreverted" to set up a context for testing this.
>> 
>> So far I'll I've done is to test that I can still reproduce the failure
>> in my environment, same sort of error reports as ci.freebsd.org's
>> FreeBSD-head-amd64-gcc . This is without your patch.
>> 
>> But I've done this with gcc being given -v so that I've the exact commands
>> and search order and the like. It  does show: -std=gnu99 . I list the
>> filemon data from the .meta as well, showing the exact mix of
>> FreeBSD and gcc headers used. (I could also provide such for with
>> the reverted Makefile.{inc1,libcompat} [so non-failing] build if you
>> care.)
>> 
>> 
>> For now I just report the failure *without your patch*:
>> (I'll build again with your patch next.)
>> 
>> . . .
>> --- all_subdir_lib/ofed ---
>> Building /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o
>> --- acm.o ---
>> Using built-in specs.
>> COLLECT_GCC=/usr/local/bin/x86_64-unknown-freebsd12.0-gcc
>> Target: x86_64-unknown-freebsd12.0
>> Configured with: /wrkdirs/usr/ports/devel/amd64-gcc/work/gcc-6.4.0/configure --target=x86_64-unknown-freebsd12.0 --disable-nls --enable-languages=c,c++ --enable-gnu-indirect-function --without-headers --with-gmp=/usr/local --with-pkgversion='FreeBSD Ports Collection for amd64' --with-system-zlib --with-gxx-include-dir=/usr/include/c++/v1/ --with-sysroot=/ --with-as=/usr/local/bin/x86_64-unknown-freebsd12.0-as --with-ld=/usr/local/bin/x86_64-unknown-freebsd12.0-ld --enable-initfini-array --prefix=/usr/local --localstatedir=/var --mandir=/usr/local/man --infodir=/usr/local/info/ --build=x86_64-unknown-freebsd12.0
>> Thread model: posix
>> gcc version 6.4.0 (FreeBSD Ports Collection for amd64) 
>> COLLECT_GCC_OPTIONS='-B' '/usr/local/x86_64-unknown-freebsd12.0/bin/' '-O2' '-pipe' '-I' '/usr/src/contrib/ofed/librdmacm' '-g' '-std=gnu99' '-fstack-protector-strong' '-Wno-error=address' '-Wno-error=array-bounds' '-Wno-error=attributes' '-Wno-error=bool-compare' '-Wno-error=cast-align' '-Wno-error=clobbered' '-Wno-error=enum-compare' '-Wno-error=extra' '-Wno-error=inline' '-Wno-error=logical-not-parentheses' '-Wno-error=strict-aliasing' '-Wno-error=uninitialized' '-Wno-error=unused-but-set-variable' '-Wno-error=unused-function' '-Wno-error=unused-value' '-Wno-error=misleading-indentation' '-Wno-error=nonnull-compare' '-Wno-error=shift-negative-value' '-Wno-error=tautological-compare' '-Wno-error=unused-const-variable' '-v' '-c' '-o' 'acm.o' '-mtune=generic' '-march=x86-64'
>> /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1 -quiet -v -I /usr/src/contrib/ofed/librdmacm -isysroot /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp /usr/src/contrib/ofed/librdmacm/acm.c -quiet -dumpbase acm.c -mtune=generic -march=x86-64 -auxbase-strip acm.o -g -O2 -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable -std=gnu99 -version -fstack-protector-strong -o - |
>> /usr/local/bin/x86_64-unknown-freebsd12.0-as -v -I /usr/src/contrib/ofed/librdmacm -o acm.o
>> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
>> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
>> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
>> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include-fixed"
>> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/../../../../x86_64-unknown-freebsd12.0/include"
>> #include "..." search starts here:
>> #include <...> search starts here:
>> /usr/src/contrib/ofed/librdmacm
>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include
>> /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include
>> End of search list.
>> GNU assembler version 2.30 (x86_64-unknown-freebsd12.0) using BFD version (GNU Binutils) 2.30
>> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
>> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
>> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
>> Compiler executable checksum: 0b55436e4202650149cc2feb351f4e0e
>> In file included from /usr/src/contrib/ofed/librdmacm/cma.h:43:0,
>>                from /usr/src/contrib/ofed/librdmacm/acm.c:42:
>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>> /usr/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>> atomic_store(&lock->cnt, 0);
>> ^
>> In file included from /usr/src/contrib/ofed/librdmacm/acm.c:42:0:
>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>> /usr/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>> ^~
>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>> /usr/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>> ^~
>> *** [acm.o] Error code 1
>> 
>> make[6]: stopped in /usr/src/lib/ofed/librdmacm
>> .ERROR_TARGET='acm.o'
>> .ERROR_META_FILE='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta'
>> .MAKE.LEVEL='6'
>> MAKEFILE=''
>> .MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
>> _ERROR_CMD='/usr/local/bin/x86_64-unknown-freebsd12.0-gcc --sysroot=/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp -B/usr/local/x86_64-unknown-freebsd12.0/bin/  -O2 -pipe -I/usr/src/contrib/ofed/librdmacm   -g -std=gnu99 -fstack-protector-strong -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable   -v  -c /usr/src/contrib/ofed/librdmacm/acm.c -o acm.o; ;'
>> .CURDIR='/usr/src/lib/ofed/librdmacm'
>> .MAKE='make'
>> .OBJDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm'
>> .TARGETS='all'
>> DESTDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp'
>> LD_LIBRARY_PATH=''
>> MACHINE='amd64'
>> MACHINE_ARCH='amd64'
>> MAKEOBJDIRPREFIX=''
>> MAKESYSPATH='/usr/src/share/mk'
>> MAKE_VERSION='20180512'
>> PATH='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
>> SRCTOP='/usr/src'
>> OBJTOP='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64'
>> .MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.amd64-xtoolchain-gcc.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/lib/ofed/librdmacm/Makefile /usr/src/share/mk/bsd.lib.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/lib/ofed/librdmacm/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/share/mk/bsd.libnames.mk /usr/src/share/mk/src.libnames.mk /usr/src/share/mk/src.opts.mk /usr/src/share/mk/bsd.symver.mk /usr/src/share/mk/bsd.nls.mk /usr/src/share/mk/bsd.confs.mk /usr/src/share/mk/bsd.files.mk /usr/src/share/mk/bsd.dirs.mk /usr/src/share/mk/bsd.incs.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/share/mk/bsd.sys.mk'
>> .PATH='. /usr/src/lib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm/man'
>> 1 error
>> 
>> From /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta
>> is the filemon data:
>> 
>> -- filemon acquired metadata --
>> # filemon version 5
>> # Target pid 95011
>> # Start 1532652684.414953
>> V 5
>> E 95033 /bin/sh
>> R 95033 /etc/libmap.conf
>> R 95033 /var/run/ld-elf.so.hints
>> R 95033 /lib/libedit.so.7
>> R 95033 /lib/libc.so.7
>> R 95033 /lib/libncursesw.so.8
>> F 95033 95034
>> E 95034 /usr/local/bin/x86_64-unknown-freebsd12.0-gcc
>> R 95034 /etc/libmap.conf
>> R 95034 /var/run/ld-elf.so.hints
>> R 95034 /usr/lib/libc++.so.1
>> R 95034 /lib/libcxxrt.so.1
>> R 95034 /lib/libm.so.5
>> R 95034 /lib/libc.so.7
>> R 95034 /lib/libgcc_s.so.1
>> F 95034 95035
>> E 95035 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1
>> F 95034 95036
>> R 95035 /etc/libmap.conf
>> R 95035 /var/run/ld-elf.so.hints
>> R 95035 /usr/local/lib/libmpc.so.3
>> R 95035 /usr/local/lib/libmpfr.so.6
>> R 95035 /usr/local/lib/libgmp.so.10
>> R 95035 /lib/libz.so.6
>> R 95035 /usr/lib/libc++.so.1
>> R 95035 /lib/libcxxrt.so.1
>> R 95035 /lib/libm.so.5
>> R 95035 /lib/libc.so.7
>> R 95035 /lib/libgcc_s.so.1
>> R 95035 /dev/urandom
>> R 95035 /usr/src/contrib/ofed/librdmacm/acm.c
>> E 95036 /usr/local/bin/x86_64-unknown-freebsd12.0-as
>> R 95036 /etc/libmap.conf
>> R 95036 /var/run/ld-elf.so.hints
>> R 95036 /lib/libc.so.7
>> R 95036 acm.o
>> W 95036 acm.o
>> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdio.h
>> R 95035 /usr/src/sys/sys/cdefs.h
>> R 95035 /usr/src/sys/sys/_null.h
>> R 95035 /usr/src/sys/sys/_types.h
>> R 95035 /usr/src/sys/amd64/include/_types.h
>> R 95035 /usr/src/sys/x86/include/_types.h
>> R 95035 /usr/src/sys/amd64/include/_limits.h
>> R 95035 /usr/src/sys/x86/include/_limits.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/inttypes.h
>> R 95035 /usr/src/sys/amd64/include/_inttypes.h
>> R 95035 /usr/src/sys/x86/include/_inttypes.h
>> R 95035 /usr/src/sys/sys/stdint.h
>> R 95035 /usr/src/sys/amd64/include/_stdint.h
>> R 95035 /usr/src/sys/x86/include/_stdint.h
>> R 95035 /usr/src/sys/amd64/include/_limits.h
>> R 95035 /usr/src/sys/sys/_stdint.h
>> R 95035 /usr/src/sys/sys/types.h
>> R 95035 /usr/src/sys/amd64/include/endian.h
>> R 95035 /usr/src/sys/x86/include/endian.h
>> R 95035 /usr/src/sys/sys/_pthreadtypes.h
>> R 95035 /usr/src/sys/sys/select.h
>> R 95035 /usr/src/sys/sys/_sigset.h
>> R 95035 /usr/src/sys/sys/_timeval.h
>> R 95035 /usr/src/sys/sys/timespec.h
>> R 95035 /usr/src/sys/sys/_timespec.h
>> R 95035 /usr/src/sys/sys/socket.h
>> R 95035 /usr/src/sys/sys/_iovec.h
>> R 95035 /usr/src/sys/amd64/include/_align.h
>> R 95035 /usr/src/sys/x86/include/_align.h
>> R 95035 /usr/src/sys/sys/_sockaddr_storage.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/netdb.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/unistd.h
>> R 95035 /usr/src/sys/sys/unistd.h
>> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
>> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdlib.h
>> R 95035 /usr/src/sys/sys/errno.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/endian.h
>> R 95035 /usr/src/sys/sys/endian.h
>> R 95035 /usr/src/sys/amd64/include/endian.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/semaphore.h
>> R 95035 /usr/src/sys/sys/_umtx.h
>> R 95035 /usr/src/sys/amd64/include/_limits.h
>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/rdma/rdma_cma.h
>> R 95035 /usr/src/sys/netinet/in.h
>> R 95035 /usr/src/sys/amd64/include/endian.h
>> R 95035 /usr/src/sys/netinet6/in6.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/verbs.h
>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
>> R 95035 /usr/src/sys/sys/stdint.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/pthread.h
>> R 95035 /usr/src/sys/amd64/include/_limits.h
>> R 95035 /usr/src/sys/amd64/include/_types.h
>> R 95035 /usr/src/sys/sys/sched.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/time.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_time.h
>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/string.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/strings.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_strings.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_string.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/types.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/sa.h
>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/ib.h
>> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
>> X 95036 0 0
>> X 95035 1 0
>> D 95034 acm.o
>> X 95034 1 0
>> X 95033 1 0
>> # Stop 1532652684.494688
>> # Bye bye
>> 
>> 
>> 
>> For reference the amd64-gcc is:
>> 
>> # pkg info amd64-gcc
>> amd64-gcc-6.4.0_1
>> Name           : amd64-gcc
>> Version        : 6.4.0_1
>> Installed on   : Sun Jul 15 09:15:38 2018 PDT
>> Origin         : devel/amd64-gcc
>> Architecture   : FreeBSD:12:amd64
>> Prefix         : /usr/local
>> Categories     : devel
>> Licenses       : GPLv3, GPLv3RLE
>> Maintainer     : kan at FreeBSD.org
>> WWW            : http://gcc.gnu.org/
>> Comment        : Cross GNU Compiler Collection for amd64
>> Shared Libs required:
>> 	libmpc.so.3
>> 	libgmp.so.10
>> 	libmpfr.so.6
>> Shared Libs provided:
>> 	liblto_plugin.so.0
>> Annotations    :
>> 	FreeBSD_version: 1200069
>> 	repo_type      : binary
>> 	repository     : custom
>> Flat size      : 338MiB
>> Description    :
>> GCC, the GNU Compiler Collection supporting C and C++ for targetting crossbuilding.
>> 
>> WWW: http://gcc.gnu.org/
> 
> With your patch it gets past that point of build failure.
> 
> But my devel/amd64-gcc predates the removal of float.h from
> the installed devel/amd64-gcc so the following may not be as
> it would be in such a context:
> 
> --- lib/msun__L ---
> /usr/src/lib/msun/src/catrigl.c:90:2: error: #error "Unsupported long double format"
> #error "Unsupported long double format"
>  ^~~~~
> . . .
> --- lib/msun__L ---
> /usr/src/lib/msun/src/catrigl.c: In function 'casinhl':
> /usr/src/lib/msun/src/catrigl.c:190:35: error: 'm_ln2' undeclared (first use in this function)
>    w = clog_for_large_values(z) + m_ln2;
>                                   ^~~~~
> /usr/src/lib/msun/src/catrigl.c:190:35: note: each undeclared identifier is reported only once for each function it appears in
> /usr/src/lib/msun/src/catrigl.c:202:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
>  if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
>           ^~~~~~~~~~~~~~
> /usr/src/lib/msun/src/catrigl.c: In function 'cacosl':
> /usr/src/lib/msun/src/catrigl.c:250:20: error: 'm_ln2' undeclared (first use in this function)
>   ry = creall(w) + m_ln2;
>                    ^~~~~
> /usr/src/lib/msun/src/catrigl.c:261:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
>  if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
>           ^~~~~~~~~~~~~~
> In file included from /usr/src/lib/msun/src/catrigl.c:45:0:
> 
> 
> 
> I can remove float.h and see what happens.

While the build without gcc's float.h goes on, here are some small
experiments with interesting results (mostly these are with
-std=gnu11):

# more AtomicTest.c 
// x86_64-unknown-freebsd12.0-gcc -v -E AtomicTest.c

#include <sys/cdefs.h>
#include <stdatomic.h>

struct foo {
       _Atomic(int) one;
       _Atomic int two;
       atomic_int three;
};



# x86_64-unknown-freebsd12.0-gcc -dM -std=gnu11 -E AtomicTest.c | grep has_
#define __has_include(STR) __has_include__(STR)
#define __has_include_next(STR) __has_include_next__(STR)
#define __has_extension __has_feature
#define __has_builtin(x) 0
#define __has_feature(x) 0

(-std=gnu99 matches the above)


# x86_64-unknown-freebsd12.0-gcc -dM -std=gnu11 -E AtomicTest.c | grep atomic_fetch
#define atomic_fetch_or(PTR,VAL) __atomic_fetch_or ((PTR), (VAL), __ATOMIC_SEQ_CST)
#define atomic_fetch_or_explicit(PTR,VAL,MO) __atomic_fetch_or ((PTR), (VAL), (MO))
#define atomic_fetch_and_explicit(PTR,VAL,MO) __atomic_fetch_and ((PTR), (VAL), (MO))
#define atomic_fetch_sub_explicit(PTR,VAL,MO) __atomic_fetch_sub ((PTR), (VAL), (MO))
#define atomic_fetch_xor_explicit(PTR,VAL,MO) __atomic_fetch_xor ((PTR), (VAL), (MO))
#define atomic_fetch_add(PTR,VAL) __atomic_fetch_add ((PTR), (VAL), __ATOMIC_SEQ_CST)
#define atomic_fetch_sub(PTR,VAL) __atomic_fetch_sub ((PTR), (VAL), __ATOMIC_SEQ_CST)
#define atomic_fetch_and(PTR,VAL) __atomic_fetch_and ((PTR), (VAL), __ATOMIC_SEQ_CST)
#define atomic_fetch_xor(PTR,VAL) __atomic_fetch_xor ((PTR), (VAL), __ATOMIC_SEQ_CST)
#define atomic_fetch_add_explicit(PTR,VAL,MO) __atomic_fetch_add ((PTR), (VAL), (MO))

(-std=gnu99 matches the above)


The following shows -std=gnu99 vs. -std=gnu11 results that do not
match:

# x86_64-unknown-freebsd12.0-gcc -E -std=gnu99 AtomicTest.c | more
. . .
# 6 "AtomicTest.c"
struct foo {
       
# 7 "AtomicTest.c" 3 4
      struct { 
# 7 "AtomicTest.c"
      int 
# 7 "AtomicTest.c" 3 4
      volatile __val; } 
# 7 "AtomicTest.c"
                   one;
       _Atomic int two;
       atomic_int three;
};
. . .

# x86_64-unknown-freebsd12.0-gcc -E -std=gnu11 AtomicTest.c | more
. . .

# 6 "AtomicTest.c"
struct foo {
       _Atomic(int) one;
       _Atomic int two;
       atomic_int three;
};
. . .

I will add a #warning where FreeBSD's cdefs.h has the #define _Atomic(T)
to report on if the #define _Atomic(T) is being processed (but possibly
ignored) for -std=gnu11 . (But after the ongoing build stops.)



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From marklmi at yahoo.com  Fri Jul 27 07:12:17 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Fri, 27 Jul 2018 00:12:06 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
 <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
 <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>
Message-ID: <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>

On 2018-Jul-26, at 11:29 PM, Mark Millard <marklmi at yahoo.com> wrote:

> On 2018-Jul-26, at 9:06 PM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> On 2018-Jul-26, at 6:14 PM, Mark Millard <marklmi at yahoo.com> wrote:
>> 
>>> On 2018-Jul-26, at 11:21 AM, John Baldwin <jhb at freebsd.org> wrote:
>>> 
>>>> On 7/26/18 10:55 AM, Mark Millard wrote:
>>>>> . . .
>>>> 
>>>> Yes, but the -E from above was when compiled with external GCC and it didn't change
>>>> _Atomic(int).  Here's part of the source of bar.c:
>>>> 
>>>> #include <sys/cdefs.h>
>>>> #include <stdatomic.h>
>>>> 
>>>> struct foo {
>>>>     _Atomic(int) one;
>>>>     _Atomic int two;
>>>>     atomic_int three;
>>>> };
>>>> 
>>>> And here is what that became after -E:
>>>> 
>>>> # 4 "bar.c"
>>>> struct foo {
>>>> _Atomic(int) one;
>>>> _Atomic int two;
>>>> atomic_int three;
>>>> };
>>>> 
>>>> So cdefs.h did not define _Atomic.
>>>> 
>>>> Ah, if I add '-std=c99' then it does break.  Code that wants to use
>>>> C11 atomics via <stdatomic.h> should not be using -std=c99.  Try this:
>>>> 
>>>> Index: lib/ofed/librdmacm/Makefile
>>>> ===================================================================
>>>> --- lib/ofed/librdmacm/Makefile (revision 335896)
>>>> +++ lib/ofed/librdmacm/Makefile (working copy)
>>>> @@ -8,6 +8,7 @@
>>>> SHLIB_MAJOR=   1
>>>> MK_PROFILE=    no
>>>> CFLAGS+=       -I${_spath}
>>>> +CSTD=          gnu11
>>>> 
>>>> SRCS= \
>>>> acm.c \
>>>> 
>>>> If this works then we should probably mark OFED as a BROKEN_OPTION when
>>>> building with ancient GCC for now as well.
>>> 
>>> I've "unreverted" to set up a context for testing this.
>>> 
>>> So far I'll I've done is to test that I can still reproduce the failure
>>> in my environment, same sort of error reports as ci.freebsd.org's
>>> FreeBSD-head-amd64-gcc . This is without your patch.
>>> 
>>> But I've done this with gcc being given -v so that I've the exact commands
>>> and search order and the like. It  does show: -std=gnu99 . I list the
>>> filemon data from the .meta as well, showing the exact mix of
>>> FreeBSD and gcc headers used. (I could also provide such for with
>>> the reverted Makefile.{inc1,libcompat} [so non-failing] build if you
>>> care.)
>>> 
>>> 
>>> For now I just report the failure *without your patch*:
>>> (I'll build again with your patch next.)
>>> 
>>> . . .
>>> --- all_subdir_lib/ofed ---
>>> Building /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o
>>> --- acm.o ---
>>> Using built-in specs.
>>> COLLECT_GCC=/usr/local/bin/x86_64-unknown-freebsd12.0-gcc
>>> Target: x86_64-unknown-freebsd12.0
>>> Configured with: /wrkdirs/usr/ports/devel/amd64-gcc/work/gcc-6.4.0/configure --target=x86_64-unknown-freebsd12.0 --disable-nls --enable-languages=c,c++ --enable-gnu-indirect-function --without-headers --with-gmp=/usr/local --with-pkgversion='FreeBSD Ports Collection for amd64' --with-system-zlib --with-gxx-include-dir=/usr/include/c++/v1/ --with-sysroot=/ --with-as=/usr/local/bin/x86_64-unknown-freebsd12.0-as --with-ld=/usr/local/bin/x86_64-unknown-freebsd12.0-ld --enable-initfini-array --prefix=/usr/local --localstatedir=/var --mandir=/usr/local/man --infodir=/usr/local/info/ --build=x86_64-unknown-freebsd12.0
>>> Thread model: posix
>>> gcc version 6.4.0 (FreeBSD Ports Collection for amd64) 
>>> COLLECT_GCC_OPTIONS='-B' '/usr/local/x86_64-unknown-freebsd12.0/bin/' '-O2' '-pipe' '-I' '/usr/src/contrib/ofed/librdmacm' '-g' '-std=gnu99' '-fstack-protector-strong' '-Wno-error=address' '-Wno-error=array-bounds' '-Wno-error=attributes' '-Wno-error=bool-compare' '-Wno-error=cast-align' '-Wno-error=clobbered' '-Wno-error=enum-compare' '-Wno-error=extra' '-Wno-error=inline' '-Wno-error=logical-not-parentheses' '-Wno-error=strict-aliasing' '-Wno-error=uninitialized' '-Wno-error=unused-but-set-variable' '-Wno-error=unused-function' '-Wno-error=unused-value' '-Wno-error=misleading-indentation' '-Wno-error=nonnull-compare' '-Wno-error=shift-negative-value' '-Wno-error=tautological-compare' '-Wno-error=unused-const-variable' '-v' '-c' '-o' 'acm.o' '-mtune=generic' '-march=x86-64'
>>> /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1 -quiet -v -I /usr/src/contrib/ofed/librdmacm -isysroot /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp /usr/src/contrib/ofed/librdmacm/acm.c -quiet -dumpbase acm.c -mtune=generic -march=x86-64 -auxbase-strip acm.o -g -O2 -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable -std=gnu99 -version -fstack-protector-strong -o - |
>>> /usr/local/bin/x86_64-unknown-freebsd12.0-as -v -I /usr/src/contrib/ofed/librdmacm -o acm.o
>>> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
>>> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
>>> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
>>> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include-fixed"
>>> ignoring nonexistent directory "/usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/../../../../x86_64-unknown-freebsd12.0/include"
>>> #include "..." search starts here:
>>> #include <...> search starts here:
>>> /usr/src/contrib/ofed/librdmacm
>>> /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include
>>> /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include
>>> End of search list.
>>> GNU assembler version 2.30 (x86_64-unknown-freebsd12.0) using BFD version (GNU Binutils) 2.30
>>> GNU C99 (FreeBSD Ports Collection for amd64) version 6.4.0 (x86_64-unknown-freebsd12.0)
>>> 	compiled by GNU C version 4.2.1 Compatible FreeBSD Clang 6.0.0 (tags/RELEASE_600/final 326565), GMP version 6.1.2, MPFR version 4.0.1, MPC version 1.1.0, isl version none
>>> GGC heuristics: --param ggc-min-expand=100 --param ggc-min-heapsize=131072
>>> Compiler executable checksum: 0b55436e4202650149cc2feb351f4e0e
>>> In file included from /usr/src/contrib/ofed/librdmacm/cma.h:43:0,
>>>               from /usr/src/contrib/ofed/librdmacm/acm.c:42:
>>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_init':
>>> /usr/src/contrib/ofed/librdmacm/cma.h:60:2: error: invalid initializer
>>> atomic_store(&lock->cnt, 0);
>>> ^
>>> In file included from /usr/src/contrib/ofed/librdmacm/acm.c:42:0:
>>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_acquire':
>>> /usr/src/contrib/ofed/librdmacm/cma.h:68:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_add'
>>> if (atomic_fetch_add(&lock->cnt, 1) > 0)
>>> ^~
>>> /usr/src/contrib/ofed/librdmacm/cma.h: In function 'fastlock_release':
>>> /usr/src/contrib/ofed/librdmacm/cma.h:73:2: error: operand type 'struct <anonymous> *' is incompatible with argument 1 of '__atomic_fetch_sub'
>>> if (atomic_fetch_sub(&lock->cnt, 1) > 1)
>>> ^~
>>> *** [acm.o] Error code 1
>>> 
>>> make[6]: stopped in /usr/src/lib/ofed/librdmacm
>>> .ERROR_TARGET='acm.o'
>>> .ERROR_META_FILE='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta'
>>> .MAKE.LEVEL='6'
>>> MAKEFILE=''
>>> .MAKE.MODE='meta missing-filemon=yes missing-meta=yes silent=yes verbose'
>>> _ERROR_CMD='/usr/local/bin/x86_64-unknown-freebsd12.0-gcc --sysroot=/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp -B/usr/local/x86_64-unknown-freebsd12.0/bin/  -O2 -pipe -I/usr/src/contrib/ofed/librdmacm   -g -std=gnu99 -fstack-protector-strong -Wno-error=address -Wno-error=array-bounds -Wno-error=attributes -Wno-error=bool-compare -Wno-error=cast-align -Wno-error=clobbered -Wno-error=enum-compare -Wno-error=extra -Wno-error=inline -Wno-error=logical-not-parentheses -Wno-error=strict-aliasing -Wno-error=uninitialized -Wno-error=unused-but-set-variable -Wno-error=unused-function -Wno-error=unused-value -Wno-error=misleading-indentation -Wno-error=nonnull-compare -Wno-error=shift-negative-value -Wno-error=tautological-compare -Wno-error=unused-const-variable   -v  -c /usr/src/contrib/ofed/librdmacm/acm.c -o acm.o; ;'
>>> .CURDIR='/usr/src/lib/ofed/librdmacm'
>>> .MAKE='make'
>>> .OBJDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm'
>>> .TARGETS='all'
>>> DESTDIR='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp'
>>> LD_LIBRARY_PATH=''
>>> MACHINE='amd64'
>>> MACHINE_ARCH='amd64'
>>> MAKEOBJDIRPREFIX=''
>>> MAKESYSPATH='/usr/src/share/mk'
>>> MAKE_VERSION='20180512'
>>> PATH='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/usr/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/legacy/bin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/sbin:/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/bin:/sbin:/bin:/usr/sbin:/usr/bin'
>>> SRCTOP='/usr/src'
>>> OBJTOP='/usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64'
>>> .MAKE.MAKEFILES='/usr/src/share/mk/sys.mk /usr/src/share/mk/local.sys.env.mk /usr/src/share/mk/src.sys.env.mk /root/src.configs/src.conf.amd64-xtoolchain-gcc.amd64-host /usr/src/share/mk/bsd.mkopt.mk /usr/src/share/mk/src.sys.obj.mk /usr/src/share/mk/auto.obj.mk /usr/src/share/mk/bsd.suffixes.mk /root/src.configs/make.conf /usr/src/share/mk/local.sys.mk /usr/src/share/mk/src.sys.mk /dev/null /usr/src/lib/ofed/librdmacm/Makefile /usr/src/share/mk/bsd.lib.mk /usr/src/share/mk/bsd.init.mk /usr/src/share/mk/bsd.opts.mk /usr/src/share/mk/bsd.cpu.mk /usr/src/share/mk/local.init.mk /usr/src/share/mk/src.init.mk /usr/src/lib/ofed/librdmacm/../Makefile.inc /usr/src/share/mk/bsd.own.mk /usr/src/share/mk/bsd.compiler.mk /usr/src/share/mk/bsd.linker.mk /usr/src/share/mk/bsd.libnames.mk /usr/src/share/mk/src.libnames.mk /usr/src/share/mk/src.opts.mk /usr/src/share/mk/bsd.symver.mk /usr/src/share/mk/bsd.nls.mk /usr/src/share/mk/bsd.confs.mk /usr/src/share/mk/bsd.files.mk /usr/src/share/mk/bsd.dirs.mk /usr/src/share/mk/bsd.incs.mk /usr/src/share/mk/bsd.links.mk /usr/src/share/mk/bsd.dep.mk /usr/src/share/mk/bsd.clang-analyze.mk /usr/src/share/mk/bsd.obj.mk /usr/src/share/mk/bsd.subdir.mk /usr/src/share/mk/bsd.sys.mk'
>>> .PATH='. /usr/src/lib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm /usr/src/contrib/ofed/librdmacm/man'
>>> 1 error
>>> 
>>> From /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/lib/ofed/librdmacm/acm.o.meta
>>> is the filemon data:
>>> 
>>> -- filemon acquired metadata --
>>> # filemon version 5
>>> # Target pid 95011
>>> # Start 1532652684.414953
>>> V 5
>>> E 95033 /bin/sh
>>> R 95033 /etc/libmap.conf
>>> R 95033 /var/run/ld-elf.so.hints
>>> R 95033 /lib/libedit.so.7
>>> R 95033 /lib/libc.so.7
>>> R 95033 /lib/libncursesw.so.8
>>> F 95033 95034
>>> E 95034 /usr/local/bin/x86_64-unknown-freebsd12.0-gcc
>>> R 95034 /etc/libmap.conf
>>> R 95034 /var/run/ld-elf.so.hints
>>> R 95034 /usr/lib/libc++.so.1
>>> R 95034 /lib/libcxxrt.so.1
>>> R 95034 /lib/libm.so.5
>>> R 95034 /lib/libc.so.7
>>> R 95034 /lib/libgcc_s.so.1
>>> F 95034 95035
>>> E 95035 /usr/local/libexec/gcc/x86_64-unknown-freebsd12.0/6.4.0/cc1
>>> F 95034 95036
>>> R 95035 /etc/libmap.conf
>>> R 95035 /var/run/ld-elf.so.hints
>>> R 95035 /usr/local/lib/libmpc.so.3
>>> R 95035 /usr/local/lib/libmpfr.so.6
>>> R 95035 /usr/local/lib/libgmp.so.10
>>> R 95035 /lib/libz.so.6
>>> R 95035 /usr/lib/libc++.so.1
>>> R 95035 /lib/libcxxrt.so.1
>>> R 95035 /lib/libm.so.5
>>> R 95035 /lib/libc.so.7
>>> R 95035 /lib/libgcc_s.so.1
>>> R 95035 /dev/urandom
>>> R 95035 /usr/src/contrib/ofed/librdmacm/acm.c
>>> E 95036 /usr/local/bin/x86_64-unknown-freebsd12.0-as
>>> R 95036 /etc/libmap.conf
>>> R 95036 /var/run/ld-elf.so.hints
>>> R 95036 /lib/libc.so.7
>>> R 95036 acm.o
>>> W 95036 acm.o
>>> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdio.h
>>> R 95035 /usr/src/sys/sys/cdefs.h
>>> R 95035 /usr/src/sys/sys/_null.h
>>> R 95035 /usr/src/sys/sys/_types.h
>>> R 95035 /usr/src/sys/amd64/include/_types.h
>>> R 95035 /usr/src/sys/x86/include/_types.h
>>> R 95035 /usr/src/sys/amd64/include/_limits.h
>>> R 95035 /usr/src/sys/x86/include/_limits.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/inttypes.h
>>> R 95035 /usr/src/sys/amd64/include/_inttypes.h
>>> R 95035 /usr/src/sys/x86/include/_inttypes.h
>>> R 95035 /usr/src/sys/sys/stdint.h
>>> R 95035 /usr/src/sys/amd64/include/_stdint.h
>>> R 95035 /usr/src/sys/x86/include/_stdint.h
>>> R 95035 /usr/src/sys/amd64/include/_limits.h
>>> R 95035 /usr/src/sys/sys/_stdint.h
>>> R 95035 /usr/src/sys/sys/types.h
>>> R 95035 /usr/src/sys/amd64/include/endian.h
>>> R 95035 /usr/src/sys/x86/include/endian.h
>>> R 95035 /usr/src/sys/sys/_pthreadtypes.h
>>> R 95035 /usr/src/sys/sys/select.h
>>> R 95035 /usr/src/sys/sys/_sigset.h
>>> R 95035 /usr/src/sys/sys/_timeval.h
>>> R 95035 /usr/src/sys/sys/timespec.h
>>> R 95035 /usr/src/sys/sys/_timespec.h
>>> R 95035 /usr/src/sys/sys/socket.h
>>> R 95035 /usr/src/sys/sys/_iovec.h
>>> R 95035 /usr/src/sys/amd64/include/_align.h
>>> R 95035 /usr/src/sys/x86/include/_align.h
>>> R 95035 /usr/src/sys/sys/_sockaddr_storage.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/netdb.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/unistd.h
>>> R 95035 /usr/src/sys/sys/unistd.h
>>> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
>>> R 95035 /usr/src/contrib/ofed/librdmacm/config.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/stdlib.h
>>> R 95035 /usr/src/sys/sys/errno.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/endian.h
>>> R 95035 /usr/src/sys/sys/endian.h
>>> R 95035 /usr/src/sys/amd64/include/endian.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/semaphore.h
>>> R 95035 /usr/src/sys/sys/_umtx.h
>>> R 95035 /usr/src/sys/amd64/include/_limits.h
>>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/rdma/rdma_cma.h
>>> R 95035 /usr/src/sys/netinet/in.h
>>> R 95035 /usr/src/sys/amd64/include/endian.h
>>> R 95035 /usr/src/sys/netinet6/in6.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/verbs.h
>>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
>>> R 95035 /usr/src/sys/sys/stdint.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/pthread.h
>>> R 95035 /usr/src/sys/amd64/include/_limits.h
>>> R 95035 /usr/src/sys/amd64/include/_types.h
>>> R 95035 /usr/src/sys/sys/sched.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/time.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_time.h
>>> R 95035 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/string.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/strings.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_strings.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/xlocale/_string.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/types.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/sa.h
>>> R 95035 /usr/obj/amd64_xtoolchain-gcc/amd64.amd64/usr/src/amd64.amd64/tmp/usr/include/infiniband/ib.h
>>> R 95035 /usr/src/contrib/ofed/librdmacm/cma.h
>>> X 95036 0 0
>>> X 95035 1 0
>>> D 95034 acm.o
>>> X 95034 1 0
>>> X 95033 1 0
>>> # Stop 1532652684.494688
>>> # Bye bye
>>> 
>>> 
>>> 
>>> For reference the amd64-gcc is:
>>> 
>>> # pkg info amd64-gcc
>>> amd64-gcc-6.4.0_1
>>> Name           : amd64-gcc
>>> Version        : 6.4.0_1
>>> Installed on   : Sun Jul 15 09:15:38 2018 PDT
>>> Origin         : devel/amd64-gcc
>>> Architecture   : FreeBSD:12:amd64
>>> Prefix         : /usr/local
>>> Categories     : devel
>>> Licenses       : GPLv3, GPLv3RLE
>>> Maintainer     : kan at FreeBSD.org
>>> WWW            : http://gcc.gnu.org/
>>> Comment        : Cross GNU Compiler Collection for amd64
>>> Shared Libs required:
>>> 	libmpc.so.3
>>> 	libgmp.so.10
>>> 	libmpfr.so.6
>>> Shared Libs provided:
>>> 	liblto_plugin.so.0
>>> Annotations    :
>>> 	FreeBSD_version: 1200069
>>> 	repo_type      : binary
>>> 	repository     : custom
>>> Flat size      : 338MiB
>>> Description    :
>>> GCC, the GNU Compiler Collection supporting C and C++ for targetting crossbuilding.
>>> 
>>> WWW: http://gcc.gnu.org/
>> 
>> With your patch it gets past that point of build failure.
>> 
>> But my devel/amd64-gcc predates the removal of float.h from
>> the installed devel/amd64-gcc so the following may not be as
>> it would be in such a context:
>> 
>> --- lib/msun__L ---
>> /usr/src/lib/msun/src/catrigl.c:90:2: error: #error "Unsupported long double format"
>> #error "Unsupported long double format"
>> ^~~~~
>> . . .
>> --- lib/msun__L ---
>> /usr/src/lib/msun/src/catrigl.c: In function 'casinhl':
>> /usr/src/lib/msun/src/catrigl.c:190:35: error: 'm_ln2' undeclared (first use in this function)
>>   w = clog_for_large_values(z) + m_ln2;
>>                                  ^~~~~
>> /usr/src/lib/msun/src/catrigl.c:190:35: note: each undeclared identifier is reported only once for each function it appears in
>> /usr/src/lib/msun/src/catrigl.c:202:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
>> if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
>>          ^~~~~~~~~~~~~~
>> /usr/src/lib/msun/src/catrigl.c: In function 'cacosl':
>> /usr/src/lib/msun/src/catrigl.c:250:20: error: 'm_ln2' undeclared (first use in this function)
>>  ry = creall(w) + m_ln2;
>>                   ^~~~~
>> /usr/src/lib/msun/src/catrigl.c:261:11: error: 'SQRT_6_EPSILON' undeclared (first use in this function)
>> if (ax < SQRT_6_EPSILON / 4 && ay < SQRT_6_EPSILON / 4)
>>          ^~~~~~~~~~~~~~
>> In file included from /usr/src/lib/msun/src/catrigl.c:45:0:
>> 
>> 
>> 
>> I can remove float.h and see what happens.
> 
> While the build without gcc's float.h goes on, here are some small
> experiments with interesting results (mostly these are with
> -std=gnu11):
> 
> # more AtomicTest.c 
> // x86_64-unknown-freebsd12.0-gcc -v -E AtomicTest.c
> 
> #include <sys/cdefs.h>
> #include <stdatomic.h>
> 
> struct foo {
>       _Atomic(int) one;
>       _Atomic int two;
>       atomic_int three;
> };
> 
> 
> 
> # x86_64-unknown-freebsd12.0-gcc -dM -std=gnu11 -E AtomicTest.c | grep has_
> #define __has_include(STR) __has_include__(STR)
> #define __has_include_next(STR) __has_include_next__(STR)
> #define __has_extension __has_feature
> #define __has_builtin(x) 0
> #define __has_feature(x) 0
> 
> (-std=gnu99 matches the above)
> 
> 
> # x86_64-unknown-freebsd12.0-gcc -dM -std=gnu11 -E AtomicTest.c | grep atomic_fetch
> #define atomic_fetch_or(PTR,VAL) __atomic_fetch_or ((PTR), (VAL), __ATOMIC_SEQ_CST)
> #define atomic_fetch_or_explicit(PTR,VAL,MO) __atomic_fetch_or ((PTR), (VAL), (MO))
> #define atomic_fetch_and_explicit(PTR,VAL,MO) __atomic_fetch_and ((PTR), (VAL), (MO))
> #define atomic_fetch_sub_explicit(PTR,VAL,MO) __atomic_fetch_sub ((PTR), (VAL), (MO))
> #define atomic_fetch_xor_explicit(PTR,VAL,MO) __atomic_fetch_xor ((PTR), (VAL), (MO))
> #define atomic_fetch_add(PTR,VAL) __atomic_fetch_add ((PTR), (VAL), __ATOMIC_SEQ_CST)
> #define atomic_fetch_sub(PTR,VAL) __atomic_fetch_sub ((PTR), (VAL), __ATOMIC_SEQ_CST)
> #define atomic_fetch_and(PTR,VAL) __atomic_fetch_and ((PTR), (VAL), __ATOMIC_SEQ_CST)
> #define atomic_fetch_xor(PTR,VAL) __atomic_fetch_xor ((PTR), (VAL), __ATOMIC_SEQ_CST)
> #define atomic_fetch_add_explicit(PTR,VAL,MO) __atomic_fetch_add ((PTR), (VAL), (MO))
> 
> (-std=gnu99 matches the above)
> 
> 
> The following shows -std=gnu99 vs. -std=gnu11 results that do not
> match:
> 
> # x86_64-unknown-freebsd12.0-gcc -E -std=gnu99 AtomicTest.c | more
> . . .
> # 6 "AtomicTest.c"
> struct foo {
> 
> # 7 "AtomicTest.c" 3 4
>      struct { 
> # 7 "AtomicTest.c"
>      int 
> # 7 "AtomicTest.c" 3 4
>      volatile __val; } 
> # 7 "AtomicTest.c"
>                   one;
>       _Atomic int two;
>       atomic_int three;
> };
> . . .
> 
> # x86_64-unknown-freebsd12.0-gcc -E -std=gnu11 AtomicTest.c | more
> . . .
> 
> # 6 "AtomicTest.c"
> struct foo {
>       _Atomic(int) one;
>       _Atomic int two;
>       atomic_int three;
> };
> . . .
> 
> I will add a #warning where FreeBSD's cdefs.h has the #define _Atomic(T)
> to report on if the #define _Atomic(T) is being processed (but possibly
> ignored) for -std=gnu11 . (But after the ongoing build stops.)
> 

I was looking too locally: the overall context has an outer #if
as well that skips the section:

/*
 * Keywords added in C11.
 */
 
#if !defined(__STDC_VERSION__) || __STDC_VERSION__ < 201112L
. . .
#if !defined(__cplusplus) && !__has_extension(c_atomic) && \
    !__has_extension(cxx_atomic)
/*
 * No native support for _Atomic(). Place object in structure to prevent
 * most forms of direct non-atomic access.
 */
#define _Atomic(T)              struct { T volatile __val; }
#endif
. . .
#endif /* __STDC_VERSION__ || __STDC_VERSION__ < 201112L */




The build with gcc's float.h also removed did complete instead of
stopping early.



As for what x86_64-unknown-freebsd12.0 .h files were used:
(some may do include_next back into FreeBSD headers)


# find /usr/obj/amd64_xtoolchain-gcc/ -name "*.meta" -exec grep "^R .*/x86_64-unknown-freebsd12.0/.*\.h" {} \; | sort -k 3 | uniq -f 2 | more
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/adxintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ammintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx2intrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512bwintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512cdintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512dqintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512erintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512fintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmaintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmavlintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512pfintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmiintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmivlintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlbwintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vldqintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avxintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmi2intrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmiintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clflushoptintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clwbintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clzerointrin.h
R 56022 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/cpuid.h
R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/emmintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/f16cintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fma4intrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fmaintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fxsrintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ia32intrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/immintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lwpintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lzcntintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm3dnow.h
R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm_malloc.h
R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mmintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mwaitxintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pkuintrin.h
R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pmmintrin.h
R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/popcntintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/prfchwintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rdseedintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rtmintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/shaintrin.h
R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/smmintrin.h
R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdarg.h
R 27622 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdbool.h
R 10025 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
R 68604 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdnoreturn.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tbmintrin.h
R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tmmintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/wmmintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/x86intrin.h
R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xmmintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xopintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavecintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveoptintrin.h
R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavesintrin.h
R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xtestintrin.h




===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From ohartmann at walstatt.org  Fri Jul 27 10:02:51 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 27 Jul 2018 12:02:36 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
 <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
Message-ID: <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>

On Fri, 27 Jul 2018 08:54:48 +0300
Toomas Soome <tsoome at me.com> wrote:

> > On 27 Jul 2018, at 08:46, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Thu, 26 Jul 2018 19:23:43 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> > 
> > (reply inline/at the end)
> > 
> >   
> >>> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
> >>> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
> >>> <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote:   
> >>>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> >>>>>> 
> >>>>>> On Wed, 25 Jul 2018 11:46:07 +0300
> >>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>   
> >>>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>>> 
> >>>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
> >>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>> 
> >>>>>>>> 
> >>>>>>>> Hello  Toomas Soome,
> >>>>>>>> 
> >>>>>>>> I CC Allan Jude since I discovered something  weird today regarding
> >>>>>>>> the UEFI boot capabilities of USB flash devices and SSDs. See below.
> >>>>>>>>   
> >>>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>> wrote:
> >>>>>>>>>> 
> >>>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>>>>   
> >>>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>>> wrote:
> >>>>>>>>>>>> 
> >>>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>>>>>>>>   
> >>>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>>>>>>>>> Hash: SHA512
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>>
> >>>>>>>>>>>>>> schrieb:           
> >>>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann
> >>>>>>>>>>>>>>>> <ohartmann at walstatt.org> wrote:
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems
> >>>>>>>>>>>>>>>> on GPT drives where the first partition begins at block 40
> >>>>>>>>>>>>>>>> of the hdd/ssd.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> I have two host in private use based on an
> >>>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
> >>>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
> >>>>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013.
> >>>>>>>>>>>>>>>> This is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for
> >>>>>>>>>>>>>>>> the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a
> >>>>>>>>>>>>>>>> BETA revision for the Spectre/Meltdown mitigation is
> >>>>>>>>>>>>>>>> available, but I didn't test that. But please read.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
> >>>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
> >>>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via
> >>>>>>>>>>>>>>>> bsdinstall the OS using UEFI-only boot method on a GPT
> >>>>>>>>>>>>>>>> partitioned device fails. The ASRock boards jump immediately
> >>>>>>>>>>>>>>>> into the firmware, the Fujitsu offers some kind of
> >>>>>>>>>>>>>>>> CPU/Memory/HDD test facility.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI
> >>>>>>>>>>>>>>>> boot only is implied, the MBR partitioned FreeBSD
> >>>>>>>>>>>>>>>> installation USB flash device does boot in UEFI! I guess I
> >>>>>>>>>>>>>>>> can assume this when the well known clumsy 80x25 char
> >>>>>>>>>>>>>>>> console suddenly gets bright and shiny with a much higher
> >>>>>>>>>>>>>>>> resoltion as long the GPU supports EFI GOP. Looking with
> >>>>>>>>>>>>>>>> gpart at the USB flash drives reveals that the EFI partition
> >>>>>>>>>>>>>>>> starts at block 1 of the device and the device has a MBR
> >>>>>>>>>>>>>>>> layout. I haven't found a way to force the GPT scheme, when
> >>>>>>>>>>>>>>>> initialised via gpart, to let the partitions start at block
> >>>>>>>>>>>>>>>> 1. This might be a naiv thinking, so please be patient with
> >>>>>>>>>>>>>>>> me.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the
> >>>>>>>>>>>>>>>> ASRock boards, I tried years ago some LinuxRed Hat and Suse
> >>>>>>>>>>>>>>>> with UEFI and that worked - FreeBSD not. I gave up on that
> >>>>>>>>>>>>>>>> that time. Now, having the very same issues with a new
> >>>>>>>>>>>>>>>> Fujitsu system, leaves me with the impression that FreeBSD's
> >>>>>>>>>>>>>>>> UEFI implementation might have problems I'm not aware of.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>>>>>>>>   
> >>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
> >>>>>>>>>>>>>>> do not support secure boot at all at this time.              
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>>>>>>>>   
> >>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>> If you have efi or bios version running - you can check from
> >>>>>>>>>>>>>>> either console variable value (it can have efi or vidconsole
> >>>>>>>>>>>>>>> or comconsole) or better yet, see if efi-version is set (show
> >>>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
> >>>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
> >>>>>>>>>>>>>>> paths present, it is uefi:)              
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> What are you talking about?
> >>>>>>>>>>>>>> What is the point of entry - running system, loader?
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS -
> >>>>>>>>>>>>>> as I'm sure since I've checked that many times. UEFI doesn't
> >>>>>>>>>>>>>> work on those systems with FreeBSD. I'm not sure antmore, but
> >>>>>>>>>>>>>> I tried also Windows 7 on those mainboards booting via UEFI -
> >>>>>>>>>>>>>> and I might recall that they failed also. I also recall that
> >>>>>>>>>>>>>> there were issues with earlier UEFI versions regarding booting
> >>>>>>>>>>>>>> only Windows 8/8.1 - and nothing else, but the fact that Linux
> >>>>>>>>>>>>>> worked confuses me a bit.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work
> >>>>>>>>>>>>>> at all - who cares, I intend to purchase new server grade
> >>>>>>>>>>>>>> hardware. But the more puzzling issue is with the Fujitsu,
> >>>>>>>>>>>>>> which I consider serious and from the behaviour the Fujitsu
> >>>>>>>>>>>>>> failure looks exactly like the ASRock - Windows 7 works,
> >>>>>>>>>>>>>> RedHat 7.5 works (I assume I can trust the Firmware settings
> >>>>>>>>>>>>>> when I disable CSM support, that the Firmware will only
> >>>>>>>>>>>>>> EFI/UEFI capable loader? Or is there a ghosty override
> >>>>>>>>>>>>>> somwhere to be expected?). Also on ASRock disabling CSM should
> >>>>>>>>>>>>>> ensure not booting a dual-bootstrap-capable system. This said,
> >>>>>>>>>>>>>> on the recent Fujitsu, it seems to boil down to a FreeBSD
> >>>>>>>>>>>>>> UEFI-firmware interaction problem, while the ASRock is still
> >>>>>>>>>>>>>> under suspicion to be broken by design.             
> >>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1;
> >>>>>>>>>>>>>>> this is because at sector 0 there is MBR (for compatibility),
> >>>>>>>>>>>>>>> sector 1 is GPT table and then sectors 2-33 have GPT
> >>>>>>>>>>>>>>> partition table entries, so the first possible data sector is
> >>>>>>>>>>>>>>> 34 (absolute 34). Thats assuming 512B sectors. For details
> >>>>>>>>>>>>>>> see UEFI 2.7 Chapter 5.3.1 page 131.              
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> Thanks for the explanation. That implies the installer did
> >>>>>>>>>>>>>> right, gpart did also right and therefore there must be an
> >>>>>>>>>>>>>> issue with the stuff located within the EFI
> >>>>>>>>>>>>>> partition?             
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
> >>>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
> >>>>>>>>>>>>> actually caring to read the MBR code and start it, since once
> >>>>>>>>>>>>> the MBR code is started, it is all about our code.            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM?
> >>>>>>>>>>>> or do you mean that specific portion of the UEFI firmware, which
> >>>>>>>>>>>> looks for the proper UEFI partition?
> >>>>>>>>>>>>   
> >>>>>>>>>>> 
> >>>>>>>>>>> BIOS as either native or CSM. Note that from boot code point of
> >>>>>>>>>>> view the CSM boot *is* BIOS boot, we have no access to UEFI
> >>>>>>>>>>> features. 
> >>>>>>>>>>>> 
> >>>>>>>>>>>> The boxes in question, most notably the more recent Fujitsu
> >>>>>>>>>>>> Esprimo Q956, refuse booting UEFI, even if properly setup (in
> >>>>>>>>>>>> terms of what FreeBSD provides on recent CURRENT) is applied and
> >>>>>>>>>>>> CSM is switched off in the firmware. Again: GPT partition scheme.
> >>>>>>>>>>>> 
> >>>>>>>>>>>> The system boots properly if a second partition of type
> >>>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
> >>>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0
> >>>>>>>>>>>> is the device).             
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
> >>>>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
> >>>>>>>>>>>>> prompt:            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>>>>>>>>> 
> >>>>>>>>>>>> OK lsdev
> >>>>>>>>>>>> disk devices:
> >>>>>>>>>>>> 	disk0:		BIOS DRIVE C ...
> >>>>>>>>>>>> 
> >>>>>>>>>>>> 		disk0p1:	EFI
> >>>>>>>>>>>> 		disk0p2:	FreeBSD BOOT
> >>>>>>>>>>>> 		disk0p3:	FreeBSD SWAP
> >>>>>>>>>>>> 		disk0p4:	FreeBSD ZFS
> >>>>>>>>>>>> zfs devices:
> >>>>>>>>>>>> 	zfs:zroot
> >>>>>>>>>>>> 
> >>>>>>>>>>>> OK chain disk0
> >>>>>>>>>>>> open failed     (so for disk0p{1-4}.
> >>>>>>>>>>>> 
> >>>>>>>>>>>> OK chain zroot
> >>>>>>>>>>>> failed to read disk (just for completeness)            
> >>>>>>>>>>> 
> >>>>>>>>>>> 
> >>>>>>>>>>> chain command does use only device name (such as disk0: or
> >>>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
> >>>>>>>>>>> ported the code to read the file.          
> >>>>>>>>>> 
> >>>>>>>>>> ??
> >>>>>>>>>>   
> >>>>>>>>>>> 
> >>>>>>>>>>> the point for chain command test is to see if the normal read and
> >>>>>>>>>>> execute would work, so in your case please try:
> >>>>>>>>>>> 
> >>>>>>>>>>> chain disk0:          
> >>>>>>>>>> 
> >>>>>>>>>> As stated above, I did so, and the result is also mentioned above,
> >>>>>>>>>> I always get "open failed".
> >>>>>>>>>> This is the same for 
> >>>>>>>>>> 
> >>>>>>>>>> chain disk0
> >>>>>>>>>> chain disk0p1
> >>>>>>>>>> chain disk0p2
> >>>>>>>>>> chain disk0p3
> >>>>>>>>>> chain disk0p4
> >>>>>>>>>> 
> >>>>>>>>>> as already said. CSM is enabled in this case.          
> >>>>>>>>> 
> >>>>>>>>> sigh? chain command does take device as argument, device must always
> >>>>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
> >>>>>>>>> above, the command should be:
> >>>>>>>>> 
> >>>>>>>>> chain disk0:
> >>>>>>>>> 
> >>>>>>>>> The disk0p1: etc will only work when partition boot code was
> >>>>>>>>> installed (which you most likely do not have - the only possible
> >>>>>>>>> candidate could be FreeBSD ZFS partition).        
> >>>>>>>> 
> >>>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
> >>>>>>>> partition scheme, but with PMBR bootblock installed and freebsd-boot
> >>>>>>>> partition conatining gptzfsboot installed.
> >>>>>>>> 
> >>>>>>>>   
> >>>>>>>>>   
> >>>>>>>>>>   
> >>>>>>>>>>> 
> >>>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
> >>>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from
> >>>>>>>>>>> disk0p2: and execute it; stage1 would detect FreeBSD ZFS from
> >>>>>>>>>>> disk0p4: and load and execute /boot/loader. If that will happen,
> >>>>>>>>>>> it means the boot code in our stages is just fine, but the bios
> >>>>>>>>>>> (CSM) does not load pmbr?.  if thats true, it would mean that you
> >>>>>>>>>>> either need to use UEFI boot or need to have some hack to fool
> >>>>>>>>>>> the BIOS or just not use GPT on that machine with CSM.          
> >>>>>>>>>> 
> >>>>>>>>>> To make it clear here: The only way to boot this box is using CSM
> >>>>>>>>>> (as it is the same with the ASRock boards mentioned earlier). But
> >>>>>>>>>> my intention is to disable CSM and use a GPT/UEFI environment
> >>>>>>>>>> only! And GPT/UEFI doesn't work with FreeBSD, neither with
> >>>>>>>>>> 12-CURRENT, nor 11.2-RELENG.
> >>>>>>>>>> 
> >>>>>>>>>> It would be nice if this could be fixed. I'm more interested in the
> >>>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
> >>>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
> >>>>>>>>>> byproduct, I'd appreciate that.
> >>>>>>>>>> 
> >>>>>>>>>> Kind regards,
> >>>>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
> >>>>>>>>> that the UEFI boot fails when the first partition starts from sector
> >>>>>>>>> 40 - does it mean you have boot when the partition will start from
> >>>>>>>>> some other sector? I think, there is something else going
> >>>>>>>>> on.        
> >>>>>>>> 
> >>>>>>>> Well, I simply try to describe what I "see" to make things
> >>>>>>>> disambiguous. I'm not familiar with the deeper insights of disk
> >>>>>>>> layouts on a binary level. So, you explained to me the reason, why
> >>>>>>>> ESP (EGI partition) starts at block 40. I compared that to the
> >>>>>>>> FreeBSD USB flash image FreeBSD provides, but this is another story
> >>>>>>>> since the image uses MBR scheme as I figured out.
> >>>>>>>> 
> >>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> What you can do is to see if that firmware will offer you EFI shell
> >>>>>>>>> option, from there you can try to start the bootx64.efi manually and
> >>>>>>>>> see what error you will get. However, the number 1 cause for failing
> >>>>>>>>> to start the bootloader in UEFI is secure boot - we do not support
> >>>>>>>>> it and secure boot must be switched off. 
> >>>>>>>>> 
> >>>>>>>>> However, they seem to claim "The Secure Boot option is available in
> >>>>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is disabled by
> >>>>>>>>> default.? 
> >>>>>>>>> 
> >>>>>>>>> Still suggest to double check if thats really the case. Also, if the
> >>>>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
> >>>>>>>>> then either there is something in firmware logs or you could get
> >>>>>>>>> them from trying to start bootx64.efi from UEFI shell.        
> >>>>>>>> 
> >>>>>>>> Since I'm with this problem since 2014 and try from time to time, be
> >>>>>>>> ausred that I tried every possible permutationof all reasonable
> >>>>>>>> options, even those nonsense, to get rid of that problem.
> >>>>>>>> 
> >>>>>>>> I never had any problems with any other UEFI capable
> >>>>>>>> server/workstation firmware so far booting FreeBSD off in
> >>>>>>>> UEFI-native (GPT partition scheme, CSM disabled) so far - until now,
> >>>>>>>> when I ran into this Fujitsu ESPRIMO Q956 with the most recent
> >>>>>>>> firmware (as of lat week, week 29 of 2018) having the very same
> >>>>>>>> problems. 
> >>>>>>>> 
> >>>>>>>> 
> >>>>>>>> 
> >>>>>>>> I figured out something strange on the Fujitsu - and that is the same
> >>>>>>>> with the ASRock boards.
> >>>>>>>> 
> >>>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> >>>>>>>> appliance, but nevertheless, the USB flash device is booted on
> >>>>>>>> Fujitsu servers with UEFI-only configurations. I assume at this
> >>>>>>>> point that disabling on the most recent Fujitsu firmwares on
> >>>>>>>> reasonable "new" hardware (not older than three years) will disable
> >>>>>>>> any(!) legacy BIOS capabilities. The same is assumed for the Fujitus
> >>>>>>>> ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
> >>>>>>>> mentioned above/earlier, they are from 2012/2013 and "quite old".
> >>>>>>>> 
> >>>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition.
> >>>>>>>> The partition scheme of the flash device is GPT. The layout looks
> >>>>>>>> like this:
> >>>>>>>> 
> >>>>>>>> gpart show -l da4        
> >>>>>>>> =>      40  15425456  da4  GPT  (7.4G)        
> >>>>>>>>     40      2000    1  efiboot0  (1.0M)
> >>>>>>>>   2040   1453584    3  disk1a  (710M)
> >>>>>>>> 1455624      4096    5  disk3  (2.0M)
> >>>>>>>> 1459720  13965776       - free -  (6.7G)
> >>>>>>>> 
> >>>>>>>> I created the flash with md, gpart and dd straightforward, efiboot0
> >>>>>>>> is the ESP partition and its format/content is created via dd
> >>>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
> >>>>>>>> 
> >>>>>>>> This USB flash device boots(!) successfully (UEFI!) on both the
> >>>>>>>> ASRock boards and the Esprimo Q956!
> >>>>>>>> 
> >>>>>>>> But any SSD prepared the same way doesn't. Why? 
> >>>>>>>> 
> >>>>>>>> On the ASRock, I recall having fiddled around with HDD also for a
> >>>>>>>> while conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD
> >>>>>>>> - I can't remember. 
> >>>>>>>> 
> >>>>>>>> In the lack of proper hardware I'm unable to check whether
> >>>>>>>> USB-attached HDD or SSD will boot or HDD will boot (just in case the
> >>>>>>>> local SATA has problems booting UEFI and USB not).
> >>>>>>>> 
> >>>>>>>> Kind regards,
> >>>>>>>> 
> >>>>>>>> Oliver 
> >>>>>>>>   
> >>>>>>> 
> >>>>>>> Am. well. I think the suggestion to test out FAT32 is still good one
> >>>>>>> to test. This is because it is known that some vendors do not support
> >>>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
> >>>>>>> specification does not tell which FAT must be supported, and only hint
> >>>>>>> about FAT12/FAT16 in context of removable devices).      
> >>>>>> 
> >>>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
> >>>>>> took me a time to circumvent the installer and I had to install the
> >>>>>> system manually. In that strain, I also "tried" to establish the ESP
> >>>>>> with FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc
> >>>>>> help how to find out the format (FAT12/16/32) of the ESP, so I assume
> >>>>>> when using 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and
> >>>>>> GPT (UEFI) (only!) the resulting ESP is FAT12 or FAT16 (300mb by
> >>>>>> default). I also assume, that when dd'ing the /boo/boot1.efifat image
> >>>>>> to a partition, the format is FAT, but not FAT32. Therefore, I
> >>>>>> refomatted the manually created ESP (using "gpart add -t efi ...")
> >>>>>> using "newfs_msdos -F 32 -b xxx ...". I had to fiddle around a bit
> >>>>>> with option -b to fit in a proper format to meet a 512mb ESP - I'm not
> >>>>>> sure whether this is the proper option to deal with. When using the
> >>>>>> default and only -F32, the size of the partition has to be 4G at least
> >>>>>> I assume. Having done that, I copied the the content of boot1.efifat
> >>>>>> (mdconfig -t vnode ..., I guess we know the drill ...) to the newly
> >>>>>> formatted ESP to /boot/efi/ ...
> >>>>>> 
> >>>>>> Having so far no knowledge of how to asure that the created ESP is
> >>>>>> FAT32, I assume it is FAT32.
> >>>>>> 
> >>>>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
> >>>>>> box is not willing to boot from SSD with the ESP prepared as decribed.
> >>>>>> So, a chance that this might still be due to a misconfiguration lies
> >>>>>> now within the -b option of newfs_msdos - if the -b option is assumed
> >>>>>> the proper option?
> >>>>>> 
> >>>>>> At the moment, the ESP of the Esprimo is subject to changes, if you
> >>>>>> wish, but not in size, since it is limited to 512mb.
> >>>>>> 
> >>>>>> Thanks and kind regards,
> >>>>>> 
> >>>>>> Oliver      
> >>>>> 
> >>>>> Yea, i was hoping fstyp command would report the FAT type, but it does
> >>>>> not (request for feature?:)      
> >>>> 
> >>>> FYI, the file(1) command is very good at disecting a disk image to tell
> >>>> you what the MBR looks like, and at looking at partitions if pointed at
> >>>> them with the -s option.  It should be able to detect FAT12/16/32.
> >>>> 
> >>>> root at x230a:/home/ISO/x # file -s /dev/md2s1
> >>>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ",
> >>>> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
> >>>> sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS
> >>>> ", FAT (12 bit), followed by FAT
> >>>>   
> >>>>> 
> >>>>> However, the more annoying idea would be to install some OS which will
> >>>>> boot with UEFI on this machine, then copy boot1.efi from freebsd to it
> >>>>> (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in
> >>>>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do
> >>>>> not support EFI32.
> >>>>> 
> >>>>> note that boot1.efi alone will not do much but printing on screen how it
> >>>>> will search for freebsd, but for the purpose of the test it would
> >>>>> suffice
> >>>>> - that would give us confirmed working ESP file system (since the other
> >>>>> os would be able to boot) and then we can confirm if boot1.efi itself is
> >>>>> OK.      
> >>>>   
> >>> 
> >>> Some new results.
> >>> I installed RedHat 7.5 and inestigated the ESP.
> >>> 
> >>> - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
> >>> - size is both 200mb if installed automatically. I forgit to investigate
> >>> the FAT format, but this might be unnecessary as shown further in this
> >>> post.
> >>> - RedHat's ESP contains ~ 10 MB of data in two
> >>> folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
> >>> RedHat's doesn't change anything, also renaming /efi/boot/fbx64.efi of
> >>> RedHat's installation. But renaming /efi/redhat renders RedHat to fail the
> >>> boot process on the Fujitsu with the signs of the built-in testprogram as
> >>> reported.
> >>> 
> >>> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot
> >>> only (CSM in firmware disabled, but there is still a gptzfsboot-prepared
> >>> partition for later use, just for the record). Booting UEFI-only fails as
> >>> reported. On this installation I copied the RedHat ESP completely into
> >>> FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh
> >>> and copied FreeBSD's BOOTX64.efi to /efi/boot. 
> >>> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
> >>> the /efi/redhat folder of the ESP is important, if renamed, the whole
> >>> process dies as I reported earlier.
> >>> 
> >>> Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB
> >>> flash booting with CSM disabled (so asumingly UEFI only then) on both
> >>> ASRock and Fujitsu (as described in more detail initially and earlier),
> >>> while SSDs fail? Is there a difference? Since FreeBSD boots in UEFI mode
> >>> from USB flash prepared as described (straight forward, 800k ESP starting
> >>> at block 40, the boot1.efifat image dd'ed onto the partition, UFS
> >>> partition following, no freebsd-boot partition or MBR/PMBR bootcode
> >>> applied ever!), I think BOOTX64.EFI is technically all right. There must
> >>> be then an issue with the SATA/SSD/HDD boot pathway.
> >>> 
> >>> Hope I could provide some more details, sorry if it sounds confusing or
> >>> way too long, but I try to descibe the situation as thorough as possible.
> >>>   
> >> 
> >> OK, this is already good hint. The thing with ESP is that there is
> >> ?default? file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as
> >> default for *removable* media, fortunately it is usable for hard disks as
> >> well, or at least in most cases.
> >> 
> >> Now, for non-removable media, the UEFI does provide boot manager interface
> >> to define boot entries, and the fact that renaming efi/redhad directory did
> >> break the redhat boot, is very loud hint. And this means, this system is
> >> probably ignoring efi/boot tree on non-removable media and is expecting the
> >> boot manager entry to be created instead.  
> > 
> > This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956 firmware
> > (not tested on ASRock Z77-Pro4 firmware).
> >   
> >> 
> >> UEFI boot manager can be configured /usually/ manually via firmware menu,
> >> or by application, such as efibootmgr. The normal approach is to create
> >> efi/<vendorname> directory and to copy the application there, then create
> >> the boot manager configuration.
> >> 
> >> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
> >> 
> >> What is different in FreeBSD case is that the whole interface to program
> >> the UEFI Boot Manager is currently being developed, so either it has to be
> >> done manually or from some other OS (see
> >> https://wiki.gentoo.org/wiki/Efibootmgr
> >> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from
> >> google:D).  
> > 
> > Well, thanks for this important hint! FreeBSD 12-CURRENT's and FreeBSD
> > 11.2-RELENG's USB flash devices are capable of booting off on Fujitsu's
> > ESPRIMO and ASRock's boards. As a note: after "kldload efirt.ko" I was able
> > to use the already in FreeBSD present toolset efibootmgr(8) and sibblings
> > (the tools do not do anything useful when booted non-UEFI).
> > 
> > Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and following
> > the steps in the examples and having created /efi/freebsd/BOOTx64.efi as
> > recommended by copy from /efi/boot, let me create a proper boot variable.
> > 
> > To make things sure, I also applied "efibootmgr -a VARIABLENAME".
> > 
> > And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do not know
> > whether this will also work with FAT12/16, I should test this case, too.
> > 
> > There is a bug in the manpage of efibootmg(8). It does not explain the
> > options -d and -p, although they could be "implied" by reading carefully.
> > There is now a PR at 
> > 
> > https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080
> > 
> > for this issue.
> > 
> > So, it's apity that the handbook has no note I could easily find on this; 
> > 
> > Thank you very much for your patience and help!
> > 
> > Kind regards,
> > Oliver  
> 
> yep, efibootmgr does call UEFI RuntimeServices to set up the variables, and
> this is only possible when booted UEFI. But glad we finally found the root
> cause. It would be good to have HW notes for such cases, it is important to
> know that those systems wont boot UEFI from HDD unless the boot manager setup
> is done.
> 
> rgds,
> toomas


This pops up the question how to deal with such HW. We have as a institution a
lot of Fujitsu hardware her - from larger servers down to Fujitsu ESPRIMO Q956.
The latter one is the first (and so far the only) piece of hardware I found
incapable of booting off UEFI within the past 5 years.

If the "standard" for removeable devices is to boot from /efi/boot/bootx64.efi,
than I'd guess it is good luck for FreeBSD that the firmware vendors did
fallback to such a mechanism. GRUB/Linux seem to install by default their
bootloader into /efi/something/ I'll check on Debian, Suse and CentOS so far
soon, the latter probably will, since its the "free" RedHat).

Anyway, apart from any criticism, I'm glad to have the tools to make things
work without using alien help (outside FreeBSD's world!). That is a thank you
towards the developers.

Kind regards,

oh


From tsoome at me.com  Fri Jul 27 10:59:50 2018
From: tsoome at me.com (Toomas Soome)
Date: Fri, 27 Jul 2018 13:59:44 +0300
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
 <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
 <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>
Message-ID: <2A5E5E42-8595-44E9-A51E-504C9C2C7FA7@me.com>



> On 27 Jul 2018, at 13:02, O. Hartmann <ohartmann at walstatt.org> wrote:
> 
> On Fri, 27 Jul 2018 08:54:48 +0300
> Toomas Soome <tsoome at me.com> wrote:
> 
>>> On 27 Jul 2018, at 08:46, O. Hartmann <ohartmann at walstatt.org> wrote:
>>> 
>>> On Thu, 26 Jul 2018 19:23:43 +0300
>>> Toomas Soome <tsoome at me.com> wrote:
>>> 
>>> (reply inline/at the end)
>>> 
>>> 
>>>>> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>> 
>>>>> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
>>>>> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
>>>>> <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote:   
>>>>>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
>>>>>>>> 
>>>>>>>> On Wed, 25 Jul 2018 11:46:07 +0300
>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>> 
>>>>>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
>>>>>>>>>> 
>>>>>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
>>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> Hello  Toomas Soome,
>>>>>>>>>> 
>>>>>>>>>> I CC Allan Jude since I discovered something  weird today regarding
>>>>>>>>>> the UEFI boot capabilities of USB flash devices and SSDs. See below.
>>>>>>>>>> 
>>>>>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>>> wrote:
>>>>>>>>>>>> 
>>>>>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
>>>>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
>>>>>>>>>>>> 
>>>>>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
>>>>>>>>>>>>>> wrote:
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
>>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
>>>>>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
>>>>>>>>>>>>>>>> Hash: SHA512
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
>>>>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
>>>>>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>>
>>>>>>>>>>>>>>>> schrieb:           
>>>>>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann
>>>>>>>>>>>>>>>>>> <ohartmann at walstatt.org> wrote:
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems
>>>>>>>>>>>>>>>>>> on GPT drives where the first partition begins at block 40
>>>>>>>>>>>>>>>>>> of the hdd/ssd.
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> I have two host in private use based on an
>>>>>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
>>>>>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
>>>>>>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013.
>>>>>>>>>>>>>>>>>> This is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for
>>>>>>>>>>>>>>>>>> the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a
>>>>>>>>>>>>>>>>>> BETA revision for the Spectre/Meltdown mitigation is
>>>>>>>>>>>>>>>>>> available, but I didn't test that. But please read.
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
>>>>>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
>>>>>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via
>>>>>>>>>>>>>>>>>> bsdinstall the OS using UEFI-only boot method on a GPT
>>>>>>>>>>>>>>>>>> partitioned device fails. The ASRock boards jump immediately
>>>>>>>>>>>>>>>>>> into the firmware, the Fujitsu offers some kind of
>>>>>>>>>>>>>>>>>> CPU/Memory/HDD test facility.
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI
>>>>>>>>>>>>>>>>>> boot only is implied, the MBR partitioned FreeBSD
>>>>>>>>>>>>>>>>>> installation USB flash device does boot in UEFI! I guess I
>>>>>>>>>>>>>>>>>> can assume this when the well known clumsy 80x25 char
>>>>>>>>>>>>>>>>>> console suddenly gets bright and shiny with a much higher
>>>>>>>>>>>>>>>>>> resoltion as long the GPU supports EFI GOP. Looking with
>>>>>>>>>>>>>>>>>> gpart at the USB flash drives reveals that the EFI partition
>>>>>>>>>>>>>>>>>> starts at block 1 of the device and the device has a MBR
>>>>>>>>>>>>>>>>>> layout. I haven't found a way to force the GPT scheme, when
>>>>>>>>>>>>>>>>>> initialised via gpart, to let the partitions start at block
>>>>>>>>>>>>>>>>>> 1. This might be a naiv thinking, so please be patient with
>>>>>>>>>>>>>>>>>> me.
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the
>>>>>>>>>>>>>>>>>> ASRock boards, I tried years ago some LinuxRed Hat and Suse
>>>>>>>>>>>>>>>>>> with UEFI and that worked - FreeBSD not. I gave up on that
>>>>>>>>>>>>>>>>>> that time. Now, having the very same issues with a new
>>>>>>>>>>>>>>>>>> Fujitsu system, leaves me with the impression that FreeBSD's
>>>>>>>>>>>>>>>>>> UEFI implementation might have problems I'm not aware of.
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>>> Can someone shed some light onto this? 
>>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
>>>>>>>>>>>>>>>>> do not support secure boot at all at this time.              
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> Secure boot is in every scenario disabled!
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>> If you have efi or bios version running - you can check from
>>>>>>>>>>>>>>>>> either console variable value (it can have efi or vidconsole
>>>>>>>>>>>>>>>>> or comconsole) or better yet, see if efi-version is set (show
>>>>>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
>>>>>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
>>>>>>>>>>>>>>>>> paths present, it is uefi:)              
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> What are you talking about?
>>>>>>>>>>>>>>>> What is the point of entry - running system, loader?
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS -
>>>>>>>>>>>>>>>> as I'm sure since I've checked that many times. UEFI doesn't
>>>>>>>>>>>>>>>> work on those systems with FreeBSD. I'm not sure antmore, but
>>>>>>>>>>>>>>>> I tried also Windows 7 on those mainboards booting via UEFI -
>>>>>>>>>>>>>>>> and I might recall that they failed also. I also recall that
>>>>>>>>>>>>>>>> there were issues with earlier UEFI versions regarding booting
>>>>>>>>>>>>>>>> only Windows 8/8.1 - and nothing else, but the fact that Linux
>>>>>>>>>>>>>>>> worked confuses me a bit.
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work
>>>>>>>>>>>>>>>> at all - who cares, I intend to purchase new server grade
>>>>>>>>>>>>>>>> hardware. But the more puzzling issue is with the Fujitsu,
>>>>>>>>>>>>>>>> which I consider serious and from the behaviour the Fujitsu
>>>>>>>>>>>>>>>> failure looks exactly like the ASRock - Windows 7 works,
>>>>>>>>>>>>>>>> RedHat 7.5 works (I assume I can trust the Firmware settings
>>>>>>>>>>>>>>>> when I disable CSM support, that the Firmware will only
>>>>>>>>>>>>>>>> EFI/UEFI capable loader? Or is there a ghosty override
>>>>>>>>>>>>>>>> somwhere to be expected?). Also on ASRock disabling CSM should
>>>>>>>>>>>>>>>> ensure not booting a dual-bootstrap-capable system. This said,
>>>>>>>>>>>>>>>> on the recent Fujitsu, it seems to boil down to a FreeBSD
>>>>>>>>>>>>>>>> UEFI-firmware interaction problem, while the ASRock is still
>>>>>>>>>>>>>>>> under suspicion to be broken by design.             
>>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1;
>>>>>>>>>>>>>>>>> this is because at sector 0 there is MBR (for compatibility),
>>>>>>>>>>>>>>>>> sector 1 is GPT table and then sectors 2-33 have GPT
>>>>>>>>>>>>>>>>> partition table entries, so the first possible data sector is
>>>>>>>>>>>>>>>>> 34 (absolute 34). Thats assuming 512B sectors. For details
>>>>>>>>>>>>>>>>> see UEFI 2.7 Chapter 5.3.1 page 131.              
>>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>>> Thanks for the explanation. That implies the installer did
>>>>>>>>>>>>>>>> right, gpart did also right and therefore there must be an
>>>>>>>>>>>>>>>> issue with the stuff located within the EFI
>>>>>>>>>>>>>>>> partition?             
>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
>>>>>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
>>>>>>>>>>>>>>> actually caring to read the MBR code and start it, since once
>>>>>>>>>>>>>>> the MBR code is started, it is all about our code.            
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM?
>>>>>>>>>>>>>> or do you mean that specific portion of the UEFI firmware, which
>>>>>>>>>>>>>> looks for the proper UEFI partition?
>>>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> BIOS as either native or CSM. Note that from boot code point of
>>>>>>>>>>>>> view the CSM boot *is* BIOS boot, we have no access to UEFI
>>>>>>>>>>>>> features. 
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> The boxes in question, most notably the more recent Fujitsu
>>>>>>>>>>>>>> Esprimo Q956, refuse booting UEFI, even if properly setup (in
>>>>>>>>>>>>>> terms of what FreeBSD provides on recent CURRENT) is applied and
>>>>>>>>>>>>>> CSM is switched off in the firmware. Again: GPT partition scheme.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> The system boots properly if a second partition of type
>>>>>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
>>>>>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0
>>>>>>>>>>>>>> is the device).             
>>>>>>>>>>>>>>> 
>>>>>>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
>>>>>>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
>>>>>>>>>>>>>>> prompt:            
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> OK lsdev
>>>>>>>>>>>>>> disk devices:
>>>>>>>>>>>>>> 	disk0:		BIOS DRIVE C ...
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> 		disk0p1:	EFI
>>>>>>>>>>>>>> 		disk0p2:	FreeBSD BOOT
>>>>>>>>>>>>>> 		disk0p3:	FreeBSD SWAP
>>>>>>>>>>>>>> 		disk0p4:	FreeBSD ZFS
>>>>>>>>>>>>>> zfs devices:
>>>>>>>>>>>>>> 	zfs:zroot
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> OK chain disk0
>>>>>>>>>>>>>> open failed     (so for disk0p{1-4}.
>>>>>>>>>>>>>> 
>>>>>>>>>>>>>> OK chain zroot
>>>>>>>>>>>>>> failed to read disk (just for completeness)            
>>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> chain command does use only device name (such as disk0: or
>>>>>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
>>>>>>>>>>>>> ported the code to read the file.          
>>>>>>>>>>>> 
>>>>>>>>>>>> ??
>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> the point for chain command test is to see if the normal read and
>>>>>>>>>>>>> execute would work, so in your case please try:
>>>>>>>>>>>>> 
>>>>>>>>>>>>> chain disk0:          
>>>>>>>>>>>> 
>>>>>>>>>>>> As stated above, I did so, and the result is also mentioned above,
>>>>>>>>>>>> I always get "open failed".
>>>>>>>>>>>> This is the same for 
>>>>>>>>>>>> 
>>>>>>>>>>>> chain disk0
>>>>>>>>>>>> chain disk0p1
>>>>>>>>>>>> chain disk0p2
>>>>>>>>>>>> chain disk0p3
>>>>>>>>>>>> chain disk0p4
>>>>>>>>>>>> 
>>>>>>>>>>>> as already said. CSM is enabled in this case.          
>>>>>>>>>>> 
>>>>>>>>>>> sigh? chain command does take device as argument, device must always
>>>>>>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
>>>>>>>>>>> above, the command should be:
>>>>>>>>>>> 
>>>>>>>>>>> chain disk0:
>>>>>>>>>>> 
>>>>>>>>>>> The disk0p1: etc will only work when partition boot code was
>>>>>>>>>>> installed (which you most likely do not have - the only possible
>>>>>>>>>>> candidate could be FreeBSD ZFS partition).        
>>>>>>>>>> 
>>>>>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
>>>>>>>>>> partition scheme, but with PMBR bootblock installed and freebsd-boot
>>>>>>>>>> partition conatining gptzfsboot installed.
>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>>> 
>>>>>>>>>>>>> 
>>>>>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
>>>>>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from
>>>>>>>>>>>>> disk0p2: and execute it; stage1 would detect FreeBSD ZFS from
>>>>>>>>>>>>> disk0p4: and load and execute /boot/loader. If that will happen,
>>>>>>>>>>>>> it means the boot code in our stages is just fine, but the bios
>>>>>>>>>>>>> (CSM) does not load pmbr?.  if thats true, it would mean that you
>>>>>>>>>>>>> either need to use UEFI boot or need to have some hack to fool
>>>>>>>>>>>>> the BIOS or just not use GPT on that machine with CSM.          
>>>>>>>>>>>> 
>>>>>>>>>>>> To make it clear here: The only way to boot this box is using CSM
>>>>>>>>>>>> (as it is the same with the ASRock boards mentioned earlier). But
>>>>>>>>>>>> my intention is to disable CSM and use a GPT/UEFI environment
>>>>>>>>>>>> only! And GPT/UEFI doesn't work with FreeBSD, neither with
>>>>>>>>>>>> 12-CURRENT, nor 11.2-RELENG.
>>>>>>>>>>>> 
>>>>>>>>>>>> It would be nice if this could be fixed. I'm more interested in the
>>>>>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
>>>>>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
>>>>>>>>>>>> byproduct, I'd appreciate that.
>>>>>>>>>>>> 
>>>>>>>>>>>> Kind regards,
>>>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
>>>>>>>>>>> that the UEFI boot fails when the first partition starts from sector
>>>>>>>>>>> 40 - does it mean you have boot when the partition will start from
>>>>>>>>>>> some other sector? I think, there is something else going
>>>>>>>>>>> on.        
>>>>>>>>>> 
>>>>>>>>>> Well, I simply try to describe what I "see" to make things
>>>>>>>>>> disambiguous. I'm not familiar with the deeper insights of disk
>>>>>>>>>> layouts on a binary level. So, you explained to me the reason, why
>>>>>>>>>> ESP (EGI partition) starts at block 40. I compared that to the
>>>>>>>>>> FreeBSD USB flash image FreeBSD provides, but this is another story
>>>>>>>>>> since the image uses MBR scheme as I figured out.
>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>>> 
>>>>>>>>>>> What you can do is to see if that firmware will offer you EFI shell
>>>>>>>>>>> option, from there you can try to start the bootx64.efi manually and
>>>>>>>>>>> see what error you will get. However, the number 1 cause for failing
>>>>>>>>>>> to start the bootloader in UEFI is secure boot - we do not support
>>>>>>>>>>> it and secure boot must be switched off. 
>>>>>>>>>>> 
>>>>>>>>>>> However, they seem to claim "The Secure Boot option is available in
>>>>>>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is disabled by
>>>>>>>>>>> default.? 
>>>>>>>>>>> 
>>>>>>>>>>> Still suggest to double check if thats really the case. Also, if the
>>>>>>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
>>>>>>>>>>> then either there is something in firmware logs or you could get
>>>>>>>>>>> them from trying to start bootx64.efi from UEFI shell.        
>>>>>>>>>> 
>>>>>>>>>> Since I'm with this problem since 2014 and try from time to time, be
>>>>>>>>>> ausred that I tried every possible permutationof all reasonable
>>>>>>>>>> options, even those nonsense, to get rid of that problem.
>>>>>>>>>> 
>>>>>>>>>> I never had any problems with any other UEFI capable
>>>>>>>>>> server/workstation firmware so far booting FreeBSD off in
>>>>>>>>>> UEFI-native (GPT partition scheme, CSM disabled) so far - until now,
>>>>>>>>>> when I ran into this Fujitsu ESPRIMO Q956 with the most recent
>>>>>>>>>> firmware (as of lat week, week 29 of 2018) having the very same
>>>>>>>>>> problems. 
>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> 
>>>>>>>>>> I figured out something strange on the Fujitsu - and that is the same
>>>>>>>>>> with the ASRock boards.
>>>>>>>>>> 
>>>>>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
>>>>>>>>>> appliance, but nevertheless, the USB flash device is booted on
>>>>>>>>>> Fujitsu servers with UEFI-only configurations. I assume at this
>>>>>>>>>> point that disabling on the most recent Fujitsu firmwares on
>>>>>>>>>> reasonable "new" hardware (not older than three years) will disable
>>>>>>>>>> any(!) legacy BIOS capabilities. The same is assumed for the Fujitus
>>>>>>>>>> ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
>>>>>>>>>> mentioned above/earlier, they are from 2012/2013 and "quite old".
>>>>>>>>>> 
>>>>>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition.
>>>>>>>>>> The partition scheme of the flash device is GPT. The layout looks
>>>>>>>>>> like this:
>>>>>>>>>> 
>>>>>>>>>> gpart show -l da4        
>>>>>>>>>> =>      40  15425456  da4  GPT  (7.4G)        
>>>>>>>>>>    40      2000    1  efiboot0  (1.0M)
>>>>>>>>>>  2040   1453584    3  disk1a  (710M)
>>>>>>>>>> 1455624      4096    5  disk3  (2.0M)
>>>>>>>>>> 1459720  13965776       - free -  (6.7G)
>>>>>>>>>> 
>>>>>>>>>> I created the flash with md, gpart and dd straightforward, efiboot0
>>>>>>>>>> is the ESP partition and its format/content is created via dd
>>>>>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
>>>>>>>>>> 
>>>>>>>>>> This USB flash device boots(!) successfully (UEFI!) on both the
>>>>>>>>>> ASRock boards and the Esprimo Q956!
>>>>>>>>>> 
>>>>>>>>>> But any SSD prepared the same way doesn't. Why? 
>>>>>>>>>> 
>>>>>>>>>> On the ASRock, I recall having fiddled around with HDD also for a
>>>>>>>>>> while conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD
>>>>>>>>>> - I can't remember. 
>>>>>>>>>> 
>>>>>>>>>> In the lack of proper hardware I'm unable to check whether
>>>>>>>>>> USB-attached HDD or SSD will boot or HDD will boot (just in case the
>>>>>>>>>> local SATA has problems booting UEFI and USB not).
>>>>>>>>>> 
>>>>>>>>>> Kind regards,
>>>>>>>>>> 
>>>>>>>>>> Oliver 
>>>>>>>>>> 
>>>>>>>>> 
>>>>>>>>> Am. well. I think the suggestion to test out FAT32 is still good one
>>>>>>>>> to test. This is because it is known that some vendors do not support
>>>>>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
>>>>>>>>> specification does not tell which FAT must be supported, and only hint
>>>>>>>>> about FAT12/FAT16 in context of removable devices).      
>>>>>>>> 
>>>>>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
>>>>>>>> took me a time to circumvent the installer and I had to install the
>>>>>>>> system manually. In that strain, I also "tried" to establish the ESP
>>>>>>>> with FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc
>>>>>>>> help how to find out the format (FAT12/16/32) of the ESP, so I assume
>>>>>>>> when using 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and
>>>>>>>> GPT (UEFI) (only!) the resulting ESP is FAT12 or FAT16 (300mb by
>>>>>>>> default). I also assume, that when dd'ing the /boo/boot1.efifat image
>>>>>>>> to a partition, the format is FAT, but not FAT32. Therefore, I
>>>>>>>> refomatted the manually created ESP (using "gpart add -t efi ...")
>>>>>>>> using "newfs_msdos -F 32 -b xxx ...". I had to fiddle around a bit
>>>>>>>> with option -b to fit in a proper format to meet a 512mb ESP - I'm not
>>>>>>>> sure whether this is the proper option to deal with. When using the
>>>>>>>> default and only -F32, the size of the partition has to be 4G at least
>>>>>>>> I assume. Having done that, I copied the the content of boot1.efifat
>>>>>>>> (mdconfig -t vnode ..., I guess we know the drill ...) to the newly
>>>>>>>> formatted ESP to /boot/efi/ ...
>>>>>>>> 
>>>>>>>> Having so far no knowledge of how to asure that the created ESP is
>>>>>>>> FAT32, I assume it is FAT32.
>>>>>>>> 
>>>>>>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
>>>>>>>> box is not willing to boot from SSD with the ESP prepared as decribed.
>>>>>>>> So, a chance that this might still be due to a misconfiguration lies
>>>>>>>> now within the -b option of newfs_msdos - if the -b option is assumed
>>>>>>>> the proper option?
>>>>>>>> 
>>>>>>>> At the moment, the ESP of the Esprimo is subject to changes, if you
>>>>>>>> wish, but not in size, since it is limited to 512mb.
>>>>>>>> 
>>>>>>>> Thanks and kind regards,
>>>>>>>> 
>>>>>>>> Oliver      
>>>>>>> 
>>>>>>> Yea, i was hoping fstyp command would report the FAT type, but it does
>>>>>>> not (request for feature?:)      
>>>>>> 
>>>>>> FYI, the file(1) command is very good at disecting a disk image to tell
>>>>>> you what the MBR looks like, and at looking at partitions if pointed at
>>>>>> them with the -s option.  It should be able to detect FAT12/16/32.
>>>>>> 
>>>>>> root at x230a:/home/ISO/x # file -s /dev/md2s1
>>>>>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ",
>>>>>> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
>>>>>> sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS
>>>>>> ", FAT (12 bit), followed by FAT
>>>>>> 
>>>>>>> 
>>>>>>> However, the more annoying idea would be to install some OS which will
>>>>>>> boot with UEFI on this machine, then copy boot1.efi from freebsd to it
>>>>>>> (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in
>>>>>>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do
>>>>>>> not support EFI32.
>>>>>>> 
>>>>>>> note that boot1.efi alone will not do much but printing on screen how it
>>>>>>> will search for freebsd, but for the purpose of the test it would
>>>>>>> suffice
>>>>>>> - that would give us confirmed working ESP file system (since the other
>>>>>>> os would be able to boot) and then we can confirm if boot1.efi itself is
>>>>>>> OK.      
>>>>>> 
>>>>> 
>>>>> Some new results.
>>>>> I installed RedHat 7.5 and inestigated the ESP.
>>>>> 
>>>>> - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
>>>>> - size is both 200mb if installed automatically. I forgit to investigate
>>>>> the FAT format, but this might be unnecessary as shown further in this
>>>>> post.
>>>>> - RedHat's ESP contains ~ 10 MB of data in two
>>>>> folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
>>>>> RedHat's doesn't change anything, also renaming /efi/boot/fbx64.efi of
>>>>> RedHat's installation. But renaming /efi/redhat renders RedHat to fail the
>>>>> boot process on the Fujitsu with the signs of the built-in testprogram as
>>>>> reported.
>>>>> 
>>>>> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot
>>>>> only (CSM in firmware disabled, but there is still a gptzfsboot-prepared
>>>>> partition for later use, just for the record). Booting UEFI-only fails as
>>>>> reported. On this installation I copied the RedHat ESP completely into
>>>>> FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh
>>>>> and copied FreeBSD's BOOTX64.efi to /efi/boot. 
>>>>> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
>>>>> the /efi/redhat folder of the ESP is important, if renamed, the whole
>>>>> process dies as I reported earlier.
>>>>> 
>>>>> Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB
>>>>> flash booting with CSM disabled (so asumingly UEFI only then) on both
>>>>> ASRock and Fujitsu (as described in more detail initially and earlier),
>>>>> while SSDs fail? Is there a difference? Since FreeBSD boots in UEFI mode
>>>>> from USB flash prepared as described (straight forward, 800k ESP starting
>>>>> at block 40, the boot1.efifat image dd'ed onto the partition, UFS
>>>>> partition following, no freebsd-boot partition or MBR/PMBR bootcode
>>>>> applied ever!), I think BOOTX64.EFI is technically all right. There must
>>>>> be then an issue with the SATA/SSD/HDD boot pathway.
>>>>> 
>>>>> Hope I could provide some more details, sorry if it sounds confusing or
>>>>> way too long, but I try to descibe the situation as thorough as possible.
>>>>> 
>>>> 
>>>> OK, this is already good hint. The thing with ESP is that there is
>>>> ?default? file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as
>>>> default for *removable* media, fortunately it is usable for hard disks as
>>>> well, or at least in most cases.
>>>> 
>>>> Now, for non-removable media, the UEFI does provide boot manager interface
>>>> to define boot entries, and the fact that renaming efi/redhad directory did
>>>> break the redhat boot, is very loud hint. And this means, this system is
>>>> probably ignoring efi/boot tree on non-removable media and is expecting the
>>>> boot manager entry to be created instead.  
>>> 
>>> This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956 firmware
>>> (not tested on ASRock Z77-Pro4 firmware).
>>> 
>>>> 
>>>> UEFI boot manager can be configured /usually/ manually via firmware menu,
>>>> or by application, such as efibootmgr. The normal approach is to create
>>>> efi/<vendorname> directory and to copy the application there, then create
>>>> the boot manager configuration.
>>>> 
>>>> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
>>>> 
>>>> What is different in FreeBSD case is that the whole interface to program
>>>> the UEFI Boot Manager is currently being developed, so either it has to be
>>>> done manually or from some other OS (see
>>>> https://wiki.gentoo.org/wiki/Efibootmgr
>>>> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from
>>>> google:D).  
>>> 
>>> Well, thanks for this important hint! FreeBSD 12-CURRENT's and FreeBSD
>>> 11.2-RELENG's USB flash devices are capable of booting off on Fujitsu's
>>> ESPRIMO and ASRock's boards. As a note: after "kldload efirt.ko" I was able
>>> to use the already in FreeBSD present toolset efibootmgr(8) and sibblings
>>> (the tools do not do anything useful when booted non-UEFI).
>>> 
>>> Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and following
>>> the steps in the examples and having created /efi/freebsd/BOOTx64.efi as
>>> recommended by copy from /efi/boot, let me create a proper boot variable.
>>> 
>>> To make things sure, I also applied "efibootmgr -a VARIABLENAME".
>>> 
>>> And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do not know
>>> whether this will also work with FAT12/16, I should test this case, too.
>>> 
>>> There is a bug in the manpage of efibootmg(8). It does not explain the
>>> options -d and -p, although they could be "implied" by reading carefully.
>>> There is now a PR at 
>>> 
>>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080
>>> 
>>> for this issue.
>>> 
>>> So, it's apity that the handbook has no note I could easily find on this; 
>>> 
>>> Thank you very much for your patience and help!
>>> 
>>> Kind regards,
>>> Oliver  
>> 
>> yep, efibootmgr does call UEFI RuntimeServices to set up the variables, and
>> this is only possible when booted UEFI. But glad we finally found the root
>> cause. It would be good to have HW notes for such cases, it is important to
>> know that those systems wont boot UEFI from HDD unless the boot manager setup
>> is done.
>> 
>> rgds,
>> toomas
> 
> 
> This pops up the question how to deal with such HW. We have as a institution a
> lot of Fujitsu hardware her - from larger servers down to Fujitsu ESPRIMO Q956.
> The latter one is the first (and so far the only) piece of hardware I found
> incapable of booting off UEFI within the past 5 years.
> 
> If the "standard" for removeable devices is to boot from /efi/boot/bootx64.efi,
> than I'd guess it is good luck for FreeBSD that the firmware vendors did
> fallback to such a mechanism. GRUB/Linux seem to install by default their
> bootloader into /efi/something/ I'll check on Debian, Suse and CentOS so far
> soon, the latter probably will, since its the "free" RedHat).
> 
> Anyway, apart from any criticism, I'm glad to have the tools to make things
> work without using alien help (outside FreeBSD's world!). That is a thank you
> towards the developers.
> 
> Kind regards,
> 
> oh
> 

The efibootmgr is only relatively recent addition (in illumos we do not have yet even access to UEFI RS), so it is only question of time once installer will get updated:)

But of course there is still an issue about the scenario when the install is done in BIOS mode and later switched to UEFI - then the boot manager configuration needs to be updated manually (or by some maintenance service like grub2 is calling via grub-install script).

rgds,
toomas


From lwhsu at FreeBSD.org  Fri Jul 27 14:43:55 2018
From: lwhsu at FreeBSD.org (Li-Wen Hsu)
Date: Fri, 27 Jul 2018 14:43:55 +0000
Subject: svn commit: r336751 - head/usr.sbin/pw
In-Reply-To: <201807262003.w6QK3B7E026934@repo.freebsd.org>
References: <201807262003.w6QK3B7E026934@repo.freebsd.org>
Message-ID: <20180727144355.GA47251@freefall.freebsd.org>

On Thu, Jul 26, 2018 at 20:03:11 +0000, Ian Lepore wrote:
> Author: ian
> Date: Thu Jul 26 20:03:11 2018
> New Revision: 336751
> URL: https://svnweb.freebsd.org/changeset/base/336751
> 
> Log:
>   Re-apply r336625 which was reverted with r336638, now that the underlying
>   pw_scan(3) has been fixed in a way that doesn't perturb other callers of
>   it or the getpwnam(3) family.
>   
>   Make pw(8) showuser work the same with or without -R <path> for non-root
>   users.  Without -R, pw(8) uses getpwnam(3), which will open master.passwd
>   for the root user or passwd for non-root users.  With -R <path> pw(8) was
>   always opening <path>/master.passwd, which would fail for a non-root user,
>   then falsely claim the userid you're trying to show doesn't exist.
>   
>   Now for a non-root user it opens <path>/passwd, and populates the fields in
>   the returned struct passwd which aren't present in that file with well-known
>   canonical values, which duplicates the behavior of getpwnam(3).  The net
>   effect is that the showuser output is identical whether using -R or not.
> 
> Modified:
>   head/usr.sbin/pw/pw_vpw.c

Hi Ian,

It seems usr.sbin.pw.* tests are failing after this commit:

https://ci.freebsd.org/job/FreeBSD-head-amd64-test/8367/testReport/

Can you help me check this is realted to the new pw code or there is
anything we need to modify in the test VM setup or running environment.

The related artifacts are available here:

https://artifact.ci.freebsd.org/snapshot/head/r336751/amd64/amd64/

You can use disk-test.img.xz which is a VM with setup testing
environment.  The build script will start automatically but you can
ctrl-c to interrupt anytime and run tests by hand:

cd /usr/tests/usr.sbin/pw
kyua test


Thanks,
Li-Wen


-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From ian at freebsd.org  Fri Jul 27 15:22:26 2018
From: ian at freebsd.org (Ian Lepore)
Date: Fri, 27 Jul 2018 09:22:15 -0600
Subject: svn commit: r336751 - head/usr.sbin/pw
In-Reply-To: <20180727144355.GA47251@freefall.freebsd.org>
References: <201807262003.w6QK3B7E026934@repo.freebsd.org>
 <20180727144355.GA47251@freefall.freebsd.org>
Message-ID: <1532704935.61594.42.camel@freebsd.org>

On Fri, 2018-07-27 at 14:43 +0000, Li-Wen Hsu wrote:
> On Thu, Jul 26, 2018 at 20:03:11 +0000, Ian Lepore wrote:
> > 
> > Author: ian
> > Date: Thu Jul 26 20:03:11 2018
> > New Revision: 336751
> > URL: https://svnweb.freebsd.org/changeset/base/336751
> > 
> > Log:
> > ? Re-apply r336625 which was reverted with r336638, now that the underlying
> > ? pw_scan(3) has been fixed in a way that doesn't perturb other callers of
> > ? it or the getpwnam(3) family.
> > ??
> > ? Make pw(8) showuser work the same with or without -R  for non-root
> > ? users.??Without -R, pw(8) uses getpwnam(3), which will open master.passwd
> > ? for the root user or passwd for non-root users.??With -R  pw(8) was
> > ? always opening /master.passwd, which would fail for a non-root user,
> > ? then falsely claim the userid you're trying to show doesn't exist.
> > ??
> > ? Now for a non-root user it opens /passwd, and populates the fields in
> > ? the returned struct passwd which aren't present in that file with well-known
> > ? canonical values, which duplicates the behavior of getpwnam(3).??The net
> > ? effect is that the showuser output is identical whether using -R or not.
> > 
> > Modified:
> > ? head/usr.sbin/pw/pw_vpw.c
> Hi Ian,
> 
> It seems usr.sbin.pw.* tests are failing after this commit:
> 
> https://ci.freebsd.org/job/FreeBSD-head-amd64-test/8367/testReport/
> 
> Can you help me check this is realted to the new pw code or there is
> anything we need to modify in the test VM setup or running environment.
> 
> The related artifacts are available here:
> 
> https://artifact.ci.freebsd.org/snapshot/head/r336751/amd64/amd64/
> 
> You can use disk-test.img.xz which is a VM with setup testing
> environment.??The build script will start automatically but you can
> ctrl-c to interrupt anytime and run tests by hand:
> 
> cd /usr/tests/usr.sbin/pw
> kyua test

This was just an error on my part, the code was wrong and I fixed it in
r336762. This time I made sure the kyua tests pass first.

I had intended to run the kyua tests before and after re-applying my
changes to pw(8). Now that I look in my scrollback, it seems I ran the
"before" tests, then got distracted and forgot to run them again after
and just committed the changes. Sorry about the breakage.

-- Ian


From jhb at FreeBSD.org  Fri Jul 27 15:23:26 2018
From: jhb at FreeBSD.org (John Baldwin)
Date: Fri, 27 Jul 2018 08:23:22 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
 <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
 <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>
 <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>
Message-ID: <d57c97fc-f9dc-37c9-09fe-66ca6f72e344@FreeBSD.org>

On 7/27/18 12:12 AM, Mark Millard wrote:
> I was looking too locally: the overall context has an outer #if
> as well that skips the section:
> 
> /*
>  * Keywords added in C11.
>  */
>  
> #if !defined(__STDC_VERSION__) || __STDC_VERSION__ < 201112L
> . . .
> #if !defined(__cplusplus) && !__has_extension(c_atomic) && \
>     !__has_extension(cxx_atomic)
> /*
>  * No native support for _Atomic(). Place object in structure to prevent
>  * most forms of direct non-atomic access.
>  */
> #define _Atomic(T)              struct { T volatile __val; }
> #endif
> . . .
> #endif /* __STDC_VERSION__ || __STDC_VERSION__ < 201112L */

Yes.  It also means that if we didn't ship the compiler's stdatomic.h and
tried to build with -std=gnu11 or -std=c11 the compile would break.

Rather than requiring c11, another approach might be to fix sys/cdefs.h
and sys/stdatomic.h to actually work with modern GCC by having them not
use the struct for the _GCC_ATOMICS case, only for the _SYNC case.

I think that would fix all of the cases.

-- 
John Baldwin

From marklmi at yahoo.com  Fri Jul 27 15:52:27 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Fri, 27 Jul 2018 08:52:13 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
 <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
 <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>
 <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>
Message-ID: <ECEF39B4-4A40-42C6-8A17-B989D23C7C3C@yahoo.com>



On 2018-Jul-27, at 12:12 AM, Mark Millard <marklmi at yahoo.com> wrote:

On 2018-Jul-26, at 11:29 PM, Mark Millard <marklmi at yahoo.com> wrote:

> . . .
> I was looking too locally: the overall context has an outer #if
> as well that skips the section:
> 
> /*
> * Keywords added in C11.
> */
> 
> #if !defined(__STDC_VERSION__) || __STDC_VERSION__ < 201112L
> . . .
> #if !defined(__cplusplus) && !__has_extension(c_atomic) && \
>    !__has_extension(cxx_atomic)
> /*
> * No native support for _Atomic(). Place object in structure to prevent
> * most forms of direct non-atomic access.
> */
> #define _Atomic(T)              struct { T volatile __val; }
> #endif
> . . .
> #endif /* __STDC_VERSION__ || __STDC_VERSION__ < 201112L */
> 
> 
> 
> 
> The build with gcc's float.h also removed did complete instead of
> stopping early.
> 
> 
> 
> As for what x86_64-unknown-freebsd12.0 .h files were used:
> (some may do include_next back into FreeBSD headers)
> 
> 
> # find /usr/obj/amd64_xtoolchain-gcc/ -name "*.meta" -exec grep "^R .*/x86_64-unknown-freebsd12.0/.*\.h" {} \; | sort -k 3 | uniq -f 2 | more
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/adxintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ammintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx2intrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512bwintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512cdintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512dqintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512erintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512fintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmaintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmavlintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512pfintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmiintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmivlintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlbwintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vldqintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avxintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmi2intrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmiintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clflushoptintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clwbintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clzerointrin.h
> R 56022 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/cpuid.h
> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/emmintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/f16cintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fma4intrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fmaintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fxsrintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ia32intrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/immintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lwpintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lzcntintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm3dnow.h
> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm_malloc.h
> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mmintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mwaitxintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pkuintrin.h
> R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pmmintrin.h
> R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/popcntintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/prfchwintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rdseedintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rtmintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/shaintrin.h
> R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/smmintrin.h
> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdarg.h
> R 27622 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdbool.h
> R 10025 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
> R 68604 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdnoreturn.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tbmintrin.h
> R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tmmintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/wmmintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/x86intrin.h
> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xmmintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xopintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavecintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveoptintrin.h
> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavesintrin.h
> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xtestintrin.h

FYI: a devel/powerpc64-gcc amd64 -> powerpc64 cross build completed (lib32 build
disabled for other reasons). [ ci.freebsd.org only tries amd64-gcc based .]

For reference:
(some may do include_next back into FreeBSD headers)

# find /usr/obj/powerpc64vtsc_xtoolchain-gcc-no_toolchain/ -name "*.meta" -exec grep "^R .*/.*-unknown-freebsd12.0/.*/include/" {} \; | sort -k 3 | uniq -f 2 | more
R 1003 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/float.h
R 10005 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdarg.h
R 38468 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
R 10001 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdbool.h
R 10050 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stddef.h
R 10000 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdint.h
R 74283 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdnoreturn.h



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From marklmi at yahoo.com  Fri Jul 27 15:58:27 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Fri, 27 Jul 2018 08:58:14 -0700
Subject: head -r336568 and -r336570 appears to have made ci.freebsg.org's
 FreeBSD-head-amd64-gcc fail either than it had been (error: operand
 type 'struct <anonymous> *' is incompatible with argument 1 of
 '__atomic_fetch_add')
In-Reply-To: <ECEF39B4-4A40-42C6-8A17-B989D23C7C3C@yahoo.com>
References: <AED126D8-AFB9-4BF6-81AF-A3CE5F16D2AB@yahoo.com>
 <EDDB87CC-3CC6-4A71-AF6D-B193F26BB692@yahoo.com>
 <95fdbf29-6c11-77a6-27a3-2d0dc30f1668@FreeBSD.org>
 <788B1EE7-EFC9-4AD4-9FD1-9876D0121189@yahoo.com>
 <9D40F38E-F1DC-4A3F-8792-09AD30D8802B@yahoo.com>
 <D06CD69A-F0E5-4935-8B64-D1ADB7B6D90A@yahoo.com>
 <1ea2a8d0-b27a-503a-0a8b-48d7fbcd8fcb@FreeBSD.org>
 <0103123A-2D77-4D64-8FF6-97CD521CA7A8@yahoo.com>
 <11b515f2-5777-f983-bec5-e60bceda06ab@FreeBSD.org>
 <6DB0B921-30C8-4BF5-B610-770C0CBF1174@yahoo.com>
 <E3CFA058-D879-4E25-A8BA-C052803AE509@yahoo.com>
 <462BE582-0C2E-4D40-92F3-A27155777E58@yahoo.com>
 <1E03ECE7-297C-4D40-BC58-FB1903538181@yahoo.com>
 <ECEF39B4-4A40-42C6-8A17-B989D23C7C3C@yahoo.com>
Message-ID: <8E61EA21-2DBE-4DED-A7E6-CCE4C79D0359@yahoo.com>

On 2018-Jul-27, at 8:52 AM, Mark Millard <marklmi atyahoo.com> wrote:

> On 2018-Jul-27, at 12:12 AM, Mark Millard <marklmi at yahoo.com> wrote:
> 
> On 2018-Jul-26, at 11:29 PM, Mark Millard <marklmi at yahoo.com> wrote:
> 
>> . . .
>> I was looking too locally: the overall context has an outer #if
>> as well that skips the section:
>> 
>> /*
>> * Keywords added in C11.
>> */
>> 
>> #if !defined(__STDC_VERSION__) || __STDC_VERSION__ < 201112L
>> . . .
>> #if !defined(__cplusplus) && !__has_extension(c_atomic) && \
>>   !__has_extension(cxx_atomic)
>> /*
>> * No native support for _Atomic(). Place object in structure to prevent
>> * most forms of direct non-atomic access.
>> */
>> #define _Atomic(T)              struct { T volatile __val; }
>> #endif
>> . . .
>> #endif /* __STDC_VERSION__ || __STDC_VERSION__ < 201112L */
>> 
>> 
>> 
>> 
>> The build with gcc's float.h also removed did complete instead of
>> stopping early.
>> 
>> 
>> 
>> As for what x86_64-unknown-freebsd12.0 .h files were used:
>> (some may do include_next back into FreeBSD headers)
>> 
>> 
>> # find /usr/obj/amd64_xtoolchain-gcc/ -name "*.meta" -exec grep "^R .*/x86_64-unknown-freebsd12.0/.*\.h" {} \; | sort -k 3 | uniq -f 2 | more
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/adxintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ammintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx2intrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512bwintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512cdintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512dqintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512erintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512fintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmaintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512ifmavlintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512pfintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmiintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vbmivlintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlbwintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vldqintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avx512vlintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/avxintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmi2intrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/bmiintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clflushoptintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clwbintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/clzerointrin.h
>> R 56022 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/cpuid.h
>> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/emmintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/f16cintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fma4intrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fmaintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/fxsrintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/ia32intrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/immintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lwpintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/lzcntintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm3dnow.h
>> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mm_malloc.h
>> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mmintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/mwaitxintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pkuintrin.h
>> R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/pmmintrin.h
>> R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/popcntintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/prfchwintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rdseedintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/rtmintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/shaintrin.h
>> R 1485 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/smmintrin.h
>> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdarg.h
>> R 27622 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
>> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdbool.h
>> R 10025 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stddef.h
>> R 10000 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdint.h
>> R 68604 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/stdnoreturn.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tbmintrin.h
>> R 1336 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/tmmintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/wmmintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/x86intrin.h
>> R 1222 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xmmintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xopintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavecintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsaveoptintrin.h
>> R 1595 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xsavesintrin.h
>> R 1520 /usr/local/lib/gcc/x86_64-unknown-freebsd12.0/6.4.0/include/xtestintrin.h
> 
> FYI: a devel/powerpc64-gcc amd64 -> powerpc64 cross build completed (lib32 build
> disabled for other reasons). [ ci.freebsd.org only tries amd64-gcc based .]
> 
> For reference:
> (some may do include_next back into FreeBSD headers)
> 
> # find /usr/obj/powerpc64vtsc_xtoolchain-gcc-no_toolchain/ -name "*.meta" -exec grep "^R .*/.*-unknown-freebsd12.0/.*/include/" {} \; | sort -k 3 | uniq -f 2 | more
> R 1003 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/float.h
> R 10005 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdarg.h
> R 38468 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdatomic.h
> R 10001 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdbool.h
> R 10050 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stddef.h
> R 10000 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdint.h
> R 74283 /usr/local/lib/gcc/powerpc64-unknown-freebsd12.0/6.4.0/include/stdnoreturn.h

I forgot to write for the powerpc64-gcc case:

The build had no system clang or gcc 4.2.1 toolchain built either: it is one I use for
base/{binutils,gcc} experiments (when I have access to the hardware).

So this avoided the altivec.h potential issue in building the clang related materials
for powerpc64.


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


===
Mark Millard
marklmi at yahoo.com
( dsl-only.net <http://dsl-only.net/> went
away in early 2018-Mar)


From ohartmann at walstatt.org  Fri Jul 27 17:06:13 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Fri, 27 Jul 2018 19:05:28 +0200
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <2A5E5E42-8595-44E9-A51E-504C9C2C7FA7@me.com>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
 <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
 <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>
 <2A5E5E42-8595-44E9-A51E-504C9C2C7FA7@me.com>
Message-ID: <20180727190555.55439fb3@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Fri, 27 Jul 2018 13:59:44 +0300
Toomas Soome <tsoome at me.com> schrieb:

> > On 27 Jul 2018, at 13:02, O. Hartmann <ohartmann at walstatt.org> wrote:
> > 
> > On Fri, 27 Jul 2018 08:54:48 +0300
> > Toomas Soome <tsoome at me.com> wrote:
> >   
> >>> On 27 Jul 2018, at 08:46, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>> 
> >>> On Thu, 26 Jul 2018 19:23:43 +0300
> >>> Toomas Soome <tsoome at me.com> wrote:
> >>> 
> >>> (reply inline/at the end)
> >>> 
> >>>   
> >>>>> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>> 
> >>>>> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
> >>>>> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
> >>>>> <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote:     
> >>>>>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org> wrote:
> >>>>>>>> 
> >>>>>>>> On Wed, 25 Jul 2018 11:46:07 +0300
> >>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>>   
> >>>>>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org> wrote:
> >>>>>>>>>> 
> >>>>>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
> >>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>>>> 
> >>>>>>>>>> 
> >>>>>>>>>> Hello  Toomas Soome,
> >>>>>>>>>> 
> >>>>>>>>>> I CC Allan Jude since I discovered something  weird today regarding
> >>>>>>>>>> the UEFI boot capabilities of USB flash devices and SSDs. See below.
> >>>>>>>>>>   
> >>>>>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>>> wrote:
> >>>>>>>>>>>> 
> >>>>>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> >>>>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> >>>>>>>>>>>>   
> >>>>>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <ohartmann at walstatt.org>
> >>>>>>>>>>>>>> wrote:
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> >>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>> wrote:
> >>>>>>>>>>>>>>   
> >>>>>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <o.hartmann at walstatt.org
> >>>>>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> >>>>>>>>>>>>>>>> Hash: SHA512
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> >>>>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> >>>>>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>>
> >>>>>>>>>>>>>>>> schrieb:             
> >>>>>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann
> >>>>>>>>>>>>>>>>>> <ohartmann at walstatt.org> wrote:
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot problems
> >>>>>>>>>>>>>>>>>> on GPT drives where the first partition begins at block 40
> >>>>>>>>>>>>>>>>>> of the hdd/ssd.
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> I have two host in private use based on an
> >>>>>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard (IvyBridge,
> >>>>>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the lates
> >>>>>>>>>>>>>>>>>> official available AMI firmware revision, dating to 2013.
> >>>>>>>>>>>>>>>>>> This is for the Z77-Pro4-M revision 2.0 (2013/7/23) and for
> >>>>>>>>>>>>>>>>>> the Z77 Pro4 revision 1.8 (2013/7/17). For both boards a
> >>>>>>>>>>>>>>>>>> BETA revision for the Spectre/Meltdown mitigation is
> >>>>>>>>>>>>>>>>>> available, but I didn't test that. But please read.
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> The third box I realised this problem is a brand new Fujitsu
> >>>>>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R 1.26.0 for
> >>>>>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via
> >>>>>>>>>>>>>>>>>> bsdinstall the OS using UEFI-only boot method on a GPT
> >>>>>>>>>>>>>>>>>> partitioned device fails. The ASRock boards jump immediately
> >>>>>>>>>>>>>>>>>> into the firmware, the Fujitsu offers some kind of
> >>>>>>>>>>>>>>>>>> CPU/Memory/HDD test facility.
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and UEFI
> >>>>>>>>>>>>>>>>>> boot only is implied, the MBR partitioned FreeBSD
> >>>>>>>>>>>>>>>>>> installation USB flash device does boot in UEFI! I guess I
> >>>>>>>>>>>>>>>>>> can assume this when the well known clumsy 80x25 char
> >>>>>>>>>>>>>>>>>> console suddenly gets bright and shiny with a much higher
> >>>>>>>>>>>>>>>>>> resoltion as long the GPU supports EFI GOP. Looking with
> >>>>>>>>>>>>>>>>>> gpart at the USB flash drives reveals that the EFI partition
> >>>>>>>>>>>>>>>>>> starts at block 1 of the device and the device has a MBR
> >>>>>>>>>>>>>>>>>> layout. I haven't found a way to force the GPT scheme, when
> >>>>>>>>>>>>>>>>>> initialised via gpart, to let the partitions start at block
> >>>>>>>>>>>>>>>>>> 1. This might be a naiv thinking, so please be patient with
> >>>>>>>>>>>>>>>>>> me.
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On the
> >>>>>>>>>>>>>>>>>> ASRock boards, I tried years ago some LinuxRed Hat and Suse
> >>>>>>>>>>>>>>>>>> with UEFI and that worked - FreeBSD not. I gave up on that
> >>>>>>>>>>>>>>>>>> that time. Now, having the very same issues with a new
> >>>>>>>>>>>>>>>>>> Fujitsu system, leaves me with the impression that FreeBSD's
> >>>>>>>>>>>>>>>>>> UEFI implementation might have problems I'm not aware of.
> >>>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>>> Can someone shed some light onto this? 
> >>>>>>>>>>>>>>>>>>   
> >>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>> The first thing to check is if the secure boot is disabled. We
> >>>>>>>>>>>>>>>>> do not support secure boot at all at this time.                
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> Secure boot is in every scenario disabled!
> >>>>>>>>>>>>>>>>   
> >>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>> If you have efi or bios version running - you can check from
> >>>>>>>>>>>>>>>>> either console variable value (it can have efi or vidconsole
> >>>>>>>>>>>>>>>>> or comconsole) or better yet, see if efi-version is set (show
> >>>>>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS loader
> >>>>>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with device
> >>>>>>>>>>>>>>>>> paths present, it is uefi:)                
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> What are you talking about?
> >>>>>>>>>>>>>>>> What is the point of entry - running system, loader?
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> This makes me quite sure that the system has booted via BIOS -
> >>>>>>>>>>>>>>>> as I'm sure since I've checked that many times. UEFI doesn't
> >>>>>>>>>>>>>>>> work on those systems with FreeBSD. I'm not sure antmore, but
> >>>>>>>>>>>>>>>> I tried also Windows 7 on those mainboards booting via UEFI -
> >>>>>>>>>>>>>>>> and I might recall that they failed also. I also recall that
> >>>>>>>>>>>>>>>> there were issues with earlier UEFI versions regarding booting
> >>>>>>>>>>>>>>>> only Windows 8/8.1 - and nothing else, but the fact that Linux
> >>>>>>>>>>>>>>>> worked confuses me a bit.
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> If this ASRock crap (never ever again this brand!) doesn't work
> >>>>>>>>>>>>>>>> at all - who cares, I intend to purchase new server grade
> >>>>>>>>>>>>>>>> hardware. But the more puzzling issue is with the Fujitsu,
> >>>>>>>>>>>>>>>> which I consider serious and from the behaviour the Fujitsu
> >>>>>>>>>>>>>>>> failure looks exactly like the ASRock - Windows 7 works,
> >>>>>>>>>>>>>>>> RedHat 7.5 works (I assume I can trust the Firmware settings
> >>>>>>>>>>>>>>>> when I disable CSM support, that the Firmware will only
> >>>>>>>>>>>>>>>> EFI/UEFI capable loader? Or is there a ghosty override
> >>>>>>>>>>>>>>>> somwhere to be expected?). Also on ASRock disabling CSM should
> >>>>>>>>>>>>>>>> ensure not booting a dual-bootstrap-capable system. This said,
> >>>>>>>>>>>>>>>> on the recent Fujitsu, it seems to boil down to a FreeBSD
> >>>>>>>>>>>>>>>> UEFI-firmware interaction problem, while the ASRock is still
> >>>>>>>>>>>>>>>> under suspicion to be broken by design.               
> >>>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>>> GPT partitions can never start from disk absolute sector 1;
> >>>>>>>>>>>>>>>>> this is because at sector 0 there is MBR (for compatibility),
> >>>>>>>>>>>>>>>>> sector 1 is GPT table and then sectors 2-33 have GPT
> >>>>>>>>>>>>>>>>> partition table entries, so the first possible data sector is
> >>>>>>>>>>>>>>>>> 34 (absolute 34). Thats assuming 512B sectors. For details
> >>>>>>>>>>>>>>>>> see UEFI 2.7 Chapter 5.3.1 page 131.                
> >>>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>>> Thanks for the explanation. That implies the installer did
> >>>>>>>>>>>>>>>> right, gpart did also right and therefore there must be an
> >>>>>>>>>>>>>>>> issue with the stuff located within the EFI
> >>>>>>>>>>>>>>>> partition?               
> >>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if we reach
> >>>>>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS bootstrap is
> >>>>>>>>>>>>>>> actually caring to read the MBR code and start it, since once
> >>>>>>>>>>>>>>> the MBR code is started, it is all about our code.              
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS" the CSM?
> >>>>>>>>>>>>>> or do you mean that specific portion of the UEFI firmware, which
> >>>>>>>>>>>>>> looks for the proper UEFI partition?
> >>>>>>>>>>>>>>   
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> BIOS as either native or CSM. Note that from boot code point of
> >>>>>>>>>>>>> view the CSM boot *is* BIOS boot, we have no access to UEFI
> >>>>>>>>>>>>> features.   
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> The boxes in question, most notably the more recent Fujitsu
> >>>>>>>>>>>>>> Esprimo Q956, refuse booting UEFI, even if properly setup (in
> >>>>>>>>>>>>>> terms of what FreeBSD provides on recent CURRENT) is applied and
> >>>>>>>>>>>>>> CSM is switched off in the firmware. Again: GPT partition scheme.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> The system boots properly if a second partition of type
> >>>>>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly applied via
> >>>>>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0" (ada0
> >>>>>>>>>>>>>> is the device).               
> >>>>>>>>>>>>>>> 
> >>>>>>>>>>>>>>> btw, you can try to validate the installed boot blocks by using
> >>>>>>>>>>>>>>> recent enough loader (usb or iso) and then you can use from OK
> >>>>>>>>>>>>>>> prompt:              
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> lsdev provides me with the follwoing informations (CSM enabled):
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> OK lsdev
> >>>>>>>>>>>>>> disk devices:
> >>>>>>>>>>>>>> 	disk0:		BIOS DRIVE C ...
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> 		disk0p1:	EFI
> >>>>>>>>>>>>>> 		disk0p2:	FreeBSD BOOT
> >>>>>>>>>>>>>> 		disk0p3:	FreeBSD SWAP
> >>>>>>>>>>>>>> 		disk0p4:	FreeBSD ZFS
> >>>>>>>>>>>>>> zfs devices:
> >>>>>>>>>>>>>> 	zfs:zroot
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> OK chain disk0
> >>>>>>>>>>>>>> open failed     (so for disk0p{1-4}.
> >>>>>>>>>>>>>> 
> >>>>>>>>>>>>>> OK chain zroot
> >>>>>>>>>>>>>> failed to read disk (just for completeness)              
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> chain command does use only device name (such as disk0: or
> >>>>>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I haven?t
> >>>>>>>>>>>>> ported the code to read the file.            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> ??
> >>>>>>>>>>>>   
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> the point for chain command test is to see if the normal read and
> >>>>>>>>>>>>> execute would work, so in your case please try:
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> chain disk0:            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> As stated above, I did so, and the result is also mentioned above,
> >>>>>>>>>>>> I always get "open failed".
> >>>>>>>>>>>> This is the same for 
> >>>>>>>>>>>> 
> >>>>>>>>>>>> chain disk0
> >>>>>>>>>>>> chain disk0p1
> >>>>>>>>>>>> chain disk0p2
> >>>>>>>>>>>> chain disk0p3
> >>>>>>>>>>>> chain disk0p4
> >>>>>>>>>>>> 
> >>>>>>>>>>>> as already said. CSM is enabled in this case.            
> >>>>>>>>>>> 
> >>>>>>>>>>> sigh? chain command does take device as argument, device must always
> >>>>>>>>>>> end with colon?. in this case, the devil is in details:) as I wrote
> >>>>>>>>>>> above, the command should be:
> >>>>>>>>>>> 
> >>>>>>>>>>> chain disk0:
> >>>>>>>>>>> 
> >>>>>>>>>>> The disk0p1: etc will only work when partition boot code was
> >>>>>>>>>>> installed (which you most likely do not have - the only possible
> >>>>>>>>>>> candidate could be FreeBSD ZFS partition).          
> >>>>>>>>>> 
> >>>>>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
> >>>>>>>>>> partition scheme, but with PMBR bootblock installed and freebsd-boot
> >>>>>>>>>> partition conatining gptzfsboot installed.
> >>>>>>>>>> 
> >>>>>>>>>>   
> >>>>>>>>>>>   
> >>>>>>>>>>>>   
> >>>>>>>>>>>>> 
> >>>>>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome would be
> >>>>>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from
> >>>>>>>>>>>>> disk0p2: and execute it; stage1 would detect FreeBSD ZFS from
> >>>>>>>>>>>>> disk0p4: and load and execute /boot/loader. If that will happen,
> >>>>>>>>>>>>> it means the boot code in our stages is just fine, but the bios
> >>>>>>>>>>>>> (CSM) does not load pmbr?.  if thats true, it would mean that you
> >>>>>>>>>>>>> either need to use UEFI boot or need to have some hack to fool
> >>>>>>>>>>>>> the BIOS or just not use GPT on that machine with CSM.            
> >>>>>>>>>>>> 
> >>>>>>>>>>>> To make it clear here: The only way to boot this box is using CSM
> >>>>>>>>>>>> (as it is the same with the ASRock boards mentioned earlier). But
> >>>>>>>>>>>> my intention is to disable CSM and use a GPT/UEFI environment
> >>>>>>>>>>>> only! And GPT/UEFI doesn't work with FreeBSD, neither with
> >>>>>>>>>>>> 12-CURRENT, nor 11.2-RELENG.
> >>>>>>>>>>>> 
> >>>>>>>>>>>> It would be nice if this could be fixed. I'm more interested in the
> >>>>>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock crap, but
> >>>>>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues as a
> >>>>>>>>>>>> byproduct, I'd appreciate that.
> >>>>>>>>>>>> 
> >>>>>>>>>>>> Kind regards,
> >>>>>>>>>>>>   
> >>>>>>>>>>> 
> >>>>>>>>>>> ok, somehow I have lost that part of the discussion. Well, you wrote
> >>>>>>>>>>> that the UEFI boot fails when the first partition starts from sector
> >>>>>>>>>>> 40 - does it mean you have boot when the partition will start from
> >>>>>>>>>>> some other sector? I think, there is something else going
> >>>>>>>>>>> on.          
> >>>>>>>>>> 
> >>>>>>>>>> Well, I simply try to describe what I "see" to make things
> >>>>>>>>>> disambiguous. I'm not familiar with the deeper insights of disk
> >>>>>>>>>> layouts on a binary level. So, you explained to me the reason, why
> >>>>>>>>>> ESP (EGI partition) starts at block 40. I compared that to the
> >>>>>>>>>> FreeBSD USB flash image FreeBSD provides, but this is another story
> >>>>>>>>>> since the image uses MBR scheme as I figured out.
> >>>>>>>>>> 
> >>>>>>>>>>   
> >>>>>>>>>>> 
> >>>>>>>>>>> What you can do is to see if that firmware will offer you EFI shell
> >>>>>>>>>>> option, from there you can try to start the bootx64.efi manually and
> >>>>>>>>>>> see what error you will get. However, the number 1 cause for failing
> >>>>>>>>>>> to start the bootloader in UEFI is secure boot - we do not support
> >>>>>>>>>>> it and secure boot must be switched off. 
> >>>>>>>>>>> 
> >>>>>>>>>>> However, they seem to claim "The Secure Boot option is available in
> >>>>>>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is disabled by
> >>>>>>>>>>> default.? 
> >>>>>>>>>>> 
> >>>>>>>>>>> Still suggest to double check if thats really the case. Also, if the
> >>>>>>>>>>> bootx64.efi start will fail and no messages are appearing on screen,
> >>>>>>>>>>> then either there is something in firmware logs or you could get
> >>>>>>>>>>> them from trying to start bootx64.efi from UEFI shell.          
> >>>>>>>>>> 
> >>>>>>>>>> Since I'm with this problem since 2014 and try from time to time, be
> >>>>>>>>>> ausred that I tried every possible permutationof all reasonable
> >>>>>>>>>> options, even those nonsense, to get rid of that problem.
> >>>>>>>>>> 
> >>>>>>>>>> I never had any problems with any other UEFI capable
> >>>>>>>>>> server/workstation firmware so far booting FreeBSD off in
> >>>>>>>>>> UEFI-native (GPT partition scheme, CSM disabled) so far - until now,
> >>>>>>>>>> when I ran into this Fujitsu ESPRIMO Q956 with the most recent
> >>>>>>>>>> firmware (as of lat week, week 29 of 2018) having the very same
> >>>>>>>>>> problems. 
> >>>>>>>>>> 
> >>>>>>>>>> 
> >>>>>>>>>> 
> >>>>>>>>>> I figured out something strange on the Fujitsu - and that is the same
> >>>>>>>>>> with the ASRock boards.
> >>>>>>>>>> 
> >>>>>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a very small
> >>>>>>>>>> appliance, but nevertheless, the USB flash device is booted on
> >>>>>>>>>> Fujitsu servers with UEFI-only configurations. I assume at this
> >>>>>>>>>> point that disabling on the most recent Fujitsu firmwares on
> >>>>>>>>>> reasonable "new" hardware (not older than three years) will disable
> >>>>>>>>>> any(!) legacy BIOS capabilities. The same is assumed for the Fujitus
> >>>>>>>>>> ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
> >>>>>>>>>> mentioned above/earlier, they are from 2012/2013 and "quite old".
> >>>>>>>>>> 
> >>>>>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot" partition.
> >>>>>>>>>> The partition scheme of the flash device is GPT. The layout looks
> >>>>>>>>>> like this:
> >>>>>>>>>> 
> >>>>>>>>>> gpart show -l da4          
> >>>>>>>>>> =>      40  15425456  da4  GPT  (7.4G)          
> >>>>>>>>>>    40      2000    1  efiboot0  (1.0M)
> >>>>>>>>>>  2040   1453584    3  disk1a  (710M)
> >>>>>>>>>> 1455624      4096    5  disk3  (2.0M)
> >>>>>>>>>> 1459720  13965776       - free -  (6.7G)
> >>>>>>>>>> 
> >>>>>>>>>> I created the flash with md, gpart and dd straightforward, efiboot0
> >>>>>>>>>> is the ESP partition and its format/content is created via dd
> >>>>>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very simple.
> >>>>>>>>>> 
> >>>>>>>>>> This USB flash device boots(!) successfully (UEFI!) on both the
> >>>>>>>>>> ASRock boards and the Esprimo Q956!
> >>>>>>>>>> 
> >>>>>>>>>> But any SSD prepared the same way doesn't. Why? 
> >>>>>>>>>> 
> >>>>>>>>>> On the ASRock, I recall having fiddled around with HDD also for a
> >>>>>>>>>> while conatining Windows 7/SP1 and FreeBSD. Windows7 booted, FreeBSD
> >>>>>>>>>> - I can't remember. 
> >>>>>>>>>> 
> >>>>>>>>>> In the lack of proper hardware I'm unable to check whether
> >>>>>>>>>> USB-attached HDD or SSD will boot or HDD will boot (just in case the
> >>>>>>>>>> local SATA has problems booting UEFI and USB not).
> >>>>>>>>>> 
> >>>>>>>>>> Kind regards,
> >>>>>>>>>> 
> >>>>>>>>>> Oliver 
> >>>>>>>>>>   
> >>>>>>>>> 
> >>>>>>>>> Am. well. I think the suggestion to test out FAT32 is still good one
> >>>>>>>>> to test. This is because it is known that some vendors do not support
> >>>>>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
> >>>>>>>>> specification does not tell which FAT must be supported, and only hint
> >>>>>>>>> about FAT12/FAT16 in context of removable devices).        
> >>>>>>>> 
> >>>>>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO Q956. It
> >>>>>>>> took me a time to circumvent the installer and I had to install the
> >>>>>>>> system manually. In that strain, I also "tried" to establish the ESP
> >>>>>>>> with FAT32, as Allen Jude suggested earlier. I didn't find any ad hoc
> >>>>>>>> help how to find out the format (FAT12/16/32) of the ESP, so I assume
> >>>>>>>> when using 12-CURRENT's or 11.2-RELENG's installer with AUTO-ZFS and
> >>>>>>>> GPT (UEFI) (only!) the resulting ESP is FAT12 or FAT16 (300mb by
> >>>>>>>> default). I also assume, that when dd'ing the /boo/boot1.efifat image
> >>>>>>>> to a partition, the format is FAT, but not FAT32. Therefore, I
> >>>>>>>> refomatted the manually created ESP (using "gpart add -t efi ...")
> >>>>>>>> using "newfs_msdos -F 32 -b xxx ...". I had to fiddle around a bit
> >>>>>>>> with option -b to fit in a proper format to meet a 512mb ESP - I'm not
> >>>>>>>> sure whether this is the proper option to deal with. When using the
> >>>>>>>> default and only -F32, the size of the partition has to be 4G at least
> >>>>>>>> I assume. Having done that, I copied the the content of boot1.efifat
> >>>>>>>> (mdconfig -t vnode ..., I guess we know the drill ...) to the newly
> >>>>>>>> formatted ESP to /boot/efi/ ...
> >>>>>>>> 
> >>>>>>>> Having so far no knowledge of how to asure that the created ESP is
> >>>>>>>> FAT32, I assume it is FAT32.
> >>>>>>>> 
> >>>>>>>> The result is negative on the ESPRIMO Q956. When disabling the CSM, the
> >>>>>>>> box is not willing to boot from SSD with the ESP prepared as decribed.
> >>>>>>>> So, a chance that this might still be due to a misconfiguration lies
> >>>>>>>> now within the -b option of newfs_msdos - if the -b option is assumed
> >>>>>>>> the proper option?
> >>>>>>>> 
> >>>>>>>> At the moment, the ESP of the Esprimo is subject to changes, if you
> >>>>>>>> wish, but not in size, since it is limited to 512mb.
> >>>>>>>> 
> >>>>>>>> Thanks and kind regards,
> >>>>>>>> 
> >>>>>>>> Oliver        
> >>>>>>> 
> >>>>>>> Yea, i was hoping fstyp command would report the FAT type, but it does
> >>>>>>> not (request for feature?:)        
> >>>>>> 
> >>>>>> FYI, the file(1) command is very good at disecting a disk image to tell
> >>>>>> you what the MBR looks like, and at looking at partitions if pointed at
> >>>>>> them with the -s option.  It should be able to detect FAT12/16/32.
> >>>>>> 
> >>>>>> root at x230a:/home/ISO/x # file -s /dev/md2s1
> >>>>>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID "BSD4.4  ",
> >>>>>> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
> >>>>>> sectors/track 63, heads 1, serial number 0xbd4111ee, label: "EFISYS
> >>>>>> ", FAT (12 bit), followed by FAT
> >>>>>>   
> >>>>>>> 
> >>>>>>> However, the more annoying idea would be to install some OS which will
> >>>>>>> boot with UEFI on this machine, then copy boot1.efi from freebsd to it
> >>>>>>> (the default program the UEFI will load is ESP:EFI/boot/bootx64.efi  in
> >>>>>>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However, we do
> >>>>>>> not support EFI32.
> >>>>>>> 
> >>>>>>> note that boot1.efi alone will not do much but printing on screen how it
> >>>>>>> will search for freebsd, but for the purpose of the test it would
> >>>>>>> suffice
> >>>>>>> - that would give us confirmed working ESP file system (since the other
> >>>>>>> os would be able to boot) and then we can confirm if boot1.efi itself is
> >>>>>>> OK.        
> >>>>>>   
> >>>>> 
> >>>>> Some new results.
> >>>>> I installed RedHat 7.5 and inestigated the ESP.
> >>>>> 
> >>>>> - The ESP starts at block 2048, while FreeBSD's ESP starts at block 40.
> >>>>> - size is both 200mb if installed automatically. I forgit to investigate
> >>>>> the FAT format, but this might be unnecessary as shown further in this
> >>>>> post.
> >>>>> - RedHat's ESP contains ~ 10 MB of data in two
> >>>>> folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
> >>>>> RedHat's doesn't change anything, also renaming /efi/boot/fbx64.efi of
> >>>>> RedHat's installation. But renaming /efi/redhat renders RedHat to fail the
> >>>>> boot process on the Fujitsu with the signs of the built-in testprogram as
> >>>>> reported.
> >>>>> 
> >>>>> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI boot
> >>>>> only (CSM in firmware disabled, but there is still a gptzfsboot-prepared
> >>>>> partition for later use, just for the record). Booting UEFI-only fails as
> >>>>> reported. On this installation I copied the RedHat ESP completely into
> >>>>> FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to /efi/boot/BOOTX64.efi.rh
> >>>>> and copied FreeBSD's BOOTX64.efi to /efi/boot. 
> >>>>> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems, that
> >>>>> the /efi/redhat folder of the ESP is important, if renamed, the whole
> >>>>> process dies as I reported earlier.
> >>>>> 
> >>>>> Still unanswered is the question: why is a NanoBSD prepared UEFI-only USB
> >>>>> flash booting with CSM disabled (so asumingly UEFI only then) on both
> >>>>> ASRock and Fujitsu (as described in more detail initially and earlier),
> >>>>> while SSDs fail? Is there a difference? Since FreeBSD boots in UEFI mode
> >>>>> from USB flash prepared as described (straight forward, 800k ESP starting
> >>>>> at block 40, the boot1.efifat image dd'ed onto the partition, UFS
> >>>>> partition following, no freebsd-boot partition or MBR/PMBR bootcode
> >>>>> applied ever!), I think BOOTX64.EFI is technically all right. There must
> >>>>> be then an issue with the SATA/SSD/HDD boot pathway.
> >>>>> 
> >>>>> Hope I could provide some more details, sorry if it sounds confusing or
> >>>>> way too long, but I try to descibe the situation as thorough as possible.
> >>>>>   
> >>>> 
> >>>> OK, this is already good hint. The thing with ESP is that there is
> >>>> ?default? file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is noted as
> >>>> default for *removable* media, fortunately it is usable for hard disks as
> >>>> well, or at least in most cases.
> >>>> 
> >>>> Now, for non-removable media, the UEFI does provide boot manager interface
> >>>> to define boot entries, and the fact that renaming efi/redhad directory did
> >>>> break the redhat boot, is very loud hint. And this means, this system is
> >>>> probably ignoring efi/boot tree on non-removable media and is expecting the
> >>>> boot manager entry to be created instead.    
> >>> 
> >>> This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956 firmware
> >>> (not tested on ASRock Z77-Pro4 firmware).
> >>>   
> >>>> 
> >>>> UEFI boot manager can be configured /usually/ manually via firmware menu,
> >>>> or by application, such as efibootmgr. The normal approach is to create
> >>>> efi/<vendorname> directory and to copy the application there, then create
> >>>> the boot manager configuration.
> >>>> 
> >>>> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
> >>>> 
> >>>> What is different in FreeBSD case is that the whole interface to program
> >>>> the UEFI Boot Manager is currently being developed, so either it has to be
> >>>> done manually or from some other OS (see
> >>>> https://wiki.gentoo.org/wiki/Efibootmgr
> >>>> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit from
> >>>> google:D).    
> >>> 
> >>> Well, thanks for this important hint! FreeBSD 12-CURRENT's and FreeBSD
> >>> 11.2-RELENG's USB flash devices are capable of booting off on Fujitsu's
> >>> ESPRIMO and ASRock's boards. As a note: after "kldload efirt.ko" I was able
> >>> to use the already in FreeBSD present toolset efibootmgr(8) and sibblings
> >>> (the tools do not do anything useful when booted non-UEFI).
> >>> 
> >>> Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and following
> >>> the steps in the examples and having created /efi/freebsd/BOOTx64.efi as
> >>> recommended by copy from /efi/boot, let me create a proper boot variable.
> >>> 
> >>> To make things sure, I also applied "efibootmgr -a VARIABLENAME".
> >>> 
> >>> And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do not know
> >>> whether this will also work with FAT12/16, I should test this case, too.
> >>> 
> >>> There is a bug in the manpage of efibootmg(8). It does not explain the
> >>> options -d and -p, although they could be "implied" by reading carefully.
> >>> There is now a PR at 
> >>> 
> >>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080
> >>> 
> >>> for this issue.
> >>> 
> >>> So, it's apity that the handbook has no note I could easily find on this; 
> >>> 
> >>> Thank you very much for your patience and help!
> >>> 
> >>> Kind regards,
> >>> Oliver    
> >> 
> >> yep, efibootmgr does call UEFI RuntimeServices to set up the variables, and
> >> this is only possible when booted UEFI. But glad we finally found the root
> >> cause. It would be good to have HW notes for such cases, it is important to
> >> know that those systems wont boot UEFI from HDD unless the boot manager setup
> >> is done.
> >> 
> >> rgds,
> >> toomas  
> > 
> > 
> > This pops up the question how to deal with such HW. We have as a institution a
> > lot of Fujitsu hardware her - from larger servers down to Fujitsu ESPRIMO Q956.
> > The latter one is the first (and so far the only) piece of hardware I found
> > incapable of booting off UEFI within the past 5 years.
> > 
> > If the "standard" for removeable devices is to boot from /efi/boot/bootx64.efi,
> > than I'd guess it is good luck for FreeBSD that the firmware vendors did
> > fallback to such a mechanism. GRUB/Linux seem to install by default their
> > bootloader into /efi/something/ I'll check on Debian, Suse and CentOS so far
> > soon, the latter probably will, since its the "free" RedHat).
> > 
> > Anyway, apart from any criticism, I'm glad to have the tools to make things
> > work without using alien help (outside FreeBSD's world!). That is a thank you
> > towards the developers.
> > 
> > Kind regards,
> > 
> > oh
> >   
> 
> The efibootmgr is only relatively recent addition (in illumos we do not have yet even
> access to UEFI RS), so it is only question of time once installer will get updated:)
> 
> But of course there is still an issue about the scenario when the install is done in
> BIOS mode and later switched to UEFI - then the boot manager configuration needs to be
> updated manually (or by some maintenance service like grub2 is calling via grub-install
> script).
> 
> rgds,
> toomas
> 
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

Just to add another success on ASRock Z77-Pro4 (800k ESP, FAT12) and ASRock Z77-Pro4M
(300mb ESP, FAT32).

On this firmware, I did not have to define/copy the bootloader
within /efi/freebd/BOOTx64.efi. It was sufficient to add an EFI variable as described in
the manpage efibootmgr(8).

The only pitfall on this firmware (very old, last functional update 2013,
Spectre/Meltodown mitigation only May 2018) was that I wasn't able to activate variable
"0000"! Creating 

efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD-12

which results in "Boot0000"

and followed by 

efibootmgr -a 0000

or 

efibootmgr -n 0000

resulted in "No such variable" or similar.

I had to perform the very same task again to gain variable 0001 and then I was able to
"activate" variable 0000. This might be due to the fact the only variable defined at all
was Boot0005 pointing to the most recent USB flash device with 12-CURRENT from 2018-07-26
I just prepared.

Now, also those boxes boot via UEFI (one, 800k ESP with the /efi/boot folder, the other,
300mb ESP, with a copy /efi/freebsd as I had to do on the Fujitsu ESPRIMO Q956 firmware).

Kind regrads,

Oliver

- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW1tQ8wAKCRDS528fyFhY
lGuQAgCZwWkZwd2Ia5ppQhAmlwIFv2hXsQzoq2IT/a8syADQV3HbofLt1vTfQoi6
L9dEQT8JYT2uDxVLxueYQsc3YOmBAf9OXJQ752mSpzEnyYy2RnlHN1hXu2pi4/i7
Djr8s574YV61UUJIcynfYrWWsJy5AFs1vh+8712gA8lmQ13zQqvn
=Yqdt
-----END PGP SIGNATURE-----

From miwi at FreeBSD.org  Fri Jul 27 17:21:55 2018
From: miwi at FreeBSD.org (Martin Wilke)
Date: Sat, 28 Jul 2018 01:21:48 +0800
Subject: =?utf-8?Q?_make_distribution_fails=2C=C2=A0A_failure_has_been_det?=
 =?utf-8?Q?ected_in_another_branch_of_the_parallel_make?=
Message-ID: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>

Hi,

I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.

- Martin

From ml at vishwin.info  Fri Jul 27 17:31:10 2018
From: ml at vishwin.info (Charlie Li)
Date: Fri, 27 Jul 2018 13:30:42 -0400
Subject: =?UTF-8?Q?Re=3a_make_distribution_fails=2c=c2=a0A_failure_has_been_?=
 =?UTF-8?Q?detected_in_another_branch_of_the_parallel_make?=
In-Reply-To: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
Message-ID: <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>

On 27/07/2018 13:21, Martin Wilke wrote:
> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.
> 
I was about to inquire about this myself. Can additionally confirm this
has been happening since at least r336735.

-- 
Charlie Li
Can't think of a witty .sigline today?

(This email address is for mailing list use only; replace local-part
with vishwin for off-list communication)

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180727/4032d331/attachment.sig>

From imp at bsdimp.com  Fri Jul 27 18:03:58 2018
From: imp at bsdimp.com (Warner Losh)
Date: Fri, 27 Jul 2018 12:03:55 -0600
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <20180727190555.55439fb3@thor.intern.walstatt.dynvpn.de>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
 <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
 <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>
 <2A5E5E42-8595-44E9-A51E-504C9C2C7FA7@me.com>
 <20180727190555.55439fb3@thor.intern.walstatt.dynvpn.de>
Message-ID: <CANCZdfrQiJTMOa4HbQve6YW531h__AQKc1nwkr4Fg+YKNRaBwQ@mail.gmail.com>

On Fri, Jul 27, 2018 at 11:05 AM, O. Hartmann <ohartmann at walstatt.org>
wrote:

> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
>
> Am Fri, 27 Jul 2018 13:59:44 +0300
> Toomas Soome <tsoome at me.com> schrieb:
>
> > > On 27 Jul 2018, at 13:02, O. Hartmann <ohartmann at walstatt.org> wrote:
> > >
> > > On Fri, 27 Jul 2018 08:54:48 +0300
> > > Toomas Soome <tsoome at me.com> wrote:
> > >
> > >>> On 27 Jul 2018, at 08:46, O. Hartmann <ohartmann at walstatt.org>
> wrote:
> > >>>
> > >>> On Thu, 26 Jul 2018 19:23:43 +0300
> > >>> Toomas Soome <tsoome at me.com> wrote:
> > >>>
> > >>> (reply inline/at the end)
> > >>>
> > >>>
> > >>>>> On 26 Jul 2018, at 16:58, O. Hartmann <ohartmann at walstatt.org>
> wrote:
> > >>>>>
> > >>>>> On Wed, 25 Jul 2018 07:30:32 -0700 (PDT)
> > >>>>> "Rodney W. Grimes" <freebsd-rwg at pdx.rh.CN85.dnsmgr.net
> > >>>>> <mailto:freebsd-rwg at pdx.rh.CN85.dnsmgr.net>> wrote:
> > >>>>>>>> On 25 Jul 2018, at 12:10, O. Hartmann <o.hartmann at walstatt.org>
> wrote:
> > >>>>>>>>
> > >>>>>>>> On Wed, 25 Jul 2018 11:46:07 +0300
> > >>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> > >>>>>>>>
> > >>>>>>>>>> On 25 Jul 2018, at 10:59, O. Hartmann <ohartmann at walstatt.org>
> wrote:
> > >>>>>>>>>>
> > >>>>>>>>>> On Tue, 24 Jul 2018 08:53:36 +0300
> > >>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> > >>>>>>>>>>
> > >>>>>>>>>>
> > >>>>>>>>>> Hello  Toomas Soome,
> > >>>>>>>>>>
> > >>>>>>>>>> I CC Allan Jude since I discovered something  weird today
> regarding
> > >>>>>>>>>> the UEFI boot capabilities of USB flash devices and SSDs. See
> below.
> > >>>>>>>>>>
> > >>>>>>>>>>>> On 24 Jul 2018, at 08:16, O. Hartmann <
> ohartmann at walstatt.org>
> > >>>>>>>>>>>> wrote:
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> On Mon, 23 Jul 2018 10:56:04 +0300
> > >>>>>>>>>>>> Toomas Soome <tsoome at me.com> wrote:
> > >>>>>>>>>>>>
> > >>>>>>>>>>>>>> On 23 Jul 2018, at 10:27, O. Hartmann <
> ohartmann at walstatt.org>
> > >>>>>>>>>>>>>> wrote:
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> On Fri, 13 Jul 2018 18:44:23 +0300
> > >>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>>
> wrote:
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> On 13 Jul 2018, at 17:44, O. Hartmann <
> o.hartmann at walstatt.org
> > >>>>>>>>>>>>>>>> <mailto:o.hartmann at walstatt.org>> wrote:
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> -----BEGIN PGP SIGNED MESSAGE-----
> > >>>>>>>>>>>>>>>> Hash: SHA512
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> Am Fri, 13 Jul 2018 14:26:51 +0300
> > >>>>>>>>>>>>>>>> Toomas Soome <tsoome at me.com <mailto:tsoome at me.com>
> > >>>>>>>>>>>>>>>> <mailto:tsoome at me.com <mailto:tsoome at me.com>>>
> > >>>>>>>>>>>>>>>> schrieb:
> > >>>>>>>>>>>>>>>>>> On 13 Jul 2018, at 14:00, O. Hartmann
> > >>>>>>>>>>>>>>>>>> <ohartmann at walstatt.org> wrote:
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> The problem is some kind of weird. I face UEFI boot
> problems
> > >>>>>>>>>>>>>>>>>> on GPT drives where the first partition begins at
> block 40
> > >>>>>>>>>>>>>>>>>> of the hdd/ssd.
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> I have two host in private use based on an
> > >>>>>>>>>>>>>>>>>> outdated ASRock Z77-Pro4-M and Z77-Pro4 mainboard
> (IvyBridge,
> > >>>>>>>>>>>>>>>>>> Socket LGA1155). Both boards are equipted with the
> lates
> > >>>>>>>>>>>>>>>>>> official available AMI firmware revision, dating to
> 2013.
> > >>>>>>>>>>>>>>>>>> This is for the Z77-Pro4-M revision 2.0 (2013/7/23)
> and for
> > >>>>>>>>>>>>>>>>>> the Z77 Pro4 revision 1.8 (2013/7/17). For both
> boards a
> > >>>>>>>>>>>>>>>>>> BETA revision for the Spectre/Meltdown mitigation is
> > >>>>>>>>>>>>>>>>>> available, but I didn't test that. But please read.
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> The third box I realised this problem is a brand new
> Fujitsu
> > >>>>>>>>>>>>>>>>>> Esprimo Q956, also AMI firmware, at V5.0.0.11 R
> 1.26.0 for
> > >>>>>>>>>>>>>>>>>> 3413-A1x, date 05/25/2018 (or 20180525).
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> Installing on any kind of HDD or SSD manually or via
> > >>>>>>>>>>>>>>>>>> bsdinstall the OS using UEFI-only boot method on a GPT
> > >>>>>>>>>>>>>>>>>> partitioned device fails. The ASRock boards jump
> immediately
> > >>>>>>>>>>>>>>>>>> into the firmware, the Fujitsu offers some kind of
> > >>>>>>>>>>>>>>>>>> CPU/Memory/HDD test facility.
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> If on both type of vendor/boards CSM is disabled and
> UEFI
> > >>>>>>>>>>>>>>>>>> boot only is implied, the MBR partitioned FreeBSD
> > >>>>>>>>>>>>>>>>>> installation USB flash device does boot in UEFI! I
> guess I
> > >>>>>>>>>>>>>>>>>> can assume this when the well known clumsy 80x25 char
> > >>>>>>>>>>>>>>>>>> console suddenly gets bright and shiny with a much
> higher
> > >>>>>>>>>>>>>>>>>> resoltion as long the GPU supports EFI GOP. Looking
> with
> > >>>>>>>>>>>>>>>>>> gpart at the USB flash drives reveals that the EFI
> partition
> > >>>>>>>>>>>>>>>>>> starts at block 1 of the device and the device has a
> MBR
> > >>>>>>>>>>>>>>>>>> layout. I haven't found a way to force the GPT
> scheme, when
> > >>>>>>>>>>>>>>>>>> initialised via gpart, to let the partitions start at
> block
> > >>>>>>>>>>>>>>>>>> 1. This might be a naiv thinking, so please be
> patient with
> > >>>>>>>>>>>>>>>>>> me.
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> I do not know whether this is a well-known issue. On
> the
> > >>>>>>>>>>>>>>>>>> ASRock boards, I tried years ago some LinuxRed Hat
> and Suse
> > >>>>>>>>>>>>>>>>>> with UEFI and that worked - FreeBSD not. I gave up on
> that
> > >>>>>>>>>>>>>>>>>> that time. Now, having the very same issues with a new
> > >>>>>>>>>>>>>>>>>> Fujitsu system, leaves me with the impression that
> FreeBSD's
> > >>>>>>>>>>>>>>>>>> UEFI implementation might have problems I'm not aware
> of.
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>> Can someone shed some light onto this?
> > >>>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>> The first thing to check is if the secure boot is
> disabled. We
> > >>>>>>>>>>>>>>>>> do not support secure boot at all at this time.
>
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> Secure boot is in every scenario disabled!
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>> If you have efi or bios version running - you can
> check from
> > >>>>>>>>>>>>>>>>> either console variable value (it can have efi or
> vidconsole
> > >>>>>>>>>>>>>>>>> or comconsole) or better yet, see if efi-version is
> set (show
> > >>>>>>>>>>>>>>>>> efi-version) - if efi-version is not set, it is BIOS
> loader
> > >>>>>>>>>>>>>>>>> running. Another indirect way is to see lsdev -v, with
> device
> > >>>>>>>>>>>>>>>>> paths present, it is uefi:)
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> What are you talking about?
> > >>>>>>>>>>>>>>>> What is the point of entry - running system, loader?
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> sysct machdep.bootmethod: BIOS
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> This makes me quite sure that the system has booted via
> BIOS -
> > >>>>>>>>>>>>>>>> as I'm sure since I've checked that many times. UEFI
> doesn't
> > >>>>>>>>>>>>>>>> work on those systems with FreeBSD. I'm not sure
> antmore, but
> > >>>>>>>>>>>>>>>> I tried also Windows 7 on those mainboards booting via
> UEFI -
> > >>>>>>>>>>>>>>>> and I might recall that they failed also. I also recall
> that
> > >>>>>>>>>>>>>>>> there were issues with earlier UEFI versions regarding
> booting
> > >>>>>>>>>>>>>>>> only Windows 8/8.1 - and nothing else, but the fact
> that Linux
> > >>>>>>>>>>>>>>>> worked confuses me a bit.
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> If this ASRock crap (never ever again this brand!)
> doesn't work
> > >>>>>>>>>>>>>>>> at all - who cares, I intend to purchase new server
> grade
> > >>>>>>>>>>>>>>>> hardware. But the more puzzling issue is with the
> Fujitsu,
> > >>>>>>>>>>>>>>>> which I consider serious and from the behaviour the
> Fujitsu
> > >>>>>>>>>>>>>>>> failure looks exactly like the ASRock - Windows 7 works,
> > >>>>>>>>>>>>>>>> RedHat 7.5 works (I assume I can trust the Firmware
> settings
> > >>>>>>>>>>>>>>>> when I disable CSM support, that the Firmware will only
> > >>>>>>>>>>>>>>>> EFI/UEFI capable loader? Or is there a ghosty override
> > >>>>>>>>>>>>>>>> somwhere to be expected?). Also on ASRock disabling CSM
> should
> > >>>>>>>>>>>>>>>> ensure not booting a dual-bootstrap-capable system.
> This said,
> > >>>>>>>>>>>>>>>> on the recent Fujitsu, it seems to boil down to a
> FreeBSD
> > >>>>>>>>>>>>>>>> UEFI-firmware interaction problem, while the ASRock is
> still
> > >>>>>>>>>>>>>>>> under suspicion to be broken by design.
> > >>>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>>> GPT partitions can never start from disk absolute
> sector 1;
> > >>>>>>>>>>>>>>>>> this is because at sector 0 there is MBR (for
> compatibility),
> > >>>>>>>>>>>>>>>>> sector 1 is GPT table and then sectors 2-33 have GPT
> > >>>>>>>>>>>>>>>>> partition table entries, so the first possible data
> sector is
> > >>>>>>>>>>>>>>>>> 34 (absolute 34). Thats assuming 512B sectors. For
> details
> > >>>>>>>>>>>>>>>>> see UEFI 2.7 Chapter 5.3.1 page 131.
> > >>>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>>> Thanks for the explanation. That implies the installer
> did
> > >>>>>>>>>>>>>>>> right, gpart did also right and therefore there must be
> an
> > >>>>>>>>>>>>>>>> issue with the stuff located within the EFI
> > >>>>>>>>>>>>>>>> partition?
> > >>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>> Ok, so, it is not about UEFI bootcode but BIOS, and if
> we reach
> > >>>>>>>>>>>>>>> BIOS loader at all or not - that is, if the BIOS
> bootstrap is
> > >>>>>>>>>>>>>>> actually caring to read the MBR code and start it, since
> once
> > >>>>>>>>>>>>>>> the MBR code is started, it is all about our code.
>
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> I'm getting confused a bit here. Do you mean by "BIOS"
> the CSM?
> > >>>>>>>>>>>>>> or do you mean that specific portion of the UEFI
> firmware, which
> > >>>>>>>>>>>>>> looks for the proper UEFI partition?
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>> BIOS as either native or CSM. Note that from boot code
> point of
> > >>>>>>>>>>>>> view the CSM boot *is* BIOS boot, we have no access to UEFI
> > >>>>>>>>>>>>> features.
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> The boxes in question, most notably the more recent
> Fujitsu
> > >>>>>>>>>>>>>> Esprimo Q956, refuse booting UEFI, even if properly setup
> (in
> > >>>>>>>>>>>>>> terms of what FreeBSD provides on recent CURRENT) is
> applied and
> > >>>>>>>>>>>>>> CSM is switched off in the firmware. Again: GPT partition
> scheme.
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> The system boots properly if a second partition of type
> > >>>>>>>>>>>>>> "freebsd-boot" is applied and bootcode is properly
> applied via
> > >>>>>>>>>>>>>> "gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 2 ada0"
> (ada0
> > >>>>>>>>>>>>>> is the device).
> > >>>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>> btw, you can try to validate the installed boot blocks
> by using
> > >>>>>>>>>>>>>>> recent enough loader (usb or iso) and then you can use
> from OK
> > >>>>>>>>>>>>>>> prompt:
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> lsdev provides me with the follwoing informations (CSM
> enabled):
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> OK lsdev
> > >>>>>>>>>>>>>> disk devices:
> > >>>>>>>>>>>>>>        disk0:          BIOS DRIVE C ...
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>>                disk0p1:        EFI
> > >>>>>>>>>>>>>>                disk0p2:        FreeBSD BOOT
> > >>>>>>>>>>>>>>                disk0p3:        FreeBSD SWAP
> > >>>>>>>>>>>>>>                disk0p4:        FreeBSD ZFS
> > >>>>>>>>>>>>>> zfs devices:
> > >>>>>>>>>>>>>>        zfs:zroot
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> OK chain disk0
> > >>>>>>>>>>>>>> open failed     (so for disk0p{1-4}.
> > >>>>>>>>>>>>>>
> > >>>>>>>>>>>>>> OK chain zroot
> > >>>>>>>>>>>>>> failed to read disk (just for completeness)
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>> chain command does use only device name (such as disk0: or
> > >>>>>>>>>>>>> disk0p2: ), but not zfs pool as device.  I just found I
> haven?t
> > >>>>>>>>>>>>> ported the code to read the file.
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> ??
> > >>>>>>>>>>>>
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>> the point for chain command test is to see if the normal
> read and
> > >>>>>>>>>>>>> execute would work, so in your case please try:
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>> chain disk0:
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> As stated above, I did so, and the result is also mentioned
> above,
> > >>>>>>>>>>>> I always get "open failed".
> > >>>>>>>>>>>> This is the same for
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> chain disk0
> > >>>>>>>>>>>> chain disk0p1
> > >>>>>>>>>>>> chain disk0p2
> > >>>>>>>>>>>> chain disk0p3
> > >>>>>>>>>>>> chain disk0p4
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> as already said. CSM is enabled in this case.
> > >>>>>>>>>>>
> > >>>>>>>>>>> sigh? chain command does take device as argument, device
> must always
> > >>>>>>>>>>> end with colon?. in this case, the devil is in details:) as
> I wrote
> > >>>>>>>>>>> above, the command should be:
> > >>>>>>>>>>>
> > >>>>>>>>>>> chain disk0:
> > >>>>>>>>>>>
> > >>>>>>>>>>> The disk0p1: etc will only work when partition boot code was
> > >>>>>>>>>>> installed (which you most likely do not have - the only
> possible
> > >>>>>>>>>>> candidate could be FreeBSD ZFS partition).
> > >>>>>>>>>>
> > >>>>>>>>>> The command "chain disk0:" works as expected (CSM enabled, GPT
> > >>>>>>>>>> partition scheme, but with PMBR bootblock installed and
> freebsd-boot
> > >>>>>>>>>> partition conatining gptzfsboot installed.
> > >>>>>>>>>>
> > >>>>>>>>>>
> > >>>>>>>>>>>
> > >>>>>>>>>>>>
> > >>>>>>>>>>>>>
> > >>>>>>>>>>>>> to read pmbr (512B) and execute it. The expected outcome
> would be
> > >>>>>>>>>>>>> that pmbr boot code would browse the GPT, read stage1 from
> > >>>>>>>>>>>>> disk0p2: and execute it; stage1 would detect FreeBSD ZFS
> from
> > >>>>>>>>>>>>> disk0p4: and load and execute /boot/loader. If that will
> happen,
> > >>>>>>>>>>>>> it means the boot code in our stages is just fine, but the
> bios
> > >>>>>>>>>>>>> (CSM) does not load pmbr?.  if thats true, it would mean
> that you
> > >>>>>>>>>>>>> either need to use UEFI boot or need to have some hack to
> fool
> > >>>>>>>>>>>>> the BIOS or just not use GPT on that machine with CSM.
>
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> To make it clear here: The only way to boot this box is
> using CSM
> > >>>>>>>>>>>> (as it is the same with the ASRock boards mentioned
> earlier). But
> > >>>>>>>>>>>> my intention is to disable CSM and use a GPT/UEFI
> environment
> > >>>>>>>>>>>> only! And GPT/UEFI doesn't work with FreeBSD, neither with
> > >>>>>>>>>>>> 12-CURRENT, nor 11.2-RELENG.
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> It would be nice if this could be fixed. I'm more
> interested in the
> > >>>>>>>>>>>> fix on the recent Fujitsu device than the outdated ASRock
> crap, but
> > >>>>>>>>>>>> if the fix for the Fujitsu Firmware could fix older issues
> as a
> > >>>>>>>>>>>> byproduct, I'd appreciate that.
> > >>>>>>>>>>>>
> > >>>>>>>>>>>> Kind regards,
> > >>>>>>>>>>>>
> > >>>>>>>>>>>
> > >>>>>>>>>>> ok, somehow I have lost that part of the discussion. Well,
> you wrote
> > >>>>>>>>>>> that the UEFI boot fails when the first partition starts
> from sector
> > >>>>>>>>>>> 40 - does it mean you have boot when the partition will
> start from
> > >>>>>>>>>>> some other sector? I think, there is something else going
> > >>>>>>>>>>> on.
> > >>>>>>>>>>
> > >>>>>>>>>> Well, I simply try to describe what I "see" to make things
> > >>>>>>>>>> disambiguous. I'm not familiar with the deeper insights of
> disk
> > >>>>>>>>>> layouts on a binary level. So, you explained to me the
> reason, why
> > >>>>>>>>>> ESP (EGI partition) starts at block 40. I compared that to the
> > >>>>>>>>>> FreeBSD USB flash image FreeBSD provides, but this is another
> story
> > >>>>>>>>>> since the image uses MBR scheme as I figured out.
> > >>>>>>>>>>
> > >>>>>>>>>>
> > >>>>>>>>>>>
> > >>>>>>>>>>> What you can do is to see if that firmware will offer you
> EFI shell
> > >>>>>>>>>>> option, from there you can try to start the bootx64.efi
> manually and
> > >>>>>>>>>>> see what error you will get. However, the number 1 cause for
> failing
> > >>>>>>>>>>> to start the bootloader in UEFI is secure boot - we do not
> support
> > >>>>>>>>>>> it and secure boot must be switched off.
> > >>>>>>>>>>>
> > >>>>>>>>>>> However, they seem to claim "The Secure Boot option is
> available in
> > >>>>>>>>>>> the UEFI/BIOS of most if not all ASRock boards. It is
> disabled by
> > >>>>>>>>>>> default.?
> > >>>>>>>>>>>
> > >>>>>>>>>>> Still suggest to double check if thats really the case.
> Also, if the
> > >>>>>>>>>>> bootx64.efi start will fail and no messages are appearing on
> screen,
> > >>>>>>>>>>> then either there is something in firmware logs or you could
> get
> > >>>>>>>>>>> them from trying to start bootx64.efi from UEFI shell.
>
> > >>>>>>>>>>
> > >>>>>>>>>> Since I'm with this problem since 2014 and try from time to
> time, be
> > >>>>>>>>>> ausred that I tried every possible permutationof all
> reasonable
> > >>>>>>>>>> options, even those nonsense, to get rid of that problem.
> > >>>>>>>>>>
> > >>>>>>>>>> I never had any problems with any other UEFI capable
> > >>>>>>>>>> server/workstation firmware so far booting FreeBSD off in
> > >>>>>>>>>> UEFI-native (GPT partition scheme, CSM disabled) so far -
> until now,
> > >>>>>>>>>> when I ran into this Fujitsu ESPRIMO Q956 with the most recent
> > >>>>>>>>>> firmware (as of lat week, week 29 of 2018) having the very
> same
> > >>>>>>>>>> problems.
> > >>>>>>>>>>
> > >>>>>>>>>>
> > >>>>>>>>>>
> > >>>>>>>>>> I figured out something strange on the Fujitsu - and that is
> the same
> > >>>>>>>>>> with the ASRock boards.
> > >>>>>>>>>>
> > >>>>>>>>>> We/I prepare some USB flash drives to boot a NanoBSD for a
> very small
> > >>>>>>>>>> appliance, but nevertheless, the USB flash device is booted on
> > >>>>>>>>>> Fujitsu servers with UEFI-only configurations. I assume at
> this
> > >>>>>>>>>> point that disabling on the most recent Fujitsu firmwares on
> > >>>>>>>>>> reasonable "new" hardware (not older than three years) will
> disable
> > >>>>>>>>>> any(!) legacy BIOS capabilities. The same is assumed for the
> Fujitus
> > >>>>>>>>>> ESPRIMO Q956. I can not speak for the ASRock A77 Pro4/m boards
> > >>>>>>>>>> mentioned above/earlier, they are from 2012/2013 and "quite
> old".
> > >>>>>>>>>>
> > >>>>>>>>>> The NanoBSD image of ours doesn't have a "freebsd-boot"
> partition.
> > >>>>>>>>>> The partition scheme of the flash device is GPT. The layout
> looks
> > >>>>>>>>>> like this:
> > >>>>>>>>>>
> > >>>>>>>>>> gpart show -l da4
> > >>>>>>>>>> =>      40  15425456  da4  GPT  (7.4G)
> > >>>>>>>>>>    40      2000    1  efiboot0  (1.0M)
> > >>>>>>>>>>  2040   1453584    3  disk1a  (710M)
> > >>>>>>>>>> 1455624      4096    5  disk3  (2.0M)
> > >>>>>>>>>> 1459720  13965776       - free -  (6.7G)
> > >>>>>>>>>>
> > >>>>>>>>>> I created the flash with md, gpart and dd straightforward,
> efiboot0
> > >>>>>>>>>> is the ESP partition and its format/content is created via dd
> > >>>>>>>>>> if=/boot/boot1.efifat of=/dev/da4p1 - I presume this is very
> simple.
> > >>>>>>>>>>
> > >>>>>>>>>> This USB flash device boots(!) successfully (UEFI!) on both
> the
> > >>>>>>>>>> ASRock boards and the Esprimo Q956!
> > >>>>>>>>>>
> > >>>>>>>>>> But any SSD prepared the same way doesn't. Why?
> > >>>>>>>>>>
> > >>>>>>>>>> On the ASRock, I recall having fiddled around with HDD also
> for a
> > >>>>>>>>>> while conatining Windows 7/SP1 and FreeBSD. Windows7 booted,
> FreeBSD
> > >>>>>>>>>> - I can't remember.
> > >>>>>>>>>>
> > >>>>>>>>>> In the lack of proper hardware I'm unable to check whether
> > >>>>>>>>>> USB-attached HDD or SSD will boot or HDD will boot (just in
> case the
> > >>>>>>>>>> local SATA has problems booting UEFI and USB not).
> > >>>>>>>>>>
> > >>>>>>>>>> Kind regards,
> > >>>>>>>>>>
> > >>>>>>>>>> Oliver
> > >>>>>>>>>>
> > >>>>>>>>>
> > >>>>>>>>> Am. well. I think the suggestion to test out FAT32 is still
> good one
> > >>>>>>>>> to test. This is because it is known that some vendors do not
> support
> > >>>>>>>>> booting FAT12/FAT16 from HDD (the likely reason is that UEFI
> > >>>>>>>>> specification does not tell which FAT must be supported, and
> only hint
> > >>>>>>>>> about FAT12/FAT16 in context of removable devices).
> > >>>>>>>>
> > >>>>>>>> I prepared yesterday a GTP/ZFS-only 11.2-RELENG on the ESPRIMO
> Q956. It
> > >>>>>>>> took me a time to circumvent the installer and I had to install
> the
> > >>>>>>>> system manually. In that strain, I also "tried" to establish
> the ESP
> > >>>>>>>> with FAT32, as Allen Jude suggested earlier. I didn't find any
> ad hoc
> > >>>>>>>> help how to find out the format (FAT12/16/32) of the ESP, so I
> assume
> > >>>>>>>> when using 12-CURRENT's or 11.2-RELENG's installer with
> AUTO-ZFS and
> > >>>>>>>> GPT (UEFI) (only!) the resulting ESP is FAT12 or FAT16 (300mb by
> > >>>>>>>> default). I also assume, that when dd'ing the /boo/boot1.efifat
> image
> > >>>>>>>> to a partition, the format is FAT, but not FAT32. Therefore, I
> > >>>>>>>> refomatted the manually created ESP (using "gpart add -t efi
> ...")
> > >>>>>>>> using "newfs_msdos -F 32 -b xxx ...". I had to fiddle around a
> bit
> > >>>>>>>> with option -b to fit in a proper format to meet a 512mb ESP -
> I'm not
> > >>>>>>>> sure whether this is the proper option to deal with. When using
> the
> > >>>>>>>> default and only -F32, the size of the partition has to be 4G
> at least
> > >>>>>>>> I assume. Having done that, I copied the the content of
> boot1.efifat
> > >>>>>>>> (mdconfig -t vnode ..., I guess we know the drill ...) to the
> newly
> > >>>>>>>> formatted ESP to /boot/efi/ ...
> > >>>>>>>>
> > >>>>>>>> Having so far no knowledge of how to asure that the created ESP
> is
> > >>>>>>>> FAT32, I assume it is FAT32.
> > >>>>>>>>
> > >>>>>>>> The result is negative on the ESPRIMO Q956. When disabling the
> CSM, the
> > >>>>>>>> box is not willing to boot from SSD with the ESP prepared as
> decribed.
> > >>>>>>>> So, a chance that this might still be due to a misconfiguration
> lies
> > >>>>>>>> now within the -b option of newfs_msdos - if the -b option is
> assumed
> > >>>>>>>> the proper option?
> > >>>>>>>>
> > >>>>>>>> At the moment, the ESP of the Esprimo is subject to changes, if
> you
> > >>>>>>>> wish, but not in size, since it is limited to 512mb.
> > >>>>>>>>
> > >>>>>>>> Thanks and kind regards,
> > >>>>>>>>
> > >>>>>>>> Oliver
> > >>>>>>>
> > >>>>>>> Yea, i was hoping fstyp command would report the FAT type, but
> it does
> > >>>>>>> not (request for feature?:)
> > >>>>>>
> > >>>>>> FYI, the file(1) command is very good at disecting a disk image
> to tell
> > >>>>>> you what the MBR looks like, and at looking at partitions if
> pointed at
> > >>>>>> them with the -s option.  It should be able to detect FAT12/16/32.
> > >>>>>>
> > >>>>>> root at x230a:/home/ISO/x # file -s /dev/md2s1
> > >>>>>> /dev/md2s1: DOS/MBR boot sector, code offset 0x3c+2, OEM-ID
> "BSD4.4  ",
> > >>>>>> root entries 512, sectors 1600 (volumes <=32 MB) , sectors/FAT 5,
> > >>>>>> sectors/track 63, heads 1, serial number 0xbd4111ee, label:
> "EFISYS
> > >>>>>> ", FAT (12 bit), followed by FAT
> > >>>>>>
> > >>>>>>>
> > >>>>>>> However, the more annoying idea would be to install some OS
> which will
> > >>>>>>> boot with UEFI on this machine, then copy boot1.efi from freebsd
> to it
> > >>>>>>> (the default program the UEFI will load is
> ESP:EFI/boot/bootx64.efi  in
> > >>>>>>> case of UEFI64 and ESP:EFI/boot/bootia32.efi for EFI32. However,
> we do
> > >>>>>>> not support EFI32.
> > >>>>>>>
> > >>>>>>> note that boot1.efi alone will not do much but printing on
> screen how it
> > >>>>>>> will search for freebsd, but for the purpose of the test it would
> > >>>>>>> suffice
> > >>>>>>> - that would give us confirmed working ESP file system (since
> the other
> > >>>>>>> os would be able to boot) and then we can confirm if boot1.efi
> itself is
> > >>>>>>> OK.
> > >>>>>>
> > >>>>>
> > >>>>> Some new results.
> > >>>>> I installed RedHat 7.5 and inestigated the ESP.
> > >>>>>
> > >>>>> - The ESP starts at block 2048, while FreeBSD's ESP starts at
> block 40.
> > >>>>> - size is both 200mb if installed automatically. I forgit to
> investigate
> > >>>>> the FAT format, but this might be unnecessary as shown further in
> this
> > >>>>> post.
> > >>>>> - RedHat's ESP contains ~ 10 MB of data in two
> > >>>>> folders, /efi/boot, /efi/redhat. copying FreeBSD's BOOTX64.efi over
> > >>>>> RedHat's doesn't change anything, also renaming
> /efi/boot/fbx64.efi of
> > >>>>> RedHat's installation. But renaming /efi/redhat renders RedHat to
> fail the
> > >>>>> boot process on the Fujitsu with the signs of the built-in
> testprogram as
> > >>>>> reported.
> > >>>>>
> > >>>>> I took the liberty and installed 11.2-RELENG again, ZFS only, UEFI
> boot
> > >>>>> only (CSM in firmware disabled, but there is still a
> gptzfsboot-prepared
> > >>>>> partition for later use, just for the record). Booting UEFI-only
> fails as
> > >>>>> reported. On this installation I copied the RedHat ESP completely
> into
> > >>>>> FreeBSD's ESP, renamed /efi/boot/BOOTX64.efi to
> /efi/boot/BOOTX64.efi.rh
> > >>>>> and copied FreeBSD's BOOTX64.efi to /efi/boot.
> > >>>>> The Esprimo Q956 tries then to boot(!) RedHat's kernel. It seems,
> that
> > >>>>> the /efi/redhat folder of the ESP is important, if renamed, the
> whole
> > >>>>> process dies as I reported earlier.
> > >>>>>
> > >>>>> Still unanswered is the question: why is a NanoBSD prepared
> UEFI-only USB
> > >>>>> flash booting with CSM disabled (so asumingly UEFI only then) on
> both
> > >>>>> ASRock and Fujitsu (as described in more detail initially and
> earlier),
> > >>>>> while SSDs fail? Is there a difference? Since FreeBSD boots in
> UEFI mode
> > >>>>> from USB flash prepared as described (straight forward, 800k ESP
> starting
> > >>>>> at block 40, the boot1.efifat image dd'ed onto the partition, UFS
> > >>>>> partition following, no freebsd-boot partition or MBR/PMBR bootcode
> > >>>>> applied ever!), I think BOOTX64.EFI is technically all right.
> There must
> > >>>>> be then an issue with the SATA/SSD/HDD boot pathway.
> > >>>>>
> > >>>>> Hope I could provide some more details, sorry if it sounds
> confusing or
> > >>>>> way too long, but I try to descibe the situation as thorough as
> possible.
> > >>>>>
> > >>>>
> > >>>> OK, this is already good hint. The thing with ESP is that there is
> > >>>> ?default? file system tree: EFI/BOOT/BOOT<sysname>.EFI, this is
> noted as
> > >>>> default for *removable* media, fortunately it is usable for hard
> disks as
> > >>>> well, or at least in most cases.
> > >>>>
> > >>>> Now, for non-removable media, the UEFI does provide boot manager
> interface
> > >>>> to define boot entries, and the fact that renaming efi/redhad
> directory did
> > >>>> break the redhat boot, is very loud hint. And this means, this
> system is
> > >>>> probably ignoring efi/boot tree on non-removable media and is
> expecting the
> > >>>> boot manager entry to be created instead.
> > >>>
> > >>> This inplication I'd confirm for the recent Fujitsu ESPRIMO Q956
> firmware
> > >>> (not tested on ASRock Z77-Pro4 firmware).
> > >>>
> > >>>>
> > >>>> UEFI boot manager can be configured /usually/ manually via firmware
> menu,
> > >>>> or by application, such as efibootmgr. The normal approach is to
> create
> > >>>> efi/<vendorname> directory and to copy the application there, then
> create
> > >>>> the boot manager configuration.
> > >>>>
> > >>>> See UEFI specification v2.7, chapter 3 Boot Manager, page 79.
> > >>>>
> > >>>> What is different in FreeBSD case is that the whole interface to
> program
> > >>>> the UEFI Boot Manager is currently being developed, so either it
> has to be
> > >>>> done manually or from some other OS (see
> > >>>> https://wiki.gentoo.org/wiki/Efibootmgr
> > >>>> <https://wiki.gentoo.org/wiki/Efibootmgr> for example, first hit
> from
> > >>>> google:D).
> > >>>
> > >>> Well, thanks for this important hint! FreeBSD 12-CURRENT's and
> FreeBSD
> > >>> 11.2-RELENG's USB flash devices are capable of booting off on
> Fujitsu's
> > >>> ESPRIMO and ASRock's boards. As a note: after "kldload efirt.ko" I
> was able
> > >>> to use the already in FreeBSD present toolset efibootmgr(8) and
> sibblings
> > >>> (the tools do not do anything useful when booted non-UEFI).
> > >>>
> > >>> Mounting the ESP of the harddrive (in my case, ada0p1) to /mnt and
> following
> > >>> the steps in the examples and having created
> /efi/freebsd/BOOTx64.efi as
> > >>> recommended by copy from /efi/boot, let me create a proper boot
> variable.
> > >>>
> > >>> To make things sure, I also applied "efibootmgr -a VARIABLENAME".
> > >>>
> > >>> And ... it worked! Yes, it worked! The ESP is FAT32 formatted, I do
> not know
> > >>> whether this will also work with FAT12/16, I should test this case,
> too.
> > >>>
> > >>> There is a bug in the manpage of efibootmg(8). It does not explain
> the
> > >>> options -d and -p, although they could be "implied" by reading
> carefully.
> > >>> There is now a PR at
> > >>>
> > >>> https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=230080
> > >>>
> > >>> for this issue.
> > >>>
> > >>> So, it's apity that the handbook has no note I could easily find on
> this;
> > >>>
> > >>> Thank you very much for your patience and help!
> > >>>
> > >>> Kind regards,
> > >>> Oliver
> > >>
> > >> yep, efibootmgr does call UEFI RuntimeServices to set up the
> variables, and
> > >> this is only possible when booted UEFI. But glad we finally found the
> root
> > >> cause. It would be good to have HW notes for such cases, it is
> important to
> > >> know that those systems wont boot UEFI from HDD unless the boot
> manager setup
> > >> is done.
> > >>
> > >> rgds,
> > >> toomas
> > >
> > >
> > > This pops up the question how to deal with such HW. We have as a
> institution a
> > > lot of Fujitsu hardware her - from larger servers down to Fujitsu
> ESPRIMO Q956.
> > > The latter one is the first (and so far the only) piece of hardware I
> found
> > > incapable of booting off UEFI within the past 5 years.
> > >
> > > If the "standard" for removeable devices is to boot from
> /efi/boot/bootx64.efi,
> > > than I'd guess it is good luck for FreeBSD that the firmware vendors
> did
> > > fallback to such a mechanism. GRUB/Linux seem to install by default
> their
> > > bootloader into /efi/something/ I'll check on Debian, Suse and CentOS
> so far
> > > soon, the latter probably will, since its the "free" RedHat).
> > >
> > > Anyway, apart from any criticism, I'm glad to have the tools to make
> things
> > > work without using alien help (outside FreeBSD's world!). That is a
> thank you
> > > towards the developers.
> > >
> > > Kind regards,
> > >
> > > oh
> > >
> >
> > The efibootmgr is only relatively recent addition (in illumos we do not
> have yet even
> > access to UEFI RS), so it is only question of time once installer will
> get updated:)
> >
> > But of course there is still an issue about the scenario when the
> install is done in
> > BIOS mode and later switched to UEFI - then the boot manager
> configuration needs to be
> > updated manually (or by some maintenance service like grub2 is calling
> via grub-install
> > script).
> >
> > rgds,
> > toomas
> >
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe@
> freebsd.org"
>
> Just to add another success on ASRock Z77-Pro4 (800k ESP, FAT12) and
> ASRock Z77-Pro4M
> (300mb ESP, FAT32).
>
> On this firmware, I did not have to define/copy the bootloader
> within /efi/freebd/BOOTx64.efi. It was sufficient to add an EFI variable
> as described in
> the manpage efibootmgr(8).
>
> The only pitfall on this firmware (very old, last functional update 2013,
> Spectre/Meltodown mitigation only May 2018) was that I wasn't able to
> activate variable
> "0000"! Creating
>
> efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD-12
>
> which results in "Boot0000"
>
> and followed by
>
> efibootmgr -a 0000
>
> or
>
> efibootmgr -n 0000
>
> resulted in "No such variable" or similar.
>

Yes. that's a bogus sanity check in the code. I've removed it and will
commit in a moment.


> I had to perform the very same task again to gain variable 0001 and then I
> was able to
> "activate" variable 0000. This might be due to the fact the only variable
> defined at all
> was Boot0005 pointing to the most recent USB flash device with 12-CURRENT
> from 2018-07-26
> I just prepared.
>
> Now, also those boxes boot via UEFI (one, 800k ESP with the /efi/boot
> folder, the other,
> 300mb ESP, with a copy /efi/freebsd as I had to do on the Fujitsu ESPRIMO
> Q956 firmware).


OK.

Warner

From miwi at FreeBSD.org  Fri Jul 27 18:08:33 2018
From: miwi at FreeBSD.org (Martin Wilke)
Date: Sat, 28 Jul 2018 02:08:26 +0800
Subject: =?utf-8?Q?Re=3A_make_distribution_fails=2C=C2=A0A_failure_has_bee?=
 =?utf-8?Q?n_detected_in_another_branch_of_the_parallel_make?=
In-Reply-To: <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
 <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
Message-ID: <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>

r336743 CONFSGRP should be CONFSGROUP ?

> On 28 Jul 2018, at 1:30 AM, Charlie Li <ml at vishwin.info> wrote:
> 
> On 27/07/2018 13:21, Martin Wilke wrote:
>> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.
>> 
> I was about to inquire about this myself. Can additionally confirm this
> has been happening since at least r336735.
> 
> -- 
> Charlie Li
> Can't think of a witty .sigline today?
> 
> (This email address is for mailing list use only; replace local-part
> with vishwin for off-list communication)
> 


From imp at bsdimp.com  Fri Jul 27 18:20:29 2018
From: imp at bsdimp.com (Warner Losh)
Date: Fri, 27 Jul 2018 12:20:26 -0600
Subject: [UEFI] Boot issues on some UEFI implementations
In-Reply-To: <CANCZdfrQiJTMOa4HbQve6YW531h__AQKc1nwkr4Fg+YKNRaBwQ@mail.gmail.com>
References: <1E6058D2-5804-480B-B6AF-66AA02CDD7AD@me.com>
 <201807251430.w6PEUWPn041286@pdx.rh.CN85.dnsmgr.net>
 <20180726155821.6f9906e9@freyja.zeit4.iv.bundesimmobilien.de>
 <7FA45CAF-6869-4DF6-AA93-5F96F83EF958@me.com>
 <20180727074558.75b2d730@freyja.zeit4.iv.bundesimmobilien.de>
 <6C5D21D2-59C6-42DB-AC75-79D98BA5E62B@me.com>
 <20180727120232.270e1d9f@freyja.zeit4.iv.bundesimmobilien.de>
 <2A5E5E42-8595-44E9-A51E-504C9C2C7FA7@me.com>
 <20180727190555.55439fb3@thor.intern.walstatt.dynvpn.de>
 <CANCZdfrQiJTMOa4HbQve6YW531h__AQKc1nwkr4Fg+YKNRaBwQ@mail.gmail.com>
Message-ID: <CANCZdfqc9gwcf35a+gQu3PeDpUAPFv9OPrKa=3oqu89JKxVzWQ@mail.gmail.com>

[[ context trimmed ]]

On Fri, Jul 27, 2018 at 12:03 PM, Warner Losh <imp at bsdimp.com> wrote:

>
>
> On Fri, Jul 27, 2018 at 11:05 AM, O. Hartmann <ohartmann at walstatt.org>
> wrote:
>
>>
>> Just to add another success on ASRock Z77-Pro4 (800k ESP, FAT12) and
>> ASRock Z77-Pro4M
>> (300mb ESP, FAT32).
>>
>> On this firmware, I did not have to define/copy the bootloader
>> within /efi/freebd/BOOTx64.efi. It was sufficient to add an EFI variable
>> as described in
>> the manpage efibootmgr(8).
>>
>> The only pitfall on this firmware (very old, last functional update 2013,
>> Spectre/Meltodown mitigation only May 2018) was that I wasn't able to
>> activate variable
>> "0000"! Creating
>>
>> efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD-12
>>
>> which results in "Boot0000"
>>
>> and followed by
>>
>> efibootmgr -a 0000
>>
>> or
>>
>> efibootmgr -n 0000
>>
>> resulted in "No such variable" or similar.
>>
>
> Yes. that's a bogus sanity check in the code. I've removed it and will
> commit in a moment.
>

that should be fixed as of r336768.


> I had to perform the very same task again to gain variable 0001 and then I
>> was able to
>> "activate" variable 0000. This might be due to the fact the only variable
>> defined at all
>> was Boot0005 pointing to the most recent USB flash device with 12-CURRENT
>> from 2018-07-26
>> I just prepared.
>>
>
That part is weird....


> Now, also those boxes boot via UEFI (one, 800k ESP with the /efi/boot
>> folder, the other,
>> 300mb ESP, with a copy /efi/freebsd as I had to do on the Fujitsu ESPRIMO
>> Q956 firmware).
>
>
> OK.
>

Cool!...

Warner

From ml at vishwin.info  Fri Jul 27 19:18:59 2018
From: ml at vishwin.info (Charlie Li)
Date: Fri, 27 Jul 2018 15:18:45 -0400
Subject: =?UTF-8?Q?Re=3a_make_distribution_fails=2c=c2=a0A_failure_has_been_?=
 =?UTF-8?Q?detected_in_another_branch_of_the_parallel_make?=
In-Reply-To: <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
 <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
 <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
Message-ID: <88c46b78-8d48-eb09-a67e-5abbd67261f7@vishwin.info>

On 27/07/2018 14:08, Martin Wilke wrote:
> r336743 CONFSGRP should be CONFSGROUP ?
> 
That line doesn't seem to make any difference.

Probably a jemalloc interaction? Emitted when attempting to update a
-CURRENT arm64.aarch64 cross-build jail:

===> sbin/dump (installconfig)
--- _CONFSINS_null ---
install  -C -o root  -g operator -m 664  /dev/null
/usr/local/poudriere/jails/aarch64-current/etc/dumpdates
<jemalloc>: jemalloc_rtree.c:205: Failed assertion: "!dependent || leaf
!= NULL"
Abort trap (core dumped)
*** [_CONFSINS_null] Error code 134

make[4]: stopped in
/usr/local/poudriere/jails/aarch64-current/usr/src/sbin/dump
1 error

Looking at my amd64.amd64 logs again, the failed assertion message does
indeed appear there as well.

-- 
Charlie Li
Can't think of a witty .sigline today?

(This email address is for mailing list use only; replace local-part
with vishwin for off-list communication)

-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: OpenPGP digital signature
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180727/e0d76f67/attachment.sig>

From brd at FreeBSD.org  Fri Jul 27 19:52:47 2018
From: brd at FreeBSD.org (Brad Davis)
Date: Fri, 27 Jul 2018 13:52:39 -0600
Subject: =?utf-8?Q?Re=3A=20make=20distribut?=
 =?utf-8?Q?ion=20fails=2C=C2=A0A=20failu?=
 =?utf-8?Q?re=20has=20been=20detect?=
 =?utf-8?Q?ed=20in=20another=20bran?=
 =?utf-8?Q?ch=20of=20the=20parallel?= =?utf-8?Q?=20make?=
In-Reply-To: <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
 <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
 <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
Message-ID: <1532721159.3662360.1455244528.139B8E85@webmail.messagingengine.com>

On Fri, Jul 27, 2018, at 12:08 PM, Martin Wilke wrote:
> r336743 CONFSGRP should be CONFSGROUP ?
> 
> > On 28 Jul 2018, at 1:30 AM, Charlie Li <ml at vishwin.info> wrote:
> > 
> > On 27/07/2018 13:21, Martin Wilke wrote:
> >> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.
> >> 
> > I was about to inquire about this myself. Can additionally confirm this
> > has been happening since at least r336735.

I'll update my poudriere jail shortly and see if I can reproduce it.

But CONFSGRP is correct, see share/mk/bsd.confs.mk.


Regards,
Brad Davis

From lwhsu at freebsd.org  Fri Jul 27 21:19:32 2018
From: lwhsu at freebsd.org (Li-Wen Hsu)
Date: Fri, 27 Jul 2018 21:50:43 +0100
Subject: svn commit: r336751 - head/usr.sbin/pw
In-Reply-To: <1532704935.61594.42.camel@freebsd.org>
References: <201807262003.w6QK3B7E026934@repo.freebsd.org>
 <20180727144355.GA47251@freefall.freebsd.org>
 <1532704935.61594.42.camel@freebsd.org>
Message-ID: <CAKBkRUxPwDs+qT1RLZ1-nnp1p7W_mq0kX8S-AWXe8rbpDXJrUA@mail.gmail.com>

On Fri, Jul 27, 2018 at 4:22 PM Ian Lepore <ian at freebsd.org> wrote:
> This was just an error on my part, the code was wrong and I fixed it in
> r336762. This time I made sure the kyua tests pass first.
>
> I had intended to run the kyua tests before and after re-applying my
> changes to pw(8). Now that I look in my scrollback, it seems I ran the
> "before" tests, then got distracted and forgot to run them again after
> and just committed the changes. Sorry about the breakage.

No worries, now the test job is back to normal:

https://ci.freebsd.org/job/FreeBSD-head-amd64-test/8377/

Thanks for your help!

Li-Wen

-- 
Li-Wen Hsu <lwhsu at FreeBSD.org>
https://lwhsu.org

From antoine at freebsd.org  Fri Jul 27 21:22:25 2018
From: antoine at freebsd.org (Antoine Brodin)
Date: Fri, 27 Jul 2018 23:22:23 +0200
Subject: make distribution fails, A failure has been detected in another
 branch of the parallel make
In-Reply-To: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
Message-ID: <CAALwa8k2-SNGfmPzJ=BT6k0wH4NSGw4=Y8zQvVEjrX9jVVUVcg@mail.gmail.com>

On Fri, Jul 27, 2018 at 7:21 PM, Martin Wilke <miwi at freebsd.org> wrote:
> Hi,
>
> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.

portmgr@ reproduces this issue too.

Antoine

From brd at FreeBSD.org  Fri Jul 27 22:08:25 2018
From: brd at FreeBSD.org (Brad Davis)
Date: Fri, 27 Jul 2018 16:08:23 -0600
Subject: =?utf-8?Q?Re=3A=20make=20distribut?=
 =?utf-8?Q?ion=20fails=2C=C2=A0A=20failu?=
 =?utf-8?Q?re=20has=20been=20detect?=
 =?utf-8?Q?ed=20in=20another=20bran?=
 =?utf-8?Q?ch=20of=20the=20parallel?= =?utf-8?Q?=20make?=
In-Reply-To: <1532721159.3662360.1455244528.139B8E85@webmail.messagingengine.com>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
 <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
 <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
 <1532721159.3662360.1455244528.139B8E85@webmail.messagingengine.com>
Message-ID: <1532729303.3864091.1455351560.3184C531@webmail.messagingengine.com>

On Fri, Jul 27, 2018, at 1:52 PM, Brad Davis wrote:
> On Fri, Jul 27, 2018, at 12:08 PM, Martin Wilke wrote:
> > r336743 CONFSGRP should be CONFSGROUP ?
> > 
> > > On 28 Jul 2018, at 1:30 AM, Charlie Li <ml at vishwin.info> wrote:
> > > 
> > > On 27/07/2018 13:21, Martin Wilke wrote:
> > >> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.
> > >> 
> > > I was about to inquire about this myself. Can additionally confirm this
> > > has been happening since at least r336735.
> 
> I'll update my poudriere jail shortly and see if I can reproduce it.
> 
> But CONFSGRP is correct, see share/mk/bsd.confs.mk.

FYI, I have opened this review if you want to try the patch:

https://reviews.freebsd.org/D16476


Regards,
Brad Davis

From brd at FreeBSD.org  Fri Jul 27 22:48:02 2018
From: brd at FreeBSD.org (Brad Davis)
Date: Fri, 27 Jul 2018 16:48:00 -0600
Subject: =?utf-8?Q?Re=3A=20make=20distribut?=
 =?utf-8?Q?ion=20fails=2C=C2=A0A=20failu?=
 =?utf-8?Q?re=20has=20been=20detect?=
 =?utf-8?Q?ed=20in=20another=20bran?=
 =?utf-8?Q?ch=20of=20the=20parallel?= =?utf-8?Q?=20make?=
In-Reply-To: <1532729303.3864091.1455351560.3184C531@webmail.messagingengine.com>
References: <C29CBFF2-4EBC-4C9F-AA36-0A253AD764D6@FreeBSD.org>
 <415fe444-a01a-3ced-257d-a7180f223189@vishwin.info>
 <06B12014-742D-477B-AD85-EA51C6A3EEFE@FreeBSD.org>
 <1532721159.3662360.1455244528.139B8E85@webmail.messagingengine.com>
 <1532729303.3864091.1455351560.3184C531@webmail.messagingengine.com>
Message-ID: <1532731680.922579.1455377000.74BCD325@webmail.messagingengine.com>

On Fri, Jul 27, 2018, at 4:08 PM, Brad Davis wrote:
> On Fri, Jul 27, 2018, at 1:52 PM, Brad Davis wrote:
> > On Fri, Jul 27, 2018, at 12:08 PM, Martin Wilke wrote:
> > > r336743 CONFSGRP should be CONFSGROUP ?
> > > 
> > > > On 28 Jul 2018, at 1:30 AM, Charlie Li <ml at vishwin.info> wrote:
> > > > 
> > > > On 27/07/2018 13:21, Martin Wilke wrote:
> > > >> I just upgraded a jail in poudriere with latest head, https://dpaste.de/bfTT/raw <https://dpaste.de/bfTT/raw>.
> > > >> 
> > > > I was about to inquire about this myself. Can additionally confirm this
> > > > has been happening since at least r336735.
> > 
> > I'll update my poudriere jail shortly and see if I can reproduce it.
> > 
> > But CONFSGRP is correct, see share/mk/bsd.confs.mk.
> 
> FYI, I have opened this review if you want to try the patch:
> 
> https://reviews.freebsd.org/D16476

Committed in r336794.


Regards,
Brad Davis

From gurenchan at gmail.com  Sat Jul 28 02:41:24 2018
From: gurenchan at gmail.com (blubee blubeeme)
Date: Sat, 28 Jul 2018 10:41:11 +0800
Subject: automake-wrapper conflicts
Message-ID: <CALM2mE=-4CbdPgo8N0UMU8R1rVCWx1UGft0wBukod7nMuTsoHQ@mail.gmail.com>

I am getting some build errors around automake-wrapper.

I tried deinstalling automake-wrapper and then installing automake but then
during the installation of automake I get this error:

install-info: warning: no info dir entry in
`/usr/ports/devel/automake/work/stage/usr/local/info/automake-history.info'
 /bin/mkdir -p '/usr/ports/devel/automake/work/stage/usr/local/man/man1'
 install  -m 0644 doc/aclocal.1 doc/automake.1 doc/aclocal-1.16.1
doc/automake-1.16.1
'/usr/ports/devel/automake/work/stage/usr/local/man/man1'
 /bin/mkdir -p
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/Automake'
 install  -m 0644 lib/Automake/Config.pm
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/Automake'
/usr/bin/make  install-data-hook
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/config.guess'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/config.sub'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/install-sh'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/mdate-sh'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/missing'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/mkinstalldirs'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/ylwrap'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/depcomp'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/compile'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/py-compile'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/ar-lib'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/test-driver'
 chmod +x
'/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/tap-driver.sh'
find: /usr/ports/devel/automake/work/stage/usr/local/lib/perl5/site_perl:
No such file or directory
====> Compressing man pages (compress-man)
===>  Installing for automake-1.16.1
===>  Checking if automake already installed
===>   Registering installation for automake-1.16.1
Installing automake-1.16.1...
pkg-static: automake-1.16.1 conflicts with automake-wrapper-20131203
(installs files into the same place).  Problematic file:
/usr/local/bin/aclocal
*** Error code 70


Is this just me or a bug?

Best,
Owen

From gurenchan at gmail.com  Sat Jul 28 02:43:15 2018
From: gurenchan at gmail.com (blubee blubeeme)
Date: Sat, 28 Jul 2018 10:43:02 +0800
Subject: automake-wrapper conflicts
In-Reply-To: <CALM2mE=-4CbdPgo8N0UMU8R1rVCWx1UGft0wBukod7nMuTsoHQ@mail.gmail.com>
References: <CALM2mE=-4CbdPgo8N0UMU8R1rVCWx1UGft0wBukod7nMuTsoHQ@mail.gmail.com>
Message-ID: <CALM2mEn1Lua2KbWbwZATyyuTdMASKLzuOfhKoMLmteHQ7QffrQ@mail.gmail.com>

On Sat, Jul 28, 2018 at 10:41 AM blubee blubeeme <gurenchan at gmail.com>
wrote:

> I am getting some build errors around automake-wrapper.
>
> I tried deinstalling automake-wrapper and then installing automake but
> then during the installation of automake I get this error:
>
> install-info: warning: no info dir entry in
> `/usr/ports/devel/automake/work/stage/usr/local/info/automake-history.info
> '
>  /bin/mkdir -p '/usr/ports/devel/automake/work/stage/usr/local/man/man1'
>  install  -m 0644 doc/aclocal.1 doc/automake.1 doc/aclocal-1.16.1
> doc/automake-1.16.1
> '/usr/ports/devel/automake/work/stage/usr/local/man/man1'
>  /bin/mkdir -p
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/Automake'
>  install  -m 0644 lib/Automake/Config.pm
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/Automake'
> /usr/bin/make  install-data-hook
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/config.guess'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/config.sub'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/install-sh'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/mdate-sh'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/missing'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/mkinstalldirs'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/ylwrap'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/depcomp'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/compile'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/py-compile'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/ar-lib'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/test-driver'
>  chmod +x
> '/usr/ports/devel/automake/work/stage/usr/local/share/automake-1.16/tap-driver.sh'
> find: /usr/ports/devel/automake/work/stage/usr/local/lib/perl5/site_perl:
> No such file or directory
> ====> Compressing man pages (compress-man)
> ===>  Installing for automake-1.16.1
> ===>  Checking if automake already installed
> ===>   Registering installation for automake-1.16.1
> Installing automake-1.16.1...
> pkg-static: automake-1.16.1 conflicts with automake-wrapper-20131203
> (installs files into the same place).  Problematic file:
> /usr/local/bin/aclocal
> *** Error code 70
>
>
> Is this just me or a bug?
>
> Best,
> Owen
>

Okay, seems that UPDATING addresses this issue!

Best,
Owen

From novel at freebsd.org  Sat Jul 28 07:29:50 2018
From: novel at freebsd.org (Roman Bogorodskiy)
Date: Sat, 28 Jul 2018 11:29:40 +0400
Subject: EFI issues
Message-ID: <20180728072938.GA28778@kloomba>

Hi,

I have a test box that's updated to -CURRENT usually once in a week or
two. This box boots using UEFI. After a regular update about two weeks
ago it started to panic on boot frequently (not UEFI related), but I
could not get a crash dump because my swap partition was too small. So I
moved data to the backup drive, repartitioned the main drive and boot
again. This went fine, so I decided to upgrade to fresh -CURRENT from
~Jul 27th. Booting with the new kernel went fine, but after installworld
machine stopped booting, and on the screen I see:

FreeBSD/amd64 EFI loader, ...

..

BootOrder: ....

And then it gets stuck and nothing happens.

As I already have a fresh backup, I decided that it'd be easier to
just re-install and copy data back over (maybe I messed up with
repartitioning). So I've downloaded a fresh snapshot:

FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img

And re-installed. In the installer I choose all the same settings that
were before: UEFI + GPT, default partition scheme it suggested (efi
followed by freebsd-ufs followed by freebsd-swap), just increased the
swap size.

And the newly installed system won't boot just like a previous one:

https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg

Is there a way to recover this?

Roman Bogorodskiy
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 455 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180728/8fdc08da/attachment.sig>

From samy.mahmoudi at gmail.com  Sat Jul 28 10:34:33 2018
From: samy.mahmoudi at gmail.com (Samy Mahmoudi)
Date: Sat, 28 Jul 2018 12:34:31 +0200
Subject: r336806: buildworld failed: emmintrin.h file not found
Message-ID: <CAFigVTOhB-7VC2i9sMzdvB9ML_oqBCLd9+4JFP9t2-WCH024Pg@mail.gmail.com>

---- Basic/SourceManager.o ----
/usr/src/contrib/llvm/tools/clang/lib/Basic/SourceManager.cpp:1175:10 fatal
error: 'emmintrin.h' file not found
#include <emmintrin.h>
              ^------------------
The file is located at
/usr/src/contrib/llvm/tools/clang/lib/Headers/emmintrin.h but I do not know
how to properly indicate this to the build suite.

From samy.mahmoudi at gmail.com  Sat Jul 28 11:06:42 2018
From: samy.mahmoudi at gmail.com (Samy Mahmoudi)
Date: Sat, 28 Jul 2018 13:06:39 +0200
Subject: r336806: buildworld failed: emmintrin.h file not found
In-Reply-To: <CAFigVTOhB-7VC2i9sMzdvB9ML_oqBCLd9+4JFP9t2-WCH024Pg@mail.gmail.com>
References: <CAFigVTOhB-7VC2i9sMzdvB9ML_oqBCLd9+4JFP9t2-WCH024Pg@mail.gmail.com>
Message-ID: <CAFigVTNyw0+FzqJL6=MSR1=5yghdMatkvTZu4hiBwz-s5TVZ8w@mail.gmail.com>

I found an answer in the last comment of
https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=190669

2018-07-28 12:34 GMT+02:00 Samy Mahmoudi <samy.mahmoudi at gmail.com>:

> ---- Basic/SourceManager.o ----
> /usr/src/contrib/llvm/tools/clang/lib/Basic/SourceManager.cpp:1175:10
> fatal error: 'emmintrin.h' file not found
> #include <emmintrin.h>
>               ^------------------
> The file is located at /usr/src/contrib/llvm/tools/clang/lib/Headers/emmintrin.h
> but I do not know how to properly indicate this to the build suite.
>

From shawn.webb at hardenedbsd.org  Sat Jul 28 17:18:40 2018
From: shawn.webb at hardenedbsd.org (Shawn Webb)
Date: Sat, 28 Jul 2018 13:17:45 -0400
Subject: Booting arm64 uefi broken
Message-ID: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>

It appears with the latest 12-CURRENT/arm64, booting is broken. The
boot process gets stuck after the "Using DTB provided by..." message.

This is on my SoftIron OverDrive 1000:

>> FreeBSD EFI boot block                                                       
   Loader path: /boot/loader.efi                                                
                                                                                
   Initializing modules: ZFS UFS                                                
   Load Path: \EFI\BOOT\BOOTAA64.EFI                                            
   Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
   BootCurrent: 0002                                                            
   BootOrder: 0001 0005 0006 0000 0002[*]                                       
   Probing 7 block devices......+..* done                                       
    ZFS found the following pools: rpool                                        
    UFS found 1 partition                                                       
Consoles: EFI console                                                           
FreeBSD/arm64 EFI loader, Revision 1.1                                          
(Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)                
                                                                                
   Command line arguments: loader.efi                                           
   EFI version: 2.60                                                            
   EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)                             
   Console: efi (0)                                                             
   Load Path: HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)     
   Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
   BootCurrent: 0002                                                            
   BootOrder: 0001 0005 0006 0000 0002[*]                                       
   BootInfo Path: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)          
Ignoring Boot0002: Only one DP found                                            
Trying ESP: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
Setting currdev to disk1p2:                                                     
Loading /boot/defaults/loader.conf                                              
/boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc syms=[0x8+0x11d108+0x8+0x10e646]
/boot/entropy size=0x1000                                                       
efi-autoresizecons: Neither Graphics Output Protocol nor Universal Graphics Adapter present
                                                                                
Hit [Enter] to boot immediately, or any other key for command prompt.           
Booting [/boot/kernel/kernel]...                                                
Using DTB provided by EFI at 0x801fe00000.

Thanks,

-- 
Shawn Webb
Cofounder and Security Engineer
HardenedBSD

Tor-ified Signal:    +1 443-546-8752
Tor+XMPP+OTR:        lattera at is.a.hacker.sx
GPG Key ID:          0x6A84658F52456EEE
GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180728/ca384acb/attachment.sig>

From markj at freebsd.org  Sat Jul 28 18:08:39 2018
From: markj at freebsd.org (Mark Johnston)
Date: Sat, 28 Jul 2018 14:08:31 -0400
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
Message-ID: <20180728180831.GA73141@raichu>

On Sat, Jul 28, 2018 at 01:17:45PM -0400, Shawn Webb wrote:
> It appears with the latest 12-CURRENT/arm64, booting is broken. The
> boot process gets stuck after the "Using DTB provided by..." message.
> 
> This is on my SoftIron OverDrive 1000:

You might try the patch here: https://reviews.freebsd.org/D16463

From imp at bsdimp.com  Sat Jul 28 18:10:54 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sat, 28 Jul 2018 12:10:40 -0600
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728180831.GA73141@raichu>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728180831.GA73141@raichu>
Message-ID: <CANCZdfqs3_eC1hOyNnm73G+DkCg-WtqRs9waF9CXnVy+9UDvrg@mail.gmail.com>

On Sat, Jul 28, 2018, 12:08 PM Mark Johnston <markj at freebsd.org> wrote:

> On Sat, Jul 28, 2018 at 01:17:45PM -0400, Shawn Webb wrote:
> > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > boot process gets stuck after the "Using DTB provided by..." message.
> >
> > This is on my SoftIron OverDrive 1000:
>
> You might try the patch here: https://reviews.freebsd.org/D16463


That's in the tree now...

Warner

>
>

From manu at bidouilliste.com  Sat Jul 28 18:28:40 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Sat, 28 Jul 2018 20:28:30 +0200
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
Message-ID: <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>

On Sat, 28 Jul 2018 13:17:45 -0400
Shawn Webb <shawn.webb at hardenedbsd.org> wrote:

> It appears with the latest 12-CURRENT/arm64, booting is broken. The
> boot process gets stuck after the "Using DTB provided by..." message.
> 
> This is on my SoftIron OverDrive 1000:
> 
> >> FreeBSD EFI boot block                                                       
>    Loader path: /boot/loader.efi                                                
>                                                                                 
>    Initializing modules: ZFS UFS                                                
>    Load Path: \EFI\BOOT\BOOTAA64.EFI                                            
>    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
>    BootCurrent: 0002                                                            
>    BootOrder: 0001 0005 0006 0000 0002[*]                                       
>    Probing 7 block devices......+..* done                                       
>     ZFS found the following pools: rpool                                        
>     UFS found 1 partition                                                       
> Consoles: EFI console                                                           
> FreeBSD/arm64 EFI loader, Revision 1.1                                          
> (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)                
>                                                                                 
>    Command line arguments: loader.efi                                           
>    EFI version: 2.60                                                            
>    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)                             
>    Console: efi (0)                                                             
>    Load Path: HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)     
>    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
>    BootCurrent: 0002                                                            
>    BootOrder: 0001 0005 0006 0000 0002[*]                                       
>    BootInfo Path: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)          
> Ignoring Boot0002: Only one DP found                                            
> Trying ESP: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> Setting currdev to disk1p2:                                                     
> Loading /boot/defaults/loader.conf                                              
> /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc syms=[0x8+0x11d108+0x8+0x10e646]
> /boot/entropy size=0x1000                                                       
> efi-autoresizecons: Neither Graphics Output Protocol nor Universal Graphics Adapter present
>                                                                                 
> Hit [Enter] to boot immediately, or any other key for command prompt.           
> Booting [/boot/kernel/kernel]...                                                
> Using DTB provided by EFI at 0x801fe00000.
> 
> Thanks,
> 
> -- 
> Shawn Webb
> Cofounder and Security Engineer
> HardenedBSD
> 
> Tor-ified Signal:    +1 443-546-8752
> Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> GPG Key ID:          0x6A84658F52456EEE
> GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE

 Latest kernel works for me :

 FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
r336834: Sat Jul 28 20:23:33 CEST 2018
root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
arm64

 I'll try with latest loader.efi

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From manu at bidouilliste.com  Sat Jul 28 18:34:34 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Sat, 28 Jul 2018 20:34:31 +0200
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
Message-ID: <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>

On Sat, 28 Jul 2018 20:28:30 +0200
Emmanuel Vadot <manu at bidouilliste.com> wrote:

> On Sat, 28 Jul 2018 13:17:45 -0400
> Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> 
> > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > boot process gets stuck after the "Using DTB provided by..." message.
> > 
> > This is on my SoftIron OverDrive 1000:
> > 
> > >> FreeBSD EFI boot block                                                       
> >    Loader path: /boot/loader.efi                                                
> >                                                                                 
> >    Initializing modules: ZFS UFS                                                
> >    Load Path: \EFI\BOOT\BOOTAA64.EFI                                            
> >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> >    BootCurrent: 0002                                                            
> >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> >    Probing 7 block devices......+..* done                                       
> >     ZFS found the following pools: rpool                                        
> >     UFS found 1 partition                                                       
> > Consoles: EFI console                                                           
> > FreeBSD/arm64 EFI loader, Revision 1.1                                          
> > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)                
> >                                                                                 
> >    Command line arguments: loader.efi                                           
> >    EFI version: 2.60                                                            
> >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)                             
> >    Console: efi (0)                                                             
> >    Load Path: HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)     
> >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> >    BootCurrent: 0002                                                            
> >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> >    BootInfo Path: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)          
> > Ignoring Boot0002: Only one DP found                                            
> > Trying ESP: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > Setting currdev to disk1p2:                                                     
> > Loading /boot/defaults/loader.conf                                              
> > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc syms=[0x8+0x11d108+0x8+0x10e646]
> > /boot/entropy size=0x1000                                                       
> > efi-autoresizecons: Neither Graphics Output Protocol nor Universal Graphics Adapter present
> >                                                                                 
> > Hit [Enter] to boot immediately, or any other key for command prompt.           
> > Booting [/boot/kernel/kernel]...                                                
> > Using DTB provided by EFI at 0x801fe00000.
> > 
> > Thanks,
> > 
> > -- 
> > Shawn Webb
> > Cofounder and Security Engineer
> > HardenedBSD
> > 
> > Tor-ified Signal:    +1 443-546-8752
> > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > GPG Key ID:          0x6A84658F52456EEE
> > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
> 
>  Latest kernel works for me :
> 
>  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> r336834: Sat Jul 28 20:23:33 CEST 2018
> root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
> arm64
> 
>  I'll try with latest loader.efi
> 
> -- 
> Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

 Latest loader.efi fails for me the same way, Shawn did you start
bisecting ?

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From shawn.webb at hardenedbsd.org  Sat Jul 28 18:37:11 2018
From: shawn.webb at hardenedbsd.org (Shawn Webb)
Date: Sat, 28 Jul 2018 14:36:29 -0400
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
Message-ID: <20180728183629.wxxabsnyrnqlmwog@mutt-hbsd>

On Sat, Jul 28, 2018 at 08:34:31PM +0200, Emmanuel Vadot wrote:
> On Sat, 28 Jul 2018 20:28:30 +0200
> Emmanuel Vadot <manu at bidouilliste.com> wrote:
> 
> > On Sat, 28 Jul 2018 13:17:45 -0400
> > Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> > 
> > > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > > boot process gets stuck after the "Using DTB provided by..." message.
> > > 
> > > This is on my SoftIron OverDrive 1000:
> > > 
> > > >> FreeBSD EFI boot block                                                       
> > >    Loader path: /boot/loader.efi                                                
> > >                                                                                 
> > >    Initializing modules: ZFS UFS                                                
> > >    Load Path: \EFI\BOOT\BOOTAA64.EFI                                            
> > >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> > >    BootCurrent: 0002                                                            
> > >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> > >    Probing 7 block devices......+..* done                                       
> > >     ZFS found the following pools: rpool                                        
> > >     UFS found 1 partition                                                       
> > > Consoles: EFI console                                                           
> > > FreeBSD/arm64 EFI loader, Revision 1.1                                          
> > > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)                
> > >                                                                                 
> > >    Command line arguments: loader.efi                                           
> > >    EFI version: 2.60                                                            
> > >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)                             
> > >    Console: efi (0)                                                             
> > >    Load Path: HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)     
> > >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > >    BootCurrent: 0002                                                            
> > >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> > >    BootInfo Path: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)          
> > > Ignoring Boot0002: Only one DP found                                            
> > > Trying ESP: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > Setting currdev to disk1p2:                                                     
> > > Loading /boot/defaults/loader.conf                                              
> > > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc syms=[0x8+0x11d108+0x8+0x10e646]
> > > /boot/entropy size=0x1000                                                       
> > > efi-autoresizecons: Neither Graphics Output Protocol nor Universal Graphics Adapter present
> > >                                                                                 
> > > Hit [Enter] to boot immediately, or any other key for command prompt.           
> > > Booting [/boot/kernel/kernel]...                                                
> > > Using DTB provided by EFI at 0x801fe00000.
> > > 
> > > Thanks,
> > > 
> > > -- 
> > > Shawn Webb
> > > Cofounder and Security Engineer
> > > HardenedBSD
> > > 
> > > Tor-ified Signal:    +1 443-546-8752
> > > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > > GPG Key ID:          0x6A84658F52456EEE
> > > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
> > 
> >  Latest kernel works for me :
> > 
> >  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> > r336834: Sat Jul 28 20:23:33 CEST 2018
> > root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
> > arm64
> > 
> >  I'll try with latest loader.efi
> > 
> > -- 
> > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 
>  Latest loader.efi fails for me the same way, Shawn did you start
> bisecting ?

Not yet. I don't have the time to right now. Probably won't for a
while.

Thanks,

-- 
Shawn Webb
Cofounder and Security Engineer
HardenedBSD

Tor-ified Signal:    +1 443-546-8752
Tor+XMPP+OTR:        lattera at is.a.hacker.sx
GPG Key ID:          0x6A84658F52456EEE
GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180728/e77d63b6/attachment.sig>

From manu at bidouilliste.com  Sat Jul 28 18:52:21 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Sat, 28 Jul 2018 20:52:18 +0200
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
Message-ID: <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>

On Sat, 28 Jul 2018 20:34:31 +0200
Emmanuel Vadot <manu at bidouilliste.com> wrote:

> On Sat, 28 Jul 2018 20:28:30 +0200
> Emmanuel Vadot <manu at bidouilliste.com> wrote:
> 
> > On Sat, 28 Jul 2018 13:17:45 -0400
> > Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> > 
> > > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > > boot process gets stuck after the "Using DTB provided by..." message.
> > > 
> > > This is on my SoftIron OverDrive 1000:
> > > 
> > > >> FreeBSD EFI boot block                                                       
> > >    Loader path: /boot/loader.efi                                                
> > >                                                                                 
> > >    Initializing modules: ZFS UFS                                                
> > >    Load Path: \EFI\BOOT\BOOTAA64.EFI                                            
> > >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> > >    BootCurrent: 0002                                                            
> > >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> > >    Probing 7 block devices......+..* done                                       
> > >     ZFS found the following pools: rpool                                        
> > >     UFS found 1 partition                                                       
> > > Consoles: EFI console                                                           
> > > FreeBSD/arm64 EFI loader, Revision 1.1                                          
> > > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)                
> > >                                                                                 
> > >    Command line arguments: loader.efi                                           
> > >    EFI version: 2.60                                                            
> > >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)                             
> > >    Console: efi (0)                                                             
> > >    Load Path: HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)     
> > >    Load Device: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > >    BootCurrent: 0002                                                            
> > >    BootOrder: 0001 0005 0006 0000 0002[*]                                       
> > >    BootInfo Path: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)          
> > > Ignoring Boot0002: Only one DP found                                            
> > > Trying ESP: PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > Setting currdev to disk1p2:                                                     
> > > Loading /boot/defaults/loader.conf                                              
> > > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc syms=[0x8+0x11d108+0x8+0x10e646]
> > > /boot/entropy size=0x1000                                                       
> > > efi-autoresizecons: Neither Graphics Output Protocol nor Universal Graphics Adapter present
> > >                                                                                 
> > > Hit [Enter] to boot immediately, or any other key for command prompt.           
> > > Booting [/boot/kernel/kernel]...                                                
> > > Using DTB provided by EFI at 0x801fe00000.
> > > 
> > > Thanks,
> > > 
> > > -- 
> > > Shawn Webb
> > > Cofounder and Security Engineer
> > > HardenedBSD
> > > 
> > > Tor-ified Signal:    +1 443-546-8752
> > > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > > GPG Key ID:          0x6A84658F52456EEE
> > > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
> > 
> >  Latest kernel works for me :
> > 
> >  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> > r336834: Sat Jul 28 20:23:33 CEST 2018
> > root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
> > arm64
> > 
> >  I'll try with latest loader.efi
> > 
> > -- 
> > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"
> 
>  Latest loader.efi fails for me the same way, Shawn did you start
> bisecting ?
> 

 Problem is between 20180709 and 20180719

-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From imp at bsdimp.com  Sat Jul 28 19:27:21 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sat, 28 Jul 2018 13:27:08 -0600
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
 <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>
Message-ID: <CANCZdfo_71kMg1of-1ZENK=-2-w_2-iLJ5SSi9RfbCCrbrgfuQ@mail.gmail.com>

Let me know the rev... all my fixes are in the tree...

Warner

On Sat, Jul 28, 2018, 12:52 PM Emmanuel Vadot <manu at bidouilliste.com> wrote:

> On Sat, 28 Jul 2018 20:34:31 +0200
> Emmanuel Vadot <manu at bidouilliste.com> wrote:
>
> > On Sat, 28 Jul 2018 20:28:30 +0200
> > Emmanuel Vadot <manu at bidouilliste.com> wrote:
> >
> > > On Sat, 28 Jul 2018 13:17:45 -0400
> > > Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> > >
> > > > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > > > boot process gets stuck after the "Using DTB provided by..." message.
> > > >
> > > > This is on my SoftIron OverDrive 1000:
> > > >
> > > > >> FreeBSD EFI boot block
>
> > > >    Loader path: /boot/loader.efi
>
> > > >
>
> > > >    Initializing modules: ZFS UFS
>
> > > >    Load Path: \EFI\BOOT\BOOTAA64.EFI
>
> > > >    Load Device:
> PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> > > >    BootCurrent: 0002
>
> > > >    BootOrder: 0001 0005 0006 0000 0002[*]
>
> > > >    Probing 7 block devices......+..* done
>
> > > >     ZFS found the following pools: rpool
>
> > > >     UFS found 1 partition
>
> > > > Consoles: EFI console
>
> > > > FreeBSD/arm64 EFI loader, Revision 1.1
>
> > > > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)
>
> > > >
>
> > > >    Command line arguments: loader.efi
>
> > > >    EFI version: 2.60
>
> > > >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)
>
> > > >    Console: efi (0)
>
> > > >    Load Path:
> HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > >    Load Device:
> PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > >    BootCurrent: 0002
>
> > > >    BootOrder: 0001 0005 0006 0000 0002[*]
>
> > > >    BootInfo Path:
> PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)
> > > > Ignoring Boot0002: Only one DP found
>
> > > > Trying ESP:
> PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > Setting currdev to disk1p2:
>
> > > > Loading /boot/defaults/loader.conf
>
> > > > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc
> syms=[0x8+0x11d108+0x8+0x10e646]
> > > > /boot/entropy size=0x1000
>
> > > > efi-autoresizecons: Neither Graphics Output Protocol nor Universal
> Graphics Adapter present
> > > >
>
> > > > Hit [Enter] to boot immediately, or any other key for command
> prompt.
> > > > Booting [/boot/kernel/kernel]...
>
> > > > Using DTB provided by EFI at 0x801fe00000.
> > > >
> > > > Thanks,
> > > >
> > > > --
> > > > Shawn Webb
> > > > Cofounder and Security Engineer
> > > > HardenedBSD
> > > >
> > > > Tor-ified Signal:    +1 443-546-8752
> > > > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > > > GPG Key ID:          0x6A84658F52456EEE
> > > > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245
> 6EEE
> > >
> > >  Latest kernel works for me :
> > >
> > >  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> > > r336834: Sat Jul 28 20:23:33 CEST 2018
> > > root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
> > > arm64
> > >
> > >  I'll try with latest loader.efi
> > >
> > > --
> > > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > > _______________________________________________
> > > freebsd-current at freebsd.org mailing list
> > > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > > To unsubscribe, send any mail to "
> freebsd-current-unsubscribe at freebsd.org"
> >
> >  Latest loader.efi fails for me the same way, Shawn did you start
> > bisecting ?
> >
>
>  Problem is between 20180709 and 20180719
>
> --
> Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
>

From manu at bidouilliste.com  Sat Jul 28 19:50:28 2018
From: manu at bidouilliste.com (Emmanuel Vadot)
Date: Sat, 28 Jul 2018 21:50:25 +0200
Subject: Booting arm64 uefi broken
In-Reply-To: <CANCZdfo_71kMg1of-1ZENK=-2-w_2-iLJ5SSi9RfbCCrbrgfuQ@mail.gmail.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
 <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>
 <CANCZdfo_71kMg1of-1ZENK=-2-w_2-iLJ5SSi9RfbCCrbrgfuQ@mail.gmail.com>
Message-ID: <20180728215025.f5acbac48ab0969eff2e7545@bidouilliste.com>

On Sat, 28 Jul 2018 13:27:08 -0600
Warner Losh <imp at bsdimp.com> wrote:

> Let me know the rev... all my fixes are in the tree...
> 
> Warner

 Fixed by r336837

 Thanks,

> On Sat, Jul 28, 2018, 12:52 PM Emmanuel Vadot <manu at bidouilliste.com> wrote:
> 
> > On Sat, 28 Jul 2018 20:34:31 +0200
> > Emmanuel Vadot <manu at bidouilliste.com> wrote:
> >
> > > On Sat, 28 Jul 2018 20:28:30 +0200
> > > Emmanuel Vadot <manu at bidouilliste.com> wrote:
> > >
> > > > On Sat, 28 Jul 2018 13:17:45 -0400
> > > > Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> > > >
> > > > > It appears with the latest 12-CURRENT/arm64, booting is broken. The
> > > > > boot process gets stuck after the "Using DTB provided by..." message.
> > > > >
> > > > > This is on my SoftIron OverDrive 1000:
> > > > >
> > > > > >> FreeBSD EFI boot block
> >
> > > > >    Loader path: /boot/loader.efi
> >
> > > > >
> >
> > > > >    Initializing modules: ZFS UFS
> >
> > > > >    Load Path: \EFI\BOOT\BOOTAA64.EFI
> >
> > > > >    Load Device:
> > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> > > > >    BootCurrent: 0002
> >
> > > > >    BootOrder: 0001 0005 0006 0000 0002[*]
> >
> > > > >    Probing 7 block devices......+..* done
> >
> > > > >     ZFS found the following pools: rpool
> >
> > > > >     UFS found 1 partition
> >
> > > > > Consoles: EFI console
> >
> > > > > FreeBSD/arm64 EFI loader, Revision 1.1
> >
> > > > > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)
> >
> > > > >
> >
> > > > >    Command line arguments: loader.efi
> >
> > > > >    EFI version: 2.60
> >
> > > > >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)
> >
> > > > >    Console: efi (0)
> >
> > > > >    Load Path:
> > HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > >    Load Device:
> > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > >    BootCurrent: 0002
> >
> > > > >    BootOrder: 0001 0005 0006 0000 0002[*]
> >
> > > > >    BootInfo Path:
> > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)
> > > > > Ignoring Boot0002: Only one DP found
> >
> > > > > Trying ESP:
> > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > > Setting currdev to disk1p2:
> >
> > > > > Loading /boot/defaults/loader.conf
> >
> > > > > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc
> > syms=[0x8+0x11d108+0x8+0x10e646]
> > > > > /boot/entropy size=0x1000
> >
> > > > > efi-autoresizecons: Neither Graphics Output Protocol nor Universal
> > Graphics Adapter present
> > > > >
> >
> > > > > Hit [Enter] to boot immediately, or any other key for command
> > prompt.
> > > > > Booting [/boot/kernel/kernel]...
> >
> > > > > Using DTB provided by EFI at 0x801fe00000.
> > > > >
> > > > > Thanks,
> > > > >
> > > > > --
> > > > > Shawn Webb
> > > > > Cofounder and Security Engineer
> > > > > HardenedBSD
> > > > >
> > > > > Tor-ified Signal:    +1 443-546-8752
> > > > > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > > > > GPG Key ID:          0x6A84658F52456EEE
> > > > > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245
> > 6EEE
> > > >
> > > >  Latest kernel works for me :
> > > >
> > > >  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> > > > r336834: Sat Jul 28 20:23:33 CEST 2018
> > > > root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/GENERIC
> > > > arm64
> > > >
> > > >  I'll try with latest loader.efi
> > > >
> > > > --
> > > > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > > > _______________________________________________
> > > > freebsd-current at freebsd.org mailing list
> > > > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > > > To unsubscribe, send any mail to "
> > freebsd-current-unsubscribe at freebsd.org"
> > >
> > >  Latest loader.efi fails for me the same way, Shawn did you start
> > > bisecting ?
> > >
> >
> >  Problem is between 20180709 and 20180719
> >
> > --
> > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> >
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"


-- 
Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>

From imp at bsdimp.com  Sat Jul 28 19:55:09 2018
From: imp at bsdimp.com (Warner Losh)
Date: Sat, 28 Jul 2018 13:55:07 -0600
Subject: Booting arm64 uefi broken
In-Reply-To: <20180728215025.f5acbac48ab0969eff2e7545@bidouilliste.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
 <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>
 <CANCZdfo_71kMg1of-1ZENK=-2-w_2-iLJ5SSi9RfbCCrbrgfuQ@mail.gmail.com>
 <20180728215025.f5acbac48ab0969eff2e7545@bidouilliste.com>
Message-ID: <CANCZdfoz3JEJVVYtm9skwUV=6DfcduCVO59Gh_7SRERJj2ZDMg@mail.gmail.com>

On Sat, Jul 28, 2018 at 1:50 PM, Emmanuel Vadot <manu at bidouilliste.com>
wrote:

> On Sat, 28 Jul 2018 13:27:08 -0600
> Warner Losh <imp at bsdimp.com> wrote:
>
> > Let me know the rev... all my fixes are in the tree...
> >
> > Warner
>
>  Fixed by r336837
>

Yea, I thought I'd pushed all my in-flight src/stand branches yesterday,
but I had one on a different machine that wasn't, and it was this one.
Sorry for the hassle, it had been ready to go for a couple days...

Warner


>  Thanks,
>
> > On Sat, Jul 28, 2018, 12:52 PM Emmanuel Vadot <manu at bidouilliste.com>
> wrote:
> >
> > > On Sat, 28 Jul 2018 20:34:31 +0200
> > > Emmanuel Vadot <manu at bidouilliste.com> wrote:
> > >
> > > > On Sat, 28 Jul 2018 20:28:30 +0200
> > > > Emmanuel Vadot <manu at bidouilliste.com> wrote:
> > > >
> > > > > On Sat, 28 Jul 2018 13:17:45 -0400
> > > > > Shawn Webb <shawn.webb at hardenedbsd.org> wrote:
> > > > >
> > > > > > It appears with the latest 12-CURRENT/arm64, booting is broken.
> The
> > > > > > boot process gets stuck after the "Using DTB provided by..."
> message.
> > > > > >
> > > > > > This is on my SoftIron OverDrive 1000:
> > > > > >
> > > > > > >> FreeBSD EFI boot block
> > >
> > > > > >    Loader path: /boot/loader.efi
> > >
> > > > > >
> > >
> > > > > >    Initializing modules: ZFS UFS
> > >
> > > > > >    Load Path: \EFI\BOOT\BOOTAA64.EFI
> > >
> > > > > >    Load Device:
> > > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(
> 1,GPT,73365FD5-9260-11E8-9F00-0026B93F5298,0x3,0x640)
> > > > > >    BootCurrent: 0002
> > >
> > > > > >    BootOrder: 0001 0005 0006 0000 0002[*]
> > >
> > > > > >    Probing 7 block devices......+..* done
> > >
> > > > > >     ZFS found the following pools: rpool
> > >
> > > > > >     UFS found 1 partition
> > >
> > > > > > Consoles: EFI console
> > >
> > > > > > FreeBSD/arm64 EFI loader, Revision 1.1
> > >
> > > > > > (Sat Jul 28 11:32:06 UTC 2018 root at nyi-01.build.hardenedbsd.org)
> > >
> > > > > >
> > >
> > > > > >    Command line arguments: loader.efi
> > >
> > > > > >    EFI version: 2.60
> > >
> > > > > >    EFI Firmware: SoftIron Overdrive 1000 (rev 1.00)
> > >
> > > > > >    Console: efi (0)
> > >
> > > > > >    Load Path:
> > > HD(2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > > >    Load Device:
> > > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(
> 2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > > >    BootCurrent: 0002
> > >
> > > > > >    BootOrder: 0001 0005 0006 0000 0002[*]
> > >
> > > > > >    BootInfo Path:
> > > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)
> > > > > > Ignoring Boot0002: Only one DP found
> > >
> > > > > > Trying ESP:
> > > PcieRoot(0x0)/Pci(0x2,0x2)/Pci(0x0,0x0)/USB(0x2,0x0)/HD(
> 2,GPT,73365FE7-9260-11E8-9F00-0026B93F5298,0x643,0x107D00)
> > > > > > Setting currdev to disk1p2:
> > >
> > > > > > Loading /boot/defaults/loader.conf
> > >
> > > > > > /boot/kernel/kernel text=0x8a7169 data=0x1384d0+0x7d39fc
> > > syms=[0x8+0x11d108+0x8+0x10e646]
> > > > > > /boot/entropy size=0x1000
> > >
> > > > > > efi-autoresizecons: Neither Graphics Output Protocol nor
> Universal
> > > Graphics Adapter present
> > > > > >
> > >
> > > > > > Hit [Enter] to boot immediately, or any other key for command
> > > prompt.
> > > > > > Booting [/boot/kernel/kernel]...
> > >
> > > > > > Using DTB provided by EFI at 0x801fe00000.
> > > > > >
> > > > > > Thanks,
> > > > > >
> > > > > > --
> > > > > > Shawn Webb
> > > > > > Cofounder and Security Engineer
> > > > > > HardenedBSD
> > > > > >
> > > > > > Tor-ified Signal:    +1 443-546-8752
> > > > > > Tor+XMPP+OTR:        lattera at is.a.hacker.sx
> > > > > > GPG Key ID:          0x6A84658F52456EEE
> > > > > > GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F
> 5245
> > > 6EEE
> > > > >
> > > > >  Latest kernel works for me :
> > > > >
> > > > >  FreeBSD od1000.home.blih.net 12.0-CURRENT FreeBSD 12.0-CURRENT #3
> > > > > r336834: Sat Jul 28 20:23:33 CEST 2018
> > > > > root at od1000.home.blih.net:/usr/o bj/usr/src/arm64.aarch64/sys/
> GENERIC
> > > > > arm64
> > > > >
> > > > >  I'll try with latest loader.efi
> > > > >
> > > > > --
> > > > > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > > > > _______________________________________________
> > > > > freebsd-current at freebsd.org mailing list
> > > > > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > > > > To unsubscribe, send any mail to "
> > > freebsd-current-unsubscribe at freebsd.org"
> > > >
> > > >  Latest loader.efi fails for me the same way, Shawn did you start
> > > > bisecting ?
> > > >
> > >
> > >  Problem is between 20180709 and 20180719
> > >
> > > --
> > > Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
> > >
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe@
> freebsd.org"
>
>
> --
> Emmanuel Vadot <manu at bidouilliste.com> <manu at freebsd.org>
>

From shawn.webb at hardenedbsd.org  Sat Jul 28 20:28:35 2018
From: shawn.webb at hardenedbsd.org (Shawn Webb)
Date: Sat, 28 Jul 2018 16:27:53 -0400
Subject: Booting arm64 uefi broken
In-Reply-To: <CANCZdfoz3JEJVVYtm9skwUV=6DfcduCVO59Gh_7SRERJj2ZDMg@mail.gmail.com>
References: <20180728171745.e5g6dfrcjdn2mtg4@mutt-hbsd>
 <20180728202830.5ff22ce7b88c6cbf2cf25e18@bidouilliste.com>
 <20180728203431.4cb39877c0e1a9c55daf9641@bidouilliste.com>
 <20180728205218.ef2661f72f27709c5d829708@bidouilliste.com>
 <CANCZdfo_71kMg1of-1ZENK=-2-w_2-iLJ5SSi9RfbCCrbrgfuQ@mail.gmail.com>
 <20180728215025.f5acbac48ab0969eff2e7545@bidouilliste.com>
 <CANCZdfoz3JEJVVYtm9skwUV=6DfcduCVO59Gh_7SRERJj2ZDMg@mail.gmail.com>
Message-ID: <20180728202753.p7mou4gmot54mzy6@mutt-hbsd>

On Sat, Jul 28, 2018 at 01:55:07PM -0600, Warner Losh wrote:
> On Sat, Jul 28, 2018 at 1:50 PM, Emmanuel Vadot <manu at bidouilliste.com>
> wrote:
> 
> > On Sat, 28 Jul 2018 13:27:08 -0600
> > Warner Losh <imp at bsdimp.com> wrote:
> >
> > > Let me know the rev... all my fixes are in the tree...
> > >
> > > Warner
> >
> >  Fixed by r336837
> >
> 
> Yea, I thought I'd pushed all my in-flight src/stand branches yesterday,
> but I had one on a different machine that wasn't, and it was this one.
> Sorry for the hassle, it had been ready to go for a couple days...

Thanks for commiting the fix! I really appreciate it. :)

-- 
Shawn Webb
Cofounder and Security Engineer
HardenedBSD

Tor-ified Signal:    +1 443-546-8752
Tor+XMPP+OTR:        lattera at is.a.hacker.sx
GPG Key ID:          0x6A84658F52456EEE
GPG Key Fingerprint: 2ABA B6BD EF6A F486 BE89  3D9E 6A84 658F 5245 6EEE
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 833 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180728/20dcd281/attachment.sig>

From novel at freebsd.org  Sun Jul 29 07:05:19 2018
From: novel at freebsd.org (Roman Bogorodskiy)
Date: Sun, 29 Jul 2018 11:05:09 +0400
Subject: EFI issues
In-Reply-To: <20180728072938.GA28778@kloomba>
References: <20180728072938.GA28778@kloomba>
Message-ID: <20180729070507.GA2216@kloomba>

  Roman Bogorodskiy wrote:

> Hi,
> 
> I have a test box that's updated to -CURRENT usually once in a week or
> two. This box boots using UEFI. After a regular update about two weeks
> ago it started to panic on boot frequently (not UEFI related), but I
> could not get a crash dump because my swap partition was too small. So I
> moved data to the backup drive, repartitioned the main drive and boot
> again. This went fine, so I decided to upgrade to fresh -CURRENT from
> ~Jul 27th. Booting with the new kernel went fine, but after installworld
> machine stopped booting, and on the screen I see:
> 
> FreeBSD/amd64 EFI loader, ...
> 
> ..
> 
> BootOrder: ....
> 
> And then it gets stuck and nothing happens.
> 
> As I already have a fresh backup, I decided that it'd be easier to
> just re-install and copy data back over (maybe I messed up with
> repartitioning). So I've downloaded a fresh snapshot:
> 
> FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> 
> And re-installed. In the installer I choose all the same settings that
> were before: UEFI + GPT, default partition scheme it suggested (efi
> followed by freebsd-ufs followed by freebsd-swap), just increased the
> swap size.
> 
> And the newly installed system won't boot just like a previous one:
> 
> https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> 
> Is there a way to recover this?

Tried updating to get r336837 mentioned in another thread, and it still
doesn't help.

Current version is r336859. Partitioning schema looks this way:

=>        40  1953525088  ada0  GPT  (932G)
          40      409600     1  efi  (200M)
      409640  1803550720     2  freebsd-ufs  (860G)
  1803960360   148897792     3  freebsd-swap  (71G)
  1952858152      666976        - free -  (326M)

I can boot it when booting from memstick r336739 and setting
vfs.root.mountfrom="ufs:ada0p2".

Roman Bogorodskiy
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 455 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180729/d9087210/attachment.sig>

From ohartmann at walstatt.org  Sun Jul 29 07:50:20 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Sun, 29 Jul 2018 09:44:35 +0200
Subject: EFI issues
In-Reply-To: <20180728072938.GA28778@kloomba>
References: <20180728072938.GA28778@kloomba>
Message-ID: <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Sat, 28 Jul 2018 11:29:40 +0400
Roman Bogorodskiy <novel at freebsd.org> schrieb:

> Hi,
> 
> I have a test box that's updated to -CURRENT usually once in a week or
> two. This box boots using UEFI. After a regular update about two weeks
> ago it started to panic on boot frequently (not UEFI related), but I
> could not get a crash dump because my swap partition was too small. So I
> moved data to the backup drive, repartitioned the main drive and boot
> again. This went fine, so I decided to upgrade to fresh -CURRENT from
> ~Jul 27th. Booting with the new kernel went fine, but after installworld
> machine stopped booting, and on the screen I see:
> 
> FreeBSD/amd64 EFI loader, ...
> 
> ..
> 
> BootOrder: ....
> 
> And then it gets stuck and nothing happens.
> 
> As I already have a fresh backup, I decided that it'd be easier to
> just re-install and copy data back over (maybe I messed up with
> repartitioning). So I've downloaded a fresh snapshot:
> 
> FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> 
> And re-installed. In the installer I choose all the same settings that
> were before: UEFI + GPT, default partition scheme it suggested (efi
> followed by freebsd-ufs followed by freebsd-swap), just increased the
> swap size.
> 
> And the newly installed system won't boot just like a previous one:
> 
> https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> 
> Is there a way to recover this?
> 
> Roman Bogorodskiy

Just curious:

When I installed FreeBSD last time from the recent (2018-07-26) USB flash drive on a SSD,
the freebsd-swap partition followed immediately after the ESP and/or freebsd-boot GPT
loader partition. But in most cases I used to use ZFS for testing.

Since I had my UEFI adventure of my own these days and received valuable hints from the
development/maintenance team on some UEFI aspects, it would be of interest to know your
recent hardware and, more importantly since I see the boot order presented in you
screenshot, a dump of the efi variable settings. Just for curiosity. For that, you have
to boot the recent USB flash drive image with UEFI-only, then logon as root and perform

kldload efirt

and then issue 

# efibootmgr -v

In my case, it looks like

[...]
[ohartmann]: sudo efibootmgr -v
BootCurrent: 0001
Timeout    : 3 seconds
BootOrder  : 0001, 0002, 0003, 0004, 0005, 0000
+Boot0001* FreeBSD-12 \
   HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi) \
   ada0p1:/efi/boot/BOOTx64.efi (null) 
 Boot0002* Hard Drive  BBS(HD,,0x0)
 Boot0003* CD/DVD Drive  BBS(CDROM,,0x0)
 Boot0004* USB  BBS(USB,,0x0)
 Boot0005* Network Card  BBS(Network,,0x0)
 Boot0000  FreeBSD-12
HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
ada0p1:/efi/boot/BOOTx64.efi (null)


Unreferenced Variables:
[...]

Boot0000 is the same as Boot0001 and is defined due to some "bug" Warner Losh has fixed
recently, it is the same as Boot0001

Kind regards,

oh

- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW11wfgAKCRDS528fyFhY
lMojAf929USx1x7I/sSGLtEWKO8rm9IXf1JEpQ7GSdI6YHid364x7fbrUBhDZYuT
JVanY57Li2oLOXogHtMw6eDUyD+aAf9GTE30LUNRhmcJ7el62Vwpm0oUBG2as52i
+v58EZ9c20yKQKuXt446dhbILyODDPKmc9ykAvnE0TtMiTHk6vRn
=M7vi
-----END PGP SIGNATURE-----

From novel at freebsd.org  Sun Jul 29 08:10:11 2018
From: novel at freebsd.org (Roman Bogorodskiy)
Date: Sun, 29 Jul 2018 12:09:58 +0400
Subject: EFI issues
In-Reply-To: <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>
References: <20180728072938.GA28778@kloomba>
 <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>
Message-ID: <20180729080957.GB2216@kloomba>

  O. Hartmann wrote:

> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> 
> Am Sat, 28 Jul 2018 11:29:40 +0400
> Roman Bogorodskiy <novel at freebsd.org> schrieb:
> 
> > Hi,
> > 
> > I have a test box that's updated to -CURRENT usually once in a week or
> > two. This box boots using UEFI. After a regular update about two weeks
> > ago it started to panic on boot frequently (not UEFI related), but I
> > could not get a crash dump because my swap partition was too small. So I
> > moved data to the backup drive, repartitioned the main drive and boot
> > again. This went fine, so I decided to upgrade to fresh -CURRENT from
> > ~Jul 27th. Booting with the new kernel went fine, but after installworld
> > machine stopped booting, and on the screen I see:
> > 
> > FreeBSD/amd64 EFI loader, ...
> > 
> > ..
> > 
> > BootOrder: ....
> > 
> > And then it gets stuck and nothing happens.
> > 
> > As I already have a fresh backup, I decided that it'd be easier to
> > just re-install and copy data back over (maybe I messed up with
> > repartitioning). So I've downloaded a fresh snapshot:
> > 
> > FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> > 
> > And re-installed. In the installer I choose all the same settings that
> > were before: UEFI + GPT, default partition scheme it suggested (efi
> > followed by freebsd-ufs followed by freebsd-swap), just increased the
> > swap size.
> > 
> > And the newly installed system won't boot just like a previous one:
> > 
> > https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> > 
> > Is there a way to recover this?
> > 
> > Roman Bogorodskiy
> 
> Just curious:
> 
> When I installed FreeBSD last time from the recent (2018-07-26) USB flash drive on a SSD,
> the freebsd-swap partition followed immediately after the ESP and/or freebsd-boot GPT
> loader partition. But in most cases I used to use ZFS for testing.

When I reinstalled it yesterday from -CURRENT snapshot mentioned above,
in guided mode it suggested a similar partitioning schema that I use:

=>        40  1953525088  ada0  GPT  (932G)
          40      409600     1  efi  (200M)
      409640  1803550720     2  freebsd-ufs  (860G)
  1803960360   148897792     3  freebsd-swap  (71G)
  1952858152      666976        - free -  (326M)

The only difference it that the freebsd-swap size was 3.5G (and
therefore, freebsd-ufs is large), the order was the same.

> Since I had my UEFI adventure of my own these days and received valuable hints from the
> development/maintenance team on some UEFI aspects, it would be of interest to know your
> recent hardware and, more importantly since I see the boot order presented in you
> screenshot, a dump of the efi variable settings. Just for curiosity. For that, you have
> to boot the recent USB flash drive image with UEFI-only, then logon as root and perform
> 
> kldload efirt
> 
> and then issue 
> 
> # efibootmgr -v
> 
> In my case, it looks like
> 
> [...]
> [ohartmann]: sudo efibootmgr -v
> BootCurrent: 0001
> Timeout    : 3 seconds
> BootOrder  : 0001, 0002, 0003, 0004, 0005, 0000
> +Boot0001* FreeBSD-12 \
>    HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi) \
>    ada0p1:/efi/boot/BOOTx64.efi (null) 
>  Boot0002* Hard Drive  BBS(HD,,0x0)
>  Boot0003* CD/DVD Drive  BBS(CDROM,,0x0)
>  Boot0004* USB  BBS(USB,,0x0)
>  Boot0005* Network Card  BBS(Network,,0x0)
>  Boot0000  FreeBSD-12
> HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> ada0p1:/efi/boot/BOOTx64.efi (null)
> 
> 
> Unreferenced Variables:
> [...]
> 
> Boot0000 is the same as Boot0001 and is defined due to some "bug" Warner Losh has fixed
> recently, it is the same as Boot0001

Motherboard is (from dmidecode):

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: American Megatrends Inc.
        Version: 0806
        Release Date: 02/20/2014
        Address: 0xF0000
        Runtime Size: 64 kB
        ROM Size: 16 MB
        Characteristics:
                PCI is supported
                APM is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                BIOS ROM is socketed
                EDD is supported
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                Print screen service is supported (int 5h)
                8042 keyboard services are supported (int 9h)
                Serial services are supported (int 14h)
                Printer services are supported (int 17h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
                UEFI is supported
        BIOS Revision: 4.6

Handle 0x0002, DMI type 2, 15 bytes
Base Board Information
        Manufacturer: ASUSTeK COMPUTER INC.
        Product Name: B85M-E
        Version: Rev X.0x
        Serial Number: 140526238405585
        Asset Tag: To be filled by O.E.M.                                                                                                                                                                          
        Features:                                                                                                                                                                                                  
                Board is a hosting board                                                                                                                                                                           
                Board is replaceable                                                                                                                                                                               
        Location In Chassis: To be filled by O.E.M.                                                                                                                                                                
        Chassis Handle: 0x0003                                                                                                                                                                                     
        Type: Motherboard                                                                                                                                                                                          
        Contained Object Handles: 0

'efibootmgr -v' output:

BootCurrent: 0004
Timeout    : 1 seconds
BootOrder  : 0001, 0002, 0003, 0004
 Boot0001* Hard Drive  BBS(HD,,0x0)
 Boot0002* Network Card  BBS(Network,,0x0)
 Boot0003* UEFI OS HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
                      ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
                  Path(0,0,ae84b11df581724e85442bab0c2cac5c020000020000)
+Boot0004* UEFI: SanDisk PciRoot(0x0)/Pci(0x1d,0x0)/USB(0x1,0x0)/USB(0x4,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
                        VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,530061006e004400690073006b000000)


Unreferenced Variables:


> Kind regards,
> 
> oh
> 
> - -- 
> O. Hartmann
> 
> Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> -----BEGIN PGP SIGNATURE-----
> 
> iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW11wfgAKCRDS528fyFhY
> lMojAf929USx1x7I/sSGLtEWKO8rm9IXf1JEpQ7GSdI6YHid364x7fbrUBhDZYuT
> JVanY57Li2oLOXogHtMw6eDUyD+aAf9GTE30LUNRhmcJ7el62Vwpm0oUBG2as52i
> +v58EZ9c20yKQKuXt446dhbILyODDPKmc9ykAvnE0TtMiTHk6vRn
> =M7vi
> -----END PGP SIGNATURE-----

Roman Bogorodskiy
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 455 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180729/1169640b/attachment.sig>

From ohartmann at walstatt.org  Sun Jul 29 09:01:17 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Sun, 29 Jul 2018 10:55:23 +0200
Subject: EFI issues
In-Reply-To: <20180729080957.GB2216@kloomba>
References: <20180728072938.GA28778@kloomba>
 <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>
 <20180729080957.GB2216@kloomba>
Message-ID: <20180729105550.4ac8711a@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Sun, 29 Jul 2018 12:09:58 +0400
Roman Bogorodskiy <novel at freebsd.org> schrieb:

>   O. Hartmann wrote:
> 
> > -----BEGIN PGP SIGNED MESSAGE-----
> > Hash: SHA512
> > 
> > Am Sat, 28 Jul 2018 11:29:40 +0400
> > Roman Bogorodskiy <novel at freebsd.org> schrieb:
> >   
> > > Hi,
> > > 
> > > I have a test box that's updated to -CURRENT usually once in a week or
> > > two. This box boots using UEFI. After a regular update about two weeks
> > > ago it started to panic on boot frequently (not UEFI related), but I
> > > could not get a crash dump because my swap partition was too small. So I
> > > moved data to the backup drive, repartitioned the main drive and boot
> > > again. This went fine, so I decided to upgrade to fresh -CURRENT from
> > > ~Jul 27th. Booting with the new kernel went fine, but after installworld
> > > machine stopped booting, and on the screen I see:
> > > 
> > > FreeBSD/amd64 EFI loader, ...
> > > 
> > > ..
> > > 
> > > BootOrder: ....
> > > 
> > > And then it gets stuck and nothing happens.
> > > 
> > > As I already have a fresh backup, I decided that it'd be easier to
> > > just re-install and copy data back over (maybe I messed up with
> > > repartitioning). So I've downloaded a fresh snapshot:
> > > 
> > > FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> > > 
> > > And re-installed. In the installer I choose all the same settings that
> > > were before: UEFI + GPT, default partition scheme it suggested (efi
> > > followed by freebsd-ufs followed by freebsd-swap), just increased the
> > > swap size.
> > > 
> > > And the newly installed system won't boot just like a previous one:
> > > 
> > > https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> > > 
> > > Is there a way to recover this?
> > > 
> > > Roman Bogorodskiy  
> > 
> > Just curious:
> > 
> > When I installed FreeBSD last time from the recent (2018-07-26) USB flash drive on a
> > SSD, the freebsd-swap partition followed immediately after the ESP and/or
> > freebsd-boot GPT loader partition. But in most cases I used to use ZFS for testing.  
> 
> When I reinstalled it yesterday from -CURRENT snapshot mentioned above,
> in guided mode it suggested a similar partitioning schema that I use:
> 
> =>        40  1953525088  ada0  GPT  (932G)  
>           40      409600     1  efi  (200M)
>       409640  1803550720     2  freebsd-ufs  (860G)
>   1803960360   148897792     3  freebsd-swap  (71G)
>   1952858152      666976        - free -  (326M)
> 
> The only difference it that the freebsd-swap size was 3.5G (and
> therefore, freebsd-ufs is large), the order was the same.
> 
> > Since I had my UEFI adventure of my own these days and received valuable hints from
> > the development/maintenance team on some UEFI aspects, it would be of interest to
> > know your recent hardware and, more importantly since I see the boot order presented
> > in you screenshot, a dump of the efi variable settings. Just for curiosity. For that,
> > you have to boot the recent USB flash drive image with UEFI-only, then logon as root
> > and perform
> > 
> > kldload efirt
> > 
> > and then issue 
> > 
> > # efibootmgr -v
> > 
> > In my case, it looks like
> > 
> > [...]
> > [ohartmann]: sudo efibootmgr -v
> > BootCurrent: 0001
> > Timeout    : 3 seconds
> > BootOrder  : 0001, 0002, 0003, 0004, 0005, 0000
> > +Boot0001* FreeBSD-12 \
> >    HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > \ ada0p1:/efi/boot/BOOTx64.efi (null) 
> >  Boot0002* Hard Drive  BBS(HD,,0x0)
> >  Boot0003* CD/DVD Drive  BBS(CDROM,,0x0)
> >  Boot0004* USB  BBS(USB,,0x0)
> >  Boot0005* Network Card  BBS(Network,,0x0)
> >  Boot0000  FreeBSD-12
> > HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > ada0p1:/efi/boot/BOOTx64.efi (null)
> > 
> > 
> > Unreferenced Variables:
> > [...]
> > 
> > Boot0000 is the same as Boot0001 and is defined due to some "bug" Warner Losh has
> > fixed recently, it is the same as Boot0001  
> 
> Motherboard is (from dmidecode):
> 
> Handle 0x0000, DMI type 0, 24 bytes
> BIOS Information
>         Vendor: American Megatrends Inc.
>         Version: 0806
>         Release Date: 02/20/2014
>         Address: 0xF0000
>         Runtime Size: 64 kB
>         ROM Size: 16 MB
>         Characteristics:
>                 PCI is supported
>                 APM is supported
>                 BIOS is upgradeable
>                 BIOS shadowing is allowed
>                 Boot from CD is supported
>                 Selectable boot is supported
>                 BIOS ROM is socketed
>                 EDD is supported
>                 5.25"/1.2 MB floppy services are supported (int 13h)
>                 3.5"/720 kB floppy services are supported (int 13h)
>                 3.5"/2.88 MB floppy services are supported (int 13h)
>                 Print screen service is supported (int 5h)
>                 8042 keyboard services are supported (int 9h)
>                 Serial services are supported (int 14h)
>                 Printer services are supported (int 17h)
>                 ACPI is supported
>                 USB legacy is supported
>                 BIOS boot specification is supported
>                 Targeted content distribution is supported
>                 UEFI is supported
>         BIOS Revision: 4.6
> 
> Handle 0x0002, DMI type 2, 15 bytes
> Base Board Information
>         Manufacturer: ASUSTeK COMPUTER INC.
>         Product Name: B85M-E
>         Version: Rev X.0x
>         Serial Number: 140526238405585
>         Asset Tag: To be filled by
> O.E.M.
> Features: Board is a hosting
> board Board is
> replaceable Location In Chassis: To be filled by
> O.E.M. Chassis Handle:
> 0x0003 Type:
> Motherboard Contained Object Handles: 0
> 
> 'efibootmgr -v' output:
> 
> BootCurrent: 0004
> Timeout    : 1 seconds
> BootOrder  : 0001, 0002, 0003, 0004
>  Boot0001* Hard Drive  BBS(HD,,0x0)
>  Boot0002* Network Card  BBS(Network,,0x0)
>  Boot0003* UEFI OS
> HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
> ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
> Path(0,0,ae84b11df581724e85442bab0c2cac5c020000020000) +Boot0004* UEFI: SanDisk
> PciRoot(0x0)/Pci(0x1d,0x0)/USB(0x1,0x0)/USB(0x4,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
> VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,530061006e004400690073006b000000)
> 
> 
> Unreferenced Variables:
> 
> 
> > Kind regards,
> > 
> > oh
> > 
> > - -- 
> > O. Hartmann
> > 
> > Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> > Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> > -----BEGIN PGP SIGNATURE-----
> > 
> > iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW11wfgAKCRDS528fyFhY
> > lMojAf929USx1x7I/sSGLtEWKO8rm9IXf1JEpQ7GSdI6YHid364x7fbrUBhDZYuT
> > JVanY57Li2oLOXogHtMw6eDUyD+aAf9GTE30LUNRhmcJ7el62Vwpm0oUBG2as52i
> > +v58EZ9c20yKQKuXt446dhbILyODDPKmc9ykAvnE0TtMiTHk6vRn
> > =M7vi
> > -----END PGP SIGNATURE-----  
> 
> Roman Bogorodskiy

The order of the partitions was simply an observation and from the "old days" with HDD as
mass storage/boot storage with rotating platters it was some sort of important for the
access latency where to position the swap partition. With NAND flash based SSD this
became obsolete - so, please don't be bothered about that.

- From my (non-expert) point of view, you UEFI variables look "normal" (according to what
I see on my boxes at home), but I was wondering about the "aged" firmware of you
mainboard. Checking out at ASUS' website/support, they claim they have a more recent
firmare from 2018! This would be on par with the Spectre/Meltdown mitigation promises
made by most valuable/reliable mainboard vendors and Intel:

https://www.asus.com/Motherboards/B85ME/HelpDesk_BIOS/

 Version 3602 2018/05/25 7.29 MByte B85M-E BIOS 3602

Since dmidecode reports on my ASRock crap mainboard also

BIOS Revision: 4.6

I guess this one is fake or some "default" from the dmidecode program not identifying
the correct revision - or it's another semantic not known to me.

But my dmidecode looks like this, with the latest BETA ASrock provides for this long
time ago discontinued Z77 Pro4-board: 

[...]

# dmidecode 3.1
# SMBIOS entry point at 0x000f04c0
Found SMBIOS entry point in EFI, reading table from /dev/mem.
SMBIOS 2.7 present.
26 structures occupying 1523 bytes.
Table at 0x000EE7F0.

Handle 0x0000, DMI type 0, 24 bytes
BIOS Information
        Vendor: American Megatrends Inc.
        Version: P2.00
        Release Date: 03/13/2018
        Address: 0xF0000
        Runtime Size: 64 kB
        ROM Size: 8192 kB
        Characteristics:
                PCI is supported
                BIOS is upgradeable
                BIOS shadowing is allowed
                Boot from CD is supported
                Selectable boot is supported
                BIOS ROM is socketed
                EDD is supported
                5.25"/1.2 MB floppy services are supported (int 13h)
                3.5"/720 kB floppy services are supported (int 13h)
                3.5"/2.88 MB floppy services are supported (int 13h)
                Print screen service is supported (int 5h)
                8042 keyboard services are supported (int 9h)
                Serial services are supported (int 14h)
                Printer services are supported (int 17h)
                ACPI is supported
                USB legacy is supported
                BIOS boot specification is supported
                Targeted content distribution is supported
                UEFI is supported
        BIOS Revision: 4.6
[...]

Watch out the Version: P2.00 entry, which is indeed the version number of the firmware.
So, in your case, the firmware is also a bit outdated, from 2014. I'd update the firmware
prior to any further action if there are no obligations from hardware incompatibilities
so far to meet the neccessity of lates Intel/AMD microcode updates and/or other UEFI
vulnerabilities of which I have no active memories about, but they hit me 2015/2016 on
our servers. There is no guarantee that the firmware update will salvage your problem,
but that might be worth a shot. Also, ASUS mention to have solved performance issues
with the latest firmware, please consider consulting the description of the latest
firmware release. 

As the next step, as from my "naive" point of view, I would perform the steps recommended
to me by FreeBSD's developers to set the UEFI variables again:

Boot in UEFI mode from the USB flash device
Logon as root
mount -uw /
kldload efirt
mount -t msdosfs /dev/ada0p1 /mnt

efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD
efibootmgr -v

Look for the "Boot000X" entry labeled with "FreeBSD", take the number portion of the that
Boot000X variable (000X) and perform

efibootmgr -a 000X
efibootmgr -n 000X (this one is "extra" and can be ommited, it means "next boot", see
manpage efibootmgr(8))

and check again with 

efibootmgr -v

The "maneuver" above is only in case the settings of UEFI variables has gone rogue.

Regards,

oh



- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW12BFgAKCRDS528fyFhY
lLZOAf0V9r/0LzMoKOJfxNhBNsLGFkVRxB6zv9OQV3ytAczGb4alGJRMv8PqDlPi
Vxgp3D+Aq5J9B/Thh2PCEX9v8AFuAgCoUztwd7APBeCaW1TVivWl7X9PpuSZIclU
PhiaxxU51DYekjKZEEUiwJiq75KZH+6SGdzvfEN+0a5H1BK2awgP
=fzRU
-----END PGP SIGNATURE-----

From novel at freebsd.org  Sun Jul 29 11:18:01 2018
From: novel at freebsd.org (Roman Bogorodskiy)
Date: Sun, 29 Jul 2018 15:17:53 +0400
Subject: EFI issues
In-Reply-To: <20180729105550.4ac8711a@thor.intern.walstatt.dynvpn.de>
References: <20180728072938.GA28778@kloomba>
 <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>
 <20180729080957.GB2216@kloomba>
 <20180729105550.4ac8711a@thor.intern.walstatt.dynvpn.de>
Message-ID: <20180729111751.GC2216@kloomba>

  O. Hartmann wrote:

> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
> 
> Am Sun, 29 Jul 2018 12:09:58 +0400
> Roman Bogorodskiy <novel at freebsd.org> schrieb:
> 
> >   O. Hartmann wrote:
> > 
> > > -----BEGIN PGP SIGNED MESSAGE-----
> > > Hash: SHA512
> > > 
> > > Am Sat, 28 Jul 2018 11:29:40 +0400
> > > Roman Bogorodskiy <novel at freebsd.org> schrieb:
> > >   
> > > > Hi,
> > > > 
> > > > I have a test box that's updated to -CURRENT usually once in a week or
> > > > two. This box boots using UEFI. After a regular update about two weeks
> > > > ago it started to panic on boot frequently (not UEFI related), but I
> > > > could not get a crash dump because my swap partition was too small. So I
> > > > moved data to the backup drive, repartitioned the main drive and boot
> > > > again. This went fine, so I decided to upgrade to fresh -CURRENT from
> > > > ~Jul 27th. Booting with the new kernel went fine, but after installworld
> > > > machine stopped booting, and on the screen I see:
> > > > 
> > > > FreeBSD/amd64 EFI loader, ...
> > > > 
> > > > ..
> > > > 
> > > > BootOrder: ....
> > > > 
> > > > And then it gets stuck and nothing happens.
> > > > 
> > > > As I already have a fresh backup, I decided that it'd be easier to
> > > > just re-install and copy data back over (maybe I messed up with
> > > > repartitioning). So I've downloaded a fresh snapshot:
> > > > 
> > > > FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> > > > 
> > > > And re-installed. In the installer I choose all the same settings that
> > > > were before: UEFI + GPT, default partition scheme it suggested (efi
> > > > followed by freebsd-ufs followed by freebsd-swap), just increased the
> > > > swap size.
> > > > 
> > > > And the newly installed system won't boot just like a previous one:
> > > > 
> > > > https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> > > > 
> > > > Is there a way to recover this?
> > > > 
> > > > Roman Bogorodskiy  
> > > 
> > > Just curious:
> > > 
> > > When I installed FreeBSD last time from the recent (2018-07-26) USB flash drive on a
> > > SSD, the freebsd-swap partition followed immediately after the ESP and/or
> > > freebsd-boot GPT loader partition. But in most cases I used to use ZFS for testing.  
> > 
> > When I reinstalled it yesterday from -CURRENT snapshot mentioned above,
> > in guided mode it suggested a similar partitioning schema that I use:
> > 
> > =>        40  1953525088  ada0  GPT  (932G)  
> >           40      409600     1  efi  (200M)
> >       409640  1803550720     2  freebsd-ufs  (860G)
> >   1803960360   148897792     3  freebsd-swap  (71G)
> >   1952858152      666976        - free -  (326M)
> > 
> > The only difference it that the freebsd-swap size was 3.5G (and
> > therefore, freebsd-ufs is large), the order was the same.
> > 
> > > Since I had my UEFI adventure of my own these days and received valuable hints from
> > > the development/maintenance team on some UEFI aspects, it would be of interest to
> > > know your recent hardware and, more importantly since I see the boot order presented
> > > in you screenshot, a dump of the efi variable settings. Just for curiosity. For that,
> > > you have to boot the recent USB flash drive image with UEFI-only, then logon as root
> > > and perform
> > > 
> > > kldload efirt
> > > 
> > > and then issue 
> > > 
> > > # efibootmgr -v
> > > 
> > > In my case, it looks like
> > > 
> > > [...]
> > > [ohartmann]: sudo efibootmgr -v
> > > BootCurrent: 0001
> > > Timeout    : 3 seconds
> > > BootOrder  : 0001, 0002, 0003, 0004, 0005, 0000
> > > +Boot0001* FreeBSD-12 \
> > >    HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > > \ ada0p1:/efi/boot/BOOTx64.efi (null) 
> > >  Boot0002* Hard Drive  BBS(HD,,0x0)
> > >  Boot0003* CD/DVD Drive  BBS(CDROM,,0x0)
> > >  Boot0004* USB  BBS(USB,,0x0)
> > >  Boot0005* Network Card  BBS(Network,,0x0)
> > >  Boot0000  FreeBSD-12
> > > HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > > ada0p1:/efi/boot/BOOTx64.efi (null)
> > > 
> > > 
> > > Unreferenced Variables:
> > > [...]
> > > 
> > > Boot0000 is the same as Boot0001 and is defined due to some "bug" Warner Losh has
> > > fixed recently, it is the same as Boot0001  
> > 
> > Motherboard is (from dmidecode):
> > 
> > Handle 0x0000, DMI type 0, 24 bytes
> > BIOS Information
> >         Vendor: American Megatrends Inc.
> >         Version: 0806
> >         Release Date: 02/20/2014
> >         Address: 0xF0000
> >         Runtime Size: 64 kB
> >         ROM Size: 16 MB
> >         Characteristics:
> >                 PCI is supported
> >                 APM is supported
> >                 BIOS is upgradeable
> >                 BIOS shadowing is allowed
> >                 Boot from CD is supported
> >                 Selectable boot is supported
> >                 BIOS ROM is socketed
> >                 EDD is supported
> >                 5.25"/1.2 MB floppy services are supported (int 13h)
> >                 3.5"/720 kB floppy services are supported (int 13h)
> >                 3.5"/2.88 MB floppy services are supported (int 13h)
> >                 Print screen service is supported (int 5h)
> >                 8042 keyboard services are supported (int 9h)
> >                 Serial services are supported (int 14h)
> >                 Printer services are supported (int 17h)
> >                 ACPI is supported
> >                 USB legacy is supported
> >                 BIOS boot specification is supported
> >                 Targeted content distribution is supported
> >                 UEFI is supported
> >         BIOS Revision: 4.6
> > 
> > Handle 0x0002, DMI type 2, 15 bytes
> > Base Board Information
> >         Manufacturer: ASUSTeK COMPUTER INC.
> >         Product Name: B85M-E
> >         Version: Rev X.0x
> >         Serial Number: 140526238405585
> >         Asset Tag: To be filled by
> > O.E.M.
> > Features: Board is a hosting
> > board Board is
> > replaceable Location In Chassis: To be filled by
> > O.E.M. Chassis Handle:
> > 0x0003 Type:
> > Motherboard Contained Object Handles: 0
> > 
> > 'efibootmgr -v' output:
> > 
> > BootCurrent: 0004
> > Timeout    : 1 seconds
> > BootOrder  : 0001, 0002, 0003, 0004
> >  Boot0001* Hard Drive  BBS(HD,,0x0)
> >  Boot0002* Network Card  BBS(Network,,0x0)
> >  Boot0003* UEFI OS
> > HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
> > ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
> > Path(0,0,ae84b11df581724e85442bab0c2cac5c020000020000) +Boot0004* UEFI: SanDisk
> > PciRoot(0x0)/Pci(0x1d,0x0)/USB(0x1,0x0)/USB(0x4,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
> > VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,530061006e004400690073006b000000)
> > 
> > 
> > Unreferenced Variables:
> > 
> > 
> > > Kind regards,
> > > 
> > > oh
> > > 
> > > - -- 
> > > O. Hartmann
> > > 
> > > Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> > > Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> > > -----BEGIN PGP SIGNATURE-----
> > > 
> > > iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW11wfgAKCRDS528fyFhY
> > > lMojAf929USx1x7I/sSGLtEWKO8rm9IXf1JEpQ7GSdI6YHid364x7fbrUBhDZYuT
> > > JVanY57Li2oLOXogHtMw6eDUyD+aAf9GTE30LUNRhmcJ7el62Vwpm0oUBG2as52i
> > > +v58EZ9c20yKQKuXt446dhbILyODDPKmc9ykAvnE0TtMiTHk6vRn
> > > =M7vi
> > > -----END PGP SIGNATURE-----  
> > 
> > Roman Bogorodskiy
> 
> The order of the partitions was simply an observation and from the "old days" with HDD as
> mass storage/boot storage with rotating platters it was some sort of important for the
> access latency where to position the swap partition. With NAND flash based SSD this
> became obsolete - so, please don't be bothered about that.
> 
> - From my (non-expert) point of view, you UEFI variables look "normal" (according to what
> I see on my boxes at home), but I was wondering about the "aged" firmware of you
> mainboard. Checking out at ASUS' website/support, they claim they have a more recent
> firmare from 2018! This would be on par with the Spectre/Meltdown mitigation promises
> made by most valuable/reliable mainboard vendors and Intel:
> 
> https://www.asus.com/Motherboards/B85ME/HelpDesk_BIOS/
> 
>  Version 3602 2018/05/25 7.29 MByte B85M-E BIOS 3602
> 
> Since dmidecode reports on my ASRock crap mainboard also
> 
> BIOS Revision: 4.6
> 
> I guess this one is fake or some "default" from the dmidecode program not identifying
> the correct revision - or it's another semantic not known to me.
> 
> But my dmidecode looks like this, with the latest BETA ASrock provides for this long
> time ago discontinued Z77 Pro4-board: 
> 
> [...]
> 
> # dmidecode 3.1
> # SMBIOS entry point at 0x000f04c0
> Found SMBIOS entry point in EFI, reading table from /dev/mem.
> SMBIOS 2.7 present.
> 26 structures occupying 1523 bytes.
> Table at 0x000EE7F0.
> 
> Handle 0x0000, DMI type 0, 24 bytes
> BIOS Information
>         Vendor: American Megatrends Inc.
>         Version: P2.00
>         Release Date: 03/13/2018
>         Address: 0xF0000
>         Runtime Size: 64 kB
>         ROM Size: 8192 kB
>         Characteristics:
>                 PCI is supported
>                 BIOS is upgradeable
>                 BIOS shadowing is allowed
>                 Boot from CD is supported
>                 Selectable boot is supported
>                 BIOS ROM is socketed
>                 EDD is supported
>                 5.25"/1.2 MB floppy services are supported (int 13h)
>                 3.5"/720 kB floppy services are supported (int 13h)
>                 3.5"/2.88 MB floppy services are supported (int 13h)
>                 Print screen service is supported (int 5h)
>                 8042 keyboard services are supported (int 9h)
>                 Serial services are supported (int 14h)
>                 Printer services are supported (int 17h)
>                 ACPI is supported
>                 USB legacy is supported
>                 BIOS boot specification is supported
>                 Targeted content distribution is supported
>                 UEFI is supported
>         BIOS Revision: 4.6
> [...]
> 
> Watch out the Version: P2.00 entry, which is indeed the version number of the firmware.
> So, in your case, the firmware is also a bit outdated, from 2014. I'd update the firmware
> prior to any further action if there are no obligations from hardware incompatibilities
> so far to meet the neccessity of lates Intel/AMD microcode updates and/or other UEFI
> vulnerabilities of which I have no active memories about, but they hit me 2015/2016 on
> our servers. There is no guarantee that the firmware update will salvage your problem,
> but that might be worth a shot. Also, ASUS mention to have solved performance issues
> with the latest firmware, please consider consulting the description of the latest
> firmware release. 
> 
> As the next step, as from my "naive" point of view, I would perform the steps recommended
> to me by FreeBSD's developers to set the UEFI variables again:
> 
> Boot in UEFI mode from the USB flash device
> Logon as root
> mount -uw /
> kldload efirt
> mount -t msdosfs /dev/ada0p1 /mnt
> 
> efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD
> efibootmgr -v
> 
> Look for the "Boot000X" entry labeled with "FreeBSD", take the number portion of the that
> Boot000X variable (000X) and perform
> 
> efibootmgr -a 000X
> efibootmgr -n 000X (this one is "extra" and can be ommited, it means "next boot", see
> manpage efibootmgr(8))
> 
> and check again with 
> 
> efibootmgr -v
> 
> The "maneuver" above is only in case the settings of UEFI variables has gone rogue.
> 
> Regards,
> 
> oh

I've updated BIOS (which alone didn't change anything) and executed
commands you suggested, and it helped! Thanks!

Now 'efibootmgr -v' output looks like this:

BootCurrent: 0000
Timeout    : 1 seconds
BootOrder  : 0000, 0004, 0006, 0003, 0007
+Boot0000* FreeBSD HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\efi\boot\BOOTx64.efi)
                      ada0p1:/efi/boot/BOOTx64.efi (null)
 Boot0004* Hard Drive  BBS(HD,,0x0)
 Boot0006* Network Card  BBS(Network,,0x0)
 Boot0003* UEFI OS HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
                      ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
                  Path(0,0,ef47642dc93ba041ac194d51d01b4ce65200650061006c00740065006b00200042006f006f00740020004100670065006e0074000000)
 Boot0007* UEFI: SanDisk PciRoot(0x0)/Pci(0x14,0x0)/USB(0x9,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
                        VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,340043003500330031003000300031003500340031003000310035003100300039003000390035000000)


Unreferenced Variables:

This is strange, because the only difference I see is that Boot0000 has
lowercase filenames ('/efi/boot/BOOTx64.efi' vs
'/EFI/BOOT/BOOTX64.EFI'). I'm wondering if that's the only reason it
wasn't working before?

> - -- 
> O. Hartmann
> 
> Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> -----BEGIN PGP SIGNATURE-----
> 
> iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW12BFgAKCRDS528fyFhY
> lLZOAf0V9r/0LzMoKOJfxNhBNsLGFkVRxB6zv9OQV3ytAczGb4alGJRMv8PqDlPi
> Vxgp3D+Aq5J9B/Thh2PCEX9v8AFuAgCoUztwd7APBeCaW1TVivWl7X9PpuSZIclU
> PhiaxxU51DYekjKZEEUiwJiq75KZH+6SGdzvfEN+0a5H1BK2awgP
> =fzRU
> -----END PGP SIGNATURE-----

Roman Bogorodskiy
-------------- next part --------------
A non-text attachment was scrubbed...
Name: signature.asc
Type: application/pgp-signature
Size: 455 bytes
Desc: not available
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180729/190fa55c/attachment.sig>

From ohartmann at walstatt.org  Sun Jul 29 12:35:58 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Sun, 29 Jul 2018 14:35:02 +0200
Subject: EFI issues
In-Reply-To: <20180729111751.GC2216@kloomba>
References: <20180728072938.GA28778@kloomba>
 <20180729094502.180dabc0@thor.intern.walstatt.dynvpn.de>
 <20180729080957.GB2216@kloomba>
 <20180729105550.4ac8711a@thor.intern.walstatt.dynvpn.de>
 <20180729111751.GC2216@kloomba>
Message-ID: <20180729143529.16bad01a@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Sun, 29 Jul 2018 15:17:53 +0400
Roman Bogorodskiy <novel at freebsd.org> schrieb:

>   O. Hartmann wrote:
> 
> > -----BEGIN PGP SIGNED MESSAGE-----
> > Hash: SHA512
> > 
> > Am Sun, 29 Jul 2018 12:09:58 +0400
> > Roman Bogorodskiy <novel at freebsd.org> schrieb:
> >   
> > >   O. Hartmann wrote:
> > >   
> > > > -----BEGIN PGP SIGNED MESSAGE-----
> > > > Hash: SHA512
> > > > 
> > > > Am Sat, 28 Jul 2018 11:29:40 +0400
> > > > Roman Bogorodskiy <novel at freebsd.org> schrieb:
> > > >     
> > > > > Hi,
> > > > > 
> > > > > I have a test box that's updated to -CURRENT usually once in a week or
> > > > > two. This box boots using UEFI. After a regular update about two weeks
> > > > > ago it started to panic on boot frequently (not UEFI related), but I
> > > > > could not get a crash dump because my swap partition was too small. So I
> > > > > moved data to the backup drive, repartitioned the main drive and boot
> > > > > again. This went fine, so I decided to upgrade to fresh -CURRENT from
> > > > > ~Jul 27th. Booting with the new kernel went fine, but after installworld
> > > > > machine stopped booting, and on the screen I see:
> > > > > 
> > > > > FreeBSD/amd64 EFI loader, ...
> > > > > 
> > > > > ..
> > > > > 
> > > > > BootOrder: ....
> > > > > 
> > > > > And then it gets stuck and nothing happens.
> > > > > 
> > > > > As I already have a fresh backup, I decided that it'd be easier to
> > > > > just re-install and copy data back over (maybe I messed up with
> > > > > repartitioning). So I've downloaded a fresh snapshot:
> > > > > 
> > > > > FreeBSD-12.0-CURRENT-amd64-20180726-r336739-memstick.img
> > > > > 
> > > > > And re-installed. In the installer I choose all the same settings that
> > > > > were before: UEFI + GPT, default partition scheme it suggested (efi
> > > > > followed by freebsd-ufs followed by freebsd-swap), just increased the
> > > > > swap size.
> > > > > 
> > > > > And the newly installed system won't boot just like a previous one:
> > > > > 
> > > > > https://people.freebsd.org/~novel/misc/freebsd_efi_lookup.jpg
> > > > > 
> > > > > Is there a way to recover this?
> > > > > 
> > > > > Roman Bogorodskiy    
> > > > 
> > > > Just curious:
> > > > 
> > > > When I installed FreeBSD last time from the recent (2018-07-26) USB flash drive
> > > > on a SSD, the freebsd-swap partition followed immediately after the ESP and/or
> > > > freebsd-boot GPT loader partition. But in most cases I used to use ZFS for
> > > > testing.    
> > > 
> > > When I reinstalled it yesterday from -CURRENT snapshot mentioned above,
> > > in guided mode it suggested a similar partitioning schema that I use:
> > >   
> > > =>        40  1953525088  ada0  GPT  (932G)    
> > >           40      409600     1  efi  (200M)
> > >       409640  1803550720     2  freebsd-ufs  (860G)
> > >   1803960360   148897792     3  freebsd-swap  (71G)
> > >   1952858152      666976        - free -  (326M)
> > > 
> > > The only difference it that the freebsd-swap size was 3.5G (and
> > > therefore, freebsd-ufs is large), the order was the same.
> > >   
> > > > Since I had my UEFI adventure of my own these days and received valuable hints
> > > > from the development/maintenance team on some UEFI aspects, it would be of
> > > > interest to know your recent hardware and, more importantly since I see the boot
> > > > order presented in you screenshot, a dump of the efi variable settings. Just for
> > > > curiosity. For that, you have to boot the recent USB flash drive image with
> > > > UEFI-only, then logon as root and perform
> > > > 
> > > > kldload efirt
> > > > 
> > > > and then issue 
> > > > 
> > > > # efibootmgr -v
> > > > 
> > > > In my case, it looks like
> > > > 
> > > > [...]
> > > > [ohartmann]: sudo efibootmgr -v
> > > > BootCurrent: 0001
> > > > Timeout    : 3 seconds
> > > > BootOrder  : 0001, 0002, 0003, 0004, 0005, 0000
> > > > +Boot0001* FreeBSD-12 \
> > > >    HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > > > \ ada0p1:/efi/boot/BOOTx64.efi (null) 
> > > >  Boot0002* Hard Drive  BBS(HD,,0x0)
> > > >  Boot0003* CD/DVD Drive  BBS(CDROM,,0x0)
> > > >  Boot0004* USB  BBS(USB,,0x0)
> > > >  Boot0005* Network Card  BBS(Network,,0x0)
> > > >  Boot0000  FreeBSD-12
> > > > HD(1,GPT,e1460941-e2e9-11e5-b913-d0509907ef09,0x28,0x640)/File(\efi\boot\BOOTx64.efi)
> > > > ada0p1:/efi/boot/BOOTx64.efi (null)
> > > > 
> > > > 
> > > > Unreferenced Variables:
> > > > [...]
> > > > 
> > > > Boot0000 is the same as Boot0001 and is defined due to some "bug" Warner Losh has
> > > > fixed recently, it is the same as Boot0001    
> > > 
> > > Motherboard is (from dmidecode):
> > > 
> > > Handle 0x0000, DMI type 0, 24 bytes
> > > BIOS Information
> > >         Vendor: American Megatrends Inc.
> > >         Version: 0806
> > >         Release Date: 02/20/2014
> > >         Address: 0xF0000
> > >         Runtime Size: 64 kB
> > >         ROM Size: 16 MB
> > >         Characteristics:
> > >                 PCI is supported
> > >                 APM is supported
> > >                 BIOS is upgradeable
> > >                 BIOS shadowing is allowed
> > >                 Boot from CD is supported
> > >                 Selectable boot is supported
> > >                 BIOS ROM is socketed
> > >                 EDD is supported
> > >                 5.25"/1.2 MB floppy services are supported (int 13h)
> > >                 3.5"/720 kB floppy services are supported (int 13h)
> > >                 3.5"/2.88 MB floppy services are supported (int 13h)
> > >                 Print screen service is supported (int 5h)
> > >                 8042 keyboard services are supported (int 9h)
> > >                 Serial services are supported (int 14h)
> > >                 Printer services are supported (int 17h)
> > >                 ACPI is supported
> > >                 USB legacy is supported
> > >                 BIOS boot specification is supported
> > >                 Targeted content distribution is supported
> > >                 UEFI is supported
> > >         BIOS Revision: 4.6
> > > 
> > > Handle 0x0002, DMI type 2, 15 bytes
> > > Base Board Information
> > >         Manufacturer: ASUSTeK COMPUTER INC.
> > >         Product Name: B85M-E
> > >         Version: Rev X.0x
> > >         Serial Number: 140526238405585
> > >         Asset Tag: To be filled by
> > > O.E.M.
> > > Features: Board is a hosting
> > > board Board is
> > > replaceable Location In Chassis: To be filled by
> > > O.E.M. Chassis Handle:
> > > 0x0003 Type:
> > > Motherboard Contained Object Handles: 0
> > > 
> > > 'efibootmgr -v' output:
> > > 
> > > BootCurrent: 0004
> > > Timeout    : 1 seconds
> > > BootOrder  : 0001, 0002, 0003, 0004
> > >  Boot0001* Hard Drive  BBS(HD,,0x0)
> > >  Boot0002* Network Card  BBS(Network,,0x0)
> > >  Boot0003* UEFI OS
> > > HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
> > > ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
> > > Path(0,0,ae84b11df581724e85442bab0c2cac5c020000020000) +Boot0004* UEFI: SanDisk
> > > PciRoot(0x0)/Pci(0x1d,0x0)/USB(0x1,0x0)/USB(0x4,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
> > > VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,530061006e004400690073006b000000)
> > > 
> > > 
> > > Unreferenced Variables:
> > > 
> > >   
> > > > Kind regards,
> > > > 
> > > > oh
> > > > 
> > > > - -- 
> > > > O. Hartmann
> > > > 
> > > > Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> > > > Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> > > > -----BEGIN PGP SIGNATURE-----
> > > > 
> > > > iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW11wfgAKCRDS528fyFhY
> > > > lMojAf929USx1x7I/sSGLtEWKO8rm9IXf1JEpQ7GSdI6YHid364x7fbrUBhDZYuT
> > > > JVanY57Li2oLOXogHtMw6eDUyD+aAf9GTE30LUNRhmcJ7el62Vwpm0oUBG2as52i
> > > > +v58EZ9c20yKQKuXt446dhbILyODDPKmc9ykAvnE0TtMiTHk6vRn
> > > > =M7vi
> > > > -----END PGP SIGNATURE-----    
> > > 
> > > Roman Bogorodskiy  
> > 
> > The order of the partitions was simply an observation and from the "old days" with
> > HDD as mass storage/boot storage with rotating platters it was some sort of important
> > for the access latency where to position the swap partition. With NAND flash based
> > SSD this became obsolete - so, please don't be bothered about that.
> > 
> > - From my (non-expert) point of view, you UEFI variables look "normal" (according to
> > what I see on my boxes at home), but I was wondering about the "aged" firmware of you
> > mainboard. Checking out at ASUS' website/support, they claim they have a more recent
> > firmare from 2018! This would be on par with the Spectre/Meltdown mitigation promises
> > made by most valuable/reliable mainboard vendors and Intel:
> > 
> > https://www.asus.com/Motherboards/B85ME/HelpDesk_BIOS/
> > 
> >  Version 3602 2018/05/25 7.29 MByte B85M-E BIOS 3602
> > 
> > Since dmidecode reports on my ASRock crap mainboard also
> > 
> > BIOS Revision: 4.6
> > 
> > I guess this one is fake or some "default" from the dmidecode program not identifying
> > the correct revision - or it's another semantic not known to me.
> > 
> > But my dmidecode looks like this, with the latest BETA ASrock provides for this long
> > time ago discontinued Z77 Pro4-board: 
> > 
> > [...]
> > 
> > # dmidecode 3.1
> > # SMBIOS entry point at 0x000f04c0
> > Found SMBIOS entry point in EFI, reading table from /dev/mem.
> > SMBIOS 2.7 present.
> > 26 structures occupying 1523 bytes.
> > Table at 0x000EE7F0.
> > 
> > Handle 0x0000, DMI type 0, 24 bytes
> > BIOS Information
> >         Vendor: American Megatrends Inc.
> >         Version: P2.00
> >         Release Date: 03/13/2018
> >         Address: 0xF0000
> >         Runtime Size: 64 kB
> >         ROM Size: 8192 kB
> >         Characteristics:
> >                 PCI is supported
> >                 BIOS is upgradeable
> >                 BIOS shadowing is allowed
> >                 Boot from CD is supported
> >                 Selectable boot is supported
> >                 BIOS ROM is socketed
> >                 EDD is supported
> >                 5.25"/1.2 MB floppy services are supported (int 13h)
> >                 3.5"/720 kB floppy services are supported (int 13h)
> >                 3.5"/2.88 MB floppy services are supported (int 13h)
> >                 Print screen service is supported (int 5h)
> >                 8042 keyboard services are supported (int 9h)
> >                 Serial services are supported (int 14h)
> >                 Printer services are supported (int 17h)
> >                 ACPI is supported
> >                 USB legacy is supported
> >                 BIOS boot specification is supported
> >                 Targeted content distribution is supported
> >                 UEFI is supported
> >         BIOS Revision: 4.6
> > [...]
> > 
> > Watch out the Version: P2.00 entry, which is indeed the version number of the
> > firmware. So, in your case, the firmware is also a bit outdated, from 2014. I'd
> > update the firmware prior to any further action if there are no obligations from
> > hardware incompatibilities so far to meet the neccessity of lates Intel/AMD microcode
> > updates and/or other UEFI vulnerabilities of which I have no active memories about,
> > but they hit me 2015/2016 on our servers. There is no guarantee that the firmware
> > update will salvage your problem, but that might be worth a shot. Also, ASUS mention
> > to have solved performance issues with the latest firmware, please consider
> > consulting the description of the latest firmware release. 
> > 
> > As the next step, as from my "naive" point of view, I would perform the steps
> > recommended to me by FreeBSD's developers to set the UEFI variables again:
> > 
> > Boot in UEFI mode from the USB flash device
> > Logon as root
> > mount -uw /
> > kldload efirt
> > mount -t msdosfs /dev/ada0p1 /mnt
> > 
> > efibootmgr -c -l /mnt/efi/boot/BOOTx64.efi -L FreeBSD
> > efibootmgr -v
> > 
> > Look for the "Boot000X" entry labeled with "FreeBSD", take the number portion of the
> > that Boot000X variable (000X) and perform
> > 
> > efibootmgr -a 000X
> > efibootmgr -n 000X (this one is "extra" and can be ommited, it means "next boot", see
> > manpage efibootmgr(8))
> > 
> > and check again with 
> > 
> > efibootmgr -v
> > 
> > The "maneuver" above is only in case the settings of UEFI variables has gone rogue.
> > 
> > Regards,
> > 
> > oh  
> 
> I've updated BIOS (which alone didn't change anything) and executed
> commands you suggested, and it helped! Thanks!
> 
> Now 'efibootmgr -v' output looks like this:
> 
> BootCurrent: 0000
> Timeout    : 1 seconds
> BootOrder  : 0000, 0004, 0006, 0003, 0007
> +Boot0000* FreeBSD
> HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\efi\boot\BOOTx64.efi)
> ada0p1:/efi/boot/BOOTx64.efi (null) Boot0004* Hard Drive  BBS(HD,,0x0)
>  Boot0006* Network Card  BBS(Network,,0x0)
>  Boot0003* UEFI OS
> HD(1,GPT,78459ec0-9303-11e8-97e6-98ded0009b1c,0x28,0x64000)/File(\EFI\BOOT\BOOTX64.EFI)
> ada0p1:/EFI/BOOT/BOOTX64.EFI (null)
> Path(0,0,ef47642dc93ba041ac194d51d01b4ce65200650061006c00740065006b00200042006f006f00740020004100670065006e0074000000)
> Boot0007* UEFI: SanDisk
> PciRoot(0x0)/Pci(0x14,0x0)/USB(0x9,0x0)/HD(1,MBR,0x90909090,0x1,0x640)
> VenHw(2d6447ef-3bc9-41a0-ac19-4d51d01b4ce6,340043003500330031003000300031003500340031003000310035003100300039003000390035000000)
> 
> 
> Unreferenced Variables:
> 
> This is strange, because the only difference I see is that Boot0000 has
> lowercase filenames ('/efi/boot/BOOTx64.efi' vs
> '/EFI/BOOT/BOOTX64.EFI'). I'm wondering if that's the only reason it
> wasn't working before?
> 
> > - -- 
> > O. Hartmann
[...]

> 
> Roman Bogorodskiy

I'm glad to be of help. But it was a "wild guess", not experience or decend knowledge.
Maybe there is an issue with recent UEFI/boot/stand implementation since this portion of
FreeBSD is under heavy development or has been under such ...

Ypu shpuld consider contacting Warner Losh or Toomas Soome (on the current@ list, there
is a thread entitelt "[UEFI] Boot issues on some UEFI implementations" started by myself
targetting some weird FreeBSD/UEFI issues. Toomas Soome gave me the hint with
efibootmgr(8) and I figured out by learning from the definitions, that on specific UEFI
implementations, the boot path "/efi/boot/bootx64.efi" is considered the default for
changeable media (like USB flash drives) and not necessaryly the default for SATA/SAS
devices.  

I felt frank and free to CC some people form the list, hoping that could shed light on
the issue.

Kind regards,
oh

- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW120kQAKCRDS528fyFhY
lI+dAf0Uqgl1GkUstSrHJZPFJgkV91YzjURFaQHwpq26kA8Uex7mWntBKNUTjzx/
MUG/U4IUvyImGESmBZYOcSyApTXOAf9PDWXBWM/zwfu9L9TbogVuJ1WYTOF4hdB6
iEvbNWRtNQy6eQwD6+eUBISxJfG+dS8DVAzwkP46+vU23R6VI2c8
=O9lx
-----END PGP SIGNATURE-----

From imb at protected-networks.net  Sun Jul 29 12:58:50 2018
From: imb at protected-networks.net (Michael Butler)
Date: Sun, 29 Jul 2018 08:58:47 -0400
Subject: console spam during mergemaster
Message-ID: <602f48b6-9dc4-37fd-a3bf-1c6852c51c5f@protected-networks.net>

This started a few days ago .. no apparent ill effect but still annoying ..

*** Creating the temporary root environment in /var/tmp/temproot
 *** /var/tmp/temproot ready for use
 *** Creating and populating directory structure in /var/tmp/temproot

make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
script for target "/var/tmp/temproot/etc/periodic/daily" ignored
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
script for target "/var/tmp/temproot/etc/periodic/daily" ignored
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
previous script for "/var/tmp/temproot/etc/periodic/monthly" defined here
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
previous script for "/var/tmp/temproot/etc/periodic/monthly" defined here
make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
script for target "/var/tmp/temproot/etc/pam.d" ignored
make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
previous script for "/var/tmp/temproot/etc/pam.d" defined here
make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
script for target "/var/tmp/temproot/etc/pam.d" ignored

	imb

From ohartmann at walstatt.org  Sun Jul 29 13:06:34 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Sun, 29 Jul 2018 15:05:43 +0200
Subject: console spam during mergemaster
In-Reply-To: <602f48b6-9dc4-37fd-a3bf-1c6852c51c5f@protected-networks.net>
References: <602f48b6-9dc4-37fd-a3bf-1c6852c51c5f@protected-networks.net>
Message-ID: <20180729150610.62936c38@thor.intern.walstatt.dynvpn.de>

-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA512

Am Sun, 29 Jul 2018 08:58:47 -0400
Michael Butler <imb at protected-networks.net> schrieb:

> This started a few days ago .. no apparent ill effect but still annoying ..
> 
> *** Creating the temporary root environment in /var/tmp/temproot
>  *** /var/tmp/temproot ready for use
>  *** Creating and populating directory structure in /var/tmp/temproot
> 
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> script for target "/var/tmp/temproot/etc/periodic/daily" ignored
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> script for target "/var/tmp/temproot/etc/periodic/daily" ignored
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> previous script for "/var/tmp/temproot/etc/periodic/monthly" defined here
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
> make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> previous script for "/var/tmp/temproot/etc/periodic/monthly" defined here
> make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> script for target "/var/tmp/temproot/etc/pam.d" ignored
> make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> previous script for "/var/tmp/temproot/etc/pam.d" defined here
> make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> script for target "/var/tmp/temproot/etc/pam.d" ignored
> 
> 	imb
> _______________________________________________
> freebsd-current at freebsd.org mailing list
> https://lists.freebsd.org/mailman/listinfo/freebsd-current
> To unsubscribe, send any mail to "freebsd-current-unsubscribe at freebsd.org"

me, too

Regards,

oh

- -- 
O. Hartmann

Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
-----BEGIN PGP SIGNATURE-----

iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW127wgAKCRDS528fyFhY
lDBdAf4mFhRmAWPot0FZZ6+/Z8TuTej/zrcxTs5S0sAQOzTHmoFu43huiwUJbs6Z
8DMEik2T+ynJf4ocf1+UxAkyNKgmAf0e7aerKYCqGKg5QCP3zSS3TpdERnxWPVMn
b/LVa0kyJzzU1vnxBhj9LNoCrAlIV27J8JtxNP7db9Csvygaks7/
=e7SV
-----END PGP SIGNATURE-----

From gurenchan at gmail.com  Sun Jul 29 17:43:32 2018
From: gurenchan at gmail.com (blubee blubeeme)
Date: Mon, 30 Jul 2018 01:43:19 +0800
Subject: SVN down or slow
Message-ID: <CALM2mE=JOmfOFP5EuT6j6iBYTjFhpEgFprLVqRX467d8rrLO9Q@mail.gmail.com>

Has anyone else noticed that svn is getting this type of error trying to
run svn: svn: E000065: Error running context: No route to host

From Alexander at leidinger.net  Sun Jul 29 20:36:59 2018
From: Alexander at leidinger.net (Alexander Leidinger)
Date: Sun, 29 Jul 2018 22:36:39 +0200
Subject: recent changes in OS boot watchdog area?
Message-ID: <20180729223639.Horde.j63W3h82ohqpZmVnSIRGTkv@webmail.leidinger.net>

Hi,

settings in BIOS:
  - power-off system if watchdog is not taken care of 10 minutes after power-on

What I have with r336564 is: watchdogd is started during boot and  
system runs fine.
What I have with r336767 is: watchdogd is started but system powers  
off after 10 minutes.
What I have with r336767 + disable of OS boot watchdog in BIOS:  
watchdogs is started during boot and system runs fine.

I checked files with *watch* or *dog* in name. No recent changes. Has  
anything changed somewhere else which may affect this?

Bye,
Alexander.

-- 
http://www.Leidinger.net Alexander at Leidinger.net: PGP 0x8F31830F9F2772BF
http://www.FreeBSD.org    netchild at FreeBSD.org  : PGP 0x8F31830F9F2772BF
-------------- next part --------------
A non-text attachment was scrubbed...
Name: not available
Type: application/pgp-signature
Size: 819 bytes
Desc: Digitale PGP-Signatur
URL: <http://lists.freebsd.org/pipermail/freebsd-current/attachments/20180729/2e9f903a/attachment.sig>

From yuri at rawbw.com  Sun Jul 29 22:20:23 2018
From: yuri at rawbw.com (Yuri)
Date: Sun, 29 Jul 2018 15:20:19 -0700
Subject: SVN down or slow
In-Reply-To: <CALM2mE=JOmfOFP5EuT6j6iBYTjFhpEgFprLVqRX467d8rrLO9Q@mail.gmail.com>
References: <CALM2mE=JOmfOFP5EuT6j6iBYTjFhpEgFprLVqRX467d8rrLO9Q@mail.gmail.com>
Message-ID: <76d53b4e-a4dd-8001-f158-c5ff0057524a@rawbw.com>

On 7/29/18 10:43 AM, blubee blubeeme wrote:
> Has anyone else noticed that svn is getting this type of error trying to
> run svn: svn: E000065: Error running context: No route to host


This is likely due to network problems, not the subversion server itself.


Yuri



From lars at gustik.eu  Sun Jul 29 23:17:38 2018
From: lars at gustik.eu (Lars Schotte)
Date: Mon, 30 Jul 2018 01:17:32 +0200
Subject: OpenVPN produces garbage on TAP on -current
Message-ID: <20180730011732.3604d5c5@romy.j20.helspy.pw>

Hey,
is it possible that OpenVPN can not handle TAP on -current (12) any
more?

I tried it with Linux -> FreeBSD and FreeBSD -> FreeBSD with the same
result. On the server, the pings for example arrived at unknown
ethernet packets or sth. He was still trying to learn new MAC addrs.

I am suspecting there a problem with how OpenVPN filled TAP device.

-- 
 Lars Schotte
 Mudro?ova 13
92101 Pie??any

From asomers at freebsd.org  Mon Jul 30 21:09:02 2018
From: asomers at freebsd.org (Alan Somers)
Date: Mon, 30 Jul 2018 15:08:59 -0600
Subject: console spam during mergemaster
In-Reply-To: <20180729150610.62936c38@thor.intern.walstatt.dynvpn.de>
References: <602f48b6-9dc4-37fd-a3bf-1c6852c51c5f@protected-networks.net>
 <20180729150610.62936c38@thor.intern.walstatt.dynvpn.de>
Message-ID: <CAOtMX2gAaO63aG4CBFpO1ftFLH8ftuwAkC3GoKnaFBBtDZ98Jg@mail.gmail.com>

On Sun, Jul 29, 2018 at 7:05 AM, O. Hartmann <ohartmann at walstatt.org> wrote:

> -----BEGIN PGP SIGNED MESSAGE-----
> Hash: SHA512
>
> Am Sun, 29 Jul 2018 08:58:47 -0400
> Michael Butler <imb at protected-networks.net> schrieb:
>
> > This started a few days ago .. no apparent ill effect but still annoying
> ..
> >
> > *** Creating the temporary root environment in /var/tmp/temproot
> >  *** /var/tmp/temproot ready for use
> >  *** Creating and populating directory structure in /var/tmp/temproot
> >
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> > script for target "/var/tmp/temproot/etc/periodic/daily" ignored
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> > previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> > script for target "/var/tmp/temproot/etc/periodic/daily" ignored
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> > previous script for "/var/tmp/temproot/etc/periodic/daily" defined here
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> > script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> > previous script for "/var/tmp/temproot/etc/periodic/monthly" defined
> here
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> > script for target "/var/tmp/temproot/etc/periodic/monthly" ignored
> > make[4]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> > previous script for "/var/tmp/temproot/etc/periodic/monthly" defined
> here
> > make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 29: warning: duplicate
> > script for target "/var/tmp/temproot/etc/pam.d" ignored
> > make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: using
> > previous script for "/var/tmp/temproot/etc/pam.d" defined here
> > make[3]: "/usr/src/share/mk/bsd.dirs.mk" line 31: warning: duplicate
> > script for target "/var/tmp/temproot/etc/pam.d" ignored
> >
> >       imb
> > _______________________________________________
> > freebsd-current at freebsd.org mailing list
> > https://lists.freebsd.org/mailman/listinfo/freebsd-current
> > To unsubscribe, send any mail to "freebsd-current-unsubscribe@
> freebsd.org"
>
> me, too
>
> Regards,
>
> oh
>
> - --
> O. Hartmann
>
> Ich widerspreche der Nutzung oder ?bermittlung meiner Daten f?r
> Werbezwecke oder f?r die Markt- oder Meinungsforschung (? 28 Abs. 4 BDSG).
> -----BEGIN PGP SIGNATURE-----
>
> iLUEARMKAB0WIQQZVZMzAtwC2T/86TrS528fyFhYlAUCW127wgAKCRDS528fyFhY
> lDBdAf4mFhRmAWPot0FZZ6+/Z8TuTej/zrcxTs5S0sAQOzTHmoFu43huiwUJbs6Z
> 8DMEik2T+ynJf4ocf1+UxAkyNKgmAf0e7aerKYCqGKg5QCP3zSS3TpdERnxWPVMn
> b/LVa0kyJzzU1vnxBhj9LNoCrAlIV27J8JtxNP7db9Csvygaks7/
> =e7SV
> -----END PGP SIGNATURE-----



It's caused by r336640.  I've let the committer know.

From ohartmann at walstatt.org  Tue Jul 31 04:52:12 2018
From: ohartmann at walstatt.org (O. Hartmann)
Date: Tue, 31 Jul 2018 06:51:50 +0200
Subject: svn commit: r336940 - in head/sys: netinet netinet6 [This broke
 ci.freebsd.org 's FreeBSD-head-mips*-build 's]
In-Reply-To: <DE1209BB-80F5-4F53-916E-B8332FA6D875@yahoo.com>
References: <DE1209BB-80F5-4F53-916E-B8332FA6D875@yahoo.com>
Message-ID: <20180731065145.6fbc7d56@freyja.zeit4.iv.bundesimmobilien.de>

On Mon, 30 Jul 2018 18:44:24 -0700
Mark Millard via svn-src-head <svn-src-head at freebsd.org> wrote:

> https://ci.freebsd.org/job/FreeBSD-head-mips-build/3577/consoleText shows:
> 
> --- tcp_usrreq.o ---
> cc1: warnings being treated as errors
> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable
> 'sin' [-Wunused-variable] . . .
> --- tcp_usrreq.o ---
> *** [tcp_usrreq.o] Error code 1
> 
> make[2]: stopped in /usr/obj/usr/src/mips.mips/sys/MALTA
> 1 error
> 
> (Note: -r366935 built correctly as #3576 .)
> 
> 
> 
> https://ci.freebsd.org/job/FreeBSD-head-mips64-build/3624/consoleText shows:
> 
> --- tcp_usrreq.o ---
> cc1: warnings being treated as errors
> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable
> 'sin' [-Wunused-variable] *** [tcp_usrreq.o] Error code 1
> 
> make[2]: stopped in /usr/obj/usr/src/mips.mips64/sys/MALTA64
> 
> (Note: -r366935 built correctly as #3623 .)
> 
> 
> 
> 
> ===
> Mark Millard
> marklmi at yahoo.com
> ( dsl-only.net went
> away in early 2018-Mar)

This broke also AMD64 builds.

Regards
oh

From marklmi at yahoo.com  Tue Jul 31 05:18:51 2018
From: marklmi at yahoo.com (Mark Millard)
Date: Mon, 30 Jul 2018 22:18:45 -0700
Subject: svn commit: r336940 - in head/sys: netinet netinet6 [This broke
 ci.freebsd.org 's FreeBSD-head-mips*-build 's]
In-Reply-To: <FFA09C3B-AC4D-41F3-ABA1-1BF2B34250E1@yahoo.com>
References: <DE1209BB-80F5-4F53-916E-B8332FA6D875@yahoo.com>
 <20180731065145.6fbc7d56@freyja.zeit4.iv.bundesimmobilien.de>
 <FFA09C3B-AC4D-41F3-ABA1-1BF2B34250E1@yahoo.com>
Message-ID: <CEB04CBD-47B7-4551-B4A5-EEDBEA549AED@yahoo.com>

[Just a resend from the correct E-mail account.]

On 2018-Jul-30, at 9:51 PM, O. Hartmann <ohartmann at walstatt.org> wrote:

> On Mon, 30 Jul 2018 18:44:24 -0700
> Mark Millard via svn-src-head <svn-src-head at freebsd.org> wrote:
> 
>> https://ci.freebsd.org/job/FreeBSD-head-mips-build/3577/consoleText shows:
>> 
>> --- tcp_usrreq.o ---
>> cc1: warnings being treated as errors
>> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
>> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable
>> 'sin' [-Wunused-variable] . . .
>> --- tcp_usrreq.o ---
>> *** [tcp_usrreq.o] Error code 1
>> 
>> make[2]: stopped in /usr/obj/usr/src/mips.mips/sys/MALTA
>> 1 error
>> 
>> (Note: -r366935 built correctly as #3576 .)
>> 
>> 
>> 
>> https://ci.freebsd.org/job/FreeBSD-head-mips64-build/3624/consoleText shows:
>> 
>> --- tcp_usrreq.o ---
>> cc1: warnings being treated as errors
>> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
>> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable
>> 'sin' [-Wunused-variable] *** [tcp_usrreq.o] Error code 1
>> 
>> make[2]: stopped in /usr/obj/usr/src/mips.mips64/sys/MALTA64
>> 
>> (Note: -r366935 built correctly as #3623 .)
>> 
> . . .
> This broke also AMD64 builds.
> 

FreeBSD-head-amd64-build 's were not broken:

#9676 of -r336933 (before) and #9677 of -r336943 (after)
both built just fine according to:

https://ci.freebsd.org/job/FreeBSD-head-amd64-build/



===
Mark Millard
marklmi at yahoo.com
( dsl-only.net went
away in early 2018-Mar)


From tuexen at freebsd.org  Tue Jul 31 06:28:08 2018
From: tuexen at freebsd.org (Michael Tuexen)
Date: Tue, 31 Jul 2018 08:28:02 +0200
Subject: svn commit: r336940 - in head/sys: netinet netinet6 [This broke
 ci.freebsd.org 's FreeBSD-head-mips*-build 's]
In-Reply-To: <DE1209BB-80F5-4F53-916E-B8332FA6D875@yahoo.com>
References: <DE1209BB-80F5-4F53-916E-B8332FA6D875@yahoo.com>
Message-ID: <3865FB6F-B74D-472E-A755-FE55C18AE217@freebsd.org>

> On 31. Jul 2018, at 03:44, Mark Millard <marklmi26-fbsd at yahoo.com> wrote:
> 
> https://ci.freebsd.org/job/FreeBSD-head-mips-build/3577/consoleText shows:
> 
> --- tcp_usrreq.o ---
> cc1: warnings being treated as errors
> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable 'sin' [-Wunused-variable]
> . . .
> --- tcp_usrreq.o ---
> *** [tcp_usrreq.o] Error code 1
> 
> make[2]: stopped in /usr/obj/usr/src/mips.mips/sys/MALTA
> 1 error
> 
> (Note: -r366935 built correctly as #3576 .)
> 
> 
> 
> https://ci.freebsd.org/job/FreeBSD-head-mips64-build/3624/consoleText shows:
> 
> --- tcp_usrreq.o ---
> cc1: warnings being treated as errors
> /usr/src/sys/netinet/tcp_usrreq.c: In function 'tcp_usr_send':
> /usr/src/sys/netinet/tcp_usrreq.c:905: warning: unused variable 'sin' [-Wunused-variable]
> *** [tcp_usrreq.o] Error code 1
> 
> make[2]: stopped in /usr/obj/usr/src/mips.mips64/sys/MALTA64
> 
> (Note: -r366935 built correctly as #3623 .)
Fixed in https://svnweb.freebsd.org/changeset/base/336962

Thanks for the report and sorry for the breakage.

Best regards
Michael
> 
> 
> 
> 
> ===
> Mark Millard
> marklmi at yahoo.com
> ( dsl-only.net went
> away in early 2018-Mar)
> 


From tech-lists at zyxst.net  Tue Jul 31 10:41:20 2018
From: tech-lists at zyxst.net (tech-lists)
Date: Tue, 31 Jul 2018 11:41:17 +0100
Subject: how to make ports not install xorg or dependencies
Message-ID: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>

Hello,

context: freebsd-12 r336215 arm64

I don't want xorg or X11 or any of its components installed on this 
system. I install ports in the traditional way, in other words cd port 
&& make config && make install. Any ports that in a generic config want 
to install xorg libs, I want the no-x11 variant.

There used to be a way to enforce this no-xorg in make.conf but looking 
at /usr/share/examples/etc/make.conf I can find no reference to X Xorg 
x11 or xorg. I presume there's a new method. If there is, can anyone 
please tell me how?

thanks,
-- 
J.

From mad at madpilot.net  Tue Jul 31 10:49:39 2018
From: mad at madpilot.net (Guido Falsi)
Date: Tue, 31 Jul 2018 12:49:35 +0200
Subject: how to make ports not install xorg or dependencies
In-Reply-To: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>
References: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>
Message-ID: <1d971811-95eb-efa9-af2a-c9fb5a3b5313@madpilot.net>

On 7/31/18 12:41 PM, tech-lists wrote:
> Hello,
> 
> context: freebsd-12 r336215 arm64
> 
> I don't want xorg or X11 or any of its components installed on this
> system. I install ports in the traditional way, in other words cd port
> && make config && make install. Any ports that in a generic config want
> to install xorg libs, I want the no-x11 variant.
> 
> There used to be a way to enforce this no-xorg in make.conf but looking
> at /usr/share/examples/etc/make.conf I can find no reference to X Xorg
> x11 or xorg. I presume there's a new method. If there is, can anyone
> please tell me how?

You can add OPTIONS_UNSET+=X11 in make.conf.

ports having an X11 option will have that disabled by default.

There is no warranty no port will have X11 dependencies anyway, it's not
mandatory to respect that knob.

-- 
Guido Falsi <mad at madpilot.net>

From mad at madpilot.net  Tue Jul 31 10:51:18 2018
From: mad at madpilot.net (Guido Falsi)
Date: Tue, 31 Jul 2018 12:51:14 +0200
Subject: how to make ports not install xorg or dependencies
In-Reply-To: <1d971811-95eb-efa9-af2a-c9fb5a3b5313@madpilot.net>
References: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>
 <1d971811-95eb-efa9-af2a-c9fb5a3b5313@madpilot.net>
Message-ID: <68cef083-a3d1-88f0-941c-441f5b2ba164@madpilot.net>

On 7/31/18 12:49 PM, Guido Falsi wrote:
> On 7/31/18 12:41 PM, tech-lists wrote:
>> Hello,
>>
>> context: freebsd-12 r336215 arm64
>>
>> I don't want xorg or X11 or any of its components installed on this
>> system. I install ports in the traditional way, in other words cd port
>> && make config && make install. Any ports that in a generic config want
>> to install xorg libs, I want the no-x11 variant.
>>
>> There used to be a way to enforce this no-xorg in make.conf but looking
>> at /usr/share/examples/etc/make.conf I can find no reference to X Xorg
>> x11 or xorg. I presume there's a new method. If there is, can anyone
>> please tell me how?
> 
> You can add OPTIONS_UNSET+=X11 in make.conf.
> 
> ports having an X11 option will have that disabled by default.
> 
> There is no warranty no port will have X11 dependencies anyway, it's not
> mandatory to respect that knob.
> 

I was too hasty in hitting send. There are other options which influence
X11 dependencies.

I usually also disable XPM and CUPS at least. It also depends on which
ports you are installing.

-- 
Guido Falsi <mad at madpilot.net>

From 000.fbsd at quip.cz  Tue Jul 31 11:13:35 2018
From: 000.fbsd at quip.cz (Miroslav Lachman)
Date: Tue, 31 Jul 2018 13:13:31 +0200
Subject: how to make ports not install xorg or dependencies
In-Reply-To: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>
References: <703ec31c-a798-68c6-c9fa-4d73bce50be2@zyxst.net>
Message-ID: <8265d700-9f0f-d2a5-a2c8-96ad4dd2e8b2@quip.cz>

tech-lists wrote on 2018/07/31 12:41:

> There used to be a way to enforce this no-xorg in make.conf but looking 
> at /usr/share/examples/etc/make.conf I can find no reference to X Xorg 
> x11 or xorg. I presume there's a new method. If there is, can anyone 
> please tell me how?


We are using OPTIONS_UNSET= X11 GUI CUPS DOCS EXAMPLES NLS for all of 
our packages (built with poudriere)
As Guido Falsi already said it is not guaranteed that you will not have 
ports with some X libs, because some ports does not have option to 
disable X11 dependencies.

Miroslav Lachman

From bsd-lists at BSDforge.com  Tue Jul 31 16:38:16 2018
From: bsd-lists at BSDforge.com (Chris H)
Date: Tue, 31 Jul 2018 09:25:43 -0700
Subject: Can't upgrade past 10.4-STABLE (interrupt storm?)
Message-ID: <7406fb42a5e2ec2cb09fca98ca1e39bb@udns.ultimatedns.net>

Hello,
I've got an older laptop that I attempted to install 12 on w/o success.
Well, it installed. But was unusable. Typing anything at the console
frequently doesn't output on the screen w/o tapping one of the arrow
keys. But doing that causes other problems. As I can't really use the
output. :(
I suspected an interrupt storm of some type. But really can't say for
sure. a vmstat -i seems to show unusually high numbers for irq1: atkbd0
often ~1/3rd the number for CPU0. I can easily realize all this during
the install process from the install media. So it's easy to test.
This is a i386 based Pentium M. FreeBSD 10.4-STABLE runs like a dream.
But I'm going to need to move forward at some point, and I'd like that
some point to be now. :)
Any thoughts on how I might discover /what/ change was made from
10.4-->11* to cause this?
It has a trackpad. Should that make any difference.

Thanks!

--Chris



